<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="referrer" content="no-referrer" />

  <!-- NOTE: isi og:url + canonical dengan URL final halaman kamu -->
  <meta property="og:url" content="" />
  <link rel="canonical" href="" />

  <meta property="og:title" content="MADETOTO2 - Spin & Win" />
  <meta name="description" content="PUTAR RODANYA & DAPATKAN HADIAH FANTASTIS HINGGA 200 RIBU RUPIAH!" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://shortq.org/gmbrmadetoto2" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="MADETOTO2 - Spin & Win" />
  <meta name="twitter:description" content="PUTAR RODANYA &amp; DAPATKAN HADIAH FANTASTIS HINGGA 200 RIBU RUPIAH!" />
  <meta name="twitter:image" content="https://shortq.org/gmbrmadetoto2" />

  <meta name="theme-color" content="#071a12" />
  <link rel="shortcut icon" href="https://shortq.org/gmbrmadetoto2" type="image/x-icon" />

<style>
/* =========================================================
 * PREMIUM — FRESH / CLEAN / SMOOTH (FULL REPLACE v2026.01)
 * Target: Android/iOS/Desktop (low–mid–high)
 * Prinsip:
 * ✅ Animasi hanya transform/opacity (anti blur-smear)
 * ✅ Backdrop blur tidak dianimasikan
 * ✅ Tidak pakai translateZ permanen (anti raster blur)
 * ✅ Auto downgrade untuk device low-end / coarse pointer
 * ✅ Tap target & typography lebih nyaman
 * ======================================================= */

*, *::before, *::after { box-sizing: border-box; }
* { margin: 0; padding: 0; }
img, video, canvas, svg { max-width: 100%; height: auto; display: block; }
:where(a, button, input, textarea, select){ -webkit-tap-highlight-color: transparent; }
button { touch-action: manipulation; font: inherit; }
:where(input,textarea,select,button){ font: inherit; }

/* =========================
 * TOKENS
 * ======================= */
:root{
  color-scheme: dark;

  /* Base depth */
  --bg0: #04110d;
  --bg1: #061c14;
  --bg2: #05271c;

  /* Metal */
  --gold0: #fff1d3;
  --gold1: #f3b24a;
  --gold2: #7a3f13;

  /* Accents */
  --green0: #d7ffe9;
  --green1: #3be07b;
  --green2: #128a45;

  --text: rgba(255,255,255,0.94);
  --muted: rgba(255,255,255,0.72);
  --muted2: rgba(255,255,255,0.56);

  --card: rgba(59,224,123,0.06);
  --cardBorder: rgba(59,224,123,0.20);

  --radius-lg: 20px;
  --radius-md: 14px;
  --radius-sm: 12px;

  /* Motion */
  --ease: cubic-bezier(0.2, 0.9, 0.2, 1);
  --dur-fast: 140ms;
  --dur: 220ms;
  --dur-slow: 360ms;

  /* Blur (dipakai untuk backdrop, bukan anim blur) */
  --blur-md: 12px;
  --blur-lg: 16px;

  /* Shadows */
  --shadow-soft: 0 0 56px -16px rgba(59,224,123,0.16);
  --shadow-deep: 0 26px 86px rgba(0,0,0,0.60);
  --shadow-card: 0 18px 70px rgba(0,0,0,0.48);

  --ring: rgba(59,224,123,0.56);

  /* Safe-area */
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-right: env(safe-area-inset-right, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-left: env(safe-area-inset-left, 0px);

  /* Wheel */
  --rim-pad: clamp(12px, 3vw, 15px);
  --inner-safe-scale: 0.986;

  /* FX knobs */
  --grain-opacity: 0.034;
  --fx-opacity: 0.72;
  --vignette-opacity: 0.92;

  /* Typography polish */
  --letter-tight: 0.12px;
  --tap-min: 44px;
}

/* =========================
 * VIEWPORT / TYPOGRAPHY
 * ======================= */
html{
  width: 100%;
  height: 100%;
  background: var(--bg0);
  overscroll-behavior: none;
  -webkit-text-size-adjust: 100%;
  text-rendering: optimizeLegibility;
  scrollbar-gutter: stable;
}
@supports (overflow: clip){
  html, body { overflow-x: clip; }
}
@supports not (overflow: clip){
  html, body { overflow-x: hidden; }
}

body{
  min-height: 100vh;
  min-height: 100svh;

  color: var(--text);
  font-family:
    ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
    "SF Pro Display","SF Pro Text","Segoe UI Variable","Segoe UI",
    Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;

  font-size: 16px;
  line-height: 1.35;

  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;

  overscroll-behavior: none;
  position: relative;
  isolation: isolate;

  background:
    radial-gradient(980px 560px at 82% 14%, rgba(59,224,123,0.12), transparent 62%),
    radial-gradient(920px 620px at 18% 10%, rgba(255,255,255,0.045), transparent 64%),
    radial-gradient(860px 560px at 20% 92%, rgba(20,184,166,0.085), transparent 60%),
    radial-gradient(760px 520px at 72% 84%, rgba(243,178,74,0.045), transparent 66%),
    linear-gradient(135deg, var(--bg0) 0%, var(--bg1) 48%, var(--bg2) 100%);
}
@supports (min-height: 100dvh){
  body{ min-height: 100dvh; }
}

::selection{
  background: rgba(59,224,123,0.18);
  color: #fff;
}

/* =========================
 * GLOBAL FOCUS (Keyboard)
 * ======================= */
@supports selector(:focus-visible){
  :where(a,button,input,textarea,select):focus{ outline: none; }
  :where(a,button,input,textarea,select):focus-visible{
    outline: none;
    box-shadow: 0 0 0 4px rgba(59,224,123,0.16);
    border-radius: 10px;
  }
}

/* =========================
 * BACKDROP VIGNETTE + GRAIN (fixed, no transform)
 * ======================= */
body::before{
  content:"";
  position: fixed;
  inset: 0;
  pointer-events:none;
  z-index: 0;
  background:
    radial-gradient(1200px 760px at 50% 28%, rgba(255,255,255,0.05), transparent 64%),
    radial-gradient(1400px 920px at 50% 112%, rgba(0,0,0,0.60), transparent 58%),
    radial-gradient(920px 920px at -10% 22%, rgba(0,0,0,0.52), transparent 56%),
    radial-gradient(920px 920px at 110% 22%, rgba(0,0,0,0.50), transparent 56%);
  opacity: var(--vignette-opacity);
}

body::after{
  content:"";
  position: fixed;
  inset: 0;
  pointer-events:none;
  z-index: 1;
  opacity: var(--grain-opacity);
  mix-blend-mode: soft-light;
  background:
    repeating-linear-gradient(0deg,
      rgba(255,255,255,0.08) 0px,
      rgba(255,255,255,0.08) 1px,
      rgba(0,0,0,0.00) 2px,
      rgba(0,0,0,0.00) 5px
    ),
    repeating-linear-gradient(90deg,
      rgba(255,255,255,0.06) 0px,
      rgba(255,255,255,0.06) 1px,
      rgba(0,0,0,0.00) 2px,
      rgba(0,0,0,0.00) 6px
    );
}

/* =========================
 * FX CANVAS
 * ======================= */
#fxCanvas{
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 2;
  opacity: var(--fx-opacity);
  mix-blend-mode: screen;
}

/* =========================
 * LAYOUT
 * ======================= */
.container{
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  padding-left: calc(20px + var(--safe-left));
  padding-right: calc(20px + var(--safe-right));
  padding-top: calc(20px + var(--safe-top));
  padding-bottom: calc(20px + var(--safe-bottom));
  position: relative;
  z-index: 5;
}
@media (max-width: 420px){
  .container{
    padding: 16px;
    padding-left: calc(16px + var(--safe-left));
    padding-right: calc(16px + var(--safe-right));
    padding-top: calc(16px + var(--safe-top));
    padding-bottom: calc(16px + var(--safe-bottom));
  }
}

/* =========================
 * HEADER
 * ======================= */
header{
  text-align: center;
  padding: clamp(14px, 2.6vw, 18px) clamp(14px, 3vw, 18px);
  position: relative;
  z-index: 10;

  background:
    radial-gradient(900px 220px at 50% -38%, rgba(255,255,255,0.075), transparent 64%),
    radial-gradient(560px 240px at 20% 34%, rgba(59,224,123,0.16), transparent 64%),
    linear-gradient(180deg, rgba(6, 28, 20, 0.86), rgba(4, 16, 12, 0.70));

  border-radius: 16px;
  border: 1px solid rgba(59,224,123,0.20);

  box-shadow:
    0 16px 60px rgba(0,0,0,0.54),
    0 0 0 1px rgba(0,0,0,0.24) inset,
    0 0 40px rgba(59,224,123,0.08);

  overflow: hidden;
  isolation: isolate;

  -webkit-mask-image: -webkit-radial-gradient(white, black);
  clip-path: inset(0 round 16px);

  container-type: inline-size;
}
@media (max-width: 420px){
  header{ border-radius: 14px; clip-path: inset(0 round 14px); }
}
header::before{
  content:"";
  position:absolute;
  inset:-2px;
  pointer-events:none;
  z-index: 0;
  opacity: 0.28;
  background:
    radial-gradient(560px 260px at 18% 28%, rgba(255,255,255,0.095), transparent 66%),
    radial-gradient(680px 280px at 86% 46%, rgba(59,224,123,0.18), transparent 66%),
    radial-gradient(560px 260px at 50% 140%, rgba(20,184,166,0.085), transparent 66%);
}
header::after{
  content:"";
  position:absolute;
  inset: 0;
  pointer-events:none;
  z-index: 1;
  opacity: 0.46;
  background:
    linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.00) 46%),
    radial-gradient(900px 240px at 50% -14%, rgba(255,255,255,0.075), transparent 62%);
  mix-blend-mode: overlay;
}

.hero-title{
  position: relative;
  z-index: 2;
  font-weight: 1000;
  text-transform: uppercase;
  line-height: 1.05;
  margin: 2px 0 clamp(8px, 1.4vw, 10px);
  text-shadow: 0 16px 40px rgba(0,0,0,0.60);

  display: inline-flex;
  flex-wrap: wrap;
  align-items: baseline;
  justify-content: center;
  gap: 0.42em;

  font-size: clamp(1.18rem, 3.2vw, 2.22rem);
  letter-spacing: clamp(0.06em, 0.22vw, 0.10em);
}
.hero-top{
  display: inline;
  font-size: inherit;
  color: rgba(215,255,233,0.92);
  white-space: nowrap;
}
.hero-brand{
  display: inline;
  font-size: inherit;
  white-space: nowrap;
  background: linear-gradient(180deg, #d7ffe9 0%, #65f0a3 44%, #3be07b 72%, #128a45 100%);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  filter:
    drop-shadow(0 14px 28px rgba(59,224,123,0.12))
    drop-shadow(0 0 14px rgba(59,224,123,0.08));
}

.subtitle{
  font-size: clamp(0.74rem, 1.55cqw, 0.92rem);
  color: rgba(215,255,233,0.78);
  font-weight: 850;
  text-transform: uppercase;
  letter-spacing: clamp(0.06em, 0.18cqw, 0.10em);
  position: relative;
  z-index: 2;
  line-height: 1.35;
  text-shadow: 0 10px 24px rgba(0,0,0,0.56);
  max-width: 1100px;
  margin-left: auto;
  margin-right: auto;
  padding-inline: clamp(0px, 1.4cqw, 14px);
  text-wrap: balance;
}
@supports not (font-size: 1cqw){
  .subtitle{ font-size: clamp(0.74rem, 2.0vw, 0.92rem); padding-inline: 0; }
}

/* =========================
 * MAIN GRID
 * ======================= */
.main-content{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: clamp(18px, 4vw, 34px);
  align-items: start;
  margin: clamp(18px, 4vw, 28px) 0 40px;
}
.main-content > * { min-width: 0; }
@media (max-width: 900px){
  .main-content{ grid-template-columns: 1fr; gap: clamp(18px, 4vw, 26px); }
}

/* =========================
 * WHEEL AREA
 * ======================= */
.wheel-container{
  position: relative;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  isolation: isolate;
  background: transparent;
  --wheel-size: min(470px, 92vw, 56svh);
  padding-top: clamp(14px, 3vw, 20px);
  padding-bottom: clamp(22px, 6vw, 46px);
}
@supports (height: 100dvh){
  .wheel-container{ --wheel-size: min(470px, 92vw, 56dvh); }
}

/* Soft beams (transform-only) */
.wheel-container::after{
  content:"";
  position:absolute;
  left: 50%;
  top: 22%;
  width: calc(var(--wheel-size) * 1.48);
  height: calc(var(--wheel-size) * 1.48);
  transform: translate(-50%, -50%);
  border-radius: 50%;
  pointer-events: none;
  z-index: 0;
  background:
    conic-gradient(from -10deg,
      rgba(255,255,255,0.00) 0deg,
      rgba(255,255,255,0.05) 14deg,
      rgba(255,255,255,0.00) 30deg,
      rgba(255,255,255,0.06) 54deg,
      rgba(255,255,255,0.00) 78deg,
      rgba(255,255,255,0.045) 108deg,
      rgba(255,255,255,0.00) 140deg,
      rgba(255,255,255,0.07) 176deg,
      rgba(255,255,255,0.00) 210deg,
      rgba(255,255,255,0.055) 244deg,
      rgba(255,255,255,0.00) 276deg,
      rgba(255,255,255,0.06) 310deg,
      rgba(255,255,255,0.00) 360deg
    ),
    radial-gradient(circle at 50% 50%, rgba(59,224,123,0.11), transparent 64%);
  opacity: 0.50;
  animation: beamsPulse 6.2s ease-in-out infinite;
  transform-origin: 50% 50%;
}
@keyframes beamsPulse{
  0%{ opacity: 0.44; transform: translate(-50%, -50%) scale(0.995); }
  50%{ opacity: 0.62; transform: translate(-50%, -50%) scale(1.01); }
  100%{ opacity: 0.44; transform: translate(-50%, -50%) scale(0.995); }
}

.wheel-container::before{
  content:"";
  position: absolute;
  width: var(--wheel-size);
  height: var(--wheel-size);
  left: 50%;
  top: calc(50% - 6px);
  transform: translate(-50%, -50%);
  border-radius: 50%;
  pointer-events: none;
  z-index: 0;
  background:
    radial-gradient(circle at 50% 60%, rgba(0,0,0,0.74), transparent 64%),
    radial-gradient(circle at 50% 50%, rgba(243,178,74,0.06), transparent 64%),
    radial-gradient(circle at 50% 50%, rgba(59,224,123,0.075), transparent 68%);
}

/* wrapper */
.wheel-wrapper{
  position: relative;
  width: var(--wheel-size);
  aspect-ratio: 1 / 1;
  height: auto;
  max-width: 100%;
  touch-action: manipulation;
  user-select: none;
  -webkit-user-select: none;
  background: transparent;
  isolation: isolate;
  z-index: 2;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}

/* =========================
 * POINTER
 * ======================= */
.pointer{
  position: absolute;
  top: clamp(-34px, -6.4vw, -22px);
  left: 50%;
  transform: translateX(-50%);
  transform-origin: 50% 18%;
  z-index: 30;
  width: clamp(40px, 10.5vw, 58px);
  height: clamp(56px, 13.6vw, 78px);
  filter:
    drop-shadow(0 18px 30px rgba(0,0,0,0.64))
    drop-shadow(0 0 16px rgba(59,224,123,0.08));
  pointer-events: none;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}
.pointer svg { width: 100%; height: 100%; display:block; }

/* animate only when needed */
.pointer.is-spin,
.pointer.is-kick{ will-change: transform; }

.pointer.is-spin{ animation: pointerFloat 560ms ease-in-out infinite; }
@keyframes pointerFloat{
  0%{ transform: translateX(-50%) rotate(-1.0deg) translateY(0px); }
  50%{ transform: translateX(-50%) rotate(1.5deg) translateY(1px); }
  100%{ transform: translateX(-50%) rotate(-1.0deg) translateY(0px); }
}
.pointer.is-kick{ animation: pointerKick 120ms ease-out 1; }
@keyframes pointerKick{
  0%{ transform: translateX(-50%) rotate(0deg); }
  45%{ transform: translateX(-50%) rotate(var(--kick-deg, -11deg)); }
  100%{ transform: translateX(-50%) rotate(0deg); }
}

/* =========================
 * OUTER RIM
 * ======================= */
.wheel-outer{
  width: 100%;
  height: 100%;
  border-radius: 50%;
  padding: var(--rim-pad);
  position: relative;
  z-index: 2;
  isolation: isolate;
  overflow: hidden;

  background:
    radial-gradient(circle at 28% 18%, rgba(255,255,255,0.22), transparent 46%),
    radial-gradient(circle at 50% 88%, rgba(0,0,0,0.62), transparent 60%),
    conic-gradient(from 14deg,
      rgba(255,255,255,0.26),
      rgba(0,0,0,0.00) 10%,
      rgba(255,255,255,0.10) 18%,
      rgba(0,0,0,0.00) 30%,
      rgba(255,255,255,0.08) 40%,
      rgba(0,0,0,0.00) 54%,
      rgba(255,255,255,0.14) 66%,
      rgba(0,0,0,0.00) 80%,
      rgba(255,255,255,0.26) 100%
    ),
    linear-gradient(180deg,
      rgba(255, 241, 211, 0.98) 0%,
      rgba(243, 178, 74, 0.98) 48%,
      rgba(122, 63, 19, 1.00) 100%
    );

  border: 1px solid rgba(255, 232, 176, 0.28);
  box-shadow:
    var(--shadow-deep),
    0 0 34px rgba(243,178,74,0.12);

  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}
.wheel-outer > * { position: relative; z-index: 4; }

.wheel-outer::before{
  content:"";
  position:absolute;
  inset: 0;
  border-radius: 50%;
  pointer-events:none;
  background:
    conic-gradient(from 0deg,
      rgba(255,255,255,0.00) 0deg,
      rgba(255,255,255,0.00) 28deg,
      rgba(255,255,255,0.18) 44deg,
      rgba(255,255,255,0.00) 58deg,
      rgba(255,255,255,0.00) 180deg,
      rgba(255,255,255,0.10) 206deg,
      rgba(255,255,255,0.00) 228deg,
      rgba(255,255,255,0.00) 360deg
    );
  mix-blend-mode: screen;
  opacity: 0.30;
  animation: rimSheen 8.8s linear infinite;
  transform-origin: 50% 50%;
  z-index: 2;
}
@keyframes rimSheen{ to { transform: rotate(360deg); } }

.wheel-outer::after{
  content:"";
  position:absolute;
  inset: 7px;
  border-radius: 50%;
  pointer-events:none;
  z-index: 3;
  border: 1px solid rgba(255, 232, 176, 0.22);
  box-shadow:
    inset 0 0 0 1px rgba(0,0,0,0.20),
    inset 0 10px 18px rgba(255,255,255,0.06),
    inset 0 -14px 18px rgba(0,0,0,0.24);
  opacity: 0.96;
}

/* =========================
 * WHEEL INNER
 * ======================= */
.wheel-inner{
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: var(--wheel-bg, conic-gradient(from 0deg, #064e3b 0deg 60deg, #f8fafc 60deg 120deg, #064e3b 120deg 180deg, #f8fafc 180deg 240deg, #064e3b 240deg 300deg, #f8fafc 300deg 360deg));
  border: 1px solid rgba(255,255,255,0.10);
  box-shadow:
    inset 0 0 0 1px rgba(0,0,0,0.22),
    inset 0 18px 32px rgba(0,0,0,0.34),
    inset 0 -16px 26px rgba(255,255,255,0.05);
  position: relative;
  overflow: hidden;
  isolation: isolate;
  background-clip: padding-box;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  --spin-dur: 6000ms;

  /* idle */
  transform: rotate(var(--from-rotation, 0deg));
}

.wheel-inner::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:50%;
  pointer-events:none;
  background:
    radial-gradient(circle at 32% 24%, rgba(255,255,255,0.15), transparent 58%),
    radial-gradient(circle at 72% 74%, rgba(243,178,74,0.07), transparent 62%),
    radial-gradient(circle at 50% 56%, rgba(0,0,0,0.20), transparent 64%),
    radial-gradient(circle at 50% 50%, rgba(0,0,0,0.10), transparent 72%);
  opacity: 0.66;
  z-index: 2;
  mix-blend-mode: overlay;
  transform: scale(var(--inner-safe-scale));
  transform-origin: 50% 50%;
}

/* Core sweep (no blur) */
.wheel-corefx{
  position:absolute;
  inset:0;
  border-radius:50%;
  pointer-events:none;
  z-index: 6;
  transform-origin: 50% 50%;
  mix-blend-mode: screen;
  opacity: 0.84;
  background:
    conic-gradient(from 0deg,
      rgba(255,255,255,0.00) 0deg,
      rgba(255,255,255,0.14) 26deg,
      rgba(59,224,123,0.22) 58deg,
      rgba(255,255,255,0.00) 96deg,
      rgba(243,178,74,0.12) 140deg,
      rgba(255,255,255,0.00) 220deg,
      rgba(59,224,123,0.16) 294deg,
      rgba(255,255,255,0.00) 360deg
    ),
    radial-gradient(circle at 50% 50%,
      rgba(59,224,123,0.12),
      rgba(0,0,0,0.00) 64%
    );
  -webkit-mask: radial-gradient(circle at 50% 50%,
    rgba(0,0,0,1) 0%,
    rgba(0,0,0,1) 34%,
    rgba(0,0,0,0.86) 46%,
    rgba(0,0,0,0.00) 58%,
    rgba(0,0,0,0.00) 100%
  );
          mask: radial-gradient(circle at 50% 50%,
    rgba(0,0,0,1) 0%,
    rgba(0,0,0,1) 34%,
    rgba(0,0,0,0.86) 46%,
    rgba(0,0,0,0.00) 58%,
    rgba(0,0,0,0.00) 100%
  );
  animation: coreFXRotate 9.4s linear infinite;
}
@keyframes coreFXRotate{
  from{ transform: scale(var(--inner-safe-scale)) rotate(0deg); }
  to  { transform: scale(var(--inner-safe-scale)) rotate(360deg); }
}

.wheel-inner.spinning{
  will-change: transform;
  animation: spin-wheel var(--spin-dur) cubic-bezier(0.15, 0, 0.15, 1) forwards;
}
@keyframes spin-wheel{
  from { transform: rotate(var(--from-rotation, 0deg)); }
  to   { transform: rotate(var(--rotation)); }
}
.wheel-inner.spinning .wheel-corefx{
  opacity: 0.60;
  animation-duration: 2.2s;
}

/* Prize text */
.prize-text{
  position:absolute;
  left:50%;
  top:50%;
  transform-origin: 50% 50%;
  font-weight: 1000;
  font-size: clamp(18px, 3.2vw, 20px);
  line-height: 1.05;
  user-select:none;
  pointer-events:none;
  white-space: nowrap;
  max-width: 74%;
  overflow: hidden;
  text-overflow: ellipsis;
  letter-spacing: 0.38px;
  text-align: center;
  -webkit-font-smoothing: antialiased;
  text-rendering: geometricPrecision;
  font-variant-numeric: tabular-nums;
  -webkit-text-stroke: 0.32px rgba(0,0,0,0.22);
  z-index: 10;
  contain: paint;
}
body.low-end .prize-text{ -webkit-text-stroke: 0.24px rgba(0,0,0,0.18); }

/* =========================
 * CENTER HUB (FULL GOLD)
 * ======================= */
.wheel-center{
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: clamp(62px, 15vw, 78px);
  height: clamp(62px, 15vw, 78px);
  border-radius: 50%;
  overflow: hidden;
  isolation: isolate;

  background:
    radial-gradient(circle at 28% 22%, rgba(255,255,255,0.34), transparent 48%),
    radial-gradient(circle at 55% 70%, rgba(122,63,19,0.42), transparent 66%),
    repeating-conic-gradient(from 18deg,
      rgba(255,255,255,0.028) 0deg,
      rgba(255,255,255,0.010) 10deg,
      rgba(0,0,0,0.012) 22deg,
      rgba(255,255,255,0.020) 36deg
    ),
    linear-gradient(180deg,
      rgba(255, 244, 220, 0.98) 0%,
      rgba(248, 202, 108, 0.98) 34%,
      rgba(243, 178, 74, 0.99) 58%,
      rgba(176, 92, 26, 0.98) 82%,
      rgba(122, 63, 19, 1.00) 100%
    );

  border: 1px solid rgba(255, 232, 176, 0.34);
  box-shadow:
    0 22px 54px rgba(0,0,0,0.62),
    0 0 18px rgba(243,178,74,0.16),
    inset 0 0 0 1px rgba(255,255,255,0.10),
    inset 0 0 0 2px rgba(0,0,0,0.14);

  z-index: 20;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}

.wheel-center .hub-sheen{
  position:absolute;
  inset:-10%;
  border-radius:50%;
  pointer-events:none;
  z-index: 0;
  opacity: 0.54;
  mix-blend-mode: screen;
  background:
    conic-gradient(from 0deg,
      rgba(255,255,255,0.00) 0deg,
      rgba(255,255,255,0.18) 26deg,
      rgba(255,255,255,0.00) 78deg,
      rgba(255, 226, 164, 0.14) 150deg,
      rgba(255,255,255,0.00) 228deg,
      rgba(255, 206, 110, 0.18) 272deg,
      rgba(255,255,255,0.00) 360deg
    );
  animation: hubSheen 9.2s linear infinite;
}
@keyframes hubSheen{ to { transform: rotate(360deg); } }

.wheel-center::before{
  content:"";
  position:absolute;
  inset: 10%;
  border-radius: 50%;
  background:
    radial-gradient(circle at 30% 26%, rgba(255,255,255,0.20), transparent 54%),
    radial-gradient(circle at 55% 70%, rgba(122,63,19,0.40), transparent 66%),
    repeating-conic-gradient(from 24deg,
      rgba(255,255,255,0.020) 0deg,
      rgba(0,0,0,0.010) 14deg,
      rgba(255,255,255,0.012) 28deg
    ),
    linear-gradient(180deg,
      rgba(255, 240, 206, 0.96) 0%,
      rgba(243,178,74,0.98) 55%,
      rgba(156, 78, 22, 0.98) 100%
    );
  border: 1px solid rgba(255,255,255,0.14);
  box-shadow:
    inset 0 0 16px rgba(0,0,0,0.36),
    inset 0 0 0 1px rgba(255,255,255,0.08);
  z-index: 1;
}

.wheel-center::after{
  content: "";
  position:absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: clamp(26px, 8vw, 38px);
  height: clamp(26px, 8vw, 38px);
  border-radius: 50%;
  background:
    radial-gradient(circle at 32% 28%, rgba(255,255,255,0.28), transparent 56%),
    radial-gradient(circle at 56% 70%, rgba(122,63,19,0.44), transparent 70%),
    repeating-conic-gradient(from 8deg,
      rgba(255,255,255,0.028) 0deg,
      rgba(0,0,0,0.012) 18deg,
      rgba(255,255,255,0.016) 34deg
    ),
    linear-gradient(180deg,
      rgba(255, 244, 220, 0.96) 0%,
      rgba(243,178,74,0.98) 56%,
      rgba(122,63,19,1.00) 100%
    );
  border: 1px solid rgba(255,255,255,0.14);
  box-shadow:
    inset 0 0 14px rgba(0,0,0,0.38),
    0 6px 16px rgba(0,0,0,0.32);
  z-index: 2;
}

/* Pulse on spin (transform only) */
.wheel-inner.spinning .wheel-center{
  will-change: transform;
  animation: hubPulse 1.32s ease-in-out infinite;
}
.wheel-inner.spinning .wheel-center .hub-sheen{ animation-duration: 1.26s; }
@keyframes hubPulse{
  0%  { transform: translate(-50%,-50%) scale(1.00); }
  50% { transform: translate(-50%,-50%) scale(1.035); }
  100%{ transform: translate(-50%,-50%) scale(1.00); }
}

/* =========================
 * SPIN FOCUS OVERLAY
 * ======================= */
#spinFocusOverlay{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 900;
  opacity: 0;
  transition: opacity var(--dur) var(--ease);
  background:
    radial-gradient(circle at var(--focus-x, 50vw) var(--focus-y, 40vh),
      rgba(0,0,0,0) 0px,
      rgba(0,0,0,0) var(--focus-r1, 240px),
      rgba(0,0,0,0.72) var(--focus-r2, 340px),
      rgba(0,0,0,0.88) 100%
    );
}
body.spin-focus-on #spinFocusOverlay{ opacity: 1; }

/* Header always above overlay */
body.spin-focus-on header{
  position: sticky;
  top: calc(10px + var(--safe-top));
  z-index: 1200;
  pointer-events: auto;
  box-shadow:
    0 18px 70px rgba(0,0,0,0.62),
    0 0 0 1px rgba(59,224,123,0.22) inset,
    0 0 46px rgba(59,224,123,0.10);
}
body.spin-focus-on header *{ pointer-events: auto; }

#wheelWrap:focus, .wheel-wrapper:focus{ outline: none !important; }

body.spin-focus-on .wheel-wrapper{
  filter:
    drop-shadow(0 28px 64px rgba(0,0,0,0.65))
    drop-shadow(0 0 40px rgba(59,224,123,0.12))
    drop-shadow(0 0 18px rgba(243,178,74,0.08));
  transform: scale(1.02);
  transition: transform 260ms var(--ease), filter 260ms var(--ease);
}

body.spin-focus-on .main-content > :not(.wheel-container):not(header){
  pointer-events: none;
  opacity: 0.22;
  filter: saturate(0.92);
  transition: opacity var(--dur) ease, filter var(--dur) ease;
}

/* scroll perf guard */
body.spin-focus-on.spin-focus-scrolling .wheel-wrapper{
  transform: none;
  filter: drop-shadow(0 18px 44px rgba(0,0,0,0.58));
}
body.spin-focus-on.spin-focus-scrolling #spinFocusOverlay{ opacity: 0.90; }

/* =========================
 * INPUT CARD
 * ======================= */
.input-section{
  background:
    radial-gradient(520px 260px at 18% 10%, rgba(255,255,255,0.05), transparent 62%),
    linear-gradient(135deg, rgba(59,224,123,0.07), rgba(0,0,0,0.30));
  border: 1px solid rgba(59,224,123,0.20);
  border-radius: var(--radius-lg);
  padding: clamp(18px, 4vw, 30px);
  box-shadow:
    0 18px 70px rgba(0,0,0,0.48),
    0 0 56px -18px rgba(59,224,123,0.18);
  margin-bottom: 14px;
  overflow: hidden;
  isolation: isolate;
  position: relative;
}
.input-section::before{
  content:"";
  position:absolute;
  inset: -2px;
  pointer-events:none;
  opacity: 0.52;
  background:
    radial-gradient(420px 220px at 20% 15%, rgba(255,255,255,0.09), transparent 66%),
    radial-gradient(520px 260px at 90% 35%, rgba(59,224,123,0.14), transparent 66%);
}
.input-section::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius: inherit;
  pointer-events:none;
  opacity: .48;
  background:
    linear-gradient(to bottom, rgba(255,255,255,.10), rgba(255,255,255,0) 26%),
    radial-gradient(520px 240px at 50% 0%, rgba(255,255,255,.06), rgba(255,255,255,0) 62%);
  mix-blend-mode: screen;
}
@supports ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
  .input-section{
    backdrop-filter: blur(var(--blur-lg));
    -webkit-backdrop-filter: blur(var(--blur-lg));
  }
}
.input-section h2{
  font-size: clamp(1.18rem, 2.4vw, 1.42rem);
  margin-bottom: 10px;
  text-shadow: 0 10px 26px rgba(0,0,0,0.56);
  letter-spacing: var(--letter-tight);
}
.input-section p{
  color: rgba(255, 255, 255, 0.74);
  margin-bottom: 18px;
  font-size: 0.95rem;
  line-height: 1.45;
}
label{
  display: block;
  margin-bottom: 10px;
  font-weight: 900;
  color: rgba(255,255,255,0.92);
  letter-spacing: var(--letter-tight);
}

/* Inputs */
input{
  width: 100%;
  height: 54px;
  font-size: 18px;
  text-align: center;
  padding: 0 16px;
  line-height: 54px;

  background: rgba(255,255,255,0.055);
  border: 1px solid rgba(255,255,255,0.16);
  border-radius: 12px;

  color: rgba(255,255,255,0.94);
  caret-color: rgba(255,255,255,0.92);

  margin-bottom: 14px;
  transition:
    transform 0.12s ease,
    box-shadow var(--dur) ease,
    border-color var(--dur) ease,
    background var(--dur) ease;

  outline: none;
  appearance: none;
  -webkit-appearance: none;

  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  letter-spacing: 1.1px;

  box-shadow:
    inset 0 0 0 1px rgba(0,0,0,0.30),
    0 10px 30px rgba(0,0,0,0.22);

  -webkit-text-fill-color: rgba(255,255,255,0.94);
  font-variant-numeric: tabular-nums;
  text-rendering: geometricPrecision;
}
input:hover{
  border-color: rgba(255,255,255,0.22);
  background: rgba(255,255,255,0.065);
}
input:focus{
  border-color: rgba(59,224,123,0.52);
  background: rgba(255,255,255,0.08);
  box-shadow:
    0 0 0 4px rgba(59,224,123,0.14),
    0 18px 46px rgba(0,0,0,0.48);
  transform: translateY(-1px);
}
input::placeholder{ color: rgba(255,255,255,0.38); letter-spacing: 1.1px; line-height: 54px; opacity: 1; }
input::-webkit-input-placeholder{ line-height: 54px; opacity: 1; }
input:disabled{
  opacity: .62;
  cursor: not-allowed;
  background: rgba(255,255,255,0.035);
}
input:invalid{
  border-color: rgba(239,68,68,0.52);
  box-shadow:
    0 0 0 4px rgba(239,68,68,0.12),
    0 18px 46px rgba(0,0,0,0.46);
}
input:-webkit-autofill{
  -webkit-text-fill-color: rgba(255,255,255,0.94);
  transition: background-color 99999s ease-out 0s;
  box-shadow: 0 0 0px 1000px rgba(255,255,255,0.055) inset, 0 10px 30px rgba(0,0,0,0.22);
  border: 1px solid rgba(255,255,255,0.16);
}

/* Buttons */
.primary-btn{
  width: 100%;
  min-height: 64px;
  height: auto;
  padding: 14px 16px;

  font-size: 22px;
  font-weight: 1000;
  letter-spacing: 1.1px;
  color: rgba(0,0,0,0.92);

  border: 1px solid rgba(59,224,123,0.64);
  border-radius: 12px;
  cursor: pointer;

  transition: transform 0.12s ease, box-shadow var(--dur) ease, background var(--dur) ease, opacity 0.2s ease;
  box-shadow:
    0 0 42px rgba(59,224,123,0.20),
    0 18px 60px rgba(0,0,0,0.32);

  position: relative;
  overflow: hidden;
  appearance: none;
  -webkit-appearance: none;
  user-select: none;
  touch-action: manipulation;

  background:
    radial-gradient(240px 96px at 50% -24%, rgba(255,255,255,0.20), rgba(255,255,255,0.00) 62%),
    linear-gradient(to bottom, var(--green1), var(--green2));
}
.primary-btn::before{
  content:"";
  position:absolute;
  inset:-2px;
  background: linear-gradient(90deg, rgba(255,255,255,0.0), rgba(255,255,255,0.34), rgba(255,255,255,0.0));
  transform: translateX(-120%);
  opacity: 0.72;
  pointer-events:none;
}
.primary-btn:hover:not(:disabled){
  transform: translateY(-1px);
  box-shadow:
    0 0 52px rgba(59,224,123,0.26),
    0 22px 70px rgba(0,0,0,0.34);
  background:
    radial-gradient(260px 104px at 50% -24%, rgba(255,255,255,0.22), rgba(255,255,255,0.00) 64%),
    linear-gradient(to bottom, rgba(215,255,233,0.92), var(--green1));
}
.primary-btn:hover:not(:disabled)::before{ animation: sheen 920ms ease-out; }
@keyframes sheen{ from { transform: translateX(-120%); } to { transform: translateX(120%); } }
.primary-btn:active:not(:disabled){
  transform: translateY(0px) scale(0.99);
  box-shadow:
    0 0 24px rgba(59,224,123,0.18),
    0 16px 54px rgba(0,0,0,0.30);
}
.primary-btn:disabled{ opacity: 0.62; cursor: not-allowed; }

.primary-btn.fx::after{
  content:"";
  position:absolute;
  left: var(--fx-x, 50%);
  top: var(--fx-y, 50%);
  width: 10px;
  height: 10px;
  border-radius: 50%;
  transform: translate(-50%, -50%) scale(0);
  background: radial-gradient(circle, rgba(255,255,255,0.66), rgba(59,224,123,0.14), rgba(0,0,0,0.0));
  animation: ripple 520ms ease-out forwards;
  pointer-events:none;
}
@keyframes ripple{ to { transform: translate(-50%, -50%) scale(32); opacity: 0; } }

.secondary-btn{
  width: 100%;
  min-height: 52px;
  height: auto;
  padding: 12px 14px;

  font-size: 16px;
  font-weight: 1000;

  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.16);

  background:
    radial-gradient(240px 110px at 50% -30%, rgba(255,255,255,0.085), rgba(255,255,255,0.00) 62%),
    rgba(0,0,0,0.44);

  color: rgba(255,255,255,0.92);
  cursor: pointer;

  transition: transform 0.12s ease, background 0.2s ease, border-color 0.2s ease, box-shadow var(--dur) ease;
  position: relative;
  overflow: hidden;
  appearance: none;
  -webkit-appearance: none;
  box-shadow: 0 14px 50px rgba(0,0,0,0.28);

  user-select: none;
  touch-action: manipulation;
}
.secondary-btn:hover{
  background:
    radial-gradient(240px 110px at 50% -30%, rgba(255,255,255,0.10), rgba(255,255,255,0.00) 64%),
    rgba(0,0,0,0.56);
  border-color: rgba(255,255,255,0.24);
}
.secondary-btn:active{ transform: scale(0.99); }

.primary-btn.is-ready:not(:disabled){ animation: btnPulse 2.8s var(--ease) infinite; }
@keyframes btnPulse{
  0%,100%{
    box-shadow:
      0 0 42px rgba(59,224,123,0.18),
      0 18px 60px rgba(0,0,0,0.32);
  }
  50%{
    box-shadow:
      0 0 58px rgba(59,224,123,0.24),
      0 18px 60px rgba(0,0,0,0.32);
  }
}
.primary-btn.is-loading{
  pointer-events: none;
  opacity: .78;
}
.primary-btn.is-loading::after{
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(90deg,
    rgba(255,255,255,0),
    rgba(255,255,255,.18),
    rgba(255,255,255,0)
  );
  transform: translateX(-120%);
  animation: sheen 900ms ease-out infinite;
  opacity: .52;
}

/* No-hover devices: prevent sticky hover */
@media (hover: none){
  input:hover{
    border-color: rgba(255,255,255,0.16);
    background: rgba(255,255,255,0.055);
  }
  .secondary-btn:hover{
    background:
      radial-gradient(240px 110px at 50% -30%, rgba(255,255,255,0.085), rgba(255,255,255,0.00) 62%),
      rgba(0,0,0,0.44);
    border-color: rgba(255,255,255,0.16);
  }
}

/* =========================
 * JACKPOT / MESSAGE
 * ======================= */
.jackpot-display{ display:flex; flex-direction:column; align-items:center; gap:6px; padding-top:14px; }
.jackpot-label{ font-size:0.85rem; color: rgba(255,255,255,0.62); }
.jackpot-amount{
  font-size: 1.24rem;
  font-weight: 1000;
  color: #65f0a3;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  letter-spacing: 1px;
  text-shadow: 0 12px 26px rgba(0,0,0,0.48);
}
.jackpot-meta{
  font-size: 0.82rem;
  color: rgba(255,255,255,0.56);
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  letter-spacing: 0.3px;
  text-align: center;
}
.spun-message{
  text-align: center;
  padding: 13px 14px;
  background: rgba(239, 68, 68, 0.16);
  border: 1px solid rgba(239, 68, 68, 0.44);
  border-radius: 10px;
  color: rgba(248, 113, 113, 0.92);
  margin-bottom: 14px;
  line-height: 1.35;
  box-shadow: 0 16px 44px rgba(0,0,0,0.30);
}

/* =========================
 * WINNERS
 * ======================= */
.winners-section{
  position: relative;
  background:
    radial-gradient(680px 320px at 18% 0%, rgba(255,255,255,0.055), transparent 62%),
    radial-gradient(820px 420px at 92% 18%, rgba(59,224,123,0.08), transparent 64%),
    linear-gradient(180deg, rgba(0,0,0,0.30), rgba(0,0,0,0.18));
  border: 1px solid rgba(255,255,255,0.09);
  border-radius: 16px;
  overflow: hidden;
  min-width: 0;
  box-shadow:
    0 22px 78px rgba(0,0,0,0.44),
    0 0 0 1px rgba(0,0,0,0.22) inset;
  isolation: isolate;
  content-visibility: auto;
  contain-intrinsic-size: 340px;
}
.winners-section::before{
  content:"";
  position:absolute;
  inset:-2px;
  pointer-events:none;
  opacity: 0.55;
  background:
    radial-gradient(520px 220px at 24% 18%, rgba(255,255,255,0.09), transparent 66%),
    radial-gradient(620px 260px at 86% 30%, rgba(59,224,123,0.14), transparent 70%),
    linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.00) 42%);
}
@supports ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
  .winners-section{ backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); }
}

.winners-header{
  position: relative;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 16px;
  font-weight: 1000;
  font-size: 1.02rem;
  letter-spacing: var(--letter-tight);
  background:
    radial-gradient(520px 180px at 22% -24%, rgba(255,255,255,0.11), transparent 60%),
    linear-gradient(to right, rgba(59,224,123,0.22), rgba(59,224,123,0.06));
  border-bottom: 1px solid rgba(59,224,123,0.12);
  text-shadow: 0 10px 26px rgba(0,0,0,0.56);
  z-index: 2;
}
.winners-header::after{
  content:"";
  position:absolute;
  left: 0; right: 0; bottom: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.10), transparent);
  opacity: 0.65;
  pointer-events:none;
}

.winners-table{
  width: 100%;
  max-height: 320px;
  overflow-x: hidden;
  overflow-y: auto;
  display: block;
  overscroll-behavior: contain;
  scroll-behavior: smooth;
  padding-bottom: 2px;
  scrollbar-width: thin;
  scrollbar-color: rgba(59,224,123,0.28) rgba(0,0,0,0.22);
  -webkit-overflow-scrolling: touch;
  scroll-padding-top: 56px;
}
.winners-table::-webkit-scrollbar{ width: 6px; }
.winners-table::-webkit-scrollbar-track{ background: rgba(0,0,0,0.22); }
.winners-table::-webkit-scrollbar-thumb{
  background: rgba(59,224,123,0.26);
  border-radius: 999px;
}
.winners-table::-webkit-scrollbar-thumb:hover{ background: rgba(59,224,123,0.44); }

.winners-table-header,
.winners-table-row{
  display: grid;
  grid-template-columns: 56px minmax(0, 1fr) clamp(120px, 28vw, 170px);
  gap: 10px;
  padding: 12px 16px;
  align-items: center;
  width: 100%;
  min-width: 0;
}
.winners-table-header{
  background: rgba(0,0,0,0.72);
  font-weight: 1000;
  color: rgba(215,255,233,0.92);
  position: sticky;
  top: 0;
  z-index: 3;
  border-bottom: 2px solid rgba(59,224,123,0.18);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  isolation: isolate;
  white-space: nowrap;
}
.winners-table-header > div{ white-space: nowrap; }

.winners-table-row{
  border-bottom: 1px solid rgba(255,255,255,0.05);
  position: relative;
  transition: transform 260ms ease, background 220ms ease, box-shadow 220ms ease;
  cursor: default;
  user-select: none;
}
.winners-table-row::before{
  content:"";
  position:absolute;
  inset: 0;
  pointer-events:none;
  opacity: 0;
  background: radial-gradient(520px 120px at 50% 50%, rgba(255,255,255,0.06), transparent 62%);
  transition: opacity 220ms ease;
}
.winners-table-row:hover::before{ opacity: 1; }
.winners-table-row:hover:not(.is-user){ background: rgba(255,255,255,0.022); }

.winners-table-row.is-user{
  cursor: pointer;
  background: rgba(59,224,123,0.085);
  box-shadow:
    inset 0 0 0 1px rgba(59,224,123,0.18),
    inset 0 0 18px rgba(59,224,123,0.06);
}
.winners-table-row.is-user:hover{
  background: rgba(59,224,123,0.11);
  box-shadow:
    inset 0 0 0 1px rgba(59,224,123,0.24),
    0 12px 38px rgba(0,0,0,0.26);
}

.winner-no{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  color: rgba(255,255,255,0.62);
  text-align: center;
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
}
.winner-id{
  font-weight: 1000;
  color: rgba(255,255,255,0.96);
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  letter-spacing: var(--letter-tight);
}
.winner-meta{
  font-size: 0.85rem;
  color: rgba(255,255,255,0.56);
  margin-top: 2px;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.winner-prize{
  text-align: right;
  font-weight: 1000;
  color: #65f0a3;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
  text-shadow: 0 10px 26px rgba(0,0,0,0.40);
}

@keyframes rowIn{
  from{ opacity:0; transform: translateY(-8px); }
  to{ opacity:1; transform: translateY(0); }
}
@keyframes shimmer{
  from{ transform: translateX(-70%); opacity: 0; }
  15%{ opacity: 1; }
  to{ transform: translateX(70%); opacity: 0; }
}
.winners-table-row.is-new{
  animation: rowIn 240ms ease-out;
  background: linear-gradient(90deg, rgba(59,224,123,0.14), rgba(255,255,255,0.03));
  box-shadow:
    inset 0 0 0 1px rgba(59,224,123,0.20),
    inset 0 0 22px rgba(59,224,123,0.06);
}
.winners-table-row.is-new::after{
  content:"";
  position:absolute;
  inset: 0;
  pointer-events:none;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.22), transparent);
  transform: translateX(-70%);
  animation: shimmer 980ms ease-out forwards;
}

/* Mobile keep 3 columns */
@media (max-width: 420px){
  .winners-header{ padding: 10px 12px; font-size: 0.95rem; gap: 8px; }
  .winners-table-header,
  .winners-table-row{
    padding: 10px 12px;
    gap: 8px;
    grid-template-columns: 40px minmax(0, 1fr) clamp(88px, 26vw, 130px);
  }
  .winners-table-header{ font-size: 0.90rem; }
  .winner-no{ font-size: 0.85rem; }
  .winner-id{ font-size: 0.95rem; }
  .winner-meta{ font-size: 0.78rem; }
  .winner-prize{ font-size: 0.95rem; }
}
@media (max-width: 360px){
  .winners-table-header,
  .winners-table-row{
    grid-template-columns: 36px minmax(0, 1fr) clamp(84px, 28vw, 118px);
  }
  .winners-header{ font-size: 0.92rem; }
  .winners-table-header{ font-size: 0.88rem; }
}

/* =========================
 * MODAL
 * ======================= */
body.modal-open { overflow: hidden; }

.modal{
  display: none;
  position: fixed;
  inset: 0;
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding:
    calc(12px + var(--safe-top))
    calc(12px + var(--safe-right))
    calc(12px + var(--safe-bottom))
    calc(12px + var(--safe-left));
  background: rgba(0,0,0,0.72);
  isolation: isolate;
}
.modal.show{
  display: flex;
  animation: modalFadeIn 180ms ease-out both;
}
@keyframes modalFadeIn{ from{ opacity: 0; } to{ opacity: 1; } }
.modal::before{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  background:
    radial-gradient(900px 520px at 50% 18%, rgba(59,224,123,0.12), transparent 60%),
    radial-gradient(900px 520px at 50% 120%, rgba(255,255,255,0.06), transparent 62%),
    linear-gradient(to bottom, rgba(0,0,0,0.18), rgba(0,0,0,0.34));
  opacity: .95;
}
@supports ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
  .modal{ backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
}
.modal-content{
  position: relative;
  width: 100%;
  max-width: clamp(280px, 86vw, 480px);
  border-radius: 18px;
  padding: clamp(12px, 3.2vw, 24px);
  background:
    radial-gradient(520px 280px at 18% 10%, rgba(255,255,255,0.045), transparent 62%),
    linear-gradient(135deg, rgba(6,18,14,0.965), rgba(7,26,20,0.94));
  border: 1px solid rgba(59,224,123,0.36);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,0.06),
    0 0 44px rgba(59,224,123,0.12),
    0 22px 70px rgba(0,0,0,0.58);
  animation: modalPop 200ms var(--ease) both;
  max-height: min(72svh, 560px);
  overflow: auto;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: rgba(59,224,123,0.22) rgba(0,0,0,0.20);
  text-align: center;
}
@supports (max-height: 72dvh){
  .modal-content{ max-height: min(72dvh, 560px); }
}
@keyframes modalPop{
  from{ opacity: 0; transform: translateY(10px) scale(0.985); }
  to{ opacity: 1; transform: translateY(0) scale(1); }
}
.modal-content :where(h1,h2,h3,p,small,strong,em,span,div,li,ul,ol){ text-align: center; }
.modal-content ul, .modal-content ol{ list-style-position: inside; padding-left: 0; margin-left: 0; }
.modal-content h1{
  font-size: clamp(1.22rem, 4.8vw, 2.05rem);
  margin: 0 0 8px;
  text-shadow: 0 14px 34px rgba(0,0,0,0.56);
  letter-spacing: var(--letter-tight);
}
.modal-content p{
  color: rgba(255,255,255,0.84);
  margin: 0 0 12px;
  font-size: clamp(0.92rem, 3.2vw, 1.02rem);
  line-height: 1.45;
}
.prize-amount{
  font-size: clamp(1.55rem, 7vw, 2.65rem);
  font-weight: 1000;
  color: var(--green0);
  margin: 14px 0 8px;
  line-height: 1.08;
  text-shadow: 0 18px 44px rgba(0,0,0,0.60);
}
.prize-meta{
  font-size: clamp(0.86rem, 3.1vw, 0.95rem);
  color: rgba(255,255,255,0.72);
  margin-top: 4px;
  line-height: 1.4;
}
.mono{
  display: inline-block;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  font-variant-numeric: tabular-nums;
  letter-spacing: 0.5px;
  color: rgba(255,255,255,0.92);
  font-weight: 900;
}
.modal-actions{
  display:flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 14px;
  align-items: center;
}
.modal-actions .primary-btn{
  width: 100%;
  max-width: 320px;
  min-height: 56px;
  font-size: 19px;
}
.modal-actions .secondary-btn{
  width: 100%;
  max-width: 320px;
  min-height: 50px;
  font-size: 15.5px;
}
@media (max-width: 380px){
  .modal{
    padding:
      calc(10px + var(--safe-top))
      calc(10px + var(--safe-right))
      calc(10px + var(--safe-bottom))
      calc(10px + var(--safe-left));
  }
  .modal-content{
    border-radius: 16px;
    max-width: clamp(270px, 90vw, 420px);
    max-height: min(70svh, 520px);
  }
  .modal-actions .primary-btn{ min-height: 54px; font-size: 18px; }
}

/* =========================
 * TOAST
 * ======================= */
.toast{
  position: fixed;
  left: 50%;
  bottom: calc(18px + var(--safe-bottom));
  transform: translateX(-50%);
  z-index: 1200;
  width: min(520px, calc(100vw - 28px));
  background: rgba(0,0,0,0.74);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 14px;
  padding: 12px 14px;
  display: none;
  gap: 10px;
  align-items: center;
  box-shadow: 0 20px 70px rgba(0,0,0,0.56);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  isolation: isolate;
}
.toast.show{ display: flex; animation: toastIn 180ms ease-out; }
@keyframes toastIn {
  from { opacity: 0; transform: translateX(-50%) translateY(6px); }
  to   { opacity: 1; transform: translateX(-50%) translateY(0); }
}
.toast .dot{
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--green1);
  box-shadow: 0 0 14px rgba(59,224,123,0.34);
  flex: 0 0 auto;
}
.toast .msg{ color: rgba(255,255,255,0.94); font-weight: 900; line-height: 1.3; font-size: 0.98rem; }
.toast.error .dot{ background: #ef4444; box-shadow: 0 0 14px rgba(239,68,68,0.34); }
.toast.success .dot{ background: #65f0a3; box-shadow: 0 0 14px rgba(59,224,123,0.30); }

/* =========================
 * LOADING OVERLAY (CLAIM)
 * ======================= */
.nav-loading{
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;

  background: rgba(0,0,0,0.78);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);

  padding: calc(14px + var(--safe-top)) calc(14px + var(--safe-right)) calc(14px + var(--safe-bottom)) calc(14px + var(--safe-left));

  opacity: 0;
  visibility: hidden;
  pointer-events: none;

  transition:
    opacity 240ms ease,
    visibility 0s linear 240ms;
  isolation: isolate;
}
.nav-loading.show{
  opacity: 1;
  visibility: visible;
  pointer-events: auto;
  transition: opacity 240ms ease, visibility 0s;
}
.nav-loading-card{
  width: min(520px, calc(100vw - 28px));
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.10);
  background:
    radial-gradient(520px 240px at 18% 10%, rgba(255,255,255,0.05), transparent 62%),
    linear-gradient(135deg, rgba(6,18,14,0.98), rgba(7,30,22,0.96));
  box-shadow: 0 25px 90px rgba(0,0,0,0.64);
  padding: 18px 18px;
  display: flex;
  gap: 12px;
  align-items: center;
  transform: translateY(4px);
  transition: transform 240ms ease;
}
.nav-loading.show .nav-loading-card{ transform: translateY(0); }
.nav-spinner{
  width: 34px;
  height: 34px;
  border-radius: 999px;
  border: 3px solid rgba(255,255,255,0.14);
  border-top-color: rgba(59,224,123,0.90);
  animation: navSpin 820ms linear infinite;
  flex: 0 0 auto;
}
@keyframes navSpin{ to{ transform: rotate(360deg); } }
.nav-title{ font-weight: 1000; color: rgba(255,255,255,0.94); line-height: 1.2; }
.nav-sub{ font-size: 0.92rem; color: rgba(255,255,255,0.62); margin-top: 2px; }

/* =========================
 * AUTO PERF GUARDS
 * ======================= */
/* Mobile / coarse pointer: ringan */
@media (max-width: 520px), (hover: none), (pointer: coarse){
  :root{
    --grain-opacity: 0.024;
    --fx-opacity: 0.60;
    --vignette-opacity: 0.88;
  }
  .wheel-container::after{ opacity: 0.42; animation-duration: 7.6s; }
  .wheel-outer::before{ opacity: 0.24; animation-duration: 10.8s; }
  .wheel-corefx{ opacity: 0.74; animation-duration: 11.6s; }
  .primary-btn{ font-size: 20px; letter-spacing: 1.0px; }
}

/* low-end class from JS: extra downgrade */
body.low-end #fxCanvas{ opacity: 0.48; }
body.low-end::after{ opacity: 0.020; }
body.low-end .wheel-container::after{ opacity: 0.30; animation: none; }
body.low-end .wheel-outer{
  box-shadow: 0 22px 70px rgba(0,0,0,0.58), 0 0 26px rgba(243,178,74,0.09);
}
body.low-end .wheel-outer::before{ animation: none; opacity: 0.18; }
body.low-end .wheel-corefx{ opacity: 0.64; animation: none; }

/* Safari safety */
@supports (-webkit-touch-callout: none){
  header::after{ opacity: 0.44; }
}

/* Reduced motion: strict off */
@media (prefers-reduced-motion: reduce){
  * { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
  .winners-table-row.is-new::after { display: none !important; }
  .nav-spinner{ animation: none !important; }
  #fxCanvas{ display:none !important; }
  .wheel-container::after{ display:none !important; }
  body::after{ display:none !important; }
  .wheel-corefx{ display:none !important; }
}

/* Optional: Reduced transparency (kalau device minta) */
@media (prefers-reduced-transparency: reduce){
  #fxCanvas{ opacity: 0.40; }
  body::after{ opacity: 0.018; }
  .modal::before{ opacity: 0.80; }
}

/* =========================
 * FINAL: legacy focus rule safe
 * ======================= */
:focus-visible{
  outline: 3px solid var(--ring);
  outline-offset: 3px;
  border-radius: 10px;
}
</style>

</head>

<body>
  <canvas id="fxCanvas" aria-hidden="true"></canvas>

  <div class="container" id="mainContainer">
    <header>
      <h1 class="hero-title">
        <span class="hero-top">SELAMAT DATANG DI</span>
        <span class="hero-brand">MADETOTO2</span>
      </h1>
      <p class="subtitle">PUTAR RODANYA &amp; DAPATKAN HADIAH FANTASTIS HINGGA 200 RIBU RUPIAH!</p>
    </header>

    <div class="main-content">
      <div class="wheel-container">
        <div class="wheel-wrapper" id="wheelWrap">
          <div class="pointer" id="pointerEl" aria-hidden="true">
            <svg viewBox="0 0 64 90" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="metal" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0" stop-color="rgba(255,255,255,0.90)"/>
                  <stop offset="0.24" stop-color="rgba(195,195,195,0.92)"/>
                  <stop offset="0.56" stop-color="rgba(88,88,88,0.96)"/>
                  <stop offset="1" stop-color="rgba(18,18,18,0.98)"/>
                </linearGradient>
                <linearGradient id="gold" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0" stop-color="#FFF4D6"/>
                  <stop offset="0.52" stop-color="#F6B33D"/>
                  <stop offset="1" stop-color="#8A4A16"/>
                </linearGradient>
                <radialGradient id="cap" cx="35%" cy="30%" r="70%">
                  <stop offset="0" stop-color="rgba(255,255,255,0.98)"/>
                  <stop offset="0.45" stop-color="#FFF4D6"/>
                  <stop offset="1" stop-color="#B45309"/>
                </radialGradient>
              </defs>
              <path d="M32 86 L10 34 C10 34 14 10 32 10 C50 10 54 34 54 34 L32 86 Z"
                    fill="url(#gold)" stroke="rgba(255,255,255,0.22)" stroke-width="2"/>
              <path d="M32 80 L18 36 C18 36 20 18 32 18 C44 18 46 36 46 36 L32 80 Z"
                    fill="url(#metal)" opacity="0.96"/>
              <circle cx="32" cy="27" r="11" fill="url(#cap)" stroke="rgba(0,0,0,0.22)" stroke-width="2"/>
              <circle cx="32" cy="27" r="4.2" fill="rgba(10,10,10,0.78)" stroke="rgba(255,255,255,0.16)" stroke-width="1.5"/>
            </svg>
          </div>

          <div class="wheel-outer">
            <div class="wheel-inner" id="wheel" aria-label="Lucky wheel">
              <div class="wheel-corefx" aria-hidden="true"></div>
              <div class="wheel-center" aria-hidden="true">
                <span class="hub-sheen" aria-hidden="true"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="input-section">
          <h2>MASUKKAN USER ID</h2>
          <p>Masukkan User ID Anda untuk memutar roda keberuntungan.</p>

          <label for="userIdInput">User ID</label>
          <input
            type="text"
            id="userIdInput"
            placeholder="Contoh: User123"
            maxlength="20"
            autocomplete="off"
            autocapitalize="off"
            autocorrect="off"
            spellcheck="false"
            inputmode="text"
          />

          <button id="spinBtn" class="primary-btn" type="button">SPIN SEKARANG!</button>

          <div class="jackpot-display" aria-live="polite">
            <div class="jackpot-label">Total Jackpot</div>
            <div class="jackpot-amount" id="jackpot">IDR 888.888.888</div>
            <div class="jackpot-meta" id="jackpotMeta">Update: --:--:--</div>
          </div>
        </div>

        <div id="spunMessage" class="spun-message" style="display:none;">
          Kesempatan spin Anda sudah habis. Silakan klaim hadiah Anda.
        </div>

        <div class="winners-section">
          <div class="winners-header">🏆 50 Riwayat Spin Terakhir</div>
          <div class="winners-table" id="winnersTable" aria-live="polite">
            <div class="winners-table-header">
              <div>NO</div>
              <div>USER ID</div>
              <div>HADIAH</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true">
    <div class="dot" aria-hidden="true"></div>
    <div class="msg" id="toastMsg">Toast</div>
  </div>

  <div class="modal" id="prizeModal" role="dialog" aria-modal="true" aria-labelledby="prizeTitle" aria-hidden="true">
    <div class="modal-content" role="document">
      <h1 id="prizeTitle">SELAMAT!</h1>
      <p>Anda memenangkan hadiah</p>
	   <div class="prize-amount" id="prizeAmount">-</div>

      <div class="prize-meta">
        User ID : <span class="mono" id="modalUserId">-</span><br/>
        Waktu : <span class="mono" id="modalTime">-</span>
      </div>

      <p style="margin-top: 14px;">Klaim sekarang melalui Live Chat dan sertakan User ID.</p>

      <div class="modal-actions">
        <button type="button" class="primary-btn" id="claimBtn">KLAIM SEKARANG</button>
        <button type="button" class="secondary-btn" id="downloadBtn">UNDUH HASIL</button>
		<button type="button" class="secondary-btn" id="shareBtn">BAGIKAN</button>
      </div>
      <div class="prize-meta" style="margin-top:10px;">
        Klik unduh hasil akan tersimpan otomatis di perangkat dan klik bagikan ke semua sosial media Anda.
      </div>
    </div>
  </div>

  <div class="nav-loading" id="navLoading" aria-hidden="true">
    <div class="nav-loading-card" role="status" aria-live="polite" aria-atomic="true">
      <div class="nav-spinner" aria-hidden="true"></div>
      <div>
        <div class="nav-title">Menghubungkan…</div>
        <div class="nav-sub">Mengarahkan ke halaman server</div>
      </div>
    </div>
  </div>

  <!-- Chaport Live Chat -->
  <script type="text/javascript">
    (function(w,d,v3){
      w.chaportConfig = { appId : '6937b4ead2823b3f94b0a834' };
      if(w.chaport) return;
      v3 = w.chaport = {};
      v3._q = [];
      v3._l = {};
      v3.q = function(){ v3._q.push(arguments) };
      v3.on = function(e,fn){ if(!v3._l[e]) v3._l[e]=[]; v3._l[e].push(fn) };
      var s = d.createElement('script');
      s.type = 'text/javascript';
      s.async = true;
      s.src = 'https://app.chaport.com/javascripts/insert.js';
      var ss = d.getElementsByTagName('script')[0];
      ss.parentNode.insertBefore(s, ss);
    })(window, document);
  </script>

  <!-- Audio -->
  <audio id="bgMusic" loop playsinline preload="auto"></audio>
  <audio id="spinSound" playsinline preload="auto"></audio>
  <audio id="tickSound" playsinline preload="auto"></audio>
  <audio id="winSound" playsinline preload="auto"></audio>
  <audio id="historySound" playsinline preload="auto"></audio>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>

<script>
/* ======================================================================
 * FINAL — FULL PATCH + POWER UP vNEXT (LOCK 150K/200K)
 * ✅ BONUS 10% dihapus total -> diganti 150K
 * ✅ Spin LOCK hanya ke: 150K atau 200K (persist hasil)
 * ✅ Persist wheel rotation + persist lastPrizeKey (reload konsisten)
 * ✅ Live history unique (seed + live)
 * ✅ Spin token cancels tick timers (no ghost ticks)
 * ✅ Modal focus trap + inert background (UX app-like)
 * ✅ Claim overlay watchdog (anti nyangkut)
 * ✅ Low-end auto downgrade (lebih stabil di mobile)
 * ✅ Time label rapi
 * ====================================================================== */

const CONFIG = {
  SPIN_DURATION_MS: 6000,
  CLAIM_URL: "https://newmadetoto2.com/",
  CLAIM_OVERLAY_MIN_MS: 700,

  LS_PREFIX: "mt2_spin_v2:",

  // ✅ BONUS 10% removed -> 150K added
  PRIZES: ["25K", "50K", "75K", "100K", "150K", "200K"],

  // ✅ LOCK RESULT: hanya 150K atau 200K
  LOCK_PRIZES: ["150K", "200K"],

  PRIZE_DISPLAY_MAP: {
    "25K": "IDR 25.000",
    "50K": "IDR 50.000",
    "75K": "IDR 75.000",
    "100K": "IDR 100.000",
    "150K": "IDR 150.000",
    "200K": "IDR 200.000",
  },

  AUDIO: {
    bg: "https://cdn.pixabay.com/download/audio/2022/03/24/audio_197846c632.mp3?filename=casino-music-1-2518.mp3",
    spin: "https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3",
    win: "https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3",
    tick: "https://assets.mixkit.co/active_storage/sfx/2063/2063-preview.mp3",
    history: "https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3",
    vol: { bg: 0.22, spin: 0.6, win: 0.85, tick: 0.55, history: 0.62 }
  }
};

const LS = {
  HAS_SPUN:      CONFIG.LS_PREFIX + "hasSpun",
  SPIN_AT:       CONFIG.LS_PREFIX + "spinAt",
  LAST_USER_ID:  CONFIG.LS_PREFIX + "lastUserId",
  LAST_PRIZE:    CONFIG.LS_PREFIX + "lastPrize",     // ✅ new (persist result key)
  JACKPOT_VAL:   CONFIG.LS_PREFIX + "jackpotVal",
  ROTATION:      CONFIG.LS_PREFIX + "rotation"
};

const PRIZES = CONFIG.PRIZES.slice();
const LOCK_PRIZES = CONFIG.LOCK_PRIZES.slice();

// ====== storage helpers ======
function lsGet(key, fallback = "") {
  try {
    const v = localStorage.getItem(key);
    return (v == null ? fallback : v);
  } catch (_) { return fallback; }
}
function lsSet(key, value) { try { localStorage.setItem(key, String(value)); } catch (_) {} }

function migrateLegacyKeys() {
  const legacy = {
    hasSpun:"hasSpun",
    spinAt:"spinAt",
    lastUserId:"lastUserId",
    jackpotVal:"jackpotVal",
    rotation:"rotation",
    lastPrize:"lastPrize" // optional legacy if pernah ada
  };
  if (!lsGet(LS.HAS_SPUN, "") && lsGet(legacy.hasSpun, "")) lsSet(LS.HAS_SPUN, lsGet(legacy.hasSpun, ""));
  if (!lsGet(LS.SPIN_AT, "") && lsGet(legacy.spinAt, "")) lsSet(LS.SPIN_AT, lsGet(legacy.spinAt, ""));
  if (!lsGet(LS.LAST_USER_ID, "") && lsGet(legacy.lastUserId, "")) lsSet(LS.LAST_USER_ID, lsGet(legacy.lastUserId, ""));
  if (!lsGet(LS.JACKPOT_VAL, "") && lsGet(legacy.jackpotVal, "")) lsSet(LS.JACKPOT_VAL, lsGet(legacy.jackpotVal, ""));
  if (!lsGet(LS.ROTATION, "") && lsGet(legacy.rotation, "")) lsSet(LS.ROTATION, lsGet(legacy.rotation, ""));
  if (!lsGet(LS.LAST_PRIZE, "") && lsGet(legacy.lastPrize, "")) lsSet(LS.LAST_PRIZE, lsGet(legacy.lastPrize, ""));
}
migrateLegacyKeys();

// ====== state ======
let hasSpun     = lsGet(LS.HAS_SPUN, "false") === "true";
let spinAt      = Number(lsGet(LS.SPIN_AT, "0") || "0") || 0;
let savedUserId = String(lsGet(LS.LAST_USER_ID, "") || "");
let savedPrizeKey = String(lsGet(LS.LAST_PRIZE, "") || "");

let isSpin = false;
let currentRotation = Number(lsGet(LS.ROTATION, "0") || "0") || 0;
let lastResult = null;

let winners = [];
let liveTimer = 0;

let rowElById = new Map();
let winnersById = new Map();

let jackpotTimer = 0;
let jackpotSaveTimer = 0;
let jackpot = 0;

let toastTimer = 0;
let metaTimer = 0;

let lastFocusedEl = null;

let tickPool = [];
let tickPoolIdx = 0;

let historyPool = [];
let historyPoolIdx = 0;
let historySfxAt = 0;

let nonUserToastAt = 0;
let audioPrimed = false;
let bgStarted = false;

let pointerEl = null;
let pointerKickT = 0;

// spin token + tick timers (cancel ghost ticks)
let spinToken = 0;
let tickTimers = [];

// live winners uniqueness (keep last 70)
const recentMasked = new Set();
const recentMaskedQueue = [];

// pause reasons for live history
const pauseReasons = new Set();
function pauseHistory(reason){ pauseReasons.add(String(reason||"x")); stopLiveHistory(); }
function resumeHistory(reason){
  pauseReasons.delete(String(reason||"x"));
  if (pauseReasons.size === 0 && !document.hidden) startLiveHistory();
}

// inert reasons (modal/nav)
const inertReasons = new Set();
function setInert(reason, on){
  const main = document.getElementById("mainContainer");
  if (!main) return;
  const r = String(reason || "x");
  if (on) inertReasons.add(r);
  else inertReasons.delete(r);

  const should = inertReasons.size > 0;
  try{
    if (should) {
      main.setAttribute("inert", "");
      main.setAttribute("aria-hidden", "true");
    } else {
      main.removeAttribute("inert");
      main.removeAttribute("aria-hidden");
    }
  }catch(_){}
}

function normalizeUserIdInput(v){
  return String(v==null?"":v).replace(/\s+/g,"").slice(0, 20);
}
function isReducedMotion(){
  return !!(window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches);
}

let __isLowEnd = false;
// Low-end heuristic for stability
function detectLowEnd(){
  try{
    const devMem = Number(navigator.deviceMemory || 0) || 0;
    const cores = Number(navigator.hardwareConcurrency || 0) || 0;
    const saveData = !!(navigator.connection && navigator.connection.saveData);
    const low = (saveData) || (devMem && devMem <= 2) || (cores && cores <= 4);
    __isLowEnd = !!low;
    if (low) document.body.classList.add("low-end");
  }catch(_){}
}

// =========================
// DOM READY
// =========================
document.addEventListener("DOMContentLoaded", () => {
  detectLowEnd();

  const spinBtn = document.getElementById("spinBtn");
  const userIdInput = document.getElementById("userIdInput");
  const claimBtn = document.getElementById("claimBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  pointerEl = document.getElementById("pointerEl");

  setupAudio();
  drawWheelPrizes();
  initWheelAutoResize();
  initFxParticlesCanvas();

  winners = generateMockWinnersRandom();
  bootPersistedUserEntry();
  
  warmRewardShareCache();

  // apply persisted rotation
  applyWheelRotation(currentRotation);

  renderWinners({ preserveScroll: true });
  startMetaTicker();
  setupHistoryRowOpen();

  updateUI();
  jackpot = initJackpot();
  startJackpot();
  startLiveHistory();

  userIdInput.addEventListener("input", () => {
    userIdInput.value = normalizeUserIdInput(userIdInput.value);
  });
  userIdInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); startSpin(); }
  });

  spinBtn.addEventListener("click", startSpin);
  spinBtn.addEventListener("pointerdown", (e) => pressFX(spinBtn, e), { passive: true });

  claimBtn.addEventListener("click", claimPrize);
  claimBtn.addEventListener("pointerdown", (e) => pressFX(claimBtn, e), { passive: true });

  downloadBtn.addEventListener("click", downloadResultPng);
  downloadBtn.addEventListener("pointerdown", (e) => pressFX(downloadBtn, e), { passive: true });

  const modal = document.getElementById("prizeModal");
  if (modal) {
    modal.addEventListener("click", (e) => {
      if (e.target && e.target.id === "prizeModal") closeModal();
    });
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      if (isModalOpen()) closeModal();
      return;
    }
    if (e.key === "Tab" && isModalOpen()) trapFocus(e);
  });

  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      endSpinFocus(false);
      stopLiveHistory();
      stopJackpot();
    } else {
      startJackpot();
      if (pauseReasons.size === 0) startLiveHistory();
    }
  });

  // Prime audio on first gesture only
  const kick = () => kickAudio(true);
  window.addEventListener("pointerdown", kick, { passive: true, once: true });
  window.addEventListener("keydown", kick, { passive: true, once: true });

  window.addEventListener("pageshow", () => { hideNavLoading(true); });

  // multi-tab sync
  window.addEventListener("storage", (e) => {
    if (!e || !e.key) return;

    if (
      e.key === LS.HAS_SPUN ||
      e.key === LS.SPIN_AT ||
      e.key === LS.LAST_USER_ID ||
      e.key === LS.LAST_PRIZE ||
      e.key === LS.ROTATION
    ) {
      hasSpun = lsGet(LS.HAS_SPUN, "false") === "true";
      spinAt = Number(lsGet(LS.SPIN_AT, "0") || "0") || 0;
      savedUserId = String(lsGet(LS.LAST_USER_ID, "") || "");
      savedPrizeKey = String(lsGet(LS.LAST_PRIZE, "") || "");
      currentRotation = Number(lsGet(LS.ROTATION, "0") || "0") || 0;

      bootPersistedUserEntry();
      applyWheelRotation(currentRotation);
      updateUI();
      renderWinners({ preserveScroll: true });
    }

    if (e.key === LS.JACKPOT_VAL) {
      const v = Number(lsGet(LS.JACKPOT_VAL, "0") || "0") || 0;
      if (v > 1000000) {
        jackpot = v;
        const el = document.getElementById("jackpot");
        const meta = document.getElementById("jackpotMeta");
        if (el) el.textContent = `IDR ${Math.round(jackpot).toLocaleString("id-ID")}`;
        if (meta) meta.textContent = `Update: ${fmtClock()}`;
      }
    }
  });
});

// =========================
// Wheel rotation persist
// =========================
function applyWheelRotation(deg){
  const wheel = document.getElementById("wheel");
  if (!wheel) return;
  wheel.classList.remove("spinning");
  wheel.style.transform = `rotate(${Number(deg || 0)}deg) translateZ(0)`;
}
function saveRotation(deg){
  currentRotation = Number(deg || 0);
  lsSet(LS.ROTATION, String(currentRotation));
}

// =========================
// FX CANVAS (auto low-end + pause on hidden)
// =========================
function initFxParticlesCanvas(){
  const c = document.getElementById("fxCanvas");
  if (!c) return;
  const ctx = c.getContext("2d", { alpha: true });
  if (!ctx) return;

  if (isReducedMotion()) { c.style.display = "none"; return; }

  const devMem = Number(navigator.deviceMemory || 0) || 4;
  const cores = Number(navigator.hardwareConcurrency || 0) || 6;
  const saveData = !!(navigator.connection && navigator.connection.saveData);
  const lowEnd = saveData || (devMem <= 2) || (cores <= 4);

  let w = 0, h = 0, dpr = 1;
  const parts = [];
  const maxParts = lowEnd ? 48 : 80;

  let rafId = 0;
  let running = true;

  const resize = () => {
    const dprCap = lowEnd ? 1.35 : 2;
    dpr = Math.min(dprCap, window.devicePixelRatio || 1);
    w = Math.max(1, Math.floor(window.innerWidth));
    h = Math.max(1, Math.floor(window.innerHeight));
    c.width = Math.floor(w * dpr);
    c.height = Math.floor(h * dpr);
    c.style.width = w + "px";
    c.style.height = h + "px";
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  };

  const rand = (a,b)=> a + Math.random()*(b-a);
  const pick = (arr)=> arr[(Math.random()*arr.length)|0];

  const spawn = () => {
    parts.push({
      x: rand(-40, w+40),
      y: rand(-40, h+40),
      r: rand(0.7, 2.2),
      vy: rand(-0.14, -0.04),
      vx: rand(-0.06, 0.06),
      a: rand(0.14, 0.50),
      tw: rand(0.004, 0.010),
      ph: rand(0, Math.PI*2),
      hue: pick([120, 140, 45, 50, 160]),
      life: rand(2400, 5200),
      t: 0
    });
  };

  const ensure = () => { while (parts.length < maxParts) spawn(); };

  const draw = (dt) => {
    ctx.clearRect(0,0,w,h);

    const g = ctx.createRadialGradient(w*0.5, h*0.28, 0, w*0.5, h*0.28, Math.max(w,h)*0.55);
    g.addColorStop(0, "rgba(34,197,94,0.075)");
    g.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    for (let i = parts.length-1; i >= 0; i--) {
      const p = parts[i];
      p.t += dt;
      p.x += p.vx * dt;
      p.y += p.vy * dt;

      const tw = (Math.sin(p.ph + p.t*p.tw) * 0.5 + 0.5);
      const alpha = Math.max(0, Math.min(1, p.a * (0.55 + tw*0.65) * (1 - (p.t/p.life))));
      const rr = p.r * (0.85 + tw*0.65);

      ctx.beginPath();
      ctx.fillStyle = `hsla(${p.hue}, 80%, 70%, ${alpha})`;
      ctx.arc(p.x, p.y, rr, 0, Math.PI*2);
      ctx.fill();

      ctx.globalAlpha = alpha * 0.28;
      ctx.strokeStyle = `hsla(${p.hue}, 85%, 78%, 1)`;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(p.x - rr*2.2, p.y);
      ctx.lineTo(p.x + rr*2.2, p.y);
      ctx.moveTo(p.x, p.y - rr*2.2);
      ctx.lineTo(p.x, p.y + rr*2.2);
      ctx.stroke();
      ctx.globalAlpha = 1;

      if (p.t >= p.life || p.y < -80) {
        parts.splice(i,1);
        spawn();
      }
    }
  };

  let last = performance.now();
  const tick = () => {
    if (!running) return;
    const now = performance.now();
    const dt = Math.min(34, now - last);
    last = now;
    ensure();
    draw(dt);
    rafId = requestAnimationFrame(tick);
  };

  const stop = () => { running = false; if (rafId) cancelAnimationFrame(rafId); rafId = 0; };
  const start = () => { if (running) return; running = true; last = performance.now(); rafId = requestAnimationFrame(tick); };

  resize();
  window.addEventListener("resize", resize, { passive: true });

  document.addEventListener("visibilitychange", () => {
    if (document.hidden) stop();
    else start();
  });

  rafId = requestAnimationFrame(tick);
}

// =========================
// AUDIO (clean start on first gesture)
// =========================
function setupAudio() {
  const bgMusic = document.getElementById("bgMusic");
  const spinSound = document.getElementById("spinSound");
  const tickSound = document.getElementById("tickSound");
  const winSound = document.getElementById("winSound");
  const historySound = document.getElementById("historySound");

  if (!bgMusic || !spinSound || !tickSound || !winSound || !historySound) return;

  bgMusic.src = CONFIG.AUDIO.bg;
  spinSound.src = CONFIG.AUDIO.spin;
  winSound.src = CONFIG.AUDIO.win;
  tickSound.src = CONFIG.AUDIO.tick;
  historySound.src = CONFIG.AUDIO.history;

  bgMusic.volume = CONFIG.AUDIO.vol.bg;
  spinSound.volume = CONFIG.AUDIO.vol.spin;
  winSound.volume = CONFIG.AUDIO.vol.win;
  tickSound.volume = CONFIG.AUDIO.vol.tick;
  historySound.volume = CONFIG.AUDIO.vol.history;

  tickPool = [];
  for (let i = 0; i < 6; i++) {
    const a = new Audio(tickSound.src);
    a.volume = tickSound.volume;
    a.preload = "auto";
    tickPool.push(a);
  }

  historyPool = [];
  for (let i = 0; i < 4; i++) {
    const a = new Audio(historySound.src);
    a.volume = historySound.volume;
    a.preload = "auto";
    historyPool.push(a);
  }
}

function primeAudioPool(pool){
  pool.forEach(a=>{
    try{
      const prevMuted = a.muted;
      a.muted = true;
      a.play().then(()=>{
        a.pause();
        a.currentTime = 0;
        a.muted = prevMuted;
      }).catch(()=>{ a.muted = prevMuted; });
    } catch(_){}
  });
}

function kickAudio(withBgStart = false) {
  if (!audioPrimed) {
    audioPrimed = true;
    primeAudioPool(tickPool);
    primeAudioPool(historyPool);
  }
  if (!withBgStart) return;

  if (!bgStarted) {
    bgStarted = true;
    const bgMusic = document.getElementById("bgMusic");
    if (bgMusic && bgMusic.paused) {
      bgMusic.play().then(()=> {
        showToast("Audio aktif", "success", 1400);
      }).catch(()=>{});
    }
  }
}

function pointerKick(intensity = 1) {
  if (!pointerEl) return;
  if (pointerKickT) clearTimeout(pointerKickT);

  const deg = (-8 - Math.random()*6) * intensity; // -8..-14
  pointerEl.style.setProperty("--kick-deg", deg.toFixed(2) + "deg");

  pointerEl.classList.remove("is-kick");
  void pointerEl.offsetWidth;
  pointerEl.classList.add("is-kick");
  pointerKickT = setTimeout(()=> pointerEl && pointerEl.classList.remove("is-kick"), 140);
}

function playTick(intensity = 1) {
  pointerKick(intensity);
  try {
    const a = tickPool[tickPoolIdx++ % tickPool.length];
    a.currentTime = 0;
    a.play().catch(() => {});
  } catch (_) {}
}

function playHistorySfx() {
  const now = Date.now();
  if (now - historySfxAt < 700) return;
  historySfxAt = now;
  try {
    const a = historyPool[historyPoolIdx++ % historyPool.length];
    a.currentTime = 0;
    a.play().catch(() => {});
  } catch (_) {}
}

// =========================
// BUTTON FX + TOAST
// =========================
function pressFX(btn, ev) {
  if (!btn) return;
  const rect = btn.getBoundingClientRect();
  let x = rect.width / 2, y = rect.height / 2;
  if (ev && ev.clientX != null && ev.clientY != null) { x = ev.clientX - rect.left; y = ev.clientY - rect.top; }
  btn.style.setProperty("--fx-x", x + "px");
  btn.style.setProperty("--fx-y", y + "px");
  btn.classList.remove("fx");
  void btn.offsetWidth;
  btn.classList.add("fx");
  setTimeout(() => btn.classList.remove("fx"), 560);
  try { if (navigator.vibrate && !isReducedMotion()) navigator.vibrate(12); } catch (_) {}
}

function showToast(message, type = "info", ms = 2400) {
  const toast = document.getElementById("toast");
  const msg = document.getElementById("toastMsg");
  if (!toast || !msg) return;

  toast.classList.remove("error", "success");
  if (type === "error") toast.classList.add("error");
  if (type === "success") toast.classList.add("success");

  msg.textContent = String(message || "");
  toast.classList.add("show");

  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove("show"), ms);
}

// =========================
// WHEEL BG + TEXT — CASINO PREMIUM (tangential + readable)
// - Label mengikuti keliling (tangent) seperti wheel casino
// - Auto flip biar tidak kebalik (anti upside-down)
// - Pooling element (no remove/recreate)
// - Cache render (skip kalau tidak berubah)
// - ResizeObserver pakai rAF (lebih smooth)
// =========================
const __wheelTextPool = [];
let __wheelRenderKey = "";
let __wheelBgKey = "";
let __wheelBgStr = "";

function setWheelBackground() {
  const wheel = document.getElementById("wheel");
  if (!wheel) return;

  const n = PRIZES.length || 1;
  const DARK = "#064e3b";
  const LIGHT = "#f1f5f9";

  const key = `${n}|${DARK}|${LIGHT}`;
  if (key === __wheelBgKey && __wheelBgStr) {
    wheel.style.setProperty("--wheel-bg", __wheelBgStr);
    return;
  }
  __wheelBgKey = key;

  const seg = 360 / n;

  // seam fix tipis (anti garis putih)
  const EPS = (n <= 8) ? 0.08 : 0.05;

  const parts = new Array(n);
  for (let i = 0; i < n; i++) {
    const a = i * seg;
    let b = (i + 1) * seg + EPS;
    if (i === n - 1) b = 360;
    const color = (i % 2 === 0) ? DARK : LIGHT;
    parts[i] = `${color} ${a.toFixed(3)}deg ${b.toFixed(3)}deg`;
  }

  __wheelBgStr = `conic-gradient(from 0deg, ${parts.join(",")})`;
  wheel.style.setProperty("--wheel-bg", __wheelBgStr);
}

function __getOrCreatePrizeEl(i, wheel) {
  let el = __wheelTextPool[i];
  if (!el) {
    el = document.createElement("div");
    el.className = "prize-text";
    el.style.willChange = "transform";
    __wheelTextPool[i] = el;
    wheel.appendChild(el);
  } else if (!el.isConnected) {
    wheel.appendChild(el);
  }
  return el;
}

function drawWheelPrizes() {
  const wheel = document.getElementById("wheel");
  if (!wheel) return;

  const n = PRIZES.length || 1;

  const size = Math.min(wheel.clientWidth || 0, wheel.clientHeight || 0);
  if (!size) return;

  const prizesKey = PRIZES.map(v => String(v)).join("\u0001");
  const key = `${n}|${size}|${prizesKey}`;
  if (key === __wheelRenderKey) {
    setWheelBackground();
    return;
  }
  __wheelRenderKey = key;

  setWheelBackground();

  const segmentAngle = 360 / n;

  // lebih “casino”: label agak mendekat ke rim
  const BASE_RADIUS = Math.round(size * 0.368);

  const isLowEnd = document.body && document.body.classList.contains("low-end");

  for (let i = 0; i < n; i++) {
    const prize = String(PRIZES[i]);
    const angle = i * segmentAngle + segmentAngle / 2;

    // Flip biar text tidak kebalik saat berada di sisi bawah/berlawanan
    const flip = (angle > 90 && angle < 270);
    const flipDeg = flip ? 180 : 0;

    const el = __getOrCreatePrizeEl(i, wheel);
    el.textContent = prize;

    // kontras per warna segmen
    const isLight = (i % 2 === 1);
    el.style.color = isLight ? "#05281d" : "#ffffff";

    // shadow low-end lebih ringan
    if (isLowEnd) {
      el.style.textShadow = isLight
        ? "0 1px 0 rgba(255,255,255,0.20), 0 6px 14px rgba(0,0,0,0.20)"
        : "0 2px 0 rgba(0,0,0,0.16), 0 10px 22px rgba(0,0,0,0.44)";
    } else {
      el.style.textShadow = isLight
        ? "0 1px 0 rgba(255,255,255,0.28), 0 10px 22px rgba(0,0,0,0.26)"
        : "0 2px 0 rgba(0,0,0,0.22), 0 14px 30px rgba(0,0,0,0.58), 0 0 18px rgba(255,255,255,0.08)";
    }

    // adaptif: label panjang → radius masuk + font lebih kecil
    let r = BASE_RADIUS;
    if (prize.length >= 9) {
      r = Math.round(r * 0.92);
      el.style.fontSize = "clamp(12px, 2.8vw, 16px)";
      el.style.letterSpacing = "0.25px";
    } else if (prize.length >= 7) {
      r = Math.round(r * 0.95);
      el.style.fontSize = "clamp(13px, 3.0vw, 18px)";
      el.style.letterSpacing = "0.30px";
    } else {
      el.style.removeProperty("font-size");
      el.style.removeProperty("letter-spacing");
    }

    // ✅ CASINO ROTATION: TANPA rotate(90) → text ikut keliling (tangent)
    // Hasil: atas = horizontal, sisi = miring natural, tetap readable
    el.style.transform =
      `translate(-50%, -50%) rotate(${angle}deg) translate(0, -${r}px) rotate(${flipDeg}deg) translateZ(0)`;
  }

  // buang extra kalau segmen berkurang
  for (let i = n; i < __wheelTextPool.length; i++) {
    const el = __wheelTextPool[i];
    if (el && el.isConnected) { try { el.remove(); } catch(_) {} }
  }
  __wheelTextPool.length = n;
}

function initWheelAutoResize() {
  const wrap = document.getElementById("wheelWrap");
  if (!wrap) return;

  let raf = 0;
  const rerender = () => {
    if (raf) return;
    raf = requestAnimationFrame(() => {
      raf = 0;
      drawWheelPrizes();
    });
  };

  if (window.ResizeObserver) {
    const ro = new ResizeObserver(rerender);
    ro.observe(wrap);
  } else {
    window.addEventListener("resize", rerender, { passive: true });
  }

  rerender();
}

/* =========================================================
 * HISTORY (random + realtime) — FIX CLICK + POWER UP MODERN v1
 * FULL REPLACE
 * ======================================================= */

// --- SAFE STATE GETTERS (works even if your globals are let/var or not on window)
function __mt2_getConfig(){
  try { if (typeof CONFIG !== "undefined" && CONFIG) return CONFIG; } catch(_){}
  return (typeof window !== "undefined" && window.CONFIG) ? window.CONFIG : { PRIZE_DISPLAY_MAP: {} };
}

function __mt2_getWinners(){
  try { if (typeof winners !== "undefined" && Array.isArray(winners)) return winners; } catch(_){}
  const w = (typeof window !== "undefined") ? window : {};
  if (!Array.isArray(w.__mt2_winners)) w.__mt2_winners = [];
  return w.__mt2_winners;
}
function __mt2_setWinners(arr){
  try { if (typeof winners !== "undefined") { winners = arr; return; } } catch(_){}
  const w = (typeof window !== "undefined") ? window : {};
  w.__mt2_winners = Array.isArray(arr) ? arr : [];
}

function __mt2_getRowElById(){
  try { if (typeof rowElById !== "undefined" && rowElById) return rowElById; } catch(_){}
  const w = (typeof window !== "undefined") ? window : {};
  if (!w.__mt2_rowElById) w.__mt2_rowElById = new Map();
  return w.__mt2_rowElById;
}
function __mt2_getWinnersById(){
  try { if (typeof winnersById !== "undefined" && winnersById) return winnersById; } catch(_){}
  const w = (typeof window !== "undefined") ? window : {};
  if (!w.__mt2_winnersById) w.__mt2_winnersById = new Map();
  return w.__mt2_winnersById;
}
function __mt2_setWinnersById(map){
  try { if (typeof winnersById !== "undefined") { winnersById = map; return; } } catch(_){}
  const w = (typeof window !== "undefined") ? window : {};
  w.__mt2_winnersById = map;
}

function __mt2_getRecentMasked(){
  try { if (typeof recentMasked !== "undefined" && recentMasked) return recentMasked; } catch(_){}
  const w = (typeof window !== "undefined") ? window : {};
  if (!w.__mt2_recentMasked) w.__mt2_recentMasked = new Set();
  return w.__mt2_recentMasked;
}
function __mt2_getRecentMaskedQueue(){
  try { if (typeof recentMaskedQueue !== "undefined" && recentMaskedQueue) return recentMaskedQueue; } catch(_){}
  const w = (typeof window !== "undefined") ? window : {};
  if (!Array.isArray(w.__mt2_recentMaskedQueue)) w.__mt2_recentMaskedQueue = [];
  return w.__mt2_recentMaskedQueue;
}

function __mt2_getPauseReasons(){
  try { if (typeof pauseReasons !== "undefined" && pauseReasons) return pauseReasons; } catch(_){}
  const w = (typeof window !== "undefined") ? window : {};
  if (!w.__mt2_pauseReasons) w.__mt2_pauseReasons = new Set();
  return w.__mt2_pauseReasons;
}

function __mt2_getMetaTimer(){
  try { if (typeof metaTimer !== "undefined") return metaTimer || 0; } catch(_){}
  const w = (typeof window !== "undefined") ? window : {};
  return w.__mt2_metaTimer || 0;
}
function __mt2_setMetaTimer(v){
  try { if (typeof metaTimer !== "undefined") { metaTimer = v; return; } } catch(_){}
  const w = (typeof window !== "undefined") ? window : {};
  w.__mt2_metaTimer = v;
}
function __mt2_getLiveTimer(){
  try { if (typeof liveTimer !== "undefined") return liveTimer || 0; } catch(_){}
  const w = (typeof window !== "undefined") ? window : {};
  return w.__mt2_liveTimer || 0;
}
function __mt2_setLiveTimer(v){
  try { if (typeof liveTimer !== "undefined") { liveTimer = v; return; } } catch(_){}
  const w = (typeof window !== "undefined") ? window : {};
  w.__mt2_liveTimer = v;
}
function __mt2_getNonUserToastAt(){
  try { if (typeof nonUserToastAt !== "undefined") return nonUserToastAt || 0; } catch(_){}
  const w = (typeof window !== "undefined") ? window : {};
  return w.__mt2_nonUserToastAt || 0;
}
function __mt2_setNonUserToastAt(v){
  try { if (typeof nonUserToastAt !== "undefined") { nonUserToastAt = v; return; } } catch(_){}
  const w = (typeof window !== "undefined") ? window : {};
  w.__mt2_nonUserToastAt = v;
}

// --- OPTIONAL: tiny UX CSS injection (safe)
function ensureHistoryStyles(){
  const D = (typeof document !== "undefined") ? document : null;
  if (!D) return;
  if (D.getElementById("mt2HistoryStyles")) return;

  const style = D.createElement("style");
  style.id = "mt2HistoryStyles";
  style.textContent = `
    #winnersTable .winners-table-row{ cursor:pointer; -webkit-tap-highlight-color: transparent; }
    #winnersTable .winners-table-row:not(.is-user){ cursor:not-allowed; }
    #winnersTable .winners-table-row.is-user:hover{ filter: brightness(1.06); }
    #winnersTable .winners-table-row.is-user:focus{ outline:2px solid rgba(255,255,255,.28); outline-offset:2px; border-radius:10px; }
  `;
  D.head && D.head.appendChild(style);
}

// =========================
// HISTORY (random + realtime) — UNIQUE
// =========================
function pickWeightedPrizeKey() {
  const bag = [
    ["25K", 18],
    ["50K", 18],
    ["75K", 14],
    ["100K", 14],
    ["150K", 16],
    ["200K", 10],
  ];
  const total = bag.reduce((a, [,w]) => a + w, 0);
  let r = Math.random() * total;
  for (const [p, w] of bag) { r -= w; if (r <= 0) return p; }
  return "50K";
}

function pickLockedPrizeKey() {
  const bag = [
    ["150K", 60],
    ["200K", 40],
  ];
  const total = bag.reduce((a, [,w]) => a + w, 0);
  let r = Math.random() * total;
  for (const [p, w] of bag) { r -= w; if (r <= 0) return p; }
  return "150K";
}

function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function pad2(n) { return String(n).padStart(2, "0"); }

function randomUserId() {
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
  const pick = (s) => s[Math.floor(Math.random() * s.length)];
  const len = randInt(7, 11);
  let out = "";
  for (let i = 0; i < len; i++) out += (Math.random() < 0.30) ? String(randInt(0,9)) : pick(letters);
  if (Math.random() < 0.35) out += String(randInt(0,9));
  return out;
}

function maskUserId(str) {
  const s = String(str || "");
  if (s.length <= 2) return "****";
  if (s.length <= 6) return s.slice(0, 2) + "****";
  return (s.slice(0, 3) + "****" + s.slice(-2));
}

function makeEntryId(prefix) {
  return `${prefix || "w"}-${Date.now()}-${Math.random().toString(16).slice(2)}-${Math.random().toString(16).slice(2)}`;
}

function rememberMasked(id){
  const recentMasked = __mt2_getRecentMasked();
  const recentMaskedQueue = __mt2_getRecentMaskedQueue();

  const v = String(id || "");
  if (!v) return;
  if (recentMasked.has(v)) return;

  recentMasked.add(v);
  recentMaskedQueue.push(v);

  while (recentMaskedQueue.length > 70) {
    const old = recentMaskedQueue.shift();
    recentMasked.delete(old);
  }
}

function uniqueMaskedId(maxTry = 60){
  const recentMasked = __mt2_getRecentMasked();
  for (let i = 0; i < maxTry; i++) {
    const masked = maskUserId(randomUserId());
    if (!recentMasked.has(masked)) {
      rememberMasked(masked);
      return masked;
    }
  }
  const fallback = maskUserId(randomUserId());
  rememberMasked(fallback);
  return fallback;
}

// ✅ helper untuk entry user asli (biar klik pasti bisa kebuka)
function buildUserWinnerEntry(userId, prizeKey, ts){
  const CFG = __mt2_getConfig();
  const safeUser = String(userId || "").trim();
  const key = String(prizeKey || "");
  return {
    id: makeEntryId("user"),
    isUser: true,
    fullId: safeUser,
    displayId: maskUserId(safeUser),
    prizeKey: key,
    prize: (CFG.PRIZE_DISPLAY_MAP && CFG.PRIZE_DISPLAY_MAP[key]) ? CFG.PRIZE_DISPLAY_MAP[key] : key,
    ts: Number(ts || Date.now()),
    isNew: true
  };
}

function generateMockWinnersRandom() {
  const CFG = __mt2_getConfig();

  let base = Date.now() - randInt(40, 220) * 1000;
  const arr = [];

  for (let i = 0; i < 50; i++) {
    const prizeKey = pickWeightedPrizeKey();
    const masked = uniqueMaskedId();

    arr.push({
      id: makeEntryId("seed"),
      isUser: false,
      fullId: "",
      displayId: masked,
      prizeKey,
      prize: (CFG.PRIZE_DISPLAY_MAP && CFG.PRIZE_DISPLAY_MAP[prizeKey]) ? CFG.PRIZE_DISPLAY_MAP[prizeKey] : prizeKey,
      ts: base,
      isNew: false
    });

    base -= randInt(20, 160) * 1000;
  }

  arr.sort((a,b) => (b.ts || 0) - (a.ts || 0));
  return arr;
}

function timeLabel(ts) {
  const d = new Date(ts || Date.now());
  const dateStr = d.toLocaleDateString("id-ID", { day: "2-digit", month: "short", year: "numeric" });
  const timeStr = `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;

  const diff = Math.max(0, Date.now() - (ts || Date.now()));
  const sec = Math.floor(diff / 1000);

  let rel = "baru saja";
  if (sec >= 60) {
    const min = Math.floor(sec / 60);
    if (min < 60) rel = `${min}m lalu`;
    else {
      const hr = Math.floor(min / 60);
      if (hr < 24) rel = `${hr}j lalu`;
      else rel = `${Math.floor(hr / 24)} hari lalu`;
    }
  }
  return `${dateStr} ${timeStr} • ${rel}`;
}

function startMetaTicker() {
  const prev = __mt2_getMetaTimer();
  if (prev) clearInterval(prev);

  const t = setInterval(() => {
    document.querySelectorAll(".winner-meta[data-ts]").forEach(el => {
      const ts = Number(el.getAttribute("data-ts") || Date.now());
      el.textContent = timeLabel(ts);
    });
  }, 15000);

  __mt2_setMetaTimer(t);
}

function pushWinnerEntry(entry) {
  if (!entry) return;

  const winners = __mt2_getWinners();

  if (!entry.id) entry.id = makeEntryId(entry.isUser ? "user" : "live");
  if (entry.isNew && typeof playHistorySfx === "function") playHistorySfx();

  winners.forEach(w => (w.isNew = false));
  winners.unshift(entry);

  const trimmed = winners.slice(0, 50);
  __mt2_setWinners(trimmed);

  renderWinners({ preserveScroll: true });
  startMetaTicker();

  // auto-clear "isNew" biar ga nempel
  setTimeout(() => {
    const w2 = __mt2_getWinners();
    const found = w2.find(x => x && x.id === entry.id);
    if (found) found.isNew = false;
    renderWinners({ preserveScroll: true });
  }, 2400);
}

function startLiveHistory() {
  const pauseReasons = __mt2_getPauseReasons();
  if (__mt2_getLiveTimer()) return;
  if (pauseReasons.size > 0) return;

  const schedule = () => {
    stopLiveHistory();
    const ms = randInt(5200, 12500);

    const to = setTimeout(() => {
      try{
        const okModal = (typeof isModalOpen === "function") ? !isModalOpen() : true;
        const okSpin  = (typeof isSpin !== "undefined") ? !isSpin : true;
        if (okModal && okSpin && pauseReasons.size === 0) {
          const prizeKey = pickWeightedPrizeKey();
          const CFG = __mt2_getConfig();
          pushWinnerEntry({
            id: makeEntryId("live"),
            isUser: false,
            fullId: "",
            displayId: uniqueMaskedId(),
            prizeKey,
            prize: (CFG.PRIZE_DISPLAY_MAP && CFG.PRIZE_DISPLAY_MAP[prizeKey]) ? CFG.PRIZE_DISPLAY_MAP[prizeKey] : prizeKey,
            ts: Date.now(),
            isNew: true
          });
        }
      } catch (_){}

      schedule();
    }, ms);

    __mt2_setLiveTimer(to);
  };

  schedule();
}

function stopLiveHistory() {
  const t = __mt2_getLiveTimer();
  if (t) clearTimeout(t);
  __mt2_setLiveTimer(0);
}

// =========================
// WINNERS RENDER (FLIP)
// =========================
function ensureWinnersHeader(table) {
  let header = table.querySelector(".winners-table-header");
  if (!header) {
    header = document.createElement("div");
    header.className = "winners-table-header";
    header.innerHTML = "<div>NO</div><div>USER ID</div><div>HADIAH</div>";
    table.appendChild(header);
  }
  return header;
}

function createRowEl(entry) {
  const row = document.createElement("div");
  row.className = "winners-table-row" + (entry.isNew ? " is-new" : "") + (entry.isUser ? " is-user" : "");
  row.setAttribute("data-id", entry.id);
  row.tabIndex = entry.isUser ? 0 : -1;
  row.setAttribute("role", "button");
  row.setAttribute("aria-disabled", entry.isUser ? "false" : "true");

  const c1 = document.createElement("div");
  c1.className = "winner-no";

  const c2 = document.createElement("div");
  c2.className = "winner-id";

  const meta = document.createElement("div");
  meta.className = "winner-meta";
  meta.setAttribute("data-ts", String(entry.ts || Date.now()));

  const c2wrap = document.createElement("div");
  c2wrap.appendChild(c2);
  c2wrap.appendChild(meta);

  const c3 = document.createElement("div");
  c3.className = "winner-prize";

  row.append(c1, c2wrap, c3);
  return row;
}

function patchRowContent(row, entry, index) {
  // ✅ FIX UTAMA: data-id harus selalu sync (kalau tidak, klik “ga ketemu” entry-nya)
  row.setAttribute("data-id", String(entry.id || ""));
  row.classList.toggle("is-new", !!entry.isNew);
  row.classList.toggle("is-user", !!entry.isUser);
  row.tabIndex = entry.isUser ? 0 : -1;
  row.setAttribute("aria-disabled", entry.isUser ? "false" : "true");
  row.setAttribute("aria-label", entry.isUser ? "Buka detail riwayat Anda" : "Tidak bisa dibuka");

  const no = row.querySelector(".winner-no");
  const id = row.querySelector(".winner-id");
  const meta = row.querySelector(".winner-meta");
  const prize = row.querySelector(".winner-prize");

  if (no) no.textContent = String(index + 1);
  if (id) id.textContent = String(entry.displayId || "");
  if (meta) {
    meta.setAttribute("data-ts", String(entry.ts || Date.now()));
    meta.textContent = timeLabel(entry.ts);
  }
  if (prize) prize.textContent = String(entry.prize || "");
}

function renderWinners(opts = {}) {
  const o = Object.assign({ preserveScroll: true }, opts);
  const table = document.getElementById("winnersTable");
  if (!table) return;

  let prevScrollTop = 0;
  try { prevScrollTop = table.scrollTop || 0; } catch (_) {}

  ensureWinnersHeader(table);

  const winners = __mt2_getWinners();
  const rowElById = __mt2_getRowElById();

  const winnersByIdLocal = new Map();
  for (const w of winners) winnersByIdLocal.set(w.id, w);
  __mt2_setWinnersById(winnersByIdLocal);

  const first = {};
  for (const [id, el] of rowElById.entries()) {
    if (!el || !el.isConnected) continue;
    first[id] = el.getBoundingClientRect().top;
  }

  for (let i = 0; i < winners.length; i++) {
    const w = winners[i];
    if (!w.id) w.id = makeEntryId("w");
    let row = rowElById.get(w.id);
    if (!row || !row.isConnected) {
      row = createRowEl(w);
      rowElById.set(w.id, row);
      table.appendChild(row);
    }
    patchRowContent(row, w, i);
  }

  for (const [id, el] of Array.from(rowElById.entries())) {
    if (!winnersByIdLocal.has(id)) {
      try { el.remove(); } catch (_) {}
      rowElById.delete(id);
    }
  }

  const header = table.querySelector(".winners-table-header");
  for (const w of winners) {
    const row = rowElById.get(w.id);
    if (row && row.isConnected) table.appendChild(row);
  }
  if (header && header.isConnected) table.insertBefore(header, table.firstChild);

  const last = {};
  for (const w of winners) {
    const el = rowElById.get(w.id);
    if (!el || !el.isConnected) continue;
    last[w.id] = el.getBoundingClientRect().top;
  }

  requestAnimationFrame(() => {
    for (const w of winners) {
      const el = rowElById.get(w.id);
      if (!el || !el.isConnected) continue;

      const a = first[w.id];
      const b = last[w.id];
      if (typeof a !== "number" || typeof b !== "number") continue;

      const dy = a - b;
      if (Math.abs(dy) < 0.5) continue;

      el.style.transform = `translateY(${dy}px)`;
      el.style.transition = "transform 0ms";
    }

    requestAnimationFrame(() => {
      for (const w of winners) {
        const el = rowElById.get(w.id);
        if (!el || !el.isConnected) continue;
        el.style.transition = "";
        el.style.transform = "";
      }
    });
  });

  if (o.preserveScroll) {
    try { table.scrollTop = prevScrollTop; } catch (_) {}
  }
}

// =========================
// Klik history: HANYA USER ASLI (FIX)
// =========================
function setupHistoryRowOpen() {
  const table = document.getElementById("winnersTable");
  if (!table) return;

  // ✅ guard anti double bind
  if (table.dataset.historyOpenBound === "1") return;
  table.dataset.historyOpenBound = "1";

  const getRowFromEvent = (e) => {
    const path = (e && typeof e.composedPath === "function") ? e.composedPath() : null;
    if (path && path.length) {
      for (const n of path) {
        if (n && n.classList && n.classList.contains("winners-table-row")) return n;
      }
    }
    const t = e && e.target;
    return (t && t.closest) ? t.closest(".winners-table-row") : null;
  };

  const tryOpen = (row) => {
    const map = __mt2_getWinnersById();
    const id = row.getAttribute("data-id");
    const entry = map && id ? map.get(id) : null;
    if (!entry) return;

    if (!entry.isUser) {
      const now = Date.now();
      const lastToast = __mt2_getNonUserToastAt();
      if (now - lastToast > 1800) {
        __mt2_setNonUserToastAt(now);
        if (typeof showToast === "function") showToast("Hanya riwayat Anda yang bisa dibuka.", "error", 1800);
      }
      return;
    }

    const showUser = String(entry.fullId || entry.displayId || "-");
    const prizeShow = String(entry.prize || entry.prizeKey || "-");
    const ts = Number(entry.ts || Date.now());

    try { if (typeof lastResult !== "undefined") lastResult = { userId: showUser, prizeKey: entry.prizeKey || "", prizeLabel: prizeShow, ts }; } catch(_){}
    if (typeof window !== "undefined") window.lastResult = { userId: showUser, prizeKey: entry.prizeKey || "", prizeLabel: prizeShow, ts };

    const pAmt = document.getElementById("prizeAmount");
    const mUid = document.getElementById("modalUserId");
    const mTime = document.getElementById("modalTime");

    if (pAmt) pAmt.textContent = prizeShow;
    if (mUid) mUid.textContent = showUser;
    if (mTime) {
      mTime.textContent = new Date(ts).toLocaleString("id-ID", {
        day: "2-digit", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });
    }

    if (typeof openModal === "function") openModal();
  };

  table.addEventListener("click", (e) => {
    const row = getRowFromEvent(e);
    if (!row) return;
    tryOpen(row);
  });

  table.addEventListener("keydown", (e) => {
    if (!e || (e.key !== "Enter" && e.key !== " ")) return;
    const row = getRowFromEvent(e);
    if (!row) return;
    e.preventDefault();
    tryOpen(row);
  });
}

// =========================
// AUTO INIT (biar klik langsung hidup)
// =========================
function initHistoryModule() {
  ensureHistoryStyles();

  const w = __mt2_getWinners();
  if (!Array.isArray(w) || w.length === 0) {
    __mt2_setWinners(generateMockWinnersRandom());
  }

  renderWinners({ preserveScroll: true });
  setupHistoryRowOpen();
  startMetaTicker();
  startLiveHistory();
}

(function(){
  if (typeof document === "undefined") return;
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initHistoryModule, { once: true });
  } else {
    initHistoryModule();
  }
})();

// =========================
// JACKPOT — hemat DOM + spike smooth + persist aman
// =========================
function initJackpot() {
  const saved = Number(lsGet(LS.JACKPOT_VAL, "0") || "0");
  if (saved && saved > 1000000) return saved;
  const seed = randInt(880_000_000, 930_000_000);
  lsSet(LS.JACKPOT_VAL, String(seed));
  return seed;
}

function fmtClock() {
  const d = new Date();
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
}

function startJackpot() {
  if (jackpotTimer) return;

  const el = document.getElementById("jackpot");
  const meta = document.getElementById("jackpotMeta");

  let speed = randInt(1400, 8200);

  let spikeStart = 0;
  let spikeEnd = 0;
  let spikePeak = 1;

  let last = performance.now();
  let lastPaint = 0;
  const paintEveryMs = 100; // 10 fps

  const step = () => {
    const now = performance.now();
    const dt = Math.min(0.24, (now - last) / 1000);
    last = now;

    if (!spikeEnd && Math.random() < 0.0012) {
      spikeStart = now;
      spikeEnd = now + (1800 + Math.random() * 2400);
      spikePeak = 1.8 + Math.random() * 2.6;
    }

    let mul = 1;
    if (spikeEnd) {
      const t = (now - spikeStart) / Math.max(1, (spikeEnd - spikeStart));
      if (t >= 1) {
        spikeStart = 0; spikeEnd = 0; spikePeak = 1;
        mul = 1;
      } else {
        const e = t < 0.5 ? (2 * t * t) : (1 - Math.pow(-2 * t + 2, 2) / 2);
        mul = 1 + (spikePeak - 1) * (1 - Math.abs(2 * e - 1));
      }
    }

    const noise = (Math.random() - 0.5) * 0.55;
    let v = speed * (1 + noise) * mul;

    if (Math.random() < 0.03) v *= 0.35;

    jackpot = Math.max(800_000_000, jackpot + v * dt);

    if (now - lastPaint >= paintEveryMs) {
      lastPaint = now;
      if (el) el.textContent = `IDR ${Math.round(jackpot).toLocaleString("id-ID")}`;
      if (meta) meta.textContent = `Update: ${fmtClock()}`;
    }

    jackpotTimer = requestAnimationFrame(step);
  };

  jackpotTimer = requestAnimationFrame(step);

  if (jackpotSaveTimer) clearInterval(jackpotSaveTimer);
  jackpotSaveTimer = setInterval(() => {
    lsSet(LS.JACKPOT_VAL, String(Math.round(jackpot)));
    if (Math.random() < 0.55) speed = randInt(1400, 9500);
  }, 3000);
}

function stopJackpot() {
  if (jackpotTimer) cancelAnimationFrame(jackpotTimer);
  jackpotTimer = 0;

  try { lsSet(LS.JACKPOT_VAL, String(Math.round(jackpot))); } catch (_) {}

  if (jackpotSaveTimer) clearInterval(jackpotSaveTimer);
  jackpotSaveTimer = 0;
}

// =========================
// MODAL (pause/resume history + focus trap + inert)
// =========================
function isModalOpen() {
  const m = document.getElementById("prizeModal");
  return !!(m && m.classList.contains("show"));
}

function openModal() {
  const modal = document.getElementById("prizeModal");
  if (!modal) return;

  lastFocusedEl = document.activeElement;

  pauseHistory("modal");
  setInert("modal", true);

  modal.classList.add("show");
  modal.setAttribute("aria-hidden", "false");
  document.body.classList.add("modal-open");

  const claimBtn = document.getElementById("claimBtn");
  if (claimBtn) setTimeout(() => claimBtn.focus({ preventScroll: true }), 0);
}

function closeModal() {
  const modal = document.getElementById("prizeModal");
  if (!modal) return;

  modal.classList.remove("show");
  modal.setAttribute("aria-hidden", "true");

  resumeHistory("modal");
  setInert("modal", false);

  if (!isNavOpen()) document.body.classList.remove("modal-open");

  if (lastFocusedEl && lastFocusedEl.isConnected && typeof lastFocusedEl.focus === "function") {
    lastFocusedEl.focus({ preventScroll: true });
  }
  lastFocusedEl = null;
}

function trapFocus(e){
  const modal = document.getElementById("prizeModal");
  const root = modal && modal.querySelector ? modal.querySelector(".modal-content") : null;
  if (!root) return;

  const focusables = root.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
  const list = Array.from(focusables).filter(el => el && !el.disabled && el.offsetParent !== null);
  if (list.length === 0) return;

  const first = list[0];
  const last = list[list.length - 1];

  const active = document.activeElement;
  if (e.shiftKey) {
    if (active === first || active === root) {
      e.preventDefault();
      last.focus({ preventScroll: true });
    }
  } else {
    if (active === last) {
      e.preventDefault();
      first.focus({ preventScroll: true });
    }
  }
}

// =========================
// UI
// =========================
function updateUI() {
  const spinBtn = document.getElementById("spinBtn");
  const userIdInput = document.getElementById("userIdInput");
  const spunMessage = document.getElementById("spunMessage");
  if (!spinBtn || !userIdInput || !spunMessage) return;

  if (hasSpun) {
    spinBtn.disabled = true;
    spinBtn.textContent = "SUDAH SPIN";
    userIdInput.disabled = true;
    spunMessage.style.display = "block";
  } else {
    spinBtn.disabled = false;
    spinBtn.textContent = "SPIN SEKARANG!";
    userIdInput.disabled = false;
    spunMessage.style.display = "none";
  }
}

// =========================
// tick per-segment (token-based cancel)
// =========================
function clearTickTimers(){
  for (const t of tickTimers) {
    try { clearTimeout(t); } catch(_){}
  }
  tickTimers = [];
}

function scheduleTicks(rotationDeltaDeg, segmentAngleDeg, durationMs, token) {
  if (isReducedMotion()) return;

  const ticks = Math.max(0, Math.floor(Math.abs(rotationDeltaDeg) / segmentAngleDeg));
  if (ticks <= 0) return;

  const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);
  const maxTicks = __isLowEnd ? 95 : 130; // ✅ low-end lebih hemat
  const count = Math.min(ticks, maxTicks);

  for (let i = 1; i <= count; i++) {
    const t = i / count;
    const when = Math.round(easeOutCubic(t) * durationMs);
    const jitter = randInt(-10, 12);

    const intensity = Math.max(0.45, 1 - t*0.55);

    const id = setTimeout(() => {
      if (token !== spinToken) return;
      playTick(intensity);
    }, Math.max(0, when + jitter));

    tickTimers.push(id);
  }
}

/* =========================================================
 * SPIN AUTO FOCUS + DARK OVERLAY SPOTLIGHT (SMOOTH v5)
 * FIX: no multi-smooth stack + perf mode while scrolling
 * FULL REPLACE
 * ======================================================= */
(function () {
  if (window.__MT2_SPIN_FOCUS_SAFE_V5__) return;
  window.__MT2_SPIN_FOCUS_SAFE_V5__ = true;

  let __spinFocusOn = false;
  let __spinFocusRaf = 0;
  let __spinOverlayEl = null;
  let __spinOverlayTick = 0;

  let __spinMoveHandler = null;
  let __spinVVHandler = null;

  let lastFocusedEl = null;

  // ===== TUNING =====
  const __HEADER_STICKY_TOP = 10;  // harus sama dengan CSS sticky top
  const __HEADER_GAP = 12;
  const __FALLBACK_TOP = 14;

  const __EPS = 10;
  const __AUTO_JUMP_THRESHOLD_PX = 650;

  // perf scrolling class timer
  let __scrollingFlagTmr = 0;

  function __reduced() {
    try { return (typeof window.isReducedMotion === "function" && window.isReducedMotion()); }
    catch (_) { return false; }
  }
  function __modalOpen() {
    try { return (typeof window.isModalOpen === "function" && window.isModalOpen()); }
    catch (_) { return false; }
  }

  function __getHeaderEl(){
    try { return document.querySelector("header"); } catch(_) { return null; }
  }

  function __computeWheelInset(){
    const header = __getHeaderEl();
    if (!header) return __FALLBACK_TOP;
    try{
      const h = Math.max(0, Math.ceil(header.getBoundingClientRect().height || 0));
      return __HEADER_STICKY_TOP + h + __HEADER_GAP;
    } catch(_){
      return __FALLBACK_TOP;
    }
  }

  function ensureSpinOverlay() {
    if (__spinOverlayEl && document.body.contains(__spinOverlayEl)) return __spinOverlayEl;
    const old = document.getElementById("spinFocusOverlay");
    if (old) { __spinOverlayEl = old; return old; }

    const el = document.createElement("div");
    el.id = "spinFocusOverlay";
    el.setAttribute("aria-hidden", "true");
    document.body.appendChild(el);
    __spinOverlayEl = el;
    return el;
  }

  function getWheelFocusTarget() {
    return (
      document.getElementById("wheelWrap") ||
      document.querySelector(".wheel-container") ||
      document.getElementById("wheel")
    );
  }

  function __isScrollable(el){
    if (!el) return false;
    try{
      const cs = getComputedStyle(el);
      const oy = cs.overflowY;
      const can = (oy === "auto" || oy === "scroll" || oy === "overlay");
      if (!can) return false;
      return (el.scrollHeight > el.clientHeight + 2);
    } catch(_){
      return false;
    }
  }

  function __getScrollContainers(el){
    const out = [];
    try{
      let p = el && el.parentElement;
      while (p && p !== document.body && p !== document.documentElement) {
        if (__isScrollable(p)) out.push(p);
        p = p.parentElement;
      }
    } catch(_){}
    // root scroller always included
    const se = document.scrollingElement || document.documentElement;
    if (se && !out.includes(se)) out.push(se);
    return out;
  }

  function __tempDisableSnap(container){
    if (!container) return null;
    try{
      const cs = getComputedStyle(container);
      const snap = cs.scrollSnapType;
      if (!snap || snap === "none") return null;

      const prev = container.style.scrollSnapType;
      container.style.scrollSnapType = "none";
      return () => { try { container.style.scrollSnapType = prev || ""; } catch(_){ } };
    } catch(_){
      return null;
    }
  }

  function __setScrollingFlag(){
    try{
      document.body.classList.add("spin-focus-scrolling");
      if (__scrollingFlagTmr) clearTimeout(__scrollingFlagTmr);
      __scrollingFlagTmr = setTimeout(() => {
        __scrollingFlagTmr = 0;
        document.body.classList.remove("spin-focus-scrolling");
      }, 520);
    } catch(_){}
  }

  // Build one “scroll plan” for page + parents (no stacked smooth)
  function __buildPlan(el, topInset){
    const plan = [];

    const se = document.scrollingElement || document.documentElement;
    // page action
    try{
      const r = el.getBoundingClientRect();
      const current = window.pageYOffset || se.scrollTop || 0;
      const absTop = r.top + current;
      const targetTop = Math.max(0, absTop - topInset);
      plan.push({ kind: "page", el: se, current, target: targetTop });
    } catch(_){}

    // parent containers
    const containers = __getScrollContainers(el);
    for (const c of containers) {
      if (!c || c === se) continue;
      try{
        const r = el.getBoundingClientRect();
        const cr = c.getBoundingClientRect();
        const currentTop = c.scrollTop;
        const elTopInC = (r.top - cr.top) + currentTop;
        const targetTop = Math.max(0, elTopInC - topInset);
        plan.push({ kind: "container", el: c, current: currentTop, target: targetTop });
      } catch(_){}
    }
    return plan;
  }

  function __maxDistance(plan){
    let m = 0;
    for (const a of plan) {
      const d = Math.abs((a.target || 0) - (a.current || 0));
      if (d > m) m = d;
    }
    return m;
  }

  function __needsMove(plan){
    for (const a of plan) {
      const d = Math.abs((a.target || 0) - (a.current || 0));
      if (d > __EPS) return true;
    }
    return false;
  }

  function __applyPlan(plan, behavior){
    const restores = [];
    for (const a of plan) {
      const node = a.el;
      const restoreSnap = __tempDisableSnap(node);
      if (restoreSnap) restores.push(restoreSnap);

      try{
        if (a.kind === "page") {
          try { window.scrollTo({ top: a.target, behavior }); }
          catch(_) { node.scrollTop = a.target; }
        } else {
          try { node.scrollTo({ top: a.target, behavior }); }
          catch(_) { node.scrollTop = a.target; }
        }
      } catch(_){}
    }
    if (restores.length) setTimeout(() => { for (const fn of restores) { try { fn(); } catch(_){} } }, 260);
  }

  // ✅ One-shot: far => auto-jump, then smooth refine once
  function __smartScroll(el, force){
    if (!el) return;

    const topInset = __computeWheelInset();
    const plan0 = __buildPlan(el, topInset);
    if (!force && !__needsMove(plan0)) return;

    __setScrollingFlag();

    const maxD = __maxDistance(plan0);
    const reduced = __reduced();

    if (reduced) {
      __applyPlan(plan0, "auto");
      return;
    }

    // 1) kalau jauh, auto-jump dulu (biar ga patah)
    if (maxD > __AUTO_JUMP_THRESHOLD_PX) {
      __applyPlan(plan0, "auto");

      // 2) refine smooth sekali setelah jump settle
      requestAnimationFrame(() => {
        if (!__spinFocusOn) return;
        const plan1 = __buildPlan(el, topInset);
        if (__needsMove(plan1)) __applyPlan(plan1, "smooth");
      });
    } else {
      // dekat: langsung smooth sekali
      __applyPlan(plan0, "smooth");
    }

    // 3) settle check cuma 1x (hindari jitter)
    setTimeout(() => {
      if (!__spinFocusOn) return;
      const plan2 = __buildPlan(el, topInset);
      if (__needsMove(plan2)) {
        // snap kecil kalau masih meleset, lalu smooth tipis
        __applyPlan(plan2, "auto");
        requestAnimationFrame(() => {
          if (!__spinFocusOn) return;
          const plan3 = __buildPlan(el, topInset);
          if (__needsMove(plan3)) __applyPlan(plan3, "smooth");
        });
      }
    }, 220);
  }

  function requestOverlayUpdate() {
    if (__spinOverlayTick) return;
    __spinOverlayTick = requestAnimationFrame(() => {
      __spinOverlayTick = 0;
      updateSpinOverlay();
    });
  }

  function updateSpinOverlay() {
    if (!__spinFocusOn) return;
    const ov = ensureSpinOverlay();
    const target = getWheelFocusTarget();
    if (!ov || !target) return;

    const r = target.getBoundingClientRect();
    const cx = r.left + r.width / 2;
    const cy = r.top + r.height / 2;

    const cy2 = cy - Math.min(54, r.height * 0.12);
    const rad = Math.max(r.width, r.height) / 2;

    const r1 = Math.round(rad * 0.92 + 70);
    const r2 = Math.round(rad * 1.18 + 130);

    ov.style.setProperty("--focus-x", cx + "px");
    ov.style.setProperty("--focus-y", cy2 + "px");
    ov.style.setProperty("--focus-r1", r1 + "px");
    ov.style.setProperty("--focus-r2", r2 + "px");
  }

  function __attachListeners() {
    if (__spinMoveHandler) return;

    __spinMoveHandler = () => { if (__spinFocusOn) requestOverlayUpdate(); };
    window.addEventListener("scroll", __spinMoveHandler, { passive: true });
    window.addEventListener("resize", __spinMoveHandler, { passive: true });

    if (window.visualViewport) {
      __spinVVHandler = () => { if (__spinFocusOn) requestOverlayUpdate(); };
      window.visualViewport.addEventListener("scroll", __spinVVHandler, { passive: true });
      window.visualViewport.addEventListener("resize", __spinVVHandler, { passive: true });
    }
  }

  function __detachListeners() {
    if (__spinMoveHandler) {
      window.removeEventListener("scroll", __spinMoveHandler);
      window.removeEventListener("resize", __spinMoveHandler);
      __spinMoveHandler = null;
    }
    if (__spinVVHandler && window.visualViewport) {
      window.visualViewport.removeEventListener("scroll", __spinVVHandler);
      window.visualViewport.removeEventListener("resize", __spinVVHandler);
      __spinVVHandler = null;
    }
  }

  // ===== EXPORT =====
  window.beginSpinFocus = function beginSpinFocus() {
    if (__spinFocusOn) {
      const wheel = getWheelFocusTarget();
      if (wheel) { __smartScroll(wheel, true); requestOverlayUpdate(); }
      return;
    }
    if (__modalOpen()) return;

    const wheel = getWheelFocusTarget();
    if (!wheel) return;

    __spinFocusOn = true;
    ensureSpinOverlay();

    try { lastFocusedEl = document.activeElement || null; } catch (_) { lastFocusedEl = null; }

    if (!wheel.hasAttribute("tabindex")) {
      wheel.setAttribute("tabindex", "-1");
      wheel.dataset.__spinTab = "1";
    }

    document.body.classList.add("spin-focus-on");
    __attachListeners();
    requestOverlayUpdate();

    if (__spinFocusRaf) cancelAnimationFrame(__spinFocusRaf);
    __spinFocusRaf = requestAnimationFrame(() => {
      // ✅ cukup align wheel (header sticky sudah tampil karena class spin-focus-on)
      __smartScroll(wheel, true);

      try { wheel.focus({ preventScroll: true }); }
      catch (_) { try { wheel.focus(); } catch (__) {} }

      requestOverlayUpdate();
    });
  };

  window.endSpinFocus = function endSpinFocus(restoreFocus = true) {
    if (!__spinFocusOn) return;
    __spinFocusOn = false;

    document.body.classList.remove("spin-focus-on");
    document.body.classList.remove("spin-focus-scrolling");

    if (__spinFocusRaf) { cancelAnimationFrame(__spinFocusRaf); __spinFocusRaf = 0; }
    if (__spinOverlayTick) { cancelAnimationFrame(__spinOverlayTick); __spinOverlayTick = 0; }
    if (__scrollingFlagTmr) { clearTimeout(__scrollingFlagTmr); __scrollingFlagTmr = 0; }

    __detachListeners();

    const wheel = getWheelFocusTarget();
    if (wheel && wheel.dataset.__spinTab === "1") {
      try { wheel.removeAttribute("tabindex"); } catch (_) {}
      try { delete wheel.dataset.__spinTab; } catch (_) {}
    }

    if (restoreFocus && lastFocusedEl && typeof lastFocusedEl.focus === "function") {
      try { lastFocusedEl.focus({ preventScroll: true }); }
      catch (_) { try { lastFocusedEl.focus(); } catch (__) {} }
    }
  };
})();

// =========================
// SPIN (LOCK RESULT 150K/200K) + AUTO FOCUS
// =========================
function startSpin() {
  kickAudio(true);

  const reduceMotion = isReducedMotion();

  const userIdInput = document.getElementById("userIdInput");
  const rawUserId = userIdInput ? userIdInput.value.trim() : "";
  const userId = normalizeUserIdInput(rawUserId);

  if (!userId) {
    showToast("Masukkan User ID terlebih dahulu!", "error");
    try { userIdInput && userIdInput.focus({ preventScroll: true }); } catch(_){}
    return;
  }
  if (hasSpun) { showToast("Anda sudah melakukan spin! Kesempatan hanya 1x.", "error"); return; }
  if (isSpin) return;

  isSpin = true;

  beginSpinFocus();
  pauseHistory("spin");

  spinToken++;
  clearTickTimers();

  if (pointerEl) pointerEl.classList.add("is-spin");

  const spinBtn = document.getElementById("spinBtn");
  if (spinBtn) {
    spinBtn.disabled = true;
    spinBtn.textContent = "SPINNING…";
  }

  const spinSound = document.getElementById("spinSound");
  try { if (spinSound) { spinSound.currentTime = 0; spinSound.play().catch(() => {}); } } catch (_) {}

  // ✅ LOCK RESULT hanya 150K / 200K
  const prizeKey = pickLockedPrizeKey();
  const prizeIndex = Math.max(0, PRIZES.indexOf(prizeKey));
  const prizeDisplay = CONFIG.PRIZE_DISPLAY_MAP[prizeKey] || prizeKey;

  const wheel = document.getElementById("wheel");
  const n = PRIZES.length;
  const segmentAngle = 360 / n;

  const segmentCenter = (prizeIndex * segmentAngle) + (segmentAngle / 2);
  const base = ((currentRotation % 360) + 360) % 360;
  const desiredMod = (360 - segmentCenter + 360) % 360;

  const fullSpins = 360 * (8 + Math.floor(Math.random() * 4));
  const jitter = (Math.random() - 0.5) * (segmentAngle * 0.55);
  const delta = (desiredMod - base + 360) % 360;

  const totalRotation = currentRotation + fullSpins + delta + jitter;
  const rotationDelta = totalRotation - currentRotation;
  const durationMs = reduceMotion ? 350 : CONFIG.SPIN_DURATION_MS;

  if (wheel) wheel.style.setProperty("--spin-dur", durationMs + "ms");

  pauseHistory("modal");

  let ended = false;
  const localToken = spinToken;

  const onEnd = () => {
    if (ended) return;
    ended = true;

    clearTickTimers();
    endSpinFocus(false);

    if (wheel) {
      wheel.classList.remove("spinning");
      applyWheelRotation(totalRotation);
    }
    saveRotation(totalRotation);

    try { if (spinSound) { spinSound.pause(); spinSound.currentTime = 0; } } catch (_) {}

    const winSound = document.getElementById("winSound");
    try { if (winSound) { winSound.currentTime = 0; winSound.play().catch(() => {}); } } catch (_) {}

    if (pointerEl) pointerEl.classList.remove("is-spin");

    hasSpun = true;
    spinAt = Date.now();
    savedUserId = userId;
    savedPrizeKey = prizeKey;

    lsSet(LS.HAS_SPUN, "true");
    lsSet(LS.SPIN_AT, String(spinAt));
    lsSet(LS.LAST_USER_ID, userId);
    lsSet(LS.LAST_PRIZE, prizeKey); // ✅ persist result

    lastResult = { userId, prizeKey, prizeLabel: prizeDisplay, ts: spinAt };

    const prizeAmount = document.getElementById("prizeAmount");
    const modalUserId = document.getElementById("modalUserId");
    const modalTime = document.getElementById("modalTime");

    if (prizeAmount) prizeAmount.textContent = prizeDisplay;
    if (modalUserId) modalUserId.textContent = userId;
    if (modalTime) {
      modalTime.textContent = new Date(spinAt).toLocaleString("id-ID", {
        day: "2-digit", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });
    }

    pushWinnerEntry({
      id: makeEntryId("user"),
      isUser: true,
      fullId: userId,
      displayId: userId,
      prizeKey,
      prize: prizeDisplay,
      ts: spinAt,
      isNew: true
    });

    updateUI();
    celebrateWin();

    resumeHistory("spin");
    openModal();

    isSpin = false;
  };

  if (reduceMotion) { onEnd(); return; }

  scheduleTicks(rotationDelta, segmentAngle, durationMs, localToken);

  if (wheel) {
    wheel.style.setProperty("--from-rotation", currentRotation + "deg");
    wheel.style.setProperty("--rotation", totalRotation + "deg");
    wheel.classList.add("spinning");
    wheel.addEventListener("animationend", onEnd, { once: true });
  }

  setTimeout(() => { if (localToken === spinToken) onEnd(); }, durationMs + 260);
}

/* =========================================================
 * REWARD PNG (download/share) — POWER UP v3.2 (FULL REPLACE)
 * ======================================================= */

/* -------------------------
 * SAFE TOAST / KICK
 * ------------------------- */
function __toast(msg, type, dur) {
  try {
    if (typeof showToast === "function") {
      // support showToast(msg,type) atau showToast(msg,type,dur)
      if (typeof dur === "number") showToast(String(msg || ""), type || "success", dur);
      else showToast(String(msg || ""), type || "success");
    }
  } catch (_) {}
}
function __kick() { try { if (typeof kickAudio === "function") kickAudio(true); } catch (_) {} }

/* -------------------------
 * SAFE: lastResult
 * ------------------------- */
function safeGetLastResult() {
  try {
    if (typeof lastResult !== "undefined" && lastResult) return lastResult;
  } catch (_) {}
  try {
    if (typeof window !== "undefined" && window.lastResult) return window.lastResult;
  } catch (_) {}
  return null;
}

/* -------------------------
 * DEVICE DETECT
 * ------------------------- */
function __isIOS() {
  try {
    const ua = String(navigator.userAgent || "");
    return /iPad|iPhone|iPod/i.test(ua);
  } catch (_) { return false; }
}
function __isMobileLike() {
  try { if (typeof matchMedia === "function" && matchMedia("(pointer: coarse)").matches) return true; } catch (_) {}
  try {
    const ua = String(navigator.userAgent || "");
    return /Android|iPhone|iPad|iPod/i.test(ua);
  } catch (_) {}
  return false;
}

/* -------------------------
 * URL (auto ikut deploy aktif)
 * priority:
 * 1) window.MT2_PLAY_URL (optional runtime override)
 * 2) localStorage mt2:play_url (optional override)
 * 3) canonical / og:url (kalau kamu set)
 * 4) location.href (deploy aktif)
 *
 * NOTE: query dibuang, HASH dipertahankan (aman untuk SPA hash-route).
 * ------------------------- */
function __getMetaUrl() {
  try {
    const canon = document.querySelector('link[rel="canonical"][href]');
    if (canon && canon.href) return canon.href;

    const og = document.querySelector('meta[property="og:url"][content]');
    if (og && og.content) return og.content;
  } catch (_) {}
  return "";
}

function getAutoPlayLink() {
  let u = "";

  // (1) runtime override
  try { if (window && window.MT2_PLAY_URL) u = String(window.MT2_PLAY_URL || ""); } catch (_) {}

  // (2) storage override
  if (!u) { try { u = String(localStorage.getItem("mt2:play_url") || ""); } catch (_) {} }

  // (3) meta
  if (!u) { u = __getMetaUrl(); }

  // (4) current deploy url
  if (!u) { try { u = String(window.location.href || ""); } catch (_) { u = ""; } }

  try {
    const url = new URL(String(u || "").trim(), window.location.href);
    url.search = ""; // buang query tracking
    // hash dibiarkan (kalau kamu pakai #/route)
    return url.toString();
  } catch (_) {}

  try { return String(window.location.origin + window.location.pathname); } catch (_) {}
  return "";
}

// yang dibakar di PNG (biar tidak terlalu panjang)
function __shortUrl(u) {
  try {
    const url = new URL(String(u || ""), window.location.href);
    const out = (url.origin + url.pathname).replace(/\/+$/, "");
    // kalau hash penting (SPA), tambah hash juga
    return url.hash ? (out + url.hash) : out;
  } catch (_) {
    return String(u || "").replace(/\/+$/, "");
  }
}

function getOriginPathKey() {
  try { return String(window.location.origin + window.location.pathname); } catch (_) { return ""; }
}

/* -------------------------
 * PAD2 (fallback)
 * ------------------------- */
function __pad2(n) {
  try { if (typeof pad2 === "function") return pad2(n); } catch (_) {}
  return String(n ?? "").padStart(2, "0");
}

/* -------------------------
 * MEASURE CTX (cache)
 * ------------------------- */
let __rewardMeasureCtx = null;
function getMeasureCtx() {
  try {
    if (__rewardMeasureCtx) return __rewardMeasureCtx;
    const c = document.createElement("canvas");
    c.width = 32; c.height = 32;
    __rewardMeasureCtx = c.getContext("2d");
    return __rewardMeasureCtx || null;
  } catch (_) {
    return null;
  }
}

/* -------------------------
 * TEXT LAYOUT
 * ------------------------- */
function layoutAdaptiveHeadline(ctx, text, maxWidth, opt) {
  const t = String(text || "").trim();
  const maxFont = opt.maxFont || 86;
  const minFont = opt.minFont || 56;
  const weight  = opt.weight  || 1000;
  const family  = opt.family  || "system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const maxLines = opt.maxLines || 2;
  const lineHScale = opt.lineHScale || 0.92;

  let fontSize = maxFont;
  let lines = [t];

  while (fontSize >= minFont) {
    ctx.font = `${weight} ${fontSize}px ${family}`;
    lines = wrapLinesByWords(ctx, t, maxWidth, maxLines);

    let widest = 0;
    for (let i = 0; i < lines.length; i++) widest = Math.max(widest, ctx.measureText(lines[i]).width);

    if (widest <= maxWidth + 0.5) break;
    fontSize -= 2;
  }

  const lineH = Math.ceil(fontSize * lineHScale);
  return { fontSize, lineH, lines };
}

function wrapLinesByWords(ctx, text, maxWidth, maxLines) {
  const words = String(text || "").split(/\s+/).filter(Boolean);
  const lines = [];
  let line = "";

  for (let i = 0; i < words.length; i++) {
    const w0 = words[i];

    if (!line && ctx.measureText(w0).width > maxWidth) {
      lines.push(fitTextWithEllipsis(ctx, w0, maxWidth));
      if (lines.length >= maxLines) break;
      continue;
    }

    const test = line ? (line + " " + w0) : w0;
    const w = ctx.measureText(test).width;

    if (w <= maxWidth) { line = test; continue; }

    if (line) lines.push(line);
    line = w0;

    if (lines.length === (maxLines - 1)) break;
  }

  if (line && lines.length < maxLines) lines.push(line);

  if (lines.length === maxLines) {
    const lastIdx = maxLines - 1;
    lines[lastIdx] = fitTextWithEllipsis(ctx, lines[lastIdx], maxWidth);
  }

  return lines;
}

function fitTextWithEllipsis(ctx, text, maxWidth) {
  const ell = "…";
  if (ctx.measureText(text).width <= maxWidth) return text;

  let t = String(text || "");
  while (t.length > 1 && ctx.measureText(t + ell).width > maxWidth) {
    t = t.slice(0, -1);
  }
  return t.trim() + ell;
}

/* -------------------------
 * DRAW HELPERS
 * ------------------------- */
function drawOrb(ctx, x, y, r, color) {
  const g = ctx.createRadialGradient(x, y, 0, x, y, r);
  g.addColorStop(0, color);
  g.addColorStop(1, "rgba(0,0,0,0)");
  ctx.fillStyle = g;
  ctx.beginPath();
  ctx.arc(x, y, r, 0, Math.PI * 2);
  ctx.fill();
}

function roundRect(ctx, x, y, w, h, r) {
  const rr = Math.min(r, w / 2, h / 2);
  ctx.beginPath();
  ctx.moveTo(x + rr, y);
  ctx.arcTo(x + w, y, x + w, y + h, rr);
  ctx.arcTo(x + w, y + h, x, y + h, rr);
  ctx.arcTo(x, y + h, x, y, rr);
  ctx.arcTo(x, y, x + w, y, rr);
  ctx.closePath();
}

/* -------------------------
 * LAYOUT (baseW adaptif + include link line)
 * ------------------------- */
function calcRewardPngLayout(r, ts, includePlayUrl) {
  const mobile = __isMobileLike();
  const baseW = mobile ? 960 : 1080;

  const pad = Math.round(baseW * 0.061); // ~66 saat 1080
  const cardX = pad;
  const cardY = 120;
  const cardW = baseW - pad * 2;

  const innerX = cardX + 44;
  const innerW = cardW - 88;

  const brandY = cardY + 90;
  const subY   = cardY + 140;

  const prizeStartY = cardY + 255;

  const fallbackPrize =
    (typeof CONFIG === "object" && CONFIG && CONFIG.BONUS_LABEL) ? String(CONFIG.BONUS_LABEL) :
    "BONUS 10%";

  const prizeText = String((r && (r.prizeLabel || r.prizeDisplay)) || fallbackPrize);

  const mctx = getMeasureCtx();
  if (!mctx) return null;

  const prize = layoutAdaptiveHeadline(mctx, prizeText, innerW, {
    maxFont: Math.min(86, Math.round(baseW * 0.08)),
    minFont: Math.max(54, Math.round(baseW * 0.053)),
    weight: 1000,
    family: "system-ui, -apple-system, Segoe UI, Roboto, Arial",
    lineHScale: 0.90,
    maxLines: 2
  });

  const prizeBlockH = Math.ceil((prize.lines.length - 1) * prize.lineH + prize.fontSize * 1.12);
  const prizeBottom = prizeStartY + prizeBlockH;
  const dividerY = Math.ceil(prizeBottom + 14);

  const userLabelY = dividerY + 70;
  const userValueY = userLabelY + 42;

  const timeLabelY = userValueY + 64;
  const timeValueY = timeLabelY + 40;

  const noteY = Math.ceil(timeValueY + 56);
  const noteX = innerX;
  const noteW = innerW;

  const noteText = "Silakan klaim melalui Live Chat dan sertakan USER ID + hasil unduh ini.";
  const noteFont = "800 22px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const noteLineH = 28;

  mctx.font = noteFont;
  const noteInnerPadX = 26;
  const noteInnerPadY = 22;
  const noteMaxW = noteW - noteInnerPadX * 2;

  const noteLines = wrapLinesByWords(mctx, noteText, noteMaxW, 3);
  const noteH = Math.max(68, noteInnerPadY * 2 + noteLines.length * noteLineH + 2);

  const noteTextX = noteX + noteInnerPadX;
  const noteTextY = noteY + noteInnerPadY + 22;

  const footerY = Math.ceil(noteY + noteH + 58);

  const playUrlRaw = getAutoPlayLink();
  const playShort = includePlayUrl ? __shortUrl(playUrlRaw) : "";

  const footerExtra = playShort ? 34 : 0;

  const cardH = Math.ceil((footerY + 40 + footerExtra) - cardY);
  const baseH = Math.ceil(cardY + cardH + 110);

  return {
    baseW, baseH,
    cardX, cardY, cardW, cardH,
    innerX, innerW,
    brandY, subY,
    prizeStartY, prize,
    dividerY,
    userLabelY, userValueY,
    timeLabelY, timeValueY,
    noteX, noteY, noteW, noteH,
    noteLines, noteLineH, noteTextX, noteTextY,
    footerY,
    playShort
  };
}

/* -------------------------
 * RENDER
 * ------------------------- */
function renderRewardCard(ctx, lay, r, ts, includePlayUrl) {
  ctx.textAlign = "left";
  ctx.textBaseline = "alphabetic";

  const g = ctx.createLinearGradient(0, 0, lay.baseW, lay.baseH);
  g.addColorStop(0, "#06130f");
  g.addColorStop(0.55, "#071e16");
  g.addColorStop(1, "#05281d");
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, lay.baseW, lay.baseH);

  // Orbs adaptif
  drawOrb(ctx, Math.min(260, lay.baseW * 0.24), 220, 260, "rgba(34,197,94,0.14)");
  drawOrb(ctx, lay.baseW - Math.min(220, lay.baseW * 0.20), 320, 220, "rgba(255,255,255,0.07)");
  drawOrb(ctx, lay.baseW - Math.min(260, lay.baseW * 0.24), lay.baseH - 260, 300, "rgba(20,184,166,0.10)");

  roundRect(ctx, lay.cardX, lay.cardY, lay.cardW, lay.cardH, 34);

  const cg = ctx.createLinearGradient(lay.cardX, lay.cardY, lay.cardX + lay.cardW, lay.cardY + lay.cardH);
  cg.addColorStop(0, "rgba(6,18,14,0.95)");
  cg.addColorStop(1, "rgba(7,30,22,0.95)");
  ctx.fillStyle = cg;
  ctx.fill();

  ctx.lineWidth = 4;
  ctx.strokeStyle = "rgba(34,197,94,0.55)";
  ctx.stroke();

  ctx.fillStyle = "rgba(255,255,255,0.95)";
  ctx.font = "900 44px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText("MADETOTO2", lay.innerX, lay.brandY);

  ctx.fillStyle = "rgba(255,255,255,0.78)";
  ctx.font = "700 24px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText("HASIL SPIN REWARD", lay.innerX, lay.subY);

  ctx.fillStyle = "#bbf7d0";
  ctx.font = `1000 ${lay.prize.fontSize}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
  ctx.save();
  ctx.shadowColor = "rgba(0,0,0,0.28)";
  ctx.shadowBlur = 18;
  ctx.shadowOffsetY = 10;
  for (let i = 0; i < lay.prize.lines.length; i++) {
    ctx.fillText(lay.prize.lines[i], lay.innerX, lay.prizeStartY + i * lay.prize.lineH);
  }
  ctx.restore();

  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(lay.innerX, lay.dividerY);
  ctx.lineTo(lay.innerX + lay.innerW, lay.dividerY);
  ctx.stroke();

  ctx.fillStyle = "rgba(255,255,255,0.70)";
  ctx.font = "800 22px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace";
  ctx.fillText("USER ID", lay.innerX, lay.userLabelY);
  ctx.fillText("WAKTU",   lay.innerX, lay.timeLabelY);

  ctx.fillStyle = "rgba(255,255,255,0.96)";
  ctx.font = "900 32px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace";
  ctx.fillText(String((r && r.userId) || "-"), lay.innerX, lay.userValueY);

  const timeStr = new Date(ts).toLocaleString("id-ID", {
    day: "2-digit", month: "short", year: "numeric",
    hour: "2-digit", minute: "2-digit", second: "2-digit"
  });
  ctx.fillText(timeStr, lay.innerX, lay.timeValueY);

  roundRect(ctx, lay.noteX, lay.noteY, lay.noteW, lay.noteH, 22);
  ctx.fillStyle = "rgba(0,0,0,0.30)";
  ctx.fill();
  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.lineWidth = 2;
  ctx.stroke();

  ctx.fillStyle = "rgba(255,255,255,0.88)";
  ctx.font = "800 22px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  for (let i = 0; i < lay.noteLines.length; i++) {
    ctx.fillText(lay.noteLines[i], lay.noteTextX, lay.noteTextY + i * lay.noteLineH);
  }

  ctx.fillStyle = "rgba(255,255,255,0.55)";
  ctx.font = "700 18px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText("Spin & Win • MADETOTO2", lay.innerX, lay.footerY);

  if (includePlayUrl && lay.playShort) {
    ctx.fillStyle = "rgba(255,255,255,0.50)";
    ctx.font = "700 18px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace";
    ctx.fillText(`Mainkan: ${lay.playShort}`, lay.innerX, lay.footerY + 26);
  }
}

/* -------------------------
 * FILE NAME
 * ------------------------- */
function buildFileName(userId, ts) {
  const d = new Date(ts || Date.now());
  const y = d.getFullYear();
  const m = __pad2(d.getMonth() + 1);
  const da = __pad2(d.getDate());
  const hh = __pad2(d.getHours());
  const mm = __pad2(d.getMinutes());

  const safeId = String(userId || "USER").replace(/[^A-Z0-9_-]/gi, "").slice(0, 18) || "USER";
  return `MADETOTO2-REWARD-${safeId}-${y}${m}${da}-${hh}${mm}.png`;
}

/* -------------------------
 * DOWNLOAD HELPERS
 * ------------------------- */
function triggerDownload(url, filename) {
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.rel = "noopener";
  a.target = "_blank";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

function dataUrlToBlob(dataUrl) {
  const s = String(dataUrl || "");
  const idx = s.indexOf(",");
  if (idx < 0) return new Blob([]);
  const meta = s.slice(0, idx);
  const b64 = s.slice(idx + 1);
  const m = /data:([^;]+);base64/i.exec(meta);
  const mime = (m && m[1]) ? m[1] : "application/octet-stream";
  const bin = atob(b64);
  const len = bin.length;
  const arr = new Uint8Array(len);
  for (let i = 0; i < len; i++) arr[i] = bin.charCodeAt(i);
  return new Blob([arr], { type: mime });
}

function downloadBlobAsPng(blob, fileName) {
  try {
    const url = URL.createObjectURL(blob);

    // iOS Safari: download attr sering tidak “download”, tapi buka tab (masih berguna untuk Save)
    if (__isIOS()) {
      try { window.open(url, "_blank", "noopener,noreferrer"); } catch (_) { triggerDownload(url, fileName); }
    } else {
      triggerDownload(url, fileName);
    }

    setTimeout(() => { try { URL.revokeObjectURL(url); } catch (_) {} }, 60000);
  } catch (_) {}
}

/* -------------------------
 * CACHE (1 varian: PNG + link dibakar)
 * ------------------------- */
const __rewardCache = {
  key: "",
  blob: null,
  fileName: "",
  inFlight: null,
  lastPrepAt: 0
};

const __shareState = { busy: false, lastTapAt: 0 };
const __downloadState = { busy: false, lastTapAt: 0 };

function nowMs(){ return (performance && performance.now) ? performance.now() : Date.now(); }

function __makeCacheKey(r, ts) {
  const uid = String((r && r.userId) || "");
  const prize = String((r && (r.prizeLabel || r.prizeDisplay)) || "");
  const t = String(ts || "");
  const env = getOriginPathKey();
  return `${uid}|${prize}|${t}|${env}`;
}

function __cloneResult(r) {
  try { return structuredClone(r); } catch (_) {}
  try { return JSON.parse(JSON.stringify(r)); } catch (_) {}
  return r;
}

function warmRewardShareCache(eager) {
  const r0 = safeGetLastResult();
  if (!r0) return;

  const r = __cloneResult(r0);
  const ts = r.ts || Date.now();
  const key = __makeCacheKey(r, ts);

  const now = Date.now();
  if (__rewardCache.key === key && __rewardCache.blob) return;
  if (__rewardCache.inFlight) return;
  if (now - (__rewardCache.lastPrepAt || 0) < 300) return;

  __rewardCache.lastPrepAt = now;

  const run = () => { __prepareRewardBlob(r, ts).catch(()=>{}); };

  try {
    if (eager) { run(); return; }
    if ("requestIdleCallback" in window) requestIdleCallback(run, { timeout: 900 });
    else setTimeout(run, 60);
  } catch (_) {
    setTimeout(run, 60);
  }
}

async function __prepareRewardBlob(r, ts) {
  const key = __makeCacheKey(r, ts);
  if (__rewardCache.key === key && __rewardCache.blob) {
    return { blob: __rewardCache.blob, fileName: __rewardCache.fileName };
  }
  if (__rewardCache.inFlight) return __rewardCache.inFlight;

  __rewardCache.key = key;
  __rewardCache.blob = null;
  __rewardCache.fileName = "";

  __rewardCache.inFlight = (async () => {
    const out = await makeRewardPngBlob(r, ts, true); // includePlayUrl = true
    __rewardCache.blob = out.blob;
    __rewardCache.fileName = out.fileName;
    return out;
  })();

  try {
    return await __rewardCache.inFlight;
  } finally {
    __rewardCache.inFlight = null;
  }
}

/* -------------------------
 * DPR control (lebih aman memory)
 * ------------------------- */
function getSafeDprForPng() {
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const hardMax = __isIOS() ? 1.6 : (__isMobileLike() ? 1.9 : 2);
  return Math.min(hardMax, dpr);
}

/* -------------------------
 * PNG BLOB (ASYNC)
 * ------------------------- */
function makeRewardPngBlob(r, ts, includePlayUrl) {
  return new Promise((resolve, reject) => {
    try {
      const dpr = getSafeDprForPng();
      const lay = calcRewardPngLayout(r, ts, includePlayUrl);
      if (!lay) return reject(new Error("layout null"));

      const W = Math.floor(lay.baseW * dpr);
      const H = Math.floor(lay.baseH * dpr);

      if (typeof OffscreenCanvas !== "undefined") {
        try {
          const oc = new OffscreenCanvas(W, H);
          const ctx = oc.getContext("2d", { alpha: true });
          if (ctx) {
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            ctx.imageSmoothingEnabled = true;
            try { ctx.imageSmoothingQuality = "high"; } catch (_) {}

            renderRewardCard(ctx, lay, r, ts, includePlayUrl);

            const fileName = buildFileName(r && r.userId, ts);
            if (oc.convertToBlob) {
              oc.convertToBlob({ type: "image/png" }).then((blob) => {
                if (!blob) return reject(new Error("blob null"));
                resolve({ blob, fileName });
              }).catch(() => {
                __makeBlobByCanvas(lay, r, ts, dpr, includePlayUrl, resolve, reject);
              });
              return;
            }
          }
        } catch (_) {}
      }

      __makeBlobByCanvas(lay, r, ts, dpr, includePlayUrl, resolve, reject);
    } catch (e) {
      reject(e);
    }
  });
}

function __makeBlobByCanvas(lay, r, ts, dpr, includePlayUrl, resolve, reject) {
  try {
    const canvas = document.createElement("canvas");
    canvas.width  = Math.floor(lay.baseW * dpr);
    canvas.height = Math.floor(lay.baseH * dpr);

    const ctx = canvas.getContext("2d");
    if (!ctx) return reject(new Error("ctx null"));

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.imageSmoothingEnabled = true;
    try { ctx.imageSmoothingQuality = "high"; } catch (_) {}

    renderRewardCard(ctx, lay, r, ts, includePlayUrl);

    const fileName = buildFileName(r && r.userId, ts);

    if (canvas.toBlob) {
      canvas.toBlob((blob) => {
        try { canvas.width = 0; canvas.height = 0; } catch (_) {}
        if (!blob) return reject(new Error("blob null"));
        resolve({ blob, fileName });
      }, "image/png");
    } else {
      const dataUrl = canvas.toDataURL("image/png");
      const blob = dataUrlToBlob(dataUrl);
      try { canvas.width = 0; canvas.height = 0; } catch (_) {}
      resolve({ blob, fileName });
    }
  } catch (e) {
    reject(e);
  }
}

/* -------------------------
 * PNG BLOB (SYNC) — penyelamat user-activation (share sheet)
 * ------------------------- */
function makeRewardPngBlobSync(r, ts, includePlayUrl) {
  const dpr = getSafeDprForPng();
  const lay = calcRewardPngLayout(r, ts, includePlayUrl);
  if (!lay) throw new Error("layout null");

  const canvas = document.createElement("canvas");
  canvas.width  = Math.floor(lay.baseW * dpr);
  canvas.height = Math.floor(lay.baseH * dpr);

  const ctx = canvas.getContext("2d");
  if (!ctx) throw new Error("ctx null");

  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.imageSmoothingEnabled = true;
  try { ctx.imageSmoothingQuality = "high"; } catch (_) {}

  renderRewardCard(ctx, lay, r, ts, includePlayUrl);

  const fileName = buildFileName(r && r.userId, ts);
  const dataUrl = canvas.toDataURL("image/png"); // SYNC
  const blob = dataUrlToBlob(dataUrl);

  try { canvas.width = 0; canvas.height = 0; } catch (_) {}
  return { blob, fileName };
}

/* -------------------------
 * SHARE TEXT (link di awal, anti truncate)
 * ------------------------- */
function buildShareText(r, ts, link) {
  const prize =
    String(
      (r && (r.prizeLabel || r.prizeDisplay)) ||
      (typeof CONFIG === "object" && CONFIG && CONFIG.BONUS_LABEL ? CONFIG.BONUS_LABEL : "BONUS 10%")
    );

  const uid = String((r && r.userId) || "-");
  const timeStr = new Date(ts || Date.now()).toLocaleString("id-ID", {
    day: "2-digit", month: "short", year: "numeric",
    hour: "2-digit", minute: "2-digit", second: "2-digit"
  });

  const L = String(link || "").trim();

  // baris awal: ajakan + link (paling aman)
  const head = [
    "Yuk coba Spin & Win MADETOTO2 👇",
    L
  ].filter(Boolean).join("\n");

  const body = [
    "🎉 HASIL SPIN MADETOTO2",
    `Hadiah : ${prize}`,
    `User ID : ${uid}`,
    `Waktu : ${timeStr}`
  ].join("\n");

  return head + "\n\n" + body;
}

/* -------------------------
 * CLIPBOARD
 * ------------------------- */
async function copyTextToClipboard(text) {
  const t = String(text || "");
  if (!t) return;

  if (navigator.clipboard && navigator.clipboard.writeText) {
    await navigator.clipboard.writeText(t);
    return;
  }

  const ta = document.createElement("textarea");
  ta.value = t;
  ta.setAttribute("readonly", "");
  ta.style.position = "fixed";
  ta.style.left = "-9999px";
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try { ta.setSelectionRange(0, ta.value.length); } catch (_) {}
  try { document.execCommand("copy"); } catch (_) {}
  ta.remove();
}

/* -------------------------
 * OPTIONAL: WhatsApp text deeplink fallback
 * ------------------------- */
function openWhatsAppText(text) {
  try {
    const t = encodeURIComponent(String(text || ""));
    const url = `https://wa.me/?text=${t}`;
    window.open(url, "_blank", "noopener,noreferrer");
  } catch (_) {}
}

/* =========================
 * SHARE (TEXT ONLY) — paling kompatibel semua sosmed
 * - Tidak share PNG sama sekali
 * - Link deploy aktif otomatis ikut (location)
 * - Fallback: copy clipboard + WA deeplink
 * ======================= */
async function shareResultPng() {
  const r0 = safeGetLastResult();
  if (!r0) { __toast("Hasil belum tersedia. Silakan spin terlebih dahulu.", "error"); return; }

  const tapNow = nowMs();
  if (__shareState.busy) return;
  if (tapNow - __shareState.lastTapAt < 450) return;
  __shareState.lastTapAt = tapNow;
  __shareState.busy = true;

  __kick();

  try {
    const r = __cloneResult(r0);
    const ts = r.ts || Date.now();

    // auto ikut domain deploy aktif
    const link = getAutoPlayLink();

    // caption + link (link di awal, anti truncate)
    const shareText = buildShareText(r, ts, link);

    // 1) Web Share API (TEXT ONLY)
    if (typeof navigator !== "undefined" && typeof navigator.share === "function") {
      try {
        await navigator.share({
          title: "MADETOTO2 — Hasil Spin",
          text: shareText
        });
        __toast("Menu share terbuka (teks + link).", "success");
        return;
      } catch (err) {
        if (err && (err.name === "AbortError" || String(err.message || "").includes("AbortError"))) {
          __toast("Bagikan dibatalkan", "error");
          return;
        }
        // lanjut fallback
      }
    }

    // 2) Clipboard fallback (paling kompatibel)
    try {
      await copyTextToClipboard(shareText);
      __toast("Teks + link disalin. Tinggal paste ke sosmed.", "success");
      return;
    } catch (_) {}

    // 3) WA deeplink fallback
    try {
      openWhatsAppText(shareText);
      __toast("Buka WhatsApp untuk bagikan.", "success");
      return;
    } catch (_) {}

    __toast("Browser tidak mendukung fitur bagikan.", "error");
  } finally {
    __shareState.busy = false;
  }
}

/* -------------------------
 * DOWNLOAD (fast) — cache / sync fallback
 * ------------------------- */
async function downloadResultPng() {
  const r0 = safeGetLastResult();
  if (!r0) { __toast("Hasil belum tersedia. Silakan spin terlebih dahulu.", "error"); return; }

  const tapNow = nowMs();
  if (__downloadState.busy) return;
  if (tapNow - __downloadState.lastTapAt < 450) return;
  __downloadState.lastTapAt = tapNow;
  __downloadState.busy = true;

  __kick();

  try {
    const r = __cloneResult(r0);
    const ts = r.ts || Date.now();

    let asset = null;
    const key = __makeCacheKey(r, ts);

    if (__rewardCache.key === key && __rewardCache.blob) {
      asset = { blob: __rewardCache.blob, fileName: __rewardCache.fileName };
    } else {
      __toast("Menyiapkan file…", "info", 900);
      asset = makeRewardPngBlobSync(r, ts, true);
      __rewardCache.key = key;
      __rewardCache.blob = asset.blob;
      __rewardCache.fileName = asset.fileName;
      try { warmRewardShareCache(false); } catch (_) {}
    }

    downloadBlobAsPng(asset.blob, asset.fileName);
    __toast("File hasil berhasil dibuat", "success");
  } catch (_) {
    __toast("Gagal membuat file. Coba ulang.", "error");
  } finally {
    __downloadState.busy = false;
  }
}

/* -------------------------
 * BIND TOMBOL (anti double-fire)
 * ------------------------- */
(function bindShareDownloadButtons(){
  const shareBtn = document.getElementById("shareBtn");
  if (shareBtn && !shareBtn.__mt2BoundShare) {
    shareBtn.__mt2BoundShare = true;

    const fire = (e) => {
      try { e && e.preventDefault && e.preventDefault(); } catch (_) {}
      try { e && e.stopPropagation && e.stopPropagation(); } catch (_) {}
      shareResultPng();
    };

    const prewarm = () => { try { warmRewardShareCache(true); } catch (_) {} };

    if ("PointerEvent" in window) {
      shareBtn.addEventListener("pointerdown", prewarm, { passive: true });
      shareBtn.addEventListener("pointerup", fire, { passive: false });
    } else {
      shareBtn.addEventListener("touchstart", prewarm, { passive: true });
      shareBtn.addEventListener("click", fire, { passive: false });
    }
  }

  const downloadBtn = document.getElementById("downloadBtn");
  if (downloadBtn && !downloadBtn.__mt2BoundDownload) {
    downloadBtn.__mt2BoundDownload = true;

    const fire = (e) => {
      try { e && e.preventDefault && e.preventDefault(); } catch (_) {}
      try { e && e.stopPropagation && e.stopPropagation(); } catch (_) {}
      downloadResultPng();
    };

    const prewarm = () => { try { warmRewardShareCache(true); } catch (_) {} };

    if ("PointerEvent" in window) {
      downloadBtn.addEventListener("pointerdown", prewarm, { passive: true });
      downloadBtn.addEventListener("pointerup", fire, { passive: false });
    } else {
      downloadBtn.addEventListener("touchstart", prewarm, { passive: true });
      downloadBtn.addEventListener("click", fire, { passive: false });
    }
  }
})();

// =========================
// CLAIM (loading overlay) + watchdog
// =========================
let claimInFlight = false;
let claimWatchdogT = 0;

function isNavOpen(){
  const el = document.getElementById("navLoading");
  return !!(el && el.classList.contains("show"));
}

function showNavLoading() {
  const el = document.getElementById("navLoading");
  if (!el) return;
  pauseHistory("nav");
  setInert("nav", true);
  el.classList.add("show");
  el.setAttribute("aria-hidden", "false");
  document.body.classList.add("modal-open");
}

function hideNavLoading(immediate = false) {
  const el = document.getElementById("navLoading");
  if (!el) return;

  const done = () => {
    el.classList.remove("show");
    el.setAttribute("aria-hidden", "true");
    claimInFlight = false;
    resumeHistory("nav");
    setInert("nav", false);
    if (!isModalOpen()) document.body.classList.remove("modal-open");
  };

  if (claimWatchdogT) { clearTimeout(claimWatchdogT); claimWatchdogT = 0; }

  if (immediate || isReducedMotion()) { done(); return; }
  el.classList.remove("show");
  el.setAttribute("aria-hidden", "true");
  setTimeout(done, 260);
}

function claimPrize() {
  if (claimInFlight) return;
  claimInFlight = true;

  closeModal();
  showNavLoading();

  const start = performance.now ? performance.now() : Date.now();
  const minHold = isReducedMotion() ? 0 : CONFIG.CLAIM_OVERLAY_MIN_MS;

  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      const now = performance.now ? performance.now() : Date.now();
      const elapsed = now - start;
      const wait = Math.max(0, minHold - elapsed);

      setTimeout(() => {
        claimWatchdogT = setTimeout(() => {
          if (isNavOpen() && !document.hidden) {
            hideNavLoading(true);
            showToast("Gagal membuka halaman klaim. Coba tekan KLAIM lagi.", "error", 2600);
          }
        }, 10000);

        try { window.location.href = CONFIG.CLAIM_URL; } catch(_) {
          hideNavLoading(true);
          showToast("Tidak bisa membuka halaman klaim.", "error", 2400);
        }
      }, wait);
    });
  });
}

  /* =========================================================
   * CELEBRATE (CONFETTI FRONT-LAYER) — FULL REPLACE
   * ✅ Confetti selalu di paling depan (anti ketutup modal/reward)
   * ✅ Canvas singleton (anti dobel / anti leak)
   * ✅ pointer-events: none (tidak ganggu klik)
   * ======================================================= */

  const CONFETTI_Z = 2147483647; // z-index super tinggi (max 32-bit)
  let __mt2Confetti = null;

  function ensureFrontConfetti() {
    // Pastikan library confetti ada
    if (typeof confetti !== "function") return null;

    // Reuse instance jika sudah ada
    if (__mt2Confetti && typeof __mt2Confetti === "function") return __mt2Confetti;

    try {
      // Buat canvas khusus confetti di BODY (lapisan paling atas)
      let canvas = document.getElementById("mt2ConfettiCanvas");
      if (!canvas) {
        canvas = document.createElement("canvas");
        canvas.id = "mt2ConfettiCanvas";
        canvas.setAttribute("aria-hidden", "true");
        Object.assign(canvas.style, {
          position: "fixed",
          inset: "0",
          width: "100%",
          height: "100%",
          zIndex: String(CONFETTI_Z),
          pointerEvents: "none",
          userSelect: "none",
          touchAction: "none",
          display: "block",
          // bantu jaga di atas layer yang "aneh" karena stacking context
          transform: "translateZ(0)",
        });
        document.body.appendChild(canvas);
      } else {
        // kalau sudah ada, paksa tetap top
        canvas.style.zIndex = String(CONFETTI_Z);
        canvas.style.pointerEvents = "none";
        canvas.style.position = "fixed";
        canvas.style.inset = "0";
      }

      // Create instance confetti yang nembak ke canvas kita (auto resize)
      __mt2Confetti = confetti.create(canvas, { resize: true, useWorker: true });
      return __mt2Confetti;
    } catch (_) {
      // fallback: pakai global confetti dengan zIndex option
      __mt2Confetti = (opts) => {
        try { confetti({ zIndex: CONFETTI_Z, ...opts }); } catch (_) {}
      };
      return __mt2Confetti;
    }
  }

  function celebrateWin() {
    if (isReducedMotion()) return;

    const shoot = ensureFrontConfetti();
    if (!shoot) return;

    const duration = 2200;
    const end = Date.now() + duration;

    const frame = () => {
      try {
        // Pastikan z-index tetap di atas setiap frame (kalau modal re-render)
        const c = document.getElementById("mt2ConfettiCanvas");
        if (c) c.style.zIndex = String(CONFETTI_Z);

        shoot({
          particleCount: 6,
          angle: 60,
          spread: 58,
          startVelocity: 32,
          gravity: 1.05,
          ticks: 210,
          scalar: 1,
          origin: { x: 0, y: 0.25 },
          zIndex: CONFETTI_Z,
        });

        shoot({
          particleCount: 6,
          angle: 120,
          spread: 58,
          startVelocity: 32,
          gravity: 1.05,
          ticks: 210,
          scalar: 1,
          origin: { x: 1, y: 0.25 },
          zIndex: CONFETTI_Z,
        });
      } catch (_) {}

      if (Date.now() < end) requestAnimationFrame(frame);
    };

    frame();
  }

// =========================
// Persist user entry + rotation consistency
// =========================
function bootPersistedUserEntry() {
  if (hasSpun && !spinAt) {
    spinAt = Date.now();
    lsSet(LS.SPIN_AT, String(spinAt));
  }

  // ✅ use persisted prizeKey if exists; fallback 150K
  const fallbackKey = "150K";
  const key = (savedPrizeKey && PRIZES.includes(savedPrizeKey)) ? savedPrizeKey : fallbackKey;
  const prizeDisplay = CONFIG.PRIZE_DISPLAY_MAP[key] || key;

  if (hasSpun && savedUserId) {
    lastResult = { userId: savedUserId, prizeKey: key, prizeLabel: prizeDisplay, ts: spinAt || Date.now() };

    const already = winners.some(w => w.isUser === true);
    if (!already) {
      pushWinnerEntry({
        id: makeEntryId("user"),
        isUser: true,
        fullId: savedUserId,
        displayId: savedUserId,
        prizeKey: key,
        prize: prizeDisplay,
        ts: spinAt || Date.now(),
        isNew: false
      });
    }
  }

  if (!isModalOpen()) {
    pauseReasons.delete("modal");
  }
}
</script>
</body>
</html>