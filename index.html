<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#060716" />
  <meta name="color-scheme" content="dark" />
  <title>Neon Slot - ARCADE</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;800&family=Inter:wght@500;600;700&display=swap" rel="stylesheet" />
  
  <style>
  :root{
    /* Night Neon base (lebih balance & anti banding lintas device) */
    --bg0:#05051a;
    --bg1:#070a22;
    --bg2:#0b1240;

    --text:#eaf0ff;
    --muted:#a9b3d6;

    --neon1:#7c4dff;
    --neon2:#26d7ff;
    --neon3:#ff2bd6;
    --gold:#ffd88a;

    --radius:22px;
    --radius2:28px;

    --ease:cubic-bezier(.2,.9,.18,1);
    --ease2:cubic-bezier(.22,.85,.2,1);

    --maxW:980px;
    --cell:clamp(74px, 10.2vw, 96px);
    --gap:clamp(14px, 3.4vw, 22px);

    --flashDur:4s;

    /* 3D cylinder feel */
    --reelPersp: clamp(720px, 88vw, 980px);
    --reelCurve: 560px;
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  html{
    -webkit-text-size-adjust:100%;
    text-size-adjust:100%;
    scrollbar-gutter: stable both-edges;
  }
  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);

    background:
      radial-gradient(1200px 760px at 16% 10%, rgba(124,77,255,.20), transparent 60%),
      radial-gradient(1120px 720px at 88% 14%, rgba(38,215,255,.16), transparent 62%),
      radial-gradient(980px 740px at 50% 112%, rgba(255,43,214,.11), transparent 66%),
      radial-gradient(820px 320px at 50% -10%, rgba(255,255,255,.035), transparent 58%),
      linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 52%, var(--bg2) 100%);
    background-color:var(--bg0);
    background-repeat:no-repeat;

    overflow-x:hidden;
    overflow-y:auto;
    overscroll-behavior-y:none;

    -webkit-tap-highlight-color:transparent;
    position:relative;
    isolation:isolate;

    min-height:100svh;
  }
  @supports (height: 100dvh){
    body{ min-height:100dvh; }
  }

  /* ‚úÖ overlay glow halus (aman perf) */
  body::before{
    content:"";
    position:fixed;
    inset:0;
    pointer-events:none;
    z-index:-1;
    background:
      radial-gradient(78vmax 52vmax at 14% 10%, rgba(124,77,255,.26), transparent 62%),
      radial-gradient(72vmax 50vmax at 92% 14%, rgba(38,215,255,.20), transparent 66%),
      radial-gradient(92vmax 62vmax at 50% 112%, rgba(255,43,214,.12), transparent 64%),
      linear-gradient(180deg, rgba(255,255,255,.018), transparent 30%, transparent 70%, rgba(0,0,0,.12));
    filter:saturate(1.10) contrast(1.04);
    transform:translateZ(0);
  }

  /* ‚úÖ micro-detail super halus (lebih ringan; low-tier makin tipis) */
  body::after{
    content:"";
    position:fixed;
    inset:-2px;
    pointer-events:none;
    z-index:-1;
    background:
      repeating-linear-gradient(0deg, rgba(255,255,255,.018) 0 1px, transparent 1px 11px),
      repeating-linear-gradient(90deg, rgba(255,255,255,.010) 0 1px, transparent 1px 16px),
      radial-gradient(70vmax 40vmax at 50% 10%, rgba(124,77,255,.050), transparent 62%),
      radial-gradient(70vmax 40vmax at 50% 18%, rgba(38,215,255,.036), transparent 66%);
    opacity:.085;
    transform:translateZ(0);
  }
  html[data-perf="low"] body::after{ opacity:.055; }
  html[data-perf="low"] body::before{ filter:saturate(1.07) contrast(1.02); }

  /* ‚úÖ saat spinning: kurangi micro-grid supaya tidak muncul overlay ‚Äúaneh‚Äù */
  html.spinning body::after{ opacity:.058; }
  html[data-perf="low"].spinning body::after{ opacity:.045; }

  .wrap{
    min-height:100svh;
    display:grid;
    place-items:center;
    padding:clamp(14px, 3.5vw, 26px);
    padding-bottom:calc(clamp(14px, 3.5vw, 26px) + env(safe-area-inset-bottom));
  }
  @supports (height: 100dvh){
    .wrap{ min-height:100dvh; }
  }
  @media (max-height: 720px){
    .wrap{ place-items:start center; }
  }

  .app{
    width:min(var(--maxW), 100%);
    border-radius:var(--radius2);
    background:linear-gradient(180deg, rgba(12,14,36,.78), rgba(7,8,20,.66));
    border:1px solid rgba(255,255,255,.10);
    box-shadow:
      0 22px 70px rgba(0,0,0,.52),
      0 0 0 1px rgba(38,215,255,.06),
      inset 0 1px 0 rgba(255,255,255,.10);
    overflow:hidden;
    position:relative;
    isolation:isolate;
    transform:translateZ(0);
  }
  html[data-perf="low"] .app{
    box-shadow:
      0 18px 54px rgba(0,0,0,.50),
      inset 0 1px 0 rgba(255,255,255,.10);
  }
  .app::before{
    content:"";
    position:absolute; inset:-2px;
    background:
      radial-gradient(92vmax 34vmax at 50% 0%, rgba(124,77,255,.20), transparent 58%),
      radial-gradient(70vmax 30vmax at 10% 34%, rgba(38,215,255,.12), transparent 58%),
      radial-gradient(70vmax 30vmax at 90% 34%, rgba(255,43,214,.11), transparent 58%),
      linear-gradient(90deg, rgba(255,255,255,.04), transparent 40%, transparent 60%, rgba(255,255,255,.03));
    pointer-events:none;
    z-index:0;
  }

  /* ‚úÖ HEADER: center */
  .top{
    position:relative; z-index:1;
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    align-items:center;
    gap:14px;
    padding:calc(clamp(16px, 3.6vw, 22px) + env(safe-area-inset-top)) clamp(16px, 3.6vw, 22px) clamp(16px, 3.6vw, 22px);
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .topSlot{ min-height:1px; }

  .brand{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:3px;
    min-width:0;
    text-align:center;
  }

  .title{
    font-family:Orbitron, Inter, system-ui;
    letter-spacing:1.0px;
    font-weight:900;
    font-size:clamp(16px, 3.4vw, 22px);
    line-height:1.12;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    text-transform:uppercase;
    text-shadow: 0 0 18px rgba(38,215,255,.12), 0 0 22px rgba(124,77,255,.12);
  }
  .subTitle{
    font-size:12.5px;
    color:rgba(234,240,255,.70);
    font-weight:800;
    letter-spacing:.18px;
    line-height:1.25;
    text-transform:none;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:min(64ch, 74vw);
  }

  .txtBtn{
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    padding:12px 14px;
    color:rgba(234,240,255,.95);
    font-weight:900;
    letter-spacing:.7px;
    cursor:pointer;
    transition:transform .14s var(--ease), border-color .18s var(--ease), filter .18s var(--ease);
    touch-action:manipulation;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.10);
    text-transform:uppercase;
    font-family:Orbitron, Inter, system-ui;
    font-size:12px;
    white-space:nowrap;
    transform:translateZ(0);
  }
  .txtBtn:active{ transform:translateY(1px) scale(.99); }
  .txtBtn:hover{ border-color:rgba(255,255,255,.22); }

  :focus-visible{
    outline:2px solid rgba(38,215,255,.55);
    outline-offset:2px;
    border-radius:14px;
  }

  .main{
    position:relative; z-index:1;
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap:var(--gap);
    padding:clamp(16px, 3.6vw, 22px);
  }
  @media (max-width: 860px){
    .main{ grid-template-columns:1fr; }
  }

  .slotCard{
    border-radius:var(--radius);
    background:linear-gradient(180deg, rgba(12,14,30,.74), rgba(8,9,22,.66));
    border:1px solid rgba(255,255,255,.10);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.08),
      0 18px 55px rgba(0,0,0,.28);
    overflow:hidden;
    position:relative;
    isolation:isolate;
    transform:translateZ(0);
  }

  /* ===== CELEBRATION FLASH ===== */
  .slotCard.flash{
    border-color:rgba(255,216,138,.38);
    box-shadow:
      0 0 0 1px rgba(255,216,138,.14),
      0 0 44px rgba(255,216,138,.20),
      0 0 110px rgba(38,215,255,.10),
      0 18px 65px rgba(0,0,0,.42),
      inset 0 1px 0 rgba(255,255,255,.12);
  }
  .slotCard.flash::before{
    content:"";
    position:absolute; inset:-2px;
    pointer-events:none;
    z-index:0;
    background:
      conic-gradient(from 30deg,
        rgba(255,216,138,.00) 0%,
        rgba(255,216,138,.20) 12%,
        rgba(38,215,255,.14) 22%,
        rgba(255,43,214,.12) 34%,
        rgba(255,216,138,.22) 52%,
        rgba(38,215,255,.12) 70%,
        rgba(255,216,138,.00) 100%);
    opacity:0;
    filter:saturate(1.25);
    animation:flashFlicker var(--flashDur) var(--ease) both;
  }
  .slotCard.flash::after{
    content:"";
    position:absolute; inset:-2px;
    pointer-events:none;
    z-index:0;
    background:
      radial-gradient(980px 360px at 50% 12%, rgba(255,216,138,.28), transparent 62%),
      radial-gradient(860px 360px at 12% 65%, rgba(38,215,255,.16), transparent 66%),
      radial-gradient(860px 360px at 88% 65%, rgba(255,43,214,.14), transparent 66%),
      repeating-linear-gradient(90deg, rgba(255,216,138,.00) 0 10px, rgba(255,216,138,.10) 10px 12px, rgba(255,216,138,.00) 12px 22px);
    opacity:0;
    transform:translate3d(0,-10px,0) scale(.99);
    filter: blur(8px) saturate(1.15);
    animation:flashDown var(--flashDur) var(--ease) both;
  }

  @keyframes flashFlicker{
    0%   {opacity:0; }
    5%   {opacity:.85;}
    10%  {opacity:.22;}
    14%  {opacity:.95;}
    18%  {opacity:.18;}
    22%  {opacity:.92;}
    26%  {opacity:.20;}
    30%  {opacity:.90;}
    34%  {opacity:.16;}
    38%  {opacity:.88;}
    42%  {opacity:.22;}
    46%  {opacity:.84;}
    50%  {opacity:.18;}
    54%  {opacity:.86;}
    58%  {opacity:.22;}
    62%  {opacity:.82;}
    66%  {opacity:.16;}
    70%  {opacity:.78;}
    75%  {opacity:.70;}
    100% {opacity:0;}
  }

  @keyframes flashDown{
    0%   {opacity:0;   transform:translate3d(0,-10px,0) scale(.99);}
    5%   {opacity:1;   transform:translate3d(0,-6px,0)  scale(1);}
    10%  {opacity:.22; transform:translate3d(0,-6px,0)  scale(1);}
    14%  {opacity:1;   transform:translate3d(0,-4px,0)  scale(1);}
    18%  {opacity:.18; transform:translate3d(0,-4px,0)  scale(1);}
    22%  {opacity:1;   transform:translate3d(0,-2px,0)  scale(1);}
    26%  {opacity:.20; transform:translate3d(0,-2px,0)  scale(1);}
    30%  {opacity:1;   transform:translate3d(0,0,0)     scale(1);}
    34%  {opacity:.18; transform:translate3d(0,0,0)     scale(1);}
    38%  {opacity:1;   transform:translate3d(0,1px,0)   scale(1);}
    42%  {opacity:.22; transform:translate3d(0,1px,0)   scale(1);}
    46%  {opacity:1;   transform:translate3d(0,0,0)     scale(1);}
    50%  {opacity:.18; transform:translate3d(0,0,0)     scale(1);}
    54%  {opacity:1;   transform:translate3d(0,2px,0)   scale(1.005);}
    58%  {opacity:.22; transform:translate3d(0,2px,0)   scale(1.005);}
    62%  {opacity:1;   transform:translate3d(0,0,0)     scale(1.008);}
    66%  {opacity:.18; transform:translate3d(0,0,0)     scale(1.008);}
    70%  {opacity:1;   transform:translate3d(0,1px,0)   scale(1.01);}
    75%  {opacity:1;   transform:translate3d(0,0,0)     scale(1.01);}
    100% {opacity:0;   transform:translate3d(0,18px,0)  scale(1.015);}
  }

  /* ‚úÖ label di atas mesin slot dihapus total */
  .slotHeader{ display:none !important; }

  .machine{ padding:16px; position:relative; z-index:1; }

  .reels{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:14px;
    padding:14px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    background:
      radial-gradient(980px 260px at 50% 0%, rgba(124,77,255,.14), transparent 62%),
      radial-gradient(900px 300px at 50% 120%, rgba(38,215,255,.10), transparent 64%),
      linear-gradient(180deg, rgba(255,255,255,.040), rgba(255,255,255,.016)),
      rgba(0,0,0,.20);
    position:relative;
    overflow:hidden;
    transform:translate3d(0,0,0);
    isolation:isolate;

    /* ‚úÖ shadow mesin: rapi + depth */
    box-shadow:
      inset 0 26px 34px rgba(0,0,0,.62),
      inset 0 -26px 34px rgba(0,0,0,.66),
      inset 0 1px 0 rgba(255,255,255,.08),
      0 18px 38px rgba(0,0,0,.20);

    /* ‚úÖ 3D depth */
    perspective: var(--reelPersp);
    perspective-origin: 50% 50%;
    contain:layout paint;
  }
  html[data-perf="low"] .reels{
    box-shadow:
      inset 0 22px 30px rgba(0,0,0,.60),
      inset 0 -22px 30px rgba(0,0,0,.64),
      inset 0 1px 0 rgba(255,255,255,.07),
      0 16px 34px rgba(0,0,0,.18);
  }

  /* ‚úÖ overlay reels: halus, no seam/line tengah */
  .reels::before{
    content:"";
    position:absolute; inset:0;
    pointer-events:none;
    z-index:1;
    background:
      linear-gradient(180deg,
        rgba(0,0,0,.64) 0%,
        rgba(0,0,0,.34) 14%,
        rgba(0,0,0,0)   36%,
        rgba(0,0,0,0)   64%,
        rgba(0,0,0,.34) 86%,
        rgba(0,0,0,.64) 100%),
      linear-gradient(90deg,
        rgba(0,0,0,.22) 0%,
        rgba(0,0,0,0)  18%,
        rgba(0,0,0,0)  82%,
        rgba(0,0,0,.22) 100%),
      radial-gradient(760px 180px at 50% 10%, rgba(255,255,255,.040), transparent 62%);
    opacity:.76;
  }
  .reels.spinning::before{ opacity:.70; }

  .reels.stopping{
    border-color:rgba(38,215,255,.22);
    box-shadow:
      inset 0 26px 34px rgba(0,0,0,.62),
      inset 0 -26px 34px rgba(0,0,0,.66),
      inset 0 1px 0 rgba(255,255,255,.08),
      0 0 0 1px rgba(38,215,255,.10),
      0 0 28px rgba(38,215,255,.10),
      0 18px 38px rgba(0,0,0,.20);
  }
  .reels.flash{
    border-color:rgba(255,216,138,.34);
    box-shadow:
      inset 0 26px 34px rgba(0,0,0,.62),
      inset 0 -26px 34px rgba(0,0,0,.66),
      inset 0 1px 0 rgba(255,255,255,.08),
      0 0 0 1px rgba(255,216,138,.14),
      0 0 44px rgba(255,216,138,.14),
      0 18px 38px rgba(0,0,0,.20);
  }
  .reels.flash::after{
    content:"";
    position:absolute; inset:-2px;
    pointer-events:none;
    z-index:2;
    background:
      radial-gradient(820px 220px at 50% 50%, rgba(255,216,138,.14), transparent 62%),
      repeating-linear-gradient(90deg, rgba(255,216,138,.00) 0 10px, rgba(255,216,138,.10) 10px 12px, rgba(255,216,138,.00) 12px 22px);
    opacity:0;
    transform:translate3d(0,-10px,0);
    animation:flashDown var(--flashDur) var(--ease) both;
    filter: blur(6px) saturate(1.08);
  }

  .reel{
    position:relative;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    overflow:hidden;
    height:calc(var(--cell) * 3);
    isolation:isolate;

    /* ‚úÖ permukaan silinder: lebih ‚Äúround‚Äù (dark edge + bright center) */
    background:
      radial-gradient(260px 180px at 50% 14%, rgba(255,255,255,.055), transparent 64%),
      radial-gradient(320px 220px at 50% 92%, rgba(38,215,255,.030), transparent 66%),
      linear-gradient(90deg,
        rgba(0,0,0,.26) 0%,
        rgba(0,0,0,.14) 12%,
        rgba(255,255,255,.038) 26%,
        rgba(255,255,255,.030) 50%,
        rgba(255,255,255,.038) 74%,
        rgba(0,0,0,.14) 88%,
        rgba(0,0,0,.26) 100%),
      rgba(255,255,255,.020);

    /* ‚úÖ depth ‚Äúsilinder‚Äù + side vignette */
    box-shadow:
      inset 0 18px 26px rgba(0,0,0,.54),
      inset 0 -18px 26px rgba(0,0,0,.56),
      inset 14px 0 18px rgba(0,0,0,.26),
      inset -14px 0 18px rgba(0,0,0,.26),
      inset 0 1px 0 rgba(255,255,255,.06);

    contain:content;
    transform:translate3d(0,0,0);
    backface-visibility:hidden;
    transform-style:preserve-3d;
  }
  @supports (overflow: clip){
    .reel{ overflow:clip; }
  }
  html[data-perf="low"] .reel{
    background:
      radial-gradient(260px 180px at 50% 14%, rgba(255,255,255,.046), transparent 64%),
      linear-gradient(90deg,
        rgba(0,0,0,.26) 0%,
        rgba(0,0,0,.14) 12%,
        rgba(255,255,255,.032) 26%,
        rgba(255,255,255,.025) 50%,
        rgba(255,255,255,.032) 74%,
        rgba(0,0,0,.14) 88%,
        rgba(0,0,0,.26) 100%),
      rgba(255,255,255,.018);
    box-shadow:
      inset 0 16px 22px rgba(0,0,0,.52),
      inset 0 -16px 22px rgba(0,0,0,.54),
      inset 12px 0 16px rgba(0,0,0,.24),
      inset -12px 0 16px rgba(0,0,0,.24),
      inset 0 1px 0 rgba(255,255,255,.06);
  }

  /* ‚úÖ overlay reel: glass + curvature highlight (lebih real slot) */
  .reel::before{
    content:"";
    position:absolute; inset:0;
    pointer-events:none;
    z-index:1;
    background:
      /* top/bot vignette */
      linear-gradient(180deg,
        rgba(0,0,0,.72) 0%,
        rgba(0,0,0,.42) 12%,
        rgba(0,0,0,0)   34%,
        rgba(0,0,0,0)   66%,
        rgba(0,0,0,.42) 88%,
        rgba(0,0,0,.72) 100%),
      /* strong cylinder curve (edge darker, center brighter) */
      radial-gradient(240% 90% at 50% 50%, rgba(255,255,255,.070), transparent 62%),
      linear-gradient(90deg,
        rgba(0,0,0,.22) 0%,
        rgba(255,255,255,.055) 20%,
        rgba(255,255,255,.015) 50%,
        rgba(255,255,255,.055) 80%,
        rgba(0,0,0,.22) 100%),
      /* subtle specular streak */
      linear-gradient(105deg,
        transparent 0%,
        rgba(255,255,255,.06) 34%,
        rgba(255,255,255,.00) 52%,
        rgba(255,255,255,.04) 62%,
        transparent 100%);
    opacity:.86;
  }

  /* ‚úÖ spinning sheen: bersih + ringan (no blend-mode) */
  .reel.spinning::after{
    content:"";
    position:absolute; inset:0;
    pointer-events:none;
    z-index:2;
    opacity:.60;
    background:
      radial-gradient(220px 260px at 50% 50%, rgba(38,215,255,.08), transparent 62%),
      linear-gradient(180deg, rgba(255,255,255,.050), transparent 26%, transparent 74%, rgba(255,255,255,.046)),
      repeating-linear-gradient(180deg, rgba(255,255,255,.030) 0 10px, rgba(255,255,255,0) 10px 46px);
    background-size:auto, auto, 100% 240px;
    background-position:0 0, 0 0, 0 0;
    filter:saturate(1.06);
    transform:translateZ(0);
  }
  html:not(.rm) .reel.spinning::after{ animation: reelSheen .98s linear infinite; }
  html[data-perf="low"] .reel.spinning::after{
    animation:none;
    opacity:.54;
    background-size:auto, auto, 100% 280px;
  }
  @keyframes reelSheen{
    to{ background-position:0 0, 0 0, 0 240px; }
  }

  .reel.kick{ animation:reelKick .20s var(--ease); }
  @keyframes reelKick{
    0%{ transform:translate3d(0,0,0) scale(1); }
    45%{ transform:translate3d(0,1px,0) scale(.996); }
    100%{ transform:translate3d(0,0,0) scale(1); }
  }

  .strip{
    position:absolute;
    left:0; right:0;
    top:0;
    transform:translate3d(0,0,0);
    backface-visibility:hidden;
    z-index:0;
    contain:layout paint;
    will-change:auto;
  }
  /* ‚úÖ will-change hanya saat spin (lebih cepat di low-end) */
  .reel.spinning .strip{ will-change:transform; }

  .symbol{
    height:var(--cell);
    display:grid;
    place-items:center;
    user-select:none;
    transform-style:preserve-3d;
    position:relative;
    padding:calc(var(--cell) * .06);
    contain:layout paint;
  }

  /* ‚úÖ layering per row */
  .symbol.posTop{ z-index:1; }
  .symbol.posBot{ z-index:2; }
  .symbol.posMid{ z-index:3; }

  /* ‚úÖ ICON HOST (PNG/EMOJI) */
  .symBox{
    width:calc(var(--cell) * .78);
    height:calc(var(--cell) * .78);

    border-radius:18px;
    border:1px solid rgba(255,255,255,.12);
    background:
      radial-gradient(140px 140px at 28% 22%, rgba(255,255,255,.11), transparent 62%),
      radial-gradient(120px 120px at 72% 78%, rgba(38,215,255,.07), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.082), rgba(255,255,255,.032));
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.12),
      0 10px 22px rgba(0,0,0,.22);
    display:grid;
    place-items:center;
    position:relative;
    overflow:hidden;
    transform:translate3d(0,0,0);
    transform-origin:50% 50%;
    backface-visibility:hidden;
  }

  /* specular + shading (bikin ‚Äúnempel silinder‚Äù) */
  .symBox::before{
    content:"";
    position:absolute; inset:-18%;
    pointer-events:none;
    background:
      radial-gradient(120px 90px at 30% 18%, rgba(255,255,255,.20), transparent 62%),
      linear-gradient(90deg, rgba(255,255,255,.085), transparent 34%, transparent 66%, rgba(0,0,0,.14));
    opacity:.50;
    mix-blend-mode:normal;
    transform:translateZ(0);
  }
  .symBox::after{
    content:"";
    position:absolute; inset:0;
    pointer-events:none;
    background:linear-gradient(180deg, rgba(0,0,0,.30), transparent 40%, transparent 60%, rgba(0,0,0,.38));
    opacity:.46;
    transform:translateZ(0);
  }
  html[data-perf="low"] .symBox::before{ opacity:.40; }
  html[data-perf="low"] .symBox::after{ opacity:.40; }

  .symImg{
    width:74%;
    height:74%;
    object-fit:contain;
    display:block;
    transform:translateZ(0);
    backface-visibility:hidden;
    filter: drop-shadow(0 3px 10px rgba(0,0,0,.22));
  }
  .symEmoji{
    display:block;
    line-height:1;
    transform:translateZ(0);
    filter: drop-shadow(0 3px 10px rgba(0,0,0,.22));
    font-size:calc(var(--cell) * .44);
  }

  /* ‚úÖ cylinder curvature per visible row (emoji ikut efek) */
  .symbol.posTop .symBox{
    transform:perspective(var(--reelCurve)) rotateX(16deg) scale(.955);
    filter:brightness(.95) saturate(1.06);
  }
  .symbol.posMid .symBox{
    transform:perspective(var(--reelCurve)) rotateX(0deg) scale(1.02);
    filter:brightness(1.02) saturate(1.08);
  }
  .symbol.posBot .symBox{
    transform:perspective(var(--reelCurve)) rotateX(-16deg) scale(.955);
    filter:brightness(.95) saturate(1.06);
  }
  html[data-perf="low"]{
    --reelCurve: 520px;
  }
  html[data-perf="low"] .symbol.posTop .symBox{
    transform:perspective(var(--reelCurve)) rotateX(12deg) scale(.965);
  }
  html[data-perf="low"] .symbol.posBot .symBox{
    transform:perspective(var(--reelCurve)) rotateX(-12deg) scale(.965);
  }

  .symbol.isMid .symBox{
    outline:1px solid rgba(255,255,255,.08);
    outline-offset:1px;
  }

  /* ‚úÖ WIN highlight */
  .reel.win .symbol.isMid .symBox{
    border-color:rgba(255,216,138,.62);
    box-shadow:
      0 0 0 1px rgba(255,216,138,.26),
      0 0 32px rgba(255,216,138,.14),
      inset 0 1px 0 rgba(255,255,255,.14);
    transform:perspective(var(--reelCurve)) rotateX(0deg) scale(1.06);
    animation:winPulse .88s var(--ease) 0s 1 both;
  }
  @keyframes winPulse{
    0%{ transform:perspective(var(--reelCurve)) rotateX(0deg) scale(1.02); }
    55%{ transform:perspective(var(--reelCurve)) rotateX(0deg) scale(1.08); }
    100%{ transform:perspective(var(--reelCurve)) rotateX(0deg) scale(1.06); }
  }

  /* INPUTS */
  .fields{ margin-top:14px; display:grid; gap:10px; }
  .field{ display:grid; gap:7px; }
  .field .lbl{
    font-size:12px;
    color:rgba(234,240,255,.72);
    font-weight:900;
    letter-spacing:.55px;
    text-transform:uppercase;
    user-select:none;
    text-align:center;
  }
  .field input{
    width:100%;
    padding:13px 14px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.05);
    color:rgba(234,240,255,.95);
    outline:none;
    font-weight:800;
    letter-spacing:.35px;
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.08),
      0 10px 24px rgba(0,0,0,.18);
    transition:transform .14s var(--ease), border-color .18s var(--ease), background .18s var(--ease), box-shadow .18s var(--ease);
    text-align:center;
    transform:translateZ(0);
    text-transform:uppercase;
  }
  .field input::placeholder{
    color:rgba(234,240,255,.50);
    font-weight:650;
    text-align:center;
    letter-spacing:.2px;
  }
  .field input:focus{
    border-color:rgba(38,215,255,.35);
    background:rgba(255,255,255,.06);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.08),
      0 0 0 3px rgba(38,215,255,.10),
      0 10px 26px rgba(0,0,0,.22);
  }
  .field input:disabled{
    cursor:not-allowed;
    opacity:.82;
    filter:saturate(.92) brightness(.96);
    background:rgba(255,255,255,.04);
  }
  .field.err input{
    border-color:rgba(255,43,214,.42);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.06),
      0 0 0 3px rgba(255,43,214,.12),
      0 10px 26px rgba(0,0,0,.22);
    animation:shake .22s var(--ease) 0s 2;
  }
  @keyframes shake{
    0%{ transform:translateX(0); }
    35%{ transform:translateX(-2px); }
    70%{ transform:translateX(2px); }
    100%{ transform:translateX(0); }
  }

  .controls{ margin-top:12px; display:flex; align-items:stretch; }
  .btn{
    width:100%;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.14);
    background:
      radial-gradient(120px 120px at 20% 20%, rgba(255,255,255,.12), transparent 60%),
      linear-gradient(180deg, rgba(124,77,255,.24), rgba(38,215,255,.14));
    color:rgba(234,240,255,.96);
    font-weight:900;
    letter-spacing:.9px;
    padding:14px 16px;
    cursor:pointer;
    transition:transform .14s var(--ease), filter .18s var(--ease), border-color .18s var(--ease);
    box-shadow:
      0 16px 34px rgba(0,0,0,.32),
      inset 0 1px 0 rgba(255,255,255,.14);
    touch-action:manipulation;
    text-transform:uppercase;
    font-family:Orbitron, Inter, system-ui;
    transform:translateZ(0);
  }
  .btn:active{ transform:translateY(1px) scale(.995); }
  .btn:disabled{ cursor:not-allowed; filter:saturate(.8) brightness(.92); opacity:.82; }

  /* SIDE */
  .side{
    border-radius:var(--radius);
    background:linear-gradient(180deg, rgba(12,14,30,.74), rgba(8,9,22,.66));
    border:1px solid rgba(255,255,255,.10);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.08),
      0 18px 55px rgba(0,0,0,.22);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    min-height:240px;
    transform:translateZ(0);
  }
  @supports (content-visibility:auto){
    .side{ content-visibility:auto; contain-intrinsic-size: 480px 420px; }
  }

  .sideHead{
    padding:14px 16px;
    border-bottom:1px solid rgba(255,255,255,.08);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .sideHead .t{
    font-weight:900;
    letter-spacing:.2px;
    font-size:13px;
    color:rgba(234,240,255,.92);
    text-transform:uppercase;
  }

  .pillBtn{
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    color:rgba(234,240,255,.92);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.08);
    border-radius:999px;
    padding:10px 12px;
    font-size:12.5px;
    font-weight:800;
    letter-spacing:.2px;
    cursor:pointer;
    transition:transform .14s var(--ease), border-color .18s var(--ease), filter .18s var(--ease);
    touch-action:manipulation;
    white-space:nowrap;
    text-transform:uppercase;
    font-family:Orbitron, Inter, system-ui;
    transform:translateZ(0);
  }
  .pillBtn:hover{ border-color:rgba(255,255,255,.22); }
  .pillBtn:active{ transform:translateY(1px) scale(.995); }

  .prizeWrap{ padding:16px; display:grid; gap:14px; }

  .prizeCard{
    border-radius:20px;
    border:1px solid rgba(255,255,255,.10);
    background:
      radial-gradient(900px 260px at 50% 0%, rgba(124,77,255,.10), transparent 62%),
      radial-gradient(820px 260px at 50% 110%, rgba(38,215,255,.08), transparent 62%),
      rgba(0,0,0,.14);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
    padding:14px;
    display:grid;
    justify-items:center;
    text-align:center;
    gap:10px;
    transform:translateZ(0);
  }

  .prizeIcon{
    width:74px; height:74px;
    border-radius:22px;
    border:1px solid rgba(255,255,255,.12);
    background:
      radial-gradient(120px 120px at 30% 25%, rgba(255,255,255,.10), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.10),
      0 12px 26px rgba(0,0,0,.22);
    display:grid;
    place-items:center;
    overflow:hidden;
  }
  .prizeIcon .symImg{ width:68%; height:68%; }
  .prizeIcon .symEmoji{ font-size:34px; }

  .prizeTitle{
    font-family:Orbitron, Inter, system-ui;
    font-weight:900;
    letter-spacing:.7px;
    font-size:18px;
    color:rgba(234,240,255,.95);
    text-transform:uppercase;
  }
  .prizeSub{ font-size:12.5px; color:rgba(234,240,255,.72); line-height:1.4; }

  .prizeActions{ width:100%; display:flex; gap:10px; margin-top:4px; }

  .aBtn{
    flex:1;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);
    color:rgba(234,240,255,.95);
    font-weight:900;
    letter-spacing:.5px;
    padding:12px 10px;
    cursor:pointer;
    transition:transform .14s var(--ease), border-color .18s var(--ease), filter .18s var(--ease);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.10),
      0 12px 26px rgba(0,0,0,.22);
    text-transform:uppercase;
    font-family:Orbitron, Inter, system-ui;
    font-size:12px;
    touch-action:manipulation;
    white-space:nowrap;
    transform:translateZ(0);
  }
  .aBtn.primary{
    background:linear-gradient(180deg, rgba(255,216,138,.22), rgba(255,43,214,.12));
    border-color:rgba(255,216,138,.22);
  }
  .aBtn:active{ transform:translateY(1px) scale(.995); }
  .aBtn:disabled{ cursor:not-allowed; opacity:.58; filter:saturate(.85) brightness(.95); }

  /* ARTI SIMBOL */
  .legendCard{
    border-radius:20px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.12);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
    overflow:hidden;
  }
  @supports (content-visibility:auto){
    .legendCard{ content-visibility:auto; contain-intrinsic-size: 420px 300px; }
  }

  .legendHead{
    padding:12px 12px 10px;
    border-bottom:1px solid rgba(255,255,255,.08);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .legendT{
    font-family:Orbitron, Inter, system-ui;
    font-weight:900;
    letter-spacing:.6px;
    font-size:12px;
    color:rgba(234,240,255,.92);
    text-transform:uppercase;
  }
  .legendList{
    padding:12px;
    display:grid;
    grid-template-columns:repeat(4, minmax(0, 1fr));
    gap:10px;
  }
  @media (max-width: 420px){
    .legendList{ gap:8px; }
  }

  .legItem{
    appearance:none;
    -webkit-appearance:none;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.03);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
    border-radius:16px;
    padding:10px 8px 9px;
    display:grid;
    justify-items:center;
    gap:7px;
    text-align:center;
    cursor:pointer;
    touch-action:manipulation;
    transition:transform .14s var(--ease), border-color .18s var(--ease), filter .18s var(--ease);
    min-height:92px;
    transform:translateZ(0);
  }
  .legItem:hover{ border-color:rgba(255,255,255,.20); }
  .legItem:active{ transform:translateY(1px) scale(.995); }

  .legIcon{
    width:48px; height:48px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background:
      radial-gradient(90px 90px at 30% 25%, rgba(255,255,255,.10), transparent 60%),
      linear-gradient(180deg, rgba(124,77,255,.14), rgba(38,215,255,.08));
    box-shadow:inset 0 1px 0 rgba(255,255,255,.10), 0 10px 22px rgba(0,0,0,.18);
    display:grid;
    place-items:center;
    overflow:hidden;
  }
  .legIcon .symImg{ width:72%; height:72%; }
  .legIcon .symEmoji{ font-size:26px; }

  .legName{
    font-weight:950;
    letter-spacing:.25px;
    font-size:11px;
    color:rgba(234,240,255,.92);
    text-transform:uppercase;
    line-height:1.05;
  }

  /* PRIZE DETAIL LIST */
  .prList{ display:grid; gap:12px; padding:2px 0; }
  .pItem{
    display:grid;
    grid-template-columns:64px 1fr;
    gap:12px;
    align-items:center;
    padding:12px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.14);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
  }
  .pImg{
    width:64px; height:64px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background:
      radial-gradient(90px 90px at 30% 25%, rgba(255,255,255,.10), transparent 60%),
      linear-gradient(180deg, rgba(124,77,255,.16), rgba(38,215,255,.10));
    box-shadow:inset 0 1px 0 rgba(255,255,255,.10), 0 12px 22px rgba(0,0,0,.18);
    overflow:hidden;
    position:relative;
  }
  .pImg[data-has="1"]{
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
  }
  .pImg::after{
    content:"IMG";
    position:absolute; inset:0;
    display:grid;
    place-items:center;
    font-family:Orbitron, Inter, system-ui;
    letter-spacing:.6px;
    font-weight:900;
    font-size:12px;
    color:rgba(234,240,255,.55);
    mix-blend-mode:screen;
  }
  .pImg[data-has="1"]::after{ display:none; }
  .pTxt{ min-width:0; }
  .pName{
    font-weight:900;
    letter-spacing:.2px;
    font-size:13px;
    color:rgba(234,240,255,.92);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    text-transform:uppercase;
  }

  /* MODAL */
  .modal{
    position:fixed; inset:0;
    display:none;
    place-items:center;
    padding:18px;
    background:rgba(0,0,0,.64);
    z-index:50;
  }
  .modal.on{ display:grid; }

  .panel{
    width:min(520px, 100%);
    border-radius:22px;
    border:1px solid rgba(255,255,255,.12);
    background:linear-gradient(180deg, rgba(16,18,44,.94), rgba(9,10,24,.92));
    box-shadow:0 30px 90px rgba(0,0,0,.60), inset 0 1px 0 rgba(255,255,255,.10);
    overflow:hidden;
    transform:translate3d(0, 6px, 0) scale(.985);
    opacity:0;
    animation:popIn .22s var(--ease) both;
    will-change: transform, opacity;
  }
  @keyframes popIn{
    to{ transform:translate3d(0,0,0) scale(1); opacity:1; }
  }

  /* ‚úÖ TITLE POPUP: center */
  .panelHead{
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    align-items:center;
    padding:14px 16px;
    border-bottom:1px solid rgba(255,255,255,.08);
    gap:10px;
  }
  .phSlot{ min-height:1px; }
  .panelHead .t{
    font-family:Orbitron, Inter, system-ui;
    font-weight:900;
    letter-spacing:.7px;
    font-size:14px;
    text-transform:uppercase;
    text-align:center;
    justify-self:center;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .panelHead .txtBtn{ justify-self:end; }

  .panelBody{
    padding:14px 16px 16px;
    max-height:min(72vh, 560px);
    overflow:auto;
    overscroll-behavior:contain;
    -webkit-overflow-scrolling:touch;
  }

  /* LOGIN + ACTIONS */
  .panelBody .field{ margin:0; }
  .panelActions{ margin-top:12px; display:flex; gap:10px; }
  .panelActions .btn, .panelActions .aBtn{ width:auto; flex:1; }

  /* JACKPOT PANEL */
  .jpWrap{ display:grid; gap:12px; justify-items:center; text-align:center; }
  .jpSymbol{
    width:92px; height:92px;
    border-radius:26px;
    border:1px solid rgba(255,255,255,.14);
    background:
      radial-gradient(140px 140px at 30% 25%, rgba(255,255,255,.12), transparent 60%),
      linear-gradient(180deg, rgba(255,216,138,.10), rgba(38,215,255,.08));
    box-shadow:inset 0 1px 0 rgba(255,255,255,.10), 0 18px 34px rgba(0,0,0,.30);
    display:grid;
    place-items:center;
    overflow:hidden;
  }
  .jpSymbol .symImg{ width:70%; height:70%; }
  .jpSymbol .symEmoji{ font-size:40px; }

  .jpImg{
    width:min(360px, 100%);
    aspect-ratio: 16 / 9;
    border-radius:20px;
    border:1px solid rgba(255,255,255,.12);
    background:
      radial-gradient(900px 260px at 50% 0%, rgba(124,77,255,.10), transparent 62%),
      radial-gradient(820px 260px at 50% 110%, rgba(38,215,255,.08), transparent 62%),
      rgba(0,0,0,.14);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
    overflow:hidden;
    position:relative;
    display:grid;
    place-items:center;
    transform:translateZ(0);
  }
  .jpImg[data-has="1"]{
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
  }
  .jpImg::after{
    content:"PNG";
    font-family:Orbitron, Inter, system-ui;
    letter-spacing:.8px;
    font-weight:900;
    font-size:12px;
    color:rgba(234,240,255,.55);
    mix-blend-mode:screen;
  }
  .jpImg[data-has="1"]::after{ display:none; }

  .jpTitle{
    font-family:Orbitron, Inter, system-ui;
    font-weight:900;
    letter-spacing:.8px;
    font-size:18px;
    text-transform:uppercase;
    color:rgba(234,240,255,.96);
  }
  .jpMeta{ width:100%; display:grid; gap:8px; text-align:left; }
  .metaRow{
    display:flex;
    justify-content:space-between;
    gap:12px;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.14);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
  }
  .metaK{
    font-weight:900;
    letter-spacing:.35px;
    font-size:12px;
    color:rgba(234,240,255,.88);
    text-transform:uppercase;
    white-space:nowrap;
  }
  .metaV{
    font-weight:800;
    font-size:12px;
    color:rgba(234,240,255,.72);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    text-align:right;
    min-width:0;
  }

  /* Symbol detail modal */
  .symPop{ display:grid; gap:12px; justify-items:center; text-align:center; }
  .symPopIcon{
    width:96px; height:96px;
    border-radius:28px;
    border:1px solid rgba(255,255,255,.14);
    background:
      radial-gradient(160px 160px at 30% 25%, rgba(255,255,255,.12), transparent 60%),
      linear-gradient(180deg, rgba(124,77,255,.14), rgba(38,215,255,.08));
    box-shadow:inset 0 1px 0 rgba(255,255,255,.10), 0 18px 34px rgba(0,0,0,.30);
    display:grid;
    place-items:center;
    overflow:hidden;
  }
  .symPopIcon .symImg{ width:70%; height:70%; }
  .symPopIcon .symEmoji{ font-size:44px; }

  .symPopName{
    font-family:Orbitron, Inter, system-ui;
    font-weight:950;
    letter-spacing:.9px;
    font-size:18px;
    text-transform:uppercase;
    color:rgba(234,240,255,.96);
  }
  .symPopDesc{
    font-size:13px;
    color:rgba(234,240,255,.78);
    line-height:1.45;
    max-width:42ch;
  }
  .symPopImg{
    width:min(360px, 100%);
    aspect-ratio: 16 / 9;
    border-radius:20px;
    border:1px solid rgba(255,255,255,.12);
    background:
      radial-gradient(900px 260px at 50% 0%, rgba(124,77,255,.10), transparent 62%),
      radial-gradient(820px 260px at 50% 110%, rgba(38,215,255,.08), transparent 62%),
      rgba(0,0,0,.14);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
    overflow:hidden;
    position:relative;
    display:grid;
    place-items:center;
    transform:translateZ(0);
  }
  .symPopImg[data-has="1"]{
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
  }
  .symPopImg::after{
    content:"PRIZE";
    font-family:Orbitron, Inter, system-ui;
    letter-spacing:.8px;
    font-weight:900;
    font-size:12px;
    color:rgba(234,240,255,.55);
    mix-blend-mode:screen;
  }
  .symPopImg[data-has="1"]::after{ display:none; }

  /* Reduced Motion */
  .rm .reel.spinning::after{ display:none; }
  .rm .btn, .rm .txtBtn, .rm .pillBtn { transition:none !important; }
  .rm .reel.kick{ animation:none !important; }
  .rm .reel.win .symbol.isMid .symBox{ animation:none !important; }
  .rm .slotCard.flash::before,
  .rm .slotCard.flash::after,
  .rm .reels.flash::after{ animation:none !important; opacity:0 !important; }
  .rm .panel{ animation:none !important; transform:none !important; opacity:1 !important; }

  @media (prefers-reduced-motion: reduce){
    .btn, .txtBtn, .pillBtn { transition:none !important; }
  }

  /* PERF TIER TUNING */
  html[data-perf="low"] .slotCard.flash::after{ filter: blur(6px) saturate(1.08); }
  html[data-perf="low"] .reels.flash::after{ filter: blur(5px) saturate(1.02); }
</style>
</head>

<body>

  <div class="wrap">
    <div class="app" role="application" aria-label="Neon Slot Arcade">

      <header class="top">
        <div class="topSlot" aria-hidden="true"></div>
        <div class="brand">
          <div class="title">SELAMAT DATANG DI MADETOTO2</div>
          <div class="subTitle">Putar Mesin Slot Keberuntunganmu</div>
        </div>
        <div class="topSlot" aria-hidden="true"></div>
      </header>

      <main class="main">
        <section class="slotCard" id="slotCard" aria-label="Slot Machine">
          <div class="slotHeader">
            <div class="hL">
              <div class="hT">NEON SLOT - ARCADE</div>
              <div class="hS">SELAMAT DATANG DI MADETOTO2</div>
            </div>
          </div>

          <div class="machine">
            <div class="reels" id="reels">
              <div class="reel" data-reel="0"><div class="strip"></div></div>
              <div class="reel" data-reel="1"><div class="strip"></div></div>
              <div class="reel" data-reel="2"><div class="strip"></div></div>
            </div>

            <div class="fields" aria-label="Inputs">
              <label class="field" id="fieldCode">
                <span class="lbl">KODE</span>
                <input id="inpCode" type="text" inputmode="text" autocomplete="off" autocapitalize="characters" spellcheck="false" placeholder="MASUKKAN KODE" />
              </label>
            </div>

            <div class="controls">
              <button class="btn" id="btnSpin" type="button">SPIN</button>
            </div>
          </div>
        </section>

        <aside class="side" aria-label="Prize">
          <div class="sideHead">
            <div class="t">PRIZE</div>
            <button class="pillBtn" id="btnPrizeDetail" type="button">DETAIL HADIAH</button>
          </div>

          <div class="prizeWrap">
            <div class="prizeCard">
              <div class="prizeIcon" id="prizeIcon" aria-hidden="true"></div>
              <div class="prizeTitle" id="prizeTitle">‚Äî</div>
              <div class="prizeSub" id="prizeSub">‚Äî</div>

              <div class="prizeActions" aria-label="Aksi Hadiah">
                <button class="aBtn primary" id="btnClaim" type="button" disabled>CLAIM</button>
                <button class="aBtn" id="btnShare" type="button" disabled>BAGIKAN</button>
              </div>
            </div>

            <div class="legendCard" aria-label="Arti Simbol Prize">
              <div class="legendHead">
                <div class="legendT">ARTI SIMBOL</div>
              </div>
              <div class="legendList" id="symbolLegend"></div>
            </div>
          </div>
        </aside>
      </main>
    </div>
  </div>

  <!-- PRIZE DETAIL MODAL -->
  <div class="modal" id="modalPrize">
    <div class="panel" role="dialog" aria-modal="true" aria-label="Detail Hadiah">
      <div class="panelHead">
        <div class="phSlot" aria-hidden="true"></div>
        <div class="t">DETAIL HADIAH</div>
        <button class="txtBtn" id="btnPrizeClose" type="button">KEMBALI</button>
      </div>
      <div class="panelBody">
        <div class="prList" id="prizeList"></div>
      </div>
    </div>
  </div>

  <!-- SYMBOL DETAIL MODAL -->
  <div class="modal" id="modalSymbol">
    <div class="panel" role="dialog" aria-modal="true" aria-label="Arti Simbol">
      <div class="panelHead">
        <div class="phSlot" aria-hidden="true"></div>
        <div class="t">ARTI SIMBOL</div>
        <button class="txtBtn" id="btnSymbolClose" type="button">KEMBALI</button>
      </div>
      <div class="panelBody">
        <div class="symPop">
          <div class="symPopIcon" id="symPopIcon"></div>
          <div class="symPopName" id="symPopName">‚Äî</div>
          <div class="symPopDesc" id="symPopDesc">‚Äî</div>
          <div class="symPopImg" id="symPopImg" data-has="0"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL (tanpa close) -->
  <div class="modal" id="modalLogin">
    <div class="panel" role="dialog" aria-modal="true" aria-label="Login">
      <div class="panelHead">
        <div class="phSlot" aria-hidden="true"></div>
        <div class="t">SLOT MECHANIC</div>
        <div class="phSlot" aria-hidden="true"></div>
      </div>
      <div class="panelBody">
        <label class="field" id="fieldUser">
          <span class="lbl">USER ID</span>
          <input id="inpUser" type="text" inputmode="text" autocomplete="off" autocapitalize="none" spellcheck="false" placeholder="MASUKKAN USER ID" />
        </label>
        <div class="panelActions">
          <button class="btn" id="btnLogin" type="button">LOGIN</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JACKPOT MODAL -->
  <div class="modal" id="modalJackpot">
    <div class="panel" role="dialog" aria-modal="true" aria-label="Jackpot">
      <div class="panelHead">
        <div class="phSlot" aria-hidden="true"></div>
        <div class="t">JACKPOT</div>
        <div class="phSlot" aria-hidden="true"></div>
      </div>
      <div class="panelBody">
        <div class="jpWrap">
          <div class="jpSymbol" id="jpSymbol"></div>
          <div class="jpImg" id="jpImg" data-has="0"></div>
          <div class="jpTitle" id="jpTitle">‚Äî</div>

          <div class="jpMeta" aria-label="Detail">
            <div class="metaRow"><div class="metaK">USER ID</div><div class="metaV" id="jpUser">‚Äî</div></div>
            <div class="metaRow"><div class="metaK">KODE</div><div class="metaV" id="jpCode">‚Äî</div></div>
            <div class="metaRow"><div class="metaK">WAKTU</div><div class="metaV" id="jpTime">‚Äî</div></div>
          </div>

          <div class="panelActions" style="margin-top:2px;">
            <button class="aBtn primary" id="jpClaim" type="button">CLAIM</button>
            <button class="aBtn" id="jpShare" type="button">BAGIKAN</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>
  
  <script>
  (() => {
  "use strict";

  // =========================
  // CONFIG (EDIT DI SINI)
  // =========================
  const CONFIG = {
    /* ‚úÖ default TIDAK memaksa jackpot tiap spin.
       Jackpot tetap bisa muncul via winRate/smartLuck, tapi simbol jackpot terkunci ke CROWN. */
    autoJackpot: true,
    longSpin: true,

    oneTime: {
      enabled: true,
      storageKey: "neon_slot_one_time_v1",
      lockButtonText: "KESEMPATAN ANDA SUDAH HABIS",
      lockAfterSpin: true
    },

    code: {
      storageKey: "neon_slot_code_v1",
      uppercase: true,
      maxLen: 32
    },

    // ‚úÖ "smart win rate" (dipakai jika autoJackpot = false)
    winRate: {
      jackpot: 0.99,  // 10%
      bonus: 0.25     // 25%
    },

    // ‚úÖ "anti-streak" biar terasa lebih smart (aktif kalau autoJackpot=false)
    smartLuck: {
      enabled: true,
      storageKey: "neon_slot_luck_v1",
      // tiap kalah, peluang naik sedikit (dibatasi)
      addJackpotPerLoss: 0.100, // +0.4% per loss
      addBonusPerLoss: 0.010,   // +1% per loss
      capExtraJackpot: 0.06,    // max +6%
      capExtraBonus: 0.12       // max +12%
    },

    /* ‚úÖ AUTO LOCK JACKPOT: simbol jackpot selalu CROWN
       - enabled: aktif
       - symbolKey: "crown"
       - forceEverySpin: false (kalau true => jackpot terus tiap spin) */
    jackpotLock: {
      enabled: true,
      symbolKey: "crown",
      forceEverySpin: true
    },

    confetti: {
      enabled: true,
      jackpot: "strong",
      bonus: "soft",
      strongParticles: 560,
      softParticles: 320,
      strongDurationMs: 1650,
      softDurationMs: 980
    },

    share: {
      intro: "Putar Slot Mechanic keberutunganmu di MADETOTO2 üëá",
      gameUrl: "https://madetoto2.info/",
      titleLine: "üé∞ SLOT MECHANIC MADETOTO2",
      tz: "Asia/Phnom_Penh"
    },

    claim: {
      url: "https://madetoto2.info/",
      openInNewTab: true,
      appendQueryIfNoTpl: true
    },

    prizes: [
      { name: "Prize Utama 1", img: "" },
      { name: "Prize Utama 2", img: "" },
      { name: "Prize Utama 3", img: "" },
      { name: "Prize Utama 4", img: "" }
    ],

    // ‚úÖ SYMBOL PNG CONFIG (ISI URL PNG DI SINI)
    symbols: [
      { key:"gem",     name:"GEM",     png:"", emoji:"üíé", meaning:"Free Saldo IDR 100.000", prizeIndex:-1 },
      { key:"star",    name:"STAR",    png:"", emoji:"‚≠ê", meaning:"",                       prizeIndex:0  },
      { key:"crown",   name:"CROWN",   png:"", emoji:"üëë", meaning:"Free Saldo IDR 200.000", prizeIndex:-1 },
      { key:"cherry",  name:"CHERRY",  png:"", emoji:"üçí", meaning:"",                       prizeIndex:1  },
      { key:"heart",   name:"HEART",   png:"", emoji:"üíñ", meaning:"Free Saldo IDR 300.000", prizeIndex:-1 },
      { key:"clover",  name:"CLOVER",  png:"", emoji:"üçÄ", meaning:"",                       prizeIndex:2  },
      { key:"diamond", name:"DIAMOND", png:"", emoji:"üî∑", meaning:"Free Saldo IDR 400.000", prizeIndex:-1 },
      { key:"coin",    name:"COIN",    png:"", emoji:"ü™ô", meaning:"",                       prizeIndex:3  }
    ],

    sound: {
      backsoundUrl: "",
      clickUrl: "",
      spinUrl: "",
      spinStopUrl: "",
      winUrl: "",
      volume: {
        backsound: 0.35,
        click: 0.65,
        spin: 0.55,
        stop: 0.65,
        win: 0.75
      },
      fadeMs: { in: 420, out: 260 }
    },

    speedBase: { normal: 3200, reduce: 2500 },
    speedJitter: 240,

    /* ‚úÖ lebih lama + dramatis */
    stopAutoStartDelayMs: { normal: [2350, 2950], reduce: [1850, 2350] },
    stopGapMs:            { normal: [640, 820],  reduce: [540, 720]  },
    stopMinTotalMs:       { normal: [4400, 5200], reduce: [3400, 4200] },

    stopMinSteps:         { normal: 7, reduce: 6 },
    stopRampSec:          0.26,
    stopSpeedFactor:      0.52,

    snapDur: { normal: 0.30, fast: 0.22, reduce: 0.18 },

    flashMs: { normal: 4000, reduce: 1200 },

    jackpotModalDelayMs: { normal: 900, reduce: 560 }
  };

  // -------------------- tiny utils --------------------
  const $  = (q, p=document) => p.querySelector(q);
  const $$ = (q, p=document) => Array.from(p.querySelectorAll(q));
  const on = (el, ev, fn, opt) => { try{ el?.addEventListener?.(ev, fn, opt); }catch{} };

  function clamp(n,a,b){ n = Number(n)||0; return Math.max(a, Math.min(b, n)); }
  function clamp01(x){ return Math.max(0, Math.min(1, Number(x)||0)); }
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function randInRange(pair){ return randInt(pair[0], pair[1]); }
  function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

  // =========================
  // DOM
  // =========================
  const els = {
    slotCard: $("#slotCard"),
    reelsWrap: $("#reels"),
    reels: $$(".reel"),

    inpCode: $("#inpCode"),
    fieldCode: $("#fieldCode"),
    btnSpin: $("#btnSpin"),

    prizeIcon: $("#prizeIcon"),
    prizeTitle: $("#prizeTitle"),
    prizeSub: $("#prizeSub"),
    btnClaim: $("#btnClaim"),
    btnShare: $("#btnShare"),

    symbolLegend: $("#symbolLegend"),

    btnPrizeDetail: $("#btnPrizeDetail"),
    modalPrize: $("#modalPrize"),
    btnPrizeClose: $("#btnPrizeClose"),
    prizeList: $("#prizeList"),

    modalSymbol: $("#modalSymbol"),
    btnSymbolClose: $("#btnSymbolClose"),
    symPopIcon: $("#symPopIcon"),
    symPopName: $("#symPopName"),
    symPopDesc: $("#symPopDesc"),
    symPopImg: $("#symPopImg"),

    modalLogin: $("#modalLogin"),
    inpUser: $("#inpUser"),
    btnLogin: $("#btnLogin"),
    fieldUser: $("#fieldUser"),

    modalJackpot: $("#modalJackpot"),
    jpSymbol: $("#jpSymbol"),
    jpImg: $("#jpImg"),
    jpTitle: $("#jpTitle"),
    jpUser: $("#jpUser"),
    jpCode: $("#jpCode"),
    jpTime: $("#jpTime"),
    jpClaim: $("#jpClaim"),
    jpShare: $("#jpShare"),
  };

  // Hard guard biar gak error kalau HTML belum lengkap
  if(!els.reelsWrap || !els.reels?.length || !els.btnSpin){
    console.warn("[NeonSlot] DOM belum lengkap: #reels/.reel/#btnSpin wajib ada.");
    return;
  }

  const prefersReduce = (() => {
    try { return matchMedia("(prefers-reduced-motion: reduce)")?.matches; }
    catch { return false; }
  })();

  // ===== PERF TIER (low/mid/high) =====
  const PERF = (() => {
    let mem = 0, cores = 0;
    try{ mem = Number(navigator.deviceMemory || 0) || 0; }catch{}
    try{ cores = Number(navigator.hardwareConcurrency || 0) || 0; }catch{}
    const low = (mem && mem <= 2) || (cores && cores <= 4);
    const mid = !low && ((mem && mem <= 4) || (cores && cores <= 6));
    const tier = low ? "low" : mid ? "mid" : "high";
    try{ document.documentElement.dataset.perf = tier; }catch{}
    return { mem, cores, tier };
  })();

  const STATE_KEY    = "neon_slot_prize_state_v9";
  const USER_KEY     = "neon_slot_user_v1";

  const ONE_TIME_KEY = String(CONFIG.oneTime?.storageKey || "neon_slot_one_time_v1");
  const CODE_KEY     = String(CONFIG.code?.storageKey || "neon_slot_code_v1");

  // ‚úÖ AUTO SETTINGS (tanpa menu)
  const settings = {
    sound: true,
    reduce: prefersReduce,
    vibe: true
  };

  const state = { lastPrize: null, lastMeta: null };
  const user  = { id:"" };
  let currentSpinMeta = null;

  const oneTime = { used:false, userId:"", code:"", timeISO:"", prize:null };

  // =========================
  // SYMBOLS (PNG / EMOJI)
  // =========================
  const BLANK_IMG = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";

  const SYMBOLS = (Array.isArray(CONFIG.symbols) ? CONFIG.symbols : []).map((s, i) => ({
    key: String(s?.key || `sym${i}`).trim().toLowerCase(),
    name: String(s?.name || `SYM ${i+1}`).trim().toUpperCase(),
    png:  String(s?.png || "").trim(),
    emoji:String(s?.emoji || "‚ùî"),
    meaning:String(s?.meaning || ""),
    prizeIndex: Number.isFinite(Number(s?.prizeIndex)) ? Number(s?.prizeIndex) : -1
  })).filter(s => s.key);

  function escapeHTML(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function safeUrl(url){
    const raw = String(url || "").trim();
    if(!raw) return "";
    try{
      const u = new URL(raw, location.href);
      const p = u.protocol.toLowerCase();
      if(p === "http:" || p === "https:" || p === "data:" || p === "blob:") return u.href;
      return "";
    }catch{
      // relative path (tanpa protocol) masih boleh
      if(raw.startsWith("/") || raw.startsWith("./") || raw.startsWith("../")) return raw;
      if(raw.startsWith("//")) return "https:" + raw;
      return raw; // terakhir: biarkan, tapi tidak ada skema berbahaya karena URL() gagal
    }
  }

  function getSym(i){
    const idx = Math.max(0, Math.min(SYMBOLS.length-1, Number(i)||0));
    return SYMBOLS[idx];
  }

  // ‚úÖ render icon tanpa innerHTML (lebih stabil + anti glitch)
  function renderIconInto(hostEl, symIndex){
    if(!hostEl) return;
    const s = getSym(symIndex);
    const url = safeUrl(s.png);

    let img = hostEl._symImg;
    let emo = hostEl._symEmo;

    if(!img){
      hostEl.textContent = "";
      img = document.createElement("img");
      img.className = "symImg";
      img.alt = "";
      img.decoding = "async";
      img.loading = "eager";
      img.draggable = false;
      img.src = BLANK_IMG;

      emo = document.createElement("span");
      emo.className = "symEmoji";
      emo.setAttribute("aria-hidden","true");

      hostEl.appendChild(img);
      hostEl.appendChild(emo);

      hostEl._symImg = img;
      hostEl._symEmo = emo;
    }

    // default: sembunyikan keduanya dulu -> anti ‚Äútumpuk 1 frame‚Äù
    img.style.display = "none";
    emo.style.display = "none";

    if(url){
      if(img.src !== url) img.src = url;
      img.style.display = "block";
      emo.textContent = "";
    }else{
      img.src = BLANK_IMG;
      emo.textContent = s.emoji || "‚ùî";
      emo.style.display = "block";
    }
  }

  function preloadImages(){
    const urls = new Set();
    for(const s of SYMBOLS){ if(s.png) urls.add(String(s.png).trim()); }
    for(const p of (Array.isArray(CONFIG.prizes)?CONFIG.prizes:[])){ if(p?.img) urls.add(String(p.img).trim()); }

    const list = Array.from(urls).map(safeUrl).filter(Boolean).slice(0, 18);
    if(!list.length) return;

    const run = () => {
      for(const u of list){
        try{ const img = new Image(); img.decoding = "async"; img.src = u; }catch{}
      }
    };

    // idle preload biar gak ganggu FPS
    try{
      if("requestIdleCallback" in window) window.requestIdleCallback(run, { timeout: 700 });
      else setTimeout(run, 60);
    }catch{ setTimeout(run, 60); }
  }

  function applyReduceClass(){
    try{ document.documentElement.classList.toggle("rm", !!settings.reduce); }catch{}
  }

  try{
    const mq = matchMedia("(prefers-reduced-motion: reduce)");
    mq?.addEventListener?.("change", (e) => {
      settings.reduce = !!e.matches;
      applyReduceClass();
    });
  }catch{}

  // ‚úÖ helper: class untuk mode spinning (hapus overlay aneh + stabilkan visual)
  function setSpinningClass(on){
    try{
      document.documentElement.classList.toggle("spinning", !!on);
      els.reelsWrap?.classList.toggle("spinning", !!on);
    }catch{}
  }

  // -------------------- storage --------------------
  function loadState(){
    try{
      const raw = localStorage.getItem(STATE_KEY);
      if(!raw) return;
      const o = JSON.parse(raw);
      if(o?.lastPrize && typeof o.lastPrize === "object") state.lastPrize = o.lastPrize;
      if(o?.lastMeta && typeof o.lastMeta === "object") state.lastMeta = o.lastMeta;
    }catch{}
  }
  function saveState(){ try{ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }catch{} }

  function loadUser(){
    try{
      const raw = localStorage.getItem(USER_KEY);
      if(!raw) return;
      const o = JSON.parse(raw);
      const id = String(o?.id || "").trim();
      if(id) user.id = id;
    }catch{}
  }
  function saveUser(){ try{ localStorage.setItem(USER_KEY, JSON.stringify({ id: user.id })); }catch{} }

  function loadOneTime(){
    try{
      const raw = localStorage.getItem(ONE_TIME_KEY);
      if(!raw) return;
      const o = JSON.parse(raw);
      oneTime.used = !!o?.used;
      oneTime.userId = String(o?.userId || "").trim();
      oneTime.code = String(o?.code || "").trim();
      oneTime.timeISO = String(o?.timeISO || "").trim();
      oneTime.prize = (o?.prize && typeof o.prize === "object") ? o.prize : null;
    }catch{}
  }
  function saveOneTime(){
    try{
      localStorage.setItem(ONE_TIME_KEY, JSON.stringify({
        used: !!oneTime.used,
        userId: oneTime.userId || "",
        code: oneTime.code || "",
        timeISO: oneTime.timeISO || "",
        prize: oneTime.prize || null
      }));
    }catch{}
  }

  function loadCode(){
    try{
      const raw = localStorage.getItem(CODE_KEY);
      if(!raw) return "";
      return String(raw || "").trim();
    }catch{ return ""; }
  }
  function saveCode(val){
    try{ localStorage.setItem(CODE_KEY, String(val || "").trim()); }catch{}
  }

  // -------------------- UI helpers --------------------
  function clearFieldErr(){ els.fieldCode?.classList.remove("err"); }
  function clearUserErr(){ els.fieldUser?.classList.remove("err"); }

  function prizeName(i){
    const nm = (CONFIG.prizes?.[i]?.name || `Prize Utama ${i+1}`).toString().trim();
    return nm || `Prize Utama ${i+1}`;
  }

  function symbolMeaning(symIndex){
    const s = getSym(symIndex);
    if(Number.isFinite(s.prizeIndex) && s.prizeIndex >= 0){
      return `PRIZE UTAMA ${s.prizeIndex + 1} ‚Äî ${prizeName(s.prizeIndex)}`;
    }
    return String(s.meaning || "").trim();
  }

  function mapPrizeIndexFromSymbol(symIndex){
    const s = getSym(symIndex);
    const pi = Number(s.prizeIndex);
    return Number.isFinite(pi) ? pi : -1;
  }

  function normalizeCode(input){
    let v = String(input || "").trim();
    if(CONFIG.code?.uppercase) v = v.toUpperCase();
    const maxLen = Math.max(8, Math.min(64, Number(CONFIG.code?.maxLen || 32)));
    if(v.length > maxLen) v = v.slice(0, maxLen);
    return v;
  }

  function applyOneTimeUI(){
    const onLock = !!(CONFIG.oneTime?.enabled && oneTime.used);
    const btnTxt = String(CONFIG.oneTime?.lockButtonText || "SUDAH DIGUNAKAN");

    if(els.inpCode){
      els.inpCode.disabled = onLock;
      if(onLock && oneTime.code) els.inpCode.value = oneTime.code;
    }
    if(els.btnSpin){
      els.btnSpin.disabled = onLock;
      if(onLock) els.btnSpin.textContent = btnTxt;
      else if(!machine.spinning) els.btnSpin.textContent = "SPIN";
    }
  }

  function markOneTimeUsed(meta, prize){
    if(!CONFIG.oneTime?.enabled) return;
    if(oneTime.used) return;

    oneTime.used = true;
    oneTime.userId = String(meta?.userId || user.id || "").trim();
    oneTime.code = String(meta?.code || (els.inpCode?.value || "")).trim();
    oneTime.timeISO = String(meta?.timeISO || new Date().toISOString());
    oneTime.prize = prize || null;

    if(oneTime.userId && !String(user.id||"").trim()){
      user.id = oneTime.userId;
      saveUser();
    }
    if(oneTime.code) saveCode(oneTime.code);

    saveOneTime();
    applyOneTimeUI();
  }

  // -------------------- confetti --------------------
  const ConfettiFX = (() => {
    let inst = null;
    let canvas = null;
    let lastBurstAt = 0;
    let hideTO = 0;

    function supportsWorker(){
      try{ return !!window.Worker && !!window.OffscreenCanvas; }
      catch{ return false; }
    }

    function ensure(){
      const base = (typeof window.confetti === "function") ? window.confetti : null;
      if(!base) return null;
      if(inst) return inst;

      try{
        canvas = document.createElement("canvas");
        canvas.setAttribute("aria-hidden","true");
        canvas.style.position = "fixed";
        canvas.style.inset = "0";
        canvas.style.width = "100vw";
        canvas.style.height = "100vh";
        canvas.style.pointerEvents = "none";
        canvas.style.zIndex = "9999";
        canvas.style.transform = "translateZ(0)";
        canvas.style.contain = "strict";
        canvas.style.opacity = "0";
        canvas.style.transition = "opacity 180ms ease";
        document.body.appendChild(canvas);

        inst = base.create(canvas, { resize:true, useWorker: supportsWorker() });
        return inst;
      }catch{
        inst = base;
        canvas = null;
        return inst;
      }
    }

    function show(){
      try{
        if(canvas){
          canvas.style.opacity = "1";
          clearTimeout(hideTO);
        }
      }catch{}
    }
    function scheduleHide(ms){
      try{
        if(canvas){
          clearTimeout(hideTO);
          hideTO = setTimeout(() => {
            try{ canvas.style.opacity = "0"; }catch{}
          }, Math.max(220, ms + 260));
        }
      }catch{}
    }

    function reset(){
      try{ inst?.reset?.(); }catch{}
      try{
        if(canvas){
          canvas.remove();
          canvas = null;
        }
      }catch{}
      inst = null;
    }

    function mulByTier(x){
      if(PERF.tier === "low") return x * 0.72;
      if(PERF.tier === "mid") return x * 0.86;
      return x;
    }

    function lerp(a,b,t){ return a + (b-a)*t; }

    function burst(kind="strong"){
      const fn = ensure();
      if(!fn) return;
      if(CONFIG.confetti?.enabled === false) return;

      const now0 = performance.now();
      if(now0 - lastBurstAt < 140) return;
      lastBurstAt = now0;

      const forcedSoft = (settings.reduce || prefersReduce);
      const mode = forcedSoft ? "soft" : (kind === "soft" ? "soft" : "strong");

      const c = CONFIG.confetti || {};
      const strong = mode === "strong";

      const baseTotal = strong
        ? clamp(c.strongParticles ?? 560, 220, 900)
        : clamp(c.softParticles   ?? 320, 140, 620);

      const baseDur = strong
        ? clamp(c.strongDurationMs ?? 1650, 800, 2600)
        : clamp(c.softDurationMs   ?? 980, 600, 2000);

      let total = Math.max(120, Math.round(mulByTier(baseTotal)));
      let dur   = baseDur;

      if(PERF.tier === "low") dur = Math.round(dur * 0.90);
      if(settings.reduce) { dur = Math.round(dur * 0.72); total = Math.round(total * 0.72); }

      show();
      scheduleHide(dur);

      const yBase = strong ? 0.16 : 0.18;
      const aL0 = strong ? 52 : 56;
      const aR0 = strong ? 128 : 124;

      const started = performance.now();
      let fired = 0;

      const maxPerFramePerSide = strong ? (PERF.tier === "low" ? 14 : 18) : (PERF.tier === "low" ? 10 : 14);
      const minPerFramePerSide = strong ? 6 : 4;

      const step = () => {
        const now = performance.now();
        const t = now - started;
        const p = Math.min(1, t / Math.max(1, dur));

        const remain = Math.max(0, total - fired);
        if(remain <= 0 || t >= dur){
          const pc2 = strong ? (PERF.tier === "low" ? 10 : 14) : (PERF.tier === "low" ? 8 : 10);
          const y2 = yBase + 0.03;
          const j2 = (Math.random()*8 - 4);

          fn({ particleCount: pc2, angle: aL0 + j2, spread: 60, startVelocity: 28, ticks: 240, scalar: 0.92, gravity: strong ? 1.22 : 1.14, decay: 0.905, drift: 0.55, origin: { x: 0.02, y: y2 } });
          fn({ particleCount: pc2, angle: aR0 - j2, spread: 60, startVelocity: 28, ticks: 240, scalar: 0.92, gravity: strong ? 1.22 : 1.14, decay: 0.905, drift: -0.55, origin: { x: 0.98, y: y2 } });
          return;
        }

        const framesLeft = Math.max(1, Math.round((dur - t) / 16.7));
        const perSide = Math.max(minPerFramePerSide, Math.min(maxPerFramePerSide, Math.ceil((remain / 2) / framesLeft)));

        const vel0 = strong ? 70 : 52;
        const vel  = lerp(vel0, vel0 - (strong ? 22 : 16), p);

        const spread0 = strong ? 66 : 58;
        const spread  = lerp(spread0, spread0 - (strong ? 14 : 10), p);

        const ticks0 = strong ? 420 : 360;
        const ticks  = Math.round(lerp(ticks0, ticks0 - 140, p));

        const scalar0 = strong ? 1.06 : 0.98;
        const scalar  = lerp(scalar0, scalar0 - 0.18, p);

        const grav = strong ? 1.24 : 1.16;
        const decay= strong ? 0.912 : 0.906;

        const jy = (Math.random() * 0.028 - 0.014);
        const y = Math.max(0.10, Math.min(0.26, yBase + jy));

        const ja = (Math.random() * 14 - 7);

        fn({ particleCount: perSide, angle: aL0 + ja, spread, startVelocity: vel, ticks, scalar: Math.max(0.80, scalar), gravity: grav, decay, drift: strong ? 0.85 : 0.70, origin: { x: 0.02, y } });
        fn({ particleCount: perSide, angle: aR0 - ja, spread, startVelocity: vel, ticks, scalar: Math.max(0.80, scalar), gravity: grav, decay, drift: strong ? -0.85 : -0.70, origin: { x: 0.98, y } });

        fired += perSide * 2;
        requestAnimationFrame(step);
      };

      step();
    }

    return { burst, reset };
  })();

  // -------------------- share / claim text --------------------
  function formatShareTime(iso){
    try{
      const tz = String(CONFIG.share?.tz || "Asia/Phnom_Penh");
      const d = new Date(iso);

      const dp = new Intl.DateTimeFormat("id-ID", {
        timeZone: tz,
        day: "2-digit",
        month: "short",
        year: "numeric"
      }).formatToParts(d);

      const day = dp.find(x=>x.type==="day")?.value || "??";
      const mon = dp.find(x=>x.type==="month")?.value || "???";
      const yr  = dp.find(x=>x.type==="year")?.value || "????";

      const tp = new Intl.DateTimeFormat("en-GB", {
        timeZone: tz,
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false
      }).formatToParts(d);

      const hh = tp.find(x=>x.type==="hour")?.value || "00";
      const mm = tp.find(x=>x.type==="minute")?.value || "00";
      const ss = tp.find(x=>x.type==="second")?.value || "00";

      return `${day} ${mon} ${yr}, ${hh}.${mm}.${ss}`;
    }catch{
      return iso || "‚Äî";
    }
  }
  function formatTime(iso){
    return formatShareTime(iso).replaceAll(".", ":");
  }

  function fillTpl(url, vars){
    return url.replace(/\{\{(\w+)\}\}/g, (_, k) => encodeURIComponent(String(vars[k] ?? "")));
  }

  function prizeText(p){
    if(!p || p.type === "none") return "";
    const symName = getSym(p.symIndex)?.name || "";
    const meaning = symbolMeaning(p.symIndex);
    return [symName, meaning].filter(Boolean).join(" ‚Äî ");
  }

  function sharePrizeOnly(p){
    const idx = mapPrizeIndexFromSymbol(p?.symIndex);
    if(idx >= 0) return prizeName(idx);
    const meaning = symbolMeaning(p?.symIndex);
    return String(meaning || "").replace(/^Free\s+Saldo/i, "Saldo Free").trim();
  }

  function buildShareText(meta, p){
    const link = String(CONFIG.share?.gameUrl || location.href || "").trim();
    const hadiah = sharePrizeOnly(p) || "-";
    const uid = String(meta?.userId || user.id || "").trim() || "-";
    const time = formatShareTime(meta?.timeISO || new Date().toISOString());

    return [
      String(CONFIG.share?.intro || "").trim(),
      link ? `(${link})` : "",
      "",
      String(CONFIG.share?.titleLine || "üé∞ SLOT MECHANIC").trim(),
      `Hadiah : ${hadiah}`,
      `User ID : ${uid}`,
      `Waktu : ${time}`
    ].filter(x => x !== "").join("\n");
  }

  async function copyToClipboard(text){
    const t = String(text || "");
    try{
      if(navigator.clipboard?.writeText){
        await navigator.clipboard.writeText(t);
        return true;
      }
    }catch{}
    try{
      const ta = document.createElement("textarea");
      ta.value = t;
      ta.setAttribute("readonly","");
      ta.style.position="fixed";
      ta.style.left="-9999px";
      ta.style.top="0";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      ta.setSelectionRange(0, ta.value.length);
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return !!ok;
    }catch{ return false; }
  }

  function buildClaimUrl(meta, p){
    const raw = String(CONFIG.claim?.url || "").trim();
    if(!raw) return "";
    const vars = {
      userId: meta?.userId || user.id || "",
      code: meta?.code || (els.inpCode?.value || "").trim(),
      prize: prizeText(p) || "",
      symbol: getSym(p?.symIndex)?.name || "",
      time: meta?.timeISO || new Date().toISOString()
    };

    const hasTpl = /\{\{\w+\}\}/.test(raw);
    let out = hasTpl ? fillTpl(raw, vars) : raw;

    if(!hasTpl && CONFIG.claim?.appendQueryIfNoTpl){
      try{
        const u = new URL(out, location.href);
        if(vars.userId) u.searchParams.set("userId", vars.userId);
        if(vars.code)   u.searchParams.set("code", vars.code);
        if(vars.prize)  u.searchParams.set("prize", vars.prize);
        if(vars.symbol) u.searchParams.set("symbol", vars.symbol);
        if(vars.time)   u.searchParams.set("time", vars.time);
        out = u.toString();
      }catch{}
    }
    return out;
  }

  function doClaim(meta, p){
    const url = buildClaimUrl(meta, p);
    if(!url) return;
    try{
      if(CONFIG.claim?.openInNewTab) window.open(url, "_blank", "noopener,noreferrer");
      else location.href = url;
    }catch{}
  }

  function setPrizeUI(p){
    const hasPrize = !!(p && p.type !== "none");
    if(els.btnClaim) els.btnClaim.disabled = !hasPrize;
    if(els.btnShare) els.btnShare.disabled = !hasPrize;

    if(!hasPrize){
      if(els.prizeIcon) els.prizeIcon.textContent = "";
      if(els.prizeTitle) els.prizeTitle.textContent = "‚Äî";
      if(els.prizeSub) els.prizeSub.textContent = "‚Äî";
      return;
    }

    const symName = getSym(p.symIndex)?.name || "";
    const meaning = symbolMeaning(p.symIndex);

    if(els.prizeIcon) renderIconInto(els.prizeIcon, p.symIndex);
    if(els.prizeTitle) els.prizeTitle.textContent = (p.type === "mega") ? "JACKPOT" : "HADIAH";
    if(els.prizeSub) els.prizeSub.textContent = [symName, meaning].filter(Boolean).join(" ‚Ä¢ ");
  }

  function renderSymbolLegend(){
    if(!els.symbolLegend) return;
    els.symbolLegend.innerHTML = SYMBOLS.map((s, idx) => `
      <button class="legItem" type="button" data-sym="${idx}" aria-label="Arti simbol ${escapeHTML(s.name)}">
        <div class="legIcon" data-icon="${idx}"></div>
        <div class="legName">${escapeHTML(s.name)}</div>
      </button>
    `).join("");

    $$(".legIcon", els.symbolLegend).forEach(el => {
      const i = Number(el.dataset.icon || 0);
      renderIconInto(el, i);
    });
  }

  // -------------------- audio (AUTO ON) --------------------
  const AudioMgr = (() => {
    const pool = { click: [], stop: [], win: [] };
    let bgm = null;
    let spin = null;
    let unlocked = false;
    let bgmUrl = "";
    let spinUrl = "";
    let fadeRAF = 0;

    function canUse(){ return !!settings.sound; }
    function safeUrl2(u){ return safeUrl(u); }
    function clampVol(v){ v = Number(v); return isFinite(v) ? Math.max(0, Math.min(1, v)) : 0.6; }

    function makeAudio(url, { loop=false, volume=0.6 } = {}){
      const a = new Audio();
      a.src = url;
      a.preload = "auto";
      a.loop = !!loop;
      a.volume = clampVol(volume);
      a.playsInline = true;
      a.crossOrigin = "anonymous";
      return a;
    }

    function unlock(){
      if(unlocked) return;
      unlocked = true;
      try{
        const p =
          safeUrl2(CONFIG.sound?.clickUrl) ||
          safeUrl2(CONFIG.sound?.winUrl) ||
          safeUrl2(CONFIG.sound?.spinStopUrl) ||
          safeUrl2(CONFIG.sound?.spinUrl) ||
          safeUrl2(CONFIG.sound?.backsoundUrl);
        if(!p) return;
        const t = makeAudio(p, { loop:false, volume:0.001 });
        t.play().then(() => { t.pause(); t.currentTime = 0; }).catch(()=>{});
      }catch{}
    }

    function stopFade(){
      if(fadeRAF){ cancelAnimationFrame(fadeRAF); fadeRAF = 0; }
    }

    function fadeTo(aud, target, ms){
      if(!aud) return;
      ms = Math.max(80, Math.min(1200, Number(ms || 320)));
      const from = Number(aud.volume || 0);
      const to = clampVol(target);
      if(!isFinite(from) || Math.abs(from - to) < 0.002){
        try{ aud.volume = to; }catch{}
        return;
      }
      stopFade();
      const t0 = performance.now();
      const step = () => {
        const t = performance.now();
        const p = Math.min(1, (t - t0) / ms);
        const k = 1 - Math.pow(1 - p, 3);
        const v = from + (to - from) * k;
        try{ aud.volume = clampVol(v); }catch{}
        if(p < 1) fadeRAF = requestAnimationFrame(step);
        else fadeRAF = 0;
      };
      fadeRAF = requestAnimationFrame(step);
    }

    function ensureBGM(){
      const url = safeUrl2(CONFIG.sound?.backsoundUrl);
      if(!url) { stopBGM(); return; }
      if(!bgm || bgmUrl !== url){
        bgmUrl = url;
        try{ if(bgm) bgm.pause(); }catch{}
        bgm = makeAudio(url, { loop:true, volume: 0.001 });
      }
    }

    function ensureSpin(){
      const url = safeUrl2(CONFIG.sound?.spinUrl);
      if(!url) { stopSpin(); return; }
      if(!spin || spinUrl !== url){
        spinUrl = url;
        try{ if(spin) spin.pause(); }catch{}
        spin = makeAudio(url, { loop:true, volume: clampVol(CONFIG.sound?.volume?.spin ?? 0.55) });
      }
    }

    function playOnce(kind){
      if(!canUse()) return false;
      const url =
        kind === "click" ? safeUrl2(CONFIG.sound?.clickUrl) :
        kind === "stop"  ? safeUrl2(CONFIG.sound?.spinStopUrl) :
        kind === "win"   ? safeUrl2(CONFIG.sound?.winUrl) : "";
      if(!url) return false;

      const vol =
        kind === "click" ? clampVol(CONFIG.sound?.volume?.click ?? 0.65) :
        kind === "stop"  ? clampVol(CONFIG.sound?.volume?.stop ?? 0.65) :
        kind === "win"   ? clampVol(CONFIG.sound?.volume?.win ?? 0.75) : 0.6;

      const arr = pool[kind] || (pool[kind] = []);
      let a = arr.find(x => x.paused || x.ended);
      if(!a){
        a = makeAudio(url, { loop:false, volume: vol });
        arr.push(a);
        const maxPool = (PERF.tier === "low") ? 2 : 3;
        if(arr.length > maxPool) arr.shift();
      }else{
        a.volume = vol;
        if(a.src !== url) a.src = url;
      }

      try{
        a.currentTime = 0;
        a.play().catch(()=>{});
        return true;
      }catch{ return false; }
    }

    function startBGM(){
      ensureBGM();
      if(!bgm || !canUse()) return;
      try{
        const target = clampVol(CONFIG.sound?.volume?.backsound ?? 0.35);
        bgm.play().then(() => {
          fadeTo(bgm, target, CONFIG.sound?.fadeMs?.in ?? 420);
        }).catch(()=>{});
      }catch{}
    }
    function stopBGM(){
      if(!bgm) return;
      try{
        const ms = CONFIG.sound?.fadeMs?.out ?? 260;
        fadeTo(bgm, 0.001, ms);
        setTimeout(() => {
          try{ bgm.pause(); bgm.currentTime = 0; }catch{}
        }, ms + 30);
      }catch{
        try{ bgm.pause(); bgm.currentTime = 0; }catch{}
      }
    }

    function startSpin(){
      ensureSpin();
      if(!spin || !canUse()) return;
      try{ spin.volume = clampVol(CONFIG.sound?.volume?.spin ?? 0.55); }catch{}
      try{ spin.currentTime = 0; spin.play().catch(()=>{}); }catch{}
    }
    function stopSpin(){
      try{ if(spin){ spin.pause(); spin.currentTime = 0; } }catch{}
    }

    return {
      unlock,
      click(){ return playOnce("click"); },
      stop(){ return playOnce("stop"); },
      win(){ return playOnce("win"); },
      startBGM, stopBGM,
      startSpin, stopSpin
    };
  })();

  // fallback beep
  let audioCtx = null;
  function ensureAudioFallback(){
    try{
      audioCtx ||= new (window.AudioContext || window.webkitAudioContext)();
      if(audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
    }catch{}
  }
  function beep(freq=520, dur=0.045, vol=0.06){
    if(!settings.sound) return;
    try{
      ensureAudioFallback();
      if(!audioCtx) return;
      const t0 = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "triangle";
      o.frequency.setValueAtTime(freq, t0);
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(vol, t0 + 0.006);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
      o.connect(g).connect(audioCtx.destination);
      o.start(t0);
      o.stop(t0 + dur + 0.02);
    }catch{}
  }

  function vibrate(ms){
    if(!settings.vibe) return;
    try{ if(navigator.vibrate) navigator.vibrate(ms); }catch{}
  }

  function clickFX(){
    AudioMgr.unlock();
    const ok = AudioMgr.click();
    if(!ok) beep(620, 0.04, 0.05);
  }
  function stopFX(){
    const ok = AudioMgr.stop();
    if(!ok) beep(520, 0.035, 0.045);
  }
  function winFX(){
    const ok = AudioMgr.win();
    if(!ok) beep(760, 0.06, 0.075);
  }

  // -------------------- flash controller --------------------
  let flashTO = 0;
  function flash3sDown(){
    clearTimeout(flashTO);
    els.slotCard?.classList.add("flash");
    els.reelsWrap?.classList.add("flash");

    const ms = settings.reduce ? CONFIG.flashMs.reduce : CONFIG.flashMs.normal;
    flashTO = setTimeout(() => {
      els.slotCard?.classList.remove("flash");
      els.reelsWrap?.classList.remove("flash");
    }, ms);

    return ms;
  }

  // -------------------- prize detail render --------------------
  function renderPrizeList(){
    if(!els.prizeList) return;
    const items = Array.isArray(CONFIG.prizes) ? CONFIG.prizes.slice(0,4) : [];
    els.prizeList.innerHTML = items.map((p, i) => {
      const name = (p?.name || `Prize ${i+1}`).toString();
      const img = safeUrl(p?.img || "");
      const has = img ? "1" : "0";
      const safe = img ? img.replace(/'/g, "%27") : "";
      const bg = img ? `style="background-image:url('${safe}')"` : "";
      return `
        <div class="pItem">
          <div class="pImg" data-has="${has}" ${bg}></div>
          <div class="pTxt">
            <div class="pName">${escapeHTML(name)}</div>
          </div>
        </div>
      `;
    }).join("");
  }

  // -------------------- modals --------------------
  function lockScroll(onLock){
    const v = onLock ? "hidden" : "";
    document.documentElement.style.overflow = v;
    document.body.style.overflow = v;
    document.body.style.touchAction = onLock ? "none" : "";
  }

  function openPrizeModal(){
    renderPrizeList();
    els.modalPrize?.classList.add("on");
    lockScroll(true);
    try{ els.btnPrizeClose?.focus({ preventScroll:true }); }catch{}
  }
  function closePrizeModal(){
    els.modalPrize?.classList.remove("on");
    lockScroll(false);
    try{ els.btnPrizeDetail?.focus({ preventScroll:true }); }catch{}
  }

  function openLoginModal(){
    els.modalLogin?.classList.add("on");
    lockScroll(true);
    setTimeout(() => { try{ els.inpUser?.focus({ preventScroll:true }); }catch{} }, 0);
  }
  function closeLoginModal(){
    els.modalLogin?.classList.remove("on");
    lockScroll(false);
  }

  function openJackpotModal(payload){
    if(els.jpSymbol) renderIconInto(els.jpSymbol, payload.symIndex);

    const img = safeUrl(payload.imgUrl || "");
    if(els.jpImg){
      if(img){
        els.jpImg.dataset.has = "1";
        els.jpImg.style.backgroundImage = `url('${img.replace(/'/g, "%27")}')`;
      }else{
        els.jpImg.dataset.has = "0";
        els.jpImg.style.backgroundImage = "";
      }
    }

    if(els.jpTitle) els.jpTitle.textContent = payload.title || "JACKPOT";
    if(els.jpUser)  els.jpUser.textContent  = payload.userId || "‚Äî";
    if(els.jpCode)  els.jpCode.textContent  = payload.code || "‚Äî";
    if(els.jpTime)  els.jpTime.textContent  = formatTime(payload.timeISO || "");

    els.modalJackpot?.classList.add("on");
    lockScroll(true);
  }
  function closeJackpotModal(){
    els.modalJackpot?.classList.remove("on");
    lockScroll(false);
  }

  let lastSymbolFocus = null;
  function openSymbolModal(symIndex, sourceEl){
    lastSymbolFocus = sourceEl || null;

    const idx = Math.max(0, Math.min(SYMBOLS.length-1, Number(symIndex)||0));
    const sym = getSym(idx);
    const meaning = symbolMeaning(idx) || "‚Äî";

    if(els.symPopIcon) renderIconInto(els.symPopIcon, idx);
    if(els.symPopName) els.symPopName.textContent = sym?.name || "‚Äî";
    if(els.symPopDesc) els.symPopDesc.textContent = meaning;

    const prizeIdx = mapPrizeIndexFromSymbol(idx);
    const img = (prizeIdx >= 0) ? safeUrl(CONFIG.prizes?.[prizeIdx]?.img || "") : "";
    if(els.symPopImg){
      if(img){
        els.symPopImg.dataset.has = "1";
        els.symPopImg.style.backgroundImage = `url('${img.replace(/'/g, "%27")}')`;
      }else{
        els.symPopImg.dataset.has = "0";
        els.symPopImg.style.backgroundImage = "";
      }
    }

    els.modalSymbol?.classList.add("on");
    lockScroll(true);
    try{ els.btnSymbolClose?.focus({ preventScroll:true }); }catch{}
  }
  function closeSymbolModal(){
    els.modalSymbol?.classList.remove("on");
    lockScroll(false);
    try{ if(lastSymbolFocus) lastSymbolFocus.focus({ preventScroll:true }); }catch{}
    lastSymbolFocus = null;
  }

  function trapFocus(modalEl, e){
    if(!modalEl) return;
    const focusables = Array.from(modalEl.querySelectorAll('button, input, [tabindex]:not([tabindex="-1"])'))
      .filter(el => !el.hasAttribute("disabled") && el.getAttribute("aria-hidden") !== "true");
    if(!focusables.length) return;
    const first = focusables[0];
    const last  = focusables[focusables.length - 1];
    if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
    else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
  }

  // -------------------- inputs requirement --------------------
  function requireLogin(){
    const id = String(user.id || "").trim();
    if(id) return true;
    openLoginModal();
    vibrate(14);
    return false;
  }

  function requireInputs(){
    if(!requireLogin()) return false;

    if(CONFIG.oneTime?.enabled && oneTime.used){
      applyOneTimeUI();
      vibrate(14);
      return false;
    }

    const c = normalizeCode(els.inpCode?.value || "");
    clearFieldErr();

    if(!c){
      els.fieldCode?.classList.add("err");
      vibrate(14);
      return false;
    }

    if(els.inpCode) els.inpCode.value = c;
    return true;
  }

  // -------------------- SMART LUCK (anti-streak) --------------------
  const Luck = (() => {
    const onLuck = !!CONFIG.smartLuck?.enabled;
    const key = String(CONFIG.smartLuck?.storageKey || "neon_slot_luck_v1");
    let loss = 0;

    function load(){
      if(!onLuck) return;
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return;
        const o = JSON.parse(raw);
        loss = Math.max(0, Math.min(999, Number(o?.loss || 0) || 0));
      }catch{}
    }
    function save(){
      if(!onLuck) return;
      try{ localStorage.setItem(key, JSON.stringify({ loss })); }catch{}
    }
    function onWin(){ loss = 0; save(); }
    function onLose(){ loss = Math.max(0, Math.min(999, loss + 1)); save(); }

    function extraJackpot(){
      if(!onLuck) return 0;
      const add = (Number(CONFIG.smartLuck?.addJackpotPerLoss)||0) * loss;
      const cap = Number(CONFIG.smartLuck?.capExtraJackpot)||0;
      return Math.max(0, Math.min(cap, add));
    }
    function extraBonus(){
      if(!onLuck) return 0;
      const add = (Number(CONFIG.smartLuck?.addBonusPerLoss)||0) * loss;
      const cap = Number(CONFIG.smartLuck?.capExtraBonus)||0;
      return Math.max(0, Math.min(cap, add));
    }

    return { load, onWin, onLose, extraJackpot, extraBonus, get loss(){ return loss; } };
  })();

  // -------------------- engine --------------------
  const machine = {
    spinning:false,
    fastStop:false,
    stopAt:0,
    raf:0,
    lastT:0,
    cellPx: 84,
    reels: [],
    stopTimes: [0,0,0],
  };

  const DynPerf = { fps: 60, speedScale: 1 };
  let inputLockUntil = 0;
  function canInput(){ return performance.now() >= inputLockUntil; }

  /* ‚úÖ brake curve: tahan dulu, lalu brake makin kuat (dramatis) */
  function brakeCurve(k){
    const p = settings.reduce ? 1.35 : 1.90;
    return Math.pow(clamp01(k), p);
  }

  // ‚úÖ ukur cell: prioritas offsetHeight (integer) biar match layout pixel => anti ‚Äútimpa‚Äù
  function measureCellPx(){
    const probe = els.reels[0]?.querySelector(".symbol");
    if(!probe) return 84;
    const oh = Number(probe.offsetHeight || 0);
    if(oh && oh >= 40) return oh;
    const h = Math.round(probe.getBoundingClientRect().height);
    return Math.max(50, h || 84);
  }

  function setCellSymbol(cellEl, symIndex){
    if(!cellEl) return;
    const idx = Math.max(0, Math.min(SYMBOLS.length-1, Number(symIndex)||0));
    if(cellEl._sym === idx) return; // ‚úÖ hemat DOM write
    cellEl._sym = idx;

    const s = getSym(idx);
    cellEl.dataset.sym = String(idx);
    cellEl.setAttribute("aria-label", s.name);

    const img = cellEl._img;
    const emo = cellEl._emo;
    const url = safeUrl(s.png);

    // ‚úÖ anti tumpuk: reset keduanya dulu
    img.style.display = "none";
    emo.style.display = "none";

    if(url){
      if(img.src !== url) img.src = url;
      img.style.display = "block";
      emo.textContent = "";
    }else{
      if(img.src !== BLANK_IMG) img.src = BLANK_IMG;
      emo.textContent = s.emoji || "‚ùî";
      emo.style.display = "block";
    }
  }

  /* ‚úÖ set posisi tampak (top/mid/bot) supaya efek silinder kena ke emoji juga */
  function setVisibleClasses(reelObj){
    for(const c of reelObj.cells){
      c.classList.remove("posTop","posMid","posBot","isMid");
    }
    const top = reelObj.cells[1] || null;
    const mid = reelObj.cells[2] || null;
    const bot = reelObj.cells[3] || null;

    if(top) top.classList.add("posTop");
    if(mid){
      mid.classList.add("posMid","isMid");
      reelObj.midCell = mid;
    }else{
      reelObj.midCell = null;
    }
    if(bot) bot.classList.add("posBot");
  }

  function renderReel(reelObj){
    // y = -(cellPx + offset) => satu cell di atas selalu ‚Äúkeluar‚Äù
    const y = -(machine.cellPx + reelObj.offset);

    // ‚úÖ FIX: integer align => anti flicker/overlap saat spin cepat
    const yy = (y | 0); // lebih cepat dari Math.round dan tetap integer
    if(reelObj._lastY === yy) return;
    reelObj._lastY = yy;

    reelObj.strip.style.transform = `translate3d(0, ${yy}px, 0)`;
  }

  function rotateStep(reelObj, plannedNextSymIndex=null){
    const first = reelObj.cells.shift();
    reelObj.cells.push(first);
    reelObj.strip.appendChild(first);

    const last = reelObj.cells[reelObj.cells.length - 1];
    const idx = (plannedNextSymIndex == null) ? randInt(0, SYMBOLS.length-1) : plannedNextSymIndex;
    setCellSymbol(last, idx);

    setVisibleClasses(reelObj);
  }

  function buildReels(){
    machine.reels = [];

    for(const reelEl of els.reels){
      const strip = reelEl.querySelector(".strip");
      if(!strip) continue;

      // reset strip
      strip.textContent = "";
      strip.style.willChange = "transform";
      strip.style.transform = "translate3d(0,0,0)";

      const frag = document.createDocumentFragment();
      const cells = [];

      for(let i=0;i<5;i++){
        const cell = document.createElement("div");
        cell.className = "symbol";

        const box = document.createElement("div");
        box.className = "symBox";

        const img = document.createElement("img");
        img.className = "symImg";
        img.alt = "";
        img.decoding = "async";
        img.loading = "eager";
        img.draggable = false;
        img.src = BLANK_IMG;

        const emo = document.createElement("span");
        emo.className = "symEmoji";
        emo.setAttribute("aria-hidden", "true");
        emo.textContent = "";

        box.appendChild(img);
        box.appendChild(emo);
        cell.appendChild(box);

        cell._img = img;
        cell._emo = emo;
        cell._sym = -999;

        frag.appendChild(cell);
        cells.push(cell);
      }

      strip.appendChild(frag);

      for(const c of cells) setCellSymbol(c, randInt(0, SYMBOLS.length-1));

      const reelObj = {
        el: reelEl,
        strip,
        cells,
        offset: 0,
        speed: 0,
        maxSpeed: 0,
        phase: "idle",
        rampT: 0,

        stopTime: 0,
        stopRequested: false,
        stopRampAt: 0,
        stepsLeft: 0,

        plan: null,
        snapFrom: 0,
        snapT: 0,
        snapDur: 0.20,

        midCell: null,
        _lastY: null
      };

      setVisibleClasses(reelObj);
      machine.reels.push(reelObj);
    }

    requestAnimationFrame(() => {
      machine.cellPx = measureCellPx();
      for(const r of machine.reels) renderReel(r);
    });
  }

  function getSymbolIndexByKey(key){
    const k = String(key || "").trim().toLowerCase();
    const i = SYMBOLS.findIndex(s => s.key === k);
    return i >= 0 ? i : -1;
  }

  // ‚úÖ "smart targets" (autoJackpot / winRate / smartLuck) + AUTO LOCK crown
  function pickTargets(){
    const lock = CONFIG.jackpotLock || {};
    const lockOn = !!lock.enabled;

    const locked = lockOn ? getSymbolIndexByKey(lock.symbolKey) : -1;
    const lockedSym = (locked >= 0) ? locked : randInt(0, SYMBOLS.length-1);

    const forceEvery = lockOn ? !!lock.forceEverySpin : false;

    if(!!CONFIG.autoJackpot || forceEvery){
      const s = lockOn ? lockedSym : randInt(0, SYMBOLS.length-1);
      return [0,1,2].map(() => ({
        top: randInt(0, SYMBOLS.length-1),
        mid: s,
        bot: randInt(0, SYMBOLS.length-1),
      }));
    }

    let jp = clamp(Number(CONFIG.winRate?.jackpot || 0.10), 0, 0.35);
    let bn = clamp(Number(CONFIG.winRate?.bonus   || 0.25), 0, 0.65);

    jp += Luck.extraJackpot();
    bn += Luck.extraBonus();

    jp = Math.min(0.45, jp);
    bn = Math.min(0.80, bn);

    const roll = Math.random();
    let mids;

    if(roll < jp){
      const s = lockOn ? lockedSym : randInt(0, SYMBOLS.length-1);
      mids = [s,s,s];
    }else if(roll < jp + bn){
      const s = randInt(0, SYMBOLS.length-1);
      let t = randInt(0, SYMBOLS.length-1);
      if(t === s) t = (t+1) % SYMBOLS.length;
      const pos = randInt(0,2);
      mids = [s,s,s];
      mids[pos] = t;
    }else{
      mids = [randInt(0, SYMBOLS.length-1), randInt(0, SYMBOLS.length-1), randInt(0, SYMBOLS.length-1)];
    }

    return mids.map(m => ({
      top: randInt(0, SYMBOLS.length-1),
      mid: m,
      bot: randInt(0, SYMBOLS.length-1),
    }));
  }

  function scheduleStopTimes(now){
    const d0 = settings.reduce ? CONFIG.stopAutoStartDelayMs.reduce : CONFIG.stopAutoStartDelayMs.normal;
    const g  = settings.reduce ? CONFIG.stopGapMs.reduce           : CONFIG.stopGapMs.normal;
    const minTotal = settings.reduce ? CONFIG.stopMinTotalMs.reduce : CONFIG.stopMinTotalMs.normal;

    let base = randInRange(d0);
    let gap1 = randInRange(g);
    let gap2 = randInRange(g);

    if(CONFIG.longSpin){
      base += randInt(260, 520);
      gap1 += randInt(60, 140);
      gap2 += randInt(70, 170);
    }

    const t0 = now + base;
    let tLast = t0 + gap1 + gap2;

    const minNeed = now + randInRange(minTotal);
    if(tLast < minNeed){
      const extra = (minNeed - tLast);
      gap1 += Math.round(extra * 0.45);
      gap2 += Math.round(extra * 0.55);
      tLast = t0 + gap1 + gap2;
    }

    machine.stopTimes[0] = t0;
    machine.stopTimes[1] = t0 + gap1;
    machine.stopTimes[2] = tLast;
  }

  function beginStop(reelObj, reelIndex, now){
    if(reelObj.stopRequested) return;
    reelObj.stopRequested = true;
    reelObj.stopRampAt = now;

    const baseMin = settings.reduce ? CONFIG.stopMinSteps.reduce : CONFIG.stopMinSteps.normal;
    reelObj.stepsLeft = Math.max(4, baseMin + randInt(0, 3));
  }

  function reelKick(el){
    if(settings.reduce || !el) return;
    el.classList.remove("kick");
    void el.offsetWidth;
    el.classList.add("kick");
    setTimeout(() => el.classList.remove("kick"), 260);
  }

  function speedBaseNow(){
    const base = settings.reduce ? CONFIG.speedBase.reduce : CONFIG.speedBase.normal;
    const tierMul = (PERF.tier === "low") ? 0.86 : (PERF.tier === "mid") ? 0.93 : 1.0;
    return base * tierMul * DynPerf.speedScale;
  }

  function startSpin(){
    AudioMgr.unlock();
    if(!requireInputs()) return;

    setSpinningClass(true);

    if(els.inpCode) els.inpCode.disabled = true;

    const code = normalizeCode(els.inpCode?.value || "");
    if(els.inpCode) els.inpCode.value = code;
    saveCode(code);

    currentSpinMeta = {
      userId: String(user.id || "").trim(),
      code,
      timeISO: new Date().toISOString()
    };

    machine.spinning = true;
    machine.fastStop = false;
    machine.stopAt = 0;

    els.reelsWrap?.classList.remove("stopping","flash");
    els.slotCard?.classList.remove("flash");

    if(els.btnSpin){
      els.btnSpin.textContent = "STOP";
      els.btnSpin.disabled = false;
    }

    AudioMgr.startSpin();

    for(const r of machine.reels){
      r.el.classList.remove("win","kick");
      r.el.classList.add("spinning");
    }

    const plans = pickTargets();
    const now = performance.now();
    scheduleStopTimes(now);

    for(let i=0;i<machine.reels.length;i++){
      const r = machine.reels[i];
      r.plan = plans[i];

      r.phase = "ramp";
      r.rampT = 0;

      r.maxSpeed = speedBaseNow() + i*220 + randInt(-CONFIG.speedJitter, CONFIG.speedJitter);

      r.speed = 0;
      r.offset = 0;

      r.stopTime = machine.stopTimes[i];
      r.stopRequested = false;
      r.stopRampAt = 0;
      r.stepsLeft = 0;

      r._lastY = null;
      renderReel(r);
      setVisibleClasses(r);
    }

    kickRAF();
  }

  function requestStop(){
    const now = performance.now();
    machine.fastStop = true;
    machine.stopAt = now;
    els.reelsWrap?.classList.add("stopping");

    if(els.btnSpin){
      els.btnSpin.textContent = "STOP‚Ä¶";
      els.btnSpin.disabled = true;
    }

    const brakeGap = settings.reduce ? [340, 560] : [380, 620];
    let tNext = now + randInt(240, 360);

    for(let i=0;i<machine.reels.length;i++){
      const r = machine.reels[i];
      if(r.phase === "idle") continue;
      if(r.stopRequested) continue;

      r.stopTime = tNext;
      tNext += randInRange(brakeGap);
    }

    vibrate(18);
    clickFX();
  }

  function lockAndSnap(r, reelIndex){
    r.phase = "snap";
    r.speed = 0;

    r.snapFrom = r.offset;
    r.snapT = 0;

    if(settings.reduce){
      r.snapDur = CONFIG.snapDur.reduce + reelIndex * 0.01;
    }else{
      r.snapDur = (machine.fastStop ? CONFIG.snapDur.fast : CONFIG.snapDur.normal) + reelIndex * 0.02;
    }
  }

  function finishSpin(){
    machine.spinning = false;
    machine.fastStop = false;
    machine.stopAt = 0;
    els.reelsWrap?.classList.remove("stopping");
    setSpinningClass(false);

    for(const r of machine.reels) r.el.classList.remove("spinning");

    AudioMgr.stopSpin();

    evaluateResult();

    if(CONFIG.oneTime?.enabled && CONFIG.oneTime?.lockAfterSpin !== false){
      markOneTimeUsed(state.lastMeta || currentSpinMeta, state.lastPrize);
    }else{
      if(els.inpCode) els.inpCode.disabled = false;
    }

    inputLockUntil = performance.now() + (settings.reduce ? 220 : 320);
  }

  let jackpotTO = 0;

  function getConfettiModeJackpot(){ return String((CONFIG.confetti || {}).jackpot || "strong"); }
  function getConfettiModeBonus(){ return String((CONFIG.confetti || {}).bonus || "soft"); }

  function evaluateResult(){
    // mid cell index = 2
    const mids = machine.reels.map(r => Number(r.cells[2]?.dataset.sym || 0));
    const [a,b,c] = mids;

    for(const r of machine.reels) r.el.classList.remove("win");

    const meta = currentSpinMeta || {
      userId: String(user.id || "").trim(),
      code: normalizeCode(els.inpCode?.value || ""),
      timeISO: new Date().toISOString()
    };

    state.lastMeta = meta;
    let prize = null;

    if(a === b && b === c){
      for(const r of machine.reels) r.el.classList.add("win");

      const flashMs = flash3sDown();
      vibrate(40);
      winFX();
      ConfettiFX.burst(getConfettiModeJackpot());

      prize = { type:"mega", symIndex:a };
      Luck.onWin();

      clearTimeout(jackpotTO);

      const d = settings.reduce ? CONFIG.jackpotModalDelayMs.reduce : CONFIG.jackpotModalDelayMs.normal;
      const showAfter = Math.min(flashMs, Math.max(420, d));

      jackpotTO = setTimeout(() => {
        const idx = mapPrizeIndexFromSymbol(a);
        const imgUrl = (idx >= 0) ? String(CONFIG.prizes?.[idx]?.img || "").trim() : "";
        const title = (idx >= 0) ? prizeName(idx) : (symbolMeaning(a) || "JACKPOT");

        openJackpotModal({
          symIndex: a,
          title,
          imgUrl,
          userId: meta.userId,
          code: meta.code,
          timeISO: meta.timeISO
        });
      }, showAfter);

    }else if(a === b || b === c || a === c){
      const sym = (a===b) ? a : (b===c) ? b : a;

      if(a === b){ machine.reels[0].el.classList.add("win"); machine.reels[1].el.classList.add("win"); }
      if(b === c){ machine.reels[1].el.classList.add("win"); machine.reels[2].el.classList.add("win"); }
      if(a === c){ machine.reels[0].el.classList.add("win"); machine.reels[2].el.classList.add("win"); }

      vibrate(22);
      winFX();
      ConfettiFX.burst(getConfettiModeBonus());
      prize = { type:"bonus", symIndex:sym };

      Luck.onWin();
    }else{
      vibrate(10);
      prize = { type:"none", symIndex:a };
      Luck.onLose();
    }

    state.lastPrize = prize;
    saveState();
    setPrizeUI(prize);
  }

  function tick(now){
    const t = now || performance.now();

    // dt clamp biar anti ‚Äúloncat‚Äù (terutama low-end)
    const dtRaw = (t - (machine.lastT || t)) / 1000;
    const dt = Math.min(0.028, Math.max(0, dtRaw));
    machine.lastT = t;

    const fpsNow = dt > 0 ? (1 / dt) : 60;
    DynPerf.fps = DynPerf.fps * 0.92 + fpsNow * 0.08;

    if(DynPerf.fps < 38) DynPerf.speedScale = Math.max(0.72, DynPerf.speedScale - 0.018);
    else if(DynPerf.fps < 46) DynPerf.speedScale = Math.max(0.82, DynPerf.speedScale - 0.008);
    else if(DynPerf.fps > 56) DynPerf.speedScale = Math.min(1.0, DynPerf.speedScale + 0.010);
    else DynPerf.speedScale = Math.min(1.0, DynPerf.speedScale + 0.003);

    let anyActive = false;

    let globalStopMult = 1;
    if(machine.fastStop && machine.stopAt){
      const x = (t - machine.stopAt) / (CONFIG.stopRampSec * 1000);
      const k = clamp01(x);
      const kk = brakeCurve(k);
      globalStopMult = 1 - kk * (1 - CONFIG.stopSpeedFactor);
    }

    for(let i=0;i<machine.reels.length;i++){
      const r = machine.reels[i];
      if(r.phase === "idle") continue;
      anyActive = true;

      if(r.phase === "ramp"){
        r.rampT += dt;
        const rampDurBase = settings.reduce ? 0.16 : 0.22;
        const rampDur = (PERF.tier === "low" && !settings.reduce) ? (rampDurBase + 0.04) : rampDurBase;

        const k = Math.min(1, r.rampT / rampDur);
        const kk = settings.reduce ? k : easeOutCubic(k);
        r.speed = r.maxSpeed * kk;
        if(k >= 1) r.phase = "run";
      }

      if(r.phase === "run"){
        if(!r.stopRequested && t >= r.stopTime){
          beginStop(r, i, t);
        }

        let perStopMult = 1;
        if(r.stopRampAt){
          const x = (t - r.stopRampAt) / (CONFIG.stopRampSec * 1000);
          const k = clamp01(x);
          const kk = brakeCurve(k);
          perStopMult = 1 - kk * (1 - CONFIG.stopSpeedFactor);
        }

        const desiredMax = speedBaseNow() + i*220 + randInt(-CONFIG.speedJitter, CONFIG.speedJitter);
        r.maxSpeed = r.maxSpeed * 0.965 + desiredMax * 0.035;

        r.speed = r.maxSpeed * globalStopMult * perStopMult;

        r.offset += r.speed * dt;

        // ‚úÖ jaga offset tetap dalam 0..cellPx (anti drift)
        if(r.offset >= machine.cellPx){
          // step count (biasanya 1, kadang 2)
          const steps = Math.min(3, Math.floor(r.offset / machine.cellPx));
          r.offset -= steps * machine.cellPx;

          for(let s=0; s<steps; s++){
            if(!r.stopRequested){
              rotateStep(r, null);
            }else{
              r.stepsLeft -= 1;

              let planned = null;
              if(r.stepsLeft === 3) planned = r.plan?.top ?? null;
              else if(r.stepsLeft === 2) planned = r.plan?.mid ?? null;
              else if(r.stepsLeft === 1) planned = r.plan?.bot ?? null;

              rotateStep(r, planned);

              if(r.stepsLeft <= 0){
                lockAndSnap(r, i);
                reelKick(r.el);
                break;
              }
            }
          }
        }

        renderReel(r);
      }

      if(r.phase === "snap"){
        r.snapT += dt;
        const t01 = Math.min(1, r.snapT / r.snapDur);
        const k = settings.reduce ? t01 : easeOutCubic(t01);
        r.offset = r.snapFrom * (1 - k);
        renderReel(r);

        if(t01 >= 1){
          r.offset = 0;
          renderReel(r);
          r.phase = "idle";
          stopFX();
          setVisibleClasses(r);
        }
      }
    }

    if(anyActive){
      machine.raf = requestAnimationFrame(tick);
    }else{
      machine.raf = 0;
      finishSpin();
    }
  }

  function kickRAF(){
    if(machine.raf) return;
    machine.lastT = performance.now();
    machine.raf = requestAnimationFrame(tick);
  }

  // -------------------- init --------------------
  function init(){
    loadState();
    loadUser();
    loadOneTime();
    Luck.load();

    applyReduceClass();

    if(oneTime.used){
      if(oneTime.userId && !String(user.id||"").trim()){
        user.id = oneTime.userId;
        saveUser();
      }
    }

    const savedCode = oneTime.used ? oneTime.code : loadCode();
    if(els.inpCode && savedCode) els.inpCode.value = normalizeCode(savedCode);

    buildReels();

    // ‚úÖ re-measure setelah fonts ready (lebih presisi, anti timpa)
    try{
      document.fonts?.ready?.then?.(() => {
        if(machine.spinning) return;
        machine.cellPx = measureCellPx();
        for (const r of machine.reels) { r.offset = 0; r._lastY = null; renderReel(r); setVisibleClasses(r); }
      }).catch(()=>{});
    }catch{}

    if(oneTime.used && oneTime.prize) state.lastPrize = oneTime.prize;
    setPrizeUI(state.lastPrize);

    requestAnimationFrame(() => renderSymbolLegend());
    applyOneTimeUI();

    preloadImages();

    if(!String(user.id || "").trim() && !(CONFIG.oneTime?.enabled && oneTime.used)){
      openLoginModal();
    }

    on(els.inpUser, "input", () => clearUserErr(), { passive:true });

    on(els.btnLogin, "click", () => {
      AudioMgr.unlock();
      clickFX();

      const id = String(els.inpUser?.value || "").trim();
      clearUserErr();
      if(!id){
        els.fieldUser?.classList.add("err");
        vibrate(14);
        try{ els.inpUser?.focus({ preventScroll:true }); }catch{}
        return;
      }
      user.id = id;
      saveUser();

      if(CONFIG.oneTime?.enabled && oneTime.used && !oneTime.userId){
        oneTime.userId = id;
        saveOneTime();
      }

      closeLoginModal();
      vibrate(12);
      AudioMgr.startBGM();
    });

    on(els.inpUser, "keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        els.btnLogin?.click();
      }
    });

    let codeTO = 0;
    on(els.inpCode, "input", () => {
      clearFieldErr();
      if(!els.inpCode) return;
      const v = normalizeCode(els.inpCode.value);
      if(v !== els.inpCode.value) els.inpCode.value = v;
      clearTimeout(codeTO);
      codeTO = setTimeout(() => {
        if(CONFIG.oneTime?.enabled && oneTime.used) return;
        saveCode(v);
      }, 180);
    }, { passive:true });

    on(els.btnSpin, "click", () => {
      AudioMgr.unlock();
      if(!canInput()) return;

      clickFX();
      if(machine.spinning) requestStop();
      else startSpin();
    });

    on(els.btnClaim, "click", () => {
      AudioMgr.unlock();
      clickFX();
      const p = state.lastPrize;
      if(!p || p.type === "none") return;

      const meta = state.lastMeta || currentSpinMeta || {
        userId: user.id,
        code: normalizeCode(els.inpCode?.value||""),
        timeISO: new Date().toISOString()
      };
      doClaim(meta, p);
      vibrate(18);
    });

    on(els.btnShare, "click", async () => {
      AudioMgr.unlock();
      clickFX();

      const p = state.lastPrize;
      if(!p || p.type === "none") return;

      const meta = state.lastMeta || { userId: user.id, code: normalizeCode(els.inpCode?.value||""), timeISO: new Date().toISOString() };
      const text = buildShareText(meta, p);

      try{
        if(navigator.share){
          await navigator.share({ title: "SLOT MECHANIC MADETOTO2", text });
        }else{
          await copyToClipboard(text);
        }
      }catch{
        await copyToClipboard(text);
      }
    });

    on(els.jpClaim, "click", () => {
      AudioMgr.unlock();
      clickFX();
      const p = state.lastPrize;
      if(!p || p.type === "none") return;

      const meta = state.lastMeta || currentSpinMeta || {
        userId: user.id,
        code: normalizeCode(els.inpCode?.value||""),
        timeISO: new Date().toISOString()
      };
      doClaim(meta, p);
      vibrate(18);
      closeJackpotModal();
    });

    on(els.jpShare, "click", async () => {
      AudioMgr.unlock();
      clickFX();

      const p = state.lastPrize;
      if(!p || p.type === "none") { closeJackpotModal(); return; }

      const meta = state.lastMeta || { userId: user.id, code: normalizeCode(els.inpCode?.value||""), timeISO: new Date().toISOString() };
      const text = buildShareText(meta, p);

      try{
        if(navigator.share){
          await navigator.share({ title: "SLOT MECHANIC MADETOTO2", text });
        }else{
          await copyToClipboard(text);
        }
      }catch{
        await copyToClipboard(text);
      }
      closeJackpotModal();
    });

    on(els.btnPrizeDetail, "click", () => { AudioMgr.unlock(); clickFX(); openPrizeModal(); });
    on(els.btnPrizeClose,  "click", () => { clickFX(); closePrizeModal(); });
    on(els.modalPrize,     "click", (e) => { if(e.target === els.modalPrize) closePrizeModal(); });

    on(els.btnSymbolClose, "click", () => { clickFX(); closeSymbolModal(); });
    on(els.modalSymbol,    "click", (e) => { if(e.target === els.modalSymbol) closeSymbolModal(); });

    on(els.symbolLegend, "click", (e) => {
      const btn = e.target.closest(".legItem");
      if(!btn) return;
      AudioMgr.unlock();
      clickFX();
      const idx = Number(btn.dataset.sym || 0);
      openSymbolModal(idx, btn);
    });

    on(els.modalJackpot, "click", (e) => { if(e.target === els.modalJackpot) closeJackpotModal(); });

    let pausedAt = 0;
    on(document, "visibilitychange", () => {
      if(document.hidden){
        pausedAt = performance.now();
        if(machine.raf){
          cancelAnimationFrame(machine.raf);
          machine.raf = 0;
          machine.lastT = 0;
        }
        AudioMgr.stopSpin();
        AudioMgr.stopBGM();
        ConfettiFX.reset();
        setSpinningClass(false);
        return;
      }

      if(String(user.id || "").trim()) AudioMgr.startBGM();
      if(!machine.spinning || !pausedAt) return;

      const now = performance.now();
      const delta = now - pausedAt;
      pausedAt = 0;

      for(const r of machine.reels){
        if(r.phase !== "idle") r.stopTime += delta;
        if(r.stopRampAt) r.stopRampAt += delta;
      }
      if(machine.stopAt) machine.stopAt += delta;

      AudioMgr.startSpin();
      setSpinningClass(true);
      kickRAF();
    }, { passive:true });

    on(window, "keydown", (e) => {
      if(els.modalLogin?.classList.contains("on")){
        if(e.key === "Tab"){ trapFocus(els.modalLogin, e); return; }
        return;
      }
      if(els.modalPrize?.classList.contains("on")){
        if(e.key === "Escape"){ closePrizeModal(); return; }
        if(e.key === "Tab"){ trapFocus(els.modalPrize, e); return; }
        return;
      }
      if(els.modalSymbol?.classList.contains("on")){
        if(e.key === "Escape"){ closeSymbolModal(); return; }
        if(e.key === "Tab"){ trapFocus(els.modalSymbol, e); return; }
        return;
      }
      if(els.modalJackpot?.classList.contains("on")){
        if(e.key === "Escape"){ closeJackpotModal(); return; }
        if(e.key === "Tab"){ trapFocus(els.modalJackpot, e); return; }
        return;
      }

      if(e.key === " " || e.key === "Enter"){
        if(e.key === " ") e.preventDefault();
        AudioMgr.unlock();
        if(!canInput()) return;

        clickFX();
        if(machine.spinning) requestStop();
        else startSpin();
      }
    }, { passive:false });

    // ‚úÖ iOS unlock + auto BGM when user gesture
    on(window, "pointerdown", () => {
      AudioMgr.unlock();
      if(String(user.id || "").trim()) AudioMgr.startBGM();
    }, { passive:true, once:true });

    // ‚úÖ resize: lebih stabil (throttle) + juga pantau visualViewport
    let rzTO = 0;
    const onResize = () => {
      clearTimeout(rzTO);
      rzTO = setTimeout(() => {
        if(machine.spinning) return;
        machine.cellPx = measureCellPx();
        for (const r of machine.reels) { r.offset = 0; r._lastY = null; renderReel(r); setVisibleClasses(r); }
      }, 120);
    };
    on(window, "resize", onResize, { passive:true });
    try{ on(window.visualViewport, "resize", onResize, { passive:true }); }catch{}
  }

  init();
})();
</script>
</body>
</html>