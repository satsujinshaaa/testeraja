
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="referrer" content="no-referrer" />

  <!-- NOTE: isi og:url + canonical dengan URL final halaman kamu -->
  <meta property="og:url" content="" />
  <link rel="canonical" href="" />

  <meta property="og:title" content="MADETOTO2 - Spin & Win" />
  <meta name="description" content="PUTAR RODANYA & DAPATKAN HADIAH FANTASTIS HINGGA 200 RIBU RUPIAH!" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://shortq.org/gmbrmadetoto2" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="MADETOTO2 - Spin & Win" />
  <meta name="twitter:description" content="PUTAR RODANYA &amp; DAPATKAN HADIAH FANTASTIS HINGGA 200 RIBU RUPIAH!" />
  <meta name="twitter:image" content="https://shortq.org/gmbrmadetoto2" />

  <meta name="theme-color" content="#071a12" />
  <link rel="shortcut icon" href="https://shortq.org/gmbrmadetoto2" type="image/x-icon" />

<style>
/* ======================================================================
 * MADETOTO2 — PREMIUM UI CSS (CLEAN + RESPONSIVE) — FULL REPLACE (vNEXT)
 * ✅ UI interaksi lebih responsif (tap/hover/focus rapi di semua device)
 * ✅ Hapus “lingkaran putih / bayangan blur” yang muncul di belakang wheel
 * ✅ Wheel: halo putih dimatikan + background blob putih diganti tone hijau/gold
 * ====================================================================== */

/* =========================
 * 0) RESET / BASE
 * ======================= */
*, *::before, *::after { box-sizing: border-box; }
* { margin: 0; padding: 0; }

:root{
  color-scheme: dark;

  /* Green depth soft */
  --bg0: #04110d;
  --bg1: #061c14;
  --bg2: #05271c;

  /* Gold metal */
  --gold0: #fff1d3;
  --gold1: #f3b24a;
  --gold2: #7a3f13;

  /* Accents */
  --green0: #d7ffe9;
  --green1: #3be07b;
  --green2: #128a45;

  /* Text */
  --text: rgba(255,255,255,0.94);
  --muted: rgba(255,255,255,0.72);
  --muted2: rgba(255,255,255,0.56);

  /* Surfaces */
  --card: rgba(59,224,123,0.06);
  --cardBorder: rgba(59,224,123,0.20);

  /* Radii */
  --radius-lg: 20px;
  --radius-md: 14px;

  /* Shadows */
  --shadow-soft: 0 0 56px -16px rgba(59,224,123,0.16);
  --shadow-deep: 0 26px 86px rgba(0,0,0,0.60);

  /* Focus ring */
  --ring: rgba(59,224,123,0.56);

  /* Safe areas (iOS) */
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-right: env(safe-area-inset-right, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-left: env(safe-area-inset-left, 0px);

  /* Perf */
  --gpu: translateZ(0);

  /* Layout padding */
  --page-pad: 20px;
  --page-pad-sm: 16px;

  /* Tap targets */
  --tap: 44px;
}

html{
  width: 100%;
  height: 100%;
  background: var(--bg0);
  overscroll-behavior: none;
  -webkit-text-size-adjust: 100%;
  text-rendering: optimizeLegibility;
  scrollbar-gutter: stable;
}
@supports (overflow: clip){
  html, body { overflow-x: clip; }
}
@supports not (overflow: clip){
  html, body { overflow-x: hidden; }
}

body{
  min-height: 100svh;
  color: var(--text);
  font-family:
    ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
    "SF Pro Display","SF Pro Text","Segoe UI Variable","Segoe UI",
    Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
  overscroll-behavior: none;
  position: relative;
  isolation: isolate;

  /* ✅ HAPUS blob putih yang biasa bikin “lingkaran putih” di belakang wheel
     (tone digeser ke hijau/gold yang lebih halus) */
  background:
    radial-gradient(980px 560px at 82% 14%, rgba(59,224,123,0.11), transparent 62%),
    radial-gradient(920px 620px at 18% 10%, rgba(215,255,233,0.025), transparent 64%),
    radial-gradient(860px 560px at 20% 92%, rgba(20,184,166,0.078), transparent 60%),
    radial-gradient(760px 520px at 72% 84%, rgba(243,178,74,0.038), transparent 66%),
    linear-gradient(135deg, var(--bg0) 0%, var(--bg1) 48%, var(--bg2) 100%);
}
@supports (min-height: 100dvh){
  body{ min-height: 100dvh; }
}

body.modal-open { overflow: hidden; }

img, video, canvas, svg { max-width: 100%; height: auto; display: block; }
a, button, input { -webkit-tap-highlight-color: transparent; }
button { touch-action: manipulation; }
input, button { font-family: inherit; }

::selection{
  background: rgba(59,224,123,0.18);
  color: #fff;
}

/* =========================
 * 1) BACKDROP FX (VIGNETTE + GRAIN)
 * ======================= */
body::before{
  content:"";
  position: fixed;
  inset: 0;
  pointer-events:none;
  z-index: 0;

  /* ✅ ganti highlight putih → highlight hijau lembut (anti “lingkaran putih” di area wheel) */
  background:
    radial-gradient(1200px 760px at 50% 24%, rgba(59,224,123,0.040), transparent 64%),
    radial-gradient(1400px 920px at 50% 112%, rgba(0,0,0,0.60), transparent 58%),
    radial-gradient(920px 920px at -10% 22%, rgba(0,0,0,0.52), transparent 56%),
    radial-gradient(920px 920px at 110% 22%, rgba(0,0,0,0.50), transparent 56%);

  opacity: 0.92;
  transform: var(--gpu);
}

body::after{
  content:"";
  position: fixed;
  inset: 0;
  pointer-events:none;
  z-index: 1;
  opacity: 0.045;
  mix-blend-mode: overlay;
  background:
    repeating-linear-gradient(0deg,
      rgba(255,255,255,0.10) 0px,
      rgba(255,255,255,0.10) 1px,
      rgba(0,0,0,0.00) 2px,
      rgba(0,0,0,0.00) 4px
    ),
    repeating-linear-gradient(90deg,
      rgba(255,255,255,0.08) 0px,
      rgba(255,255,255,0.08) 1px,
      rgba(0,0,0,0.00) 2px,
      rgba(0,0,0,0.00) 5px
    );
  transform: var(--gpu);
}

/* Premium FX canvas */
#fxCanvas{
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 2;
  opacity: 0.78;
  mix-blend-mode: screen;
  transform: var(--gpu);
}

/* =========================
 * 2) LAYOUT WRAP
 * ======================= */
.container{
  max-width: 1200px;
  margin: 0 auto;
  padding: var(--page-pad);
  padding-left: calc(var(--page-pad) + var(--safe-left));
  padding-right: calc(var(--page-pad) + var(--safe-right));
  padding-top: calc(var(--page-pad) + var(--safe-top));
  padding-bottom: calc(var(--page-pad) + var(--safe-bottom));
  position: relative;
  z-index: 5;
}
@media (max-width: 420px){
  .container{
    padding: var(--page-pad-sm);
    padding-left: calc(var(--page-pad-sm) + var(--safe-left));
    padding-right: calc(var(--page-pad-sm) + var(--safe-right));
    padding-top: calc(var(--page-pad-sm) + var(--safe-top));
    padding-bottom: calc(var(--page-pad-sm) + var(--safe-bottom));
  }
}

/* =========================
 * 3) HEADER — PREMIUM DETAIL + RESPONSIVE
 * ======================= */
header{
  text-align: center;
  position: relative;
  z-index: 10;

  padding:
    clamp(14px, 2.6vw, 18px)
    clamp(14px, 3vw, 18px);

  background:
    radial-gradient(900px 240px at 50% -42%, rgba(255,255,255,0.08), transparent 64%),
    radial-gradient(560px 260px at 20% 36%, rgba(59,224,123,0.14), transparent 64%),
    linear-gradient(180deg, rgba(6,28,20,0.88), rgba(4,16,12,0.72));

  border-radius: 16px;
  border: 1px solid rgba(59,224,123,0.18);

  box-shadow:
    0 16px 60px rgba(0,0,0,0.54),
    0 0 0 1px rgba(0,0,0,0.22) inset,
    0 0 40px rgba(59,224,123,0.06);

  overflow: hidden;
  isolation: isolate;

  transform: var(--gpu);

  -webkit-mask-image: -webkit-radial-gradient(white, black);
  clip-path: inset(0 round 16px);

  container-type: inline-size;
  -webkit-tap-highlight-color: transparent;
}

header::before{
  content:"";
  position:absolute;
  inset:-2px;
  pointer-events:none;
  z-index: 0;
  opacity: 0.28;
  filter: blur(1px);
  background:
    radial-gradient(560px 260px at 18% 28%, rgba(255,255,255,0.09), transparent 66%),
    radial-gradient(680px 280px at 86% 46%, rgba(59,224,123,0.16), transparent 66%),
    radial-gradient(560px 260px at 50% 140%, rgba(20,184,166,0.07), transparent 66%);
}

header::after{
  content:"";
  position:absolute;
  inset: 0;
  pointer-events:none;
  z-index: 1;
  opacity: 0.52;
  background:
    linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.00) 52%),
    radial-gradient(900px 240px at 50% -14%, rgba(255,255,255,0.07), transparent 62%);
  mix-blend-mode: overlay;
}

/* optional top badge */
.header-badge{
  position: relative;
  z-index: 2;
  display: inline-flex;
  align-items: center;
  gap: 8px;

  margin: 0 auto 10px;
  padding: 8px 12px;

  border-radius: 999px;
  border: 1px solid rgba(59,224,123,0.22);
  background:
    linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.08));
  box-shadow:
    0 12px 28px rgba(0,0,0,0.40),
    0 0 0 1px rgba(0,0,0,0.14) inset;

  color: rgba(215,255,233,0.88);
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: 0.10em;

  font-size: clamp(0.62rem, 1.25cqw, 0.78rem);
}
@supports not (font-size: 1cqw){
  .header-badge{ font-size: clamp(0.62rem, 2.1vw, 0.78rem); }
}
.header-badge::before{
  content:"";
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(59,224,123,0.95);
  box-shadow: 0 0 18px rgba(59,224,123,0.35);
}

.hero-title{
  position: relative;
  z-index: 2;

  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  align-items: baseline;
  gap: 0.42em;

  margin: 2px 0 clamp(8px, 1.4vw, 10px);

  text-transform: uppercase;
  line-height: 1.05;
  font-weight: 1000;

  font-size: clamp(1.12rem, 3.1vw, 2.30rem);
  letter-spacing: clamp(0.055em, 0.22vw, 0.10em);

  text-shadow: 0 16px 40px rgba(0,0,0,0.60);

  max-width: min(1100px, 100%);
  margin-inline: auto;
  padding-inline: 6px;
}
.hero-top{
  display: inline;
  color: rgba(215,255,233,0.90);
  white-space: nowrap;
}
.hero-brand{
  display: inline;
  white-space: nowrap;

  background: linear-gradient(180deg,
    #e7fff3 0%,
    #8bffc3 30%,
    #3be07b 62%,
    #128a45 100%);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;

  filter:
    drop-shadow(0 14px 28px rgba(59,224,123,0.12))
    drop-shadow(0 0 14px rgba(59,224,123,0.10));
}

.header-divider{
  position: relative;
  z-index: 2;
  width: min(520px, 92%);
  height: 1px;
  margin: 10px auto 12px;

  background:
    linear-gradient(90deg,
      transparent,
      rgba(59,224,123,0.28),
      rgba(255,255,255,0.10),
      rgba(59,224,123,0.28),
      transparent);
  opacity: 0.9;
}
.header-divider::after{
  content:"";
  position: absolute;
  left: 50%;
  top: 50%;
  width: 44px;
  height: 6px;
  transform: translate(-50%, -50%);
  border-radius: 999px;
  background: rgba(59,224,123,0.22);
  filter: blur(0.2px);
}

.subtitle{
  position: relative;
  z-index: 2;

  max-width: 1100px;
  margin-inline: auto;

  padding-inline: clamp(0px, 1.4cqw, 14px);

  font-weight: 850;
  text-transform: uppercase;
  line-height: 1.38;

  color: rgba(215,255,233,0.78);
  text-shadow: 0 10px 24px rgba(0,0,0,0.56);

  font-size: clamp(0.74rem, 1.55cqw, 0.94rem);
  letter-spacing: clamp(0.055em, 0.18cqw, 0.10em);

  text-wrap: balance;
}
@supports not (font-size: 1cqw){
  .subtitle{
    font-size: clamp(0.74rem, 2.0vw, 0.94rem);
    letter-spacing: clamp(0.055em, 0.28vw, 0.10em);
    padding-inline: 0;
  }
}

@media (max-width: 380px){
  .hero-top, .hero-brand{ white-space: normal; }
  .hero-title{ gap: 0.30em; }
}
@container (max-width: 360px){
  .header-divider{ margin: 8px auto 10px; }
  .subtitle{ line-height: 1.42; }
}

/* =========================
 * 4) MAIN GRID
 * ======================= */
.main-content{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: clamp(18px, 4vw, 34px);
  align-items: start;
  margin: clamp(18px, 4vw, 28px) 0 40px;
}
.main-content > *{ min-width: 0; }
@media (max-width: 900px){
  .main-content{ grid-template-columns: 1fr; gap: 26px; }
}

/* ======================================================================
 * 5) WHEEL — CASINO PREMIUM (RESPONSIVE + CLEAN)
 * ====================================================================== */

/* Local tokens */
.wheel-container{
  /* sizing */
  --wheel-size: min(480px, 92vw, 56svh);
  --rim-pad: clamp(6px, 1.6vw, 12px);

  /* perf */
  --gpu: translateZ(0);
  --inner-safe-scale: 1;

  /* shadow */
  --wheel-shadow: 0 26px 72px rgba(0,0,0,0.62);

  /* corefx */
  --corefx-opacity: 0.24;
  --corefx-opacity-spin: 0.40;

  /* sync */
  --spin-dur: 6000ms;

  /* hub & pointer */
  --hub-size: clamp(50px, calc(var(--wheel-size) * 0.10), 10px);

  --pointer-w: clamp(36px, calc(var(--wheel-size) * 0.115), 56px);
  --pointer-h: clamp(50px, calc(var(--wheel-size) * 0.155), 78px);

  /* pointer top base + offsetY (tuner) */
  --pointer-top: clamp(-26px, calc(var(--wheel-size) * -0.060), -16px);
  --pointer-drop: 18px;

  /* cutout */
  --hub-cut: 0.245;
  --hub-feather: 0.060;

  /* ✅ HALO / AURA OUTSIDE WHEEL (DIMATIKAN) */
  --wheel-halo: 0;

  container-type: inline-size;
}

@supports (height: 100dvh){
  .wheel-container{ --wheel-size: min(480px, 92vw, 56dvh); }
}
@container (min-width: 420px){
  .wheel-container{
    --hub-size: clamp(78px, calc(var(--wheel-size) * 0.225), 142px);
    --pointer-top: clamp(-24px, calc(var(--wheel-size) * -0.056), -14px);
    --hub-cut: 0.252;
  }
}
@container (max-width: 360px){
  .wheel-container{
    --hub-size: clamp(70px, calc(var(--wheel-size) * 0.205), 120px);
    --pointer-top: clamp(-22px, calc(var(--wheel-size) * -0.052), -12px);
    --hub-cut: 0.238;
  }
}

.wheel-container{
  position: relative;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  isolation: isolate;
  background: transparent;

  padding-top: clamp(12px, 2.6vw, 18px);
  padding-bottom: clamp(22px, 6vw, 46px);
}

/* Wrapper */
.wheel-wrapper{
  position: relative;
  width: var(--wheel-size);
  height: var(--wheel-size);
  max-width: 100%;
  max-height: 100%;
  aspect-ratio: 1 / 1;

  touch-action: manipulation;
  user-select: none;
  -webkit-user-select: none;

  background: transparent;
  isolation: isolate;
  z-index: 2;

  transform: var(--gpu);
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}

/* Pointer */
.pointer{
  position: absolute;
  top: var(--pointer-top);
  left: 50%;
  width: var(--pointer-w);
  height: var(--pointer-h);

  --pointer-offsetY: var(--pointer-drop);

  transform: translateX(-50%) translateY(var(--pointer-offsetY)) var(--gpu);
  transform-origin: 50% 16%;
  z-index: 40;
  pointer-events: none;

  filter:
    drop-shadow(0 16px 28px rgba(0,0,0,0.66))
    drop-shadow(0 0 12px rgba(59,224,123,0.07));

  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  will-change: transform;
}
.pointer svg{ width:100%; height:100%; display:block; }

.pointer.is-spin{ animation: pointerFloat 560ms ease-in-out infinite; }
@keyframes pointerFloat{
  0%{
    transform: translateX(-50%) translateY(var(--pointer-offsetY))
      rotate(-1.05deg) translateZ(0);
  }
  50%{
    transform: translateX(-50%) translateY(calc(var(--pointer-offsetY) + 1px))
      rotate(1.55deg) translateZ(0);
  }
  100%{
    transform: translateX(-50%) translateY(var(--pointer-offsetY))
      rotate(-1.05deg) translateZ(0);
  }
}
.pointer.is-kick{ animation: pointerKick 120ms ease-out 1; }
@keyframes pointerKick{
  0%{
    transform: translateX(-50%) translateY(var(--pointer-offsetY))
      rotate(0deg) translateZ(0);
  }
  45%{
    transform: translateX(-50%) translateY(var(--pointer-offsetY))
      rotate(var(--kick-deg, -11deg)) translateZ(0);
  }
  100%{
    transform: translateX(-50%) translateY(var(--pointer-offsetY))
      rotate(0deg) translateZ(0);
  }
}

/* Outer frame */
.wheel-outer{
  position: relative;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  padding: var(--rim-pad);
  z-index: 2;

  isolation: isolate;

  /* ✅ clip pseudo agar tidak bikin halo keluar */
  overflow: hidden;

  background: transparent;
  box-shadow: var(--wheel-shadow);

  transform: var(--gpu);
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}

/* ✅ HALO luar dimatikan by default (hapus “lingkaran putih / blur” di belakang wheel) */
.wheel-outer::before{
  content:"";
  position:absolute;
  inset: 0;                /* tidak keluar radius */
  border-radius: 0%;
  pointer-events:none;

  background:
    radial-gradient(circle at 50% 52%,
      rgba(246,179,61,0.06) 0%,
      rgba(246,179,61,0.018) 44%,
      rgba(246,179,61,0.00) 74%
    ),
    radial-gradient(circle at 50% 46%,
      rgba(59,224,123,0.05) 0%,
      rgba(59,224,123,0.016) 42%,
      rgba(59,224,123,0.00) 74%
    );

  opacity: calc(0.85 * var(--wheel-halo));
  filter: none;
  transform: translateZ(0);
}

/* Rim detail (anti “ring putih”) */
.wheel-outer::after{
  content:"";
  position:absolute;
  inset: var(--rim-pad);
  border-radius: 50%;
  pointer-events:none;

  box-shadow:
    inset 0 0 0 1px rgba(255,232,176,0.06),   /* sebelumnya putih, sekarang gold tipis */
    inset 0 8px 18px rgba(255,255,255,0.020),
    inset 0 -14px 22px rgba(0,0,0,0.28);
  opacity: 0.96;
}

/* Inner host */
.wheel-inner{
  position: relative;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  isolation: isolate;
  overflow: hidden;

  background: transparent;
  border: 0;

  box-shadow:
    inset 0 0 0 1px rgba(0,0,0,0.22),
    inset 0 16px 30px rgba(0,0,0,0.26),
    inset 0 -14px 22px rgba(255,255,255,0.026);

  transform: var(--gpu);
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  will-change: transform;
}

.wheel-inner .wheel-svg{
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  display: block;
  pointer-events: none;
  overflow: visible;
}

/* overlay halus */
.wheel-inner::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:50%;
  pointer-events:none;
  z-index: 10;

  background:
    radial-gradient(circle at 36% 22%, rgba(255,255,255,0.070), transparent 54%),
    radial-gradient(circle at 50% 58%, rgba(0,0,0,0.090), transparent 66%),
    radial-gradient(circle at 50% 50%, rgba(0,0,0,0.065), transparent 82%);
  opacity: 0.44;

  transform: scale(var(--inner-safe-scale)) translateZ(0);
  transform-origin: 50% 50%;

  -webkit-mask: radial-gradient(circle at 50% 50%,
    rgba(0,0,0,0.00) 0%,
    rgba(0,0,0,0.00) calc((var(--hub-cut) - var(--hub-feather)) * 100%),
    rgba(0,0,0,1.00) calc((var(--hub-cut) + var(--hub-feather)) * 100%),
    rgba(0,0,0,1.00) 100%
  );
          mask: radial-gradient(circle at 50% 50%,
    rgba(0,0,0,0.00) 0%,
    rgba(0,0,0,0.00) calc((var(--hub-cut) - var(--hub-feather)) * 100%),
    rgba(0,0,0,1.00) calc((var(--hub-cut) + var(--hub-feather)) * 100%),
    rgba(0,0,0,1.00) 100%
  );
}

/* Core FX */
.wheel-corefx{
  position:absolute;
  inset:0;
  border-radius:50%;
  pointer-events:none;
  z-index: 11;

  transform-origin: 50% 50%;
  opacity: var(--corefx-opacity);

  filter: none;
  mix-blend-mode: screen;

  will-change: transform, opacity;

  /* ✅ kurangi “white wash” supaya tidak jadi ring putih */
  background:
    conic-gradient(from 0deg,
      rgba(255,255,255,0.00) 0deg,
      rgba(255,255,255,0.055) 28deg,
      rgba(59,224,123,0.085) 58deg,
      rgba(255,255,255,0.00) 110deg,
      rgba(243,178,74,0.065) 150deg,
      rgba(255,255,255,0.00) 230deg,
      rgba(59,224,123,0.070) 300deg,
      rgba(255,255,255,0.00) 360deg
    );

  -webkit-mask: radial-gradient(circle at 50% 50%,
    rgba(0,0,0,0.00) 0%,
    rgba(0,0,0,0.00) calc((var(--hub-cut) + 0.020) * 100%),
    rgba(0,0,0,0.92) calc((var(--hub-cut) + 0.105) * 100%),
    rgba(0,0,0,1.00) 46%,
    rgba(0,0,0,0.78) 58%,
    rgba(0,0,0,0.00) 68%,
    rgba(0,0,0,0.00) 100%
  );
          mask: radial-gradient(circle at 50% 50%,
    rgba(0,0,0,0.00) 0%,
    rgba(0,0,0,0.00) calc((var(--hub-cut) + 0.020) * 100%),
    rgba(0,0,0,0.92) calc((var(--hub-cut) + 0.105) * 100%),
    rgba(0,0,0,1.00) 46%,
    rgba(0,0,0,0.78) 58%,
    rgba(0,0,0,0.00) 68%,
    rgba(0,0,0,0.00) 100%
  );

  animation: coreFXRotate 12.5s linear infinite;
}
@keyframes coreFXRotate{
  from{ transform: translateZ(0) scale(var(--inner-safe-scale)) rotate(0deg); }
  to  { transform: translateZ(0) scale(var(--inner-safe-scale)) rotate(360deg); }
}

/* Legacy spin */
.wheel-inner.spinning{
  animation: spin-wheel var(--spin-dur) cubic-bezier(0.15, 0, 0.15, 1) forwards;
}
@keyframes spin-wheel{
  from { transform: rotate(var(--from-rotation, 0deg)) translateZ(0); }
  to   { transform: rotate(var(--rotation)) translateZ(0); }
}
.wheel-inner.spinning .wheel-corefx{
  opacity: var(--corefx-opacity-spin);
  animation-duration: 2.35s;
}

/* Hide legacy text */
.prize-text{ display:none !important; }

/* Hub */
.wheel-center{
  position:absolute;
  top:50%;
  left:50%;
  transform: translate(-50%, -50%) translateZ(0);

  width: var(--hub-size);
  height: var(--hub-size);

  border-radius:50%;
  overflow:hidden;
  isolation:isolate;
  z-index: 30;

  background:
    radial-gradient(circle at 28% 18%, rgba(255,255,255,0.60), rgba(255,255,255,0.00) 46%),
    radial-gradient(circle at 66% 82%, rgba(0,0,0,0.52), rgba(0,0,0,0.00) 62%),
    radial-gradient(circle at 50% 50%, rgba(0,0,0,0.14), rgba(0,0,0,0.00) 58%),
    linear-gradient(180deg,
      #fff7e3 0%,
      #f9de9a 16%,
      #f6b33d 44%,
      #df8d2a 64%,
      #9b4f16 84%,
      #6f3711 100%
    );

  border: 1px solid rgba(255,232,176,0.20);

  box-shadow:
    0 18px 44px rgba(0,0,0,0.62),
    0 0 14px rgba(246,179,61,0.12),
    inset 0 0 0 1px rgba(0,0,0,0.16),
    inset 0 10px 16px rgba(255,255,255,0.06),
    inset 0 -18px 22px rgba(0,0,0,0.26);

  backface-visibility:hidden;
  -webkit-backface-visibility:hidden;
  will-change: transform;
}

.wheel-center::before{
  content:"";
  position:absolute;
  inset:-2%;
  border-radius:50%;
  pointer-events:none;
  z-index: 1;

  background:
    conic-gradient(from 16deg,
      rgba(255,255,255,0.32),
      rgba(0,0,0,0.00) 14%,
      rgba(255,255,255,0.13) 26%,
      rgba(0,0,0,0.00) 42%,
      rgba(255,255,255,0.20) 58%,
      rgba(0,0,0,0.00) 74%,
      rgba(255,255,255,0.32) 100%
    ),
    radial-gradient(circle at 50% 50%,
      rgba(0,0,0,0.00) 54%,
      rgba(0,0,0,0.16) 72%,
      rgba(0,0,0,0.00) 100%
    );

  opacity: 0.58;
  filter: none;
  mix-blend-mode: screen;
}

.wheel-center::after{
  content:"";
  position:absolute;
  left:50%;
  top:50%;
  transform: translate(-50%, -50%) translateZ(0);

  width: 60%;
  height: 60%;
  border-radius:50%;
  z-index: 3;

  background:
    repeating-radial-gradient(circle at 50% 50%,
      rgba(255,255,255,0.10) 0 1.8%,
      rgba(0,0,0,0.00) 1.8% 5.2%
    ),
    radial-gradient(circle at 34% 26%, rgba(255,255,255,0.34), transparent 54%),
    radial-gradient(circle at 64% 74%, rgba(0,0,0,0.42), transparent 66%),
    linear-gradient(180deg,
      rgba(255,244,214,0.98),
      rgba(246,179,61,0.94),
      rgba(138,74,22,0.94)
    );

  border: 1px solid rgba(255,255,255,0.14);
  box-shadow:
    inset 0 0 0 1px rgba(0,0,0,0.20),
    inset 0 10px 18px rgba(255,255,255,0.06),
    inset 0 -16px 18px rgba(0,0,0,0.30);
}

.wheel-center .hub-sheen{
  position:absolute;
  inset:-18%;
  border-radius:50%;
  pointer-events:none;
  z-index: 4;

  opacity: 0.16;
  mix-blend-mode: screen;
  filter: none;
  will-change: opacity;

  background:
    radial-gradient(circle at 26% 18%, rgba(255,255,255,0.36), transparent 48%),
    conic-gradient(from 0deg,
      rgba(255,255,255,0.00) 0deg,
      rgba(255,255,255,0.14) 22deg,
      rgba(255,255,255,0.00) 70deg,
      rgba(255,255,255,0.09) 132deg,
      rgba(255,255,255,0.00) 220deg,
      rgba(255,255,255,0.10) 276deg,
      rgba(255,255,255,0.00) 360deg
    );

  animation: hubSpark 1.9s ease-in-out infinite;
}
@keyframes hubSpark{
  0%   { opacity: 0.12; }
  50%  { opacity: 0.20; }
  100% { opacity: 0.12; }
}

/* Mobile/low interaction */
@media (hover: none) and (pointer: coarse){
  .wheel-corefx{ animation-duration: 16s; }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  .wheel-corefx,
  .wheel-center .hub-sheen{
    animation: none !important;
  }
}

/* ======================================================================
 * 6) FORMS / INPUT / BUTTONS — RESPONSIVE + SMOOTH
 * ====================================================================== */
.input-section{
  position: relative;
  isolation: isolate;
  overflow: hidden;

  border-radius: var(--radius-lg);
  padding: clamp(16px, 3.8vw, 28px);
  margin-bottom: 14px;

  background:
    radial-gradient(520px 260px at 18% 10%, rgba(255,255,255,0.045), transparent 62%),
    linear-gradient(135deg, rgba(59,224,123,0.065), rgba(0,0,0,0.30));
  border: 1px solid rgba(59,224,123,0.18);

  box-shadow:
    0 18px 64px rgba(0,0,0,0.46),
    0 0 48px -18px rgba(59,224,123,0.16);

  transform: var(--gpu);
  -webkit-tap-highlight-color: transparent;
}
.input-section::before{
  content:"";
  position:absolute;
  inset: -2px;
  pointer-events:none;
  opacity: 0.48;

  background:
    radial-gradient(420px 220px at 20% 15%, rgba(255,255,255,0.085), transparent 66%),
    radial-gradient(520px 260px at 90% 35%, rgba(59,224,123,0.12), transparent 66%);
  filter: blur(0.7px);
}
@supports ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
  .input-section{
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
  }
}

.input-section h2{
  font-size: clamp(1.10rem, 2.4vw, 1.42rem);
  margin-bottom: 10px;
  letter-spacing: 0.2px;
  text-shadow: 0 10px 26px rgba(0,0,0,0.56);
}
.input-section p{
  color: rgba(255, 255, 255, 0.74);
  margin-bottom: 16px;
  font-size: clamp(0.92rem, 1.8vw, 0.96rem);
  line-height: 1.48;
}

label{
  display: block;
  margin-bottom: 10px;
  font-weight: 900;
  color: rgba(255,255,255,0.92);
  letter-spacing: 0.2px;
  text-transform: none;
}

/* Input */
input{
  width: 100%;
  min-height: 54px;
  height: 54px;
  padding: 0 16px;

  font-size: 18px; /* iOS anti-zoom */
  line-height: 54px;
  text-align: center;

  color: rgba(255,255,255,0.94);
  caret-color: rgba(255,255,255,0.92);

  background: rgba(255,255,255,0.055);
  border: 1px solid rgba(255,255,255,0.16);
  border-radius: 12px;

  outline: none;
  appearance: none;
  -webkit-appearance: none;

  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  letter-spacing: 1.1px;

  margin-bottom: 14px;

  box-shadow:
    inset 0 0 0 1px rgba(0,0,0,0.28),
    0 10px 26px rgba(0,0,0,0.20);

  transition:
    transform 140ms ease,
    border-color 200ms ease,
    background 200ms ease,
    box-shadow 200ms ease;
  will-change: transform;
}
@media (hover: hover) and (pointer: fine){
  input:hover{
    border-color: rgba(255,255,255,0.22);
    background: rgba(255,255,255,0.065);
  }
}
input:focus{
  border-color: rgba(59,224,123,0.44);
  background: rgba(255,255,255,0.075);
  box-shadow:
    0 0 0 4px rgba(59,224,123,0.12),
    0 16px 40px rgba(0,0,0,0.44);
  transform: translateY(-1px);
}
input:focus:not(:focus-visible){
  box-shadow:
    0 0 0 3px rgba(59,224,123,0.10),
    0 14px 34px rgba(0,0,0,0.40);
}

input::placeholder{
  color: rgba(255,255,255,0.38);
  letter-spacing: 1.1px;
  opacity: 1;
}
input::-webkit-input-placeholder{ opacity: 1; }

/* Autofill */
input:-webkit-autofill{
  -webkit-text-fill-color: rgba(255,255,255,0.94);
  transition: background-color 99999s ease-out 0s;
  box-shadow:
    0 0 0px 1000px rgba(255,255,255,0.055) inset,
    0 10px 26px rgba(0,0,0,0.20);
  border: 1px solid rgba(255,255,255,0.16);
}

/* Buttons — base */
.primary-btn,
.secondary-btn{
  width: 100%;
  border-radius: 12px;
  cursor: pointer;

  appearance: none;
  -webkit-appearance: none;

  user-select: none;
  -webkit-user-select: none;

  min-height: var(--tap);

  transform: var(--gpu);
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;

  will-change: transform;
  transition:
    transform 140ms ease,
    box-shadow 220ms ease,
    background 220ms ease,
    border-color 220ms ease,
    opacity 200ms ease,
    filter 220ms ease;
}

/* Primary */
.primary-btn{
  min-height: 60px;
  height: 60px;

  font-size: clamp(1.05rem, 2.6vw, 1.35rem);
  font-weight: 1000;
  letter-spacing: 1.0px;
  color: rgba(0,0,0,0.92);

  border: 1px solid rgba(59,224,123,0.62);

  background:
    radial-gradient(240px 96px at 50% -24%, rgba(255,255,255,0.18), rgba(255,255,255,0.00) 62%),
    linear-gradient(to bottom, var(--green1), var(--green2));

  box-shadow:
    0 0 36px rgba(59,224,123,0.18),
    0 16px 54px rgba(0,0,0,0.30);

  position: relative;
  overflow: hidden;
}
.primary-btn::before{
  content:"";
  position:absolute;
  inset:-2px;
  pointer-events:none;
  opacity: 0.70;
  transform: translateX(-120%);
  background: linear-gradient(90deg, rgba(255,255,255,0.0), rgba(255,255,255,0.32), rgba(255,255,255,0.0));
}

@media (hover: hover) and (pointer: fine){
  .primary-btn:hover:not(:disabled){
    transform: translateY(-1px) var(--gpu);
    filter: saturate(1.05) contrast(1.02);

    box-shadow:
      0 0 46px rgba(59,224,123,0.22),
      0 20px 64px rgba(0,0,0,0.34);

    background:
      radial-gradient(260px 104px at 50% -24%, rgba(255,255,255,0.20), rgba(255,255,255,0.00) 64%),
      linear-gradient(to bottom, rgba(215,255,233,0.92), var(--green1));
  }
  .primary-btn:hover:not(:disabled)::before{ animation: sheen 920ms ease-out; }
}
@keyframes sheen{ from { transform: translateX(-120%); } to { transform: translateX(120%); } }

.primary-btn:active:not(:disabled){
  transform: translateY(0px) scale(0.992) var(--gpu);
  box-shadow:
    0 0 22px rgba(59,224,123,0.16),
    0 14px 48px rgba(0,0,0,0.30);
}

/* ✅ Touch feedback lebih “kerasa” di mobile */
@media (hover: none) and (pointer: coarse){
  .primary-btn:active:not(:disabled){
    transform: scale(0.988) var(--gpu);
    filter: saturate(1.04);
  }
}

.primary-btn:focus-visible{
  outline: none;
  box-shadow:
    0 0 0 4px rgba(59,224,123,0.14),
    0 16px 54px rgba(0,0,0,0.34);
}
.primary-btn:disabled{
  opacity: 0.62;
  cursor: not-allowed;
  filter: saturate(0.9);
}

/* Ripple FX */
.primary-btn.fx::after{
  content:"";
  position:absolute;
  left: var(--fx-x, 50%);
  top: var(--fx-y, 50%);
  width: 10px;
  height: 10px;
  border-radius: 50%;
  transform: translate(-50%, -50%) scale(0);
  pointer-events:none;

  background: radial-gradient(circle, rgba(255,255,255,0.62), rgba(59,224,123,0.12), rgba(0,0,0,0.0));
  animation: ripple 520ms ease-out forwards;
}
@keyframes ripple{
  to{ transform: translate(-50%, -50%) scale(32); opacity: 0; }
}

/* Secondary */
.secondary-btn{
  min-height: 50px;
  height: 50px;

  font-size: clamp(0.92rem, 2.2vw, 1rem);
  font-weight: 1000;

  border: 1px solid rgba(255,255,255,0.16);
  color: rgba(255,255,255,0.92);

  background:
    radial-gradient(240px 110px at 50% -30%, rgba(255,255,255,0.08), rgba(255,255,255,0.00) 62%),
    rgba(0,0,0,0.44);

  box-shadow: 0 14px 46px rgba(0,0,0,0.26);
  position: relative;
  overflow: hidden;
}
@media (hover: hover) and (pointer: fine){
  .secondary-btn:hover{
    background:
      radial-gradient(240px 110px at 50% -30%, rgba(255,255,255,0.10), rgba(255,255,255,0.00) 64%),
      rgba(0,0,0,0.56);
    border-color: rgba(255,255,255,0.22);
    transform: translateY(-1px) var(--gpu);
  }
}
.secondary-btn:active{
  transform: scale(0.992) var(--gpu);
}
@media (hover: none) and (pointer: coarse){
  .secondary-btn:active{ transform: scale(0.988) var(--gpu); }
}
.secondary-btn:focus-visible{
  outline: none;
  box-shadow:
    0 0 0 4px rgba(255,255,255,0.10),
    0 14px 46px rgba(0,0,0,0.30);
}

/* Jackpot block */
.jackpot-display{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 6px;
  padding-top: 14px;
}
.jackpot-label{
  font-size: 0.85rem;
  color: rgba(255,255,255,0.62);
}
.jackpot-amount{
  font-size: clamp(1.08rem, 2.6vw, 1.24rem);
  font-weight: 1000;
  color: #65f0a3;

  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  letter-spacing: 1px;
  font-variant-numeric: tabular-nums;

  text-shadow: 0 12px 26px rgba(0,0,0,0.48);
}
.jackpot-meta{
  font-size: 0.82rem;
  color: rgba(255,255,255,0.56);

  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  letter-spacing: 0.3px;
  text-align: center;
}

/* Already spun message */
.spun-message{
  text-align: center;
  padding: 12px 14px;
  border-radius: 10px;

  background: rgba(239, 68, 68, 0.16);
  border: 1px solid rgba(239, 68, 68, 0.42);
  color: rgba(248, 113, 113, 0.92);

  margin-bottom: 14px;
  line-height: 1.38;

  box-shadow: 0 14px 40px rgba(0,0,0,0.28);
}

@media (max-width: 420px){
  input{
    height: 52px;
    min-height: 52px;
    line-height: 52px;
    font-size: 17px;
  }
  .primary-btn{
    height: 58px;
    min-height: 58px;
    letter-spacing: 0.9px;
  }
  .secondary-btn{
    height: 48px;
    min-height: 48px;
  }
}

/* Reduced motion (forms) */
@media (prefers-reduced-motion: reduce){
  input, .primary-btn, .secondary-btn{
    transition: none !important;
  }
  .primary-btn::before{ animation: none !important; }
}

/* ======================================================================
 * 7) WINNERS (TABLE)
 * ====================================================================== */
.winners-section{
  position: relative;
  background:
    radial-gradient(680px 320px at 18% 0%, rgba(255,255,255,0.055), transparent 62%),
    radial-gradient(820px 420px at 92% 18%, rgba(59,224,123,0.08), transparent 64%),
    linear-gradient(180deg, rgba(0,0,0,0.30), rgba(0,0,0,0.18));
  border: 1px solid rgba(255,255,255,0.09);
  border-radius: 16px;
  overflow: hidden;
  min-width: 0;
  box-shadow:
    0 22px 78px rgba(0,0,0,0.44),
    0 0 0 1px rgba(0,0,0,0.22) inset;
  isolation: isolate;
}
.winners-section::before{
  content:"";
  position:absolute;
  inset:-2px;
  pointer-events:none;
  opacity: 0.55;
  background:
    radial-gradient(520px 220px at 24% 18%, rgba(255,255,255,0.09), transparent 66%),
    radial-gradient(620px 260px at 86% 30%, rgba(59,224,123,0.14), transparent 70%),
    linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.00) 42%);
  filter: blur(0.8px);
}
@supports ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
  .winners-section{
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
  }
}

.winners-header{
  position: relative;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 16px;

  font-weight: 1000;
  font-size: 1.02rem;
  letter-spacing: 0.2px;

  background:
    radial-gradient(520px 180px at 22% -24%, rgba(255,255,255,0.11), transparent 60%),
    linear-gradient(to right, rgba(59,224,123,0.22), rgba(59,224,123,0.06));
  border-bottom: 1px solid rgba(59,224,123,0.12);

  text-shadow: 0 10px 26px rgba(0,0,0,0.56);
  z-index: 2;
}
.winners-header::after{
  content:"";
  position:absolute;
  left: 0; right: 0; bottom: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.10), transparent);
  opacity: 0.65;
  pointer-events:none;
}

.winners-table{
  width: 100%;
  max-height: 320px;
  overflow-x: hidden;
  overflow-y: auto;
  display: block;
  overscroll-behavior: contain;
  scroll-behavior: smooth;
  padding-bottom: 2px;

  scrollbar-width: thin;
  scrollbar-color: rgba(59,224,123,0.28) rgba(0,0,0,0.22);
  -webkit-overflow-scrolling: touch;

  scroll-padding-top: 56px;
}
.winners-table::-webkit-scrollbar{ width: 6px; }
.winners-table::-webkit-scrollbar-track{ background: rgba(0,0,0,0.22); }
.winners-table::-webkit-scrollbar-thumb{
  background: rgba(59,224,123,0.26);
  border-radius: 999px;
}
.winners-table::-webkit-scrollbar-thumb:hover{ background: rgba(59,224,123,0.44); }

.winners-table-header,
.winners-table-row{
  display: grid;
  grid-template-columns: 56px minmax(0, 1fr) clamp(120px, 28vw, 170px);
  gap: 10px;
  padding: 12px 16px;
  align-items: center;
  width: 100%;
  min-width: 0;
}

.winners-table-header{
  background: rgba(0,0,0,0.72);
  font-weight: 1000;
  color: rgba(215,255,233,0.92);
  position: sticky;
  top: 0;
  z-index: 3;

  border-bottom: 2px solid rgba(59,224,123,0.18);
  white-space: nowrap;
}
@supports ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
  .winners-table-header{
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }
}
.winners-table-header > div{ white-space: nowrap; }

.winners-table-row{
  border-bottom: 1px solid rgba(255,255,255,0.05);
  position: relative;
  transition: transform 260ms ease, background 220ms ease, box-shadow 220ms ease;
  will-change: transform;
  cursor: default;
  user-select: none;
}
.winners-table-row::before{
  content:"";
  position:absolute;
  inset: 0;
  pointer-events:none;
  opacity: 0;
  background: radial-gradient(520px 120px at 50% 50%, rgba(255,255,255,0.06), transparent 62%);
  transition: opacity 220ms ease;
}
@media (hover: hover) and (pointer: fine){
  .winners-table-row:hover::before{ opacity: 1; }
  .winners-table-row:hover:not(.is-user){ background: rgba(255,255,255,0.022); }
}

.winners-table-row.is-user{
  cursor: pointer;
  background: rgba(59,224,123,0.085);
  box-shadow:
    inset 0 0 0 1px rgba(59,224,123,0.18),
    inset 0 0 18px rgba(59,224,123,0.06);
}
@media (hover: hover) and (pointer: fine){
  .winners-table-row.is-user:hover{
    background: rgba(59,224,123,0.11);
    box-shadow:
      inset 0 0 0 1px rgba(59,224,123,0.24),
      0 12px 38px rgba(0,0,0,0.26);
  }
}

.winner-no{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  color: rgba(255,255,255,0.62);
  text-align: center;
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
}
.winner-id{
  font-weight: 1000;
  color: rgba(255,255,255,0.96);
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  letter-spacing: 0.15px;
}
.winner-meta{
  font-size: 0.85rem;
  color: rgba(255,255,255,0.56);
  margin-top: 2px;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.winner-prize{
  text-align: right;
  font-weight: 1000;
  color: #65f0a3;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
  text-shadow: 0 10px 26px rgba(0,0,0,0.40);
}

@keyframes rowIn{
  from{ opacity:0; transform: translateY(-8px); }
  to{ opacity:1; transform: translateY(0); }
}
@keyframes shimmer{
  from{ transform: translateX(-70%); opacity: 0; }
  15%{ opacity: 1; }
  to{ transform: translateX(70%); opacity: 0; }
}
.winners-table-row.is-new{
  animation: rowIn 240ms ease-out;
  background: linear-gradient(90deg, rgba(59,224,123,0.14), rgba(255,255,255,0.03));
  box-shadow:
    inset 0 0 0 1px rgba(59,224,123,0.20),
    inset 0 0 22px rgba(59,224,123,0.06);
}
.winners-table-row.is-new::after{
  content:"";
  position:absolute;
  inset: 0;
  pointer-events:none;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.22), transparent);
  transform: translateX(-70%);
  animation: shimmer 980ms ease-out forwards;
}

@media (max-width: 420px){
  .winners-header{
    padding: 10px 12px;
    font-size: 0.95rem;
    gap: 8px;
  }
  .winners-table-header,
  .winners-table-row{
    padding: 10px 12px;
    gap: 8px;
    grid-template-columns: 40px minmax(0, 1fr) clamp(88px, 26vw, 130px);
  }
  .winners-table-header{ font-size: 0.90rem; }
  .winner-no{ font-size: 0.85rem; }
  .winner-id{ font-size: 0.95rem; }
  .winner-meta{ font-size: 0.78rem; }
  .winner-prize{ font-size: 0.95rem; }
}
@media (max-width: 360px){
  .winners-table-header,
  .winners-table-row{
    grid-template-columns: 36px minmax(0, 1fr) clamp(84px, 28vw, 118px);
  }
  .winners-header{ font-size: 0.92rem; }
  .winners-table-header{ font-size: 0.88rem; }
}

/* ======================================================================
 * 8) MODAL — MINIMAL + SMOOTH (SMALLER + RESPONSIVE) — FULL REPLACE
 * Fokus:
 * ✅ Modal reward lebih kecil (tidak “gede banget” di desktop)
 * ✅ Mobile tetap nyaman: padding aman, max-height aman, font scalable
 * ✅ Tombol ikut mengecil + tetap enak ditekan
 * ====================================================================== */
.modal{
  position: fixed;
  inset: 0;
  z-index: 1000;

  display: flex;
  align-items: center;
  justify-content: center;

  padding:
    calc(12px + var(--safe-top))
    calc(12px + var(--safe-right))
    calc(12px + var(--safe-bottom))
    calc(12px + var(--safe-left));

  height: 100svh;
  width: 100vw;

  --modal-dur: 220ms;
  --modal-ease: cubic-bezier(0.2, 0.9, 0.2, 1);

  background: rgba(0,0,0,0.68);
  opacity: 0;
  visibility: hidden;
  pointer-events: none;

  transition:
    opacity var(--modal-dur) var(--modal-ease),
    visibility 0s linear var(--modal-dur);

  contain: layout paint style;
}
@supports (height: 100dvh){
  .modal{ height: 100dvh; }
}
.modal.show{
  opacity: 1;
  visibility: visible;
  pointer-events: auto;

  transition:
    opacity var(--modal-dur) var(--modal-ease),
    visibility 0s linear 0s;
}
@supports ((-webkit-backdrop-filter: blur(10px)) or (backdrop-filter: blur(10px))){
  .modal{
    -webkit-backdrop-filter: blur(10px) saturate(115%);
    backdrop-filter: blur(10px) saturate(115%);
  }
}

.modal-content{
  /* ✅ lebih kecil & rapih */
  width: min(420px, 100%);
  max-height: min(76svh, 560px);
  overflow: auto;

  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;

  border-radius: 16px;
  padding: clamp(14px, 3.2vw, 22px);
  text-align: center;

  background:
    radial-gradient(420px 240px at 18% 10%, rgba(255,255,255,0.040), transparent 62%),
    linear-gradient(135deg, rgba(6,18,14,0.965), rgba(7,26,19,0.94));
  border: 1px solid rgba(59,224,123,0.26);

  box-shadow:
    0 16px 54px rgba(0,0,0,0.58),
    0 0 0 1px rgba(0,0,0,0.18) inset;

  opacity: 0;
  transform: translate3d(0, 10px, 0) scale(0.985);
  will-change: transform, opacity;

  transition:
    transform var(--modal-dur) var(--modal-ease),
    opacity var(--modal-dur) var(--modal-ease);

  scrollbar-width: thin;
  scrollbar-color: rgba(59,224,123,0.22) rgba(0,0,0,0.18);
}
@supports (max-height: 76dvh){
  .modal-content{ max-height: min(76dvh, 560px); }
}
.modal.show .modal-content{
  opacity: 1;
  transform: translate3d(0, 0, 0) scale(1);
}

/* Scrollbar */
.modal-content::-webkit-scrollbar{ width: 10px; }
.modal-content::-webkit-scrollbar-track{
  background: rgba(0,0,0,0.18);
  border-radius: 999px;
}
.modal-content::-webkit-scrollbar-thumb{
  background: rgba(59,224,123,0.22);
  border-radius: 999px;
  border: 2px solid rgba(0,0,0,0.12);
}
.modal-content::-webkit-scrollbar-thumb:hover{
  background: rgba(59,224,123,0.30);
}

/* Typography lebih kompak */
.modal-content h1{
  font-size: clamp(1.35rem, 2.8vw, 1.9rem);
  margin-bottom: 6px;
  letter-spacing: 0.2px;
  text-shadow: 0 12px 28px rgba(0,0,0,0.52);
}
.modal-content p{
  color: rgba(255,255,255,0.84);
  margin-bottom: 12px;
  font-size: clamp(0.95rem, 2.3vw, 1.02rem);
  line-height: 1.5;
}

/* Prize amount lebih proporsional */
.prize-amount{
  font-size: clamp(1.6rem, 5.2vw, 2.35rem);
  font-weight: 1000;
  color: var(--green0);
  margin: 12px 0 8px;
  line-height: 1.1;
  text-shadow: 0 16px 36px rgba(0,0,0,0.58);
}
.prize-meta{
  font-size: 0.92rem;
  color: rgba(255,255,255,0.70);
  margin-top: 3px;
  line-height: 1.45;
}
.mono{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  letter-spacing: 0.6px;
  color: rgba(255,255,255,0.92);
  font-weight: 900;
}

/* Actions lebih compact tapi tetap tap-friendly */
.modal-actions{
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 14px;
  align-items: center;
}
.modal-actions .primary-btn{
  max-width: 300px;
  width: 100%;
  height: 52px;
  font-size: 16px;
}
.modal-actions .secondary-btn{
  max-width: 300px;
  width: 100%;
  height: 46px;
  font-size: 14px;
}

/* Mobile kecil: makin ringkas */
@media (max-width: 380px){
  .modal{ padding: calc(10px + var(--safe-top)) calc(10px + var(--safe-right)) calc(10px + var(--safe-bottom)) calc(10px + var(--safe-left)); }
  .modal-content{
    width: min(360px, 100%);
    max-height: min(78svh, 520px);
    border-radius: 14px;
    padding: 14px;
  }
  .modal-actions .primary-btn{ height: 50px; font-size: 15px; }
  .modal-actions .secondary-btn{ height: 44px; font-size: 13.5px; }
}

/* Desktop lebar: jangan kebesaran */
@media (min-width: 1024px){
  .modal-content{
    width: min(400px, 92vw);
    max-height: min(74svh, 520px);
  }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  .modal, .modal-content{
    transition: none !important;
    animation: none !important;
  }
  .modal-content{ transform: none !important; opacity: 1 !important; }
}

/* ======================================================================
 * 9) TOAST
 * ====================================================================== */
.toast{
  position: fixed;
  left: 50%;
  bottom: calc(18px + var(--safe-bottom));
  transform: translateX(-50%);
  z-index: 1200;
  width: min(520px, calc(100vw - 28px));
  background: rgba(0,0,0,0.74);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 14px;
  padding: 12px 14px;
  display: none;
  gap: 10px;
  align-items: center;
  box-shadow: 0 20px 70px rgba(0,0,0,0.56);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  isolation: isolate;
}
.toast.show{ display: flex; animation: toastIn 180ms ease-out; }
@keyframes toastIn {
  from { opacity: 0; transform: translateX(-50%) translateY(6px); }
  to   { opacity: 1; transform: translateX(-50%) translateY(0); }
}
.toast .dot{
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--green1);
  box-shadow: 0 0 14px rgba(59,224,123,0.34);
  flex: 0 0 auto;
}
.toast .msg{ color: rgba(255,255,255,0.94); font-weight: 900; line-height: 1.3; font-size: 0.98rem; }
.toast.error .dot{ background: #ef4444; box-shadow: 0 0 14px rgba(239,68,68,0.34); }
.toast.success .dot{ background: #65f0a3; box-shadow: 0 0 14px rgba(59,224,123,0.30); }

/* ======================================================================
 * 10) LOADING OVERLAY (CLAIM)
 * ====================================================================== */
.nav-loading{
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;

  background: rgba(0,0,0,0.78);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);

  padding: calc(14px + var(--safe-top)) calc(14px + var(--safe-right)) calc(14px + var(--safe-bottom)) calc(14px + var(--safe-left));

  opacity: 0;
  visibility: hidden;
  pointer-events: none;

  transform: var(--gpu);
  transition: opacity 240ms ease, visibility 0s linear 240ms;
  isolation: isolate;
}
.nav-loading.show{
  opacity: 1;
  visibility: visible;
  pointer-events: auto;
  transition: opacity 240ms ease, visibility 0s;
}
.nav-loading-card{
  width: min(520px, calc(100vw - 28px));
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.10);
  background:
    radial-gradient(520px 240px at 18% 10%, rgba(255,255,255,0.05), transparent 62%),
    linear-gradient(135deg, rgba(6,18,14,0.98), rgba(7,30,22,0.96));
  box-shadow: 0 25px 90px rgba(0,0,0,0.64);
  padding: 18px 18px;
  display: flex;
  gap: 12px;
  align-items: center;
  transform: translateY(4px);
  transition: transform 240ms ease;
}
.nav-loading.show .nav-loading-card{ transform: translateY(0); }

.nav-spinner{
  width: 34px;
  height: 34px;
  border-radius: 999px;
  border: 3px solid rgba(255,255,255,0.14);
  border-top-color: rgba(59,224,123,0.90);
  animation: navSpin 820ms linear infinite;
  flex: 0 0 auto;
}
@keyframes navSpin{ to{ transform: rotate(360deg); } }

.nav-title{ font-weight: 1000; color: rgba(255,255,255,0.94); line-height: 1.2; }
.nav-sub{ font-size: 0.92rem; color: rgba(255,255,255,0.62); margin-top: 2px; }

/* ======================================================================
 * 11) A11Y / FOCUS
 * ====================================================================== */
:focus-visible{
  outline: 3px solid var(--ring);
  outline-offset: 3px;
  border-radius: 10px;
}

/* ======================================================================
 * 12) LOW-END DOWNGRADE (toggle by JS)
 * ====================================================================== */
body.low-end #fxCanvas{ opacity: 0.52; }
body.low-end::after{ opacity: 0.028; }
body.low-end .wheel-outer{ box-shadow: 0 22px 70px rgba(0,0,0,0.58); }
body.low-end .wheel-corefx{ opacity: 0.62; }

/* Safari safety */
@supports (-webkit-touch-callout: none){
  .wheel-corefx{ opacity: 0.78; }
  header::after{ opacity: 0.46; }
}

/* ======================================================================
 * 13) REDUCED MOTION / SLOW UPDATE
 * ====================================================================== */
@media (prefers-reduced-motion: reduce), (update: slow){
  .wheel-center .hub-sheen{ animation: none !important; opacity: 0.16; }
}
@media (prefers-reduced-motion: reduce){
  .wheel-corefx,
  .wheel-inner.spinning{
    animation: none !important;
  }
}

@media (update: slow){
  .wheel-outer::before{ opacity: calc(0.55 * var(--wheel-halo)); }
  .wheel-corefx{ opacity: calc(var(--corefx-opacity) * 0.78); }
}

/* Global reduced motion hard stop */
@media (prefers-reduced-motion: reduce){
  * { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
  .winners-table-row.is-new::after { display: none !important; }
  .nav-spinner{ animation: none !important; }
  #fxCanvas{ display:none !important; }
  .wheel-outer::before{ display:none !important; } /* pastikan tidak ada halo */
  body::after{ display:none !important; }
  .wheel-corefx{ display:none !important; }
}

/* ======================================================================
 * EXTRA HARD-KILL (kalau masih ada ring putih dari CSS lain yang nyangkut)
 * ====================================================================== */
.wheel-wrapper, .wheel-outer, .wheel-inner { background: transparent !important; }
</style>

</head>

<body>
  <canvas id="fxCanvas" aria-hidden="true"></canvas>

  <div class="container" id="mainContainer">
    <header>
      <h1 class="hero-title">
        <span class="hero-top">SELAMAT DATANG DI</span>
        <span class="hero-brand">MADETOTO2</span>
      </h1>
      <p class="subtitle">
        PUTAR RODANYA &amp; DAPATKAN HADIAH FANTASTIS HINGGA 200 RIBU RUPIAH!
      </p>
    </header>

    <div class="main-content">
      <div class="wheel-container">
        <div class="wheel-wrapper" id="wheelWrap">
          <div class="pointer" id="pointerEl" aria-hidden="true">
            <!-- NOTE: Defs ID dibuat unik supaya tidak bentrok dengan SVG lain (penting!) -->
            <svg viewBox="0 0 64 90" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
              <defs>
                <linearGradient id="ptrMetal" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0" stop-color="#ffffff" stop-opacity="0.90" />
                  <stop offset="0.24" stop-color="#c3c3c3" stop-opacity="0.92" />
                  <stop offset="0.56" stop-color="#585858" stop-opacity="0.96" />
                  <stop offset="1" stop-color="#121212" stop-opacity="0.98" />
                </linearGradient>

                <linearGradient id="ptrGold" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0" stop-color="#FFF4D6" />
                  <stop offset="0.52" stop-color="#F6B33D" />
                  <stop offset="1" stop-color="#8A4A16" />
                </linearGradient>

                <radialGradient id="ptrCap" cx="35%" cy="30%" r="70%">
                  <stop offset="0" stop-color="#ffffff" stop-opacity="0.98" />
                  <stop offset="0.45" stop-color="#FFF4D6" />
                  <stop offset="1" stop-color="#B45309" />
                </radialGradient>
              </defs>

              <path
                d="M32 86 L10 34 C10 34 14 10 32 10 C50 10 54 34 54 34 L32 86 Z"
                fill="url(#ptrGold)"
                stroke="rgba(255,255,255,0.22)"
                stroke-width="2"
              />
              <path
                d="M32 80 L18 36 C18 36 20 18 32 18 C44 18 46 36 46 36 L32 80 Z"
                fill="url(#ptrMetal)"
                opacity="0.96"
              />
              <circle
                cx="32"
                cy="27"
                r="11"
                fill="url(#ptrCap)"
                stroke="rgba(0,0,0,0.22)"
                stroke-width="2"
              />
              <circle
                cx="32"
                cy="27"
                r="4.2"
                fill="rgba(10,10,10,0.78)"
                stroke="rgba(255,255,255,0.16)"
                stroke-width="1.5"
              />
            </svg>
          </div>

          <div class="wheel-outer">
            <div class="wheel-inner" id="wheel" aria-label="Lucky wheel">
              <!-- untuk efek overlay internal -->
              <div class="wheel-corefx" aria-hidden="true"></div>

              <!-- hub / center overlay -->
              <div class="wheel-center" aria-hidden="true">
                <span class="hub-sheen" aria-hidden="true"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="input-section">
          <h2>MASUKKAN USER ID</h2>
          <p id="userIdHelp">Masukkan User ID Anda untuk memutar roda keberuntungan.</p>

          <label for="userIdInput">User ID</label>
          <input
            type="text"
            id="userIdInput"
            placeholder="Contoh: User123"
            maxlength="20"
            autocomplete="off"
            autocapitalize="off"
            autocorrect="off"
            spellcheck="false"
            inputmode="text"
            aria-describedby="userIdHelp"
          />

          <button id="spinBtn" class="primary-btn" type="button">
            SPIN SEKARANG!
          </button>

          <div class="jackpot-display" aria-live="polite">
            <div class="jackpot-label">Total Jackpot</div>
            <div class="jackpot-amount" id="jackpot">IDR 888.888.888</div>
            <div class="jackpot-meta" id="jackpotMeta">Update: --:--:--</div>
          </div>
        </div>

        <div id="spunMessage" class="spun-message" style="display: none;">
          Kesempatan spin Anda sudah habis. Silakan klaim hadiah Anda.
        </div>

        <div class="winners-section" aria-label="Riwayat Spin Terakhir">
          <div class="winners-header">🏆 50 Riwayat Spin Terakhir</div>

          <div class="winners-table" id="winnersTable" aria-live="polite" aria-atomic="false">
            <div class="winners-table-header" role="row">
              <div role="columnheader">NO</div>
              <div role="columnheader">USER ID</div>
              <div role="columnheader">HADIAH</div>
            </div>
            <!-- rows akan di-inject oleh JS -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true">
    <div class="dot" aria-hidden="true"></div>
    <div class="msg" id="toastMsg">Toast</div>
  </div>

  <div
    class="modal"
    id="prizeModal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="prizeTitle"
    aria-describedby="prizeDesc"
    aria-hidden="true"
  >
    <div class="modal-content" role="document" tabindex="-1">
      <h1 id="prizeTitle">SELAMAT!</h1>
      <p id="prizeDesc">Anda memenangkan hadiah:</p>

      <div class="prize-amount" id="prizeAmount">BONUS 10%</div>

      <div class="prize-meta">
        User ID: <span class="mono" id="modalUserId">-</span><br />
        Waktu: <span class="mono" id="modalTime">-</span>
      </div>

      <p style="margin-top: 14px;">
        Silakan klaim melalui Live Chat dan sertakan User ID.
      </p>

      <!-- ✅ Actions: KLAIM -> UNDUH -> BAGIKAN -->
      <div class="modal-actions" style="display: flex; flex-direction: column; gap: 10px;">
        <button type="button" class="primary-btn" id="claimBtn">
          KLAIM SEKARANG
        </button>

        <button type="button" class="secondary-btn" id="downloadBtn">
          UNDUH HASIL
        </button>

        <button
          type="button"
          class="secondary-btn"
          id="shareBtn"
          aria-label="Bagikan hasil"
        >
          BAGIKAN
        </button>
      </div>

      <div class="prize-meta" style="margin-top: 10px;">
        Klik tombol unduh untuk mendapatkan hasil. File akan tersimpan otomatis di perangkat Anda.
      </div>
    </div>
  </div>

  <div class="nav-loading" id="navLoading" aria-hidden="true">
    <div class="nav-loading-card" role="status" aria-live="polite" aria-atomic="true">
      <div class="nav-spinner" aria-hidden="true"></div>
      <div>
        <div class="nav-title">Menghubungkan…</div>
        <div class="nav-sub">Mengarahkan ke halaman server</div>
      </div>
    </div>
  </div>

  <!-- Chaport Live Chat -->
  <script type="text/javascript">
    (function (w, d, v3) {
      w.chaportConfig = { appId: "6937b4ead2823b3f94b0a834" };
      if (w.chaport) return;
      v3 = (w.chaport = {});
      v3._q = [];
      v3._l = {};
      v3.q = function () { v3._q.push(arguments); };
      v3.on = function (e, fn) {
        if (!v3._l[e]) v3._l[e] = [];
        v3._l[e].push(fn);
      };
      var s = d.createElement("script");
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://app.chaport.com/javascripts/insert.js";
      var ss = d.getElementsByTagName("script")[0];
      ss.parentNode.insertBefore(s, ss);
    })(window, document);
  </script>

  <!-- Audio -->
  <audio id="bgMusic" loop playsinline preload="auto"></audio>
  <audio id="spinSound" playsinline preload="auto"></audio>
  <audio id="tickSound" playsinline preload="auto"></audio>
  <audio id="winSound" playsinline preload="auto"></audio>
  <audio id="historySound" playsinline preload="auto"></audio>

  <script defer src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>
</body>

<script>

/* ======================================================================
 * 0) CONFIG + CONST — POWER UP (AUTO FOCUS WHEEL + STABILITY)
 * ✅ Tambah CONFIG.FOCUS (auto-detect wheel aktif + spotlight + auto scroll)
 * ✅ applyWheelRotation() support #wheelInner dan #wheel (anti mismatch id)
 * ✅ DOM boot lebih aman (guard elemen null)
 * ✅ Wheel Focus overlay ringan (tanpa blur/halo aneh)
 * ====================================================================== */

/* =========================================================
 * 0) CONFIG + CONST
 * ======================================================= */
const CONFIG = {
  SPIN_DURATION_MS: 6000,
  CLAIM_URL: "https://newmadetoto2.com/",
  CLAIM_OVERLAY_MIN_MS: 700,

  LS_PREFIX: "mt2_spin_v2:",
  PRIZES: ["25K", "50K", "75K", "100K", "200K", "BONUS 10%"],
  BONUS_LABEL: "BONUS 10%",

  PRIZE_DISPLAY_MAP: {
    "25K": "IDR 25.000",
    "50K": "IDR 50.000",
    "75K": "IDR 75.000",
    "100K": "IDR 100.000",
    "200K": "IDR 200.000",
    "BONUS 10%": "BONUS 10%",
  },

  AUDIO: {
    bg: "https://cdn.pixabay.com/download/audio/2022/03/24/audio_197846c632.mp3?filename=casino-music-1-2518.mp3",
    spin: "https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3",
    win: "https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3",
    tick: "https://assets.mixkit.co/active_storage/sfx/2063/2063-preview.mp3",
    history: "https://assets.mixkit.co/active_storage/sfx/2014/2014-preview.mp3",
    vol: { bg: 0.22, spin: 0.6, win: 0.85, tick: 0.55, history: 0.62 }
  },

  /* =========================================================
   * FOCUS WHEEL — POWER UP (AUTO DETECT + AUTO SCROLL + SPOTLIGHT)
   * ======================================================= */
  FOCUS: {
    ENABLED: true,

    // behavior
    AUTO_SCROLL: true,
    SCROLL_BEHAVIOR: "smooth",      // "smooth" | "auto"
    SCROLL_BLOCK: "center",
    MIN_VISIBLE_RATIO: 0.62,        // kalau wheel kurang terlihat -> auto scroll

    // visual (ringan: radial overlay tanpa blur)
    MODE: "spotlight",              // "spotlight" | "scrollOnly"
    DIM_OPACITY: 0.56,              // 0..1
    INNER_CLEAR_PX: 170,            // area terang sekitar wheel
    OUTER_DARK_PX: 380,             // radius gelap (lebih soft)

    // elevate wheel
    SCALE: 1.025,
    TRANSITION_MS: 260,

    // stability
    RELEASE_DELAY_MS: 220,          // anti flicker
    COOLDOWN_MS: 600,               // anti spam scroll

    // optional focus
    KEYBOARD_FOCUS: false
  }
};

const LS = {
  HAS_SPUN: CONFIG.LS_PREFIX + "hasSpun",
  SPIN_AT: CONFIG.LS_PREFIX + "spinAt",
  LAST_USER_ID: CONFIG.LS_PREFIX + "lastUserId",
  JACKPOT_VAL: CONFIG.LS_PREFIX + "jackpotVal",
  ROTATION: CONFIG.LS_PREFIX + "rotation"
};

const PRIZES = CONFIG.PRIZES.slice();
const BONUS_LABEL = CONFIG.BONUS_LABEL;
const BONUS_INDEX = PRIZES.indexOf(BONUS_LABEL);

/* =========================================================
 * 1) STORAGE HELPERS + MIGRATION
 * ======================================================= */
function lsGet(key, fallback = "") {
  try {
    const v = localStorage.getItem(key);
    return (v == null ? fallback : v);
  } catch (_) { return fallback; }
}

function lsSet(key, value) {
  try { localStorage.setItem(key, String(value)); } catch (_) {}
}

function migrateLegacyKeys() {
  const legacy = {
    hasSpun: "hasSpun",
    spinAt: "spinAt",
    lastUserId: "lastUserId",
    jackpotVal: "jackpotVal",
    rotation: "rotation"
  };

  // keep behavior sama (cuma dirapikan)
  const pairs = [
    [LS.HAS_SPUN, legacy.hasSpun],
    [LS.SPIN_AT, legacy.spinAt],
    [LS.LAST_USER_ID, legacy.lastUserId],
    [LS.JACKPOT_VAL, legacy.jackpotVal],
    [LS.ROTATION, legacy.rotation],
  ];

  for (const [newK, oldK] of pairs) {
    if (!lsGet(newK, "") && lsGet(oldK, "")) lsSet(newK, lsGet(oldK, ""));
  }
}

migrateLegacyKeys();

/* =========================================================
 * 2) STATE (GLOBAL)
 * ======================================================= */
let hasSpun = (lsGet(LS.HAS_SPUN, "false") === "true");
let spinAt = Number(lsGet(LS.SPIN_AT, "0") || "0") || 0;
let savedUserId = String(lsGet(LS.LAST_USER_ID, "") || "");

let isSpin = false;
let currentRotation = Number(lsGet(LS.ROTATION, "0") || "0") || 0;
let lastResult = null;

let winners = [];
let liveTimer = 0;

let rowElById = new Map();
let winnersById = new Map();

let jackpotTimer = 0;
let jackpotSaveTimer = 0;
let jackpot = 0;

let spikeUntilMs = 0;
let spikeMul = 1;

let toastTimer = 0;
let metaTimer = 0;

let lastFocusedEl = null;

let tickPool = [];
let tickPoolIdx = 0;

let historyPool = [];
let historyPoolIdx = 0;
let historySfxAt = 0;

let nonUserToastAt = 0;
let audioPrimed = false;
let bgStarted = false;

let pointerEl = null;
let pointerKickT = 0;

// spin token + tick timers (cancel ghost ticks)
let spinToken = 0;
let tickTimers = [];

// live winners uniqueness (keep last 70)
const recentMasked = new Set();
const recentMaskedQueue = [];

// pause reasons for live history
const pauseReasons = new Set();

function pauseHistory(reason) {
  pauseReasons.add(String(reason || "x"));
  stopLiveHistory();
}

function resumeHistory(reason) {
  pauseReasons.delete(String(reason || "x"));
  if (pauseReasons.size === 0 && !document.hidden) startLiveHistory();
}

// inert reasons (modal/nav)
const inertReasons = new Set();

function setInert(reason, on) {
  const main = document.getElementById("mainContainer");
  if (!main) return;

  const r = String(reason || "x");
  if (on) inertReasons.add(r);
  else inertReasons.delete(r);

  const should = inertReasons.size > 0;
  try {
    if (should) {
      main.setAttribute("inert", "");
      main.setAttribute("aria-hidden", "true");
    } else {
      main.removeAttribute("inert");
      main.removeAttribute("aria-hidden");
    }
  } catch (_) {}
}

/* =========================================================
 * 3) SMALL UTILS
 * ======================================================= */
function normalizeUserIdInput(v) {
  return String(v == null ? "" : v).replace(/\s+/g, "").slice(0, 20);
}

function isReducedMotion() {
  return !!(window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches);
}

// Low-end heuristic for stability
function detectLowEnd() {
  try {
    const devMem = Number(navigator.deviceMemory || 0) || 0;
    const cores = Number(navigator.hardwareConcurrency || 0) || 0;
    const saveData = !!(navigator.connection && navigator.connection.saveData);

    const low = (saveData) || (devMem && devMem <= 2) || (cores && cores <= 4);
    if (low) document.body.classList.add("low-end");
  } catch (_) {}
}

/* =========================================================
 * 3.5) WHEEL AUTO FOCUS — POWER UP (AUTO DETECT ACTIVE SPIN)
 * ======================================================= */
let __wfInit = false;
let __wfOn = false;
let __wfRaf = 0;
let __wfObs = null;
let __wfReleaseT = 0;
let __wfLastScrollAt = 0;

let __wfOverlay = null;
let __wfRaisedWrap = null;

function __wfCfg() {
  const F = (CONFIG && CONFIG.FOCUS) ? CONFIG.FOCUS : null;
  return (F && F.ENABLED) ? F : null;
}

function __wfIsLowEnd() {
  try { return document.body.classList.contains("low-end"); } catch (_) { return false; }
}

function __wfGetWrap() {
  return document.getElementById("wheelWrap") || document.getElementById("wheelWrap") || document.querySelector(".wheel-wrapper") || null;
}

function __wfGetWheelEl() {
  // support 2 id yang sering kepakai di versi kamu
  return document.getElementById("wheelInner") || document.getElementById("wheel") || document.querySelector("#wheelInner, #wheel") || null;
}

function __wfEnsureOverlay() {
  if (__wfOverlay) return __wfOverlay;

  const ov = document.createElement("div");
  ov.id = "mt2WheelFocusOverlay";
  ov.setAttribute("aria-hidden", "true");

  // Overlay ringan: radial dim tanpa blur/backdrop-filter (anti “bayangan aneh”)
  ov.style.cssText = [
    "position:fixed",
    "inset:0",
    "pointer-events:none",
    "opacity:0",
    "z-index:160", // di atas konten biasa
    "will-change:opacity,background",
    "transition:opacity 260ms cubic-bezier(0.2,0.9,0.2,1)",
    "background:radial-gradient(circle at 50% 50%, rgba(0,0,0,0) 0 170px, rgba(0,0,0,0.56) 380px)"
  ].join(";");

  document.body.appendChild(ov);
  __wfOverlay = ov;
  return ov;
}

function __wfVisibleRatio(el) {
  if (!el) return 0;
  const r = el.getBoundingClientRect();
  const vh = window.innerHeight || document.documentElement.clientHeight || 0;
  const vw = window.innerWidth || document.documentElement.clientWidth || 0;
  if (!vh || !vw || r.width <= 0 || r.height <= 0) return 0;

  const top = Math.max(0, r.top);
  const bottom = Math.min(vh, r.bottom);
  const visibleH = Math.max(0, bottom - top);
  return Math.max(0, Math.min(1, visibleH / r.height));
}

function __wfScheduleOverlayUpdate(wrap) {
  if (!wrap || !__wfOn || !__wfOverlay) return;
  if (__wfRaf) return;

  __wfRaf = requestAnimationFrame(() => {
    __wfRaf = 0;

    const F = __wfCfg();
    if (!F || !__wfOn || !__wfOverlay) return;

    const r = wrap.getBoundingClientRect();
    const vw = window.innerWidth || 1;
    const vh = window.innerHeight || 1;

    const cx = Math.round(((r.left + r.width / 2) / vw) * 1000) / 10; // %
    const cy = Math.round(((r.top + r.height / 2) / vh) * 1000) / 10; // %

    const dim = Math.max(0, Math.min(1, Number(F.DIM_OPACITY || 0.56)));
    const inner = Math.max(80, Number(F.INNER_CLEAR_PX || 170));
    const outer = Math.max(inner + 60, Number(F.OUTER_DARK_PX || 380));

    __wfOverlay.style.background =
      `radial-gradient(circle at ${cx}% ${cy}%, rgba(0,0,0,0) 0 ${inner}px, rgba(0,0,0,${dim}) ${outer}px)`;
  });
}

function __wfRaiseWrap(wrap) {
  if (!wrap) return;
  if (__wfRaisedWrap === wrap) return;

  __wfUnraiseWrap();

  __wfRaisedWrap = wrap;

  const F = __wfCfg();
  const t = Math.max(120, Number(F.TRANSITION_MS || 260));
  const s = Math.max(1, Number(F.SCALE || 1.025));

  // pastikan bisa naik z-index
  const pos = getComputedStyle(wrap).position;
  if (pos === "static") wrap.style.position = "relative";

  wrap.style.zIndex = "170"; // di atas overlay(160)
  wrap.style.willChange = "transform, filter";
  wrap.style.transition = `transform ${t}ms cubic-bezier(0.2,0.9,0.2,1), filter ${t}ms cubic-bezier(0.2,0.9,0.2,1)`;
  wrap.style.transform = `translateZ(0) scale(${s})`;

  // shadow premium tipis (tanpa blur putih)
  wrap.style.filter =
    "drop-shadow(0 24px 88px rgba(0,0,0,0.62)) drop-shadow(0 0 44px rgba(59,224,123,0.14))";
}

function __wfUnraiseWrap() {
  const wrap = __wfRaisedWrap;
  if (!wrap) return;

  wrap.style.transform = "";
  wrap.style.filter = "";
  wrap.style.zIndex = "";
  wrap.style.willChange = "";
  wrap.style.transition = "";

  __wfRaisedWrap = null;
}

function __wfSpinActive() {
  // auto-detect: isSpin OR class markers
  let active = false;

  try { if (isSpin) active = true; } catch (_) {}

  const wheel = __wfGetWheelEl();
  const wrap = __wfGetWrap();

  try {
    if (wheel && wheel.classList.contains("spinning")) active = true;
    if (wrap && wrap.classList.contains("spinning")) active = true;
    if (pointerEl && pointerEl.classList.contains("is-spin")) active = true;
  } catch (_) {}

  return { active, wrap };
}

function wheelFocusRequest(on, reason) {
  const F = __wfCfg();
  if (!F) return;

  // jangan ganggu modal
  try { if (typeof isModalOpen === "function" && isModalOpen()) return; } catch (_) {}

  const reduce = isReducedMotion();
  const lowEnd = __wfIsLowEnd();

  const st = __wfSpinActive();
  const wrap = st.wrap;

  if (on) {
    // auto scroll kalau wheel nggak keliatan
    if (F.AUTO_SCROLL && wrap) {
      const now = Date.now();
      const cool = Math.max(0, Number(F.COOLDOWN_MS || 600));
      if (now - __wfLastScrollAt > cool) {
        const ratio = __wfVisibleRatio(wrap);
        if (ratio < Number(F.MIN_VISIBLE_RATIO || 0.62)) {
          try {
            wrap.scrollIntoView({ behavior: F.SCROLL_BEHAVIOR || "smooth", block: F.SCROLL_BLOCK || "center" });
            __wfLastScrollAt = now;
          } catch (_) {}
        }
      }
    }

    __wfOn = true;

    if (!reduce && !lowEnd && (F.MODE || "spotlight") === "spotlight") {
      const ov = __wfEnsureOverlay();
      ov.style.transitionDuration = `${Math.max(120, Number(F.TRANSITION_MS || 260))}ms`;
      ov.style.opacity = "1";
    }

    if (!reduce && wrap) __wfRaiseWrap(wrap);
    if (wrap && __wfOverlay) __wfScheduleOverlayUpdate(wrap);

    if (F.KEYBOARD_FOCUS && wrap) {
      try {
        if (!wrap.hasAttribute("tabindex")) wrap.setAttribute("tabindex", "-1");
        wrap.focus({ preventScroll: true });
      } catch (_) {}
    }

    return;
  }

  clearTimeout(__wfReleaseT);
  __wfReleaseT = setTimeout(() => {
    __wfOn = false;
    if (__wfOverlay) __wfOverlay.style.opacity = "0";
    __wfUnraiseWrap();

    // optional restore focus
    try {
      if (lastFocusedEl && typeof lastFocusedEl.focus === "function") {
        lastFocusedEl.focus({ preventScroll: true });
      }
    } catch (_) {}
  }, Math.max(0, Number(F.RELEASE_DELAY_MS || 220)));
}

function __wfAutoDetectTick() {
  const F = __wfCfg();
  if (!F) return;

  // kalau modal terbuka, matiin spotlight biar nggak ganggu
  try {
    if (typeof isModalOpen === "function" && isModalOpen()) {
      wheelFocusRequest(false, "modal");
      return;
    }
  } catch (_) {}

  const st = __wfSpinActive();
  if (st.active) {
    wheelFocusRequest(true, "auto");
    if (st.wrap) __wfScheduleOverlayUpdate(st.wrap);
  } else {
    wheelFocusRequest(false, "auto");
  }
}

function initWheelFocusPowerUp() {
  if (__wfInit) return;
  __wfInit = true;

  const F = __wfCfg();
  if (!F) return;

  const onMove = () => {
    if (!__wfOn) return;
    const wrap = __wfGetWrap();
    if (wrap && __wfOverlay) __wfScheduleOverlayUpdate(wrap);
  };

  window.addEventListener("scroll", onMove, { passive: true });
  window.addEventListener("resize", onMove, { passive: true });

  document.addEventListener("visibilitychange", () => {
    if (document.hidden) wheelFocusRequest(false, "hidden");
  });

  // track last focused element (berguna kalau kamu aktifkan restore focus)
  document.addEventListener("focusin", (e) => {
    try {
      if (e && e.target && e.target !== document.body) lastFocusedEl = e.target;
    } catch (_) {}
  }, { passive: true });

  // MutationObserver untuk class toggles
  try {
    const wrap = __wfGetWrap();
    const wheel = __wfGetWheelEl();
    const ptr = pointerEl || document.getElementById("pointerEl");

    __wfObs = new MutationObserver(() => __wfAutoDetectTick());
    if (wrap) __wfObs.observe(wrap, { attributes: true, attributeFilter: ["class", "style"] });
    if (wheel) __wfObs.observe(wheel, { attributes: true, attributeFilter: ["class", "style"] });
    if (ptr) __wfObs.observe(ptr, { attributes: true, attributeFilter: ["class", "style"] });
  } catch (_) {}

  // fallback ticker (kalau class spinning nggak konsisten)
  setInterval(() => {
    if (!__wfCfg()) return;
    __wfAutoDetectTick();
  }, 250);

  // initial check
  __wfAutoDetectTick();
}

/* =========================================================
 * 4) DOM BOOT
 * ======================================================= */
document.addEventListener("DOMContentLoaded", () => {
  detectLowEnd();

  const spinBtn = document.getElementById("spinBtn");
  const userIdInput = document.getElementById("userIdInput");
  const claimBtn = document.getElementById("claimBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  pointerEl = document.getElementById("pointerEl");

  // POWER UP: auto-detect wheel aktif + auto focus spotlight
  initWheelFocusPowerUp();

  setupAudio();
  drawWheelPrizes();
  initWheelAutoResize();
  initFxParticlesCanvas();
  safeScheduleWheelBuild("boot");

  // winners seed + persist user entry
  winners = generateMockWinnersRandom();
  bootPersistedUserEntry();

  // apply persisted rotation to wheel (most feelable fix)
  applyWheelRotation(currentRotation);

  renderWinners({ preserveScroll: true });
  startMetaTicker();
  setupHistoryRowOpen();

  updateUI();
  jackpot = initJackpot();
  startJackpot();
  startLiveHistory();

  if (userIdInput) {
    userIdInput.addEventListener("input", () => {
      userIdInput.value = normalizeUserIdInput(userIdInput.value);
    });

    userIdInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); startSpin(); }
    });
  }

  if (spinBtn) {
    spinBtn.addEventListener("click", startSpin);
    spinBtn.addEventListener("pointerdown", (e) => pressFX(spinBtn, e), { passive: true });
  }

  if (claimBtn) {
    claimBtn.addEventListener("click", claimPrize);
    claimBtn.addEventListener("pointerdown", (e) => pressFX(claimBtn, e), { passive: true });
  }

  if (downloadBtn) {
    downloadBtn.addEventListener("click", downloadResultPng);
    downloadBtn.addEventListener("pointerdown", (e) => pressFX(downloadBtn, e), { passive: true });
  }

  const prizeModal = document.getElementById("prizeModal");
  if (prizeModal) {
    prizeModal.addEventListener("click", (e) => {
      if (e.target && e.target.id === "prizeModal") closeModal();
    });
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      if (typeof isModalOpen === "function" && isModalOpen()) closeModal();
      return;
    }
    // Focus trap for modal
    if (e.key === "Tab" && typeof isModalOpen === "function" && isModalOpen()) {
      trapFocus(e);
    }
  });

  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      stopLiveHistory();
      stopJackpot();
      // fokus off biar nggak nyangkut kalau user balik
      wheelFocusRequest(false, "hidden");
    } else {
      startJackpot();
      if (pauseReasons.size === 0) startLiveHistory();
    }
  });

  // Prime audio on first gesture only (cleaner UX)
  const kick = () => kickAudio(true);
  window.addEventListener("pointerdown", kick, { passive: true, once: true });
  window.addEventListener("keydown", kick, { passive: true, once: true });

  window.addEventListener("pageshow", () => { hideNavLoading(true); });

  // multi-tab sync
  window.addEventListener("storage", (e) => {
    if (!e || !e.key) return;

    if (
      e.key === LS.HAS_SPUN ||
      e.key === LS.SPIN_AT ||
      e.key === LS.LAST_USER_ID ||
      e.key === LS.ROTATION
    ) {
      hasSpun = (lsGet(LS.HAS_SPUN, "false") === "true");
      spinAt = Number(lsGet(LS.SPIN_AT, "0") || "0") || 0;
      savedUserId = String(lsGet(LS.LAST_USER_ID, "") || "");
      currentRotation = Number(lsGet(LS.ROTATION, "0") || "0") || 0;

      bootPersistedUserEntry();
      applyWheelRotation(currentRotation);
      updateUI();
      renderWinners({ preserveScroll: true });
    }

    if (e.key === LS.JACKPOT_VAL) {
      const v = Number(lsGet(LS.JACKPOT_VAL, "0") || "0") || 0;
      if (v > 1000000) {
        jackpot = v;
        const el = document.getElementById("jackpot");
        const meta = document.getElementById("jackpotMeta");
        if (el) el.textContent = `IDR ${Math.round(jackpot).toLocaleString("id-ID")}`;
        if (meta) meta.textContent = `Update: ${fmtClock()}`;
      }
    }
  });
});

/* =========================================================
 * 5) WHEEL ROTATION PERSIST — POWER (stable + crisp)
 * ======================================================= */
function applyWheelRotation(deg) {
  // support #wheelInner dan #wheel (biar aman di semua versi DOM kamu)
  const wheel = document.getElementById("wheelInner") || document.getElementById("wheel");
  if (!wheel) return;

  wheel.classList.remove("spinning");

  const v = Number(deg || 0);
  const vv = Number.isFinite(v) ? v : 0;

  // micro clamp biar transform string stabil (hindari jitter float panjang)
  const snapped = Math.round(vv * 1000) / 1000;

  wheel.style.transform = `rotate(${snapped}deg) translateZ(0)`;
}

function saveRotation(deg) {
  const v = Number(deg || 0);
  currentRotation = Number.isFinite(v) ? v : 0;
  lsSet(LS.ROTATION, String(currentRotation));
}

/* =========================================================
 * 6) FX CANVAS (auto low-end + pause on hidden)
 * ======================================================= */
function initFxParticlesCanvas() {
  const c = document.getElementById("fxCanvas");
  if (!c) return;

  const ctx = c.getContext("2d", { alpha: true });
  if (!ctx) return;

  if (isReducedMotion()) { c.style.display = "none"; return; }

  const devMem = Number(navigator.deviceMemory || 0) || 4;
  const cores = Number(navigator.hardwareConcurrency || 0) || 6;
  const saveData = !!(navigator.connection && navigator.connection.saveData);
  const lowEnd = saveData || (devMem <= 2) || (cores <= 4);

  let w = 0, h = 0, dpr = 1;
  const parts = [];
  const maxParts = lowEnd ? 54 : 84;

  let rafId = 0;
  let running = true;

  const resize = () => {
    const dprCap = lowEnd ? 1.4 : 2;
    dpr = Math.min(dprCap, window.devicePixelRatio || 1);

    w = Math.max(1, Math.floor(window.innerWidth));
    h = Math.max(1, Math.floor(window.innerHeight));

    c.width = Math.floor(w * dpr);
    c.height = Math.floor(h * dpr);
    c.style.width = w + "px";
    c.style.height = h + "px";

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  };

  const rand = (a, b) => a + Math.random() * (b - a);
  const pick = (arr) => arr[(Math.random() * arr.length) | 0];

  const spawn = () => {
    parts.push({
      x: rand(-40, w + 40),
      y: rand(-40, h + 40),
      r: rand(0.7, 2.3),
      vy: rand(-0.14, -0.04),
      vx: rand(-0.06, 0.06),
      a: rand(0.14, 0.52),
      tw: rand(0.004, 0.010),
      ph: rand(0, Math.PI * 2),
      hue: pick([120, 140, 45, 50, 160]),
      life: rand(2400, 5200),
      t: 0
    });
  };

  const ensure = () => { while (parts.length < maxParts) spawn(); };

  const draw = (dt) => {
    ctx.clearRect(0, 0, w, h);

    const g = ctx.createRadialGradient(
      w * 0.5, h * 0.28, 0,
      w * 0.5, h * 0.28, Math.max(w, h) * 0.55
    );
    g.addColorStop(0, "rgba(34,197,94,0.075)");
    g.addColorStop(1, "rgba(0,0,0,0)");

    ctx.fillStyle = g;
    ctx.fillRect(0, 0, w, h);

    for (let i = parts.length - 1; i >= 0; i--) {
      const p = parts[i];
      p.t += dt;

      p.x += p.vx * dt;
      p.y += p.vy * dt;

      const tw = (Math.sin(p.ph + p.t * p.tw) * 0.5 + 0.5);
      const alpha = Math.max(0, Math.min(1, p.a * (0.55 + tw * 0.65) * (1 - (p.t / p.life))));
      const rr = p.r * (0.85 + tw * 0.65);

      ctx.beginPath();
      ctx.fillStyle = `hsla(${p.hue}, 80%, 70%, ${alpha})`;
      ctx.arc(p.x, p.y, rr, 0, Math.PI * 2);
      ctx.fill();

      ctx.globalAlpha = alpha * 0.28;
      ctx.strokeStyle = `hsla(${p.hue}, 85%, 78%, 1)`;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(p.x - rr * 2.2, p.y);
      ctx.lineTo(p.x + rr * 2.2, p.y);
      ctx.moveTo(p.x, p.y - rr * 2.2);
      ctx.lineTo(p.x, p.y + rr * 2.2);
      ctx.stroke();
      ctx.globalAlpha = 1;

      if (p.t >= p.life || p.y < -80) {
        parts.splice(i, 1);
        spawn();
      }
    }
  };

  let last = performance.now();

  const tick = () => {
    if (!running) return;
    const now = performance.now();
    const dt = Math.min(34, now - last);
    last = now;

    ensure();
    draw(dt);

    rafId = requestAnimationFrame(tick);
  };

  const stop = () => {
    running = false;
    if (rafId) cancelAnimationFrame(rafId);
    rafId = 0;
  };

  const start = () => {
    if (running) return;
    running = true;
    last = performance.now();
    rafId = requestAnimationFrame(tick);
  };

  resize();
  window.addEventListener("resize", resize, { passive: true });

  document.addEventListener("visibilitychange", () => {
    if (document.hidden) stop();
    else start();
  });

  rafId = requestAnimationFrame(tick);
}

/* =========================================================
 * 7) AUDIO (clean start on first gesture)
 * ======================================================= */
function setupAudio() {
  const bgMusic = document.getElementById("bgMusic");
  const spinSound = document.getElementById("spinSound");
  const tickSound = document.getElementById("tickSound");
  const winSound = document.getElementById("winSound");
  const historySound = document.getElementById("historySound");

  if (!bgMusic || !spinSound || !tickSound || !winSound || !historySound) return;

  bgMusic.src = CONFIG.AUDIO.bg;
  spinSound.src = CONFIG.AUDIO.spin;
  winSound.src = CONFIG.AUDIO.win;
  tickSound.src = CONFIG.AUDIO.tick;
  historySound.src = CONFIG.AUDIO.history;

  bgMusic.volume = CONFIG.AUDIO.vol.bg;
  spinSound.volume = CONFIG.AUDIO.vol.spin;
  winSound.volume = CONFIG.AUDIO.vol.win;
  tickSound.volume = CONFIG.AUDIO.vol.tick;
  historySound.volume = CONFIG.AUDIO.vol.history;

  tickPool = [];
  for (let i = 0; i < 6; i++) {
    const a = new Audio(tickSound.src);
    a.volume = tickSound.volume;
    a.preload = "auto";
    tickPool.push(a);
  }

  historyPool = [];
  for (let i = 0; i < 4; i++) {
    const a = new Audio(historySound.src);
    a.volume = historySound.volume;
    a.preload = "auto";
    historyPool.push(a);
  }
}

function primeAudioPool(pool) {
  pool.forEach((a) => {
    try {
      const prevMuted = a.muted;
      a.muted = true;
      a.play().then(() => {
        a.pause();
        a.currentTime = 0;
        a.muted = prevMuted;
      }).catch(() => { a.muted = prevMuted; });
    } catch (_) {}
  });
}

function kickAudio(withBgStart = false) {
  if (!audioPrimed) {
    audioPrimed = true;
    primeAudioPool(tickPool);
    primeAudioPool(historyPool);
  }
  if (!withBgStart) return;

  if (!bgStarted) {
    bgStarted = true;
    const bgMusic = document.getElementById("bgMusic");
    if (bgMusic && bgMusic.paused) {
      bgMusic.play().then(() => {
        // optional: tiny confirmation (tidak ganggu)
        showToast("Audio aktif", "success", 1400);
      }).catch(() => {});
    }
  }
}

function pointerKick(intensity = 1) {
  if (!pointerEl) return;
  if (pointerKickT) clearTimeout(pointerKickT);

  // micro random for realism
  const deg = (-8 - Math.random() * 6) * intensity; // -8..-14
  pointerEl.style.setProperty("--kick-deg", deg.toFixed(2) + "deg");

  pointerEl.classList.remove("is-kick");
  void pointerEl.offsetWidth;
  pointerEl.classList.add("is-kick");

  pointerKickT = setTimeout(() => pointerEl && pointerEl.classList.remove("is-kick"), 140);
}

function playTick(intensity = 1) {
  pointerKick(intensity);
  try {
    const a = tickPool[tickPoolIdx++ % tickPool.length];
    a.currentTime = 0;
    a.play().catch(() => {});
  } catch (_) {}
}

function playHistorySfx() {
  const now = Date.now();
  if (now - historySfxAt < 700) return;
  historySfxAt = now;
  try {
    const a = historyPool[historyPoolIdx++ % historyPool.length];
    a.currentTime = 0;
    a.play().catch(() => {});
  } catch (_) {}
}

/* =========================================================
 * 8) BUTTON FX + TOAST
 * ======================================================= */
function pressFX(btn, ev) {
  if (!btn) return;

  const rect = btn.getBoundingClientRect();
  let x = rect.width / 2, y = rect.height / 2;

  if (ev && ev.clientX != null && ev.clientY != null) {
    x = ev.clientX - rect.left;
    y = ev.clientY - rect.top;
  }

  btn.style.setProperty("--fx-x", x + "px");
  btn.style.setProperty("--fx-y", y + "px");

  btn.classList.remove("fx");
  void btn.offsetWidth;
  btn.classList.add("fx");

  setTimeout(() => btn.classList.remove("fx"), 560);

  try { if (navigator.vibrate && !isReducedMotion()) navigator.vibrate(12); } catch (_) {}
}

function showToast(message, type = "info", ms = 2400) {
  const toast = document.getElementById("toast");
  const msg = document.getElementById("toastMsg");
  if (!toast || !msg) return;

  toast.classList.remove("error", "success");
  if (type === "error") toast.classList.add("error");
  if (type === "success") toast.classList.add("success");

  msg.textContent = String(message || "");
  toast.classList.add("show");

  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove("show"), ms);
}

/* =========================================================
 * 9) WHEEL SVG + LABELS — CASINO 1:1 (PREMIUM HD) — POWER UP v12.2 (FULL REPLACE)
 * Fokus: SUPER SMOOTH MOBILE + ✅ HILANGKAN “bayangan putih / blur” DI BELAKANG WHEEL
 *
 * v12.2 changes:
 * ✅ Anti white-blur: SVG di-CLIP ke lingkaran wheel (tidak ada glow/filter bleed keluar)
 * ✅ Bulbs bloom selalu di-band-limit (tidak “kabut putih” melebar)
 * ✅ Rebuild: rAF + settle + idle (tidak rebut input)
 * ✅ RO + VV + orientation + visibility + pageshow + IO (anti rebuild spam, hemat)
 * ✅ Noise auto OFF mobile + tier low/med (tetap seperti v12)
 * ======================================================= */

/* =========================
 * Background safety
 * ======================= */
function setWheelBackground() {
  const wheel = document.getElementById("wheel");
  if (!wheel) return;
  wheel.style.setProperty("--wheel-bg", "transparent");
  wheel.style.background = "transparent";
}

/* =========================
 * HARD CLIP host (anti blur bleed)
 * - memastikan SVG glow/filter tidak “keluar” jadi halo putih mengganggu
 * ======================= */
function ensureWheelClipHost(wheelEl){
  if (!wheelEl || wheelEl.__mt2ClipHostDone) return;
  wheelEl.__mt2ClipHostDone = true;
  try {
    const cs = getComputedStyle(wheelEl);
    if (cs.borderRadius === "0px" || cs.borderRadius === "0") wheelEl.style.borderRadius = "50%";
    if (cs.overflow !== "hidden") wheelEl.style.overflow = "hidden";
    wheelEl.style.backgroundClip = "padding-box";
    wheelEl.style.transform = wheelEl.style.transform || "translateZ(0)";
  } catch (_) {}
}

/* =========================
 * Safe prizes getter (ANTI ReferenceError)
 * ======================= */
function _getPrizesSafe() {
  const wp = (typeof window !== "undefined") ? window.PRIZES : undefined;
  if (Array.isArray(wp) && wp.length) return wp;

  try {
    const cfg = (typeof window !== "undefined") ? window.CONFIG : undefined;
    if (cfg && Array.isArray(cfg.PRIZES) && cfg.PRIZES.length) return cfg.PRIZES;
  } catch (_) {}

  try {
    // eslint-disable-next-line no-undef
    if (typeof PRIZES !== "undefined" && Array.isArray(PRIZES) && PRIZES.length) return PRIZES;
  } catch (_) {}

  return ["BONUS 10%"];
}

/* =========================
 * Rotation bridge (STATIC lighting support)
 * - FIX: tidak overwrite transform #wheel (fallback jadi pending)
 * ======================= */
function setWheelRotationSVG(deg, opt = {}) {
  const wheel = document.getElementById("wheel");
  if (!wheel) return false;

  const d = Number(deg || 0);
  if (!Number.isFinite(d)) return false;

  wheel.__mt2PendingRotation = d;

  try { wheel.style.setProperty("--mt2-wheel-rot", `${d}deg`); } catch (_) {}

  const svg = wheel.__mt2WheelSvg;
  const api = (svg && svg.__wheel) || wheel.__mt2WheelApi;

  if (api && typeof api.setRotation === "function") {
    api.setRotation(d, opt);
    return true;
  }
  return false;
}

/* =========================
 * Draw wheel (build/rebuild) — stable + guarded + idle-friendly
 * ======================= */
function drawWheelPrizes() {
  const wheel = document.getElementById("wheel");
  if (!wheel) return;

  if (document.hidden) return;

  // skip jika tidak terlihat (anti rebuild saat scroll)
  try {
    const r = wheel.getBoundingClientRect();
    if (r.width < 10 || r.height < 10) return;
  } catch (_) {}

  ensureWheelClipHost(wheel);
  setWheelBackground();

  const wrap = document.getElementById("wheelWrap") || wheel;

  // pastikan position tidak static sekali saja
  try {
    if (!wheel.__mt2PosFixed) {
      const cs = getComputedStyle(wheel);
      if (cs.position === "static") wheel.style.position = "relative";
      wheel.__mt2PosFixed = true;
    }
  } catch (_) {}

  const prizes = _getPrizesSafe();

  const w = Math.round(wrap.clientWidth || 0);
  const h = Math.round(wrap.clientHeight || 0);
  const size = Math.max(0, Math.min(w, h));
  if (!size || size < 160) return;

  const ST = window.__MT2_WHEEL_CASINO || (window.__MT2_WHEEL_CASINO = {});
  if (ST._drawing) return;

  const perfMode = "auto";
  const tierNow = detectPerfTier(perfMode);
  const rm = matchReduceMotion() ? 1 : 0;

  const nav = (typeof navigator !== "undefined") ? navigator : {};
  const ua = String(nav.userAgent || "");
  const isMobileUA = /Android|iPhone|iPad|iPod/i.test(ua);

  const hasHtmlHub = !!(document.querySelector && document.querySelector(".wheel-center"));
  const includeHub = !hasHtmlHub;

  const opt = {
    uprightLabels: true,
    perf: perfMode,
    includeHub,

    // Bulbs
    animateBulbs: !rm && tierNow !== "low",
    bulbBandMask: true,               // ✅ selalu band-limit (anti “kabut putih”)
    bulbGlowFilter: tierNow !== "low", // low: tanpa filter blur besar

    // Noise mahal → OFF mobile & low/med
    noise: (!isMobileUA && tierNow === "high" && !rm)
  };

  const key =
    `${size}` +
    `|${prizes.join("|")}` +
    `|upright:${opt.uprightLabels ? 1 : 0}` +
    `|perf:${perfMode}:${tierNow}` +
    `|rm:${rm}` +
    `|hub:${includeHub ? 1 : 0}` +
    `|ir:${String(opt.innerRadius ?? "")}` +
    `|noise:${opt.noise ? 1 : 0}` +
    `|anim:${opt.animateBulbs ? 1 : 0}` +
    `|band:${opt.bulbBandMask ? 1 : 0}` +
    `|glowf:${opt.bulbGlowFilter ? 1 : 0}`;

  if (ST._lastKey === key) return;
  ST._lastKey = key;

  ST._drawing = true;
  try {
    wheel.querySelectorAll(".prize-text").forEach((el) => el.remove());

    const old = wheel.querySelector("svg.wheel-svg");
    if (old) {
      try { old.__wheel && old.__wheel.destroy && old.__wheel.destroy(); } catch (_) {}
      try { old.remove(); } catch (_) {}
    }

    const svg = buildWheelSVG_CASINO(prizes, opt);

    // ✅ overflow hidden + clip internal = anti blur keluar
    svg.style.cssText =
      "position:absolute;inset:0;width:100%;height:100%;display:block;pointer-events:none;" +
      "transform:translateZ(0);will-change:transform;z-index:0;overflow:hidden;";

    wheel.insertBefore(svg, wheel.firstChild);

    wheel.__mt2WheelSvg = svg;
    wheel.__mt2WheelApi = svg.__wheel;

    const pending = Number(wheel.__mt2PendingRotation);
    let cur = Number.isFinite(pending) ? pending : NaN;

    if (!Number.isFinite(cur)) {
      try { cur = Number((window.S && window.S.currentRotation) || 0); } catch (_) {}
    }
    if (Number.isFinite(cur)) {
      try { setWheelRotationSVG(cur, { force: true }); } catch (_) {}
    }
  } catch (e) {
    try { ST._lastKey = ""; } catch (_) {}
  } finally {
    ST._drawing = false;
  }

  // fonts ready → rebuild sekali (idle)
  if (document.fonts && typeof document.fonts.ready?.then === "function") {
    if (!ST._fontsHooked) {
      ST._fontsHooked = true;
      document.fonts.ready.then(() => {
        try { ST._lastKey = ""; safeScheduleWheelBuild("fonts"); } catch (_) {}
      }).catch(() => {});
    }
  }
}

/* =========================
 * Idle-friendly scheduler (shared)
 * ======================= */
function safeScheduleWheelBuild(reason = "unknown") {
  const ST = window.__MT2_WHEEL_CASINO || (window.__MT2_WHEEL_CASINO = {});
  if (ST._sched) return;
  ST._sched = 1;

  const settle = (reason === "vvScroll") ? 160 : (reason === "orientation") ? 220 : 80;

  const run = () => {
    ST._sched = 0;
    try { drawWheelPrizes(); } catch (_) {}
  };

  const raf = (typeof requestAnimationFrame === "function") ? requestAnimationFrame : (fn) => setTimeout(fn, 16);

  raf(() => {
    if (ST._settleT) { try { clearTimeout(ST._settleT); } catch (_) {} }
    ST._settleT = setTimeout(() => {
      ST._settleT = 0;

      if (typeof requestIdleCallback === "function") {
        try {
          requestIdleCallback(run, { timeout: 260 });
          return;
        } catch (_) {}
      }
      run();
    }, settle);
  });
}

/* =========================
 * Auto resize watcher (RO + VV + DPR/scale) — smooth & conservative
 * ======================= */
function initWheelAutoResize() {
  const wheel = document.getElementById("wheel");
  if (!wheel) return;

  const wrap = document.getElementById("wheelWrap") || wheel;
  const ST = window.__MT2_WHEEL_CASINO || (window.__MT2_WHEEL_CASINO = {});

  // cleanup lama
  if (ST.ro) { try { ST.ro.disconnect(); } catch (_) {} ST.ro = null; }
  if (ST.io) { try { ST.io.disconnect(); } catch (_) {} ST.io = null; }
  if (ST._settleT) { try { clearTimeout(ST._settleT); } catch (_) {} ST._settleT = 0; }
  if (ST.pollT) { try { clearInterval(ST.pollT); } catch (_) {} ST.pollT = 0; }
  if (ST.off) { try { ST.off(); } catch (_) {} ST.off = null; }
  if (ST.vvOff) { try { ST.vvOff(); } catch (_) {} ST.vvOff = null; }
  if (ST.pageOff) { try { ST.pageOff(); } catch (_) {} ST.pageOff = null; }
  if (ST.visOff) { try { ST.visOff(); } catch (_) {} ST.visOff = null; }
  if (ST.orOff) { try { ST.orOff(); } catch (_) {} ST.orOff = null; }

  ST._lastKey = "";
  ST._dpr = window.devicePixelRatio || 1;
  ST._vvScale = (window.visualViewport && window.visualViewport.scale) ? window.visualViewport.scale : 1;
  ST._inView = true;

  const schedule = (why) => {
    if (ST._inView === false && why !== "init" && why !== "pageshow" && why !== "visible") return;
    safeScheduleWheelBuild(why || "resize");
  };

  // IO: kalau wheel keluar viewport, stop rebuild spam (mobile hemat)
  if ("IntersectionObserver" in window) {
    ST.io = new IntersectionObserver((entries) => {
      const e = entries && entries[0];
      const iv = !!(e && (e.isIntersecting || e.intersectionRatio > 0));
      ST._inView = iv;
      if (iv) schedule("visible");
    }, { root: null, threshold: 0.01 });
    try { ST.io.observe(wrap); } catch (_) {}
  }

  if (window.ResizeObserver) {
    ST.ro = new ResizeObserver(() => schedule("ro"));
    try { ST.ro.observe(wrap); } catch (_) {}
  } else {
    const onR = () => schedule("winResize");
    window.addEventListener("resize", onR, { passive: true });
    ST.off = () => window.removeEventListener("resize", onR);
  }

  // VisualViewport (iOS/Android)
  if (window.visualViewport && typeof window.visualViewport.addEventListener === "function") {
    const vv = window.visualViewport;
    const onVVResize = () => schedule("vvResize");

    let vvScrollT = 0;
    const onVVScroll = () => {
      if (vvScrollT) return;
      vvScrollT = setTimeout(() => {
        vvScrollT = 0;
        schedule("vvScroll");
      }, 130);
    };

    vv.addEventListener("resize", onVVResize, { passive: true });
    vv.addEventListener("scroll", onVVScroll, { passive: true });

    ST.vvOff = () => {
      try { vv.removeEventListener("resize", onVVResize); } catch (_) {}
      try { vv.removeEventListener("scroll", onVVScroll); } catch (_) {}
      if (vvScrollT) { try { clearTimeout(vvScrollT); } catch (_) {} vvScrollT = 0; }
    };
  }

  // DPR/scale poll — jarang (hemat)
  ST.pollT = setInterval(() => {
    if (document.hidden) return;
    if (ST._inView === false) return;

    const dpr = window.devicePixelRatio || 1;
    const sc = (window.visualViewport && window.visualViewport.scale) ? window.visualViewport.scale : 1;

    if (Math.abs(dpr - ST._dpr) > 0.01 || Math.abs(sc - ST._vvScale) > 0.01) {
      ST._dpr = dpr;
      ST._vvScale = sc;
      schedule("poll");
    }
  }, 900);

  // pageshow (BFCache iOS) → rebuild
  const onPageShow = () => schedule("pageshow");
  window.addEventListener("pageshow", onPageShow, { passive: true });
  ST.pageOff = () => window.removeEventListener("pageshow", onPageShow);

  // visibilitychange: balik dari background → rebuild halus
  const onVis = () => { if (!document.hidden) schedule("visible"); };
  document.addEventListener("visibilitychange", onVis, { passive: true });
  ST.visOff = () => document.removeEventListener("visibilitychange", onVis);

  // orientationchange (mobile)
  const onOr = () => schedule("orientation");
  window.addEventListener("orientationchange", onOr, { passive: true });
  ST.orOff = () => window.removeEventListener("orientationchange", onOr);

  ST.destroy = () => {
    try { if (ST.ro) ST.ro.disconnect(); } catch (_) {}
    try { if (ST.io) ST.io.disconnect(); } catch (_) {}
    try { if (ST._settleT) clearTimeout(ST._settleT); } catch (_) {}
    try { if (ST.pollT) clearInterval(ST.pollT); } catch (_) {}
    try { if (ST.off) ST.off(); } catch (_) {}
    try { if (ST.vvOff) ST.vvOff(); } catch (_) {}
    try { if (ST.pageOff) ST.pageOff(); } catch (_) {}
    try { if (ST.visOff) ST.visOff(); } catch (_) {}
    try { if (ST.orOff) ST.orOff(); } catch (_) {}
    ST.ro = null; ST.io = null; ST._settleT = 0; ST.pollT = 0;
    ST.off = null; ST.vvOff = null; ST.pageOff = null; ST.visOff = null; ST.orOff = null;
  };

  schedule("init");
}

/* =========================================================
 * SVG BUILDER — CASINO PREMIUM 1:1 — FULL REPLACE (v12.2)
 * HOTFIX: ✅ internal clip wheel circle (anti blur behind)
 * ======================================================= */
function buildWheelSVG_CASINO(prizes, opt = {}) {
  const list = Array.isArray(prizes) ? prizes : [];
  const safePrizes = (list.length ? list : ["-"]).map(v => String(v ?? "").trim() || "-");

  const n = safePrizes.length || 1;
  const seg = 360 / n;

  const NS = "http://www.w3.org/2000/svg";
  const VB = 1000;
  const cx = 500, cy = 500;

  const rOuter = 492;
  const rimW1  = 30;
  const rimW2  = 10;

  const rSegOut = rOuter - (rimW1 + 10);
  const rSegIn  = clampNumber(Number(opt.innerRadius ?? 350), 20, 10);

  const rText = Math.round((rSegIn + rSegOut) * 0.565);
  const dividerW = 2.2;

  const includeHub = (typeof opt.includeHub === "boolean")
    ? opt.includeHub
    : !(typeof document !== "undefined" && document.querySelector && document.querySelector(".wheel-center"));

  const defaultUprightLabels = (opt.uprightLabels === false) ? false : true;

  const perfTier = detectPerfTier(opt.perf);
  const isLow = perfTier === "low";
  const isMed = perfTier === "med";

  const reduceMotion = matchReduceMotion();
  const animateBulbs = (opt.animateBulbs !== false) && !reduceMotion;

  // band-limit bloom/run (anti haze putih)
  const useBulbBandMask = (opt.bulbBandMask !== false);

  // glow filter besar → matikan di low
  const useBulbGlowFilter = (opt.bulbGlowFilter !== false) && !isLow;

  const chaseDurMs = clampNumber(Number(opt.bulbChaseDurMs ?? (isLow ? 2800 : isMed ? 2350 : 2050)), 1200, 9000);
  const chaseStrength = clampNumber(Number(opt.bulbChaseStrength ?? (isLow ? 0.95 : isMed ? 1.05 : 1.16)), 0.35, 1.60);

  // microNoise mahal saat rotate → default: off low/med
  const enableNoise = (opt.noise === true) || (opt.noise !== false && !isLow && !isMed);

  const uid = _wheelUid();
  const ID = (x) => `${uid}_${x}`;

  const E = (tag, attrs = {}) => {
    const el = document.createElementNS(NS, tag);
    for (const k in attrs) el.setAttribute(k, String(attrs[k]));
    return el;
  };

  const PAD = 0;

  const svg = E("svg", {
    class: "wheel-svg",
    viewBox: `0 0 ${VB} ${VB}`,
    preserveAspectRatio: "xMidYMid meet",
    "aria-hidden": "true",
    overflow: "hidden"
  });

  const TXT_SHADOW_Y = isLow ? 2.0 : 3.2;
  const TXT_BLUR_1   = isLow ? 1.7 : 2.6;
  const TXT_BLUR_2   = isLow ? 0.40 : 0.60;

  const GLOW_BLUR_0  = isLow ? 2.4 : isMed ? 3.6 : 5.2;
  const GLOW_BLUR_1  = isLow ? 1.4 : isMed ? 2.0 : 3.0;
  const GLOW_BLUR_2  = isLow ? 0.7 : isMed ? 1.0 : 1.6;

  const SPARK_BLUR   = isLow ? 0.9 : 1.4;

  const BULB_CLIP_R = rOuter + (isLow ? 0.70 : 0.95);
  const BULB_BAND_INNER = rSegOut + (isLow ? 8.2 : isMed ? 7.4 : 6.2);

  const defs = E("defs");
  defs.innerHTML = `
    <style>
      .wheel-rot, .wheel-static { transform-box: fill-box; transform-origin: center; }

      .wheel-bulbs{
        --chaseDur: ${Math.max(0.01, chaseDurMs / 1000).toFixed(3)}s;
        --chaseK: ${chaseStrength.toFixed(3)};
        --winDur: 0.92s;
      }
      .wheel-bulbs[data-anim="0"] .bulb-run,
      .wheel-bulbs[data-anim="0"] .bulb-halo-anim,
      .wheel-bulbs[data-anim="0"] .bulb-lens{
        animation:none !important;
      }

      .wheel-bulbs .bulb-run,
      .wheel-bulbs .bulb-halo-anim{
        transform-box: fill-box;
        transform-origin: center;
        will-change: opacity, transform;
        opacity: 0;
        animation: bulbRun var(--chaseDur) cubic-bezier(0.18, 1, 0.32, 1) infinite;
        animation-delay: var(--d, 0s);
      }
      .wheel-bulbs .bulb-halo-anim{
        opacity: 0.14;
        animation-name: bulbHaloAnim;
      }

      .wheel-bulbs .bulb-lens{
        transform-box: fill-box;
        transform-origin: center;
        will-change: opacity, transform;
        animation: bulbHeat 3.25s cubic-bezier(0.22, 1, 0.20, 1) infinite;
        animation-delay: var(--fd, 0s);
      }

      @keyframes bulbRun{
        0%   { opacity: 0.02; transform: scale(0.99); }
        10%  { opacity: calc(0.88 * var(--chaseK)); transform: scale(1.06); }
        22%  { opacity: calc(0.14 * var(--chaseK)); transform: scale(1.01); }
        100% { opacity: 0.02; transform: scale(0.99); }
      }
      @keyframes bulbHaloAnim{
        0%   { opacity: 0.10; transform: scale(1.00); }
        10%  { opacity: calc(0.26 * var(--chaseK)); transform: scale(1.10); }
        22%  { opacity: 0.11; transform: scale(1.02); }
        100% { opacity: 0.10; transform: scale(1.00); }
      }
      @keyframes bulbHeat{
        0%   { opacity: 1; transform: scale(1.00); }
        14%  { opacity: 0.96; transform: scale(0.995); }
        28%  { opacity: 1; transform: scale(1.010); }
        56%  { opacity: 0.97; transform: scale(0.998); }
        100% { opacity: 1; transform: scale(1.00); }
      }

      .wheel-bulbs.win-flash .bulb-run,
      .wheel-bulbs.win-flash .bulb-halo-anim{ animation:none !important; opacity: 0 !important; }
      .wheel-bulbs.win-flash .bulb-lens{
        animation: winCore var(--winDur) cubic-bezier(0.16, 1, 0.20, 1) both;
      }
      @keyframes winCore{
        0%   { opacity: 1.00; transform: scale(1.00); }
        12%  { opacity: 1.00; transform: scale(1.05); }
        34%  { opacity: 0.84; transform: scale(0.998); }
        52%  { opacity: 1.00; transform: scale(1.06); }
        76%  { opacity: 0.86; transform: scale(0.998); }
        100% { opacity: 1.00; transform: scale(1.00); }
      }

      @media (prefers-reduced-motion: reduce), (update: slow){
        .wheel-bulbs .bulb-run,
        .wheel-bulbs .bulb-halo-anim,
        .wheel-bulbs .bulb-lens{ animation:none !important; }
        .wheel-bulbs .bulb-run{ opacity: 0.10; }
      }
    </style>

    <!-- ✅ CLIP semua layer ke lingkaran wheel (anti blur putih “keluar”) -->
    <clipPath id="${ID("clipWheel")}" clipPathUnits="userSpaceOnUse">
      <circle cx="${cx}" cy="${cy}" r="${rOuter}"/>
    </clipPath>

    ${useBulbBandMask ? `
    <clipPath id="${ID("clipBulbsBand")}" clipPathUnits="userSpaceOnUse">
      <path d="${svgDonutPath(cx, cy, BULB_CLIP_R, BULB_BAND_INNER)}" fill-rule="evenodd" clip-rule="evenodd"/>
    </clipPath>
    ` : ""}

    <linearGradient id="${ID("segGreen")}" gradientUnits="userSpaceOnUse" x1="0" y1="0" x2="0" y2="${VB}">
      <stop offset="0" stop-color="#0c6a4f"/>
      <stop offset="0.55" stop-color="#074c37"/>
      <stop offset="1" stop-color="#053224"/>
    </linearGradient>

    <linearGradient id="${ID("segIvory")}" gradientUnits="userSpaceOnUse" x1="0" y1="0" x2="0" y2="${VB}">
      <stop offset="0" stop-color="#ffffff"/>
      <stop offset="0.55" stop-color="#f0f4f8"/>
      <stop offset="1" stop-color="#e6edf4"/>
    </linearGradient>

    <linearGradient id="${ID("rimGold")}" gradientUnits="userSpaceOnUse" x1="0" y1="0" x2="0" y2="${VB}">
      <stop offset="0"    stop-color="#fffdf4"/>
      <stop offset="0.10" stop-color="#fff1d3"/>
      <stop offset="0.22" stop-color="#f9e5b4"/>
      <stop offset="0.48" stop-color="#f3b24a"/>
      <stop offset="0.66" stop-color="#db8a2e"/>
      <stop offset="0.82" stop-color="#a95a1a"/>
      <stop offset="1"    stop-color="#6f3711"/>
    </linearGradient>

    <linearGradient id="${ID("rimHardSpec")}" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#ffffff" stop-opacity="0.00"/>
      <stop offset="0.34" stop-color="#ffffff" stop-opacity="0.26"/>
      <stop offset="0.52" stop-color="#ffffff" stop-opacity="0.58"/>
      <stop offset="0.68" stop-color="#ffffff" stop-opacity="0.18"/>
      <stop offset="1" stop-color="#ffffff" stop-opacity="0.00"/>
    </linearGradient>

    <linearGradient id="${ID("rimLip")}" gradientUnits="userSpaceOnUse" x1="0" y1="0" x2="0" y2="${VB}">
      <stop offset="0" stop-color="#2b170a" stop-opacity="0.92"/>
      <stop offset="0.40" stop-color="#000000" stop-opacity="0.56"/>
      <stop offset="1" stop-color="#000000" stop-opacity="0.22"/>
    </linearGradient>

    <radialGradient id="${ID("rimSpec")}" cx="34%" cy="18%" r="72%">
      <stop offset="0"    stop-color="#ffffff" stop-opacity="0.40"/>
      <stop offset="0.28" stop-color="#ffffff" stop-opacity="0.16"/>
      <stop offset="1"    stop-color="#ffffff" stop-opacity="0"/>
    </radialGradient>

    <radialGradient id="${ID("segVignette")}" cx="50%" cy="50%" r="74%">
      <stop offset="0"    stop-color="#000000" stop-opacity="0"/>
      <stop offset="0.78" stop-color="#000000" stop-opacity="0.11"/>
      <stop offset="1"    stop-color="#000000" stop-opacity="0.30"/>
    </radialGradient>

    <radialGradient id="${ID("segGloss")}" cx="36%" cy="16%" r="74%">
      <stop offset="0"    stop-color="#ffffff" stop-opacity="0.22"/>
      <stop offset="0.44" stop-color="#ffffff" stop-opacity="0.06"/>
      <stop offset="1"    stop-color="#ffffff" stop-opacity="0"/>
    </radialGradient>

    ${enableNoise ? `
    <filter id="${ID("microNoise")}" x="0" y="0" width="100%" height="100%" color-interpolation-filters="sRGB">
      <feTurbulence type="fractalNoise" baseFrequency="0.85" numOctaves="1" stitchTiles="stitch" result="n0"/>
      <feColorMatrix in="n0" type="matrix" values="
        1 0 0 0 0
        0 1 0 0 0
        0 0 1 0 0
        0 0 0 0.050 0" result="n1"/>
      <feBlend in="SourceGraphic" in2="n1" mode="overlay"/>
    </filter>
    ` : ""}

    <mask id="${ID("maskDonut")}">
      <rect x="0" y="0" width="${VB}" height="${VB}" fill="black"/>
      <circle cx="${cx}" cy="${cy}" r="${rSegOut}" fill="white"/>
      <circle cx="${cx}" cy="${cy}" r="${rSegIn}" fill="black"/>
    </mask>

    <mask id="${ID("maskRimBand")}">
      <rect x="0" y="0" width="${VB}" height="${VB}" fill="black"/>
      <circle cx="${cx}" cy="${cy}" r="${rOuter + 2}" fill="white"/>
      <circle cx="${cx}" cy="${cy}" r="${Math.max(1, rOuter - rimW1 - 10)}" fill="black"/>
    </mask>

    <radialGradient id="${ID("hubWell")}" cx="42%" cy="34%" r="78%">
      <stop offset="0"    stop-color="#16654c" stop-opacity="0.98"/>
      <stop offset="0.55" stop-color="#083a28" stop-opacity="0.98"/>
      <stop offset="1"    stop-color="#03130d" stop-opacity="0.98"/>
    </radialGradient>

    <radialGradient id="${ID("hubWellSpec")}" cx="36%" cy="22%" r="78%">
      <stop offset="0"    stop-color="#ffffff" stop-opacity="0.16"/>
      <stop offset="0.55" stop-color="#ffffff" stop-opacity="0.05"/>
      <stop offset="1"    stop-color="#ffffff" stop-opacity="0"/>
    </radialGradient>

    <radialGradient id="${ID("hubGold")}" cx="34%" cy="28%" r="76%">
      <stop offset="0"    stop-color="#fffdf4"/>
      <stop offset="0.22" stop-color="#f7d990"/>
      <stop offset="0.55" stop-color="#f3b24a"/>
      <stop offset="0.80" stop-color="#c26a1c"/>
      <stop offset="1"    stop-color="#6f3711"/>
    </radialGradient>

    <radialGradient id="${ID("hubGoldSpec")}" cx="30%" cy="18%" r="70%">
      <stop offset="0"    stop-color="#ffffff" stop-opacity="0.58"/>
      <stop offset="0.40" stop-color="#ffffff" stop-opacity="0.16"/>
      <stop offset="1"    stop-color="#ffffff" stop-opacity="0"/>
    </radialGradient>

    <radialGradient id="${ID("bulbFill")}" cx="34%" cy="24%" r="76%">
      <stop offset="0"    stop-color="#ffffff" stop-opacity="1"/>
      <stop offset="0.20" stop-color="#fff7e6" stop-opacity="1"/>
      <stop offset="0.55" stop-color="#ffd784" stop-opacity="1"/>
      <stop offset="1"    stop-color="#a94f16" stop-opacity="1"/>
    </radialGradient>

    <filter id="${ID("txtEmboss")}" x="-24%" y="-24%" width="148%" height="148%" color-interpolation-filters="sRGB">
      <feDropShadow dx="0" dy="${TXT_SHADOW_Y}" stdDeviation="${TXT_BLUR_1}" flood-color="#000000" flood-opacity="${isLow ? 0.50 : 0.54}"/>
      <feDropShadow dx="0" dy="0.9" stdDeviation="${TXT_BLUR_2}" flood-color="#ffffff" flood-opacity="${isLow ? 0.08 : 0.09}"/>
    </filter>

    <filter id="${ID("bulbGlow")}" x="-60%" y="-60%" width="220%" height="220%" color-interpolation-filters="sRGB">
      <feGaussianBlur in="SourceGraphic" stdDeviation="${GLOW_BLUR_0}" result="b0"/>
      <feColorMatrix in="b0" type="matrix" values="
        1 0 0 0 0.08
        0 1 0 0 0.05
        0 0 1 0 -0.02
        0 0 0 0.30 0" result="b1"/>
      <feGaussianBlur in="SourceGraphic" stdDeviation="${GLOW_BLUR_1}" result="b2"/>
      <feColorMatrix in="b2" type="matrix" values="
        1 0 0 0 0.03
        0 1 0 0 0.03
        0 0 1 0 0
        0 0 0 0.48 0" result="b3"/>
      <feGaussianBlur in="SourceGraphic" stdDeviation="${GLOW_BLUR_2}" result="b4"/>
      <feColorMatrix in="b4" type="matrix" values="
        1 0 0 0 0
        0 1 0 0 0
        0 0 1 0 0
        0 0 0 0.68 0" result="b5"/>
      <feMerge>
        <feMergeNode in="b1"/>
        <feMergeNode in="b3"/>
        <feMergeNode in="b5"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>

    <filter id="${ID("bulbSpark")}" x="-55%" y="-55%" width="210%" height="210%" color-interpolation-filters="sRGB">
      <feGaussianBlur in="SourceGraphic" stdDeviation="${SPARK_BLUR}" result="s0"/>
      <feColorMatrix in="s0" type="matrix" values="
        1 0 0 0 0
        0 1 0 0 0
        0 0 1 0 0
        0 0 0 0.66 0" result="s1"/>
      <feMerge>
        <feMergeNode in="s1"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>

    <filter id="${ID("hubShadow")}" x="-26%" y="-26%" width="152%" height="152%" color-interpolation-filters="sRGB">
      <feDropShadow dx="0" dy="5.6" stdDeviation="5.2" flood-color="#000000" flood-opacity="0.22"/>
    </filter>
  `;
  svg.appendChild(defs);

  // ✅ semua layer masuk ke group yang di-clip lingkaran wheel
  const gClipAll = E("g", { "clip-path": `url(#${ID("clipWheel")})` });
  svg.appendChild(gClipAll);

  // LAYER ORDER
  const gRotateBase   = E("g", { class: "wheel-rot wheel-rot-base" });
  const gStaticSeg    = E("g", { class: "wheel-static wheel-static-seg" });

  const gRotateLabels = E("g", { class: "wheel-rot wheel-rot-labels" });
  const gLabelsUpright = E("g", { class: "wheel-labels-upright" });
  gRotateLabels.appendChild(gLabelsUpright);

  const gStaticRim    = E("g", { class: "wheel-static wheel-static-rim" });
  const gRotateBulbs  = E("g", { class: "wheel-rot wheel-rot-bulbs" });
  const gRotateTop    = E("g", { class: "wheel-rot wheel-rot-top" });

  gClipAll.appendChild(gRotateBase);
  gClipAll.appendChild(gStaticSeg);
  gClipAll.appendChild(gRotateLabels);
  gClipAll.appendChild(gStaticRim);
  gClipAll.appendChild(gRotateBulbs);
  gClipAll.appendChild(gRotateTop);

  let _bulbFlashTimer = 0;
  let _lastDeg = null;

  /* ===== bulbs ===== */
  const gBulbWrap = E("g", { class: "wheel-bulbs", opacity: "1" });
  gBulbWrap.setAttribute("data-anim", animateBulbs ? "1" : "0");

  const bulbCount = clampNumber(
    Number(opt.bulbCount ?? (isLow ? 26 : isMed ? 32 : Math.max(34, Math.min(52, n * 5)))),
    24,
    56
  );

  const bulbR = Math.max(6, Math.min(11, Math.round(rimW1 * (isLow ? 0.34 : 0.40))));
  const bulbOrbit = rOuter - (rimW1 * 0.55);

  const gSocket = E("g", { class: "bulb-layer socket" });
  const gBloom  = E("g", { class: "bulb-layer bloom" });
  const gCore   = E("g", { class: "bulb-layer core" });
  const gRun    = E("g", { class: "bulb-layer run" });

  if (useBulbGlowFilter) gBloom.setAttribute("filter", `url(#${ID("bulbGlow")})`);
  if (!isLow) gRun.setAttribute("filter", `url(#${ID("bulbSpark")})`);

  // ✅ band-limit bloom/run supaya tidak bikin haze / white blur
  if (useBulbBandMask) {
    gBloom.setAttribute("clip-path", `url(#${ID("clipBulbsBand")})`);
    gRun.setAttribute("clip-path", `url(#${ID("clipBulbsBand")})`);
  }

  const chaseStepS = (Math.max(1, chaseDurMs) / 1000) / bulbCount;

  const fragSocket = document.createDocumentFragment();
  const fragBloom  = document.createDocumentFragment();
  const fragCore   = document.createDocumentFragment();
  const fragRun    = document.createDocumentFragment();

  for (let i = 0; i < bulbCount; i++) {
    const a = (360 / bulbCount) * i;
    const p = polar(cx, cy, bulbOrbit, a);

    const d  = (-i * chaseStepS).toFixed(3);
    const fd = (-(i * 0.11) % 1.7).toFixed(3);

    fragSocket.appendChild(E("circle", {
      cx: p.x.toFixed(2), cy: p.y.toFixed(2),
      r: String(bulbR * 1.26),
      fill: "#1f0f06",
      "fill-opacity": "0.66"
    }));
    fragSocket.appendChild(E("circle", {
      cx: p.x.toFixed(2), cy: p.y.toFixed(2),
      r: String(bulbR * 1.26),
      fill: "none",
      stroke: "#ffffff",
      "stroke-opacity": "0.10",
      "stroke-width": "1.0",
      "vector-effect": "non-scaling-stroke"
    }));

    const halo2R = bulbR * (isLow ? 1.40 : 1.75);
    const halo1R = bulbR * (isLow ? 1.16 : 1.34);

    fragBloom.appendChild(E("circle", {
      cx: p.x.toFixed(2), cy: p.y.toFixed(2),
      r: String(halo2R),
      fill: "#ffe39a",
      "fill-opacity": isLow ? "0.06" : "0.10"
    }));
    fragBloom.appendChild(E("circle", {
      cx: p.x.toFixed(2), cy: p.y.toFixed(2),
      r: String(halo1R),
      fill: "#ffd67a",
      "fill-opacity": isLow ? "0.38" : "0.86"
    }));

    const core = E("g", { class: "bulb core" });
    core.setAttribute("style", `--fd:${fd}s;`);

    const lens = E("circle", {
      class: "bulb-lens",
      cx: p.x.toFixed(2), cy: p.y.toFixed(2),
      r: String(bulbR),
      fill: `url(#${ID("bulbFill")})`,
      stroke: "#ffffff",
      "stroke-opacity": "0.22",
      "stroke-width": "1.12",
      "vector-effect": "non-scaling-stroke"
    });

    const dot = E("circle", {
      cx: (p.x - bulbR * 0.22).toFixed(2),
      cy: (p.y - bulbR * 0.28).toFixed(2),
      r: String(Math.max(1.7, bulbR * 0.28)),
      fill: "#ffffff",
      "fill-opacity": "0.80"
    });

    core.appendChild(lens);
    core.appendChild(dot);
    fragCore.appendChild(core);

    if (animateBulbs) {
      const runG = E("g", { class: "bulb run" });
      runG.setAttribute("style", `--d:${d}s;`);

      runG.appendChild(E("circle", {
        class: "bulb-halo-anim",
        cx: p.x.toFixed(2), cy: p.y.toFixed(2),
        r: String(bulbR * 1.40),
        fill: "#fff2bf",
        "fill-opacity": "1"
      }));

      runG.appendChild(E("circle", {
        class: "bulb-run",
        cx: p.x.toFixed(2), cy: p.y.toFixed(2),
        r: String(Math.max(1.2, bulbR * 1.02)),
        fill: "#ffffff",
        "fill-opacity": "1"
      }));

      fragRun.appendChild(runG);
    }
  }

  gSocket.appendChild(fragSocket);
  gBloom.appendChild(fragBloom);
  gCore.appendChild(fragCore);
  if (animateBulbs) gRun.appendChild(fragRun);

  gBulbWrap.appendChild(gSocket);
  gBulbWrap.appendChild(gBloom);
  gBulbWrap.appendChild(gCore);
  if (animateBulbs) gBulbWrap.appendChild(gRun);

  gRotateBulbs.appendChild(gBulbWrap);

  /* ===== API ===== */
  svg.__wheel = {
    uid, cx, cy,
    uprightLabels: defaultUprightLabels,
    perfTier,

    setRotation(deg, opt2 = {}) {
      const d = Number(deg || 0);
      if (!Number.isFinite(d)) return;
      if (_lastDeg !== null && Math.abs(d - _lastDeg) < 0.0001 && !opt2.force) return;
      _lastDeg = d;

      const upright = (typeof opt2.uprightLabels === "boolean") ? opt2.uprightLabels : !!svg.__wheel.uprightLabels;

      const tr = `rotate(${d} ${cx} ${cy})`;
      gRotateBase.setAttribute("transform", tr);
      gRotateLabels.setAttribute("transform", tr);
      gRotateBulbs.setAttribute("transform", tr);
      gRotateTop.setAttribute("transform", tr);

      if (upright) gLabelsUpright.setAttribute("transform", `rotate(${-d} ${cx} ${cy})`);
      else gLabelsUpright.removeAttribute("transform");
    },

    flashBulbs(ms = 950) {
      const dur = clampNumber(Number(ms || 0), 220, 2400);
      const el = gBulbWrap;
      if (!el) return;

      try { el.style.setProperty("--winDur", `${(dur / 1000).toFixed(3)}s`); } catch (_) {}

      if (_bulbFlashTimer) { try { clearTimeout(_bulbFlashTimer); } catch (_) {} _bulbFlashTimer = 0; }

      el.classList.remove("win-flash");
      requestAnimationFrame(() => {
        el.classList.add("win-flash");
        _bulbFlashTimer = setTimeout(() => {
          el.classList.remove("win-flash");
          _bulbFlashTimer = 0;
        }, dur + 90);
      });
    },

    setBulbMode(mode = "idle") {
      const el = gBulbWrap;
      if (!el) return;

      if (mode === "spin") {
        el.style.setProperty("--chaseK", isLow ? "1.06" : "1.20");
        el.style.setProperty("--chaseDur", isLow ? "2.90s" : "1.70s");
      } else if (mode === "win") {
        el.style.setProperty("--chaseK", isLow ? "1.04" : "1.16");
        el.style.setProperty("--chaseDur", isLow ? "2.35s" : "1.25s");
      } else {
        el.style.setProperty("--chaseK", isLow ? "0.92" : "1.05");
        el.style.setProperty("--chaseDur", isLow ? "3.10s" : "2.10s");
      }
    },

    destroy() {
      if (_bulbFlashTimer) { try { clearTimeout(_bulbFlashTimer); } catch (_) {} _bulbFlashTimer = 0; }
    }
  };

  /* ===== segments ===== */
  const gSlices = E("g", { class: "wheel-slices" });
  gRotateBase.appendChild(gSlices);

  const mctx = getMeasureCtx();
  const segForMeasure = Math.min(seg, 179.999);
  const maxLabelW = (n <= 1) ? (rText * 1.85) : (segmentChord(rText, segForMeasure) * 0.78);
  const EPS = (n >= 3 ? 0.10 : 0.06);

  for (let i = 0; i < n; i++) {
    const a0 = i * seg;
    const a1 = (i + 1) * seg;
    const mid = a0 + seg / 2;

    const isIvory = (i % 2 === 1);
    const fill = isIvory ? `url(#${ID("segIvory")})` : `url(#${ID("segGreen")})`;

    let s0 = a0, s1 = a1;
    if (n > 1) {
      if (i > 0) s0 -= EPS;
      if (i < n - 1) s1 += EPS;
      if (i === 0) s0 = 0;
      if (i === n - 1) s1 = 360;
    } else {
      s0 = 0; s1 = 359.999;
    }

    const wedge = E("path", { d: svgDonutWedge(cx, cy, rSegIn, rSegOut, s0, s1), fill });
    if (enableNoise) wedge.setAttribute("filter", `url(#${ID("microNoise")})`);
    gSlices.appendChild(wedge);

    if (n > 1) {
      const p1 = polar(cx, cy, rSegIn + 10, a0);
      const p2 = polar(cx, cy, rSegOut - 10, a0);
      gSlices.appendChild(E("line", {
        x1: p1.x.toFixed(2), y1: p1.y.toFixed(2),
        x2: p2.x.toFixed(2), y2: p2.y.toFixed(2),
        stroke: isIvory ? "#063b2b" : "#ffffff",
        "stroke-opacity": isIvory ? "0.14" : "0.12",
        "stroke-width": String(dividerW),
        "vector-effect": "non-scaling-stroke"
      }));
    }

    const label = safePrizes[i];
    const tp = polar(cx, cy, rText, mid);

    const isBonus = /bonus/i.test(label);
    const baseFont = isBonus ? 42 : 50;
    const fontWeight = 900;
    const letterSpacing = 1.1;

    let fontSize = baseFont;
    if (mctx) {
      fontSize = fitFontSizeByWidth(mctx, label, maxLabelW, {
        base: baseFont,
        min: isBonus ? 34 : 38,
        weight: fontWeight,
        family: "system-ui, -apple-system, Segoe UI, Roboto, Arial",
        letterSpacingPx: letterSpacing
      });
    }

    const text = E("text", {
      x: tp.x.toFixed(2),
      y: tp.y.toFixed(2),
      "text-anchor": "middle",
      "dominant-baseline": "middle",
      dy: "0.06em",
      filter: `url(#${ID("txtEmboss")})`,
      "font-family": "system-ui, -apple-system, Segoe UI, Roboto, Arial",
      "font-weight": String(fontWeight),
      "font-size": String(fontSize),
      "letter-spacing": String(letterSpacing),
      "paint-order": "stroke fill",
      "stroke-linejoin": "round",
      "stroke-miterlimit": "2"
    });

    if (isIvory) {
      text.setAttribute("fill", "#063b2b");
      text.setAttribute("stroke", "#ffffff");
      text.setAttribute("stroke-opacity", "0.18");
      text.setAttribute("stroke-width", "1.0");
    } else {
      text.setAttribute("fill", "#ffffff");
      text.setAttribute("fill-opacity", "0.96");
      text.setAttribute("stroke", "#000000");
      text.setAttribute("stroke-opacity", "0.16");
      text.setAttribute("stroke-width", "1.0");
    }

    text.textContent = label;
    gLabelsUpright.appendChild(text);
  }

  /* ===== bevel / rim metal (rotating base) ===== */
  gRotateBase.appendChild(E("circle", {
    cx, cy, r: (rSegOut + 3),
    fill: "none", stroke: "#ffffff",
    "stroke-opacity": "0.11",
    "stroke-width": "6",
    "vector-effect": "non-scaling-stroke"
  }));

  gRotateBase.appendChild(E("circle", {
    cx, cy, r: (rOuter - rimW1 + 4),
    fill: "none", stroke: "#000000",
    "stroke-opacity": "0.22",
    "stroke-width": "10",
    "vector-effect": "non-scaling-stroke"
  }));
  gRotateBase.appendChild(E("circle", {
    cx, cy, r: (rOuter - rimW1 + 5),
    fill: "none", stroke: "#ffffff",
    "stroke-opacity": "0.08",
    "stroke-width": "3",
    "vector-effect": "non-scaling-stroke"
  }));

  gRotateBase.appendChild(E("circle", {
    cx, cy, r: (rOuter - 1),
    fill: "none", stroke: "#ffffff",
    "stroke-opacity": "0.16",
    "stroke-width": "2",
    "vector-effect": "non-scaling-stroke"
  }));

  gRotateBase.appendChild(E("circle", {
    cx, cy,
    r: (rOuter - rimW1 / 2),
    fill: "none",
    stroke: `url(#${ID("rimGold")})`,
    "stroke-width": String(rimW1),
    "vector-effect": "non-scaling-stroke"
  }));

  gRotateBase.appendChild(E("circle", {
    cx, cy,
    r: (rOuter - rimW1 + 9),
    fill: "none",
    stroke: `url(#${ID("rimLip")})`,
    "stroke-width": "6",
    "vector-effect": "non-scaling-stroke"
  }));

  gRotateBase.appendChild(E("circle", {
    cx, cy,
    r: (rSegOut + 18),
    fill: "none",
    stroke: "#f6b33d",
    "stroke-opacity": "0.56",
    "stroke-width": String(rimW2),
    "vector-effect": "non-scaling-stroke"
  }));

  /* ===== static lighting ===== */
  gStaticSeg.appendChild(E("rect", {
    x: 0, y: 0, width: VB, height: VB,
    fill: `url(#${ID("segVignette")})`,
    mask: `url(#${ID("maskDonut")})`
  }));
  gStaticSeg.appendChild(E("rect", {
    x: 0, y: 0, width: VB, height: VB,
    fill: `url(#${ID("segGloss")})`,
    mask: `url(#${ID("maskDonut")})`
  }));

  gStaticRim.appendChild(E("circle", {
    cx, cy,
    r: (rOuter - rimW1 / 2),
    fill: "none",
    stroke: `url(#${ID("rimSpec")})`,
    "stroke-width": String(rimW1 + 10),
    mask: `url(#${ID("maskRimBand")})`,
    "vector-effect": "non-scaling-stroke"
  }));

  gStaticRim.appendChild(E("circle", {
    cx, cy,
    r: (rOuter - rimW1 / 2 + 2),
    fill: "none",
    stroke: `url(#${ID("rimHardSpec")})`,
    "stroke-width": "3.2",
    "stroke-opacity": "0.85",
    mask: `url(#${ID("maskRimBand")})`,
    "vector-effect": "non-scaling-stroke"
  }));

  /* ===== optional hub ===== */
  if (includeHub) {
    const gHub = E("g", { class: "wheel-hub" });

    gHub.appendChild(E("circle", {
      cx, cy,
      r: Math.max(1, rSegIn - 8),
      fill: `url(#${ID("hubWell")})`,
      filter: `url(#${ID("hubShadow")})`
    }));
    gHub.appendChild(E("circle", {
      cx, cy,
      r: Math.max(1, rSegIn - 8),
      fill: `url(#${ID("hubWellSpec")})`
    }));

    const capR = Math.max(42, Math.round((rSegIn - 8) * 0.46));
    gHub.appendChild(E("circle", { cx, cy, r: capR, fill: `url(#${ID("hubGold")})` }));
    gHub.appendChild(E("circle", { cx, cy, r: capR, fill: `url(#${ID("hubGoldSpec")})` }));

    gHub.appendChild(E("circle", {
      cx, cy,
      r: Math.max(1, capR - 2),
      fill: "none",
      stroke: "#ffffff",
      "stroke-opacity": "0.18",
      "stroke-width": "2",
      "vector-effect": "non-scaling-stroke"
    }));

    gRotateTop.appendChild(gHub);
  }

  svg.__wheel.setRotation(0, { uprightLabels: defaultUprightLabels, force: true });
  try { svg.__wheel.setBulbMode("idle"); } catch (_) {}

  return svg;
}

/* =========================================================
 * helpers (FULL REPLACE)
 * ======================================================= */
function clampNumber(v, lo, hi){
  const x = Number(v);
  if (!Number.isFinite(x)) return lo;
  return Math.max(lo, Math.min(hi, x));
}

function polar(cx, cy, r, deg) {
  const a = (deg - 90) * Math.PI / 180;
  return { x: cx + r * Math.cos(a), y: cy + r * Math.sin(a) };
}

function svgCirclePath(cx, cy, r){
  const rr = Number(r);
  return [
    `M ${cx} ${cy - rr}`,
    `A ${rr} ${rr} 0 1 1 ${cx} ${cy + rr}`,
    `A ${rr} ${rr} 0 1 1 ${cx} ${cy - rr}`,
    "Z"
  ].join(" ");
}

function svgDonutPath(cx, cy, rOuter, rInner){
  return `${svgCirclePath(cx, cy, rOuter)} ${svgCirclePath(cx, cy, rInner)}`;
}

function svgDonutWedge(cx, cy, r0, r1, a0, a1) {
  const sweep = Math.abs(a1 - a0);
  const large = sweep > 180 ? 1 : 0;

  const p1 = polar(cx, cy, r1, a0);
  const p2 = polar(cx, cy, r1, a1);
  const p3 = polar(cx, cy, r0, a1);
  const p4 = polar(cx, cy, r0, a0);

  return [
    `M ${p1.x.toFixed(2)} ${p1.y.toFixed(2)}`,
    `A ${r1} ${r1} 0 ${large} 1 ${p2.x.toFixed(2)} ${p2.y.toFixed(2)}`,
    `L ${p3.x.toFixed(2)} ${p3.y.toFixed(2)}`,
    `A ${r0} ${r0} 0 ${large} 0 ${p4.x.toFixed(2)} ${p4.y.toFixed(2)}`,
    "Z"
  ].join(" ");
}

function getMeasureCtx() {
  if (getMeasureCtx._ctx) return getMeasureCtx._ctx;
  const c = document.createElement("canvas");
  c.width = 64; c.height = 64;
  getMeasureCtx._ctx = c.getContext("2d", { willReadFrequently: false });
  return getMeasureCtx._ctx;
}

function segmentChord(r, segDeg) {
  const rad = (segDeg * Math.PI) / 180;
  return 2 * r * Math.sin(rad / 2);
}

function fitFontSizeByWidth(ctx, text, maxW, opt) {
  const t = String(text || "");
  const base = opt.base || 48;
  const min = opt.min || 34;
  const family = opt.family || "system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const weight = opt.weight || 900;
  const ls = Number(opt.letterSpacingPx || 0);

  let fs = base;
  while (fs >= min) {
    ctx.font = `${weight} ${fs}px ${family}`;
    const w0 = ctx.measureText(t).width;
    const w = w0 + Math.max(0, (t.length - 1)) * ls;
    if (w <= maxW) return fs;
    fs -= 1;
  }
  return min;
}

function _wheelUid() {
  const g = _wheelUid;
  g._seq = (g._seq || 0) + 1;

  let rand = "";
  if (typeof crypto !== "undefined" && crypto.randomUUID) {
    rand = crypto.randomUUID().replace(/-/g, "").slice(0, 12);
  } else if (typeof crypto !== "undefined" && crypto.getRandomValues) {
    const a = new Uint32Array(3);
    crypto.getRandomValues(a);
    rand = Array.from(a).map(x => x.toString(16).padStart(8, "0")).join("").slice(0, 12);
  } else {
    rand = Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);
    rand = rand.slice(0, 12);
  }

  return `w${Date.now().toString(36)}_${g._seq.toString(36)}_${rand}`;
}

function matchReduceMotion(){
  try {
    return !!(window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches);
  } catch (_) {}
  return false;
}

function detectPerfTier(mode) {
  const m = String(mode || "auto").toLowerCase();
  if (m === "high" || m === "med" || m === "low") return m;

  if (matchReduceMotion()) return "low";

  const nav = (typeof navigator !== "undefined") ? navigator : {};
  const dm = Number(nav.deviceMemory || 0);
  const hc = Number(nav.hardwareConcurrency || 0);
  const saveData = !!(nav.connection && nav.connection.saveData);

  const ua = String(nav.userAgent || "");
  const isMobile = /Android|iPhone|iPad|iPod/i.test(ua);

  if (saveData) return "low";
  if (dm && dm <= 2) return "low";
  if (hc && hc <= 4 && dm && dm <= 4) return "low";

  if (!isMobile) {
    if ((dm && dm >= 8) || (hc && hc >= 8)) return "high";
    return "med";
  }

  if (dm && dm <= 4) return "med";
  if (hc && hc <= 6) return "med";

  return "med";
}

  /* =========================================================
   * 10) HISTORY (random + realtime) — UNIQUE
   * ======================================================= */
  function pickWeightedPrizeKey() {
    const bag = [
      ["BONUS 10%", 30],
      ["25K", 17],
      ["50K", 18],
      ["75K", 14],
      ["100K", 12],
      ["200K", 9],
    ];

    const total = bag.reduce((a, [, w]) => a + w, 0);
    let r = Math.random() * total;

    for (const [p, w] of bag) { r -= w; if (r <= 0) return p; }
    return "50K";
  }

  function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
  function pad2(n) { return String(n).padStart(2, "0"); }

  function randomUserId() {
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
    const pick = (s) => s[Math.floor(Math.random() * s.length)];

    const len = randInt(7, 11);
    let out = "";

    for (let i = 0; i < len; i++) out += (Math.random() < 0.30) ? String(randInt(0, 9)) : pick(letters);
    if (Math.random() < 0.35) out += String(randInt(0, 9));

    return out;
  }

  function maskUserId(str) {
    const s = String(str || "");
    if (s.length <= 6) return s.slice(0, 2) + "****";
    return (s.slice(0, 3) + "****" + s.slice(-2));
  }

  function makeEntryId(prefix) {
    return `${prefix || "w"}-${Date.now()}-${Math.random().toString(16).slice(2)}-${Math.random().toString(16).slice(2)}`;
  }

  function rememberMasked(id) {
    const v = String(id || "");
    if (!v) return;
    if (recentMasked.has(v)) return;

    recentMasked.add(v);
    recentMaskedQueue.push(v);

    // keep last ~70
    while (recentMaskedQueue.length > 70) {
      const old = recentMaskedQueue.shift();
      recentMasked.delete(old);
    }
  }

  function uniqueMaskedId(maxTry = 60) {
    for (let i = 0; i < maxTry; i++) {
      const masked = maskUserId(randomUserId());
      if (!recentMasked.has(masked)) {
        rememberMasked(masked);
        return masked;
      }
    }

    const fallback = maskUserId(randomUserId());
    rememberMasked(fallback);
    return fallback;
  }

  function generateMockWinnersRandom() {
    let base = Date.now() - randInt(40, 220) * 1000;
    const arr = [];

    for (let i = 0; i < 50; i++) {
      const prizeKey = pickWeightedPrizeKey();
      const masked = uniqueMaskedId();

      arr.push({
        id: makeEntryId("seed"),
        isUser: false,
        fullId: "",
        displayId: masked,
        prizeKey,
        prize: CONFIG.PRIZE_DISPLAY_MAP[prizeKey] || prizeKey,
        ts: base,
        isNew: false
      });

      base -= randInt(20, 160) * 1000;
    }

    arr.sort((a, b) => (b.ts || 0) - (a.ts || 0));
    return arr;
  }

  function timeLabel(ts) {
    const d = new Date(ts || Date.now());
    const dateStr = d.toLocaleDateString("id-ID", { day: "2-digit", month: "short", year: "numeric" });
    const timeStr = `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;

    const diff = Math.max(0, Date.now() - (ts || Date.now()));
    const sec = Math.floor(diff / 1000);

    let rel = "baru saja";
    if (sec >= 60) {
      const min = Math.floor(sec / 60);
      if (min < 60) rel = `${min}m lalu`;
      else {
        const hr = Math.floor(min / 60);
        if (hr < 24) rel = `${hr}j lalu`;
        else rel = `${Math.floor(hr / 24)} hari lalu`;
      }
    }

    return `${dateStr} ${timeStr} • ${rel}`;
  }

  function startMetaTicker() {
    if (metaTimer) clearInterval(metaTimer);
    metaTimer = setInterval(() => {
      document.querySelectorAll(".winner-meta[data-ts]").forEach((el) => {
        const ts = Number(el.getAttribute("data-ts") || Date.now());
        el.textContent = timeLabel(ts);
      });
    }, 15000);
  }

  function pushWinnerEntry(entry) {
    if (!entry) return;
    if (!entry.id) entry.id = makeEntryId(entry.isUser ? "user" : "live");
    if (entry.isNew) playHistorySfx();

    winners.forEach((w) => (w.isNew = false));
    winners.unshift(entry);
    winners = winners.slice(0, 50);

    renderWinners({ preserveScroll: true });
    startMetaTicker();
  }

  function startLiveHistory() {
    if (liveTimer) return;
    if (pauseReasons.size > 0) return;

    const schedule = () => {
      stopLiveHistory();
      const ms = randInt(5200, 12500);

      liveTimer = setTimeout(() => {
        if (!isModalOpen() && !isSpin && pauseReasons.size === 0) {
          const prizeKey = pickWeightedPrizeKey();
          pushWinnerEntry({
            id: makeEntryId("live"),
            isUser: false,
            fullId: "",
            displayId: uniqueMaskedId(),
            prizeKey,
            prize: CONFIG.PRIZE_DISPLAY_MAP[prizeKey] || prizeKey,
            ts: Date.now(),
            isNew: true
          });
        }
        schedule();
      }, ms);
    };

    schedule();
  }

  function stopLiveHistory() {
    if (liveTimer) clearTimeout(liveTimer);
    liveTimer = 0;
  }

  /* =========================================================
   * 11) WINNERS RENDER (FLIP)
   * ======================================================= */
  function ensureWinnersHeader(table) {
    let header = table.querySelector(".winners-table-header");
    if (!header) {
      header = document.createElement("div");
      header.className = "winners-table-header";
      header.innerHTML = "<div>NO</div><div>USER ID</div><div>HADIAH</div>";
      table.appendChild(header);
    }
    return header;
  }

  function createRowEl(entry) {
    const row = document.createElement("div");
    row.className = "winners-table-row" + (entry.isNew ? " is-new" : "") + (entry.isUser ? " is-user" : "");
    row.setAttribute("data-id", entry.id);
    row.tabIndex = entry.isUser ? 0 : -1;

    const c1 = document.createElement("div");
    c1.className = "winner-no";

    const c2 = document.createElement("div");
    c2.className = "winner-id";

    const meta = document.createElement("div");
    meta.className = "winner-meta";
    meta.setAttribute("data-ts", String(entry.ts || Date.now()));

    const c2wrap = document.createElement("div");
    c2wrap.appendChild(c2);
    c2wrap.appendChild(meta);

    const c3 = document.createElement("div");
    c3.className = "winner-prize";

    row.append(c1, c2wrap, c3);
    return row;
  }

  function patchRowContent(row, entry, index) {
    row.classList.toggle("is-new", !!entry.isNew);
    row.classList.toggle("is-user", !!entry.isUser);
    row.tabIndex = entry.isUser ? 0 : -1;

    const no = row.querySelector(".winner-no");
    const id = row.querySelector(".winner-id");
    const meta = row.querySelector(".winner-meta");
    const prize = row.querySelector(".winner-prize");

    if (no) no.textContent = String(index + 1);
    if (id) id.textContent = String(entry.displayId || "");

    if (meta) {
      meta.setAttribute("data-ts", String(entry.ts || Date.now()));
      meta.textContent = timeLabel(entry.ts);
    }

    if (prize) prize.textContent = String(entry.prize || "");
  }

  function renderWinners(opts = {}) {
    const o = Object.assign({ preserveScroll: true }, opts);
    const table = document.getElementById("winnersTable");
    if (!table) return;

    let prevScrollTop = 0;
    try { prevScrollTop = table.scrollTop || 0; } catch (_) {}

    ensureWinnersHeader(table);

    winnersById = new Map();
    for (const w of winners) winnersById.set(w.id, w);

    const first = {};
    for (const [id, el] of rowElById.entries()) {
      if (!el || !el.isConnected) continue;
      first[id] = el.getBoundingClientRect().top;
    }

    for (let i = 0; i < winners.length; i++) {
      const w = winners[i];
      if (!w.id) w.id = makeEntryId("w");

      let row = rowElById.get(w.id);
      if (!row || !row.isConnected) {
        row = createRowEl(w);
        rowElById.set(w.id, row);
        table.appendChild(row);
      }

      patchRowContent(row, w, i);
    }

    for (const [id, el] of Array.from(rowElById.entries())) {
      if (!winnersById.has(id)) {
        try { el.remove(); } catch (_) {}
        rowElById.delete(id);
      }
    }

    const header = table.querySelector(".winners-table-header");
    for (const w of winners) {
      const row = rowElById.get(w.id);
      if (row && row.isConnected) table.appendChild(row);
    }
    if (header && header.isConnected) table.insertBefore(header, table.firstChild);

    const last = {};
    for (const w of winners) {
      const el = rowElById.get(w.id);
      if (!el || !el.isConnected) continue;
      last[w.id] = el.getBoundingClientRect().top;
    }

    requestAnimationFrame(() => {
      for (const w of winners) {
        const el = rowElById.get(w.id);
        if (!el || !el.isConnected) continue;

        const a = first[w.id];
        const b = last[w.id];
        if (typeof a !== "number" || typeof b !== "number") continue;

        const dy = a - b;
        if (Math.abs(dy) < 0.5) continue;

        el.style.transform = `translateY(${dy}px)`;
        el.style.transition = "transform 0ms";
      }

      requestAnimationFrame(() => {
        for (const w of winners) {
          const el = rowElById.get(w.id);
          if (!el || !el.isConnected) continue;
          el.style.transition = "";
          el.style.transform = "";
        }
      });
    });

    if (o.preserveScroll) {
      try { table.scrollTop = prevScrollTop; } catch (_) {}
    }
  }

  /* =========================================================
   * 12) Klik history: HANYA USER ASLI
   * ======================================================= */
  function setupHistoryRowOpen() {
    const table = document.getElementById("winnersTable");
    if (!table) return;

    const tryOpen = (row) => {
      const id = row.getAttribute("data-id");
      const entry = winnersById.get(id);
      if (!entry) return;

      if (!entry.isUser) {
        const now = Date.now();
        if (now - nonUserToastAt > 1800) {
          nonUserToastAt = now;
          showToast("Hanya riwayat Anda yang bisa dibuka.", "error", 1800);
        }
        return;
      }

      const showUser = String(entry.fullId || entry.displayId || "-");
      const prizeShow = String(entry.prize || entry.prizeKey || "-");
      const ts = Number(entry.ts || Date.now());

      lastResult = { userId: showUser, prizeLabel: prizeShow, prizeDisplay: prizeShow, ts };

      document.getElementById("prizeAmount").textContent = prizeShow;
      document.getElementById("modalUserId").textContent = showUser;
      document.getElementById("modalTime").textContent = new Date(ts).toLocaleString("id-ID", {
        day: "2-digit", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });

      openModal();
    };

    table.addEventListener("click", (e) => {
      const row = (e.target && e.target.closest) ? e.target.closest(".winners-table-row") : null;
      if (!row) return;
      tryOpen(row);
    });

    table.addEventListener("keydown", (e) => {
      if (e.key !== "Enter" && e.key !== " ") return;
      const row = (e.target && e.target.classList && e.target.classList.contains("winners-table-row")) ? e.target : null;
      if (!row) return;

      e.preventDefault();
      tryOpen(row);
    });
  }

  /* =========================================================
   * 13) JACKPOT
   * ======================================================= */
  function initJackpot() {
    const saved = Number(lsGet(LS.JACKPOT_VAL, "0") || "0");
    if (saved && saved > 1000000) return saved;

    const seed = randInt(880_000_000, 930_000_000);
    lsSet(LS.JACKPOT_VAL, String(seed));
    return seed;
  }

  function fmtClock() {
    const d = new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

  function startJackpot() {
    if (jackpotTimer) return;

    const el = document.getElementById("jackpot");
    const meta = document.getElementById("jackpotMeta");

    let speed = randInt(1400, 8200);
    let last = performance.now();

    const step = () => {
      const now = performance.now();
      const dt = Math.min(0.22, (now - last) / 1000);
      last = now;

      if (now > spikeUntilMs) {
        spikeMul = 1;
        if (Math.random() < 0.0012) {
          spikeMul = 2.0 + Math.random() * 2.3;
          spikeUntilMs = now + (2000 + Math.random() * 2500);
        }
      }

      const noise = (Math.random() - 0.5) * 0.8;
      let v = speed * (1 + noise) * spikeMul;
      if (Math.random() < 0.03) v *= -0.25;

      jackpot = Math.max(800_000_000, jackpot + v * dt);

      if (el) el.textContent = `IDR ${Math.round(jackpot).toLocaleString("id-ID")}`;
      if (meta) meta.textContent = `Update: ${fmtClock()}`;

      jackpotTimer = requestAnimationFrame(step);
    };

    jackpotTimer = requestAnimationFrame(step);

    if (jackpotSaveTimer) clearInterval(jackpotSaveTimer);
    jackpotSaveTimer = setInterval(() => {
      lsSet(LS.JACKPOT_VAL, String(Math.round(jackpot)));
      if (Math.random() < 0.55) speed = randInt(1400, 9500);
    }, 3000);
  }

  function stopJackpot() {
    if (jackpotTimer) cancelAnimationFrame(jackpotTimer);
    jackpotTimer = 0;

    if (jackpotSaveTimer) clearInterval(jackpotSaveTimer);
    jackpotSaveTimer = 0;
  }

  /* =========================================================
   * 14) MODAL (pause/resume history + focus trap + inert)
   * ======================================================= */
  function isModalOpen() {
    return document.getElementById("prizeModal").classList.contains("show");
  }

  function openModal() {
    const modal = document.getElementById("prizeModal");
    lastFocusedEl = document.activeElement;

    pauseHistory("modal");
    setInert("modal", true);

    modal.classList.add("show");
    modal.setAttribute("aria-hidden", "false");
    document.body.classList.add("modal-open");

    const claimBtn = document.getElementById("claimBtn");
    if (claimBtn) setTimeout(() => claimBtn.focus({ preventScroll: true }), 0);
  }

  function closeModal() {
    const modal = document.getElementById("prizeModal");

    modal.classList.remove("show");
    modal.setAttribute("aria-hidden", "true");

    resumeHistory("modal");
    setInert("modal", false);

    // only remove modal-open if nav overlay not showing
    if (!isNavOpen()) document.body.classList.remove("modal-open");

    if (lastFocusedEl && lastFocusedEl.isConnected && typeof lastFocusedEl.focus === "function") {
      lastFocusedEl.focus({ preventScroll: true });
    }
    lastFocusedEl = null;
  }

  function trapFocus(e) {
    const modal = document.getElementById("prizeModal");
    const root = (modal && modal.querySelector) ? modal.querySelector(".modal-content") : null;
    if (!root) return;

    const focusables = root.querySelectorAll(
      'button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])'
    );
    const list = Array.from(focusables).filter((el) => el && !el.disabled && el.offsetParent !== null);
    if (list.length === 0) return;

    const first = list[0];
    const last = list[list.length - 1];

    const active = document.activeElement;

    if (e.shiftKey) {
      if (active === first || active === root) {
        e.preventDefault();
        last.focus({ preventScroll: true });
      }
    } else {
      if (active === last) {
        e.preventDefault();
        first.focus({ preventScroll: true });
      }
    }
  }

  /* =========================================================
   * 15) UI
   * ======================================================= */
  function updateUI() {
    const spinBtn = document.getElementById("spinBtn");
    const userIdInput = document.getElementById("userIdInput");
    const spunMessage = document.getElementById("spunMessage");

    if (hasSpun) {
      spinBtn.disabled = true;
      spinBtn.textContent = "SUDAH SPIN";
      userIdInput.disabled = true;
      spunMessage.style.display = "block";
    } else {
      spinBtn.disabled = false;
      spinBtn.textContent = "SPIN SEKARANG!";
      userIdInput.disabled = false;
      spunMessage.style.display = "none";
    }
  }

  /* =========================================================
   * 16) tick per-segment (token-based cancel)
   * ======================================================= */
  function clearTickTimers() {
    for (const t of tickTimers) {
      try { clearTimeout(t); } catch (_) {}
    }
    tickTimers = [];
  }

  function scheduleTicks(rotationDeltaDeg, segmentAngleDeg, durationMs, token) {
    if (isReducedMotion()) return;

    const ticks = Math.max(0, Math.floor(Math.abs(rotationDeltaDeg) / segmentAngleDeg));
    if (ticks <= 0) return;

    const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);
    const maxTicks = 130;
    const count = Math.min(ticks, maxTicks);

    for (let i = 1; i <= count; i++) {
      const t = i / count;
      const when = Math.round(easeOutCubic(t) * durationMs);
      const jitter = randInt(-10, 12);

      // ease-out intensity: strong early, softer near end
      const intensity = Math.max(0.45, 1 - t * 0.55);

      const id = setTimeout(() => {
        if (token !== spinToken) return;
        playTick(intensity);
      }, Math.max(0, when + jitter));

      tickTimers.push(id);
    }
  }

  /* =========================================================
   * 17) SPIN (LOCK RESULT BONUS 10%)
   * ======================================================= */
  function startSpin() {
    kickAudio(true);

    const reduceMotion = isReducedMotion();

    const userIdInput = document.getElementById("userIdInput");
    const rawUserId = userIdInput.value.trim();
    const userId = normalizeUserIdInput(rawUserId);

    if (!userId) {
      showToast("Masukkan User ID terlebih dahulu!", "error");
      userIdInput.focus({ preventScroll: true });
      return;
    }

    if (hasSpun) { showToast("Anda sudah melakukan spin! Kesempatan hanya 1x.", "error"); return; }
    if (isSpin) return;

    isSpin = true;
    pauseHistory("spin");

    // new spin token cancels old tick timers
    spinToken++;
    clearTickTimers();

    if (pointerEl) pointerEl.classList.add("is-spin");

    const spinBtn = document.getElementById("spinBtn");
    spinBtn.disabled = true;
    spinBtn.textContent = "SPINNING…";

    const spinSound = document.getElementById("spinSound");
    try { spinSound.currentTime = 0; spinSound.play().catch(() => {}); } catch (_) {}

    const prizeIndex = (BONUS_INDEX >= 0 ? BONUS_INDEX : 0);

    const wheel = document.getElementById("wheel");
    const n = PRIZES.length;
    const segmentAngle = 360 / n;

    const segmentCenter = (prizeIndex * segmentAngle) + (segmentAngle / 2);
    const base = ((currentRotation % 360) + 360) % 360;
    const desiredMod = (360 - segmentCenter + 360) % 360;

    const fullSpins = 360 * (8 + Math.floor(Math.random() * 4));
    const jitter = (Math.random() - 0.5) * (segmentAngle * 0.55);
    const delta = (desiredMod - base + 360) % 360;

    const totalRotation = currentRotation + fullSpins + delta + jitter;
    const rotationDelta = totalRotation - currentRotation;
    const durationMs = reduceMotion ? 350 : CONFIG.SPIN_DURATION_MS;

    wheel.style.setProperty("--spin-dur", durationMs + "ms");

    // Pre-pause modal to avoid any flicker start when removing spin pause
    pauseHistory("modal");

    let ended = false;
    const localToken = spinToken;

    const onEnd = () => {
      if (ended) return;
      ended = true;

      // cancel remaining tick timers immediately
      clearTickTimers();

      wheel.classList.remove("spinning");
      applyWheelRotation(totalRotation);
      saveRotation(totalRotation);

      try { spinSound.pause(); spinSound.currentTime = 0; } catch (_) {}

      const winSound = document.getElementById("winSound");
      try { winSound.currentTime = 0; winSound.play().catch(() => {}); } catch (_) {}

      if (pointerEl) pointerEl.classList.remove("is-spin");

      hasSpun = true;
      spinAt = Date.now();

      lsSet(LS.HAS_SPUN, "true");
      lsSet(LS.SPIN_AT, String(spinAt));
      lsSet(LS.LAST_USER_ID, userId);

      savedUserId = userId;

      lastResult = { userId, prizeLabel: BONUS_LABEL, prizeDisplay: CONFIG.PRIZE_DISPLAY_MAP[BONUS_LABEL], ts: spinAt };

      document.getElementById("prizeAmount").textContent = BONUS_LABEL;
      document.getElementById("modalUserId").textContent = userId;
      document.getElementById("modalTime").textContent = new Date(spinAt).toLocaleString("id-ID", {
        day: "2-digit", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });

      pushWinnerEntry({
        id: makeEntryId("user"),
        isUser: true,
        fullId: userId,
        displayId: userId,
        prizeKey: BONUS_LABEL,
        prize: CONFIG.PRIZE_DISPLAY_MAP[BONUS_LABEL],
        ts: spinAt,
        isNew: true
      });

      updateUI();
      celebrateWin();

      // remove spin pause while modal pause is already active (no flicker)
      resumeHistory("spin");

      // open modal (modal pause already active; openModal will keep it)
      openModal();

      isSpin = false;
    };

    if (reduceMotion) { onEnd(); return; }

    scheduleTicks(rotationDelta, segmentAngle, durationMs, localToken);

    wheel.style.setProperty("--from-rotation", currentRotation + "deg");
    wheel.style.setProperty("--rotation", totalRotation + "deg");
    wheel.classList.add("spinning");

    wheel.addEventListener("animationend", onEnd, { once: true });
    setTimeout(() => { if (localToken === spinToken) onEnd(); }, durationMs + 260);
  }

/* =========================================================
 * 18) DOWNLOAD + SHARE RESULT (PNG) — FINAL (FULL REPLACE v3)
 * ✅ Force: Play URL/domain SELALU ikut saat share (text + navigator.share url)
 * ✅ Add: Domain tampil di PNG (biar repost gambar tetap ada alamat main)
 * ✅ Add: Fallback Share Menu (WA/Telegram/X/FB/LINE/Email/Copy Link)
 * ✅ Keep: lastResult safe getter, iOS pre-open, blob/dataUrl fallback, revoke safe
 * ✅ Keep: Reward modal auto-resize responsif
 * ======================================================= */

/* -------------------------
 * SAFE UTIL
 * ------------------------- */
function __toast(msg, type) {
  try { if (typeof showToast === "function") showToast(String(msg || ""), type || "success"); } catch (_) {}
}
function __kick() { try { if (typeof kickAudio === "function") kickAudio(true); } catch (_) {} }

function __getLastResult() {
  try { if (typeof lastResult !== "undefined" && lastResult) return lastResult; } catch (_) {}
  try { if (typeof window !== "undefined" && window.lastResult) return window.lastResult; } catch (_) {}
  return null;
}

function __isIOS() {
  try {
    const ua = String(navigator.userAgent || "");
    return /iPad|iPhone|iPod/i.test(ua);
  } catch (_) { return false; }
}
function __isMobileLike() {
  try { if (typeof matchMedia === "function" && matchMedia("(pointer: coarse)").matches) return true; } catch (_) {}
  try {
    const ua = String(navigator.userAgent || "");
    return /Android|iPhone|iPad|iPod/i.test(ua);
  } catch (_) {}
  return false;
}

function __pad2(n) {
  try { if (typeof pad2 === "function") return pad2(n); } catch (_) {}
  return String(n ?? "").padStart(2, "0");
}

/* -------------------------
 * PLAY URL (domain bermain) — selalu ada
 * priority:
 * 1) CONFIG.PLAY_URL
 * 2) CONFIG.CLAIM_URL
 * 3) current page (origin + pathname)
 * ------------------------- */
function __normalizeUrl(u) {
  try {
    const url = new URL(String(u || "").trim(), location.href);
    // buang hash biar rapih
    url.hash = "";
    return url.toString();
  } catch (_) {
    return String(u || "").trim();
  }
}

function __getMetaUrl() {
  try {
    // 1) canonical
    const canon = document.querySelector('link[rel="canonical"][href]');
    if (canon && canon.href) return canon.href;

    // 2) og:url
    const og = document.querySelector('meta[property="og:url"][content]');
    if (og && og.content) return og.content;
  } catch (_) {}
  return "";
}

function __getPlayUrl() {
  // PRIORITY:
  // A) runtime override (optional) -> window.MT2_PLAY_URL
  // B) localStorage override (optional) -> mt2:play_url
  // C) canonical / og:url (kalau kamu set)
  // D) lokasi halaman sekarang (pasti sesuai domain deploy yang sedang dipakai)

  let u = "";

  // A) runtime override
  try {
    if (typeof window !== "undefined" && window.MT2_PLAY_URL) u = String(window.MT2_PLAY_URL || "");
  } catch (_) {}

  // B) localStorage override
  if (!u) {
    try { u = String(localStorage.getItem("mt2:play_url") || ""); } catch (_) {}
  }

  // C) canonical/og:url
  if (!u) {
    try { u = __getMetaUrl(); } catch (_) { u = ""; }
  }

  // D) current location (AUTO domain deploy)
  if (!u) {
    try { u = String(location.href || ""); } catch (_) { u = ""; }
  }

  return __normalizeUrl(u);
}

/* optional helper kalau suatu saat mau set manual tanpa edit code */
function __setPlayUrlOverride(url) {
  const v = __normalizeUrl(url);
  try { localStorage.setItem("mt2:play_url", v); } catch (_) {}
  try { window.MT2_PLAY_URL = v; } catch (_) {}
  return v;
}

/* -------------------------
 * RESPONSIVE: shrink Reward Modal on mobile
 * ------------------------- */
(function setupRewardModalResponsiveSizing() {
  let raf = 0;

  function findRoot() {
    const dBtn = document.getElementById("downloadBtn");
    const sBtn = document.getElementById("shareBtn");
    const btn = dBtn || sBtn;
    if (!btn) return null;

    const root =
      btn.closest('[role="dialog"]') ||
      btn.closest(".modal") ||
      btn.closest(".dialog") ||
      btn.closest(".overlay") ||
      btn.closest(".popup") ||
      btn.closest(".sheet") ||
      btn.closest(".bottom-sheet") ||
      btn.closest("[data-modal]") ||
      btn.closest("[id*='modal' i]") ||
      btn.closest("[class*='modal' i]") ||
      btn.closest("[class*='dialog' i]") ||
      null;

    return root;
  }

  function applySizing() {
    const root = findRoot();
    if (!root) return;

    const mobile = __isMobileLike();
    const panel =
      root.querySelector(".modal-content, .dialog-content, .content, .panel, .card") ||
      root;

    try {
      panel.style.width = mobile ? "min(420px, 92vw)" : "min(520px, 92vw)";
      panel.style.maxHeight = mobile ? "min(74vh, 640px)" : "min(78vh, 720px)";
      panel.style.overflow = "auto";
      panel.style.boxSizing = "border-box";
      if (!panel.style.padding) panel.style.padding = mobile ? "14px 14px 16px" : "18px 18px 20px";
      if (!panel.style.borderRadius) panel.style.borderRadius = "18px";
    } catch (_) {}

    try {
      const imgs = root.querySelectorAll("img");
      for (let i = 0; i < imgs.length; i++) {
        const img = imgs[i];
        const w = img.naturalWidth || img.width || 0;
        if (w && w < 120) continue;

        img.style.maxWidth = mobile ? "min(340px, 86vw)" : "min(440px, 92vw)";
        img.style.height = "auto";
        img.style.display = "block";
        img.style.marginInline = "auto";
      }
    } catch (_) {}
  }

  function schedule() {
    cancelAnimationFrame(raf);
    raf = requestAnimationFrame(applySizing);
  }

  try {
    window.addEventListener("resize", schedule, { passive: true });
    window.addEventListener("orientationchange", schedule, { passive: true });
  } catch (_) {}
  schedule();
})();

/* -------------------------
 * FALLBACK SHARE MENU (platform links)
 * ------------------------- */
const __SHARE_MENU = { el: null };

function __ensureShareMenu() {
  if (__SHARE_MENU.el) return __SHARE_MENU.el;

  const wrap = document.createElement("div");
  wrap.id = "mt2ShareMenu";
  wrap.style.cssText = [
    "position:fixed; inset:0; z-index:2147483000;",
    "display:none; align-items:flex-end; justify-content:center;",
    "background:rgba(0,0,0,0.62);",
    "padding:16px;"
  ].join("");

  const panel = document.createElement("div");
  panel.style.cssText = [
    "width:min(520px, 96vw);",
    "border-radius:18px;",
    "background:linear-gradient(135deg, rgba(6,18,14,0.96), rgba(7,30,22,0.96));",
    "border:1px solid rgba(34,197,94,0.30);",
    "box-shadow:0 22px 80px rgba(0,0,0,0.55);",
    "padding:14px 14px 12px;",
    "margin-bottom: max(8px, env(safe-area-inset-bottom));"
  ].join("");

  const title = document.createElement("div");
  title.textContent = "Bagikan hasil";
  title.style.cssText = "font:900 16px system-ui,-apple-system,Segoe UI,Roboto,Arial; color:rgba(255,255,255,0.92); margin:4px 6px 10px;";

  const grid = document.createElement("div");
  grid.style.cssText = "display:grid; grid-template-columns:1fr 1fr; gap:10px;";

  function mkBtn(label) {
    const b = document.createElement("button");
    b.type = "button";
    b.textContent = label;
    b.style.cssText = [
      "appearance:none; border:1px solid rgba(255,255,255,0.12);",
      "background:rgba(255,255,255,0.06);",
      "color:rgba(255,255,255,0.92);",
      "border-radius:14px; padding:12px 10px;",
      "font:800 14px system-ui,-apple-system,Segoe UI,Roboto,Arial;",
      "cursor:pointer;"
    ].join("");
    b.onpointerdown = () => { b.style.transform = "scale(0.98)"; };
    b.onpointerup = () => { b.style.transform = "scale(1)"; };
    b.onpointercancel = () => { b.style.transform = "scale(1)"; };
    return b;
  }

  const closeRow = document.createElement("div");
  closeRow.style.cssText = "display:flex; gap:10px; margin-top:10px;";

  const closeBtn = mkBtn("Tutup");
  closeBtn.style.cssText += "flex:1; background:rgba(255,255,255,0.04);";
  closeBtn.addEventListener("click", () => __hideShareMenu());

  const copyBtn = mkBtn("Copy Link");
  copyBtn.style.cssText += "flex:1; border-color:rgba(34,197,94,0.35);";

  closeRow.appendChild(copyBtn);
  closeRow.appendChild(closeBtn);

  panel.appendChild(title);
  panel.appendChild(grid);
  panel.appendChild(closeRow);

  wrap.appendChild(panel);

  wrap.addEventListener("click", (e) => {
    if (e.target === wrap) __hideShareMenu();
  });

  document.body.appendChild(wrap);

  __SHARE_MENU.el = wrap;
  __SHARE_MENU.grid = grid;
  __SHARE_MENU.copyBtn = copyBtn;

  return wrap;
}

function __showShareMenu(payload) {
  const el = __ensureShareMenu();
  const grid = __SHARE_MENU.grid;
  grid.innerHTML = "";

  const url = String(payload.url || "");
  const text = String(payload.text || "");
  const title = String(payload.title || "");
  const encText = encodeURIComponent(text);
  const encUrl = encodeURIComponent(url);

  const targets = [
    ["WhatsApp", `https://wa.me/?text=${encText}`],
    ["Telegram", `https://t.me/share/url?url=${encUrl}&text=${encText}`],
    ["X / Twitter", `https://twitter.com/intent/tweet?text=${encText}`],
    ["Facebook", `https://www.facebook.com/sharer/sharer.php?u=${encUrl}`],
    ["LINE", `https://social-plugins.line.me/lineit/share?url=${encUrl}`],
    ["Email", `mailto:?subject=${encodeURIComponent(title)}&body=${encText}`],
  ];

  for (let i = 0; i < targets.length; i++) {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.textContent = targets[i][0];
    btn.style.cssText = [
      "appearance:none; border:1px solid rgba(255,255,255,0.12);",
      "background:rgba(255,255,255,0.06);",
      "color:rgba(255,255,255,0.92);",
      "border-radius:14px; padding:12px 10px;",
      "font:800 14px system-ui,-apple-system,Segoe UI,Roboto,Arial;",
      "cursor:pointer;"
    ].join("");
    btn.addEventListener("click", () => {
      try { window.open(targets[i][1], "_blank", "noopener,noreferrer"); } catch (_) {}
      __hideShareMenu();
    });
    grid.appendChild(btn);
  }

  __SHARE_MENU.copyBtn.onclick = async () => {
    try {
      const clip = url ? url : text;
      if (navigator.clipboard && navigator.clipboard.writeText) await navigator.clipboard.writeText(clip);
      __toast("Link disalin", "success");
    } catch (_) {
      __toast("Gagal menyalin link", "error");
    }
    __hideShareMenu();
  };

  el.style.display = "flex";
}

function __hideShareMenu() {
  try { if (__SHARE_MENU.el) __SHARE_MENU.el.style.display = "none"; } catch (_) {}
}

/* -------------------------
 * PUBLIC API
 * ------------------------- */
function downloadResultPng() {
  const rSafe = __getLastResult();
  if (!rSafe) { __toast("Hasil belum tersedia. Silakan spin terlebih dahulu.", "error"); return; }
  __kick();

  const r = rSafe;
  const ts = r.ts || Date.now();

  const preOpen = __isIOS();
  let preTab = null;
  if (preOpen) {
    try { preTab = window.open("about:blank", "_blank", "noopener,noreferrer"); } catch (_) { preTab = null; }
  }

  makeRewardPngBlob(r, ts, { intent: "download" })
    .then(({ blob, fileName, dataUrl }) => {
      const name = fileName || buildFileName(r.userId, ts);

      if (blob instanceof Blob) {
        try {
          const url = URL.createObjectURL(blob);
          try { triggerDownload(url, name); } catch (_) {}
          if (preTab && !preTab.closed) { try { preTab.location.href = url; } catch (_) {} }
          setTimeout(() => { try { URL.revokeObjectURL(url); } catch (_) {} }, 60000);
          __toast("File hasil berhasil dibuat", "success");
          return;
        } catch (_) {}
      }

      if (typeof dataUrl === "string" && dataUrl.startsWith("data:image/")) {
        try { triggerDownload(dataUrl, name); }
        catch (_) {
          try {
            if (preTab && !preTab.closed) preTab.location.href = dataUrl;
            else window.open(dataUrl, "_blank", "noopener,noreferrer");
          } catch (_) {}
        }
        __toast("File hasil berhasil dibuat", "success");
        return;
      }

      __toast("Gagal membuat gambar.", "error");
      try { if (preTab && !preTab.closed) preTab.close(); } catch (_) {}
    })
    .catch(() => {
      __toast("Gagal membuat gambar hasil.", "error");
      try { if (preTab && !preTab.closed) preTab.close(); } catch (_) {}
    });
}

/* ✅ Share via Web Share API + ALWAYS include play link */
async function shareResultPng() {
  const rSafe = __getLastResult();
  if (!rSafe) { __toast("Hasil belum tersedia. Silakan spin terlebih dahulu.", "error"); return; }
  __kick();

  const r = rSafe;
  const ts = r.ts || Date.now();

  const playUrl = __getPlayUrl();
  const prize = String(r.prizeLabel || "BONUS 10%");
  const safeUser = String(r.userId || "-");
  const timeStr = new Date(ts).toLocaleString("id-ID", {
    day: "2-digit", month: "short", year: "numeric",
    hour: "2-digit", minute: "2-digit", second: "2-digit"
  });

  const shareTitle = "MADETOTO2 — Hasil Spin";

  // ✅ TEXT untuk Web Share (TANPA URL) agar WA tidak dobel
  const shareTextNoUrl =
    `🎉 MADETOTO2\n` +
    `Hadiah: ${prize}\n` +
    `User ID: ${safeUser}\n` +
    `Waktu: ${timeStr}\n` +
    `Ayo coba spin!`;

  // ✅ TEXT untuk Clipboard/fallback (PAKAI URL) agar tetap kebawa
  const shareTextWithUrl =
    shareTextNoUrl + `\nMainkan di: ${playUrl}`;

  // iOS: WA sering buang caption kalau share files -> prioritaskan text+url
  const isIOS = __isIOS();

  // 1) Web Share API (text + url) — paling konsisten & tidak dobel link
  if (typeof navigator !== "undefined" && typeof navigator.share === "function") {
    try {
      await navigator.share({
        title: shareTitle,
        text: shareTextNoUrl,
        url: playUrl
      });
      __toast("Menu bagikan dibuka", "success");
      return;
    } catch (err) {
      if (err && (err.name === "AbortError" || String(err.message || "").includes("AbortError"))) {
        __toast("Bagikan dibatalkan", "error");
        return;
      }
      // lanjut fallback
    }
  }

  // 2) Clipboard fallback (pasti ada URL)
  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(shareTextWithUrl);
      __toast("Teks + link disalin. Tinggal paste ke sosmed.", "success");
      return;
    }
  } catch (_) {}

  // 3) Last fallback: WhatsApp share link
  try {
    const wa = "https://wa.me/?text=" + encodeURIComponent(shareTextWithUrl);
    window.open(wa, "_blank", "noopener,noreferrer");
    __toast("Buka WhatsApp untuk bagikan.", "success");
    return;
  } catch (_) {}

  __toast("Browser tidak mendukung fitur bagikan.", "error");
}

/* -------------------------
 * SAFE BIND (anti double bind)
 * ------------------------- */
(function bindDownloadShareButtonsOnce() {
  try {
    const dBtn = document.getElementById("downloadBtn");
    if (dBtn && !dBtn.dataset.boundDownload) {
      dBtn.dataset.boundDownload = "1";
      dBtn.addEventListener("click", downloadResultPng);
    }

    const sBtn = document.getElementById("shareBtn");
    if (sBtn && !sBtn.dataset.boundShare) {
      sBtn.dataset.boundShare = "1";
      sBtn.addEventListener("click", shareResultPng);
    }
  } catch (_) {}
})();

/* -------------------------
 * CORE: generate PNG blob (shared by download/share)
 * ------------------------- */
function makeRewardPngBlob(r, ts, opt) {
  return new Promise((resolve, reject) => {
    try {
      const t = r || {};
      const stamp = ts || Date.now();
      const intent = (opt && opt.intent) ? String(opt.intent) : "download";

      const mobile = __isMobileLike();
      const baseW = mobile ? (intent === "share" ? 900 : 960) : 1080;

      const rawDpr = (typeof window !== "undefined" && window.devicePixelRatio) ? window.devicePixelRatio : 1;
      const dprCap = mobile ? (intent === "share" ? 1.6 : 1.9) : 2;
      const dpr = Math.max(1, Math.min(dprCap, rawDpr || 1));

      const playUrl = (opt && opt.playUrl) ? String(opt.playUrl) : __getPlayUrl();
      const playShort = __shortUrl(playUrl);

      const lay = calcRewardPngLayout(t, stamp, { baseW, playShort });

      const canvas = document.createElement("canvas");
      canvas.width = Math.floor(lay.baseW * dpr);
      canvas.height = Math.floor(lay.baseH * dpr);

      const ctx = canvas.getContext("2d");
      if (!ctx) { reject(new Error("no_ctx")); return; }
      ctx.scale(dpr, dpr);

      const g = ctx.createLinearGradient(0, 0, lay.baseW, lay.baseH);
      g.addColorStop(0, "#06130f");
      g.addColorStop(0.55, "#071e16");
      g.addColorStop(1, "#05281d");
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, lay.baseW, lay.baseH);

      drawOrb(ctx, Math.min(260, lay.baseW * 0.24), 220, 260, "rgba(34,197,94,0.14)");
      drawOrb(ctx, lay.baseW - Math.min(220, lay.baseW * 0.20), 320, 220, "rgba(255,255,255,0.07)");
      drawOrb(ctx, lay.baseW - Math.min(260, lay.baseW * 0.24), lay.baseH - 260, 300, "rgba(20,184,166,0.10)");

      roundRect(ctx, lay.cardX, lay.cardY, lay.cardW, lay.cardH, 34);

      const cg = ctx.createLinearGradient(lay.cardX, lay.cardY, lay.cardX + lay.cardW, lay.cardY + lay.cardH);
      cg.addColorStop(0, "rgba(6,18,14,0.95)");
      cg.addColorStop(1, "rgba(7,30,22,0.95)");
      ctx.fillStyle = cg;
      ctx.fill();

      ctx.lineWidth = 4;
      ctx.strokeStyle = "rgba(34,197,94,0.55)";
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,0.95)";
      ctx.font = "900 44px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("MADETOTO2", lay.innerX, lay.brandY);

      ctx.fillStyle = "rgba(255,255,255,0.78)";
      ctx.font = "700 24px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("HASIL SPIN REWARD", lay.innerX, lay.subY);

      ctx.fillStyle = "#bbf7d0";
      ctx.font = `1000 ${lay.prize.fontSize}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;

      ctx.save();
      ctx.shadowColor = "rgba(0,0,0,0.28)";
      ctx.shadowBlur = 18;
      ctx.shadowOffsetY = 10;
      for (let i = 0; i < lay.prize.lines.length; i++) {
        ctx.fillText(lay.prize.lines[i], lay.innerX, lay.prizeStartY + i * lay.prize.lineH);
      }
      ctx.restore();

      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(lay.innerX, lay.dividerY);
      ctx.lineTo(lay.innerX + lay.innerW, lay.dividerY);
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,0.70)";
      ctx.font = "800 22px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace";
      ctx.fillText("USER ID", lay.innerX, lay.userLabelY);
      ctx.fillText("WAKTU", lay.innerX, lay.timeLabelY);

      ctx.fillStyle = "rgba(255,255,255,0.96)";
      ctx.font = "900 32px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace";
      ctx.fillText(String(t.userId || "-"), lay.innerX, lay.userValueY);

      const timeStr = new Date(stamp).toLocaleString("id-ID", {
        day: "2-digit", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });
      ctx.fillText(timeStr, lay.innerX, lay.timeValueY);

      roundRect(ctx, lay.noteX, lay.noteY, lay.noteW, lay.noteH, 22);
      ctx.fillStyle = "rgba(0,0,0,0.30)";
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,0.88)";
      ctx.font = "800 22px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      for (let i = 0; i < lay.noteLines.length; i++) {
        ctx.fillText(lay.noteLines[i], lay.noteTextX, lay.noteTextY + i * lay.noteLineH);
      }

      // footer (domain tampil)
      ctx.fillStyle = "rgba(255,255,255,0.55)";
      ctx.font = "700 18px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText(`Mainkan: ${playShort}`, lay.innerX, lay.footerY);

      const fileName = buildFileName(t.userId, stamp);

      let dataUrl = "";
      try { dataUrl = canvas.toDataURL("image/png"); } catch (_) { dataUrl = ""; }

      if (canvas.toBlob) {
        canvas.toBlob((b) => {
          if (b) { resolve({ blob: b, fileName, dataUrl }); return; }
          try {
            const b2 = dataUrl ? dataUrlToBlob(dataUrl) : null;
            resolve({ blob: b2, fileName, dataUrl });
          } catch (_) {
            resolve({ blob: null, fileName, dataUrl });
          }
        }, "image/png");
      } else {
        try {
          const b = dataUrl ? dataUrlToBlob(dataUrl) : null;
          resolve({ blob: b, fileName, dataUrl });
        } catch (_) {
          resolve({ blob: null, fileName, dataUrl });
        }
      }
    } catch (e) {
      reject(e);
    }
  });
}

function dataUrlToBlob(dataUrl) {
  const parts = String(dataUrl || "").split(",");
  const meta = parts[0] || "";
  const b64 = parts[1] || "";
  const mime = (meta.match(/data:([^;]+)/i) || [])[1] || "image/png";
  const bin = atob(b64);
  const len = bin.length;
  const arr = new Uint8Array(len);
  for (let i = 0; i < len; i++) arr[i] = bin.charCodeAt(i);
  return new Blob([arr], { type: mime });
}

/* -------------------------
 * Download helpers
 * ------------------------- */
function triggerDownload(url, filename) {
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.rel = "noopener";
  a.target = "_blank";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

function buildFileName(userId, ts) {
  const d = new Date(ts || Date.now());
  const y = d.getFullYear();
  const m = __pad2(d.getMonth() + 1);
  const da = __pad2(d.getDate());
  const hh = __pad2(d.getHours());
  const mm = __pad2(d.getMinutes());

  const safeId = String(userId || "USER").replace(/[^A-Z0-9_-]/gi, "").slice(0, 18) || "USER";
  return `MADETOTO2-REWARD-${safeId}-${y}${m}${da}-${hh}${mm}.png`;
}

function drawOrb(ctx, x, y, r, color) {
  const g = ctx.createRadialGradient(x, y, 0, x, y, r);
  g.addColorStop(0, color);
  g.addColorStop(1, "rgba(0,0,0,0)");
  ctx.fillStyle = g;
  ctx.beginPath();
  ctx.arc(x, y, r, 0, Math.PI * 2);
  ctx.fill();
}

function roundRect(ctx, x, y, w, h, r) {
  const rr = Math.min(r, w / 2, h / 2);
  ctx.beginPath();
  ctx.moveTo(x + rr, y);
  ctx.arcTo(x + w, y, x + w, y + h, rr);
  ctx.arcTo(x + w, y + h, x, y + h, rr);
  ctx.arcTo(x, y + h, x, y, rr);
  ctx.arcTo(x, y, x + w, y, rr);
  ctx.closePath();
}

/* -------------------------
 * LAYOUT (MEASURE)
 * ------------------------- */
const __MEASURE = { ctx: null };
function getMeasureCtx() {
  try {
    if (__MEASURE.ctx) return __MEASURE.ctx;
    const c = document.createElement("canvas");
    c.width = 64; c.height = 64;
    __MEASURE.ctx = c.getContext("2d");
    return __MEASURE.ctx;
  } catch (_) {
    return null;
  }
}

function calcRewardPngLayout(r, ts, opt) {
  const baseW = (opt && opt.baseW) ? Math.max(720, Math.min(1080, Number(opt.baseW) || 1080)) : 1080;
  const playShort = (opt && opt.playShort) ? String(opt.playShort || "") : "";

  const pad = Math.round(baseW * 0.061);
  const cardX = pad;
  const cardY = 120;
  const cardW = baseW - pad * 2;

  const innerX = cardX + 44;
  const innerW = cardW - 88;

  const brandY = cardY + 90;
  const subY = cardY + 140;

  const prizeStartY = cardY + 255;
  const prizeText = String(r.prizeLabel || "BONUS 10%");

  const mctx = getMeasureCtx();
  if (!mctx) {
    const prize = { fontSize: 72, lineH: 64, lines: [prizeText] };
    const dividerY = prizeStartY + 120;
    const userLabelY = dividerY + 70;
    const userValueY = userLabelY + 42;
    const timeLabelY = userValueY + 64;
    const timeValueY = timeLabelY + 40;
    const noteY = timeValueY + 56;
    const noteX = innerX;
    const noteW = innerW;
    const noteTextX = noteX + 26;
    const noteTextY = noteY + 44;
    const noteLineH = 28;

    const noteLines = playShort
      ? [`Mainkan di: ${playShort}`, "Klaim via Live Chat + sertakan", "USER ID + gambar ini."]
      : ["Silakan klaim melalui Live Chat", "dan sertakan USER ID + hasil unduh ini."];

    const noteH = playShort ? 132 : 110;
    const footerY = noteY + noteH + 58;
    const cardH = (footerY + 40) - cardY;
    const baseH = cardY + cardH + 110;

    return {
      baseW, baseH,
      cardX, cardY, cardW, cardH,
      innerX, innerW,
      brandY, subY,
      prizeStartY, prize,
      dividerY,
      userLabelY, userValueY,
      timeLabelY, timeValueY,
      noteX, noteY, noteW, noteH,
      noteLines, noteLineH, noteTextX, noteTextY,
      footerY
    };
  }

  const prize = layoutAdaptiveHeadline(mctx, prizeText, innerW, {
    maxFont: Math.min(86, Math.round(baseW * 0.08)),
    minFont: Math.max(52, Math.round(baseW * 0.052)),
    weight: 1000,
    family: "system-ui, -apple-system, Segoe UI, Roboto, Arial",
    lineHScale: 0.90,
    maxLines: 2
  });

  const prizeBlockH = Math.ceil((prize.lines.length - 1) * prize.lineH + prize.fontSize * 1.12);
  const prizeBottom = prizeStartY + prizeBlockH;
  const dividerY = Math.ceil(prizeBottom + 14);

  const userLabelY = dividerY + 70;
  const userValueY = userLabelY + 42;

  const timeLabelY = userValueY + 64;
  const timeValueY = timeLabelY + 40;

  const noteY = Math.ceil(timeValueY + 56);
  const noteX = innerX;
  const noteW = innerW;

  const noteFont = "800 22px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const noteLineH = 28;

  mctx.font = noteFont;
  const noteInnerPadX = 26;
  const noteInnerPadY = 22;
  const noteMaxW = noteW - noteInnerPadX * 2;

  const noteText = playShort
    ? `Mainkan di: ${playShort} • Klaim via Live Chat dan sertakan USER ID + gambar ini.`
    : "Silakan klaim melalui Live Chat dan sertakan USER ID + hasil unduh ini.";

  const noteLines = wrapLinesByWords(mctx, noteText, noteMaxW, 3);
  const noteH = Math.max(68, noteInnerPadY * 2 + noteLines.length * noteLineH + 2);

  const noteTextX = noteX + noteInnerPadX;
  const noteTextY = noteY + noteInnerPadY + 22;

  const footerY = Math.ceil(noteY + noteH + 58);

  const cardH = Math.ceil((footerY + 40) - cardY);
  const baseH = Math.ceil(cardY + cardH + 110);

  return {
    baseW, baseH,
    cardX, cardY, cardW, cardH,
    innerX, innerW,
    brandY, subY,
    prizeStartY, prize,
    dividerY,
    userLabelY, userValueY,
    timeLabelY, timeValueY,
    noteX, noteY, noteW, noteH,
    noteLines, noteLineH, noteTextX, noteTextY,
    footerY
  };
}

function layoutAdaptiveHeadline(ctx, text, maxWidth, opt) {
  const t = String(text || "").trim();
  const maxFont = opt.maxFont || 86;
  const minFont = opt.minFont || 56;
  const weight = opt.weight || 1000;
  const family = opt.family || "system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const maxLines = opt.maxLines || 2;
  const lineHScale = opt.lineHScale || 0.92;

  let fontSize = maxFont;
  let lines = [t];

  while (fontSize >= minFont) {
    ctx.font = `${weight} ${fontSize}px ${family}`;
    lines = wrapLinesByWords(ctx, t, maxWidth, maxLines);
    if (lines.length <= maxLines) break;
    fontSize -= 2;
  }

  const lineH = Math.ceil(fontSize * lineHScale);
  return { fontSize, lineH, lines };
}

function wrapLinesByWords(ctx, text, maxWidth, maxLines) {
  const words = String(text || "").split(/\s+/).filter(Boolean);
  const lines = [];
  let line = "";

  for (let i = 0; i < words.length; i++) {
    const test = line ? (line + " " + words[i]) : words[i];
    const w = ctx.measureText(test).width;

    if (w <= maxWidth) { line = test; continue; }

    if (line) lines.push(line);
    line = words[i];

    if (lines.length === (maxLines - 1)) break;
  }

  if (line) lines.push(line);

  if (lines.length === maxLines) {
    const lastIdx = maxLines - 1;
    lines[lastIdx] = fitTextWithEllipsis(ctx, lines[lastIdx], maxWidth);
  }

  return lines;
}

function fitTextWithEllipsis(ctx, text, maxWidth) {
  const ell = "…";
  if (ctx.measureText(text).width <= maxWidth) return text;

  let t = String(text || "");
  while (t.length > 1 && ctx.measureText(t + ell).width > maxWidth) {
    t = t.slice(0, -1);
  }
  return t.trim() + ell;
}

  /* =========================================================
   * 19) CLAIM (loading overlay) + watchdog
   * ======================================================= */
  let claimInFlight = false;
  let claimWatchdogT = 0;

  function isNavOpen() {
    const el = document.getElementById("navLoading");
    return !!(el && el.classList.contains("show"));
  }

  function showNavLoading() {
    const el = document.getElementById("navLoading");
    if (!el) return;

    pauseHistory("nav");
    setInert("nav", true);

    el.classList.add("show");
    el.setAttribute("aria-hidden", "false");

    document.body.classList.add("modal-open");
  }

  function hideNavLoading(immediate = false) {
    const el = document.getElementById("navLoading");
    if (!el) return;

    const done = () => {
      el.classList.remove("show");
      el.setAttribute("aria-hidden", "true");

      claimInFlight = false;

      resumeHistory("nav");
      setInert("nav", false);

      if (!isModalOpen()) document.body.classList.remove("modal-open");
    };

    if (claimWatchdogT) { clearTimeout(claimWatchdogT); claimWatchdogT = 0; }

    if (immediate || isReducedMotion()) { done(); return; }

    el.classList.remove("show");
    el.setAttribute("aria-hidden", "true");
    setTimeout(done, 260);
  }

  function claimPrize() {
    if (claimInFlight) return;
    claimInFlight = true;

    closeModal();
    showNavLoading();

    const start = (performance.now ? performance.now() : Date.now());
    const minHold = isReducedMotion() ? 0 : CONFIG.CLAIM_OVERLAY_MIN_MS;

    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        const now = (performance.now ? performance.now() : Date.now());
        const elapsed = now - start;
        const wait = Math.max(0, minHold - elapsed);

        setTimeout(() => {
          // watchdog: if still here after 10s, unlock
          claimWatchdogT = setTimeout(() => {
            if (isNavOpen() && !document.hidden) {
              hideNavLoading(true);
              showToast("Gagal membuka halaman klaim. Coba tekan KLAIM lagi.", "error", 2600);
            }
          }, 10000);

          try { window.location.href = CONFIG.CLAIM_URL; } catch (_) {
            hideNavLoading(true);
            showToast("Tidak bisa membuka halaman klaim.", "error", 2400);
          }
        }, wait);
      });
    });
  }

   /* =========================================================
   * 20) CELEBRATE (CONFETTI FRONT-LAYER) — FULL REPLACE
   * ✅ Confetti selalu di paling depan (anti ketutup modal/reward)
   * ✅ Canvas singleton (anti dobel / anti leak)
   * ✅ pointer-events: none (tidak ganggu klik)
   * ======================================================= */

  const CONFETTI_Z = 2147483647; // z-index super tinggi (max 32-bit)
  let __mt2Confetti = null;

  function ensureFrontConfetti() {
    // Pastikan library confetti ada
    if (typeof confetti !== "function") return null;

    // Reuse instance jika sudah ada
    if (__mt2Confetti && typeof __mt2Confetti === "function") return __mt2Confetti;

    try {
      // Buat canvas khusus confetti di BODY (lapisan paling atas)
      let canvas = document.getElementById("mt2ConfettiCanvas");
      if (!canvas) {
        canvas = document.createElement("canvas");
        canvas.id = "mt2ConfettiCanvas";
        canvas.setAttribute("aria-hidden", "true");
        Object.assign(canvas.style, {
          position: "fixed",
          inset: "0",
          width: "100%",
          height: "100%",
          zIndex: String(CONFETTI_Z),
          pointerEvents: "none",
          userSelect: "none",
          touchAction: "none",
          display: "block",
          // bantu jaga di atas layer yang "aneh" karena stacking context
          transform: "translateZ(0)",
        });
        document.body.appendChild(canvas);
      } else {
        // kalau sudah ada, paksa tetap top
        canvas.style.zIndex = String(CONFETTI_Z);
        canvas.style.pointerEvents = "none";
        canvas.style.position = "fixed";
        canvas.style.inset = "0";
      }

      // Create instance confetti yang nembak ke canvas kita (auto resize)
      __mt2Confetti = confetti.create(canvas, { resize: true, useWorker: true });
      return __mt2Confetti;
    } catch (_) {
      // fallback: pakai global confetti dengan zIndex option
      __mt2Confetti = (opts) => {
        try { confetti({ zIndex: CONFETTI_Z, ...opts }); } catch (_) {}
      };
      return __mt2Confetti;
    }
  }

  function celebrateWin() {
    if (isReducedMotion()) return;

    const shoot = ensureFrontConfetti();
    if (!shoot) return;

    const duration = 2200;
    const end = Date.now() + duration;

    const frame = () => {
      try {
        // Pastikan z-index tetap di atas setiap frame (kalau modal re-render)
        const c = document.getElementById("mt2ConfettiCanvas");
        if (c) c.style.zIndex = String(CONFETTI_Z);

        shoot({
          particleCount: 6,
          angle: 60,
          spread: 58,
          startVelocity: 32,
          gravity: 1.05,
          ticks: 210,
          scalar: 1,
          origin: { x: 0, y: 0.25 },
          zIndex: CONFETTI_Z,
        });

        shoot({
          particleCount: 6,
          angle: 120,
          spread: 58,
          startVelocity: 32,
          gravity: 1.05,
          ticks: 210,
          scalar: 1,
          origin: { x: 1, y: 0.25 },
          zIndex: CONFETTI_Z,
        });
      } catch (_) {}

      if (Date.now() < end) requestAnimationFrame(frame);
    };

    frame();
  }

  /* =========================================================
   * 21) Persist user entry + rotation consistency
   * ======================================================= */
  function bootPersistedUserEntry() {
    if (hasSpun && !spinAt) { spinAt = Date.now(); lsSet(LS.SPIN_AT, String(spinAt)); }

    if (hasSpun && savedUserId) {
      lastResult = {
        userId: savedUserId,
        prizeLabel: BONUS_LABEL,
        prizeDisplay: CONFIG.PRIZE_DISPLAY_MAP[BONUS_LABEL],
        ts: (spinAt || Date.now())
      };

      // ensure user entry exists only once
      const already = winners.some((w) => w.isUser === true);
      if (!already) {
        pushWinnerEntry({
          id: makeEntryId("user"),
          isUser: true,
          fullId: savedUserId,
          displayId: savedUserId,
          prizeKey: BONUS_LABEL,
          prize: CONFIG.PRIZE_DISPLAY_MAP[BONUS_LABEL],
          ts: (spinAt || Date.now()),
          isNew: false
        });
      }
    }

    // keep modal pause clean if not actually open
    if (!isModalOpen()) {
      pauseReasons.delete("modal");
    }
  }
</script>
</body>
</html>