<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="referrer" content="no-referrer" />

  <!-- NOTE: isi og:url + canonical dengan URL final halaman kamu -->
  <meta property="og:url" content="" />
  <link rel="canonical" href="" />

  <meta property="og:title" content="MADETOTO2 - Spin & Win" />
  <meta name="description" content="PUTAR RODANYA & DAPATKAN HADIAH FANTASTIS HINGGA 200 RIBU RUPIAH!" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://shortq.org/gmbrmadetoto2" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="MADETOTO2 - Spin & Win" />
  <meta name="twitter:description" content="PUTAR RODANYA &amp; DAPATKAN HADIAH FANTASTIS HINGGA 200 RIBU RUPIAH!" />
  <meta name="twitter:image" content="https://shortq.org/gmbrmadetoto2" />

  <meta name="theme-color" content="#071a12" />
  <link rel="shortcut icon" href="https://shortq.org/gmbrmadetoto2" type="image/x-icon" />

<style>
  /* =========================
   * BASE / TOKENS (PREMIUM ‚Äî GREEN DEPTH SOFT)
   * ======================= */
  *, *::before, *::after { box-sizing: border-box; }
  * { margin: 0; padding: 0; }

  :root{
    color-scheme: dark;

    /* ‚úÖ softer green depth (less ‚Äúharsh‚Äù, more premium) */
    --bg0: #04110d;
    --bg1: #061c14;
    --bg2: #05271c;

    /* gold metal (keep as rim accent, but more balanced) */
    --gold0: #fff1d3;
    --gold1: #f3b24a;
    --gold2: #7a3f13;

    /* green accents (soft modern) */
    --green0: #d7ffe9;
    --green1: #3be07b;
    --green2: #128a45;

    --text: rgba(255,255,255,0.94);
    --muted: rgba(255,255,255,0.72);
    --muted2: rgba(255,255,255,0.56);

    --card: rgba(59, 224, 123, 0.06);
    --cardBorder: rgba(59, 224, 123, 0.20);

    --radius-lg: 20px;
    --radius-md: 14px;

    /* ‚úÖ smoother shadows (less ‚Äúoverglow‚Äù) */
    --shadow-soft: 0 0 56px -16px rgba(59,224,123,0.16);
    --shadow-deep: 0 26px 86px rgba(0,0,0,0.60);

    --ring: rgba(59,224,123,0.56);

    --safe-top: env(safe-area-inset-top, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);

    --gpu: translateZ(0);

    /* wheel */
    --rim-pad: clamp(12px, 3vw, 15px);
    --inner-safe-scale: 0.986;
  }

  html{
    width: 100%;
    height: 100%;
    background: var(--bg0);
    overscroll-behavior: none;
    -webkit-text-size-adjust: 100%;
    text-rendering: optimizeLegibility;
    scrollbar-gutter: stable;
  }

  body{
    min-height: 100svh;
    color: var(--text);
    font-family:
      ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
      "SF Pro Display","SF Pro Text","Segoe UI Variable","Segoe UI",
      Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
    overscroll-behavior: none;
    position: relative;
    isolation: isolate;

    background:
      radial-gradient(980px 560px at 82% 14%, rgba(59,224,123,0.12), transparent 62%),
      radial-gradient(920px 620px at 18% 10%, rgba(255,255,255,0.045), transparent 64%),
      radial-gradient(860px 560px at 20% 92%, rgba(20,184,166,0.085), transparent 60%),
      radial-gradient(760px 520px at 72% 84%, rgba(243,178,74,0.045), transparent 66%),
      linear-gradient(135deg, var(--bg0) 0%, var(--bg1) 48%, var(--bg2) 100%);
  }
  @supports (min-height: 100dvh){
    body{ min-height: 100dvh; }
  }

  /* vignette (tight, anti-leak) */
  body::before{
    content:"";
    position: fixed;
    inset: 0;
    pointer-events:none;
    z-index: 0;
    background:
      radial-gradient(1200px 760px at 50% 28%, rgba(255,255,255,0.05), transparent 64%),
      radial-gradient(1400px 920px at 50% 112%, rgba(0,0,0,0.60), transparent 58%),
      radial-gradient(920px 920px at -10% 22%, rgba(0,0,0,0.52), transparent 56%),
      radial-gradient(920px 920px at 110% 22%, rgba(0,0,0,0.50), transparent 56%);
    opacity: 0.92;
    transform: var(--gpu);
  }

  /* subtle grain (softer) */
  body::after{
    content:"";
    position: fixed;
    inset: 0;
    pointer-events:none;
    z-index: 1;
    opacity: 0.045;
    mix-blend-mode: overlay;
    background:
      repeating-linear-gradient(0deg,
        rgba(255,255,255,0.10) 0px,
        rgba(255,255,255,0.10) 1px,
        rgba(0,0,0,0.00) 2px,
        rgba(0,0,0,0.00) 4px
      ),
      repeating-linear-gradient(90deg,
        rgba(255,255,255,0.08) 0px,
        rgba(255,255,255,0.08) 1px,
        rgba(0,0,0,0.00) 2px,
        rgba(0,0,0,0.00) 5px
      );
    transform: var(--gpu);
  }

  @supports (overflow: clip){
    html, body { overflow-x: clip; }
  }
  @supports not (overflow: clip){
    html, body { overflow-x: hidden; }
  }

  body.modal-open { overflow: hidden; }

  img, video, canvas, svg { max-width: 100%; height: auto; display: block; }
  a, button, input { -webkit-tap-highlight-color: transparent; }
  button { touch-action: manipulation; }

  ::selection{
    background: rgba(59,224,123,0.18);
    color: #fff;
  }

  /* =========================
   * PREMIUM FX CANVAS
   * ======================= */
  #fxCanvas{
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 2;
    opacity: 0.78;
    mix-blend-mode: screen;
    transform: var(--gpu);
  }

  /* =========================
   * LAYOUT
   * ======================= */
  .container{
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    padding-left: calc(20px + var(--safe-left));
    padding-right: calc(20px + var(--safe-right));
    padding-top: calc(20px + var(--safe-top));
    padding-bottom: calc(20px + var(--safe-bottom));
    position: relative;
    z-index: 5;
  }
  @media (max-width: 420px){
    .container{
      padding: 16px;
      padding-left: calc(16px + var(--safe-left));
      padding-right: calc(16px + var(--safe-right));
      padding-top: calc(16px + var(--safe-top));
      padding-bottom: calc(16px + var(--safe-bottom));
    }
  }

  /* =========================
   * HEADER ‚Äî CLEAN / ANTI GLOW LEAK
   * ======================= */
  header{
    text-align: center;
    padding: clamp(14px, 2.6vw, 18px) clamp(14px, 3vw, 18px);
    position: relative;
    z-index: 10;

    background:
      radial-gradient(900px 220px at 50% -38%, rgba(255,255,255,0.075), transparent 64%),
      radial-gradient(560px 240px at 20% 34%, rgba(59,224,123,0.16), transparent 64%),
      linear-gradient(180deg, rgba(6, 28, 20, 0.86), rgba(4, 16, 12, 0.70));
    border-radius: 16px;
    border: 1px solid rgba(59,224,123,0.20);
    box-shadow:
      0 16px 60px rgba(0,0,0,0.54),
      0 0 0 1px rgba(0,0,0,0.24) inset,
      0 0 40px rgba(59,224,123,0.08);

    overflow: hidden;
    isolation: isolate;
    transform: var(--gpu);

    /* ‚úÖ hard-clip to stop glow leaking */
    -webkit-mask-image: -webkit-radial-gradient(white, black);
    clip-path: inset(0 round 16px);

    container-type: inline-size;
  }

  header::before{
    content:"";
    position:absolute;
    inset:-2px;
    pointer-events:none;
    z-index: 0;
    opacity: 0.30;
    filter: blur(1px);
    background:
      radial-gradient(560px 260px at 18% 28%, rgba(255,255,255,0.095), transparent 66%),
      radial-gradient(680px 280px at 86% 46%, rgba(59,224,123,0.18), transparent 66%),
      radial-gradient(560px 260px at 50% 140%, rgba(20,184,166,0.085), transparent 66%);
  }

  header::after{
    content:"";
    position:absolute;
    inset: 0;
    pointer-events:none;
    z-index: 1;
    opacity: 0.50;
    background:
      linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.00) 46%),
      radial-gradient(900px 240px at 50% -14%, rgba(255,255,255,0.075), transparent 62%);
    mix-blend-mode: overlay;
  }

  .hero-title{
    position: relative;
    z-index: 2;
    font-weight: 1000;
    text-transform: uppercase;
    line-height: 1.05;
    margin: 2px 0 clamp(8px, 1.4vw, 10px);
    text-shadow: 0 16px 40px rgba(0,0,0,0.60);

    display: inline-flex;
    flex-wrap: wrap;
    align-items: baseline;
    justify-content: center;
    gap: 0.42em;

    font-size: clamp(1.18rem, 3.2vw, 2.22rem);
    letter-spacing: clamp(0.06em, 0.22vw, 0.10em);
  }

  .hero-top{
    display: inline;
    font-size: inherit;
    color: rgba(215,255,233,0.92);
    white-space: nowrap;
  }

  .hero-brand{
    display: inline;
    font-size: inherit;
    white-space: nowrap;

    background: linear-gradient(180deg, #d7ffe9 0%, #65f0a3 44%, #3be07b 72%, #128a45 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;

    filter:
      drop-shadow(0 14px 28px rgba(59,224,123,0.14))
      drop-shadow(0 0 14px rgba(59,224,123,0.10));
  }

  .subtitle{
    font-size: clamp(0.74rem, 1.55cqw, 0.92rem);
    color: rgba(215,255,233,0.78);
    font-weight: 850;
    text-transform: uppercase;
    letter-spacing: clamp(0.06em, 0.18cqw, 0.10em);
    position: relative;
    z-index: 2;
    line-height: 1.35;
    text-shadow: 0 10px 24px rgba(0,0,0,0.56);
    max-width: 1100px;
    margin-left: auto;
    margin-right: auto;
    padding-inline: clamp(0px, 1.4cqw, 14px);
    text-wrap: balance;
  }
  @supports not (font-size: 1cqw){
    .subtitle{ font-size: clamp(0.74rem, 2.0vw, 0.92rem); padding-inline: 0; }
  }

  /* =========================
   * MAIN GRID
   * ======================= */
  .main-content{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: clamp(18px, 4vw, 34px);
    align-items: start;
    margin: clamp(18px, 4vw, 28px) 0 40px;
  }
  .main-content > * { min-width: 0; }
  @media (max-width: 900px){
    .main-content{ grid-template-columns: 1fr; gap: 26px; }
  }

/* =========================
 * LOCAL TOKENS (wheel only)
 * ======================= */
.wheel-container{
  --wheel-size: min(480px, 92vw, 56svh);
  --rim-pad: clamp(6px, 1.6vw, 12px);
  --gpu: translateZ(0);
  --inner-safe-scale: 1;
  --wheel-shadow: 0 38px 90px rgba(0,0,0,0.62);
  --gold-glow: 0 0 36px rgba(246,179,61,0.14);
  --green-glow: 0 0 42px rgba(59,224,123,0.10);
}
@supports (height: 100dvh){
  .wheel-container{ --wheel-size: min(480px, 92vw, 56dvh); }
}

/* =========================
 * WHEEL AREA ‚Äî CASINO LIGHTING
 * ======================= */
.wheel-container{
  position: relative;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  isolation: isolate;
  background: transparent;
  padding-top: clamp(14px, 3vw, 20px);
  padding-bottom: clamp(22px, 6vw, 46px);
}

/* Spotlight + felt vignette (lebih ‚Äúcasino‚Äù, gak norak) */
.wheel-container::before{
  content:"";
  position:absolute;
  left:50%;
  top: 40%;
  width: calc(var(--wheel-size) * 1.85);
  height: calc(var(--wheel-size) * 1.85);
  transform: translate(-50%, -50%);
  border-radius: 50%;
  pointer-events:none;
  z-index: 0;
  background:
    radial-gradient(circle at 50% 40%, rgba(59,224,123,0.10), transparent 60%),
    radial-gradient(circle at 50% 55%, rgba(243,178,74,0.08), transparent 66%),
    radial-gradient(circle at 50% 60%, rgba(0,0,0,0.70), transparent 64%);
  filter: blur(0.6px);
  opacity: 0.95;
}

/* Subtle beams (halus, jangan dominan) */
.wheel-container::after{
  content:"";
  position:absolute;
  left:50%;
  top: 22%;
  width: calc(var(--wheel-size) * 1.55);
  height: calc(var(--wheel-size) * 1.55);
  transform: translate(-50%, -50%);
  border-radius: 50%;
  pointer-events:none;
  z-index: 0;
  background:
    conic-gradient(from -12deg,
      rgba(255,255,255,0.00) 0deg,
      rgba(255,255,255,0.05) 18deg,
      rgba(255,255,255,0.00) 34deg,
      rgba(255,255,255,0.06) 64deg,
      rgba(255,255,255,0.00) 92deg,
      rgba(255,255,255,0.05) 128deg,
      rgba(255,255,255,0.00) 154deg,
      rgba(255,255,255,0.06) 190deg,
      rgba(255,255,255,0.00) 230deg,
      rgba(255,255,255,0.05) 268deg,
      rgba(255,255,255,0.00) 302deg,
      rgba(255,255,255,0.05) 332deg,
      rgba(255,255,255,0.00) 360deg
    );
  opacity: 0.42;
  filter: blur(1.1px);
  animation: wheelBeams 7.4s ease-in-out infinite;
  transform-origin: 50% 50%;
}
@keyframes wheelBeams{
  0%{ transform: translate(-50%, -50%) rotate(-1deg) scale(0.995); opacity: 0.34; }
  50%{ transform: translate(-50%, -50%) rotate(1.2deg) scale(1.01); opacity: 0.52; }
  100%{ transform: translate(-50%, -50%) rotate(-1deg) scale(0.995); opacity: 0.34; }
}

/* =========================
 * WRAPPER (stable)
 * ======================= */
.wheel-wrapper{
  position: relative;
  width: var(--wheel-size);
  aspect-ratio: 1 / 1;
  height: auto;
  max-width: 100%;
  touch-action: manipulation;
  user-select: none;
  -webkit-user-select: none;
  background: transparent;
  isolation: isolate;
  z-index: 2;
  transform: var(--gpu);
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}

/* =========================
 * POINTER ‚Äî CASINO CLEAN
 * ======================= */
.pointer{
  position: absolute;
  top: clamp(-34px, -6.4vw, -22px);
  left: 50%;
  width: clamp(40px, 10.5vw, 58px);
  height: clamp(56px, 13.6vw, 78px);
  transform: translateX(-50%) var(--gpu);
  transform-origin: 50% 18%;
  z-index: 30;
  pointer-events: none;
  filter:
    drop-shadow(0 18px 30px rgba(0,0,0,0.64))
    drop-shadow(0 0 18px rgba(59,224,123,0.10));
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}
.pointer svg{ width:100%; height:100%; display:block; }

.pointer.is-spin{ animation: pointerFloat 540ms ease-in-out infinite; }
@keyframes pointerFloat{
  0%{ transform: translateX(-50%) rotate(-1.1deg) translateY(0px) translateZ(0); }
  50%{ transform: translateX(-50%) rotate(1.7deg) translateY(1px) translateZ(0); }
  100%{ transform: translateX(-50%) rotate(-1.1deg) translateY(0px) translateZ(0); }
}
.pointer.is-kick{ animation: pointerKick 120ms ease-out 1; }
@keyframes pointerKick{
  0%{ transform: translateX(-50%) rotate(0deg) translateZ(0); }
  45%{ transform: translateX(-50%) rotate(var(--kick-deg, -11deg)) translateZ(0); }
  100%{ transform: translateX(-50%) rotate(0deg) translateZ(0); }
}

/* =========================
 * OUTER FRAME ‚Äî minimal (SVG sudah ada rim emas)
 * ======================= */
.wheel-outer{
  width: 100%;
  height: 100%;
  border-radius: 50%;
  padding: var(--rim-pad);
  position: relative;
  z-index: 2;
  isolation: isolate;
  overflow: visible; /* penting: jangan clip shadow */
  background: transparent;
  box-shadow: var(--wheel-shadow), var(--gold-glow), var(--green-glow);
  transform: var(--gpu);
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}

/* Inner frame ring (tipis aja, biar ‚Äúpremium frame‚Äù) */
.wheel-outer::after{
  content:"";
  position:absolute;
  inset: var(--rim-pad);
  border-radius: 50%;
  pointer-events:none;
  z-index: 1;
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.08),
    inset 0 10px 22px rgba(255,255,255,0.04),
    inset 0 -16px 24px rgba(0,0,0,0.26);
  opacity: 0.95;
}

/* =========================
 * WHEEL INNER ‚Äî SVG HOST (no conic bg)
 * ======================= */
.wheel-inner{
  width: 100%;
  height: 100%;
  border-radius: 50%;
  position: relative;
  overflow: hidden;
  isolation: isolate;

  /* penting: jangan pakai conic background lagi */
  background: transparent;
  border: 1px solid rgba(255,255,255,0.10);

  /* depth halus (biar 3D tapi tidak merusak SVG) */
  box-shadow:
    inset 0 0 0 1px rgba(0,0,0,0.20),
    inset 0 20px 40px rgba(0,0,0,0.26),
    inset 0 -18px 28px rgba(255,255,255,0.04);

  will-change: transform;
  transform: var(--gpu);
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;

  --spin-dur: 6000ms;
}

/* Subtle gloss + vignette (SANGAT halus) */
.wheel-inner::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:50%;
  pointer-events:none;
  z-index: 5; /* di atas SVG, tapi halus */
  background:
    radial-gradient(circle at 36% 22%, rgba(255,255,255,0.10), transparent 52%),
    radial-gradient(circle at 50% 58%, rgba(0,0,0,0.18), transparent 64%),
    radial-gradient(circle at 50% 50%, rgba(0,0,0,0.12), transparent 74%);
  opacity: 0.55;
  transform: scale(var(--inner-safe-scale)) translateZ(0);
  transform-origin: 50% 50%;
}

/* CORE FX ‚Äî turunin agresif (biar gak ‚Äúnabrak‚Äù SVG) */
.wheel-corefx{
  position:absolute;
  inset:0;
  border-radius:50%;
  pointer-events:none;
  z-index: 6;
  transform-origin: 50% 50%;
  opacity: 0.38;            /* ‚úÖ lebih kecil */
  filter: blur(0.55px);
  will-change: transform;
  mix-blend-mode: screen;

  background:
    conic-gradient(from 0deg,
      rgba(255,255,255,0.00) 0deg,
      rgba(255,255,255,0.10) 28deg,
      rgba(59,224,123,0.12) 58deg,
      rgba(255,255,255,0.00) 110deg,
      rgba(243,178,74,0.10) 150deg,
      rgba(255,255,255,0.00) 230deg,
      rgba(59,224,123,0.10) 300deg,
      rgba(255,255,255,0.00) 360deg
    );

  -webkit-mask: radial-gradient(circle at 50% 50%,
    rgba(0,0,0,1) 0%,
    rgba(0,0,0,1) 34%,
    rgba(0,0,0,0.78) 46%,
    rgba(0,0,0,0.00) 60%,
    rgba(0,0,0,0.00) 100%
  );
          mask: radial-gradient(circle at 50% 50%,
    rgba(0,0,0,1) 0%,
    rgba(0,0,0,1) 34%,
    rgba(0,0,0,0.78) 46%,
    rgba(0,0,0,0.00) 60%,
    rgba(0,0,0,0.00) 100%
  );

  animation: coreFXRotate 10.5s linear infinite;
}
@keyframes coreFXRotate{
  from{ transform: translateZ(0) scale(var(--inner-safe-scale)) rotate(0deg); }
  to  { transform: translateZ(0) scale(var(--inner-safe-scale)) rotate(360deg); }
}

/* Spin animation (tetap) */
.wheel-inner.spinning{
  animation: spin-wheel var(--spin-dur) cubic-bezier(0.15, 0, 0.15, 1) forwards;
}
@keyframes spin-wheel{
  from { transform: rotate(var(--from-rotation, 0deg)) translateZ(0); }
  to   { transform: rotate(var(--rotation)) translateZ(0); }
}

/* during spin: corefx sedikit naik, tapi tetap elegan */
.wheel-inner.spinning .wheel-corefx{
  opacity: 0.52;
  animation-duration: 2.2s;
}

/* Legacy prize-text (sekarang pakai SVG text) */
.prize-text{ display:none !important; }

/* =========================
 * CENTER HUB ‚Äî GOLD COIN / FACETED (REF MATCH)
 * - Gold coin look + faceted jewel center
 * - Thin outer gold ring + bevel
 * - Specular highlight on top-left (casino feel)
 * ======================= */

.wheel-center{
  position:absolute;
  top:50%;
  left:50%;
  transform: translate(-50%, -50%) translateZ(0);

  /* size modern (tidak kebesaran) */
  width: clamp(56px, 12.8vw, 78px);
  height: clamp(56px, 12.8vw, 78px);

  border-radius:50%;
  overflow:hidden;
  isolation:isolate;
  z-index:20;

  /* GOLD COIN base */
  background:
    radial-gradient(circle at 32% 22%, rgba(255,255,255,0.38), transparent 48%),
    radial-gradient(circle at 60% 78%, rgba(0,0,0,0.40), transparent 68%),
    linear-gradient(180deg,
      #fff4d6 0%,
      #f7d27e 18%,
      #f6b33d 46%,
      #c46b1c 74%,
      #7a3f13 100%
    );

  /* crisp edge */
  border: 1px solid rgba(255, 232, 176, 0.22);

  box-shadow:
    0 18px 44px rgba(0,0,0,0.58),
    0 0 18px rgba(246,179,61,0.16),
    0 0 22px rgba(59,224,123,0.06),
    inset 0 0 0 1px rgba(0,0,0,0.14),
    inset 0 10px 16px rgba(255,255,255,0.05),
    inset 0 -16px 18px rgba(0,0,0,0.20);

  backface-visibility:hidden;
  -webkit-backface-visibility:hidden;
  will-change: transform, filter;
}

/* ‚úÖ thin outer gold ring (biar mirip referensi) */
.wheel-center::before{
  content:"";
  position:absolute;
  inset: -2%;
  border-radius:50%;
  pointer-events:none;
  z-index: 1;

  background:
    conic-gradient(from 12deg,
      rgba(255,255,255,0.30),
      rgba(0,0,0,0.00) 14%,
      rgba(255,255,255,0.12) 26%,
      rgba(0,0,0,0.00) 42%,
      rgba(255,255,255,0.20) 58%,
      rgba(0,0,0,0.00) 74%,
      rgba(255,255,255,0.30) 100%
    );

  opacity: 0.55;
  filter: blur(0.25px);
  mix-blend-mode: screen;
}

/* ‚úÖ faceted gem / coin core (diamond facets) */
.wheel-center::after{
  content:"";
  position:absolute;
  left:50%;
  top:50%;
  transform: translate(-50%, -50%) translateZ(0);

  width: 58%;
  height: 58%;
  border-radius:50%;
  z-index: 3;

  /* facets: conic + radial = ‚Äúdiamond coin‚Äù */
  background:
    conic-gradient(from -18deg,
      rgba(255,255,255,0.00) 0deg,
      rgba(255,255,255,0.18) 18deg,
      rgba(0,0,0,0.10) 42deg,
      rgba(255,255,255,0.16) 68deg,
      rgba(0,0,0,0.12) 98deg,
      rgba(255,255,255,0.14) 128deg,
      rgba(0,0,0,0.14) 164deg,
      rgba(255,255,255,0.16) 210deg,
      rgba(0,0,0,0.12) 252deg,
      rgba(255,255,255,0.14) 292deg,
      rgba(0,0,0,0.10) 330deg,
      rgba(255,255,255,0.00) 360deg
    ),
    radial-gradient(circle at 34% 28%, rgba(255,255,255,0.28), transparent 52%),
    radial-gradient(circle at 60% 72%, rgba(0,0,0,0.38), transparent 66%),
    linear-gradient(180deg,
      rgba(255,244,214,0.96),
      rgba(246,179,61,0.92),
      rgba(138,74,22,0.92)
    );

  border: 1px solid rgba(255,255,255,0.16);
  box-shadow:
    inset 0 0 0 1px rgba(0,0,0,0.18),
    inset 0 10px 18px rgba(255,255,255,0.06),
    inset 0 -16px 18px rgba(0,0,0,0.26);
}

/* ‚úÖ moving specular sheen (top-left sweep) */
.wheel-center .hub-sheen{
  position:absolute;
  inset:-18%;
  border-radius:50%;
  pointer-events:none;
  z-index: 4;

  opacity: 0.38;
  mix-blend-mode: screen;
  filter: blur(0.35px);
  will-change: transform;

  background:
    radial-gradient(circle at 28% 22%, rgba(255,255,255,0.40), transparent 48%),
    conic-gradient(from 0deg,
      rgba(255,255,255,0.00) 0deg,
      rgba(255,255,255,0.18) 28deg,
      rgba(255,255,255,0.00) 74deg,
      rgba(255,255,255,0.10) 132deg,
      rgba(255,255,255,0.00) 220deg,
      rgba(255,255,255,0.14) 276deg,
      rgba(255,255,255,0.00) 360deg
    );

  animation: hubSheen 8.8s linear infinite;
}
@keyframes hubSheen{
  to { transform: rotate(360deg) translateZ(0); }
}

/* ‚úÖ spin pulse (subtle, premium) */
.wheel-inner.spinning .wheel-center{
  animation: hubPulse 1.55s ease-in-out infinite;
}
.wheel-inner.spinning .wheel-center .hub-sheen{
  animation-duration: 1.25s;
}
@keyframes hubPulse{
  0%{
    filter: drop-shadow(0 0 8px rgba(246,179,61,0.10));
    transform: translate(-50%,-50%) scale(1) translateZ(0);
  }
  50%{
    filter: drop-shadow(0 0 14px rgba(246,179,61,0.14));
    transform: translate(-50%,-50%) scale(1.02) translateZ(0);
  }
  100%{
    filter: drop-shadow(0 0 8px rgba(246,179,61,0.10));
    transform: translate(-50%,-50%) scale(1) translateZ(0);
  }
}

/* =========================
 * Reduced motion
 * ======================= */
@media (prefers-reduced-motion: reduce){
  .wheel-container::after,
  .wheel-corefx,
  .wheel-center .hub-sheen,
  .wheel-inner.spinning .wheel-center{
    animation: none !important;
  }
}

  /* =========================
   * CARD / INPUT
   * ======================= */
  .input-section{
    background:
      radial-gradient(520px 260px at 18% 10%, rgba(255,255,255,0.05), transparent 62%),
      linear-gradient(135deg, rgba(59,224,123,0.07), rgba(0,0,0,0.30));
    border: 1px solid rgba(59,224,123,0.20);
    border-radius: var(--radius-lg);
    padding: clamp(18px, 4vw, 30px);
    box-shadow:
      0 18px 70px rgba(0,0,0,0.48),
      0 0 56px -18px rgba(59,224,123,0.18);
    margin-bottom: 14px;
    overflow: hidden;
    isolation: isolate;
    position: relative;
  }
  .input-section::before{
    content:"";
    position:absolute;
    inset: -2px;
    pointer-events:none;
    opacity: 0.52;
    background:
      radial-gradient(420px 220px at 20% 15%, rgba(255,255,255,0.09), transparent 66%),
      radial-gradient(520px 260px at 90% 35%, rgba(59,224,123,0.14), transparent 66%);
    filter: blur(0.7px);
  }
  @supports ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
    .input-section{
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
  }

  .input-section h2{
    font-size: clamp(1.18rem, 2.4vw, 1.42rem);
    margin-bottom: 10px;
    text-shadow: 0 10px 26px rgba(0,0,0,0.56);
    letter-spacing: 0.2px;
  }
  .input-section p{
    color: rgba(255, 255, 255, 0.74);
    margin-bottom: 18px;
    font-size: 0.95rem;
    line-height: 1.45;
  }
  label{
    display: block;
    margin-bottom: 10px;
    font-weight: 900;
    color: rgba(255,255,255,0.92);
    letter-spacing: 0.2px;
  }

  input{
    width: 100%;
    height: 54px;
    font-size: 18px;
    text-align: center;
    padding: 0 16px;
    line-height: 54px;
    text-indent: 0;

    background: rgba(255,255,255,0.055);
    border: 1px solid rgba(255,255,255,0.16);
    border-radius: 12px;

    color: rgba(255,255,255,0.94);
    caret-color: rgba(255,255,255,0.92);

    margin-bottom: 14px;
    transition:
      transform 0.12s ease,
      box-shadow 0.22s ease,
      border-color 0.22s ease,
      background 0.22s ease;

    outline: none;
    appearance: none;
    -webkit-appearance: none;

    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    letter-spacing: 1.2px;

    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,0.30),
      0 10px 30px rgba(0,0,0,0.22);
    -webkit-text-fill-color: rgba(255,255,255,0.94);
  }
  input:hover{
    border-color: rgba(255,255,255,0.22);
    background: rgba(255,255,255,0.065);
  }
  input:focus{
    border-color: rgba(59,224,123,0.52);
    background: rgba(255,255,255,0.08);
    box-shadow:
      0 0 0 4px rgba(59,224,123,0.14),
      0 18px 46px rgba(0,0,0,0.48);
    transform: translateY(-1px);
  }
  input::placeholder{ color: rgba(255,255,255,0.38); letter-spacing: 1.2px; line-height: 54px; opacity: 1; }
  input::-webkit-input-placeholder{ line-height: 54px; opacity: 1; }

  input:-webkit-autofill{
    -webkit-text-fill-color: rgba(255,255,255,0.94);
    transition: background-color 99999s ease-out 0s;
    box-shadow: 0 0 0px 1000px rgba(255,255,255,0.055) inset, 0 10px 30px rgba(0,0,0,0.22);
    border: 1px solid rgba(255,255,255,0.16);
  }

  .primary-btn{
    width: 100%;
    height: 64px;
    font-size: 22px;
    font-weight: 1000;
    letter-spacing: 1.2px;
    color: rgba(0,0,0,0.92);
    border: 1px solid rgba(59,224,123,0.64);
    border-radius: 12px;
    cursor: pointer;
    transition: transform 0.12s ease, box-shadow 0.22s ease, background 0.22s ease, opacity 0.2s ease, filter 0.22s ease;
    box-shadow:
      0 0 42px rgba(59,224,123,0.20),
      0 18px 60px rgba(0,0,0,0.32);
    font-family: inherit;
    position: relative;
    overflow: hidden;
    transform: var(--gpu);
    appearance: none;
    -webkit-appearance: none;

    background:
      radial-gradient(240px 96px at 50% -24%, rgba(255,255,255,0.20), rgba(255,255,255,0.00) 62%),
      linear-gradient(to bottom, var(--green1), var(--green2));
  }

  .primary-btn::before{
    content:"";
    position:absolute;
    inset:-2px;
    background: linear-gradient(90deg, rgba(255,255,255,0.0), rgba(255,255,255,0.34), rgba(255,255,255,0.0));
    transform: translateX(-120%);
    opacity: 0.74;
    pointer-events:none;
  }

  .primary-btn:hover:not(:disabled){
    transform: translateY(-1px) var(--gpu);
    filter: saturate(1.05) contrast(1.02);
    box-shadow:
      0 0 52px rgba(59,224,123,0.26),
      0 22px 70px rgba(0,0,0,0.34);
    background:
      radial-gradient(260px 104px at 50% -24%, rgba(255,255,255,0.22), rgba(255,255,255,0.00) 64%),
      linear-gradient(to bottom, rgba(215,255,233,0.92), var(--green1));
  }
  .primary-btn:hover:not(:disabled)::before{ animation: sheen 920ms ease-out; }
  @keyframes sheen{ from { transform: translateX(-120%); } to { transform: translateX(120%); } }

  .primary-btn:active:not(:disabled){
    transform: translateY(0px) scale(0.99) var(--gpu);
    box-shadow:
      0 0 24px rgba(59,224,123,0.18),
      0 16px 54px rgba(0,0,0,0.30);
  }
  .primary-btn:disabled{ opacity: 0.62; cursor: not-allowed; }

  .primary-btn.fx::after{
    content:"";
    position:absolute;
    left: var(--fx-x, 50%);
    top: var(--fx-y, 50%);
    width: 10px;
    height: 10px;
    border-radius: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: radial-gradient(circle, rgba(255,255,255,0.66), rgba(59,224,123,0.14), rgba(0,0,0,0.0));
    animation: ripple 520ms ease-out forwards;
    pointer-events:none;
  }
  @keyframes ripple{ to { transform: translate(-50%, -50%) scale(32); opacity: 0; } }

  .secondary-btn{
    width: 100%;
    height: 52px;
    font-size: 16px;
    font-weight: 1000;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.16);
    background:
      radial-gradient(240px 110px at 50% -30%, rgba(255,255,255,0.085), rgba(255,255,255,0.00) 62%),
      rgba(0,0,0,0.44);
    color: rgba(255,255,255,0.92);
    cursor: pointer;
    transition: transform 0.12s ease, background 0.2s ease, border-color 0.2s ease, box-shadow 0.22s ease;
    position: relative;
    overflow: hidden;
    appearance: none;
    -webkit-appearance: none;
    box-shadow: 0 14px 50px rgba(0,0,0,0.28);
  }
  .secondary-btn:hover{
    background:
      radial-gradient(240px 110px at 50% -30%, rgba(255,255,255,0.10), rgba(255,255,255,0.00) 64%),
      rgba(0,0,0,0.56);
    border-color: rgba(255,255,255,0.24);
  }
  .secondary-btn:active{ transform: scale(0.99); }

  .jackpot-display{ display:flex; flex-direction:column; align-items:center; gap:6px; padding-top:14px; }
  .jackpot-label{ font-size:0.85rem; color: rgba(255,255,255,0.62); }
  .jackpot-amount{
    font-size: 1.24rem;
    font-weight: 1000;
    color: #65f0a3;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    letter-spacing: 1px;
    text-shadow: 0 12px 26px rgba(0,0,0,0.48);
  }
  .jackpot-meta{
    font-size: 0.82rem;
    color: rgba(255,255,255,0.56);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    letter-spacing: 0.3px;
    text-align: center;
  }

  .spun-message{
    text-align: center;
    padding: 13px 14px;
    background: rgba(239, 68, 68, 0.16);
    border: 1px solid rgba(239, 68, 68, 0.44);
    border-radius: 10px;
    color: rgba(248, 113, 113, 0.92);
    margin-bottom: 14px;
    line-height: 1.35;
    box-shadow: 0 16px 44px rgba(0,0,0,0.30);
  }

/* =========================
 * WINNERS ‚Äî PREMIUM (FINAL PATCH)
 * - Header & table selalu sejajar (NO | USER ID | HADIAH) di mobile
 * - Lebih compact + lebih premium + scroll lebih halus
 * ======================= */
.winners-section{
  position: relative;
  background:
    radial-gradient(680px 320px at 18% 0%, rgba(255,255,255,0.055), transparent 62%),
    radial-gradient(820px 420px at 92% 18%, rgba(59,224,123,0.08), transparent 64%),
    linear-gradient(180deg, rgba(0,0,0,0.30), rgba(0,0,0,0.18));
  border: 1px solid rgba(255,255,255,0.09);
  border-radius: 16px;
  overflow: hidden;
  min-width: 0;
  box-shadow:
    0 22px 78px rgba(0,0,0,0.44),
    0 0 0 1px rgba(0,0,0,0.22) inset;
  isolation: isolate;
}

.winners-section::before{
  content:"";
  position:absolute;
  inset:-2px;
  pointer-events:none;
  opacity: 0.55;
  background:
    radial-gradient(520px 220px at 24% 18%, rgba(255,255,255,0.09), transparent 66%),
    radial-gradient(620px 260px at 86% 30%, rgba(59,224,123,0.14), transparent 70%),
    linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.00) 42%);
  filter: blur(0.8px);
}

@supports ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
  .winners-section{
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
  }
}

.winners-header{
  position: relative;
  display: flex;
  align-items: center;
  gap: 10px;

  padding: 14px 16px;
  font-weight: 1000;
  font-size: 1.02rem;
  letter-spacing: 0.2px;

  background:
    radial-gradient(520px 180px at 22% -24%, rgba(255,255,255,0.11), transparent 60%),
    linear-gradient(to right, rgba(59,224,123,0.22), rgba(59,224,123,0.06));
  border-bottom: 1px solid rgba(59,224,123,0.12);

  text-shadow: 0 10px 26px rgba(0,0,0,0.56);
  z-index: 2;
}

.winners-header::after{
  content:"";
  position:absolute;
  left: 0; right: 0; bottom: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.10), transparent);
  opacity: 0.65;
  pointer-events:none;
}

.winners-table{
  width: 100%;
  max-height: 320px;
  overflow-x: hidden;
  overflow-y: auto;
  display: block;
  overscroll-behavior: contain;
  scroll-behavior: smooth;
  padding-bottom: 2px;

  scrollbar-width: thin;
  scrollbar-color: rgba(59,224,123,0.28) rgba(0,0,0,0.22);
  -webkit-overflow-scrolling: touch;

  /* sedikit ‚Äúsnap feel‚Äù tanpa bikin kaku */
  scroll-padding-top: 56px;
}

.winners-table::-webkit-scrollbar{ width: 6px; }
.winners-table::-webkit-scrollbar-track{ background: rgba(0,0,0,0.22); }
.winners-table::-webkit-scrollbar-thumb{
  background: rgba(59,224,123,0.26);
  border-radius: 999px;
}
.winners-table::-webkit-scrollbar-thumb:hover{ background: rgba(59,224,123,0.44); }

.winners-table-header,
.winners-table-row{
  display: grid;
  grid-template-columns: 56px minmax(0, 1fr) clamp(120px, 28vw, 170px);
  gap: 10px;
  padding: 12px 16px;
  align-items: center;
  width: 100%;
  min-width: 0;
}

.winners-table-header{
  background: rgba(0,0,0,0.72);
  font-weight: 1000;
  color: rgba(215,255,233,0.92);
  position: sticky;
  top: 0;
  z-index: 3;

  border-bottom: 2px solid rgba(59,224,123,0.18);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  isolation: isolate;

  /* anti wrap biar HADIAH gak jatuh */
  white-space: nowrap;
}

.winners-table-header > div{
  white-space: nowrap;
}

.winners-table-row{
  border-bottom: 1px solid rgba(255,255,255,0.05);
  position: relative;
  transition: transform 260ms ease, background 220ms ease, box-shadow 220ms ease;
  will-change: transform;
  cursor: default;
  user-select: none;
}

.winners-table-row::before{
  content:"";
  position:absolute;
  inset: 0;
  pointer-events:none;
  opacity: 0;
  background:
    radial-gradient(520px 120px at 50% 50%, rgba(255,255,255,0.06), transparent 62%);
  transition: opacity 220ms ease;
}

.winners-table-row:hover::before{ opacity: 1; }

.winners-table-row:hover:not(.is-user){
  background: rgba(255,255,255,0.022);
}

.winners-table-row.is-user{
  cursor: pointer;
  background: rgba(59,224,123,0.085);
  box-shadow:
    inset 0 0 0 1px rgba(59,224,123,0.18),
    inset 0 0 18px rgba(59,224,123,0.06);
}

.winners-table-row.is-user:hover{
  background: rgba(59,224,123,0.11);
  box-shadow:
    inset 0 0 0 1px rgba(59,224,123,0.24),
    0 12px 38px rgba(0,0,0,0.26);
}

.winner-no{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  color: rgba(255,255,255,0.62);
  text-align: center;
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
}

.winner-id{
  font-weight: 1000;
  color: rgba(255,255,255,0.96);
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  letter-spacing: 0.15px;
}

.winner-meta{
  font-size: 0.85rem;
  color: rgba(255,255,255,0.56);
  margin-top: 2px;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.winner-prize{
  text-align: right;
  font-weight: 1000;
  color: #65f0a3;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
  text-shadow: 0 10px 26px rgba(0,0,0,0.40);
}

/* new row animations */
@keyframes rowIn{
  from{ opacity:0; transform: translateY(-8px); }
  to{ opacity:1; transform: translateY(0); }
}
@keyframes shimmer{
  from{ transform: translateX(-70%); opacity: 0; }
  15%{ opacity: 1; }
  to{ transform: translateX(70%); opacity: 0; }
}

.winners-table-row.is-new{
  animation: rowIn 240ms ease-out;
  background: linear-gradient(90deg, rgba(59,224,123,0.14), rgba(255,255,255,0.03));
  box-shadow:
    inset 0 0 0 1px rgba(59,224,123,0.20),
    inset 0 0 22px rgba(59,224,123,0.06);
}

.winners-table-row.is-new::after{
  content:"";
  position:absolute;
  inset: 0;
  pointer-events:none;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.22), transparent);
  transform: translateX(-70%);
  animation: shimmer 980ms ease-out forwards;
}

/* =========================
 * MOBILE ‚Äî KEEP 3 COLUMNS (fix ‚ÄúHADIAH turun‚Äù)
 * ======================= */
@media (max-width: 420px){
  .winners-header{
    padding: 10px 12px;
    font-size: 0.95rem;
    gap: 8px;
  }

  .winners-table-header,
  .winners-table-row{
    padding: 10px 12px;
    gap: 8px;
    grid-template-columns: 40px minmax(0, 1fr) clamp(88px, 26vw, 130px);
  }

  .winners-table-header{ font-size: 0.90rem; }

  .winner-no{ font-size: 0.85rem; }
  .winner-id{ font-size: 0.95rem; }
  .winner-meta{ font-size: 0.78rem; }
  .winner-prize{
    text-align: right;
    margin-top: 0;
    font-size: 0.95rem;
  }
}

/* extra small devices */
@media (max-width: 360px){
  .winners-table-header,
  .winners-table-row{
    grid-template-columns: 36px minmax(0, 1fr) clamp(84px, 28vw, 118px);
  }
  .winners-header{ font-size: 0.92rem; }
  .winners-table-header{ font-size: 0.88rem; }
}

  /* =========================
   * MODAL
   * ======================= */
  .modal{
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.78);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: calc(14px + var(--safe-top)) calc(14px + var(--safe-right)) calc(14px + var(--safe-bottom)) calc(14px + var(--safe-left));
  }
  .modal.show { display: flex; }

  .modal-content{
    background:
      radial-gradient(520px 280px at 18% 10%, rgba(255,255,255,0.05), transparent 62%),
      linear-gradient(135deg, rgba(6,18,14,0.98), rgba(7,30,22,0.96));
    border: 1px solid rgba(59,224,123,0.52);
    border-radius: 20px;
    padding: clamp(18px, 4vw, 40px);
    text-align: center;
    max-width: 520px;
    width: 100%;
    box-shadow:
      0 0 72px rgba(59,224,123,0.14),
      0 28px 90px rgba(0,0,0,0.60);
    animation: zoomIn 0.22s ease-out;
    max-height: min(84svh, 720px);
    overflow: auto;
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(59,224,123,0.26) rgba(0,0,0,0.22);
  }
  @supports (max-height: 84dvh){
    .modal-content{ max-height: min(84dvh, 720px); }
  }
  @keyframes zoomIn { from { opacity: 0; transform: scale(0.96); } to { opacity: 1; transform: scale(1); } }

  .modal-content h1 { font-size: clamp(1.8rem, 3.4vw, 2.5rem); margin-bottom: 8px; text-shadow: 0 14px 34px rgba(0,0,0,0.56); }
  .modal-content p { color: rgba(255, 255, 255, 0.84); margin-bottom: 14px; font-size: 1.05rem; line-height: 1.45; }

  .prize-amount{
    font-size: clamp(2rem, 6vw, 3rem);
    font-weight: 1000;
    color: var(--green0);
    margin: 18px 0 10px;
    line-height: 1.1;
    text-shadow: 0 18px 44px rgba(0,0,0,0.60);
  }
  .prize-meta{
    font-size: 0.95rem;
    color: rgba(255,255,255,0.72);
    margin-top: 4px;
    line-height: 1.4;
  }
  .mono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    letter-spacing: 0.6px;
    color: rgba(255,255,255,0.92);
    font-weight: 900;
  }

  .modal-actions{
    display:flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 16px;
    align-items: center;
  }
  .modal-actions .primary-btn{ max-width: 320px; height: 58px; font-size: 20px; }
  .modal-actions .secondary-btn{ max-width: 320px; height: 52px; font-size: 16px; }

  /* =========================
   * TOAST
   * ======================= */
  .toast{
    position: fixed;
    left: 50%;
    bottom: calc(18px + var(--safe-bottom));
    transform: translateX(-50%);
    z-index: 1200;
    width: min(520px, calc(100vw - 28px));
    background: rgba(0,0,0,0.74);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 14px;
    padding: 12px 14px;
    display: none;
    gap: 10px;
    align-items: center;
    box-shadow: 0 20px 70px rgba(0,0,0,0.56);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    isolation: isolate;
  }
  .toast.show{ display: flex; animation: toastIn 180ms ease-out; }
  @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(6px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

  .toast .dot{
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--green1);
    box-shadow: 0 0 14px rgba(59,224,123,0.34);
    flex: 0 0 auto;
  }
  .toast .msg{ color: rgba(255,255,255,0.94); font-weight: 900; line-height: 1.3; font-size: 0.98rem; }
  .toast.error .dot{ background: #ef4444; box-shadow: 0 0 14px rgba(239,68,68,0.34); }
  .toast.success .dot{ background: #65f0a3; box-shadow: 0 0 14px rgba(59,224,123,0.30); }

  /* =========================
   * LOADING OVERLAY (CLAIM)
   * ======================= */
  .nav-loading{
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;

    background: rgba(0,0,0,0.78);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);

    padding: calc(14px + var(--safe-top)) calc(14px + var(--safe-right)) calc(14px + var(--safe-bottom)) calc(14px + var(--safe-left));

    opacity: 0;
    visibility: hidden;
    pointer-events: none;

    transform: var(--gpu);
    transition:
      opacity 240ms ease,
      visibility 0s linear 240ms;
    isolation: isolate;
  }
  .nav-loading.show{
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    transition: opacity 240ms ease, visibility 0s;
  }

  .nav-loading-card{
    width: min(520px, calc(100vw - 28px));
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,0.10);
    background:
      radial-gradient(520px 240px at 18% 10%, rgba(255,255,255,0.05), transparent 62%),
      linear-gradient(135deg, rgba(6,18,14,0.98), rgba(7,30,22,0.96));
    box-shadow: 0 25px 90px rgba(0,0,0,0.64);
    padding: 18px 18px;
    display: flex;
    gap: 12px;
    align-items: center;
    transform: translateY(4px);
    transition: transform 240ms ease;
  }
  .nav-loading.show .nav-loading-card{ transform: translateY(0); }

  .nav-spinner{
    width: 34px;
    height: 34px;
    border-radius: 999px;
    border: 3px solid rgba(255,255,255,0.14);
    border-top-color: rgba(59,224,123,0.90);
    animation: navSpin 820ms linear infinite;
    flex: 0 0 auto;
  }
  @keyframes navSpin{ to{ transform: rotate(360deg); } }

  .nav-title{ font-weight: 1000; color: rgba(255,255,255,0.94); line-height: 1.2; }
  .nav-sub{ font-size: 0.92rem; color: rgba(255,255,255,0.62); margin-top: 2px; }

  /* =========================
   * ACCESSIBILITY + REDUCED MOTION
   * ======================= */
  :focus-visible{
    outline: 3px solid var(--ring);
    outline-offset: 3px;
    border-radius: 10px;
  }

  /* =========================
   * LOW-END DOWNGRADE (auto by JS)
   * ======================= */
  body.low-end #fxCanvas{ opacity: 0.52; }
  body.low-end::after{ opacity: 0.028; }
  body.low-end .wheel-container::after{ opacity: 0.35; filter: blur(0.9px); }
  body.low-end .wheel-outer{ box-shadow: 0 22px 70px rgba(0,0,0,0.58), 0 0 26px rgba(243,178,74,0.09); }
  body.low-end .wheel-corefx{ opacity: 0.78; filter: blur(0.5px); }
  @supports (-webkit-touch-callout: none){
    /* Safari safety: tone down blend a bit to avoid harsh/patchy rendering */
    .wheel-corefx{ opacity: 0.88; }
    header::after{ opacity: 0.46; }
  }

  @media (prefers-reduced-motion: reduce){
    * { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
    .winners-table-row.is-new::after { display: none !important; }
    .nav-spinner{ animation: none !important; }
    #fxCanvas{ display:none !important; }
    .wheel-outer::before{ display:none !important; }
    .wheel-container::after{ display:none !important; }
    body::after{ display:none !important; }
    .wheel-corefx{ display:none !important; }
  }
</style>
</head>

<body>
  <canvas id="fxCanvas" aria-hidden="true"></canvas>

  <div class="container" id="mainContainer">
    <header>
      <h1 class="hero-title">
        <span class="hero-top">SELAMAT DATANG DI</span>
        <span class="hero-brand">MADETOTO2</span>
      </h1>
      <p class="subtitle">
        PUTAR RODANYA &amp; DAPATKAN HADIAH FANTASTIS HINGGA 200 RIBU RUPIAH!
      </p>
    </header>

    <div class="main-content">
      <div class="wheel-container">
        <div class="wheel-wrapper" id="wheelWrap">
          <div class="pointer" id="pointerEl" aria-hidden="true">
            <svg viewBox="0 0 64 90" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="metal" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0" stop-color="rgba(255,255,255,0.90)" />
                  <stop offset="0.24" stop-color="rgba(195,195,195,0.92)" />
                  <stop offset="0.56" stop-color="rgba(88,88,88,0.96)" />
                  <stop offset="1" stop-color="rgba(18,18,18,0.98)" />
                </linearGradient>

                <linearGradient id="gold" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0" stop-color="#FFF4D6" />
                  <stop offset="0.52" stop-color="#F6B33D" />
                  <stop offset="1" stop-color="#8A4A16" />
                </linearGradient>

                <radialGradient id="cap" cx="35%" cy="30%" r="70%">
                  <stop offset="0" stop-color="rgba(255,255,255,0.98)" />
                  <stop offset="0.45" stop-color="#FFF4D6" />
                  <stop offset="1" stop-color="#B45309" />
                </radialGradient>
              </defs>

              <path
                d="M32 86 L10 34 C10 34 14 10 32 10 C50 10 54 34 54 34 L32 86 Z"
                fill="url(#gold)"
                stroke="rgba(255,255,255,0.22)"
                stroke-width="2"
              />
              <path
                d="M32 80 L18 36 C18 36 20 18 32 18 C44 18 46 36 46 36 L32 80 Z"
                fill="url(#metal)"
                opacity="0.96"
              />
              <circle
                cx="32"
                cy="27"
                r="11"
                fill="url(#cap)"
                stroke="rgba(0,0,0,0.22)"
                stroke-width="2"
              />
              <circle
                cx="32"
                cy="27"
                r="4.2"
                fill="rgba(10,10,10,0.78)"
                stroke="rgba(255,255,255,0.16)"
                stroke-width="1.5"
              />
            </svg>
          </div>

          <div class="wheel-outer">
            <div class="wheel-inner" id="wheel" aria-label="Lucky wheel">
              <div class="wheel-corefx" aria-hidden="true"></div>
              <div class="wheel-center" aria-hidden="true">
                <span class="hub-sheen" aria-hidden="true"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="input-section">
          <h2>MASUKKAN USER ID</h2>
          <p>Masukkan User ID Anda untuk memutar roda keberuntungan.</p>

          <label for="userIdInput">User ID</label>
          <input
            type="text"
            id="userIdInput"
            placeholder="Contoh: User123"
            maxlength="20"
            autocomplete="off"
            autocapitalize="off"
            autocorrect="off"
            spellcheck="false"
            inputmode="text"
          />

          <button id="spinBtn" class="primary-btn" type="button">
            SPIN SEKARANG!
          </button>

          <div class="jackpot-display" aria-live="polite">
            <div class="jackpot-label">Total Jackpot</div>
            <div class="jackpot-amount" id="jackpot">IDR 888.888.888</div>
            <div class="jackpot-meta" id="jackpotMeta">Update: --:--:--</div>
          </div>
        </div>

        <div id="spunMessage" class="spun-message" style="display: none;">
          Kesempatan spin Anda sudah habis. Silakan klaim hadiah Anda.
        </div>

        <div class="winners-section">
          <div class="winners-header">üèÜ 50 Riwayat Spin Terakhir</div>
          <div class="winners-table" id="winnersTable" aria-live="polite">
            <div class="winners-table-header">
              <div>NO</div>
              <div>USER ID</div>
              <div>HADIAH</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true">
    <div class="dot" aria-hidden="true"></div>
    <div class="msg" id="toastMsg">Toast</div>
  </div>

  <div
    class="modal"
    id="prizeModal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="prizeTitle"
    aria-hidden="true"
  >
    <div class="modal-content" role="document">
      <h1 id="prizeTitle">SELAMAT!</h1>
      <p>Anda memenangkan hadiah:</p>

      <div class="prize-amount" id="prizeAmount">BONUS 10%</div>

      <div class="prize-meta">
        User ID: <span class="mono" id="modalUserId">-</span><br />
        Waktu: <span class="mono" id="modalTime">-</span>
      </div>

      <p style="margin-top: 14px;">
        Silakan klaim melalui Live Chat dan sertakan User ID.
      </p>

      <!-- ‚úÖ Actions: KLAIM -> UNDUH -> BAGIKAN (BAGIKAN tepat di bawah UNDUH) -->
      <div class="modal-actions" style="display: flex; flex-direction: column; gap: 10px;">
        <button type="button" class="primary-btn" id="claimBtn">
          KLAIM SEKARANG
        </button>

        <button type="button" class="secondary-btn" id="downloadBtn">
          UNDUH HASIL
        </button>

        <button
          type="button"
          class="secondary-btn"
          id="shareBtn"
          aria-label="Bagikan hasil"
        >
          BAGIKAN
        </button>
      </div>

      <div class="prize-meta" style="margin-top: 10px;">
        Klik tombol unduh untuk mendapatkan hasil. File akan tersimpan otomatis di perangkat Anda.
      </div>
    </div>
  </div>

  <div class="nav-loading" id="navLoading" aria-hidden="true">
    <div class="nav-loading-card" role="status" aria-live="polite" aria-atomic="true">
      <div class="nav-spinner" aria-hidden="true"></div>
      <div>
        <div class="nav-title">Menghubungkan‚Ä¶</div>
        <div class="nav-sub">Mengarahkan ke halaman klaim</div>
      </div>
    </div>
  </div>

  <!-- Chaport Live Chat -->
  <script type="text/javascript">
    (function (w, d, v3) {
      w.chaportConfig = { appId: "6937b4ead2823b3f94b0a834" };
      if (w.chaport) return;
      v3 = (w.chaport = {});
      v3._q = [];
      v3._l = {};
      v3.q = function () {
        v3._q.push(arguments);
      };
      v3.on = function (e, fn) {
        if (!v3._l[e]) v3._l[e] = [];
        v3._l[e].push(fn);
      };
      var s = d.createElement("script");
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://app.chaport.com/javascripts/insert.js";
      var ss = d.getElementsByTagName("script")[0];
      ss.parentNode.insertBefore(s, ss);
    })(window, document);
  </script>

  <!-- Audio -->
  <audio id="bgMusic" loop playsinline preload="auto"></audio>
  <audio id="spinSound" playsinline preload="auto"></audio>
  <audio id="tickSound" playsinline preload="auto"></audio>
  <audio id="winSound" playsinline preload="auto"></audio>
  <audio id="historySound" playsinline preload="auto"></audio>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>

<script>
  /* ======================================================================
   * FINAL ‚Äî FULL PATCH + POWER UP (MOST FEELABLE)
   * ‚úÖ Persist wheel rotation (reload tetap konsisten secara visual)
   * ‚úÖ Live history benar-benar unique (seed + live)
   * ‚úÖ Spin token cancels tick timers (no ghost ticks)
   * ‚úÖ Modal focus trap + inert background (UX app-like)
   * ‚úÖ Claim overlay watchdog (anti nyangkut)
   * ‚úÖ Low-end auto downgrade (lebih stabil di mobile)
   * ‚úÖ Time label hari/jam rapi
   * ====================================================================== */

  /* =========================================================
   * 0) CONFIG + CONST
   * ======================================================= */
  const CONFIG = {
    SPIN_DURATION_MS: 6000,
    CLAIM_URL: "https://newmadetoto2.com/",
    CLAIM_OVERLAY_MIN_MS: 700,

    LS_PREFIX: "mt2_spin_v2:",
    PRIZES: ["25K", "50K", "75K", "100K", "200K", "BONUS 10%"],
    BONUS_LABEL: "BONUS 10%",

    PRIZE_DISPLAY_MAP: {
      "25K": "IDR 25.000",
      "50K": "IDR 50.000",
      "75K": "IDR 75.000",
      "100K": "IDR 100.000",
      "200K": "IDR 200.000",
      "BONUS 10%": "BONUS 10%",
    },

    AUDIO: {
      bg: "https://cdn.pixabay.com/download/audio/2022/03/24/audio_197846c632.mp3?filename=casino-music-1-2518.mp3",
      spin: "https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3",
      win: "https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3",
      tick: "https://assets.mixkit.co/active_storage/sfx/2063/2063-preview.mp3",
      history: "https://assets.mixkit.co/active_storage/sfx/2014/2014-preview.mp3",
      vol: { bg: 0.22, spin: 0.6, win: 0.85, tick: 0.55, history: 0.62 }
    }
  };

  const LS = {
    HAS_SPUN: CONFIG.LS_PREFIX + "hasSpun",
    SPIN_AT: CONFIG.LS_PREFIX + "spinAt",
    LAST_USER_ID: CONFIG.LS_PREFIX + "lastUserId",
    JACKPOT_VAL: CONFIG.LS_PREFIX + "jackpotVal",
    ROTATION: CONFIG.LS_PREFIX + "rotation"
  };

  const PRIZES = CONFIG.PRIZES.slice();
  const BONUS_LABEL = CONFIG.BONUS_LABEL;
  const BONUS_INDEX = PRIZES.indexOf(BONUS_LABEL);

  /* =========================================================
   * 1) STORAGE HELPERS + MIGRATION
   * ======================================================= */
  function lsGet(key, fallback = "") {
    try {
      const v = localStorage.getItem(key);
      return (v == null ? fallback : v);
    } catch (_) { return fallback; }
  }

  function lsSet(key, value) {
    try { localStorage.setItem(key, String(value)); } catch (_) {}
  }

  function migrateLegacyKeys() {
    const legacy = {
      hasSpun: "hasSpun",
      spinAt: "spinAt",
      lastUserId: "lastUserId",
      jackpotVal: "jackpotVal",
      rotation: "rotation"
    };

    if (!lsGet(LS.HAS_SPUN, "") && lsGet(legacy.hasSpun, "")) lsSet(LS.HAS_SPUN, lsGet(legacy.hasSpun, ""));
    if (!lsGet(LS.SPIN_AT, "") && lsGet(legacy.spinAt, "")) lsSet(LS.SPIN_AT, lsGet(legacy.spinAt, ""));
    if (!lsGet(LS.LAST_USER_ID, "") && lsGet(legacy.lastUserId, "")) lsSet(LS.LAST_USER_ID, lsGet(legacy.lastUserId, ""));
    if (!lsGet(LS.JACKPOT_VAL, "") && lsGet(legacy.jackpotVal, "")) lsSet(LS.JACKPOT_VAL, lsGet(legacy.jackpotVal, ""));
    if (!lsGet(LS.ROTATION, "") && lsGet(legacy.rotation, "")) lsSet(LS.ROTATION, lsGet(legacy.rotation, ""));
  }

  migrateLegacyKeys();

  /* =========================================================
   * 2) STATE (GLOBAL)
   * ======================================================= */
  let hasSpun = (lsGet(LS.HAS_SPUN, "false") === "true");
  let spinAt = Number(lsGet(LS.SPIN_AT, "0") || "0") || 0;
  let savedUserId = String(lsGet(LS.LAST_USER_ID, "") || "");

  let isSpin = false;
  let currentRotation = Number(lsGet(LS.ROTATION, "0") || "0") || 0;
  let lastResult = null;

  let winners = [];
  let liveTimer = 0;

  let rowElById = new Map();
  let winnersById = new Map();

  let jackpotTimer = 0;
  let jackpotSaveTimer = 0;
  let jackpot = 0;

  let spikeUntilMs = 0;
  let spikeMul = 1;

  let toastTimer = 0;
  let metaTimer = 0;

  let lastFocusedEl = null;

  let tickPool = [];
  let tickPoolIdx = 0;

  let historyPool = [];
  let historyPoolIdx = 0;
  let historySfxAt = 0;

  let nonUserToastAt = 0;
  let audioPrimed = false;
  let bgStarted = false;

  let pointerEl = null;
  let pointerKickT = 0;

  // spin token + tick timers (cancel ghost ticks)
  let spinToken = 0;
  let tickTimers = [];

  // live winners uniqueness (keep last 70)
  const recentMasked = new Set();
  const recentMaskedQueue = [];

  // pause reasons for live history
  const pauseReasons = new Set();

  function pauseHistory(reason) {
    pauseReasons.add(String(reason || "x"));
    stopLiveHistory();
  }

  function resumeHistory(reason) {
    pauseReasons.delete(String(reason || "x"));
    if (pauseReasons.size === 0 && !document.hidden) startLiveHistory();
  }

  // inert reasons (modal/nav)
  const inertReasons = new Set();

  function setInert(reason, on) {
    const main = document.getElementById("mainContainer");
    if (!main) return;

    const r = String(reason || "x");
    if (on) inertReasons.add(r);
    else inertReasons.delete(r);

    const should = inertReasons.size > 0;
    try {
      if (should) {
        main.setAttribute("inert", "");
        main.setAttribute("aria-hidden", "true");
      } else {
        main.removeAttribute("inert");
        main.removeAttribute("aria-hidden");
      }
    } catch (_) {}
  }

  /* =========================================================
   * 3) SMALL UTILS
   * ======================================================= */
  function normalizeUserIdInput(v) {
    return String(v == null ? "" : v).replace(/\s+/g, "").slice(0, 20);
  }

  function isReducedMotion() {
    return !!(window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches);
  }

  // Low-end heuristic for stability
  function detectLowEnd() {
    try {
      const devMem = Number(navigator.deviceMemory || 0) || 0;
      const cores = Number(navigator.hardwareConcurrency || 0) || 0;
      const saveData = !!(navigator.connection && navigator.connection.saveData);

      const low = (saveData) || (devMem && devMem <= 2) || (cores && cores <= 4);
      if (low) document.body.classList.add("low-end");
    } catch (_) {}
  }

  /* =========================================================
   * 4) DOM BOOT
   * ======================================================= */
  document.addEventListener("DOMContentLoaded", () => {
    detectLowEnd();

    const spinBtn = document.getElementById("spinBtn");
    const userIdInput = document.getElementById("userIdInput");
    const claimBtn = document.getElementById("claimBtn");
    const downloadBtn = document.getElementById("downloadBtn");

    pointerEl = document.getElementById("pointerEl");

    setupAudio();
    drawWheelPrizes();
    initWheelAutoResize();
    initFxParticlesCanvas();

    // winners seed + persist user entry
    winners = generateMockWinnersRandom();
    bootPersistedUserEntry();

    // apply persisted rotation to wheel (most feelable fix)
    applyWheelRotation(currentRotation);

    renderWinners({ preserveScroll: true });
    startMetaTicker();
    setupHistoryRowOpen();

    updateUI();
    jackpot = initJackpot();
    startJackpot();
    startLiveHistory();

    userIdInput.addEventListener("input", () => {
      userIdInput.value = normalizeUserIdInput(userIdInput.value);
    });

    userIdInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); startSpin(); }
    });

    spinBtn.addEventListener("click", startSpin);
    spinBtn.addEventListener("pointerdown", (e) => pressFX(spinBtn, e), { passive: true });

    claimBtn.addEventListener("click", claimPrize);
    claimBtn.addEventListener("pointerdown", (e) => pressFX(claimBtn, e), { passive: true });

    downloadBtn.addEventListener("click", downloadResultPng);
    downloadBtn.addEventListener("pointerdown", (e) => pressFX(downloadBtn, e), { passive: true });

    document.getElementById("prizeModal").addEventListener("click", (e) => {
      if (e.target && e.target.id === "prizeModal") closeModal();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (isModalOpen()) closeModal();
        return;
      }
      // Focus trap for modal
      if (e.key === "Tab" && isModalOpen()) {
        trapFocus(e);
      }
    });

    document.addEventListener("visibilitychange", () => {
      if (document.hidden) { stopLiveHistory(); stopJackpot(); }
      else { startJackpot(); if (pauseReasons.size === 0) startLiveHistory(); }
    });

    // Prime audio on first gesture only (cleaner UX)
    const kick = () => kickAudio(true);
    window.addEventListener("pointerdown", kick, { passive: true, once: true });
    window.addEventListener("keydown", kick, { passive: true, once: true });

    window.addEventListener("pageshow", () => { hideNavLoading(true); });

    // multi-tab sync
    window.addEventListener("storage", (e) => {
      if (!e || !e.key) return;

      if (
        e.key === LS.HAS_SPUN ||
        e.key === LS.SPIN_AT ||
        e.key === LS.LAST_USER_ID ||
        e.key === LS.ROTATION
      ) {
        hasSpun = (lsGet(LS.HAS_SPUN, "false") === "true");
        spinAt = Number(lsGet(LS.SPIN_AT, "0") || "0") || 0;
        savedUserId = String(lsGet(LS.LAST_USER_ID, "") || "");
        currentRotation = Number(lsGet(LS.ROTATION, "0") || "0") || 0;

        bootPersistedUserEntry();
        applyWheelRotation(currentRotation);
        updateUI();
        renderWinners({ preserveScroll: true });
      }

      if (e.key === LS.JACKPOT_VAL) {
        const v = Number(lsGet(LS.JACKPOT_VAL, "0") || "0") || 0;
        if (v > 1000000) {
          jackpot = v;
          const el = document.getElementById("jackpot");
          const meta = document.getElementById("jackpotMeta");
          if (el) el.textContent = `IDR ${Math.round(jackpot).toLocaleString("id-ID")}`;
          if (meta) meta.textContent = `Update: ${fmtClock()}`;
        }
      }
    });
  });

/* =========================================================
 * 5) WHEEL ROTATION PERSIST ‚Äî POWER (stable + crisp)
 * ======================================================= */
function applyWheelRotation(deg) {
  const wheel = document.getElementById("wheel");
  if (!wheel) return;

  wheel.classList.remove("spinning");

  const v = Number(deg || 0);
  const vv = Number.isFinite(v) ? v : 0;

  // micro clamp biar transform string stabil (hindari jitter float panjang)
  const snapped = Math.round(vv * 1000) / 1000;

  wheel.style.transform = `rotate(${snapped}deg) translateZ(0)`;
}

function saveRotation(deg) {
  const v = Number(deg || 0);
  currentRotation = Number.isFinite(v) ? v : 0;
  lsSet(LS.ROTATION, String(currentRotation));
}

  /* =========================================================
   * 6) FX CANVAS (auto low-end + pause on hidden)
   * ======================================================= */
  function initFxParticlesCanvas() {
    const c = document.getElementById("fxCanvas");
    if (!c) return;

    const ctx = c.getContext("2d", { alpha: true });
    if (!ctx) return;

    if (isReducedMotion()) { c.style.display = "none"; return; }

    const devMem = Number(navigator.deviceMemory || 0) || 4;
    const cores = Number(navigator.hardwareConcurrency || 0) || 6;
    const saveData = !!(navigator.connection && navigator.connection.saveData);
    const lowEnd = saveData || (devMem <= 2) || (cores <= 4);

    let w = 0, h = 0, dpr = 1;
    const parts = [];
    const maxParts = lowEnd ? 54 : 84;

    let rafId = 0;
    let running = true;

    const resize = () => {
      const dprCap = lowEnd ? 1.4 : 2;
      dpr = Math.min(dprCap, window.devicePixelRatio || 1);

      w = Math.max(1, Math.floor(window.innerWidth));
      h = Math.max(1, Math.floor(window.innerHeight));

      c.width = Math.floor(w * dpr);
      c.height = Math.floor(h * dpr);
      c.style.width = w + "px";
      c.style.height = h + "px";

      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    };

    const rand = (a, b) => a + Math.random() * (b - a);
    const pick = (arr) => arr[(Math.random() * arr.length) | 0];

    const spawn = () => {
      parts.push({
        x: rand(-40, w + 40),
        y: rand(-40, h + 40),
        r: rand(0.7, 2.3),
        vy: rand(-0.14, -0.04),
        vx: rand(-0.06, 0.06),
        a: rand(0.14, 0.52),
        tw: rand(0.004, 0.010),
        ph: rand(0, Math.PI * 2),
        hue: pick([120, 140, 45, 50, 160]),
        life: rand(2400, 5200),
        t: 0
      });
    };

    const ensure = () => { while (parts.length < maxParts) spawn(); };

    const draw = (dt) => {
      ctx.clearRect(0, 0, w, h);

      const g = ctx.createRadialGradient(
        w * 0.5, h * 0.28, 0,
        w * 0.5, h * 0.28, Math.max(w, h) * 0.55
      );
      g.addColorStop(0, "rgba(34,197,94,0.075)");
      g.addColorStop(1, "rgba(0,0,0,0)");

      ctx.fillStyle = g;
      ctx.fillRect(0, 0, w, h);

      for (let i = parts.length - 1; i >= 0; i--) {
        const p = parts[i];
        p.t += dt;

        p.x += p.vx * dt;
        p.y += p.vy * dt;

        const tw = (Math.sin(p.ph + p.t * p.tw) * 0.5 + 0.5);
        const alpha = Math.max(0, Math.min(1, p.a * (0.55 + tw * 0.65) * (1 - (p.t / p.life))));
        const rr = p.r * (0.85 + tw * 0.65);

        ctx.beginPath();
        ctx.fillStyle = `hsla(${p.hue}, 80%, 70%, ${alpha})`;
        ctx.arc(p.x, p.y, rr, 0, Math.PI * 2);
        ctx.fill();

        ctx.globalAlpha = alpha * 0.28;
        ctx.strokeStyle = `hsla(${p.hue}, 85%, 78%, 1)`;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(p.x - rr * 2.2, p.y);
        ctx.lineTo(p.x + rr * 2.2, p.y);
        ctx.moveTo(p.x, p.y - rr * 2.2);
        ctx.lineTo(p.x, p.y + rr * 2.2);
        ctx.stroke();
        ctx.globalAlpha = 1;

        if (p.t >= p.life || p.y < -80) {
          parts.splice(i, 1);
          spawn();
        }
      }
    };

    let last = performance.now();

    const tick = () => {
      if (!running) return;
      const now = performance.now();
      const dt = Math.min(34, now - last);
      last = now;

      ensure();
      draw(dt);

      rafId = requestAnimationFrame(tick);
    };

    const stop = () => {
      running = false;
      if (rafId) cancelAnimationFrame(rafId);
      rafId = 0;
    };

    const start = () => {
      if (running) return;
      running = true;
      last = performance.now();
      rafId = requestAnimationFrame(tick);
    };

    resize();
    window.addEventListener("resize", resize, { passive: true });

    document.addEventListener("visibilitychange", () => {
      if (document.hidden) stop();
      else start();
    });

    rafId = requestAnimationFrame(tick);
  }

  /* =========================================================
   * 7) AUDIO (clean start on first gesture)
   * ======================================================= */
  function setupAudio() {
    const bgMusic = document.getElementById("bgMusic");
    const spinSound = document.getElementById("spinSound");
    const tickSound = document.getElementById("tickSound");
    const winSound = document.getElementById("winSound");
    const historySound = document.getElementById("historySound");

    bgMusic.src = CONFIG.AUDIO.bg;
    spinSound.src = CONFIG.AUDIO.spin;
    winSound.src = CONFIG.AUDIO.win;
    tickSound.src = CONFIG.AUDIO.tick;
    historySound.src = CONFIG.AUDIO.history;

    bgMusic.volume = CONFIG.AUDIO.vol.bg;
    spinSound.volume = CONFIG.AUDIO.vol.spin;
    winSound.volume = CONFIG.AUDIO.vol.win;
    tickSound.volume = CONFIG.AUDIO.vol.tick;
    historySound.volume = CONFIG.AUDIO.vol.history;

    tickPool = [];
    for (let i = 0; i < 6; i++) {
      const a = new Audio(tickSound.src);
      a.volume = tickSound.volume;
      a.preload = "auto";
      tickPool.push(a);
    }

    historyPool = [];
    for (let i = 0; i < 4; i++) {
      const a = new Audio(historySound.src);
      a.volume = historySound.volume;
      a.preload = "auto";
      historyPool.push(a);
    }
  }

  function primeAudioPool(pool) {
    pool.forEach((a) => {
      try {
        const prevMuted = a.muted;
        a.muted = true;
        a.play().then(() => {
          a.pause();
          a.currentTime = 0;
          a.muted = prevMuted;
        }).catch(() => { a.muted = prevMuted; });
      } catch (_) {}
    });
  }

  function kickAudio(withBgStart = false) {
    if (!audioPrimed) {
      audioPrimed = true;
      primeAudioPool(tickPool);
      primeAudioPool(historyPool);
    }
    if (!withBgStart) return;

    if (!bgStarted) {
      bgStarted = true;
      const bgMusic = document.getElementById("bgMusic");
      if (bgMusic && bgMusic.paused) {
        bgMusic.play().then(() => {
          // optional: tiny confirmation (tidak ganggu)
          showToast("Audio aktif", "success", 1400);
        }).catch(() => {});
      }
    }
  }

  function pointerKick(intensity = 1) {
    if (!pointerEl) return;
    if (pointerKickT) clearTimeout(pointerKickT);

    // micro random for realism
    const deg = (-8 - Math.random() * 6) * intensity; // -8..-14
    pointerEl.style.setProperty("--kick-deg", deg.toFixed(2) + "deg");

    pointerEl.classList.remove("is-kick");
    void pointerEl.offsetWidth;
    pointerEl.classList.add("is-kick");

    pointerKickT = setTimeout(() => pointerEl && pointerEl.classList.remove("is-kick"), 140);
  }

  function playTick(intensity = 1) {
    pointerKick(intensity);
    try {
      const a = tickPool[tickPoolIdx++ % tickPool.length];
      a.currentTime = 0;
      a.play().catch(() => {});
    } catch (_) {}
  }

  function playHistorySfx() {
    const now = Date.now();
    if (now - historySfxAt < 700) return;
    historySfxAt = now;
    try {
      const a = historyPool[historyPoolIdx++ % historyPool.length];
      a.currentTime = 0;
      a.play().catch(() => {});
    } catch (_) {}
  }

  /* =========================================================
   * 8) BUTTON FX + TOAST
   * ======================================================= */
  function pressFX(btn, ev) {
    if (!btn) return;

    const rect = btn.getBoundingClientRect();
    let x = rect.width / 2, y = rect.height / 2;

    if (ev && ev.clientX != null && ev.clientY != null) {
      x = ev.clientX - rect.left;
      y = ev.clientY - rect.top;
    }

    btn.style.setProperty("--fx-x", x + "px");
    btn.style.setProperty("--fx-y", y + "px");

    btn.classList.remove("fx");
    void btn.offsetWidth;
    btn.classList.add("fx");

    setTimeout(() => btn.classList.remove("fx"), 560);

    try { if (navigator.vibrate && !isReducedMotion()) navigator.vibrate(12); } catch (_) {}
  }

  function showToast(message, type = "info", ms = 2400) {
    const toast = document.getElementById("toast");
    const msg = document.getElementById("toastMsg");

    toast.classList.remove("error", "success");
    if (type === "error") toast.classList.add("error");
    if (type === "success") toast.classList.add("success");

    msg.textContent = String(message || "");
    toast.classList.add("show");

    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove("show"), ms);
  }

/* =========================================================
 * 9) WHEEL SVG + LABELS ‚Äî CASINO 1:1 (PREMIUM HD)
 * - Full SVG wheel: multi gold rim, bevel rings, glossy highlight
 * - Segments: clean green/ivory + vignette depth (3D)
 * - Labels: NO textLength stretch, auto-fit by measuring width
 * - Emboss text: stroke + shadow filter (crisp)
 * - Smooth resize: rAF debounced + cleanup
 * ======================================================= */

function setWheelBackground() {
  const wheel = document.getElementById("wheel");
  if (!wheel) return;
  // pastikan tidak ada conic gradient lama
  wheel.style.setProperty("--wheel-bg", "transparent");
  wheel.style.background = "transparent";
}

function drawWheelPrizes() {
  const wheel = document.getElementById("wheel");
  if (!wheel) return;

  // ensure positioning for absolute SVG
  try {
    const cs = getComputedStyle(wheel);
    if (cs.position === "static") wheel.style.position = "relative";
  } catch (_) {}

  // bersihin legacy
  wheel.querySelectorAll(".prize-text").forEach((el) => el.remove());
  const old = wheel.querySelector("svg.wheel-svg");
  if (old) old.remove();

  setWheelBackground();

  const prizes = (Array.isArray(PRIZES) && PRIZES.length) ? PRIZES : ["BONUS 10%"];
  const size = Math.min(wheel.clientWidth || 0, wheel.clientHeight || 0);
  if (!size) return;

  const svg = buildWheelSVG_CASINO(prizes);

  // IMPORTANT: let corefx/center overlay remain above if you have it
  svg.style.cssText =
    "position:absolute;inset:0;width:100%;height:100%;display:block;pointer-events:none;" +
    "transform:translateZ(0);will-change:transform;z-index:0;";

  // taruh paling bawah di dalam wheel
  wheel.insertBefore(svg, wheel.firstChild);
}

function initWheelAutoResize() {
  const wrap = document.getElementById("wheelWrap");
  if (!wrap) return;

  const ST = window.__MT2_WHEEL_CASINO || (window.__MT2_WHEEL_CASINO = {});
  if (ST.ro) { try { ST.ro.disconnect(); } catch (_) {} ST.ro = null; }
  if (ST.raf) { try { cancelAnimationFrame(ST.raf); } catch (_) {} ST.raf = 0; }

  const schedule = () => {
    if (ST.raf) return;
    ST.raf = requestAnimationFrame(() => {
      ST.raf = 0;
      drawWheelPrizes();
    });
  };

  if (window.ResizeObserver) {
    ST.ro = new ResizeObserver(() => schedule());
    ST.ro.observe(wrap);
  } else {
    window.addEventListener("resize", schedule, { passive: true });
  }

  schedule();
}

/* =========================================================
 * SVG BUILDER ‚Äî CASINO PREMIUM (HD + LIGHTS RIM) ‚Äî FINAL (BULBS GLOW v4)
 * ‚úÖ HAPUS: rim sweep / rim light muter (biar gak terlihat ‚Äúmainan‚Äù)
 * ‚úÖ MAX: bulbs glow lebih ‚Äúnyala‚Äù + bloom lembut modern
 * ‚úÖ Tetap: gold rim premium (static), segments HD, seam-safe, uid-safe
 * ======================================================= */

function buildWheelSVG_CASINO(prizes, opt = {}) {
  const list = Array.isArray(prizes) ? prizes : [];
  const safePrizes = (list.length ? list : ["-"]).map(v => String(v ?? "").trim() || "-");

  const n = safePrizes.length || 1;
  const seg = 360 / n;

  const NS = "http://www.w3.org/2000/svg";
  const VB = 1000;
  const cx = 500, cy = 500;

  // ‚úÖ proportions (modern casino)
  const rOuter = 492;
  const rimW1  = 24;
  const rimW2  = 6;

  const rSegOut = rOuter - (rimW1 + 14);

  const rSegIn = clampNumber(
    Number(opt.innerRadius ?? 136),
    110,
    178
  );

  const rText = Math.round((rSegIn + rSegOut) * 0.565);
  const dividerW = 2.4;

  const includeHub = (typeof opt.includeHub === "boolean")
    ? opt.includeHub
    : !(typeof document !== "undefined" && document.querySelector && document.querySelector(".wheel-center"));

  // bulbs controls
  const animateBulbs = (opt.animateBulbs !== false);
  const chaseDurMs = clampNumber(Number(opt.bulbChaseDurMs ?? 2600), 1200, 7000);
  const chaseStrength = clampNumber(Number(opt.bulbChaseStrength ?? 1.05), 0.2, 1.8);

  // ---- uid (anti bentrok defs) ----
  const uid = _wheelUid();
  const ID = (x) => `${uid}_${x}`;

  const E = (tag, attrs = {}) => {
    const el = document.createElementNS(NS, tag);
    for (const k in attrs) el.setAttribute(k, String(attrs[k]));
    return el;
  };

  const svg = E("svg", {
    class: "wheel-svg",
    viewBox: `0 0 ${VB} ${VB}`,
    preserveAspectRatio: "xMidYMid meet",
    "aria-hidden": "true",
    "shape-rendering": "geometricPrecision",
    "text-rendering": "geometricPrecision"
  });

  /* =========================
   * DEFS
   * ======================= */
  const defs = E("defs");
  defs.innerHTML = `
    <style>
      .wheel-svg { shape-rendering: geometricPrecision; text-rendering: geometricPrecision; }

      /* --- Bulb shimmer (lebih elegan: bukan blink keras) --- */
      .wheel-bulbs { --chaseDur: ${Math.max(0.01, chaseDurMs / 1000).toFixed(3)}s; --chaseK: ${chaseStrength.toFixed(3)}; }
      .wheel-bulbs .bulb-hi{
        opacity: calc(0.18 * var(--chaseK));
        transform-box: fill-box;
        transform-origin: center;
        animation: bulbShimmer var(--chaseDur) cubic-bezier(0.22, 1, 0.36, 1) infinite;
        animation-delay: var(--d, 0s);
        will-change: opacity, transform;
      }
      @keyframes bulbShimmer{
        0%   { opacity: calc(0.16 * var(--chaseK)); transform: scale(0.98); }
        10%  { opacity: calc(0.92 * var(--chaseK)); transform: scale(1.10); }
        24%  { opacity: calc(0.34 * var(--chaseK)); transform: scale(1.02); }
        100% { opacity: calc(0.16 * var(--chaseK)); transform: scale(0.98); }
      }
      @media (prefers-reduced-motion: reduce){
        .wheel-bulbs .bulb-hi{ animation:none; opacity:0.28; transform:none; }
      }
    </style>

    <!-- segments -->
    <linearGradient id="${ID("segGreen")}" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0" stop-color="#0c5a43"/>
      <stop offset="1" stop-color="#063b2b"/>
    </linearGradient>

    <linearGradient id="${ID("segIvory")}" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0" stop-color="#ffffff"/>
      <stop offset="1" stop-color="#e9eef3"/>
    </linearGradient>

    <!-- gold rim -->
    <linearGradient id="${ID("rimGold")}" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0" stop-color="#fff4d6"/>
      <stop offset="0.22" stop-color="#f6d586"/>
      <stop offset="0.50" stop-color="#f6b33d"/>
      <stop offset="0.76" stop-color="#c46b1c"/>
      <stop offset="1" stop-color="#7a3f13"/>
    </linearGradient>

    <!-- rim specular highlight (static, premium) -->
    <radialGradient id="${ID("rimSpec")}" cx="34%" cy="20%" r="72%">
      <stop offset="0" stop-color="#ffffff" stop-opacity="0.42"/>
      <stop offset="0.44" stop-color="#ffffff" stop-opacity="0.12"/>
      <stop offset="1" stop-color="#ffffff" stop-opacity="0"/>
    </radialGradient>

    <!-- segment depth + gloss -->
    <radialGradient id="${ID("segVignette")}" cx="50%" cy="50%" r="72%">
      <stop offset="0" stop-color="#000000" stop-opacity="0"/>
      <stop offset="0.72" stop-color="#000000" stop-opacity="0.14"/>
      <stop offset="1" stop-color="#000000" stop-opacity="0.38"/>
    </radialGradient>

    <radialGradient id="${ID("segGloss")}" cx="36%" cy="18%" r="74%">
      <stop offset="0" stop-color="#ffffff" stop-opacity="0.18"/>
      <stop offset="0.46" stop-color="#ffffff" stop-opacity="0.06"/>
      <stop offset="1" stop-color="#ffffff" stop-opacity="0"/>
    </radialGradient>

    <!-- donut mask (slices only) -->
    <mask id="${ID("maskDonut")}">
      <rect x="0" y="0" width="${VB}" height="${VB}" fill="black"/>
      <circle cx="${cx}" cy="${cy}" r="${rSegOut}" fill="white"/>
      <circle cx="${cx}" cy="${cy}" r="${rSegIn}" fill="black"/>
    </mask>

    <!-- INNER HUB WELL -->
    <radialGradient id="${ID("hubWell")}" cx="42%" cy="34%" r="78%">
      <stop offset="0" stop-color="#145b45" stop-opacity="0.98"/>
      <stop offset="0.55" stop-color="#083626" stop-opacity="0.98"/>
      <stop offset="1" stop-color="#03130d" stop-opacity="0.98"/>
    </radialGradient>

    <radialGradient id="${ID("hubWellSpec")}" cx="36%" cy="22%" r="78%">
      <stop offset="0" stop-color="#ffffff" stop-opacity="0.20"/>
      <stop offset="0.55" stop-color="#ffffff" stop-opacity="0.06"/>
      <stop offset="1" stop-color="#ffffff" stop-opacity="0"/>
    </radialGradient>

    <!-- CENTER GOLD CAP -->
    <radialGradient id="${ID("hubGold")}" cx="34%" cy="28%" r="76%">
      <stop offset="0" stop-color="#fff7de"/>
      <stop offset="0.22" stop-color="#f7d990"/>
      <stop offset="0.55" stop-color="#f3b24a"/>
      <stop offset="0.80" stop-color="#c26a1c"/>
      <stop offset="1" stop-color="#7a3f13"/>
    </radialGradient>

    <radialGradient id="${ID("hubGoldSpec")}" cx="30%" cy="18%" r="70%">
      <stop offset="0" stop-color="#ffffff" stop-opacity="0.55"/>
      <stop offset="0.40" stop-color="#ffffff" stop-opacity="0.16"/>
      <stop offset="1" stop-color="#ffffff" stop-opacity="0"/>
    </radialGradient>

    <!-- bulb fill (lebih bright, biar glow ‚Äúhidup‚Äù) -->
    <radialGradient id="${ID("bulbFill")}" cx="35%" cy="28%" r="72%">
      <stop offset="0" stop-color="#ffffff" stop-opacity="1"/>
      <stop offset="0.30" stop-color="#fff7e4" stop-opacity="1"/>
      <stop offset="0.62" stop-color="#ffd27a" stop-opacity="1"/>
      <stop offset="1" stop-color="#b75b18" stop-opacity="1"/>
    </radialGradient>

    <!-- text emboss -->
    <filter id="${ID("txtEmboss")}" x="-40%" y="-40%" width="180%" height="180%">
      <feDropShadow dx="0" dy="8" stdDeviation="6" flood-color="#000000" flood-opacity="0.55"/>
      <feDropShadow dx="0" dy="1.5" stdDeviation="1.1" flood-color="#ffffff" flood-opacity="0.10"/>
    </filter>

    <!-- rim shadow -->
    <filter id="${ID("rimShadow")}" x="-30%" y="-30%" width="160%" height="160%">
      <feDropShadow dx="0" dy="16" stdDeviation="16" flood-color="#000000" flood-opacity="0.42"/>
    </filter>

    <!-- ‚úÖ BULB BLOOM (lebih kuat, tetap soft modern) -->
    <filter id="${ID("bulbGlow")}" x="-120%" y="-120%" width="340%" height="340%">
      <feDropShadow dx="0" dy="0" stdDeviation="7.0" flood-color="#ffcf63" flood-opacity="0.55"/>
      <feDropShadow dx="0" dy="0" stdDeviation="3.2" flood-color="#ffffff" flood-opacity="0.26"/>
      <feDropShadow dx="0" dy="0" stdDeviation="1.2" flood-color="#fff2c8" flood-opacity="0.20"/>
    </filter>

    <!-- ‚úÖ BULB SPARK (runner highlight lebih ‚Äúnyala‚Äù tapi lembut) -->
    <filter id="${ID("bulbSpark")}" x="-160%" y="-160%" width="420%" height="420%">
      <feDropShadow dx="0" dy="0" stdDeviation="10.2" flood-color="#ffd77a" flood-opacity="0.72"/>
      <feDropShadow dx="0" dy="0" stdDeviation="4.0"  flood-color="#ffffff" flood-opacity="0.36"/>
    </filter>

    <!-- hub shadow -->
    <filter id="${ID("hubShadow")}" x="-38%" y="-38%" width="176%" height="176%">
      <feDropShadow dx="0" dy="7" stdDeviation="7" flood-color="#000000" flood-opacity="0.26"/>
    </filter>
  `;
  svg.appendChild(defs);

  /* =========================
   * ROOT GROUPS (spin + labels)
   * ======================= */
  const gSpin = E("g", { class: "wheel-spin" });
  const gLabels = E("g", { class: "wheel-labels" });
  svg.appendChild(gSpin);
  svg.appendChild(gLabels);

  const _labelNodes = [];
  svg.__wheel = {
    uid,
    cx, cy,
    setRotation(deg, opt2 = {}) {
      const d = Number(deg || 0);
      const upright = !!opt2.uprightLabels;

      gSpin.setAttribute("transform", `rotate(${d} ${cx} ${cy})`);
      gLabels.setAttribute("transform", `rotate(${d} ${cx} ${cy})`);

      if (upright) {
        const inv = -d;
        for (const it of _labelNodes) it.el.setAttribute("transform", `rotate(${inv} ${it.x} ${it.y})`);
      } else {
        for (const it of _labelNodes) it.el.removeAttribute("transform");
      }
    }
  };

  /* =========================
   * OUTER SHADOW WEIGHT
   * ======================= */
  gSpin.appendChild(E("circle", {
    cx, cy,
    r: (rOuter - 2),
    fill: "none",
    stroke: "#000000",
    "stroke-opacity": "0.18",
    "stroke-width": "10",
    filter: `url(#${ID("rimShadow")})`
  }));

  /* =========================
   * SEGMENTS
   * ======================= */
  const gSlices = E("g", { class: "wheel-slices" });
  gSpin.appendChild(gSlices);

  const mctx = getMeasureCtx();
  const segForMeasure = Math.min(seg, 179.999);
  const maxLabelW = (n <= 1) ? (rText * 1.85) : (segmentChord(rText, segForMeasure) * 0.78);
  const EPS = (n >= 3 ? 0.10 : 0.06);

  for (let i = 0; i < n; i++) {
    const a0 = i * seg;
    const a1 = (i + 1) * seg;
    const mid = a0 + seg / 2;

    const isIvory = (i % 2 === 1);
    const fill = isIvory ? `url(#${ID("segIvory")})` : `url(#${ID("segGreen")})`;

    let s0 = a0, s1 = a1;
    if (n > 1) {
      if (i > 0) s0 -= EPS;
      if (i < n - 1) s1 += EPS;
      if (i === 0) s0 = 0;
      if (i === n - 1) s1 = 360;
    } else {
      s0 = 0; s1 = 359.999;
    }

    gSlices.appendChild(E("path", {
      d: svgDonutWedge(cx, cy, rSegIn, rSegOut, s0, s1),
      fill
    }));

    if (n > 1) {
      const p1 = polar(cx, cy, rSegIn + 10, a0);
      const p2 = polar(cx, cy, rSegOut - 10, a0);

      gSlices.appendChild(E("line", {
        x1: p1.x.toFixed(2), y1: p1.y.toFixed(2),
        x2: p2.x.toFixed(2), y2: p2.y.toFixed(2),
        stroke: "#ffffff",
        "stroke-opacity": isIvory ? "0.08" : "0.10",
        "stroke-width": String(dividerW),
        "vector-effect": "non-scaling-stroke"
      }));
    }

    // label
    const label = safePrizes[i];
    const tp = polar(cx, cy, rText, mid);

    const isBonus = /bonus/i.test(label);
    const baseFont = isBonus ? 38 : 50;

    const fontWeight = isBonus ? 1000 : 900;
    const letterSpacing = isBonus ? 1.6 : 1.1;

    let fontSize = baseFont;
    if (mctx) {
      fontSize = fitFontSizeByWidth(mctx, label, maxLabelW, {
        base: baseFont,
        min: isBonus ? 32 : 38,
        weight: fontWeight,
        family: "system-ui, -apple-system, Segoe UI, Roboto, Arial",
        letterSpacingPx: letterSpacing
      });
    }

    const text = E("text", {
      x: tp.x.toFixed(2),
      y: tp.y.toFixed(2),
      "text-anchor": "middle",
      "dominant-baseline": "middle",
      filter: `url(#${ID("txtEmboss")})`,
      "font-family": "system-ui, -apple-system, Segoe UI, Roboto, Arial",
      "font-weight": String(fontWeight),
      "font-size": String(fontSize),
      "letter-spacing": String(letterSpacing),
      "paint-order": "stroke"
    });

    if (isBonus) {
      text.setAttribute("fill", "#f6b33d");
      text.setAttribute("stroke", "#ffffff");
      text.setAttribute("stroke-opacity", "0.26");
      text.setAttribute("stroke-width", "1.2");
    } else if (isIvory) {
      text.setAttribute("fill", "#063b2b");
      text.setAttribute("stroke", "#ffffff");
      text.setAttribute("stroke-opacity", "0.20");
      text.setAttribute("stroke-width", "1.0");
    } else {
      text.setAttribute("fill", "#ffffff");
      text.setAttribute("fill-opacity", "0.96");
      text.setAttribute("stroke", "#000000");
      text.setAttribute("stroke-opacity", "0.18");
      text.setAttribute("stroke-width", "1.0");
    }

    text.textContent = label;
    gLabels.appendChild(text);
    _labelNodes.push({ el: text, x: tp.x.toFixed(2), y: tp.y.toFixed(2) });
  }

  /* =========================
   * DEPTH OVERLAYS (masked donut)
   * ======================= */
  gSpin.appendChild(E("rect", {
    x: 0, y: 0, width: VB, height: VB,
    fill: `url(#${ID("segVignette")})`,
    mask: `url(#${ID("maskDonut")})`
  }));

  gSpin.appendChild(E("rect", {
    x: 0, y: 0, width: VB, height: VB,
    fill: `url(#${ID("segGloss")})`,
    mask: `url(#${ID("maskDonut")})`
  }));

  /* =========================
   * BEVEL EDGES (OUTER)
   * ======================= */
  gSpin.appendChild(E("circle", {
    cx, cy,
    r: (rSegOut + 3),
    fill: "none",
    stroke: "#ffffff",
    "stroke-opacity": "0.14",
    "stroke-width": "6",
    "vector-effect": "non-scaling-stroke"
  }));

  /* =========================
   * GOLD RIM (static premium)
   * ======================= */
  gSpin.appendChild(E("circle", {
    cx, cy,
    r: (rOuter - 1),
    fill: "none",
    stroke: "#ffffff",
    "stroke-opacity": "0.16",
    "stroke-width": "2",
    "vector-effect": "non-scaling-stroke"
  }));

  gSpin.appendChild(E("circle", {
    cx, cy,
    r: (rOuter - rimW1 / 2),
    fill: "none",
    stroke: `url(#${ID("rimGold")})`,
    "stroke-width": String(rimW1),
    "vector-effect": "non-scaling-stroke"
  }));

  gSpin.appendChild(E("circle", {
    cx, cy,
    r: (rOuter - rimW1 / 2),
    fill: "none",
    stroke: `url(#${ID("rimSpec")})`,
    "stroke-width": String(rimW1 + 6),
    "vector-effect": "non-scaling-stroke"
  }));

  gSpin.appendChild(E("circle", {
    cx, cy,
    r: (rSegOut + 18),
    fill: "none",
    stroke: "#f6b33d",
    "stroke-opacity": "0.58",
    "stroke-width": String(rimW2),
    "vector-effect": "non-scaling-stroke"
  }));

  /* =========================
   * RIM LIGHTS / BULBS (MAX GLOW)
   * ======================= */
  const gBulbWrap = E("g", { class: "wheel-bulbs", opacity: "1" });

  const bulbCount = Math.max(28, Math.min(48, n * 4));
  const bulbR = Math.max(6, Math.min(11, Math.round(rimW1 * 0.38)));
  const bulbOrbit = rOuter - (rimW1 * 0.55);

  const gBulbBase = E("g", { class: "bulb-layer base", filter: `url(#${ID("bulbGlow")})` });
  const gBulbHi = E("g", { class: "bulb-layer hi", filter: `url(#${ID("bulbSpark")})` });

  const chaseStepS = (chaseDurMs / 1000) / bulbCount;

  for (let i = 0; i < bulbCount; i++) {
    const a = (360 / bulbCount) * i;
    const p = polar(cx, cy, bulbOrbit, a);

    // halo plate (tanpa filter per bulb; glow group yang urus bloom)
    gBulbBase.appendChild(E("circle", {
      cx: p.x.toFixed(2),
      cy: p.y.toFixed(2),
      r: String(bulbR * 1.55),
      fill: "#ffd67a",
      "fill-opacity": "0.16"
    }));

    // base bulb
    gBulbBase.appendChild(E("circle", {
      class: "bulb-base",
      cx: p.x.toFixed(2),
      cy: p.y.toFixed(2),
      r: String(bulbR),
      fill: `url(#${ID("bulbFill")})`,
      stroke: "#ffffff",
      "stroke-opacity": "0.22",
      "stroke-width": "1.2"
    }));

    // tiny spec dot
    gBulbBase.appendChild(E("circle", {
      cx: (p.x - bulbR * 0.22).toFixed(2),
      cy: (p.y - bulbR * 0.28).toFixed(2),
      r: String(Math.max(1.7, bulbR * 0.26)),
      fill: "#ffffff",
      "fill-opacity": "0.66"
    }));

    // shimmer runner (soft)
    if (animateBulbs) {
      const hi = E("circle", {
        class: "bulb-hi",
        cx: p.x.toFixed(2),
        cy: p.y.toFixed(2),
        r: String(Math.max(1.2, bulbR * 0.96)),
        fill: "#ffffff",
        "fill-opacity": "1"
      });
      hi.setAttribute("style", `--d:${(-i * chaseStepS).toFixed(3)}s;`);
      gBulbHi.appendChild(hi);
    }
  }

  gBulbWrap.appendChild(gBulbBase);
  if (animateBulbs) gBulbWrap.appendChild(gBulbHi);
  gSpin.appendChild(gBulbWrap);

  /* =========================
   * OPTIONAL: SVG HUB
   * ======================= */
  if (includeHub) {
    const gHub = E("g", { class: "wheel-hub" });

    gHub.appendChild(E("circle", {
      cx, cy,
      r: Math.max(1, rSegIn - 8),
      fill: `url(#${ID("hubWell")})`,
      filter: `url(#${ID("hubShadow")})`
    }));
    gHub.appendChild(E("circle", {
      cx, cy,
      r: Math.max(1, rSegIn - 8),
      fill: `url(#${ID("hubWellSpec")})`
    }));

    const capR = Math.max(42, Math.round((rSegIn - 8) * 0.46));
    gHub.appendChild(E("circle", { cx, cy, r: capR, fill: `url(#${ID("hubGold")})` }));
    gHub.appendChild(E("circle", { cx, cy, r: capR, fill: `url(#${ID("hubGoldSpec")})` }));

    gHub.appendChild(E("circle", {
      cx, cy,
      r: Math.max(1, capR - 2),
      fill: "none",
      stroke: "#ffffff",
      "stroke-opacity": "0.18",
      "stroke-width": "2",
      "vector-effect": "non-scaling-stroke"
    }));

    gSpin.appendChild(gHub);
  }

  return svg;
}

/* =========================================================
 * helpers (FULL REPLACE)
 * ======================================================= */

function clampNumber(v, lo, hi){
  const x = Number(v);
  if (!Number.isFinite(x)) return lo;
  return Math.max(lo, Math.min(hi, x));
}

function polar(cx, cy, r, deg) {
  const a = (deg - 90) * Math.PI / 180;
  return { x: cx + r * Math.cos(a), y: cy + r * Math.sin(a) };
}

function svgDonutWedge(cx, cy, r0, r1, a0, a1) {
  const sweep = Math.abs(a1 - a0);
  const large = sweep > 180 ? 1 : 0;

  const p1 = polar(cx, cy, r1, a0);
  const p2 = polar(cx, cy, r1, a1);
  const p3 = polar(cx, cy, r0, a1);
  const p4 = polar(cx, cy, r0, a0);

  return [
    `M ${p1.x.toFixed(2)} ${p1.y.toFixed(2)}`,
    `A ${r1} ${r1} 0 ${large} 1 ${p2.x.toFixed(2)} ${p2.y.toFixed(2)}`,
    `L ${p3.x.toFixed(2)} ${p3.y.toFixed(2)}`,
    `A ${r0} ${r0} 0 ${large} 0 ${p4.x.toFixed(2)} ${p4.y.toFixed(2)}`,
    "Z"
  ].join(" ");
}

function getMeasureCtx() {
  if (getMeasureCtx._ctx) return getMeasureCtx._ctx;
  const c = document.createElement("canvas");
  c.width = 64; c.height = 64;
  getMeasureCtx._ctx = c.getContext("2d");
  return getMeasureCtx._ctx;
}

function segmentChord(r, segDeg) {
  const rad = (segDeg * Math.PI) / 180;
  return 2 * r * Math.sin(rad / 2);
}

function fitFontSizeByWidth(ctx, text, maxW, opt) {
  const t = String(text || "");
  const base = opt.base || 48;
  const min = opt.min || 34;
  const family = opt.family || "system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const weight = opt.weight || 900;
  const ls = Number(opt.letterSpacingPx || 0);

  let fs = base;
  while (fs >= min) {
    ctx.font = `${weight} ${fs}px ${family}`;
    const w0 = ctx.measureText(t).width;
    const w = w0 + Math.max(0, (t.length - 1)) * ls;
    if (w <= maxW) return fs;
    fs -= 1;
  }
  return min;
}

function _wheelUid() {
  const g = _wheelUid;
  g._seq = (g._seq || 0) + 1;

  let rand = "";
  if (typeof crypto !== "undefined" && crypto.randomUUID) {
    rand = crypto.randomUUID().replace(/-/g, "").slice(0, 12);
  } else if (typeof crypto !== "undefined" && crypto.getRandomValues) {
    const a = new Uint32Array(3);
    crypto.getRandomValues(a);
    rand = Array.from(a).map(x => x.toString(16).padStart(8, "0")).join("").slice(0, 12);
  } else {
    rand = Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);
    rand = rand.slice(0, 12);
  }

  return `w${Date.now().toString(36)}_${g._seq.toString(36)}_${rand}`;
}

  /* =========================================================
   * 10) HISTORY (random + realtime) ‚Äî UNIQUE
   * ======================================================= */
  function pickWeightedPrizeKey() {
    const bag = [
      ["BONUS 10%", 30],
      ["25K", 17],
      ["50K", 18],
      ["75K", 14],
      ["100K", 12],
      ["200K", 9],
    ];

    const total = bag.reduce((a, [, w]) => a + w, 0);
    let r = Math.random() * total;

    for (const [p, w] of bag) { r -= w; if (r <= 0) return p; }
    return "50K";
  }

  function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
  function pad2(n) { return String(n).padStart(2, "0"); }

  function randomUserId() {
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
    const pick = (s) => s[Math.floor(Math.random() * s.length)];

    const len = randInt(7, 11);
    let out = "";

    for (let i = 0; i < len; i++) out += (Math.random() < 0.30) ? String(randInt(0, 9)) : pick(letters);
    if (Math.random() < 0.35) out += String(randInt(0, 9));

    return out;
  }

  function maskUserId(str) {
    const s = String(str || "");
    if (s.length <= 6) return s.slice(0, 2) + "****";
    return (s.slice(0, 3) + "****" + s.slice(-2));
  }

  function makeEntryId(prefix) {
    return `${prefix || "w"}-${Date.now()}-${Math.random().toString(16).slice(2)}-${Math.random().toString(16).slice(2)}`;
  }

  function rememberMasked(id) {
    const v = String(id || "");
    if (!v) return;
    if (recentMasked.has(v)) return;

    recentMasked.add(v);
    recentMaskedQueue.push(v);

    // keep last ~70
    while (recentMaskedQueue.length > 70) {
      const old = recentMaskedQueue.shift();
      recentMasked.delete(old);
    }
  }

  function uniqueMaskedId(maxTry = 60) {
    for (let i = 0; i < maxTry; i++) {
      const masked = maskUserId(randomUserId());
      if (!recentMasked.has(masked)) {
        rememberMasked(masked);
        return masked;
      }
    }

    const fallback = maskUserId(randomUserId());
    rememberMasked(fallback);
    return fallback;
  }

  function generateMockWinnersRandom() {
    let base = Date.now() - randInt(40, 220) * 1000;
    const arr = [];

    for (let i = 0; i < 50; i++) {
      const prizeKey = pickWeightedPrizeKey();
      const masked = uniqueMaskedId();

      arr.push({
        id: makeEntryId("seed"),
        isUser: false,
        fullId: "",
        displayId: masked,
        prizeKey,
        prize: CONFIG.PRIZE_DISPLAY_MAP[prizeKey] || prizeKey,
        ts: base,
        isNew: false
      });

      base -= randInt(20, 160) * 1000;
    }

    arr.sort((a, b) => (b.ts || 0) - (a.ts || 0));
    return arr;
  }

  function timeLabel(ts) {
    const d = new Date(ts || Date.now());
    const dateStr = d.toLocaleDateString("id-ID", { day: "2-digit", month: "short", year: "numeric" });
    const timeStr = `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;

    const diff = Math.max(0, Date.now() - (ts || Date.now()));
    const sec = Math.floor(diff / 1000);

    let rel = "baru saja";
    if (sec >= 60) {
      const min = Math.floor(sec / 60);
      if (min < 60) rel = `${min}m lalu`;
      else {
        const hr = Math.floor(min / 60);
        if (hr < 24) rel = `${hr}j lalu`;
        else rel = `${Math.floor(hr / 24)} hari lalu`;
      }
    }

    return `${dateStr} ${timeStr} ‚Ä¢ ${rel}`;
  }

  function startMetaTicker() {
    if (metaTimer) clearInterval(metaTimer);
    metaTimer = setInterval(() => {
      document.querySelectorAll(".winner-meta[data-ts]").forEach((el) => {
        const ts = Number(el.getAttribute("data-ts") || Date.now());
        el.textContent = timeLabel(ts);
      });
    }, 15000);
  }

  function pushWinnerEntry(entry) {
    if (!entry) return;
    if (!entry.id) entry.id = makeEntryId(entry.isUser ? "user" : "live");
    if (entry.isNew) playHistorySfx();

    winners.forEach((w) => (w.isNew = false));
    winners.unshift(entry);
    winners = winners.slice(0, 50);

    renderWinners({ preserveScroll: true });
    startMetaTicker();
  }

  function startLiveHistory() {
    if (liveTimer) return;
    if (pauseReasons.size > 0) return;

    const schedule = () => {
      stopLiveHistory();
      const ms = randInt(5200, 12500);

      liveTimer = setTimeout(() => {
        if (!isModalOpen() && !isSpin && pauseReasons.size === 0) {
          const prizeKey = pickWeightedPrizeKey();
          pushWinnerEntry({
            id: makeEntryId("live"),
            isUser: false,
            fullId: "",
            displayId: uniqueMaskedId(),
            prizeKey,
            prize: CONFIG.PRIZE_DISPLAY_MAP[prizeKey] || prizeKey,
            ts: Date.now(),
            isNew: true
          });
        }
        schedule();
      }, ms);
    };

    schedule();
  }

  function stopLiveHistory() {
    if (liveTimer) clearTimeout(liveTimer);
    liveTimer = 0;
  }

  /* =========================================================
   * 11) WINNERS RENDER (FLIP)
   * ======================================================= */
  function ensureWinnersHeader(table) {
    let header = table.querySelector(".winners-table-header");
    if (!header) {
      header = document.createElement("div");
      header.className = "winners-table-header";
      header.innerHTML = "<div>NO</div><div>USER ID</div><div>HADIAH</div>";
      table.appendChild(header);
    }
    return header;
  }

  function createRowEl(entry) {
    const row = document.createElement("div");
    row.className = "winners-table-row" + (entry.isNew ? " is-new" : "") + (entry.isUser ? " is-user" : "");
    row.setAttribute("data-id", entry.id);
    row.tabIndex = entry.isUser ? 0 : -1;

    const c1 = document.createElement("div");
    c1.className = "winner-no";

    const c2 = document.createElement("div");
    c2.className = "winner-id";

    const meta = document.createElement("div");
    meta.className = "winner-meta";
    meta.setAttribute("data-ts", String(entry.ts || Date.now()));

    const c2wrap = document.createElement("div");
    c2wrap.appendChild(c2);
    c2wrap.appendChild(meta);

    const c3 = document.createElement("div");
    c3.className = "winner-prize";

    row.append(c1, c2wrap, c3);
    return row;
  }

  function patchRowContent(row, entry, index) {
    row.classList.toggle("is-new", !!entry.isNew);
    row.classList.toggle("is-user", !!entry.isUser);
    row.tabIndex = entry.isUser ? 0 : -1;

    const no = row.querySelector(".winner-no");
    const id = row.querySelector(".winner-id");
    const meta = row.querySelector(".winner-meta");
    const prize = row.querySelector(".winner-prize");

    if (no) no.textContent = String(index + 1);
    if (id) id.textContent = String(entry.displayId || "");

    if (meta) {
      meta.setAttribute("data-ts", String(entry.ts || Date.now()));
      meta.textContent = timeLabel(entry.ts);
    }

    if (prize) prize.textContent = String(entry.prize || "");
  }

  function renderWinners(opts = {}) {
    const o = Object.assign({ preserveScroll: true }, opts);
    const table = document.getElementById("winnersTable");
    if (!table) return;

    let prevScrollTop = 0;
    try { prevScrollTop = table.scrollTop || 0; } catch (_) {}

    ensureWinnersHeader(table);

    winnersById = new Map();
    for (const w of winners) winnersById.set(w.id, w);

    const first = {};
    for (const [id, el] of rowElById.entries()) {
      if (!el || !el.isConnected) continue;
      first[id] = el.getBoundingClientRect().top;
    }

    for (let i = 0; i < winners.length; i++) {
      const w = winners[i];
      if (!w.id) w.id = makeEntryId("w");

      let row = rowElById.get(w.id);
      if (!row || !row.isConnected) {
        row = createRowEl(w);
        rowElById.set(w.id, row);
        table.appendChild(row);
      }

      patchRowContent(row, w, i);
    }

    for (const [id, el] of Array.from(rowElById.entries())) {
      if (!winnersById.has(id)) {
        try { el.remove(); } catch (_) {}
        rowElById.delete(id);
      }
    }

    const header = table.querySelector(".winners-table-header");
    for (const w of winners) {
      const row = rowElById.get(w.id);
      if (row && row.isConnected) table.appendChild(row);
    }
    if (header && header.isConnected) table.insertBefore(header, table.firstChild);

    const last = {};
    for (const w of winners) {
      const el = rowElById.get(w.id);
      if (!el || !el.isConnected) continue;
      last[w.id] = el.getBoundingClientRect().top;
    }

    requestAnimationFrame(() => {
      for (const w of winners) {
        const el = rowElById.get(w.id);
        if (!el || !el.isConnected) continue;

        const a = first[w.id];
        const b = last[w.id];
        if (typeof a !== "number" || typeof b !== "number") continue;

        const dy = a - b;
        if (Math.abs(dy) < 0.5) continue;

        el.style.transform = `translateY(${dy}px)`;
        el.style.transition = "transform 0ms";
      }

      requestAnimationFrame(() => {
        for (const w of winners) {
          const el = rowElById.get(w.id);
          if (!el || !el.isConnected) continue;
          el.style.transition = "";
          el.style.transform = "";
        }
      });
    });

    if (o.preserveScroll) {
      try { table.scrollTop = prevScrollTop; } catch (_) {}
    }
  }

  /* =========================================================
   * 12) Klik history: HANYA USER ASLI
   * ======================================================= */
  function setupHistoryRowOpen() {
    const table = document.getElementById("winnersTable");
    if (!table) return;

    const tryOpen = (row) => {
      const id = row.getAttribute("data-id");
      const entry = winnersById.get(id);
      if (!entry) return;

      if (!entry.isUser) {
        const now = Date.now();
        if (now - nonUserToastAt > 1800) {
          nonUserToastAt = now;
          showToast("Hanya riwayat Anda yang bisa dibuka.", "error", 1800);
        }
        return;
      }

      const showUser = String(entry.fullId || entry.displayId || "-");
      const prizeShow = String(entry.prize || entry.prizeKey || "-");
      const ts = Number(entry.ts || Date.now());

      lastResult = { userId: showUser, prizeLabel: prizeShow, prizeDisplay: prizeShow, ts };

      document.getElementById("prizeAmount").textContent = prizeShow;
      document.getElementById("modalUserId").textContent = showUser;
      document.getElementById("modalTime").textContent = new Date(ts).toLocaleString("id-ID", {
        day: "2-digit", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });

      openModal();
    };

    table.addEventListener("click", (e) => {
      const row = (e.target && e.target.closest) ? e.target.closest(".winners-table-row") : null;
      if (!row) return;
      tryOpen(row);
    });

    table.addEventListener("keydown", (e) => {
      if (e.key !== "Enter" && e.key !== " ") return;
      const row = (e.target && e.target.classList && e.target.classList.contains("winners-table-row")) ? e.target : null;
      if (!row) return;

      e.preventDefault();
      tryOpen(row);
    });
  }

  /* =========================================================
   * 13) JACKPOT
   * ======================================================= */
  function initJackpot() {
    const saved = Number(lsGet(LS.JACKPOT_VAL, "0") || "0");
    if (saved && saved > 1000000) return saved;

    const seed = randInt(880_000_000, 930_000_000);
    lsSet(LS.JACKPOT_VAL, String(seed));
    return seed;
  }

  function fmtClock() {
    const d = new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

  function startJackpot() {
    if (jackpotTimer) return;

    const el = document.getElementById("jackpot");
    const meta = document.getElementById("jackpotMeta");

    let speed = randInt(1400, 8200);
    let last = performance.now();

    const step = () => {
      const now = performance.now();
      const dt = Math.min(0.22, (now - last) / 1000);
      last = now;

      if (now > spikeUntilMs) {
        spikeMul = 1;
        if (Math.random() < 0.0012) {
          spikeMul = 2.0 + Math.random() * 2.3;
          spikeUntilMs = now + (2000 + Math.random() * 2500);
        }
      }

      const noise = (Math.random() - 0.5) * 0.8;
      let v = speed * (1 + noise) * spikeMul;
      if (Math.random() < 0.03) v *= -0.25;

      jackpot = Math.max(800_000_000, jackpot + v * dt);

      if (el) el.textContent = `IDR ${Math.round(jackpot).toLocaleString("id-ID")}`;
      if (meta) meta.textContent = `Update: ${fmtClock()}`;

      jackpotTimer = requestAnimationFrame(step);
    };

    jackpotTimer = requestAnimationFrame(step);

    if (jackpotSaveTimer) clearInterval(jackpotSaveTimer);
    jackpotSaveTimer = setInterval(() => {
      lsSet(LS.JACKPOT_VAL, String(Math.round(jackpot)));
      if (Math.random() < 0.55) speed = randInt(1400, 9500);
    }, 3000);
  }

  function stopJackpot() {
    if (jackpotTimer) cancelAnimationFrame(jackpotTimer);
    jackpotTimer = 0;

    if (jackpotSaveTimer) clearInterval(jackpotSaveTimer);
    jackpotSaveTimer = 0;
  }

  /* =========================================================
   * 14) MODAL (pause/resume history + focus trap + inert)
   * ======================================================= */
  function isModalOpen() {
    return document.getElementById("prizeModal").classList.contains("show");
  }

  function openModal() {
    const modal = document.getElementById("prizeModal");
    lastFocusedEl = document.activeElement;

    pauseHistory("modal");
    setInert("modal", true);

    modal.classList.add("show");
    modal.setAttribute("aria-hidden", "false");
    document.body.classList.add("modal-open");

    const claimBtn = document.getElementById("claimBtn");
    if (claimBtn) setTimeout(() => claimBtn.focus({ preventScroll: true }), 0);
  }

  function closeModal() {
    const modal = document.getElementById("prizeModal");

    modal.classList.remove("show");
    modal.setAttribute("aria-hidden", "true");

    resumeHistory("modal");
    setInert("modal", false);

    // only remove modal-open if nav overlay not showing
    if (!isNavOpen()) document.body.classList.remove("modal-open");

    if (lastFocusedEl && lastFocusedEl.isConnected && typeof lastFocusedEl.focus === "function") {
      lastFocusedEl.focus({ preventScroll: true });
    }
    lastFocusedEl = null;
  }

  function trapFocus(e) {
    const modal = document.getElementById("prizeModal");
    const root = (modal && modal.querySelector) ? modal.querySelector(".modal-content") : null;
    if (!root) return;

    const focusables = root.querySelectorAll(
      'button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])'
    );
    const list = Array.from(focusables).filter((el) => el && !el.disabled && el.offsetParent !== null);
    if (list.length === 0) return;

    const first = list[0];
    const last = list[list.length - 1];

    const active = document.activeElement;

    if (e.shiftKey) {
      if (active === first || active === root) {
        e.preventDefault();
        last.focus({ preventScroll: true });
      }
    } else {
      if (active === last) {
        e.preventDefault();
        first.focus({ preventScroll: true });
      }
    }
  }

  /* =========================================================
   * 15) UI
   * ======================================================= */
  function updateUI() {
    const spinBtn = document.getElementById("spinBtn");
    const userIdInput = document.getElementById("userIdInput");
    const spunMessage = document.getElementById("spunMessage");

    if (hasSpun) {
      spinBtn.disabled = true;
      spinBtn.textContent = "SUDAH SPIN";
      userIdInput.disabled = true;
      spunMessage.style.display = "block";
    } else {
      spinBtn.disabled = false;
      spinBtn.textContent = "SPIN SEKARANG!";
      userIdInput.disabled = false;
      spunMessage.style.display = "none";
    }
  }

  /* =========================================================
   * 16) tick per-segment (token-based cancel)
   * ======================================================= */
  function clearTickTimers() {
    for (const t of tickTimers) {
      try { clearTimeout(t); } catch (_) {}
    }
    tickTimers = [];
  }

  function scheduleTicks(rotationDeltaDeg, segmentAngleDeg, durationMs, token) {
    if (isReducedMotion()) return;

    const ticks = Math.max(0, Math.floor(Math.abs(rotationDeltaDeg) / segmentAngleDeg));
    if (ticks <= 0) return;

    const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);
    const maxTicks = 130;
    const count = Math.min(ticks, maxTicks);

    for (let i = 1; i <= count; i++) {
      const t = i / count;
      const when = Math.round(easeOutCubic(t) * durationMs);
      const jitter = randInt(-10, 12);

      // ease-out intensity: strong early, softer near end
      const intensity = Math.max(0.45, 1 - t * 0.55);

      const id = setTimeout(() => {
        if (token !== spinToken) return;
        playTick(intensity);
      }, Math.max(0, when + jitter));

      tickTimers.push(id);
    }
  }

  /* =========================================================
   * 17) SPIN (LOCK RESULT BONUS 10%)
   * ======================================================= */
  function startSpin() {
    kickAudio(true);

    const reduceMotion = isReducedMotion();

    const userIdInput = document.getElementById("userIdInput");
    const rawUserId = userIdInput.value.trim();
    const userId = normalizeUserIdInput(rawUserId);

    if (!userId) {
      showToast("Masukkan User ID terlebih dahulu!", "error");
      userIdInput.focus({ preventScroll: true });
      return;
    }

    if (hasSpun) { showToast("Anda sudah melakukan spin! Kesempatan hanya 1x.", "error"); return; }
    if (isSpin) return;

    isSpin = true;
    pauseHistory("spin");

    // new spin token cancels old tick timers
    spinToken++;
    clearTickTimers();

    if (pointerEl) pointerEl.classList.add("is-spin");

    const spinBtn = document.getElementById("spinBtn");
    spinBtn.disabled = true;
    spinBtn.textContent = "SPINNING‚Ä¶";

    const spinSound = document.getElementById("spinSound");
    try { spinSound.currentTime = 0; spinSound.play().catch(() => {}); } catch (_) {}

    const prizeIndex = (BONUS_INDEX >= 0 ? BONUS_INDEX : 0);

    const wheel = document.getElementById("wheel");
    const n = PRIZES.length;
    const segmentAngle = 360 / n;

    const segmentCenter = (prizeIndex * segmentAngle) + (segmentAngle / 2);
    const base = ((currentRotation % 360) + 360) % 360;
    const desiredMod = (360 - segmentCenter + 360) % 360;

    const fullSpins = 360 * (8 + Math.floor(Math.random() * 4));
    const jitter = (Math.random() - 0.5) * (segmentAngle * 0.55);
    const delta = (desiredMod - base + 360) % 360;

    const totalRotation = currentRotation + fullSpins + delta + jitter;
    const rotationDelta = totalRotation - currentRotation;
    const durationMs = reduceMotion ? 350 : CONFIG.SPIN_DURATION_MS;

    wheel.style.setProperty("--spin-dur", durationMs + "ms");

    // Pre-pause modal to avoid any flicker start when removing spin pause
    pauseHistory("modal");

    let ended = false;
    const localToken = spinToken;

    const onEnd = () => {
      if (ended) return;
      ended = true;

      // cancel remaining tick timers immediately
      clearTickTimers();

      wheel.classList.remove("spinning");
      applyWheelRotation(totalRotation);
      saveRotation(totalRotation);

      try { spinSound.pause(); spinSound.currentTime = 0; } catch (_) {}

      const winSound = document.getElementById("winSound");
      try { winSound.currentTime = 0; winSound.play().catch(() => {}); } catch (_) {}

      if (pointerEl) pointerEl.classList.remove("is-spin");

      hasSpun = true;
      spinAt = Date.now();

      lsSet(LS.HAS_SPUN, "true");
      lsSet(LS.SPIN_AT, String(spinAt));
      lsSet(LS.LAST_USER_ID, userId);

      savedUserId = userId;

      lastResult = { userId, prizeLabel: BONUS_LABEL, prizeDisplay: CONFIG.PRIZE_DISPLAY_MAP[BONUS_LABEL], ts: spinAt };

      document.getElementById("prizeAmount").textContent = BONUS_LABEL;
      document.getElementById("modalUserId").textContent = userId;
      document.getElementById("modalTime").textContent = new Date(spinAt).toLocaleString("id-ID", {
        day: "2-digit", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });

      pushWinnerEntry({
        id: makeEntryId("user"),
        isUser: true,
        fullId: userId,
        displayId: userId,
        prizeKey: BONUS_LABEL,
        prize: CONFIG.PRIZE_DISPLAY_MAP[BONUS_LABEL],
        ts: spinAt,
        isNew: true
      });

      updateUI();
      celebrateWin();

      // remove spin pause while modal pause is already active (no flicker)
      resumeHistory("spin");

      // open modal (modal pause already active; openModal will keep it)
      openModal();

      isSpin = false;
    };

    if (reduceMotion) { onEnd(); return; }

    scheduleTicks(rotationDelta, segmentAngle, durationMs, localToken);

    wheel.style.setProperty("--from-rotation", currentRotation + "deg");
    wheel.style.setProperty("--rotation", totalRotation + "deg");
    wheel.classList.add("spinning");

    wheel.addEventListener("animationend", onEnd, { once: true });
    setTimeout(() => { if (localToken === spinToken) onEnd(); }, durationMs + 260);
  }

/* =========================================================
 * 18) DOWNLOAD + SHARE RESULT (PNG) ‚Äî FINAL (FULL REPLACE)
 * - Download PNG (tetap)
 * - Share PNG via Web Share API (sosmed mana pun)
 * - Fallback: share text/link -> copy image -> open tab
 * ======================================================= */

/* -------------------------
 * PUBLIC API
 * ------------------------- */
function downloadResultPng() {
  if (!lastResult) { showToast("Hasil belum tersedia. Silakan spin terlebih dahulu.", "error"); return; }
  try { kickAudio(true); } catch (_) {}

  const r = lastResult;
  const ts = r.ts || Date.now();

  makeRewardPngBlob(r, ts).then(({ blob, fileName }) => {
    const done = (blobOrDataUrl) => {
      try {
        if (blobOrDataUrl instanceof Blob) {
          const url = URL.createObjectURL(blobOrDataUrl);
          triggerDownload(url, fileName);
          setTimeout(() => URL.revokeObjectURL(url), 2500);
        } else if (typeof blobOrDataUrl === "string") {
          triggerDownload(blobOrDataUrl, fileName);
        }
        showToast("File hasil berhasil dibuat", "success");
      } catch (_) {
        showToast("Gagal mengunduh. File akan dibuka di tab baru.", "error");
        try {
          const url = (blobOrDataUrl instanceof Blob)
            ? URL.createObjectURL(blobOrDataUrl)
            : String(blobOrDataUrl || "");
          window.open(url, "_blank", "noopener,noreferrer");
        } catch (_) {}
      }
    };

    if (!blob) {
      // fallback ekstrem
      try {
        const dataUrl = blobToDataUrlFallback();
        done(dataUrl);
      } catch (_) {
        showToast("Gagal membuat gambar.", "error");
      }
      return;
    }

    done(blob);
  }).catch(() => {
    showToast("Gagal membuat gambar hasil.", "error");
  });
}

/* ‚úÖ Tambahan: Share via Web Share API */
async function shareResultPng() {
  if (!lastResult) { showToast("Hasil belum tersedia. Silakan spin terlebih dahulu.", "error"); return; }
  try { kickAudio(true); } catch (_) {}

  const r = lastResult;
  const ts = r.ts || Date.now();

  // teks share (biar enak ditempel di sosmed)
  const timeStr = new Date(ts).toLocaleString("id-ID", {
    day: "2-digit", month: "short", year: "numeric",
    hour: "2-digit", minute: "2-digit", second: "2-digit"
  });

  const safeUser = String(r.userId || "-");
  const prize = String(r.prizeLabel || "BONUS 10%");
  const shareTitle = "Hasil Spin ‚Äî MADETOTO2";
  const shareText =
    `üéâ ${shareTitle}\n` +
    `Hadiah: ${prize}\n` +
    `User ID: ${safeUser}\n` +
    `Waktu: ${timeStr}\n` +
    (CONFIG?.CLAIM_URL ? `Klaim: ${CONFIG.CLAIM_URL}` : "");

  // prefer: share FILE png
  let blob = null, fileName = null;
  try {
    const res = await makeRewardPngBlob(r, ts);
    blob = res.blob || null;
    fileName = res.fileName || buildFileName(r.userId, ts);
  } catch (_) {
    blob = null;
  }

  // 1) Web Share API + files (terbaik)
  if (blob && typeof navigator !== "undefined" && navigator.share) {
    try {
      const file = new File([blob], fileName || "MADETOTO2-REWARD.png", { type: "image/png", lastModified: ts });

      // canShare cek file support
      const canShareFiles = !!(navigator.canShare && navigator.canShare({ files: [file] }));

      if (canShareFiles) {
        await navigator.share({ title: shareTitle, text: shareText, files: [file] });
        showToast("Menu bagikan dibuka", "success");
        return;
      }

      // kalau share ada tapi files tidak didukung, lanjut share text/link
      await navigator.share({ title: shareTitle, text: shareText });
      showToast("Menu bagikan dibuka", "success");
      return;
    } catch (err) {
      // AbortError = user cancel (bukan error fatal)
      if (err && (err.name === "AbortError" || err.message?.includes("AbortError"))) {
        showToast("Bagikan dibatalkan", "error");
        return;
      }
      // jatuh ke fallback di bawah
    }
  }

  // 2) Web Share API text-only (kalau ada)
  if (typeof navigator !== "undefined" && navigator.share) {
    try {
      await navigator.share({ title: shareTitle, text: shareText });
      showToast("Menu bagikan dibuka", "success");
      return;
    } catch (err) {
      if (err && (err.name === "AbortError" || err.message?.includes("AbortError"))) {
        showToast("Bagikan dibatalkan", "error");
        return;
      }
    }
  }

  // 3) Copy image ke clipboard (kalau support) ‚Äî lalu user tinggal paste di sosmed
  if (blob && typeof navigator !== "undefined" && navigator.clipboard && typeof window !== "undefined" && window.ClipboardItem) {
    try {
      await navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]);
      showToast("Gambar disalin. Tinggal paste ke sosmed.", "success");

      // bonus: copy teks juga (kalau bisa)
      try { await navigator.clipboard.writeText(shareText); } catch (_) {}
      return;
    } catch (_) {
      // lanjut fallback
    }
  }

  // 4) Copy text (paling kompatibel)
  if (typeof navigator !== "undefined" && navigator.clipboard && navigator.clipboard.writeText) {
    try {
      await navigator.clipboard.writeText(shareText);
      showToast("Teks hasil disalin. Tinggal paste ke sosmed.", "success");
      return;
    } catch (_) {}
  }

  // 5) Fallback terakhir: buka gambar di tab baru
  if (blob) {
    try {
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank", "noopener,noreferrer");
      setTimeout(() => URL.revokeObjectURL(url), 5000);
      showToast("Gambar dibuka di tab baru untuk dibagikan.", "success");
      return;
    } catch (_) {}
  }

  showToast("Browser tidak mendukung fitur bagikan.", "error");
}

/* -------------------------
 * SAFE BIND (anti double bind)
 * ------------------------- */
(function bindDownloadShareButtonsOnce() {
  try {
    const dBtn = document.getElementById("downloadBtn");
    if (dBtn && !dBtn.dataset.boundDownload) {
      dBtn.dataset.boundDownload = "1";
      dBtn.addEventListener("click", downloadResultPng, { passive: true });
    }

    const sBtn = document.getElementById("shareBtn");
    if (sBtn && !sBtn.dataset.boundShare) {
      sBtn.dataset.boundShare = "1";
      sBtn.addEventListener("click", () => { shareResultPng(); }, { passive: true });
    }
  } catch (_) {}
})();

/* -------------------------
 * CORE: generate PNG blob (shared by download/share)
 * ------------------------- */
function makeRewardPngBlob(r, ts) {
  return new Promise((resolve, reject) => {
    try {
      const t = r || {};
      const stamp = ts || Date.now();

      // --- DPI
      const dpr = Math.min(2, window.devicePixelRatio || 1);

      // --- Measure layout first (so canvas height can be minimal)
      const lay = calcRewardPngLayout(t, stamp);

      const canvas = document.createElement("canvas");
      canvas.width = Math.floor(lay.baseW * dpr);
      canvas.height = Math.floor(lay.baseH * dpr);

      const ctx = canvas.getContext("2d");
      if (!ctx) { reject(new Error("no_ctx")); return; }
      ctx.scale(dpr, dpr);

      // --- Background
      const g = ctx.createLinearGradient(0, 0, lay.baseW, lay.baseH);
      g.addColorStop(0, "#06130f");
      g.addColorStop(0.55, "#071e16");
      g.addColorStop(1, "#05281d");
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, lay.baseW, lay.baseH);

      // Orbs (adapt to height)
      drawOrb(ctx, 260, 220, 260, "rgba(34,197,94,0.14)");
      drawOrb(ctx, lay.baseW - 220, 320, 220, "rgba(255,255,255,0.07)");
      drawOrb(ctx, lay.baseW - 260, lay.baseH - 260, 300, "rgba(20,184,166,0.10)");

      // --- Card
      roundRect(ctx, lay.cardX, lay.cardY, lay.cardW, lay.cardH, 34);

      const cg = ctx.createLinearGradient(lay.cardX, lay.cardY, lay.cardX + lay.cardW, lay.cardY + lay.cardH);
      cg.addColorStop(0, "rgba(6,18,14,0.95)");
      cg.addColorStop(1, "rgba(7,30,22,0.95)");
      ctx.fillStyle = cg;
      ctx.fill();

      ctx.lineWidth = 4;
      ctx.strokeStyle = "rgba(34,197,94,0.55)";
      ctx.stroke();

      // --- Header
      ctx.fillStyle = "rgba(255,255,255,0.95)";
      ctx.font = "900 44px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("MADETOTO2", lay.innerX, lay.brandY);

      ctx.fillStyle = "rgba(255,255,255,0.78)";
      ctx.font = "700 24px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("HASIL SPIN REWARD", lay.innerX, lay.subY);

      // --- Prize (AKURAT: height dihitung pakai fontSize, bukan lineH doang)
      ctx.fillStyle = "#bbf7d0";
      ctx.font = `1000 ${lay.prize.fontSize}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;

      // Shadow halus biar premium
      ctx.save();
      ctx.shadowColor = "rgba(0,0,0,0.28)";
      ctx.shadowBlur = 18;
      ctx.shadowOffsetY = 10;

      for (let i = 0; i < lay.prize.lines.length; i++) {
        ctx.fillText(lay.prize.lines[i], lay.innerX, lay.prizeStartY + i * lay.prize.lineH);
      }
      ctx.restore();

      // Divider
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(lay.innerX, lay.dividerY);
      ctx.lineTo(lay.innerX + lay.innerW, lay.dividerY);
      ctx.stroke();

      // --- Labels
      ctx.fillStyle = "rgba(255,255,255,0.70)";
      ctx.font = "800 22px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace";
      ctx.fillText("USER ID", lay.innerX, lay.userLabelY);
      ctx.fillText("WAKTU", lay.innerX, lay.timeLabelY);

      ctx.fillStyle = "rgba(255,255,255,0.96)";
      ctx.font = "900 32px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace";
      ctx.fillText(String(t.userId || "-"), lay.innerX, lay.userValueY);

      const timeStr = new Date(stamp).toLocaleString("id-ID", {
        day: "2-digit", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });
      ctx.fillText(timeStr, lay.innerX, lay.timeValueY);

      // --- Note box (auto height)
      roundRect(ctx, lay.noteX, lay.noteY, lay.noteW, lay.noteH, 22);
      ctx.fillStyle = "rgba(0,0,0,0.30)";
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,0.88)";
      ctx.font = "800 22px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      for (let i = 0; i < lay.noteLines.length; i++) {
        ctx.fillText(lay.noteLines[i], lay.noteTextX, lay.noteTextY + i * lay.noteLineH);
      }

      // --- Footer
      ctx.fillStyle = "rgba(255,255,255,0.55)";
      ctx.font = "700 18px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Spin & Win ‚Ä¢ MADETOTO2", lay.innerX, lay.footerY);

      const fileName = buildFileName(t.userId, stamp);

      // blob
      if (canvas.toBlob) {
        canvas.toBlob((blob) => {
          if (!blob) {
            // fallback to dataURL -> blob
            try {
              const b2 = dataUrlToBlob(canvas.toDataURL("image/png"));
              resolve({ blob: b2, fileName });
            } catch (_) {
              resolve({ blob: null, fileName, dataUrl: canvas.toDataURL("image/png") });
            }
            return;
          }
          resolve({ blob, fileName });
        }, "image/png", 0.92);
      } else {
        const dataUrl = canvas.toDataURL("image/png");
        try {
          const blob = dataUrlToBlob(dataUrl);
          resolve({ blob, fileName });
        } catch (_) {
          resolve({ blob: null, fileName, dataUrl });
        }
      }
    } catch (e) {
      reject(e);
    }
  });
}

function dataUrlToBlob(dataUrl) {
  const parts = String(dataUrl || "").split(",");
  const meta = parts[0] || "";
  const b64 = parts[1] || "";
  const mime = (meta.match(/data:([^;]+)/i) || [])[1] || "image/png";
  const bin = atob(b64);
  const len = bin.length;
  const arr = new Uint8Array(len);
  for (let i = 0; i < len; i++) arr[i] = bin.charCodeAt(i);
  return new Blob([arr], { type: mime });
}

function blobToDataUrlFallback() {
  // fallback stub (rarely used)
  return "";
}

/* -------------------------
 * Download helpers (unchanged behavior)
 * ------------------------- */
function triggerDownload(url, filename) {
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.rel = "noopener";
  a.target = "_blank";
  document.body.appendChild(a);
  a.click();
  a.remove();

  setTimeout(() => {
    try {
      if (/iPhone|iPad|iPod/i.test(navigator.userAgent || "")) {
        window.open(url, "_blank", "noopener,noreferrer");
      }
    } catch (_) {}
  }, 120);
}

function buildFileName(userId, ts) {
  const d = new Date(ts || Date.now());
  const y = d.getFullYear();
  const m = pad2(d.getMonth() + 1);
  const da = pad2(d.getDate());
  const hh = pad2(d.getHours());
  const mm = pad2(d.getMinutes());

  const safeId = String(userId || "USER").replace(/[^A-Z0-9_-]/gi, "").slice(0, 18) || "USER";
  return `MADETOTO2-REWARD-${safeId}-${y}${m}${da}-${hh}${mm}.png`;
}

function drawOrb(ctx, x, y, r, color) {
  const g = ctx.createRadialGradient(x, y, 0, x, y, r);
  g.addColorStop(0, color);
  g.addColorStop(1, "rgba(0,0,0,0)");
  ctx.fillStyle = g;
  ctx.beginPath();
  ctx.arc(x, y, r, 0, Math.PI * 2);
  ctx.fill();
}

function roundRect(ctx, x, y, w, h, r) {
  const rr = Math.min(r, w / 2, h / 2);
  ctx.beginPath();
  ctx.moveTo(x + rr, y);
  ctx.arcTo(x + w, y, x + w, y + h, rr);
  ctx.arcTo(x + w, y + h, x, y + h, rr);
  ctx.arcTo(x, y + h, x, y, rr);
  ctx.arcTo(x, y, x + w, y, rr);
  ctx.closePath();
}

/* -------------------------
 * LAYOUT (MEASURE) ‚Äî FIX AKURAT (as-is)
 * ------------------------- */
function calcRewardPngLayout(r, ts) {
  const baseW = 1080;

  // card geometry
  const pad = 66;
  const cardX = pad;
  const cardY = 120;
  const cardW = baseW - pad * 2;

  const innerX = cardX + 44;
  const innerW = cardW - 88;

  // header
  const brandY = cardY + 90;
  const subY = cardY + 140;

  // prize
  const prizeStartY = cardY + 255; // baseline
  const prizeText = String(r.prizeLabel || "BONUS 10%");

  const mctx = getMeasureCtx();
  if (!mctx) {
    // fallback layout kalau ctx measure gagal (sangat jarang)
    const prize = { fontSize: 72, lineH: 64, lines: [prizeText] };
    const dividerY = prizeStartY + 120;
    const userLabelY = dividerY + 70;
    const userValueY = userLabelY + 42;
    const timeLabelY = userValueY + 64;
    const timeValueY = timeLabelY + 40;
    const noteY = timeValueY + 56;
    const noteX = innerX;
    const noteW = innerW;
    const noteTextX = noteX + 26;
    const noteTextY = noteY + 44;
    const noteLineH = 28;
    const noteLines = ["Silakan klaim melalui Live Chat", "dan sertakan USER ID + hasil unduh ini."];
    const noteH = 110;
    const footerY = noteY + noteH + 58;
    const cardH = (footerY + 40) - cardY;
    const baseH = cardY + cardH + 110;

    return {
      baseW, baseH,
      cardX, cardY, cardW, cardH,
      innerX, innerW,
      brandY, subY,
      prizeStartY, prize,
      dividerY,
      userLabelY, userValueY,
      timeLabelY, timeValueY,
      noteX, noteY, noteW, noteH,
      noteLines, noteLineH, noteTextX, noteTextY,
      footerY
    };
  }

  const prize = layoutAdaptiveHeadline(mctx, prizeText, innerW, {
    maxFont: 86,
    minFont: 56,
    weight: 1000,
    family: "system-ui, -apple-system, Segoe UI, Roboto, Arial",
    lineHScale: 0.90,
    maxLines: 2
  });

  // ‚úÖ FIX AKURAT: height dihitung dari fontSize, bukan lineH doang
  const prizeBlockH = Math.ceil((prize.lines.length - 1) * prize.lineH + prize.fontSize * 1.12);
  const prizeBottom = prizeStartY + prizeBlockH;

  // divider lebih rapet
  const dividerY = Math.ceil(prizeBottom + 14);

  // info section
  const userLabelY = dividerY + 70;
  const userValueY = userLabelY + 42;

  const timeLabelY = userValueY + 64;
  const timeValueY = timeLabelY + 40;

  // note box (auto-height)
  const noteY = Math.ceil(timeValueY + 56);
  const noteX = innerX;
  const noteW = innerW;

  const noteText = "Silakan klaim melalui Live Chat dan sertakan USER ID + hasil unduh ini.";
  const noteFont = "800 22px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const noteLineH = 28;

  mctx.font = noteFont;
  const noteInnerPadX = 26;
  const noteInnerPadY = 22;
  const noteMaxW = noteW - noteInnerPadX * 2;

  const noteLines = wrapLinesByWords(mctx, noteText, noteMaxW, 3);
  const noteH = Math.max(68, noteInnerPadY * 2 + noteLines.length * noteLineH + 2);

  const noteTextX = noteX + noteInnerPadX;
  const noteTextY = noteY + noteInnerPadY + 22;

  // footer + total card height (AUTO)
  const footerY = Math.ceil(noteY + noteH + 58);

  const cardH = Math.ceil((footerY + 40) - cardY);
  const baseH = Math.ceil(cardY + cardH + 110);

  return {
    baseW, baseH,
    cardX, cardY, cardW, cardH,
    innerX, innerW,
    brandY, subY,
    prizeStartY, prize,
    dividerY,
    userLabelY, userValueY,
    timeLabelY, timeValueY,
    noteX, noteY, noteW, noteH,
    noteLines, noteLineH, noteTextX, noteTextY,
    footerY
  };
}

function getMeasureCtx() {
  const c = document.createElement("canvas");
  c.width = 32;
  c.height = 32;
  return c.getContext("2d");
}

function layoutAdaptiveHeadline(ctx, text, maxWidth, opt) {
  const t = String(text || "").trim();
  const maxFont = opt.maxFont || 86;
  const minFont = opt.minFont || 56;
  const weight = opt.weight || 1000;
  const family = opt.family || "system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const maxLines = opt.maxLines || 2;
  const lineHScale = opt.lineHScale || 0.92;

  let fontSize = maxFont;
  let lines = [t];

  while (fontSize >= minFont) {
    ctx.font = `${weight} ${fontSize}px ${family}`;
    lines = wrapLinesByWords(ctx, t, maxWidth, maxLines);
    if (lines.length <= maxLines) break;
    fontSize -= 2;
  }

  const lineH = Math.ceil(fontSize * lineHScale);
  return { fontSize, lineH, lines };
}

function wrapLinesByWords(ctx, text, maxWidth, maxLines) {
  const words = String(text || "").split(/\s+/).filter(Boolean);
  const lines = [];
  let line = "";

  for (let i = 0; i < words.length; i++) {
    const test = line ? (line + " " + words[i]) : words[i];
    const w = ctx.measureText(test).width;

    if (w <= maxWidth) { line = test; continue; }

    if (line) lines.push(line);
    line = words[i];

    if (lines.length === (maxLines - 1)) break;
  }

  if (line) lines.push(line);

  if (lines.length === maxLines) {
    const lastIdx = maxLines - 1;
    lines[lastIdx] = fitTextWithEllipsis(ctx, lines[lastIdx], maxWidth);
  }

  return lines;
}

function fitTextWithEllipsis(ctx, text, maxWidth) {
  const ell = "‚Ä¶";
  if (ctx.measureText(text).width <= maxWidth) return text;

  let t = String(text || "");
  while (t.length > 1 && ctx.measureText(t + ell).width > maxWidth) {
    t = t.slice(0, -1);
  }
  return t.trim() + ell;
}

  /* =========================================================
   * 19) CLAIM (loading overlay) + watchdog
   * ======================================================= */
  let claimInFlight = false;
  let claimWatchdogT = 0;

  function isNavOpen() {
    const el = document.getElementById("navLoading");
    return !!(el && el.classList.contains("show"));
  }

  function showNavLoading() {
    const el = document.getElementById("navLoading");
    if (!el) return;

    pauseHistory("nav");
    setInert("nav", true);

    el.classList.add("show");
    el.setAttribute("aria-hidden", "false");

    document.body.classList.add("modal-open");
  }

  function hideNavLoading(immediate = false) {
    const el = document.getElementById("navLoading");
    if (!el) return;

    const done = () => {
      el.classList.remove("show");
      el.setAttribute("aria-hidden", "true");

      claimInFlight = false;

      resumeHistory("nav");
      setInert("nav", false);

      if (!isModalOpen()) document.body.classList.remove("modal-open");
    };

    if (claimWatchdogT) { clearTimeout(claimWatchdogT); claimWatchdogT = 0; }

    if (immediate || isReducedMotion()) { done(); return; }

    el.classList.remove("show");
    el.setAttribute("aria-hidden", "true");
    setTimeout(done, 260);
  }

  function claimPrize() {
    if (claimInFlight) return;
    claimInFlight = true;

    closeModal();
    showNavLoading();

    const start = (performance.now ? performance.now() : Date.now());
    const minHold = isReducedMotion() ? 0 : CONFIG.CLAIM_OVERLAY_MIN_MS;

    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        const now = (performance.now ? performance.now() : Date.now());
        const elapsed = now - start;
        const wait = Math.max(0, minHold - elapsed);

        setTimeout(() => {
          // watchdog: if still here after 10s, unlock
          claimWatchdogT = setTimeout(() => {
            if (isNavOpen() && !document.hidden) {
              hideNavLoading(true);
              showToast("Gagal membuka halaman klaim. Coba tekan KLAIM lagi.", "error", 2600);
            }
          }, 10000);

          try { window.location.href = CONFIG.CLAIM_URL; } catch (_) {
            hideNavLoading(true);
            showToast("Tidak bisa membuka halaman klaim.", "error", 2400);
          }
        }, wait);
      });
    });
  }

  /* =========================================================
   * 20) CELEBRATE
   * ======================================================= */
  function celebrateWin() {
    if (isReducedMotion()) return;

    const duration = 2200;
    const end = Date.now() + duration;

    const frame = () => {
      try {
        confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
        confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
      } catch (_) {}

      if (Date.now() < end) requestAnimationFrame(frame);
    };

    frame();
  }

  /* =========================================================
   * 21) Persist user entry + rotation consistency
   * ======================================================= */
  function bootPersistedUserEntry() {
    if (hasSpun && !spinAt) { spinAt = Date.now(); lsSet(LS.SPIN_AT, String(spinAt)); }

    if (hasSpun && savedUserId) {
      lastResult = {
        userId: savedUserId,
        prizeLabel: BONUS_LABEL,
        prizeDisplay: CONFIG.PRIZE_DISPLAY_MAP[BONUS_LABEL],
        ts: (spinAt || Date.now())
      };

      // ensure user entry exists only once
      const already = winners.some((w) => w.isUser === true);
      if (!already) {
        pushWinnerEntry({
          id: makeEntryId("user"),
          isUser: true,
          fullId: savedUserId,
          displayId: savedUserId,
          prizeKey: BONUS_LABEL,
          prize: CONFIG.PRIZE_DISPLAY_MAP[BONUS_LABEL],
          ts: (spinAt || Date.now()),
          isNew: false
        });
      }
    }

    // keep modal pause clean if not actually open
    if (!isModalOpen()) {
      pauseReasons.delete("modal");
    }
  }
</script>
</body>
</html>
