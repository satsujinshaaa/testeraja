<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0a0c18" />
  <meta name="color-scheme" content="dark" />
  <title>NEON SLOT â€” Arcade</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;800&family=Inter:wght@500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg0:#070814;
      --bg1:#0a0c18;

      --text:#eaf0ff;
      --muted:#a9b3d6;

      --neon1:#7c4dff;
      --neon2:#26d7ff;
      --neon3:#ff2bd6;
      --gold:#ffd88a;

      --radius:22px;
      --radius2:28px;

      --ease:cubic-bezier(.2,.9,.18,1);
      --ease2:cubic-bezier(.22,.85,.2,1);

      --maxW:980px;
      --cell:clamp(74px, 10.2vw, 96px);
      --gap:clamp(14px, 3.4vw, 22px);

      --flashDur:4s; /* 3s kedip cepat + 1s turun perlahan */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(124,77,255,.25), transparent 60%),
        radial-gradient(820px 560px at 85% 20%, rgba(38,215,255,.18), transparent 62%),
        radial-gradient(900px 650px at 50% 105%, rgba(255,43,214,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 55%, #060713);
      overflow-x:hidden;
    }

    .wrap{
      min-height:100%;
      display:grid;
      place-items:center;
      padding:clamp(14px, 3.5vw, 26px);
      padding-bottom:calc(clamp(14px, 3.5vw, 26px) + env(safe-area-inset-bottom));
    }
    @media (max-height: 720px){
      .wrap{ place-items:start center; }
    }

    .app{
      width:min(var(--maxW), 100%);
      border-radius:var(--radius2);
      background:linear-gradient(180deg, rgba(13,16,36,.72), rgba(9,10,22,.62));
      border:1px solid rgba(255,255,255,.10);
      box-shadow:
        0 20px 60px rgba(0,0,0,.45),
        inset 0 1px 0 rgba(255,255,255,.10);
      overflow:hidden;
      position:relative;
      isolation:isolate;
    }
    .app::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(1200px 380px at 50% 0%, rgba(124,77,255,.18), transparent 58%),
        radial-gradient(900px 340px at 10% 30%, rgba(38,215,255,.10), transparent 58%),
        radial-gradient(900px 340px at 90% 30%, rgba(255,43,214,.09), transparent 58%);
      pointer-events:none;
      z-index:0;
    }

    .top{
      position:relative; z-index:1;
      display:flex; gap:14px;
      align-items:center; justify-content:space-between;
      padding:clamp(16px, 3.6vw, 22px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .brand{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .title{
      font-family:Orbitron, Inter, system-ui;
      letter-spacing:.9px;
      font-weight:800;
      font-size:clamp(16px, 3.2vw, 22px);
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .topRight{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .txtBtn{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      padding:12px 14px;
      color:rgba(234,240,255,.95);
      font-weight:900;
      letter-spacing:.7px;
      cursor:pointer;
      transition:transform .15s var(--ease), border-color .2s var(--ease), filter .2s var(--ease);
      touch-action:manipulation;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.10);
      text-transform:uppercase;
      font-family:Orbitron, Inter, system-ui;
      font-size:12px;
      white-space:nowrap;
    }
    .txtBtn:active{ transform:translateY(1px) scale(.99); }
    .txtBtn:hover{ border-color:rgba(255,255,255,.22); }

    :focus-visible{
      outline:2px solid rgba(38,215,255,.55);
      outline-offset:2px;
      border-radius:14px;
    }

    .main{
      position:relative; z-index:1;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:var(--gap);
      padding:clamp(16px, 3.6vw, 22px);
    }
    @media (max-width: 860px){
      .main{ grid-template-columns:1fr; }
    }

    .slotCard{
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(12,14,28,.72), rgba(10,12,24,.62));
      border:1px solid rgba(255,255,255,.10);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.08),
        0 18px 45px rgba(0,0,0,.25);
      overflow:hidden;
      position:relative;
      isolation:isolate;
    }

    /* ===== CELEBRATION FLASH ===== */
    .slotCard.flash{
      border-color:rgba(255,216,138,.38);
      box-shadow:
        0 0 0 1px rgba(255,216,138,.14),
        0 0 44px rgba(255,216,138,.22),
        0 0 110px rgba(38,215,255,.10),
        0 18px 65px rgba(0,0,0,.40),
        inset 0 1px 0 rgba(255,255,255,.12);
    }
    .slotCard.flash::before{
      content:"";
      position:absolute; inset:-2px;
      pointer-events:none;
      z-index:0;
      background:
        conic-gradient(from 30deg,
          rgba(255,216,138,.00) 0%,
          rgba(255,216,138,.20) 12%,
          rgba(38,215,255,.14) 22%,
          rgba(255,43,214,.12) 34%,
          rgba(255,216,138,.22) 52%,
          rgba(38,215,255,.12) 70%,
          rgba(255,216,138,.00) 100%);
      opacity:0;
      filter:saturate(1.25);
      animation:flashFlicker var(--flashDur) var(--ease) both;
    }
    .slotCard.flash::after{
      content:"";
      position:absolute; inset:-2px;
      pointer-events:none;
      z-index:0;
      background:
        radial-gradient(980px 360px at 50% 12%, rgba(255,216,138,.30), transparent 62%),
        radial-gradient(860px 360px at 12% 65%, rgba(38,215,255,.16), transparent 66%),
        radial-gradient(860px 360px at 88% 65%, rgba(255,43,214,.14), transparent 66%),
        repeating-linear-gradient(90deg, rgba(255,216,138,.00) 0 10px, rgba(255,216,138,.10) 10px 12px, rgba(255,216,138,.00) 12px 22px);
      opacity:0;
      transform:translate3d(0,-10px,0) scale(.99);
      filter: blur(10px) saturate(1.18);
      animation:flashDown var(--flashDur) var(--ease) both;
    }

    @keyframes flashFlicker{
      0%   {opacity:0; }
      5%   {opacity:.85;}
      10%  {opacity:.22;}
      14%  {opacity:.95;}
      18%  {opacity:.18;}
      22%  {opacity:.92;}
      26%  {opacity:.20;}
      30%  {opacity:.90;}
      34%  {opacity:.16;}
      38%  {opacity:.88;}
      42%  {opacity:.22;}
      46%  {opacity:.84;}
      50%  {opacity:.18;}
      54%  {opacity:.86;}
      58%  {opacity:.22;}
      62%  {opacity:.82;}
      66%  {opacity:.16;}
      70%  {opacity:.78;}
      75%  {opacity:.70;}
      100% {opacity:0;}
    }

    @keyframes flashDown{
      0%   {opacity:0;   transform:translate3d(0,-10px,0) scale(.99);}
      5%   {opacity:1;   transform:translate3d(0,-6px,0)  scale(1);}
      10%  {opacity:.22; transform:translate3d(0,-6px,0)  scale(1);}
      14%  {opacity:1;   transform:translate3d(0,-4px,0)  scale(1);}
      18%  {opacity:.18; transform:translate3d(0,-4px,0)  scale(1);}
      22%  {opacity:1;   transform:translate3d(0,-2px,0)  scale(1);}
      26%  {opacity:.20; transform:translate3d(0,-2px,0)  scale(1);}
      30%  {opacity:1;   transform:translate3d(0,0,0)     scale(1);}
      34%  {opacity:.18; transform:translate3d(0,0,0)     scale(1);}
      38%  {opacity:1;   transform:translate3d(0,1px,0)   scale(1);}
      42%  {opacity:.22; transform:translate3d(0,1px,0)   scale(1);}
      46%  {opacity:1;   transform:translate3d(0,0,0)     scale(1);}
      50%  {opacity:.18; transform:translate3d(0,0,0)     scale(1);}
      54%  {opacity:1;   transform:translate3d(0,2px,0)   scale(1.005);}
      58%  {opacity:.22; transform:translate3d(0,2px,0)   scale(1.005);}
      62%  {opacity:1;   transform:translate3d(0,0,0)     scale(1.008);}
      66%  {opacity:.18; transform:translate3d(0,0,0)     scale(1.008);}
      70%  {opacity:1;   transform:translate3d(0,1px,0)   scale(1.01);}
      75%  {opacity:1;   transform:translate3d(0,0,0)     scale(1.01);}
      100% {opacity:0;   transform:translate3d(0,18px,0)  scale(1.015);}
    }

    .slotHeader{
      position:relative;
      z-index:1;
      display:grid;
      place-items:center;
      padding:16px 16px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      gap:6px;
      text-align:center;
    }
    .slotHeader .hL{ display:grid; gap:4px; }
    .slotHeader .hT{ font-weight:900; letter-spacing:.3px; font-size:13px; color:rgba(234,240,255,.92); text-transform:uppercase; }
    .slotHeader .hS{ font-size:12px; color:rgba(234,240,255,.66); }

    .machine{ padding:16px; position:relative; z-index:1; }

    .reels{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:14px;
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 240px at 50% 0%, rgba(124,77,255,.12), transparent 60%),
        radial-gradient(800px 260px at 50% 110%, rgba(38,215,255,.08), transparent 60%),
        rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
      transform:translate3d(0,0,0);
      isolation:isolate;
    }
    .reels::before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:linear-gradient(180deg, rgba(0,0,0,.55), transparent 22%, transparent 78%, rgba(0,0,0,.55));
      opacity:.92;
    }
    .reels.stopping{
      border-color:rgba(38,215,255,.22);
      box-shadow:
        0 0 0 1px rgba(38,215,255,.10),
        0 0 28px rgba(38,215,255,.10),
        inset 0 1px 0 rgba(255,255,255,.08);
    }
    .reels.flash{
      border-color:rgba(255,216,138,.34);
      box-shadow:
        0 0 0 1px rgba(255,216,138,.14),
        0 0 44px rgba(255,216,138,.14),
        inset 0 1px 0 rgba(255,255,255,.10);
    }
    .reels.flash::after{
      content:"";
      position:absolute; inset:-2px;
      pointer-events:none;
      z-index:2;
      background:
        radial-gradient(820px 220px at 50% 50%, rgba(255,216,138,.14), transparent 62%),
        repeating-linear-gradient(90deg, rgba(255,216,138,.00) 0 10px, rgba(255,216,138,.10) 10px 12px, rgba(255,216,138,.00) 12px 22px);
      opacity:0;
      transform:translate3d(0,-10px,0);
      animation:flashDown var(--flashDur) var(--ease) both;
      filter: blur(7px) saturate(1.1);
    }

    .reel{
      position:relative;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      overflow:hidden;
      height:calc(var(--cell) * 3);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
      contain:content;
      transform:translate3d(0,0,0);
      backface-visibility:hidden;
    }
    .reel::before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:linear-gradient(180deg, rgba(255,255,255,.06), transparent 18%, transparent 82%, rgba(255,255,255,.05));
      opacity:.9;
      z-index:1;
    }
    .reel.spinning::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      z-index:2;
      opacity:.85;
      background:
        radial-gradient(120px 200px at 50% 50%, rgba(38,215,255,.10), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.06), transparent 22%, transparent 78%, rgba(255,255,255,.05));
      mix-blend-mode:screen;
    }

    .reel.kick{ animation:reelKick .22s var(--ease); }
    @keyframes reelKick{
      0%{ transform:translate3d(0,0,0) scale(1); }
      45%{ transform:translate3d(0,1px,0) scale(.995); }
      100%{ transform:translate3d(0,0,0) scale(1); }
    }

    .strip{
      position:absolute;
      left:0; right:0;
      top:0;
      will-change:transform;
      transform:translate3d(0,0,0);
      backface-visibility:hidden;
      z-index:0;
    }
    .symbol{
      height:var(--cell);
      display:grid;
      place-items:center;
      user-select:none;
    }
    .symBox{
      width:calc(var(--cell) * .84);
      height:calc(var(--cell) * .84);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(120px 120px at 30% 25%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.10),
        0 10px 22px rgba(0,0,0,.22);
      display:grid;
      place-items:center;
      transform:translate3d(0,0,0);
    }
    .symBox svg{
      width:70%;
      height:70%;
      display:block;
      shape-rendering:geometricPrecision;
    }
    .symbol.isMid .symBox{
      outline:1px solid rgba(255,255,255,.08);
      outline-offset:2px;
    }
    .reel.win .symbol.isMid .symBox{
      border-color:rgba(255,216,138,.62);
      box-shadow:
        0 0 0 1px rgba(255,216,138,.28),
        0 0 34px rgba(255,216,138,.18),
        inset 0 1px 0 rgba(255,255,255,.14);
      transform:translate3d(0,0,0) scale(1.03);
    }

    /* INPUTS */
    .fields{
      margin-top:14px;
      display:grid;
      gap:10px;
    }
    .field{
      display:grid;
      gap:7px;
    }
    .field .lbl{
      font-size:12px;
      color:rgba(234,240,255,.72);
      font-weight:900;
      letter-spacing:.55px;
      text-transform:uppercase;
      user-select:none;
      text-align:center;
    }
    .field input{
      width:100%;
      padding:13px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:rgba(234,240,255,.95);
      outline:none;
      font-weight:700;
      letter-spacing:.2px;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.08),
        0 10px 24px rgba(0,0,0,.18);
      transition:transform .15s var(--ease), border-color .2s var(--ease), background .2s var(--ease), box-shadow .2s var(--ease);
      text-align:center;
    }
    .field input::placeholder{
      color:rgba(234,240,255,.50);
      font-weight:650;
      text-align:center;
    }
    .field input:focus{
      border-color:rgba(38,215,255,.35);
      background:rgba(255,255,255,.06);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.08),
        0 0 0 3px rgba(38,215,255,.10),
        0 10px 26px rgba(0,0,0,.22);
    }
    .field.err input{
      border-color:rgba(255,43,214,.42);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.06),
        0 0 0 3px rgba(255,43,214,.12),
        0 10px 26px rgba(0,0,0,.22);
      animation:shake .22s var(--ease) 0s 2;
    }
    @keyframes shake{
      0%{ transform:translateX(0); }
      35%{ transform:translateX(-2px); }
      70%{ transform:translateX(2px); }
      100%{ transform:translateX(0); }
    }

    .controls{
      margin-top:12px;
      display:flex;
      align-items:stretch;
    }
    .btn{
      width:100%;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(124,77,255,.22), rgba(38,215,255,.14));
      color:rgba(234,240,255,.96);
      font-weight:900;
      letter-spacing:.9px;
      padding:14px 16px;
      cursor:pointer;
      transition:transform .15s var(--ease), filter .2s var(--ease), border-color .2s var(--ease);
      box-shadow:
        0 16px 34px rgba(0,0,0,.30),
        inset 0 1px 0 rgba(255,255,255,.14);
      touch-action:manipulation;
      text-transform:uppercase;
      font-family:Orbitron, Inter, system-ui;
    }
    .btn:active{ transform:translateY(1px) scale(.995); }
    .btn:disabled{ cursor:not-allowed; filter:saturate(.8) brightness(.92); opacity:.82; }

    /* SIDE */
    .side{
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(12,14,28,.72), rgba(10,12,24,.62));
      border:1px solid rgba(255,255,255,.10);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.08),
        0 18px 45px rgba(0,0,0,.20);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:240px;
    }
    .sideHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sideHead .t{
      font-weight:900;
      letter-spacing:.2px;
      font-size:13px;
      color:rgba(234,240,255,.92);
      text-transform:uppercase;
    }

    .pillBtn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:rgba(234,240,255,.92);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.08);
      border-radius:999px;
      padding:10px 12px;
      font-size:12.5px;
      font-weight:800;
      letter-spacing:.2px;
      cursor:pointer;
      transition:transform .15s var(--ease), border-color .2s var(--ease), filter .2s var(--ease);
      touch-action:manipulation;
      white-space:nowrap;
      text-transform:uppercase;
      font-family:Orbitron, Inter, system-ui;
    }
    .pillBtn:hover{ border-color:rgba(255,255,255,.22); }
    .pillBtn:active{ transform:translateY(1px) scale(.995); }

    .prizeWrap{
      padding:16px;
      display:grid;
      gap:14px;
    }
    .prizeCard{
      border-radius:20px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 260px at 50% 0%, rgba(124,77,255,.10), transparent 62%),
        radial-gradient(820px 260px at 50% 110%, rgba(38,215,255,.08), transparent 62%),
        rgba(0,0,0,.14);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
      padding:14px;
      display:grid;
      justify-items:center;
      text-align:center;
      gap:10px;
    }
    .prizeIcon{
      width:74px; height:74px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(120px 120px at 30% 25%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.10),
        0 12px 26px rgba(0,0,0,.22);
      display:grid;
      place-items:center;
    }
    .prizeIcon svg{ width:64%; height:64%; display:block; }
    .prizeTitle{
      font-family:Orbitron, Inter, system-ui;
      font-weight:900;
      letter-spacing:.7px;
      font-size:18px;
      color:rgba(234,240,255,.95);
      text-transform:uppercase;
    }
    .prizeSub{
      font-size:12.5px;
      color:rgba(234,240,255,.72);
      line-height:1.4;
    }

    .prizeActions{
      width:100%;
      display:flex;
      gap:10px;
      margin-top:4px;
    }
    .aBtn{
      flex:1;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(234,240,255,.95);
      font-weight:900;
      letter-spacing:.5px;
      padding:12px 10px;
      cursor:pointer;
      transition:transform .15s var(--ease), border-color .2s var(--ease), filter .2s var(--ease);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.10),
        0 12px 26px rgba(0,0,0,.22);
      text-transform:uppercase;
      font-family:Orbitron, Inter, system-ui;
      font-size:12px;
      touch-action:manipulation;
      white-space:nowrap;
    }
    .aBtn.primary{
      background:linear-gradient(180deg, rgba(255,216,138,.22), rgba(255,43,214,.12));
      border-color:rgba(255,216,138,.22);
    }
    .aBtn:active{ transform:translateY(1px) scale(.995); }
    .aBtn:disabled{
      cursor:not-allowed;
      opacity:.58;
      filter:saturate(.85) brightness(.95);
    }

    /* ARTI SIMBOL */
    .legendCard{
      border-radius:20px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.12);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
      overflow:hidden;
    }
    .legendHead{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .legendT{
      font-family:Orbitron, Inter, system-ui;
      font-weight:900;
      letter-spacing:.6px;
      font-size:12px;
      color:rgba(234,240,255,.92);
      text-transform:uppercase;
    }
    .legendList{
      padding:12px;
      display:grid;
      grid-template-columns:repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 420px){
      .legendList{ grid-template-columns:repeat(4, minmax(0, 1fr)); gap:8px; }
    }
    .legItem{
      appearance:none;
      -webkit-appearance:none;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
      border-radius:16px;
      padding:10px 8px 9px;
      display:grid;
      justify-items:center;
      gap:7px;
      text-align:center;
      cursor:pointer;
      touch-action:manipulation;
      transition:transform .14s var(--ease), border-color .2s var(--ease), filter .2s var(--ease);
      min-height:92px;
    }
    .legItem:hover{ border-color:rgba(255,255,255,.20); }
    .legItem:active{ transform:translateY(1px) scale(.995); }

    .legIcon{
      width:48px; height:48px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(90px 90px at 30% 25%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(124,77,255,.14), rgba(38,215,255,.08));
      box-shadow:inset 0 1px 0 rgba(255,255,255,.10), 0 10px 22px rgba(0,0,0,.18);
      display:grid;
      place-items:center;
    }
    .legIcon svg{ width:64%; height:64%; display:block; }
    .legName{
      font-weight:950;
      letter-spacing:.25px;
      font-size:11px;
      color:rgba(234,240,255,.92);
      text-transform:uppercase;
      line-height:1.05;
    }

    /* PRIZE DETAIL LIST */
    .prList{
      display:grid;
      gap:12px;
      padding:2px 0;
    }
    .pItem{
      display:grid;
      grid-template-columns:64px 1fr;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.14);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
    }
    .pImg{
      width:64px; height:64px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(90px 90px at 30% 25%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(124,77,255,.16), rgba(38,215,255,.10));
      box-shadow:inset 0 1px 0 rgba(255,255,255,.10), 0 12px 22px rgba(0,0,0,.18);
      overflow:hidden;
      position:relative;
    }
    .pImg[data-has="1"]{
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
    }
    .pImg::after{
      content:"IMG";
      position:absolute; inset:0;
      display:grid;
      place-items:center;
      font-family:Orbitron, Inter, system-ui;
      letter-spacing:.6px;
      font-weight:900;
      font-size:12px;
      color:rgba(234,240,255,.55);
      mix-blend-mode:screen;
    }
    .pImg[data-has="1"]::after{ display:none; }
    .pTxt{ min-width:0; }
    .pName{
      font-weight:900;
      letter-spacing:.2px;
      font-size:13px;
      color:rgba(234,240,255,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-transform:uppercase;
    }

    /* MODAL */
    .modal{
      position:fixed; inset:0;
      display:none;
      place-items:center;
      padding:18px;
      background:rgba(0,0,0,.62);
      z-index:50;
    }
    .modal.on{ display:grid; }

    .panel{
      width:min(520px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(16,18,40,.92), rgba(10,11,25,.90));
      box-shadow:0 28px 80px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.10);
      overflow:hidden;
      transform:translate3d(0, 6px, 0) scale(.985);
      opacity:0;
      animation:popIn .22s var(--ease) both;
      will-change: transform, opacity;
    }
    @keyframes popIn{
      to{ transform:translate3d(0,0,0) scale(1); opacity:1; }
    }

    .panelHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      gap:10px;
    }
    .panelHead .t{
      font-family:Orbitron, Inter, system-ui;
      font-weight:900;
      letter-spacing:.6px;
      font-size:14px;
      text-transform:uppercase;
    }
    .panelBody{ padding:14px 16px 16px; }

    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:12px 0;
      border-bottom:1px dashed rgba(255,255,255,.10);
    }
    .row:last-child{ border-bottom:none; }
    .row .l{ display:flex; flex-direction:column; gap:0; min-width:0; }
    .row .l .k{ font-weight:900; font-size:13px; text-transform:uppercase; letter-spacing:.3px; }

    .toggle{
      --w:52px; --h:30px;
      width:var(--w);
      height:var(--h);
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      position:relative;
      cursor:pointer;
      flex:0 0 auto;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.10);
      padding:0;
      appearance:none;
      -webkit-appearance:none;
      outline:none;
    }
    .toggle::after{
      content:"";
      position:absolute;
      top:3px; left:3px;
      width:calc(var(--h) - 6px);
      height:calc(var(--h) - 6px);
      border-radius:999px;
      background:linear-gradient(180deg, rgba(255,255,255,.86), rgba(255,255,255,.62));
      box-shadow:0 10px 18px rgba(0,0,0,.25);
      transition:transform .22s var(--ease);
    }
    .toggle.on{
      background:linear-gradient(180deg, rgba(124,77,255,.35), rgba(38,215,255,.18));
      border-color:rgba(255,255,255,.22);
    }
    .toggle.on::after{ transform:translateX(calc(var(--w) - var(--h))); }

    /* LOGIN + ACTIONS */
    .panelBody .field{ margin:0; }
    .panelActions{
      margin-top:12px;
      display:flex;
      gap:10px;
    }
    .panelActions .btn, .panelActions .aBtn{
      width:auto;
      flex:1;
    }

    /* JACKPOT PANEL */
    .jpWrap{
      display:grid;
      gap:12px;
      justify-items:center;
      text-align:center;
    }
    .jpSymbol{
      width:92px; height:92px;
      border-radius:26px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(140px 140px at 30% 25%, rgba(255,255,255,.12), transparent 60%),
        linear-gradient(180deg, rgba(255,216,138,.10), rgba(38,215,255,.08));
      box-shadow:inset 0 1px 0 rgba(255,255,255,.10), 0 18px 34px rgba(0,0,0,.30);
      display:grid;
      place-items:center;
    }
    .jpSymbol svg{ width:68%; height:68%; display:block; }

    .jpImg{
      width:min(360px, 100%);
      aspect-ratio: 16 / 9;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(900px 260px at 50% 0%, rgba(124,77,255,.10), transparent 62%),
        radial-gradient(820px 260px at 50% 110%, rgba(38,215,255,.08), transparent 62%),
        rgba(0,0,0,.14);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
      overflow:hidden;
      position:relative;
      display:grid;
      place-items:center;
    }
    .jpImg[data-has="1"]{
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
    }
    .jpImg::after{
      content:"PNG";
      font-family:Orbitron, Inter, system-ui;
      letter-spacing:.8px;
      font-weight:900;
      font-size:12px;
      color:rgba(234,240,255,.55);
      mix-blend-mode:screen;
    }
    .jpImg[data-has="1"]::after{ display:none; }

    .jpTitle{
      font-family:Orbitron, Inter, system-ui;
      font-weight:900;
      letter-spacing:.8px;
      font-size:18px;
      text-transform:uppercase;
      color:rgba(234,240,255,.96);
    }
    .jpMeta{
      width:100%;
      display:grid;
      gap:8px;
      text-align:left;
    }
    .metaRow{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.14);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
    }
    .metaK{
      font-weight:900;
      letter-spacing:.35px;
      font-size:12px;
      color:rgba(234,240,255,.88);
      text-transform:uppercase;
      white-space:nowrap;
    }
    .metaV{
      font-weight:800;
      font-size:12px;
      color:rgba(234,240,255,.72);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      text-align:right;
      min-width:0;
    }

    /* Symbol detail modal */
    .symPop{
      display:grid;
      gap:12px;
      justify-items:center;
      text-align:center;
    }
    .symPopIcon{
      width:96px; height:96px;
      border-radius:28px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(160px 160px at 30% 25%, rgba(255,255,255,.12), transparent 60%),
        linear-gradient(180deg, rgba(124,77,255,.14), rgba(38,215,255,.08));
      box-shadow:inset 0 1px 0 rgba(255,255,255,.10), 0 18px 34px rgba(0,0,0,.30);
      display:grid;
      place-items:center;
    }
    .symPopIcon svg{ width:66%; height:66%; display:block; }

    .symPopName{
      font-family:Orbitron, Inter, system-ui;
      font-weight:950;
      letter-spacing:.9px;
      font-size:18px;
      text-transform:uppercase;
      color:rgba(234,240,255,.96);
    }
    .symPopDesc{
      font-size:13px;
      color:rgba(234,240,255,.78);
      line-height:1.45;
      max-width:42ch;
    }
    .symPopImg{
      width:min(360px, 100%);
      aspect-ratio: 16 / 9;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(900px 260px at 50% 0%, rgba(124,77,255,.10), transparent 62%),
        radial-gradient(820px 260px at 50% 110%, rgba(38,215,255,.08), transparent 62%),
        rgba(0,0,0,.14);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
      overflow:hidden;
      position:relative;
      display:grid;
      place-items:center;
    }
    .symPopImg[data-has="1"]{
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
    }
    .symPopImg::after{
      content:"PRIZE";
      font-family:Orbitron, Inter, system-ui;
      letter-spacing:.8px;
      font-weight:900;
      font-size:12px;
      color:rgba(234,240,255,.55);
      mix-blend-mode:screen;
    }
    .symPopImg[data-has="1"]::after{ display:none; }

    /* Reduced Motion */
    .rm .reel.spinning::after{ display:none; }
    .rm .btn, .rm .txtBtn, .rm .pillBtn, .rm .toggle::after { transition:none !important; }
    .rm .reel.kick{ animation:none !important; }
    .rm .slotCard.flash::before,
    .rm .slotCard.flash::after,
    .rm .reels.flash::after{ animation:none !important; opacity:0 !important; }
    .rm .panel{ animation:none !important; transform:none !important; opacity:1 !important; }

    @media (prefers-reduced-motion: reduce){
      .btn, .txtBtn, .pillBtn, .toggle::after { transition:none !important; }
    }
  </style>
</head>

<body>

  <!-- SVG SPRITE (untuk simbol slot) -->
  <svg aria-hidden="true" width="0" height="0" style="position:absolute;left:-9999px;top:-9999px;overflow:hidden">
    <defs>
      <linearGradient id="grad-gem" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#26d7ff"/>
        <stop offset="1" stop-color="#7c4dff"/>
      </linearGradient>
      <linearGradient id="grad-star" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#ffd88a"/>
        <stop offset="1" stop-color="#ff2bd6"/>
      </linearGradient>
      <linearGradient id="grad-crown" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#ffd88a"/>
        <stop offset="1" stop-color="#f2c96f"/>
      </linearGradient>
      <linearGradient id="grad-cherry" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#ff2b5a"/>
        <stop offset="1" stop-color="#7a0518"/>
      </linearGradient>
      <linearGradient id="grad-heart" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#ff2bd6"/>
        <stop offset="1" stop-color="#7c4dff"/>
      </linearGradient>
      <linearGradient id="grad-clover" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#26d7ff"/>
        <stop offset="1" stop-color="#00c98a"/>
      </linearGradient>
      <linearGradient id="grad-diamond" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#26d7ff"/>
        <stop offset="1" stop-color="#ff2bd6"/>
      </linearGradient>
      <linearGradient id="grad-coin" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#fff6df"/>
        <stop offset="1" stop-color="#ffd88a"/>
      </linearGradient>
    </defs>

    <symbol id="sym-gem" viewBox="0 0 64 64">
      <path d="M12 26 24 10h16l12 16-20 28H32L12 26Z" fill="url(#grad-gem)" stroke="rgba(255,255,255,.35)" stroke-width="2" />
      <path d="M24 10 12 26h40L40 10" fill="rgba(255,255,255,.10)"/>
      <path d="M32 54 22 26h20L32 54Z" fill="rgba(0,0,0,.12)"/>
    </symbol>

    <symbol id="sym-star" viewBox="0 0 64 64">
      <path d="M32 8l7.3 15.4L56 25.4 43.8 37.1 46.8 54 32 45.9 17.2 54l3-16.9L8 25.4l16.7-2L32 8Z"
        fill="url(#grad-star)" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linejoin="round"/>
    </symbol>

    <symbol id="sym-crown" viewBox="0 0 64 64">
      <path d="M10 46 14 20l14 12 4-18 4 18 14-12 4 26H10Z" fill="url(#grad-crown)" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linejoin="round"/>
      <rect x="12" y="46" width="40" height="10" rx="4" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.20)"/>
      <circle cx="14" cy="20" r="3" fill="#ff2bd6"/>
      <circle cx="32" cy="14" r="3" fill="#26d7ff"/>
      <circle cx="50" cy="20" r="3" fill="#7c4dff"/>
    </symbol>

    <symbol id="sym-cherry" viewBox="0 0 64 64">
      <path d="M36 18c8-8 18-2 18 8" fill="none" stroke="rgba(38,215,255,.55)" stroke-width="3" stroke-linecap="round"/>
      <path d="M32 18c-6 6-10 12-10 22" fill="none" stroke="rgba(38,215,255,.55)" stroke-width="3" stroke-linecap="round"/>
      <circle cx="22" cy="44" r="10" fill="url(#grad-cherry)" stroke="rgba(255,255,255,.35)" stroke-width="2"/>
      <circle cx="42" cy="40" r="10" fill="url(#grad-cherry)" stroke="rgba(255,255,255,.35)" stroke-width="2"/>
      <path d="M40 14c5 2 8 1 12-2" fill="none" stroke="rgba(255,216,138,.75)" stroke-width="3" stroke-linecap="round"/>
    </symbol>

    <symbol id="sym-heart" viewBox="0 0 64 64">
      <path d="M32 54S10 40 10 24c0-8 6-14 14-14 5 0 8 2 8 2s3-2 8-2c8 0 14 6 14 14 0 16-22 30-22 30Z"
        fill="url(#grad-heart)" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linejoin="round"/>
    </symbol>

    <symbol id="sym-clover" viewBox="0 0 64 64">
      <path d="M32 30c-6 0-10-4-10-10S26 10 32 16c6-6 10-2 10 4s-4 10-10 10Zm0 0c6 0 10 4 10 10s-4 10-10 4c-6 6-10 2-10-4s4-10 10-10Z"
        fill="url(#grad-clover)" stroke="rgba(255,255,255,.30)" stroke-width="2" stroke-linejoin="round"/>
      <path d="M32 34c0 10 0 14-6 20" fill="none" stroke="rgba(255,216,138,.60)" stroke-width="3" stroke-linecap="round"/>
    </symbol>

    <symbol id="sym-diamond" viewBox="0 0 64 64">
      <path d="M32 6 56 32 32 58 8 32 32 6Z"
        fill="url(#grad-diamond)" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linejoin="round"/>
      <path d="M32 6 44 32 32 58 20 32 32 6Z" fill="rgba(255,255,255,.10)"/>
    </symbol>

    <symbol id="sym-coin" viewBox="0 0 64 64">
      <circle cx="32" cy="32" r="22" fill="url(#grad-coin)" stroke="rgba(255,255,255,.35)" stroke-width="2"/>
      <circle cx="32" cy="32" r="14" fill="rgba(0,0,0,.08)" stroke="rgba(255,255,255,.18)" stroke-width="2"/>
      <path d="M32 18v28" stroke="rgba(124,77,255,.55)" stroke-width="3" stroke-linecap="round"/>
      <path d="M24 24h16M24 40h16" stroke="rgba(38,215,255,.45)" stroke-width="3" stroke-linecap="round"/>
    </symbol>
  </svg>

  <div class="wrap">
    <div class="app" role="application" aria-label="Neon Slot Arcade">

      <header class="top">
        <div class="brand">
          <div class="title">NEON SLOT â€” ARCADE</div>
        </div>

        <div class="topRight">
          <button class="txtBtn" id="btnSettings" type="button">SETTINGS</button>
        </div>
      </header>

      <main class="main">
        <section class="slotCard" id="slotCard" aria-label="Slot Machine">
          <div class="slotHeader">
            <div class="hL">
              <div class="hT">Selamat Bermain</div>
              <div class="hS">Putar Mesin Slot Keberuntungan mu</div>
            </div>
          </div>

          <div class="machine">
            <div class="reels" id="reels">
              <div class="reel" data-reel="0"><div class="strip"></div></div>
              <div class="reel" data-reel="1"><div class="strip"></div></div>
              <div class="reel" data-reel="2"><div class="strip"></div></div>
            </div>

            <div class="fields" aria-label="Inputs">
              <label class="field" id="fieldCode">
                <span class="lbl">KODE</span>
                <input id="inpCode" type="text" inputmode="text" autocomplete="off" autocapitalize="characters" spellcheck="false" placeholder="MASUKKAN KODE" />
              </label>
            </div>

            <div class="controls">
              <button class="btn" id="btnSpin" type="button">SPIN</button>
            </div>
          </div>
        </section>

        <aside class="side" aria-label="Prize">
          <div class="sideHead">
            <div class="t">PRIZE</div>
            <button class="pillBtn" id="btnPrizeDetail" type="button">DETAIL HADIAH</button>
          </div>

          <div class="prizeWrap">
            <div class="prizeCard">
              <div class="prizeIcon" id="prizeIcon" aria-hidden="true"></div>
              <div class="prizeTitle" id="prizeTitle">â€”</div>
              <div class="prizeSub" id="prizeSub">â€”</div>

              <div class="prizeActions" aria-label="Aksi Hadiah">
                <button class="aBtn primary" id="btnClaim" type="button" disabled>CLAIM</button>
                <button class="aBtn" id="btnShare" type="button" disabled>BAGIKAN</button>
              </div>
            </div>

            <div class="legendCard" aria-label="Arti Simbol Prize">
              <div class="legendHead">
                <div class="legendT">ARTI SIMBOL</div>
              </div>
              <div class="legendList" id="symbolLegend"></div>
            </div>
          </div>
        </aside>
      </main>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div class="modal" id="modal">
    <div class="panel" role="dialog" aria-modal="true" aria-label="Settings">
      <div class="panelHead">
        <div class="t">SETTINGS</div>
        <button class="txtBtn" id="btnClose" type="button">TUTUP</button>
      </div>
      <div class="panelBody">
        <div class="row">
          <div class="l"><div class="k">SOUND</div></div>
          <button class="toggle" id="tglSound" type="button" role="switch" aria-label="Toggle sound" aria-checked="true"></button>
        </div>
        <div class="row">
          <div class="l"><div class="k">REDUCED MOTION</div></div>
          <button class="toggle" id="tglReduce" type="button" role="switch" aria-label="Toggle reduced motion" aria-checked="false"></button>
        </div>
        <div class="row">
          <div class="l"><div class="k">VIBRATION</div></div>
          <button class="toggle" id="tglVibe" type="button" role="switch" aria-label="Toggle vibration" aria-checked="true"></button>
        </div>
      </div>
    </div>
  </div>

  <!-- PRIZE DETAIL MODAL -->
  <div class="modal" id="modalPrize">
    <div class="panel" role="dialog" aria-modal="true" aria-label="Detail Hadiah">
      <div class="panelHead">
        <div class="t">DETAIL HADIAH</div>
        <button class="txtBtn" id="btnPrizeClose" type="button">KEMBALI</button>
      </div>
      <div class="panelBody">
        <div class="prList" id="prizeList"></div>
      </div>
    </div>
  </div>

  <!-- SYMBOL DETAIL MODAL (klik simbol pada grid) -->
  <div class="modal" id="modalSymbol">
    <div class="panel" role="dialog" aria-modal="true" aria-label="Arti Simbol">
      <div class="panelHead">
        <div class="t">ARTI SIMBOL</div>
        <button class="txtBtn" id="btnSymbolClose" type="button">KEMBALI</button>
      </div>
      <div class="panelBody">
        <div class="symPop">
          <div class="symPopIcon" id="symPopIcon"></div>
          <div class="symPopName" id="symPopName">â€”</div>
          <div class="symPopDesc" id="symPopDesc">â€”</div>
          <div class="symPopImg" id="symPopImg" data-has="0"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL (tanpa close) -->
  <div class="modal" id="modalLogin">
    <div class="panel" role="dialog" aria-modal="true" aria-label="Login">
      <div class="panelHead">
        <div class="t">SLOT MECHANIC</div>
        <div style="width:1px;height:1px;overflow:hidden;">.</div>
      </div>
      <div class="panelBody">
        <label class="field" id="fieldUser">
          <span class="lbl">USER ID</span>
          <input id="inpUser" type="text" inputmode="text" autocomplete="off" autocapitalize="none" spellcheck="false" placeholder="MASUKKAN USER ID" />
        </label>
        <div class="panelActions">
          <button class="btn" id="btnLogin" type="button">LOGIN</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JACKPOT MODAL -->
  <div class="modal" id="modalJackpot">
    <div class="panel" role="dialog" aria-modal="true" aria-label="Jackpot">
      <div class="panelHead">
        <div class="t">JACKPOT</div>
        <div style="width:1px;height:1px;overflow:hidden;">.</div>
      </div>
      <div class="panelBody">
        <div class="jpWrap">
          <div class="jpSymbol" id="jpSymbol"></div>
          <div class="jpImg" id="jpImg" data-has="0"></div>
          <div class="jpTitle" id="jpTitle">â€”</div>

          <div class="jpMeta" aria-label="Detail">
            <div class="metaRow"><div class="metaK">USER ID</div><div class="metaV" id="jpUser">â€”</div></div>
            <div class="metaRow"><div class="metaK">KODE</div><div class="metaV" id="jpCode">â€”</div></div>
            <div class="metaRow"><div class="metaK">WAKTU</div><div class="metaV" id="jpTime">â€”</div></div>
          </div>

          <div class="panelActions" style="margin-top:2px;">
            <button class="aBtn primary" id="jpClaim" type="button">CLAIM</button>
            <button class="aBtn" id="jpShare" type="button">BAGIKAN</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>
  
<script>
(() => {
  "use strict";

  // =========================
  // CONFIG (EDIT DI SINI)
  // =========================
  const CONFIG = {
    autoJackpot: true,
    longSpin: true,

    // âœ… LOCK JACKPOT SYMBOL
    // - enabled: aktifkan kunci simbol jackpot
    // - symbolKey: "gem"|"star"|"crown"|"cherry"|"heart"|"clover"|"diamond"|"coin"
    // - forceEverySpin: kalau true => setiap spin jadi jackpot (sesuai autoJackpot). Kalau false => hanya saat jackpot terjadi, simbolnya dikunci.
    jackpotLock: {
      enabled: true,
      symbolKey: "crown",
      forceEverySpin: true
    },

    // âœ… CONFETTI (pojok kiri/kanan atas)
    confetti: {
      enabled: true,
      burst: "soft" // "soft" | "strong"
    },

    // âœ… SHARE TEXT (sesuai format kamu)
    share: {
      intro: "Putar Slot Mechanic keberutunganmu di MADETOTO2 ðŸ‘‡",
      gameUrl: "https://madetoto2.info/", // (link ku) -> ganti nanti kalau perlu
      titleLine: "ðŸŽ° SLOT MECHANIC MADETOTO2",
      tz: "Asia/Phnom_Penh"
    },

    // âœ… URL ACTION CLAIM (ISI NANTI)
    // Placeholder: {{userId}} {{code}} {{prize}} {{symbol}} {{time}}
    claim: {
      url: "https://madetoto2.info/",
      openInNewTab: true,
      appendQueryIfNoTpl: true
    },

    // âœ… 4 PRIZE UTAMA
    prizes: [
      { name: "Prize Utama 1", img: "" },
      { name: "Prize Utama 2", img: "" },
      { name: "Prize Utama 3", img: "" },
      { name: "Prize Utama 4", img: "" },
    ],

    // âœ… SOUND URLS
    sound: {
      backsoundUrl: "",
      clickUrl: "",
      spinUrl: "",
      spinStopUrl: "",
      winUrl: "",
      volume: {
        backsound: 0.35,
        click: 0.65,
        spin: 0.55,
        stop: 0.65,
        win: 0.75
      }
    },

    speedBase: { normal: 3200, reduce: 2500 },
    speedJitter: 240,

    stopAutoStartDelayMs: { normal: [1900, 2250], reduce: [1500, 1850] },
    stopGapMs:            { normal: [520, 650],  reduce: [460, 600]  },
    stopMinTotalMs:       { normal: [3300, 3600], reduce: [2700, 3000] },

    stopMinSteps:         { normal: 6, reduce: 5 },
    stopRampSec:          0.18,
    stopSpeedFactor:      0.62,

    snapDur: { normal: 0.24, fast: 0.16, reduce: 0.12 },

    flashMs: { normal: 4000, reduce: 1200 }
  };

  const $ = (q, p=document) => p.querySelector(q);
  const $$ = (q, p=document) => Array.from(p.querySelectorAll(q));

  const els = {
    slotCard: $("#slotCard"),

    reelsWrap: $("#reels"),
    reels: $$(".reel"),

    inpCode: $("#inpCode"),
    fieldCode: $("#fieldCode"),
    btnSpin: $("#btnSpin"),

    prizeIcon: $("#prizeIcon"),
    prizeTitle: $("#prizeTitle"),
    prizeSub: $("#prizeSub"),
    btnClaim: $("#btnClaim"),
    btnShare: $("#btnShare"),

    symbolLegend: $("#symbolLegend"),

    // settings
    modal: $("#modal"),
    btnSettings: $("#btnSettings"),
    btnClose: $("#btnClose"),
    tglSound: $("#tglSound"),
    tglReduce: $("#tglReduce"),
    tglVibe: $("#tglVibe"),

    // prize detail
    btnPrizeDetail: $("#btnPrizeDetail"),
    modalPrize: $("#modalPrize"),
    btnPrizeClose: $("#btnPrizeClose"),
    prizeList: $("#prizeList"),

    // symbol detail
    modalSymbol: $("#modalSymbol"),
    btnSymbolClose: $("#btnSymbolClose"),
    symPopIcon: $("#symPopIcon"),
    symPopName: $("#symPopName"),
    symPopDesc: $("#symPopDesc"),
    symPopImg: $("#symPopImg"),

    // login
    modalLogin: $("#modalLogin"),
    inpUser: $("#inpUser"),
    btnLogin: $("#btnLogin"),
    fieldUser: $("#fieldUser"),

    // jackpot
    modalJackpot: $("#modalJackpot"),
    jpSymbol: $("#jpSymbol"),
    jpImg: $("#jpImg"),
    jpTitle: $("#jpTitle"),
    jpUser: $("#jpUser"),
    jpCode: $("#jpCode"),
    jpTime: $("#jpTime"),
    jpClaim: $("#jpClaim"),
    jpShare: $("#jpShare"),
  };

  const prefersReduce = (() => {
    try { return matchMedia("(prefers-reduced-motion: reduce)")?.matches; }
    catch { return false; }
  })();

  const SETTINGS_KEY = "neon_slot_settings_v6";
  const STATE_KEY    = "neon_slot_prize_state_v6";
  const USER_KEY     = "neon_slot_user_v1";

  const settings = { sound:true, reduce:prefersReduce, vibe:true };
  const state = {
    lastPrize: null,      // { type, symIndex }
    lastMeta: null,       // { userId, code, timeISO }
  };

  const user = { id:"" };
  let currentSpinMeta = null;

  const SYMBOLS = [
    { key:"gem",     name:"GEM" },
    { key:"star",    name:"STAR" },
    { key:"crown",   name:"CROWN" },
    { key:"cherry",  name:"CHERRY" },
    { key:"heart",   name:"HEART" },
    { key:"clover",  name:"CLOVER" },
    { key:"diamond", name:"DIAMOND" },
    { key:"coin",    name:"COIN" },
  ];

  // cache svg markup
  const SVG_CACHE = SYMBOLS.map(s =>
    `<svg viewBox="0 0 64 64" aria-hidden="true" focusable="false">
      <use href="#sym-${s.key}" xlink:href="#sym-${s.key}"></use>
    </svg>`
  );

  // -------------------- storage --------------------
  function loadSettings(){
    try{
      const raw = localStorage.getItem(SETTINGS_KEY);
      if(!raw) return false;
      const o = JSON.parse(raw);
      if(typeof o?.sound === "boolean") settings.sound = o.sound;
      if(typeof o?.reduce === "boolean") settings.reduce = o.reduce;
      if(typeof o?.vibe  === "boolean") settings.vibe  = o.vibe;
      return true;
    }catch{ return false; }
  }
  function saveSettings(){
    try{ localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }catch{}
  }
  function loadState(){
    try{
      const raw = localStorage.getItem(STATE_KEY);
      if(!raw) return;
      const o = JSON.parse(raw);
      if(o?.lastPrize && typeof o.lastPrize === "object") state.lastPrize = o.lastPrize;
      if(o?.lastMeta && typeof o.lastMeta === "object") state.lastMeta = o.lastMeta;
    }catch{}
  }
  function saveState(){
    try{ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }catch{}
  }
  function loadUser(){
    try{
      const raw = localStorage.getItem(USER_KEY);
      if(!raw) return;
      const o = JSON.parse(raw);
      const id = String(o?.id || "").trim();
      if(id) user.id = id;
    }catch{}
  }
  function saveUser(){
    try{ localStorage.setItem(USER_KEY, JSON.stringify({ id: user.id })); }catch{}
  }

  // -------------------- auto-tier --------------------
  function autoTierDefault(){
    try{
      const hasSaved = !!localStorage.getItem(SETTINGS_KEY);
      if(hasSaved) return;
      const mem = Number(navigator.deviceMemory || 0) || 0;
      const cores = Number(navigator.hardwareConcurrency || 0) || 0;
      const low = (mem && mem <= 4) || (cores && cores <= 4);
      if(low) settings.reduce = true;
    }catch{}
  }

  // -------------------- UI helpers --------------------
  function setToggle(el, on){
    if(!el) return;
    el.classList.toggle("on", !!on);
    el.setAttribute("aria-checked", String(!!on));
  }
  function applyReduceClass(){
    document.documentElement.classList.toggle("rm", !!settings.reduce);
  }

  function clearFieldErr(){ els.fieldCode?.classList.remove("err"); }
  function clearUserErr(){ els.fieldUser?.classList.remove("err"); }

  function escapeHTML(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function prizeIconHTML(symIndex){
    const i = Math.max(0, Math.min(SYMBOLS.length-1, Number(symIndex) || 0));
    return SVG_CACHE[i];
  }

  function prizeName(i){
    const nm = (CONFIG.prizes?.[i]?.name || `Prize Utama ${i+1}`).toString().trim();
    return nm || `Prize Utama ${i+1}`;
  }

  function symbolMeaning(symIndex){
    const key = SYMBOLS[symIndex]?.key || "";
    switch(key){
      case "gem":     return "Free Saldo IDR 100.000";
      case "star":    return `PRIZE UTAMA 1 â€” ${prizeName(0)}`;
      case "crown":   return "Free Saldo IDR 200.000";
      case "cherry":  return `PRIZE UTAMA 2 â€” ${prizeName(1)}`;
      case "heart":   return "Free Saldo IDR 300.000";
      case "clover":  return `PRIZE UTAMA 3 â€” ${prizeName(2)}`;
      case "diamond": return "Free Saldo IDR 400.000";
      case "coin":    return `PRIZE UTAMA 4 â€” ${prizeName(3)}`;
      default:        return "";
    }
  }

  function mapPrizeIndexFromSymbol(symIndex){
    const k = SYMBOLS[symIndex]?.key || "";
    if(k === "star") return 0;
    if(k === "cherry") return 1;
    if(k === "clover") return 2;
    if(k === "coin") return 3;
    return -1;
  }

  // -------------------- confetti (corner burst) --------------------
  function confettiBurstCorners(kind="soft"){
    if(!CONFIG.confetti?.enabled) return;
    if(settings.reduce || prefersReduce) kind = "soft";
    const fn = (typeof window.confetti === "function") ? window.confetti : null;
    if(!fn) return;

    const strong = kind === "strong";
    const particleCount = strong ? 120 : 70;
    const spread = strong ? 70 : 55;
    const startVelocity = strong ? 42 : 34;
    const ticks = strong ? 220 : 180;
    const scalar = strong ? 1.0 : 0.9;

    // kiri
    fn({
      particleCount: Math.round(particleCount * 0.55),
      angle: 60,
      spread,
      startVelocity,
      ticks,
      scalar,
      origin: { x: 0.06, y: 0.02 }
    });

    // kanan
    fn({
      particleCount: Math.round(particleCount * 0.55),
      angle: 120,
      spread,
      startVelocity,
      ticks,
      scalar,
      origin: { x: 0.94, y: 0.02 }
    });

    // micro burst biar lebih â€œpremiumâ€
    setTimeout(() => {
      fn({
        particleCount: Math.round(particleCount * 0.25),
        angle: 90,
        spread: spread - 10,
        startVelocity: startVelocity - 6,
        ticks: ticks - 40,
        scalar: scalar - 0.08,
        origin: { x: 0.5, y: 0.03 }
      });
    }, 110);
  }

  // -------------------- share / claim text --------------------
  function pad2(n){ n = Number(n)||0; return String(n).padStart(2,"0"); }

  function formatShareTime(iso){
    try{
      const tz = String(CONFIG.share?.tz || "Asia/Phnom_Penh");
      const d = new Date(iso);
      // pakai Intl untuk tanggal (biar aman), lalu susun manual HH.mm.ss
      const dp = new Intl.DateTimeFormat("id-ID", {
        timeZone: tz,
        day: "2-digit",
        month: "short",
        year: "numeric"
      }).formatToParts(d);

      const day = dp.find(x=>x.type==="day")?.value || "??";
      const mon = dp.find(x=>x.type==="month")?.value || "???";
      const yr  = dp.find(x=>x.type==="year")?.value || "????";

      // jam di TZ (manual via Intl)
      const tp = new Intl.DateTimeFormat("en-GB", {
        timeZone: tz,
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false
      }).formatToParts(d);

      const hh = tp.find(x=>x.type==="hour")?.value || "00";
      const mm = tp.find(x=>x.type==="minute")?.value || "00";
      const ss = tp.find(x=>x.type==="second")?.value || "00";

      return `${day} ${mon} ${yr}, ${hh}.${mm}.${ss}`;
    }catch{
      return iso || "â€”";
    }
  }

  function formatTime(iso){
    // untuk UI modal jackpot (tetap rapi)
    return formatShareTime(iso).replaceAll(".", ":");
  }

  function fillTpl(url, vars){
    return url.replace(/\{\{(\w+)\}\}/g, (_, k) => encodeURIComponent(String(vars[k] ?? "")));
  }

  function prizeText(p){
    if(!p || p.type === "none") return "";
    const symName = SYMBOLS[p.symIndex]?.name || "";
    const meaning = symbolMeaning(p.symIndex);
    return [symName, meaning].filter(Boolean).join(" â€” ");
  }

  function sharePrizeOnly(p){
    const idx = mapPrizeIndexFromSymbol(p?.symIndex);
    if(idx >= 0) return prizeName(idx);
    const meaning = symbolMeaning(p?.symIndex);
    return String(meaning || "").replace(/^Free\s+Saldo/i, "Saldo Free").trim();
  }

  function buildShareText(meta, p){
    const link = String(CONFIG.share?.gameUrl || location.href || "").trim();
    const hadiah = sharePrizeOnly(p) || "-";
    const uid = String(meta?.userId || user.id || "").trim() || "-";
    const time = formatShareTime(meta?.timeISO || new Date().toISOString());

    return [
      String(CONFIG.share?.intro || "").trim(),
      link ? `(${link})` : "",
      "",
      String(CONFIG.share?.titleLine || "ðŸŽ° SLOT MECHANIC").trim(),
      `Hadiah : ${hadiah}`,
      `User ID : ${uid}`,
      `Waktu : ${time}`
    ].filter(x => x !== "").join("\n");
  }

  async function copyToClipboard(text){
    try{
      if(navigator.clipboard?.writeText){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch{}
    try{
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly","");
      ta.style.position="fixed";
      ta.style.left="-9999px";
      ta.style.top="0";
      document.body.appendChild(ta);
      ta.select();
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return !!ok;
    }catch{ return false; }
  }

  function buildClaimUrl(meta, p){
    const raw = String(CONFIG.claim?.url || "").trim();
    if(!raw) return "";
    const vars = {
      userId: meta?.userId || user.id || "",
      code: meta?.code || (els.inpCode?.value || "").trim(),
      prize: prizeText(p) || "",
      symbol: SYMBOLS[p?.symIndex]?.name || "",
      time: meta?.timeISO || new Date().toISOString()
    };

    const hasTpl = /\{\{\w+\}\}/.test(raw);
    let out = hasTpl ? fillTpl(raw, vars) : raw;

    if(!hasTpl && CONFIG.claim?.appendQueryIfNoTpl){
      try{
        const u = new URL(out, location.href);
        if(vars.userId) u.searchParams.set("userId", vars.userId);
        if(vars.code)   u.searchParams.set("code", vars.code);
        if(vars.prize)  u.searchParams.set("prize", vars.prize);
        if(vars.symbol) u.searchParams.set("symbol", vars.symbol);
        if(vars.time)   u.searchParams.set("time", vars.time);
        out = u.toString();
      }catch{}
    }
    return out;
  }

  function doClaim(meta, p){
    const url = buildClaimUrl(meta, p);
    if(!url) return;
    try{
      if(CONFIG.claim?.openInNewTab) window.open(url, "_blank", "noopener,noreferrer");
      else location.href = url;
    }catch{}
  }

  function setPrizeUI(p){
    const hasPrize = !!(p && p.type !== "none");
    if(els.btnClaim) els.btnClaim.disabled = !hasPrize;
    if(els.btnShare) els.btnShare.disabled = !hasPrize;

    if(!hasPrize){
      if(els.prizeIcon) els.prizeIcon.innerHTML = "";
      if(els.prizeTitle) els.prizeTitle.textContent = "â€”";
      if(els.prizeSub) els.prizeSub.textContent = "â€”";
      return;
    }

    const symName = SYMBOLS[p.symIndex]?.name || "";
    const meaning = symbolMeaning(p.symIndex);

    if(els.prizeIcon) els.prizeIcon.innerHTML = prizeIconHTML(p.symIndex);
    if(els.prizeTitle) els.prizeTitle.textContent = (p.type === "mega") ? "JACKPOT" : "HADIAH";
    if(els.prizeSub) els.prizeSub.textContent = [symName, meaning].filter(Boolean).join(" â€¢ ");
  }

  function renderSymbolLegend(){
    if(!els.symbolLegend) return;
    els.symbolLegend.innerHTML = SYMBOLS.map((s, idx) => `
      <button class="legItem" type="button" data-sym="${idx}" aria-label="Arti simbol ${escapeHTML(s.name)}">
        <div class="legIcon">${prizeIconHTML(idx)}</div>
        <div class="legName">${escapeHTML(s.name)}</div>
      </button>
    `).join("");
  }

  // -------------------- audio (URL-based) --------------------
  const AudioMgr = (() => {
    const pool = { click: [], stop: [], win: [] };
    let bgm = null;
    let spin = null;
    let unlocked = false;
    let bgmUrl = "";
    let spinUrl = "";

    function canUse(){ return !!settings.sound; }
    function safeUrl(u){ return String(u || "").trim(); }
    function clampVol(v){ v = Number(v); return isFinite(v) ? Math.max(0, Math.min(1, v)) : 0.6; }

    function makeAudio(url, { loop=false, volume=0.6 } = {}){
      const a = new Audio();
      a.src = url;
      a.preload = "auto";
      a.loop = !!loop;
      a.volume = clampVol(volume);
      a.playsInline = true;
      a.crossOrigin = "anonymous";
      return a;
    }

    function unlock(){
      if(unlocked) return;
      unlocked = true;
      try{
        const p = safeUrl(CONFIG.sound?.clickUrl) || safeUrl(CONFIG.sound?.winUrl) || safeUrl(CONFIG.sound?.spinStopUrl) || safeUrl(CONFIG.sound?.spinUrl) || safeUrl(CONFIG.sound?.backsoundUrl);
        if(!p) return;
        const t = makeAudio(p, { loop:false, volume:0.001 });
        t.play().then(() => { t.pause(); t.currentTime = 0; }).catch(()=>{});
      }catch{}
    }

    function ensureBGM(){
      const url = safeUrl(CONFIG.sound?.backsoundUrl);
      if(!url) { stopBGM(); return; }
      if(!bgm || bgmUrl !== url){
        bgmUrl = url;
        try{ if(bgm) bgm.pause(); }catch{}
        bgm = makeAudio(url, { loop:true, volume: clampVol(CONFIG.sound?.volume?.backsound ?? 0.35) });
      }
    }

    function ensureSpin(){
      const url = safeUrl(CONFIG.sound?.spinUrl);
      if(!url) { stopSpin(); return; }
      if(!spin || spinUrl !== url){
        spinUrl = url;
        try{ if(spin) spin.pause(); }catch{}
        spin = makeAudio(url, { loop:true, volume: clampVol(CONFIG.sound?.volume?.spin ?? 0.55) });
      }
    }

    function playOnce(kind){
      if(!canUse()) return false;
      const url =
        kind === "click" ? safeUrl(CONFIG.sound?.clickUrl) :
        kind === "stop"  ? safeUrl(CONFIG.sound?.spinStopUrl) :
        kind === "win"   ? safeUrl(CONFIG.sound?.winUrl) : "";
      if(!url) return false;

      const vol =
        kind === "click" ? clampVol(CONFIG.sound?.volume?.click ?? 0.65) :
        kind === "stop"  ? clampVol(CONFIG.sound?.volume?.stop ?? 0.65) :
        kind === "win"   ? clampVol(CONFIG.sound?.volume?.win ?? 0.75) : 0.6;

      const arr = pool[kind] || (pool[kind] = []);
      let a = arr.find(x => x.paused || x.ended);
      if(!a){
        a = makeAudio(url, { loop:false, volume: vol });
        arr.push(a);
        if(arr.length > 3) arr.shift();
      }else{
        a.volume = vol;
        if(a.src !== url) a.src = url;
      }

      try{
        a.currentTime = 0;
        a.play().catch(()=>{});
        return true;
      }catch{ return false; }
    }

    function startBGM(){
      ensureBGM();
      if(!bgm || !canUse()) return;
      try{ bgm.volume = clampVol(CONFIG.sound?.volume?.backsound ?? 0.35); }catch{}
      try{ bgm.play().catch(()=>{}); }catch{}
    }
    function stopBGM(){
      try{ if(bgm){ bgm.pause(); bgm.currentTime = 0; } }catch{}
    }

    function startSpin(){
      ensureSpin();
      if(!spin || !canUse()) return;
      try{ spin.volume = clampVol(CONFIG.sound?.volume?.spin ?? 0.55); }catch{}
      try{ spin.currentTime = 0; spin.play().catch(()=>{}); }catch{}
    }
    function stopSpin(){
      try{ if(spin){ spin.pause(); spin.currentTime = 0; } }catch{}
    }

    function syncSoundOnToggle(){
      if(!settings.sound){ stopSpin(); stopBGM(); return; }
      startBGM();
    }

    return {
      unlock,
      click(){ return playOnce("click"); },
      stop(){ return playOnce("stop"); },
      win(){ return playOnce("win"); },
      startBGM, stopBGM,
      startSpin, stopSpin,
      syncSoundOnToggle
    };
  })();

  // fallback beep
  let audioCtx = null;
  function ensureAudioFallback(){
    try{
      audioCtx ||= new (window.AudioContext || window.webkitAudioContext)();
      if(audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
    }catch{}
  }
  function beep(freq=520, dur=0.045, vol=0.06){
    if(!settings.sound) return;
    try{
      ensureAudioFallback();
      if(!audioCtx) return;
      const t0 = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "triangle";
      o.frequency.setValueAtTime(freq, t0);
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(vol, t0 + 0.006);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
      o.connect(g).connect(audioCtx.destination);
      o.start(t0);
      o.stop(t0 + dur + 0.02);
    }catch{}
  }

  function vibrate(ms){
    if(!settings.vibe) return;
    try{ if(navigator.vibrate) navigator.vibrate(ms); }catch{}
  }

  function clickFX(){
    AudioMgr.unlock();
    const ok = AudioMgr.click();
    if(!ok) beep(620, 0.04, 0.05);
  }
  function stopFX(){
    const ok = AudioMgr.stop();
    if(!ok) beep(520, 0.035, 0.045);
  }
  function winFX(){
    const ok = AudioMgr.win();
    if(!ok) beep(760, 0.06, 0.075);
  }

  // -------------------- flash controller --------------------
  let flashTO = 0;
  function flash3sDown(){
    clearTimeout(flashTO);
    els.slotCard?.classList.add("flash");
    els.reelsWrap?.classList.add("flash");

    const ms = settings.reduce ? CONFIG.flashMs.reduce : CONFIG.flashMs.normal;
    flashTO = setTimeout(() => {
      els.slotCard?.classList.remove("flash");
      els.reelsWrap?.classList.remove("flash");
    }, ms);

    return ms;
  }

  // -------------------- prize detail render --------------------
  function renderPrizeList(){
    if(!els.prizeList) return;
    const items = Array.isArray(CONFIG.prizes) ? CONFIG.prizes.slice(0,4) : [];
    els.prizeList.innerHTML = items.map((p, i) => {
      const name = (p?.name || `Prize ${i+1}`).toString();
      const img = (p?.img || "").toString().trim();
      const has = img ? "1" : "0";
      const safeUrl = img ? img.replace(/'/g, "%27") : "";
      const bg = img ? `style="background-image:url('${safeUrl}')"` : "";
      return `
        <div class="pItem">
          <div class="pImg" data-has="${has}" ${bg}></div>
          <div class="pTxt">
            <div class="pName">${escapeHTML(name)}</div>
          </div>
        </div>
      `;
    }).join("");
  }

  // -------------------- modals --------------------
  function lockScroll(on){
    document.documentElement.style.overflow = on ? "hidden" : "";
  }

  function openModalSettings(){
    els.modal?.classList.add("on");
    lockScroll(true);
    try{ els.btnClose?.focus({ preventScroll:true }); }catch{}
  }
  function closeModalSettings(){
    els.modal?.classList.remove("on");
    lockScroll(false);
    try{ els.btnSettings?.focus({ preventScroll:true }); }catch{}
  }

  function openPrizeModal(){
    renderPrizeList();
    els.modalPrize?.classList.add("on");
    lockScroll(true);
    try{ els.btnPrizeClose?.focus({ preventScroll:true }); }catch{}
  }
  function closePrizeModal(){
    els.modalPrize?.classList.remove("on");
    lockScroll(false);
    try{ els.btnPrizeDetail?.focus({ preventScroll:true }); }catch{}
  }

  function openLoginModal(){
    els.modalLogin?.classList.add("on");
    lockScroll(true);
    setTimeout(() => { try{ els.inpUser?.focus({ preventScroll:true }); }catch{} }, 0);
  }
  function closeLoginModal(){
    els.modalLogin?.classList.remove("on");
    lockScroll(false);
  }

  function openJackpotModal(payload){
    if(els.jpSymbol) els.jpSymbol.innerHTML = prizeIconHTML(payload.symIndex);

    const img = String(payload.imgUrl || "").trim();
    if(els.jpImg){
      if(img){
        els.jpImg.dataset.has = "1";
        els.jpImg.style.backgroundImage = `url('${img.replace(/'/g, "%27")}')`;
      }else{
        els.jpImg.dataset.has = "0";
        els.jpImg.style.backgroundImage = "";
      }
    }

    if(els.jpTitle) els.jpTitle.textContent = payload.title || "JACKPOT";
    if(els.jpUser)  els.jpUser.textContent  = payload.userId || "â€”";
    if(els.jpCode)  els.jpCode.textContent  = payload.code || "â€”";
    if(els.jpTime)  els.jpTime.textContent  = formatTime(payload.timeISO || "");

    els.modalJackpot?.classList.add("on");
    lockScroll(true);
  }
  function closeJackpotModal(){
    els.modalJackpot?.classList.remove("on");
    lockScroll(false);
  }

  let lastSymbolFocus = null;
  function openSymbolModal(symIndex, sourceEl){
    lastSymbolFocus = sourceEl || null;

    const idx = Math.max(0, Math.min(SYMBOLS.length-1, Number(symIndex)||0));
    const sym = SYMBOLS[idx];
    const meaning = symbolMeaning(idx) || "â€”";

    if(els.symPopIcon) els.symPopIcon.innerHTML = prizeIconHTML(idx);
    if(els.symPopName) els.symPopName.textContent = sym?.name || "â€”";
    if(els.symPopDesc) els.symPopDesc.textContent = meaning;

    const prizeIdx = mapPrizeIndexFromSymbol(idx);
    const img = (prizeIdx >= 0) ? String(CONFIG.prizes?.[prizeIdx]?.img || "").trim() : "";
    if(els.symPopImg){
      if(img){
        els.symPopImg.dataset.has = "1";
        els.symPopImg.style.backgroundImage = `url('${img.replace(/'/g, "%27")}')`;
      }else{
        els.symPopImg.dataset.has = "0";
        els.symPopImg.style.backgroundImage = "";
      }
    }

    els.modalSymbol?.classList.add("on");
    lockScroll(true);
    try{ els.btnSymbolClose?.focus({ preventScroll:true }); }catch{}
  }
  function closeSymbolModal(){
    els.modalSymbol?.classList.remove("on");
    lockScroll(false);
    try{ if(lastSymbolFocus) lastSymbolFocus.focus({ preventScroll:true }); }catch{}
    lastSymbolFocus = null;
  }

  function bindToggle(el, key){
    if(!el) return;
    const flip = () => {
      clickFX();
      settings[key] = !settings[key];
      setToggle(el, settings[key]);
      if(key === "reduce") applyReduceClass();
      saveSettings();
      if(key === "sound") AudioMgr.syncSoundOnToggle();
    };
    el.addEventListener("click", flip);
    el.addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        flip();
      }
    });
  }

  function trapFocus(modalEl, e){
    const focusables = modalEl.querySelectorAll('button, input, [tabindex]:not([tabindex="-1"])');
    if(!focusables.length) return;
    const first = focusables[0];
    const last  = focusables[focusables.length - 1];
    if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
    else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
  }

  // -------------------- inputs requirement --------------------
  function requireLogin(){
    const id = String(user.id || "").trim();
    if(id) return true;
    openLoginModal();
    vibrate(14);
    return false;
  }

  function requireInputs(){
    if(!requireLogin()) return false;

    const c = (els.inpCode?.value || "").trim();
    clearFieldErr();

    if(!c){
      els.fieldCode?.classList.add("err");
      vibrate(14);
      return false;
    }
    return true;
  }

  // -------------------- engine --------------------
  const machine = {
    spinning:false,
    fastStop:false,
    stopAt:0,
    raf:0,
    lastT:0,
    cellPx: 84,
    reels: [],
    stopTimes: [0,0,0],
  };

  let inputLockUntil = 0;
  function canInput(){ return performance.now() >= inputLockUntil; }

  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function randInRange(pair){ return randInt(pair[0], pair[1]); }
  function clamp01(x){ return Math.max(0, Math.min(1, x)); }
  function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

  function measureCellPx(){
    const probe = els.reels[0]?.querySelector(".symbol");
    if(!probe) return 84;
    const h = Math.round(probe.getBoundingClientRect().height);
    return Math.max(50, h || 84);
  }

  function setCellSymbol(cellEl, symIndex){
    const i = Math.max(0, Math.min(SYMBOLS.length-1, Number(symIndex)||0));
    cellEl.dataset.sym = String(i);
    cellEl.setAttribute("aria-label", SYMBOLS[i].name);
    const box = cellEl.querySelector(".symBox");
    if(box) box.innerHTML = SVG_CACHE[i];
  }

  function updateMidClass(reelObj){
    const cells = reelObj.cells;
    for(const c of cells) c.classList.remove("isMid");
    if(cells[2]) cells[2].classList.add("isMid");
  }

  function renderReel(reelObj){
    const y = -(machine.cellPx + reelObj.offset);
    reelObj.strip.style.transform = `translate3d(0, ${Math.round(y*100)/100}px, 0)`;
  }

  function rotateStep(reelObj, plannedNextSymIndex=null){
    const first = reelObj.cells.shift();
    reelObj.cells.push(first);
    reelObj.strip.appendChild(first);

    const last = reelObj.cells[reelObj.cells.length - 1];
    const idx = (plannedNextSymIndex == null) ? randInt(0, SYMBOLS.length-1) : plannedNextSymIndex;
    setCellSymbol(last, idx);

    updateMidClass(reelObj);
  }

  function buildReels(){
    machine.reels = [];
    for(const reelEl of els.reels){
      const strip = reelEl.querySelector(".strip");
      if(!strip) continue;
      strip.innerHTML = "";
      strip.style.willChange = "transform";

      const cells = [];
      for(let i=0;i<5;i++){
        const cell = document.createElement("div");
        cell.className = "symbol";
        cell.innerHTML = `<div class="symBox"></div>`;
        strip.appendChild(cell);
        cells.push(cell);
      }
      for(const c of cells) setCellSymbol(c, randInt(0, SYMBOLS.length-1));

      const reelObj = {
        el: reelEl,
        strip,
        cells,
        offset: 0,
        speed: 0,
        maxSpeed: 0,
        phase: "idle",
        rampT: 0,

        stopTime: 0,
        stopRequested: false,
        stopRampAt: 0,
        stepsLeft: 0,

        plan: null,
        snapFrom: 0,
        snapT: 0,
        snapDur: 0.20,
      };

      updateMidClass(reelObj);
      machine.reels.push(reelObj);
    }

    requestAnimationFrame(() => {
      machine.cellPx = measureCellPx();
      for(const r of machine.reels) renderReel(r);
    });
  }

  function getSymbolIndexByKey(key){
    const k = String(key || "").trim().toLowerCase();
    const i = SYMBOLS.findIndex(s => s.key === k);
    return i >= 0 ? i : -1;
  }

  function pickTargets(){
    const lock = CONFIG.jackpotLock || {};
    const lockOn = !!lock.enabled;
    const locked = lockOn ? getSymbolIndexByKey(lock.symbolKey) : -1;
    const lockedSym = (locked >= 0) ? locked : randInt(0, SYMBOLS.length-1);

    const forceEvery = lockOn ? (lock.forceEverySpin !== false) : false;

    // autoJackpot OR lock-force => selalu 3 mid sama
    if(!!CONFIG.autoJackpot || forceEvery){
      const s = lockOn ? lockedSym : randInt(0, SYMBOLS.length-1);
      return [0,1,2].map(() => ({
        top: randInt(0, SYMBOLS.length-1),
        mid: s,
        bot: randInt(0, SYMBOLS.length-1),
      }));
    }

    const roll = Math.random();
    let mid = [0,0,0];

    if(roll < 0.10){
      const s = lockOn ? lockedSym : randInt(0, SYMBOLS.length-1);
      mid = [s,s,s];
    }else if(roll < 0.35){
      const s = randInt(0, SYMBOLS.length-1);
      let t = randInt(0, SYMBOLS.length-1);
      if(t === s) t = (t+1) % SYMBOLS.length;
      const pos = randInt(0,2);
      mid = [s,s,s];
      mid[pos] = t;
    }else{
      mid = [randInt(0, SYMBOLS.length-1), randInt(0, SYMBOLS.length-1), randInt(0, SYMBOLS.length-1)];
    }

    return mid.map(m => ({
      top: randInt(0, SYMBOLS.length-1),
      mid: m,
      bot: randInt(0, SYMBOLS.length-1),
    }));
  }

  function scheduleStopTimes(now){
    const d0 = settings.reduce ? CONFIG.stopAutoStartDelayMs.reduce : CONFIG.stopAutoStartDelayMs.normal;
    const g  = settings.reduce ? CONFIG.stopGapMs.reduce           : CONFIG.stopGapMs.normal;
    const minTotal = settings.reduce ? CONFIG.stopMinTotalMs.reduce : CONFIG.stopMinTotalMs.normal;

    let base = randInRange(d0);
    let gap1 = randInRange(g);
    let gap2 = randInRange(g);

    if(CONFIG.longSpin){
      base += randInt(120, 220);
      gap1 += randInt(20, 60);
      gap2 += randInt(20, 70);
    }

    const t0 = now + base;
    let tLast = t0 + gap1 + gap2;

    const minNeed = now + randInRange(minTotal);
    if(tLast < minNeed){
      const extra = (minNeed - tLast);
      gap1 += Math.round(extra * 0.45);
      gap2 += Math.round(extra * 0.55);
      tLast = t0 + gap1 + gap2;
    }

    machine.stopTimes[0] = t0;
    machine.stopTimes[1] = t0 + gap1;
    machine.stopTimes[2] = tLast;
  }

  function beginStop(reelObj, reelIndex, now){
    if(reelObj.stopRequested) return;
    reelObj.stopRequested = true;
    reelObj.stopRampAt = now;

    const baseMin = settings.reduce ? CONFIG.stopMinSteps.reduce : CONFIG.stopMinSteps.normal;
    reelObj.stepsLeft = Math.max(4, baseMin + randInt(0, 3));
  }

  function reelKick(el){
    if(settings.reduce || !el) return;
    el.classList.remove("kick");
    void el.offsetWidth;
    el.classList.add("kick");
    setTimeout(() => el.classList.remove("kick"), 260);
  }

  function startSpin(){
    AudioMgr.unlock();
    if(!requireInputs()) return;

    const code = (els.inpCode?.value || "").trim();
    currentSpinMeta = {
      userId: String(user.id || "").trim(),
      code,
      timeISO: new Date().toISOString()
    };

    machine.spinning = true;
    machine.fastStop = false;
    machine.stopAt = 0;

    els.reelsWrap?.classList.remove("stopping","flash");
    els.slotCard?.classList.remove("flash");

    if(els.btnSpin){
      els.btnSpin.textContent = "STOP";
      els.btnSpin.disabled = false;
    }

    AudioMgr.startSpin();

    for(const r of machine.reels){
      r.el.classList.remove("win","kick");
      r.el.classList.add("spinning");
    }

    const plans = pickTargets();
    const now = performance.now();
    scheduleStopTimes(now);

    for(let i=0;i<machine.reels.length;i++){
      const r = machine.reels[i];
      r.plan = plans[i];

      r.phase = "ramp";
      r.rampT = 0;

      const baseSpeed = settings.reduce ? CONFIG.speedBase.reduce : CONFIG.speedBase.normal;
      r.maxSpeed = baseSpeed + i*220 + randInt(-CONFIG.speedJitter, CONFIG.speedJitter);

      r.speed = 0;
      r.offset = 0;

      r.stopTime = machine.stopTimes[i];
      r.stopRequested = false;
      r.stopRampAt = 0;
      r.stepsLeft = 0;

      renderReel(r);
    }

    kickRAF();
  }

  function requestStop(){
    const now = performance.now();
    machine.fastStop = true;
    machine.stopAt = now;
    els.reelsWrap?.classList.add("stopping");

    if(els.btnSpin){
      els.btnSpin.textContent = "STOPâ€¦";
      els.btnSpin.disabled = true;
    }

    const brakeGap = settings.reduce ? [320, 520] : [360, 580];
    let tNext = now + randInt(200, 300);

    for(let i=0;i<machine.reels.length;i++){
      const r = machine.reels[i];
      if(r.phase === "idle") continue;
      if(r.stopRequested) continue;

      r.stopTime = tNext;
      tNext += randInRange(brakeGap);
    }

    vibrate(18);
    clickFX();
  }

  function lockAndSnap(r, reelIndex){
    r.phase = "snap";
    r.speed = 0;

    r.snapFrom = r.offset;
    r.snapT = 0;

    if(settings.reduce){
      r.snapDur = CONFIG.snapDur.reduce + reelIndex * 0.01;
    }else{
      r.snapDur = (machine.fastStop ? CONFIG.snapDur.fast : CONFIG.snapDur.normal) + reelIndex * 0.02;
    }
  }

  function finishSpin(){
    machine.spinning = false;
    machine.fastStop = false;
    machine.stopAt = 0;
    els.reelsWrap?.classList.remove("stopping");

    for(const r of machine.reels) r.el.classList.remove("spinning");

    if(els.btnSpin){
      els.btnSpin.textContent = "SPIN";
      els.btnSpin.disabled = false;
    }

    AudioMgr.stopSpin();

    evaluateResult();
    inputLockUntil = performance.now() + (settings.reduce ? 220 : 320);
  }

  let jackpotTO = 0;

  function evaluateResult(){
    const mids = machine.reels.map(r => Number(r.cells[2]?.dataset.sym || 0));
    const [a,b,c] = mids;

    for(const r of machine.reels) r.el.classList.remove("win");

    let prize = null;

    if(a === b && b === c){
      for(const r of machine.reels) r.el.classList.add("win");

      const flashMs = flash3sDown();
      vibrate(40);
      winFX();
      confettiBurstCorners(CONFIG.confetti?.burst || "soft");

      prize = { type:"mega", symIndex:a };

      const meta = currentSpinMeta || {
        userId: String(user.id || "").trim(),
        code: (els.inpCode?.value || "").trim(),
        timeISO: new Date().toISOString()
      };
      state.lastMeta = meta;

      clearTimeout(jackpotTO);
      jackpotTO = setTimeout(() => {
        const idx = mapPrizeIndexFromSymbol(a);
        const imgUrl = (idx >= 0) ? String(CONFIG.prizes?.[idx]?.img || "").trim() : "";
        const title = (idx >= 0) ? prizeName(idx) : (symbolMeaning(a) || "JACKPOT");

        openJackpotModal({
          symIndex: a,
          title,
          imgUrl,
          userId: meta.userId,
          code: meta.code,
          timeISO: meta.timeISO
        });
      }, flashMs);

    }else if(a === b || b === c || a === c){
      const sym = (a===b) ? a : (b===c) ? b : a;

      if(a === b){ machine.reels[0].el.classList.add("win"); machine.reels[1].el.classList.add("win"); }
      if(b === c){ machine.reels[1].el.classList.add("win"); machine.reels[2].el.classList.add("win"); }
      if(a === c){ machine.reels[0].el.classList.add("win"); machine.reels[2].el.classList.add("win"); }

      vibrate(22);
      winFX();
      confettiBurstCorners("soft");
      prize = { type:"bonus", symIndex:sym };

    }else{
      vibrate(10);
      prize = { type:"none", symIndex:a };
    }

    state.lastPrize = prize;
    saveState();

    setPrizeUI(prize);
  }

  function tick(now){
    const t = now || performance.now();
    const dt = Math.min(0.034, (t - (machine.lastT || t)) / 1000);
    machine.lastT = t;

    let anyActive = false;

    let globalStopMult = 1;
    if(machine.fastStop && machine.stopAt){
      const x = (t - machine.stopAt) / (CONFIG.stopRampSec * 1000);
      const k = clamp01(x);
      globalStopMult = 1 - k * (1 - CONFIG.stopSpeedFactor);
    }

    for(let i=0;i<machine.reels.length;i++){
      const r = machine.reels[i];
      if(r.phase === "idle") continue;
      anyActive = true;

      if(r.phase === "ramp"){
        r.rampT += dt;
        const rampDur = settings.reduce ? 0.15 : 0.20;
        const k = Math.min(1, r.rampT / rampDur);
        const kk = settings.reduce ? k : easeOutCubic(k);
        r.speed = r.maxSpeed * kk;
        if(k >= 1) r.phase = "run";
      }

      if(r.phase === "run"){
        if(!r.stopRequested && t >= r.stopTime){
          beginStop(r, i, t);
        }

        let perStopMult = 1;
        if(r.stopRampAt){
          const x = (t - r.stopRampAt) / (CONFIG.stopRampSec * 1000);
          const k = clamp01(x);
          perStopMult = 1 - k * (1 - CONFIG.stopSpeedFactor);
        }

        r.speed = r.maxSpeed * globalStopMult * perStopMult;
        r.offset += r.speed * dt;

        while(r.offset >= machine.cellPx){
          r.offset -= machine.cellPx;

          if(!r.stopRequested){
            rotateStep(r, null);
            continue;
          }

          r.stepsLeft -= 1;

          let planned = null;
          if(r.stepsLeft === 3) planned = r.plan?.top ?? null;
          else if(r.stepsLeft === 2) planned = r.plan?.mid ?? null;
          else if(r.stepsLeft === 1) planned = r.plan?.bot ?? null;

          rotateStep(r, planned);

          if(r.stepsLeft <= 0){
            lockAndSnap(r, i);
            reelKick(r.el);
            break;
          }
        }

        renderReel(r);
      }

      if(r.phase === "snap"){
        r.snapT += dt;
        const t01 = Math.min(1, r.snapT / r.snapDur);
        const k = settings.reduce ? t01 : easeOutCubic(t01);
        r.offset = r.snapFrom * (1 - k);
        renderReel(r);

        if(t01 >= 1){
          r.offset = 0;
          renderReel(r);
          r.phase = "idle";

          stopFX(); // sekali per reel selesai (lebih clean)
        }
      }
    }

    if(anyActive){
      machine.raf = requestAnimationFrame(tick);
    }else{
      machine.raf = 0;
      finishSpin();
    }
  }

  function kickRAF(){
    if(machine.raf) return;
    machine.lastT = performance.now();
    machine.raf = requestAnimationFrame(tick);
  }

  // -------------------- init --------------------
  function init(){
    const hadSaved = loadSettings();
    autoTierDefault();
    loadState();
    loadUser();

    setToggle(els.tglSound, settings.sound);
    setToggle(els.tglReduce, settings.reduce);
    setToggle(els.tglVibe, settings.vibe);
    applyReduceClass();

    bindToggle(els.tglSound, "sound");
    bindToggle(els.tglReduce, "reduce");
    bindToggle(els.tglVibe, "vibe");

    buildReels();
    setPrizeUI(state.lastPrize);
    renderSymbolLegend();

    AudioMgr.syncSoundOnToggle();

    if(!String(user.id || "").trim()){
      openLoginModal();
    }

    // login
    els.inpUser?.addEventListener("input", () => clearUserErr(), { passive:true });
    els.btnLogin?.addEventListener("click", () => {
      AudioMgr.unlock();
      clickFX();

      const id = String(els.inpUser?.value || "").trim();
      clearUserErr();
      if(!id){
        els.fieldUser?.classList.add("err");
        vibrate(14);
        try{ els.inpUser?.focus({ preventScroll:true }); }catch{}
        return;
      }
      user.id = id;
      saveUser();
      closeLoginModal();
      vibrate(12);
      AudioMgr.startBGM();
    });
    els.inpUser?.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        els.btnLogin?.click();
      }
    });

    // code
    els.inpCode?.addEventListener("input", () => clearFieldErr(), { passive:true });

    // spin
    els.btnSpin?.addEventListener("click", () => {
      AudioMgr.unlock();
      if(!canInput()) return;

      clickFX();
      if(machine.spinning) requestStop();
      else startSpin();
    });

    // claim / share (panel kanan) - SILENT
    els.btnClaim?.addEventListener("click", () => {
      AudioMgr.unlock();
      clickFX();
      const p = state.lastPrize;
      if(!p || p.type === "none") return;

      const meta = state.lastMeta || currentSpinMeta || {
        userId: user.id,
        code: (els.inpCode?.value||"").trim(),
        timeISO: new Date().toISOString()
      };
      doClaim(meta, p);
      vibrate(18);
    });

    els.btnShare?.addEventListener("click", async () => {
      AudioMgr.unlock();
      clickFX();

      const p = state.lastPrize;
      if(!p || p.type === "none") return;

      const meta = state.lastMeta || { userId: user.id, code: (els.inpCode?.value||"").trim(), timeISO: new Date().toISOString() };
      const text = buildShareText(meta, p);

      try{
        if(navigator.share){
          await navigator.share({ title: "SLOT MECHANIC MADETOTO2", text });
        }else{
          await copyToClipboard(text);
        }
      }catch{
        await copyToClipboard(text);
      }
    });

    // jackpot modal actions (SILENT)
    els.jpClaim?.addEventListener("click", () => {
      AudioMgr.unlock();
      clickFX();
      const p = state.lastPrize;
      if(!p || p.type === "none") return;

      const meta = state.lastMeta || currentSpinMeta || {
        userId: user.id,
        code: (els.inpCode?.value||"").trim(),
        timeISO: new Date().toISOString()
      };
      doClaim(meta, p);
      vibrate(18);
      closeJackpotModal();
    });

    els.jpShare?.addEventListener("click", async () => {
      AudioMgr.unlock();
      clickFX();

      const p = state.lastPrize;
      if(!p || p.type === "none") { closeJackpotModal(); return; }

      const meta = state.lastMeta || { userId: user.id, code: (els.inpCode?.value||"").trim(), timeISO: new Date().toISOString() };
      const text = buildShareText(meta, p);

      try{
        if(navigator.share){
          await navigator.share({ title: "SLOT MECHANIC MADETOTO2", text });
        }else{
          await copyToClipboard(text);
        }
      }catch{
        await copyToClipboard(text);
      }
      closeJackpotModal();
    });

    // settings modal
    els.btnSettings?.addEventListener("click", () => { AudioMgr.unlock(); clickFX(); openModalSettings(); });
    els.btnClose?.addEventListener("click", () => { clickFX(); closeModalSettings(); });
    els.modal?.addEventListener("click", (e) => { if(e.target === els.modal) closeModalSettings(); });

    // prize modal
    els.btnPrizeDetail?.addEventListener("click", () => { AudioMgr.unlock(); clickFX(); openPrizeModal(); });
    els.btnPrizeClose?.addEventListener("click", () => { clickFX(); closePrizeModal(); });
    els.modalPrize?.addEventListener("click", (e) => { if(e.target === els.modalPrize) closePrizeModal(); });

    // symbol modal
    els.btnSymbolClose?.addEventListener("click", () => { clickFX(); closeSymbolModal(); });
    els.modalSymbol?.addEventListener("click", (e) => { if(e.target === els.modalSymbol) closeSymbolModal(); });

    // legend click => open symbol popup
    els.symbolLegend?.addEventListener("click", (e) => {
      const btn = e.target.closest(".legItem");
      if(!btn) return;
      AudioMgr.unlock();
      clickFX();
      const idx = Number(btn.dataset.sym || 0);
      openSymbolModal(idx, btn);
    });

    // jackpot modal: tap backdrop to close
    els.modalJackpot?.addEventListener("click", (e) => { if(e.target === els.modalJackpot) closeJackpotModal(); });

    // Pause/resume timing
    let pausedAt = 0;
    document.addEventListener("visibilitychange", () => {
      if(document.hidden){
        pausedAt = performance.now();
        if(machine.raf){
          cancelAnimationFrame(machine.raf);
          machine.raf = 0;
          machine.lastT = 0;
        }
        AudioMgr.stopSpin();
        return;
      }

      AudioMgr.syncSoundOnToggle();

      if(!machine.spinning || !pausedAt) return;
      const now = performance.now();
      const delta = now - pausedAt;
      pausedAt = 0;

      for(const r of machine.reels){
        if(r.phase !== "idle") r.stopTime += delta;
        if(r.stopRampAt) r.stopRampAt += delta;
      }
      if(machine.stopAt) machine.stopAt += delta;

      AudioMgr.startSpin();
      kickRAF();
    }, { passive:true });

    window.addEventListener("keydown", (e) => {
      if(els.modalLogin?.classList.contains("on")){
        if(e.key === "Tab"){ trapFocus(els.modalLogin, e); return; }
        return;
      }
      if(els.modal?.classList.contains("on")){
        if(e.key === "Escape"){ closeModalSettings(); return; }
        if(e.key === "Tab"){ trapFocus(els.modal, e); return; }
        return;
      }
      if(els.modalPrize?.classList.contains("on")){
        if(e.key === "Escape"){ closePrizeModal(); return; }
        if(e.key === "Tab"){ trapFocus(els.modalPrize, e); return; }
        return;
      }
      if(els.modalSymbol?.classList.contains("on")){
        if(e.key === "Escape"){ closeSymbolModal(); return; }
        if(e.key === "Tab"){ trapFocus(els.modalSymbol, e); return; }
        return;
      }
      if(els.modalJackpot?.classList.contains("on")){
        if(e.key === "Escape"){ closeJackpotModal(); return; }
        if(e.key === "Tab"){ trapFocus(els.modalJackpot, e); return; }
        return;
      }

      if(e.key === " " || e.key === "Enter"){
        if(e.key === " ") e.preventDefault();
        AudioMgr.unlock();
        if(!canInput()) return;

        clickFX();
        if(machine.spinning) requestStop();
        else startSpin();
      }
    }, { passive:false });

    window.addEventListener("pointerdown", () => {
      AudioMgr.unlock();
      AudioMgr.syncSoundOnToggle();
    }, { passive:true, once:true });

    let rzTO = 0;
    window.addEventListener("resize", () => {
      clearTimeout(rzTO);
      rzTO = setTimeout(() => {
        if(machine.spinning) return;
        machine.cellPx = measureCellPx();
        for (const r of machine.reels) { r.offset = 0; renderReel(r); }
      }, 120);
    }, { passive:true });

    if(!hadSaved) saveSettings();
  }

  init();
})();
</script>
</body>
</html>