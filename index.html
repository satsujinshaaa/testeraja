<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="referrer" content="no-referrer" />

  <!-- NOTE: isi og:url + canonical dengan URL final halaman kamu -->
  <meta property="og:url" content="" />
  <link rel="canonical" href="" />

  <meta property="og:title" content="MADETOTO2 - Spin & Win" />
  <meta name="description" content="PUTAR RODANYA & DAPATKAN HADIAH FANTASTIS HINGGA 200 RIBU RUPIAH!" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://shortq.org/gmbrmadetoto2" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="MADETOTO2 - Spin & Win" />
  <meta name="twitter:description" content="PUTAR RODANYA &amp; DAPATKAN HADIAH FANTASTIS HINGGA 200 RIBU RUPIAH!" />
  <meta name="twitter:image" content="https://shortq.org/gmbrmadetoto2" />

  <meta name="theme-color" content="#071a12" />
  <link rel="shortcut icon" href="https://shortq.org/gmbrmadetoto2" type="image/x-icon" />

<style>
  /* ======================================================================
   * MT2 — FULL CSS UPDATE (SMOOTH + OPTIMAL)
   * - Motion tokens (durations/easing) konsisten
   * - Hover hanya untuk device yang benar-benar hover (anti “stuck hover” di mobile)
   * - Animasi transform/opacity-friendly (lebih ringan)
   * - Tweaks perf: backface, font smoothing, scroll, shadow balance
   * ====================================================================== */

  /* =========================
   * BASE / TOKENS (PREMIUM — GREEN DEPTH SOFT)
   * ======================= */
  *, *::before, *::after { box-sizing: border-box; }
  * { margin: 0; padding: 0; }

  :root{
    color-scheme: dark;

    /* ✅ softer green depth (less “harsh”, more premium) */
    --bg0: #04110d;
    --bg1: #061c14;
    --bg2: #05271c;

    /* gold metal (keep as rim accent, but more balanced) */
    --gold0: #fff1d3;
    --gold1: #f3b24a;
    --gold2: #7a3f13;

    /* green accents (soft modern) */
    --green0: #d7ffe9;
    --green1: #3be07b;
    --green2: #128a45;

    --text: rgba(255,255,255,0.94);
    --muted: rgba(255,255,255,0.72);
    --muted2: rgba(255,255,255,0.56);

    --card: rgba(59, 224, 123, 0.06);
    --cardBorder: rgba(59, 224, 123, 0.20);

    --radius-lg: 20px;
    --radius-md: 14px;

    /* ✅ smoother shadows (less “overglow”) */
    --shadow-soft: 0 0 56px -16px rgba(59,224,123,0.16);
    --shadow-deep: 0 26px 86px rgba(0,0,0,0.60);

    --ring: rgba(59,224,123,0.56);

    --safe-top: env(safe-area-inset-top, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);

    /* GPU hint */
    --gpu: translate3d(0,0,0);

    /* motion tokens */
    --d-1: 120ms;
    --d-2: 180ms;
    --d-3: 240ms;
    --d-4: 320ms;
    --d-5: 520ms;

    --ease-out: cubic-bezier(0.16, 1, 0.30, 1);
    --ease-in: cubic-bezier(0.60, 0.00, 0.90, 0.35);
    --ease-io: cubic-bezier(0.40, 0.00, 0.20, 1);
    --ease-pop: cubic-bezier(0.20, 0.90, 0.20, 1);

    /* wheel */
    --rim-pad: clamp(12px, 3vw, 15px);
    --inner-safe-scale: 0.986;
    --ease-spin: cubic-bezier(0.15, 0, 0.15, 1);

    /* subtle highlight strength */
    --shine: rgba(255,255,255,0.10);
  }

  html{
    width: 100%;
    height: 100%;
    background: var(--bg0);
    overscroll-behavior: none;
    -webkit-text-size-adjust: 100%;
    text-rendering: optimizeLegibility;
    scrollbar-gutter: stable;
  }

  body{
    min-height: 100svh;
    color: var(--text);
    font-family:
      ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
      "SF Pro Display","SF Pro Text","Segoe UI Variable","Segoe UI",
      Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
    font-kerning: normal;
    overscroll-behavior: none;
    position: relative;
    isolation: isolate;

    background:
      radial-gradient(980px 560px at 82% 14%, rgba(59,224,123,0.12), transparent 62%),
      radial-gradient(920px 620px at 18% 10%, rgba(255,255,255,0.045), transparent 64%),
      radial-gradient(860px 560px at 20% 92%, rgba(20,184,166,0.085), transparent 60%),
      radial-gradient(760px 520px at 72% 84%, rgba(243,178,74,0.045), transparent 66%),
      linear-gradient(135deg, var(--bg0) 0%, var(--bg1) 48%, var(--bg2) 100%);
  }
  @supports (min-height: 100dvh){
    body{ min-height: 100dvh; }
  }

  /* vignette (tight, anti-leak) */
  body::before{
    content:"";
    position: fixed;
    inset: 0;
    pointer-events:none;
    z-index: 0;
    background:
      radial-gradient(1200px 760px at 50% 28%, rgba(255,255,255,0.05), transparent 64%),
      radial-gradient(1400px 920px at 50% 112%, rgba(0,0,0,0.60), transparent 58%),
      radial-gradient(920px 920px at -10% 22%, rgba(0,0,0,0.52), transparent 56%),
      radial-gradient(920px 920px at 110% 22%, rgba(0,0,0,0.50), transparent 56%);
    opacity: 0.92;
    transform: var(--gpu);
  }

  /* subtle grain (softer) */
  body::after{
    content:"";
    position: fixed;
    inset: 0;
    pointer-events:none;
    z-index: 1;
    opacity: 0.045;
    mix-blend-mode: overlay;
    background:
      repeating-linear-gradient(0deg,
        rgba(255,255,255,0.10) 0px,
        rgba(255,255,255,0.10) 1px,
        rgba(0,0,0,0.00) 2px,
        rgba(0,0,0,0.00) 4px
      ),
      repeating-linear-gradient(90deg,
        rgba(255,255,255,0.08) 0px,
        rgba(255,255,255,0.08) 1px,
        rgba(0,0,0,0.00) 2px,
        rgba(0,0,0,0.00) 5px
      );
    transform: var(--gpu);
  }

  @supports (overflow: clip){
    html, body { overflow-x: clip; }
  }
  @supports not (overflow: clip){
    html, body { overflow-x: hidden; }
  }

  body.modal-open { overflow: hidden; }

  img, video, canvas, svg { max-width: 100%; height: auto; display: block; }
  a, button, input { -webkit-tap-highlight-color: transparent; }
  button { touch-action: manipulation; }

  ::selection{
    background: rgba(59,224,123,0.18);
    color: #fff;
  }

  /* =========================
   * PREMIUM FX CANVAS
   * ======================= */
  #fxCanvas{
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 2;
    opacity: 0.78;
    mix-blend-mode: screen;
    transform: var(--gpu);
    will-change: opacity;
  }

  /* =========================
   * LAYOUT
   * ======================= */
  .container{
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    padding-left: calc(20px + var(--safe-left));
    padding-right: calc(20px + var(--safe-right));
    padding-top: calc(20px + var(--safe-top));
    padding-bottom: calc(20px + var(--safe-bottom));
    position: relative;
    z-index: 5;
  }
  @media (max-width: 420px){
    .container{
      padding: 16px;
      padding-left: calc(16px + var(--safe-left));
      padding-right: calc(16px + var(--safe-right));
      padding-top: calc(16px + var(--safe-top));
      padding-bottom: calc(16px + var(--safe-bottom));
    }
  }

  /* =========================
   * HEADER — CLEAN / ANTI GLOW LEAK
   * ======================= */
  header{
    text-align: center;
    padding: clamp(14px, 2.6vw, 18px) clamp(14px, 3vw, 18px);
    position: relative;
    z-index: 10;

    background:
      radial-gradient(900px 220px at 50% -38%, rgba(255,255,255,0.075), transparent 64%),
      radial-gradient(560px 240px at 20% 34%, rgba(59,224,123,0.16), transparent 64%),
      linear-gradient(180deg, rgba(6, 28, 20, 0.86), rgba(4, 16, 12, 0.70));
    border-radius: 16px;
    border: 1px solid rgba(59,224,123,0.20);
    box-shadow:
      0 16px 60px rgba(0,0,0,0.54),
      0 0 0 1px rgba(0,0,0,0.24) inset,
      0 0 40px rgba(59,224,123,0.08);

    overflow: hidden;
    isolation: isolate;
    transform: var(--gpu);

    /* ✅ hard-clip to stop glow leaking */
    -webkit-mask-image: -webkit-radial-gradient(white, black);
    clip-path: inset(0 round 16px);

    container-type: inline-size;
  }

  header::before{
    content:"";
    position:absolute;
    inset:-2px;
    pointer-events:none;
    z-index: 0;
    opacity: 0.30;
    filter: blur(1px);
    background:
      radial-gradient(560px 260px at 18% 28%, rgba(255,255,255,0.095), transparent 66%),
      radial-gradient(680px 280px at 86% 46%, rgba(59,224,123,0.18), transparent 66%),
      radial-gradient(560px 260px at 50% 140%, rgba(20,184,166,0.085), transparent 66%);
  }

  header::after{
    content:"";
    position:absolute;
    inset: 0;
    pointer-events:none;
    z-index: 1;
    opacity: 0.50;
    background:
      linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.00) 46%),
      radial-gradient(900px 240px at 50% -14%, rgba(255,255,255,0.075), transparent 62%);
    mix-blend-mode: overlay;
  }

  .hero-title{
    position: relative;
    z-index: 2;
    font-weight: 1000;
    text-transform: uppercase;
    line-height: 1.05;
    margin: 2px 0 clamp(8px, 1.4vw, 10px);
    text-shadow: 0 16px 40px rgba(0,0,0,0.60);

    display: inline-flex;
    flex-wrap: wrap;
    align-items: baseline;
    justify-content: center;
    gap: 0.42em;

    font-size: clamp(1.18rem, 3.2vw, 2.22rem);
    letter-spacing: clamp(0.06em, 0.22vw, 0.10em);
  }

  .hero-top{
    display: inline;
    font-size: inherit;
    color: rgba(215,255,233,0.92);
    white-space: nowrap;
  }

  .hero-brand{
    display: inline;
    font-size: inherit;
    white-space: nowrap;

    background: linear-gradient(180deg, #d7ffe9 0%, #65f0a3 44%, #3be07b 72%, #128a45 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;

    filter:
      drop-shadow(0 14px 28px rgba(59,224,123,0.14))
      drop-shadow(0 0 14px rgba(59,224,123,0.10));
  }

  .subtitle{
    font-size: clamp(0.74rem, 1.55cqw, 0.92rem);
    color: rgba(215,255,233,0.78);
    font-weight: 850;
    text-transform: uppercase;
    letter-spacing: clamp(0.06em, 0.18cqw, 0.10em);
    position: relative;
    z-index: 2;
    line-height: 1.35;
    text-shadow: 0 10px 24px rgba(0,0,0,0.56);
    max-width: 1100px;
    margin-left: auto;
    margin-right: auto;
    padding-inline: clamp(0px, 1.4cqw, 14px);
    text-wrap: balance;
  }
  @supports not (font-size: 1cqw){
    .subtitle{ font-size: clamp(0.74rem, 2.0vw, 0.92rem); padding-inline: 0; }
  }

  /* =========================
   * MAIN GRID
   * ======================= */
  .main-content{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: clamp(18px, 4vw, 34px);
    align-items: start;
    margin: clamp(18px, 4vw, 28px) 0 40px;
  }
  .main-content > * { min-width: 0; }
  @media (max-width: 900px){
    .main-content{ grid-template-columns: 1fr; gap: 26px; }
  }

  /* =========================
   * WHEEL AREA — CLEAN / SMOOTH
   * ======================= */
  .wheel-container{
    position: relative;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    isolation: isolate;
    background: transparent;
    --wheel-size: min(470px, 92vw, 56svh);
    padding-top: clamp(14px, 3vw, 20px);
    padding-bottom: clamp(22px, 6vw, 46px);
  }
  @supports (height: 100dvh){
    .wheel-container{ --wheel-size: min(470px, 92vw, 56dvh); }
  }

  /* soft beams behind wheel (lighter anim path) */
  .wheel-container::after{
    content:"";
    position:absolute;
    left: 50%;
    top: 22%;
    width: calc(var(--wheel-size) * 1.48);
    height: calc(var(--wheel-size) * 1.48);
    transform: translate3d(-50%, -50%, 0);
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
    background:
      conic-gradient(from -10deg,
        rgba(255,255,255,0.00) 0deg,
        rgba(255,255,255,0.05) 14deg,
        rgba(255,255,255,0.00) 30deg,
        rgba(255,255,255,0.07) 54deg,
        rgba(255,255,255,0.00) 78deg,
        rgba(255,255,255,0.05) 108deg,
        rgba(255,255,255,0.00) 140deg,
        rgba(255,255,255,0.08) 176deg,
        rgba(255,255,255,0.00) 210deg,
        rgba(255,255,255,0.06) 244deg,
        rgba(255,255,255,0.00) 276deg,
        rgba(255,255,255,0.07) 310deg,
        rgba(255,255,255,0.00) 360deg
      ),
      radial-gradient(circle at 50% 50%, rgba(59,224,123,0.12), transparent 64%);
    filter: blur(1.05px);
    opacity: 0.56;
    animation: beamsPulse 5.2s var(--ease-io) infinite;
    transform-origin: 50% 50%;
  }
  @keyframes beamsPulse{
    0%   { opacity: 0.48; transform: translate3d(-50%,-50%,0) rotate(-1deg) scale(0.992); }
    50%  { opacity: 0.70; transform: translate3d(-50%,-50%,0) rotate( 1.3deg) scale(1.01); }
    100% { opacity: 0.48; transform: translate3d(-50%,-50%,0) rotate(-1deg) scale(0.992); }
  }

  .wheel-container::before{
    content:"";
    position: absolute;
    width: var(--wheel-size);
    height: var(--wheel-size);
    left: 50%;
    top: calc(50% - 6px);
    transform: translate3d(-50%, -50%, 0);
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
    background:
      radial-gradient(circle at 50% 60%, rgba(0,0,0,0.74), transparent 64%),
      radial-gradient(circle at 50% 50%, rgba(243,178,74,0.07), transparent 64%),
      radial-gradient(circle at 50% 50%, rgba(59,224,123,0.08), transparent 68%);
    filter: blur(0.30px);
  }

  .wheel-wrapper{
    position: relative;
    width: var(--wheel-size);
    aspect-ratio: 1 / 1;
    height: auto;
    max-width: 100%;
    touch-action: manipulation;
    user-select: none;
    -webkit-user-select: none;
    background: transparent;
    isolation: isolate;
    z-index: 2;
    transform: var(--gpu);
    will-change: transform;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
  }

  /* =========================
   * POINTER (cleaner light)
   * ======================= */
  .pointer{
    position: absolute;
    top: clamp(-34px, -6.4vw, -22px);
    left: 50%;
    transform: translate3d(-50%, 0, 0);
    transform-origin: 50% 18%;
    z-index: 30;
    width: clamp(40px, 10.5vw, 58px);
    height: clamp(56px, 13.6vw, 78px);
    filter:
      drop-shadow(0 18px 30px rgba(0,0,0,0.64))
      drop-shadow(0 0 18px rgba(59,224,123,0.10));
    pointer-events: none;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    will-change: transform;
  }
  .pointer svg { width: 100%; height: 100%; display:block; }

  .pointer.is-spin{ animation: pointerFloat 540ms var(--ease-io) infinite; }
  @keyframes pointerFloat{
    0%   { transform: translate3d(-50%,0,0) rotate(-1.1deg) translateY(0px); }
    50%  { transform: translate3d(-50%,0,0) rotate( 1.7deg) translateY(1px); }
    100% { transform: translate3d(-50%,0,0) rotate(-1.1deg) translateY(0px); }
  }
  .pointer.is-kick{ animation: pointerKick 120ms var(--ease-out) 1; }
  @keyframes pointerKick{
    0%   { transform: translate3d(-50%,0,0) rotate(0deg); }
    45%  { transform: translate3d(-50%,0,0) rotate(var(--kick-deg, -11deg)); }
    100% { transform: translate3d(-50%,0,0) rotate(0deg); }
  }

  /* =========================
   * OUTER RIM — gold metal
   * ======================= */
  .wheel-outer{
    width: 100%;
    height: 100%;
    border-radius: 50%;
    padding: var(--rim-pad);
    position: relative;
    z-index: 2;
    isolation: isolate;
    overflow: hidden;

    background:
      radial-gradient(circle at 28% 18%, rgba(255,255,255,0.24), transparent 46%),
      radial-gradient(circle at 50% 88%, rgba(0,0,0,0.62), transparent 60%),
      conic-gradient(from 14deg,
        rgba(255,255,255,0.28),
        rgba(0,0,0,0.00) 10%,
        rgba(255,255,255,0.10) 18%,
        rgba(0,0,0,0.00) 30%,
        rgba(255,255,255,0.08) 40%,
        rgba(0,0,0,0.00) 54%,
        rgba(255,255,255,0.16) 66%,
        rgba(0,0,0,0.00) 80%,
        rgba(255,255,255,0.28) 100%
      ),
      linear-gradient(180deg,
        rgba(255, 241, 211, 0.98) 0%,
        rgba(243, 178, 74, 0.98) 48%,
        rgba(122, 63, 19, 1.00) 100%
      );

    border: 1px solid rgba(255, 232, 176, 0.28);
    box-shadow:
      var(--shadow-deep),
      0 0 34px rgba(243,178,74,0.12);

    transform: var(--gpu);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
  }

  .wheel-outer > * { position: relative; z-index: 4; }

  .wheel-outer::before{
    content:"";
    position:absolute;
    inset: 0;
    border-radius: 50%;
    pointer-events:none;
    background:
      conic-gradient(from 0deg,
        rgba(255,255,255,0.00) 0deg,
        rgba(255,255,255,0.00) 28deg,
        rgba(255,255,255,0.20) 44deg,
        rgba(255,255,255,0.00) 58deg,
        rgba(255,255,255,0.00) 180deg,
        rgba(255,255,255,0.12) 206deg,
        rgba(255,255,255,0.00) 228deg,
        rgba(255,255,255,0.00) 360deg
      );
    mix-blend-mode: screen;
    opacity: 0.40;
    filter: blur(0.30px);
    animation: rimSheen 6.6s linear infinite;
    transform-origin: 50% 50%;
    z-index: 2;
  }
  @keyframes rimSheen{ to { transform: rotate(360deg) translateZ(0); } }

  .wheel-outer::after{
    content:"";
    position:absolute;
    inset: 7px;
    border-radius: 50%;
    pointer-events:none;
    z-index: 3;
    border: 1px solid rgba(255, 232, 176, 0.22);
    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,0.20),
      inset 0 10px 18px rgba(255,255,255,0.06),
      inset 0 -14px 18px rgba(0,0,0,0.24);
    opacity: 0.96;
  }

  /* =========================
   * WHEEL INNER — STABLE (no @property)
   * ======================= */
  .wheel-inner{
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: var(--wheel-bg, conic-gradient(from 0deg, #064e3b 0deg 60deg, #f8fafc 60deg 120deg, #064e3b 120deg 180deg, #f8fafc 180deg 240deg, #064e3b 240deg 300deg, #f8fafc 300deg 360deg));
    border: 1px solid rgba(255,255,255,0.10);
    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,0.22),
      inset 0 18px 32px rgba(0,0,0,0.34),
      inset 0 -16px 26px rgba(255,255,255,0.05);
    position: relative;
    will-change: transform;
    transform: var(--gpu);
    overflow: hidden;
    isolation: isolate;
    background-clip: padding-box;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    --spin-dur: 6000ms;
  }

  .wheel-inner::before{
    content:"";
    position:absolute;
    inset:0;
    border-radius:50%;
    pointer-events:none;
    background:
      radial-gradient(circle at 32% 24%, rgba(255,255,255,0.15), transparent 58%),
      radial-gradient(circle at 72% 74%, rgba(243,178,74,0.07), transparent 62%),
      radial-gradient(circle at 50% 56%, rgba(0,0,0,0.20), transparent 64%),
      radial-gradient(circle at 50% 50%, rgba(0,0,0,0.10), transparent 72%);
    opacity: 0.70;
    z-index: 2;
    mix-blend-mode: overlay;
    transform: scale(var(--inner-safe-scale)) var(--gpu);
    transform-origin: 50% 50%;
  }

  /* ✅ center-only sweep as real element (transform rotate = stable on iOS) */
  .wheel-corefx{
    position:absolute;
    inset:0;
    border-radius:50%;
    pointer-events:none;
    z-index: 6;
    transform-origin: 50% 50%;
    mix-blend-mode: screen;
    opacity: 0.92;
    filter: blur(0.62px);
    will-change: transform, opacity;

    background:
      conic-gradient(from 0deg,
        rgba(255,255,255,0.00) 0deg,
        rgba(255,255,255,0.16) 26deg,
        rgba(59,224,123,0.26) 58deg,
        rgba(255,255,255,0.00) 96deg,
        rgba(243,178,74,0.14) 140deg,
        rgba(255,255,255,0.00) 220deg,
        rgba(59,224,123,0.18) 294deg,
        rgba(255,255,255,0.00) 360deg
      ),
      radial-gradient(circle at 50% 50%,
        rgba(59,224,123,0.14),
        rgba(0,0,0,0.00) 64%
      );

    -webkit-mask: radial-gradient(circle at 50% 50%,
      rgba(0,0,0,1) 0%,
      rgba(0,0,0,1) 34%,
      rgba(0,0,0,0.86) 46%,
      rgba(0,0,0,0.00) 58%,
      rgba(0,0,0,0.00) 100%
    );
            mask: radial-gradient(circle at 50% 50%,
      rgba(0,0,0,1) 0%,
      rgba(0,0,0,1) 34%,
      rgba(0,0,0,0.86) 46%,
      rgba(0,0,0,0.00) 58%,
      rgba(0,0,0,0.00) 100%
    );

    animation: coreFXRotate 7.0s linear infinite;
  }
  @keyframes coreFXRotate{
    from{ transform: translate3d(0,0,0) scale(var(--inner-safe-scale)) rotate(0deg); }
    to  { transform: translate3d(0,0,0) scale(var(--inner-safe-scale)) rotate(360deg); }
  }

  .wheel-inner.spinning{
    animation: spin-wheel var(--spin-dur) var(--ease-spin) forwards;
  }
  @keyframes spin-wheel{
    from { transform: rotate(var(--from-rotation, 0deg)) translateZ(0); }
    to   { transform: rotate(var(--rotation)) translateZ(0); }
  }

  /* during spin: faster center sweep */
  .wheel-inner.spinning .wheel-corefx{
    opacity: 0.70;
    animation-duration: 1.85s;
  }

  /* prize texts */
  .prize-text{
    position:absolute;
    left:50%;
    top:50%;
    font-weight: 1000;
    font-size: clamp(14px, 3.2vw, 20px);
    user-select:none;
    pointer-events:none;
    white-space:nowrap;
    z-index: 10;
    letter-spacing: 0.55px;
    transform-origin: center center;
    max-width: 74%;
    overflow: hidden;
    text-overflow: ellipsis;

    text-shadow:
      0 2px 0 rgba(0,0,0,0.22),
      0 10px 28px rgba(0,0,0,0.58),
      0 0 20px rgba(255,255,255,0.08);
    -webkit-font-smoothing: antialiased;
  }

  /* =========================
   * CENTER HUB — stable sheen (no @property)
   * ======================= */
  .wheel-center{
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate3d(-50%, -50%, 0);
    width: clamp(62px, 15vw, 78px);
    height: clamp(62px, 15vw, 78px);
    border-radius: 50%;
    overflow: hidden;
    isolation: isolate;

    background:
      radial-gradient(circle at 30% 25%, rgba(255,255,255,0.28), transparent 50%),
      radial-gradient(circle at 55% 65%, rgba(0,0,0,0.34), transparent 66%),
      linear-gradient(180deg,
        rgba(255, 241, 211, 0.96),
        rgba(243,178,74,0.98),
        rgba(122,63,19,1.00)
      );

    border: 1px solid rgba(255, 232, 176, 0.28);
    box-shadow:
      0 22px 54px rgba(0,0,0,0.62),
      0 0 22px rgba(243,178,74,0.14),
      0 0 36px rgba(59,224,123,0.10),
      inset 0 0 0 1px rgba(0,0,0,0.18);

    z-index: 20;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    will-change: transform, filter;
  }

  .wheel-center .hub-sheen{
    position:absolute;
    inset:-10%;
    border-radius:50%;
    pointer-events:none;
    z-index: 0;
    opacity: 0.70;
    mix-blend-mode: screen;
    filter: blur(0.22px);
    will-change: transform;
    background:
      conic-gradient(from 0deg,
        rgba(255,255,255,0.00) 0deg,
        rgba(255,255,255,0.18) 28deg,
        rgba(255,255,255,0.00) 78deg,
        rgba(59,224,123,0.14) 154deg,
        rgba(255,255,255,0.00) 234deg,
        rgba(243,178,74,0.20) 272deg,
        rgba(255,255,255,0.00) 360deg
      );
    animation: hubSheen 7.8s linear infinite;
  }
  @keyframes hubSheen{ to { transform: rotate(360deg) translateZ(0); } }

  .wheel-center::before{
    content:"";
    position:absolute;
    inset: 10%;
    border-radius: 50%;
    background:
      radial-gradient(circle at 30% 25%, rgba(255,255,255,0.09), transparent 56%),
      radial-gradient(circle at 50% 60%, rgba(0,0,0,0.34), transparent 64%),
      linear-gradient(180deg, rgba(10,30,22,0.96), rgba(6,18,14,0.82));
    border: 1px solid rgba(255,255,255,0.10);
    box-shadow: inset 0 0 14px rgba(0,0,0,0.50);
    z-index: 1;
  }

  .wheel-center::after{
    content: "";
    position:absolute;
    left: 50%;
    top: 50%;
    transform: translate3d(-50%, -50%, 0);
    width: clamp(26px, 8vw, 38px);
    height: clamp(26px, 8vw, 38px);
    border-radius: 50%;
    background:
      radial-gradient(circle at 30% 25%, rgba(255,255,255,0.14), transparent 56%),
      radial-gradient(circle at 55% 58%, rgba(0,0,0,0.44), transparent 66%),
      linear-gradient(180deg, rgba(12,12,12,0.96), rgba(22,22,22,0.76));
    border: 1px solid rgba(255,255,255,0.10);
    box-shadow: inset 0 0 14px rgba(0,0,0,0.56);
    z-index: 2;
  }

  .wheel-inner.spinning .wheel-center{
    animation: hubPulse 1.18s var(--ease-io) infinite;
  }
  .wheel-inner.spinning .wheel-center .hub-sheen{
    animation-duration: 1.08s;
  }
  @keyframes hubPulse{
    0%   { filter: drop-shadow(0 0 10px rgba(59,224,123,0.10)); transform: translate3d(-50%,-50%,0) scale(1); }
    50%  { filter: drop-shadow(0 0 20px rgba(59,224,123,0.18)); transform: translate3d(-50%,-50%,0) scale(1.04); }
    100% { filter: drop-shadow(0 0 10px rgba(59,224,123,0.10)); transform: translate3d(-50%,-50%,0) scale(1); }
  }

  /* =========================
   * CARD / INPUT
   * ======================= */
  .input-section{
    background:
      radial-gradient(520px 260px at 18% 10%, rgba(255,255,255,0.05), transparent 62%),
      linear-gradient(135deg, rgba(59,224,123,0.07), rgba(0,0,0,0.30));
    border: 1px solid rgba(59,224,123,0.20);
    border-radius: var(--radius-lg);
    padding: clamp(18px, 4vw, 30px);
    box-shadow:
      0 18px 70px rgba(0,0,0,0.48),
      0 0 56px -18px rgba(59,224,123,0.18);
    margin-bottom: 14px;
    overflow: hidden;
    isolation: isolate;
    position: relative;
    transform: var(--gpu);
  }
  .input-section::before{
    content:"";
    position:absolute;
    inset: -2px;
    pointer-events:none;
    opacity: 0.52;
    background:
      radial-gradient(420px 220px at 20% 15%, rgba(255,255,255,0.09), transparent 66%),
      radial-gradient(520px 260px at 90% 35%, rgba(59,224,123,0.14), transparent 66%);
    filter: blur(0.65px);
  }
  @supports ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
    .input-section{
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
  }

  .input-section h2{
    font-size: clamp(1.18rem, 2.4vw, 1.42rem);
    margin-bottom: 10px;
    text-shadow: 0 10px 26px rgba(0,0,0,0.56);
    letter-spacing: 0.2px;
  }
  .input-section p{
    color: rgba(255, 255, 255, 0.74);
    margin-bottom: 18px;
    font-size: 0.95rem;
    line-height: 1.45;
  }
  label{
    display: block;
    margin-bottom: 10px;
    font-weight: 900;
    color: rgba(255,255,255,0.92);
    letter-spacing: 0.2px;
  }

  input{
    width: 100%;
    height: 54px;
    font-size: 18px;
    text-align: center;
    padding: 0 16px;
    line-height: 54px;
    text-indent: 0;

    background: rgba(255,255,255,0.055);
    border: 1px solid rgba(255,255,255,0.16);
    border-radius: 12px;

    color: rgba(255,255,255,0.94);
    caret-color: rgba(255,255,255,0.92);

    margin-bottom: 14px;
    transition:
      transform var(--d-1) var(--ease-out),
      box-shadow var(--d-3) var(--ease-out),
      border-color var(--d-3) var(--ease-out),
      background var(--d-3) var(--ease-out);

    outline: none;
    appearance: none;
    -webkit-appearance: none;

    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    letter-spacing: 1.2px;

    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,0.30),
      0 10px 30px rgba(0,0,0,0.22);
    -webkit-text-fill-color: rgba(255,255,255,0.94);
    transform: var(--gpu);
  }

  /* hover hanya untuk device yang memang hover */
  @media (hover:hover) and (pointer:fine){
    input:hover{
      border-color: rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.065);
    }
  }

  input:focus{
    border-color: rgba(59,224,123,0.52);
    background: rgba(255,255,255,0.08);
    box-shadow:
      0 0 0 4px rgba(59,224,123,0.14),
      0 18px 46px rgba(0,0,0,0.48);
    transform: translate3d(0,-1px,0);
  }
  input::placeholder{ color: rgba(255,255,255,0.38); letter-spacing: 1.2px; line-height: 54px; opacity: 1; }
  input::-webkit-input-placeholder{ line-height: 54px; opacity: 1; }

  input:-webkit-autofill{
    -webkit-text-fill-color: rgba(255,255,255,0.94);
    transition: background-color 99999s ease-out 0s;
    box-shadow: 0 0 0px 1000px rgba(255,255,255,0.055) inset, 0 10px 30px rgba(0,0,0,0.22);
    border: 1px solid rgba(255,255,255,0.16);
  }

  .primary-btn{
    width: 100%;
    height: 64px;
    font-size: 22px;
    font-weight: 1000;
    letter-spacing: 1.2px;
    color: rgba(0,0,0,0.92);
    border: 1px solid rgba(59,224,123,0.64);
    border-radius: 12px;
    cursor: pointer;

    transition:
      transform var(--d-1) var(--ease-out),
      box-shadow var(--d-3) var(--ease-out),
      background var(--d-3) var(--ease-out),
      opacity var(--d-2) var(--ease-out),
      filter var(--d-3) var(--ease-out);

    box-shadow:
      0 0 42px rgba(59,224,123,0.20),
      0 18px 60px rgba(0,0,0,0.32);

    font-family: inherit;
    position: relative;
    overflow: hidden;
    transform: var(--gpu);
    appearance: none;
    -webkit-appearance: none;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;

    background:
      radial-gradient(240px 96px at 50% -24%, rgba(255,255,255,0.20), rgba(255,255,255,0.00) 62%),
      linear-gradient(to bottom, var(--green1), var(--green2));
  }

  .primary-btn::before{
    content:"";
    position:absolute;
    inset:-2px;
    background: linear-gradient(90deg, rgba(255,255,255,0.0), rgba(255,255,255,0.34), rgba(255,255,255,0.0));
    transform: translate3d(-120%,0,0);
    opacity: 0.74;
    pointer-events:none;
  }

  @media (hover:hover) and (pointer:fine){
    .primary-btn:hover:not(:disabled){
      transform: translate3d(0,-1px,0);
      filter: saturate(1.06) contrast(1.03);
      box-shadow:
        0 0 52px rgba(59,224,123,0.26),
        0 22px 70px rgba(0,0,0,0.34);
      background:
        radial-gradient(260px 104px at 50% -24%, rgba(255,255,255,0.22), rgba(255,255,255,0.00) 64%),
        linear-gradient(to bottom, rgba(215,255,233,0.92), var(--green1));
    }
    .primary-btn:hover:not(:disabled)::before{ animation: sheen 920ms var(--ease-out); }
  }

  @keyframes sheen{
    from { transform: translate3d(-120%,0,0); }
    to   { transform: translate3d(120%,0,0); }
  }

  .primary-btn:active:not(:disabled){
    transform: translate3d(0,0,0) scale(0.992);
    box-shadow:
      0 0 24px rgba(59,224,123,0.18),
      0 16px 54px rgba(0,0,0,0.30);
  }
  .primary-btn:disabled{ opacity: 0.62; cursor: not-allowed; }

  .primary-btn.fx::after{
    content:"";
    position:absolute;
    left: var(--fx-x, 50%);
    top: var(--fx-y, 50%);
    width: 10px;
    height: 10px;
    border-radius: 50%;
    transform: translate3d(-50%, -50%, 0) scale(0);
    background: radial-gradient(circle, rgba(255,255,255,0.66), rgba(59,224,123,0.14), rgba(0,0,0,0.0));
    animation: ripple 520ms var(--ease-out) forwards;
    pointer-events:none;
  }
  @keyframes ripple{
    to { transform: translate3d(-50%, -50%, 0) scale(32); opacity: 0; }
  }

  .secondary-btn{
    width: 100%;
    height: 52px;
    font-size: 16px;
    font-weight: 1000;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.16);
    background:
      radial-gradient(240px 110px at 50% -30%, rgba(255,255,255,0.085), rgba(255,255,255,0.00) 62%),
      rgba(0,0,0,0.44);
    color: rgba(255,255,255,0.92);
    cursor: pointer;

    transition:
      transform var(--d-1) var(--ease-out),
      background var(--d-3) var(--ease-out),
      border-color var(--d-3) var(--ease-out),
      box-shadow var(--d-3) var(--ease-out);

    position: relative;
    overflow: hidden;
    appearance: none;
    -webkit-appearance: none;
    box-shadow: 0 14px 50px rgba(0,0,0,0.28);
    transform: var(--gpu);
  }

  @media (hover:hover) and (pointer:fine){
    .secondary-btn:hover{
      background:
        radial-gradient(240px 110px at 50% -30%, rgba(255,255,255,0.10), rgba(255,255,255,0.00) 64%),
        rgba(0,0,0,0.56);
      border-color: rgba(255,255,255,0.24);
    }
  }
  .secondary-btn:active{ transform: translate3d(0,0,0) scale(0.992); }

  .jackpot-display{ display:flex; flex-direction:column; align-items:center; gap:6px; padding-top:14px; }
  .jackpot-label{ font-size:0.85rem; color: rgba(255,255,255,0.62); }
  .jackpot-amount{
    font-size: 1.24rem;
    font-weight: 1000;
    color: #65f0a3;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    letter-spacing: 1px;
    text-shadow: 0 12px 26px rgba(0,0,0,0.48);
  }
  .jackpot-meta{
    font-size: 0.82rem;
    color: rgba(255,255,255,0.56);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    letter-spacing: 0.3px;
    text-align: center;
  }

  .spun-message{
    text-align: center;
    padding: 13px 14px;
    background: rgba(239, 68, 68, 0.16);
    border: 1px solid rgba(239, 68, 68, 0.44);
    border-radius: 10px;
    color: rgba(248, 113, 113, 0.92);
    margin-bottom: 14px;
    line-height: 1.35;
    box-shadow: 0 16px 44px rgba(0,0,0,0.30);
  }

  /* =========================
   * WINNERS — PREMIUM (FINAL PATCH)
   * ======================= */
  .winners-section{
    position: relative;
    background:
      radial-gradient(680px 320px at 18% 0%, rgba(255,255,255,0.055), transparent 62%),
      radial-gradient(820px 420px at 92% 18%, rgba(59,224,123,0.08), transparent 64%),
      linear-gradient(180deg, rgba(0,0,0,0.30), rgba(0,0,0,0.18));
    border: 1px solid rgba(255,255,255,0.09);
    border-radius: 16px;
    overflow: hidden;
    min-width: 0;
    box-shadow:
      0 22px 78px rgba(0,0,0,0.44),
      0 0 0 1px rgba(0,0,0,0.22) inset;
    isolation: isolate;
    transform: var(--gpu);
  }

  .winners-section::before{
    content:"";
    position:absolute;
    inset:-2px;
    pointer-events:none;
    opacity: 0.55;
    background:
      radial-gradient(520px 220px at 24% 18%, rgba(255,255,255,0.09), transparent 66%),
      radial-gradient(620px 260px at 86% 30%, rgba(59,224,123,0.14), transparent 70%),
      linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.00) 42%);
    filter: blur(0.75px);
  }

  @supports ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
    .winners-section{
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
  }

  .winners-header{
    position: relative;
    display: flex;
    align-items: center;
    gap: 10px;

    padding: 14px 16px;
    font-weight: 1000;
    font-size: 1.02rem;
    letter-spacing: 0.2px;

    background:
      radial-gradient(520px 180px at 22% -24%, rgba(255,255,255,0.11), transparent 60%),
      linear-gradient(to right, rgba(59,224,123,0.22), rgba(59,224,123,0.06));
    border-bottom: 1px solid rgba(59,224,123,0.12);

    text-shadow: 0 10px 26px rgba(0,0,0,0.56);
    z-index: 2;
  }

  .winners-header::after{
    content:"";
    position:absolute;
    left: 0; right: 0; bottom: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.10), transparent);
    opacity: 0.65;
    pointer-events:none;
  }

  .winners-table{
    width: 100%;
    max-height: 320px;
    overflow-x: hidden;
    overflow-y: auto;
    display: block;
    overscroll-behavior: contain;
    scroll-behavior: smooth;
    padding-bottom: 2px;

    scrollbar-width: thin;
    scrollbar-color: rgba(59,224,123,0.28) rgba(0,0,0,0.22);
    -webkit-overflow-scrolling: touch;

    scroll-padding-top: 56px;
  }

  .winners-table::-webkit-scrollbar{ width: 6px; }
  .winners-table::-webkit-scrollbar-track{ background: rgba(0,0,0,0.22); }
  .winners-table::-webkit-scrollbar-thumb{
    background: rgba(59,224,123,0.26);
    border-radius: 999px;
  }
  .winners-table::-webkit-scrollbar-thumb:hover{ background: rgba(59,224,123,0.44); }

  .winners-table-header,
  .winners-table-row{
    display: grid;
    grid-template-columns: 56px minmax(0, 1fr) clamp(120px, 28vw, 170px);
    gap: 10px;
    padding: 12px 16px;
    align-items: center;
    width: 100%;
    min-width: 0;
  }

  .winners-table-header{
    background: rgba(0,0,0,0.72);
    font-weight: 1000;
    color: rgba(215,255,233,0.92);
    position: sticky;
    top: 0;
    z-index: 3;

    border-bottom: 2px solid rgba(59,224,123,0.18);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    isolation: isolate;

    white-space: nowrap;
  }

  .winners-table-header > div{ white-space: nowrap; }

  .winners-table-row{
    border-bottom: 1px solid rgba(255,255,255,0.05);
    position: relative;
    transition:
      transform var(--d-3) var(--ease-out),
      background var(--d-3) var(--ease-out),
      box-shadow var(--d-3) var(--ease-out);
    cursor: default;
    user-select: none;
  }

  .winners-table-row::before{
    content:"";
    position:absolute;
    inset: 0;
    pointer-events:none;
    opacity: 0;
    background: radial-gradient(520px 120px at 50% 50%, rgba(255,255,255,0.06), transparent 62%);
    transition: opacity var(--d-3) var(--ease-out);
  }

  @media (hover:hover) and (pointer:fine){
    .winners-table-row:hover::before{ opacity: 1; }
    .winners-table-row:hover:not(.is-user){ background: rgba(255,255,255,0.022); }
  }

  .winners-table-row.is-user{
    cursor: pointer;
    background: rgba(59,224,123,0.085);
    box-shadow:
      inset 0 0 0 1px rgba(59,224,123,0.18),
      inset 0 0 18px rgba(59,224,123,0.06);
  }

  @media (hover:hover) and (pointer:fine){
    .winners-table-row.is-user:hover{
      background: rgba(59,224,123,0.11);
      box-shadow:
        inset 0 0 0 1px rgba(59,224,123,0.24),
        0 12px 38px rgba(0,0,0,0.26);
      transform: translate3d(0,-1px,0);
    }
  }

  .winner-no{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    color: rgba(255,255,255,0.62);
    text-align: center;
    white-space: nowrap;
    font-variant-numeric: tabular-nums;
  }

  .winner-id{
    font-weight: 1000;
    color: rgba(255,255,255,0.96);
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    letter-spacing: 0.15px;
  }

  .winner-meta{
    font-size: 0.85rem;
    color: rgba(255,255,255,0.56);
    margin-top: 2px;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .winner-prize{
    text-align: right;
    font-weight: 1000;
    color: #65f0a3;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-variant-numeric: tabular-nums;
    text-shadow: 0 10px 26px rgba(0,0,0,0.40);
  }

  /* new row animations */
  @keyframes rowIn{
    from{ opacity:0; transform: translate3d(0,-8px,0); }
    to  { opacity:1; transform: translate3d(0,0,0); }
  }
  @keyframes shimmer{
    from{ transform: translate3d(-70%,0,0); opacity: 0; }
    15%{ opacity: 1; }
    to  { transform: translate3d(70%,0,0); opacity: 0; }
  }

  .winners-table-row.is-new{
    animation: rowIn 240ms var(--ease-out);
    background: linear-gradient(90deg, rgba(59,224,123,0.14), rgba(255,255,255,0.03));
    box-shadow:
      inset 0 0 0 1px rgba(59,224,123,0.20),
      inset 0 0 22px rgba(59,224,123,0.06);
  }

  .winners-table-row.is-new::after{
    content:"";
    position:absolute;
    inset: 0;
    pointer-events:none;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.22), transparent);
    transform: translate3d(-70%,0,0);
    animation: shimmer 980ms var(--ease-out) forwards;
  }

  /* =========================
   * MOBILE — KEEP 3 COLUMNS (fix “HADIAH turun”)
   * ======================= */
  @media (max-width: 420px){
    .winners-header{
      padding: 10px 12px;
      font-size: 0.95rem;
      gap: 8px;
    }

    .winners-table-header,
    .winners-table-row{
      padding: 10px 12px;
      gap: 8px;
      grid-template-columns: 40px minmax(0, 1fr) clamp(88px, 26vw, 130px);
    }

    .winners-table-header{ font-size: 0.90rem; }

    .winner-no{ font-size: 0.85rem; }
    .winner-id{ font-size: 0.95rem; }
    .winner-meta{ font-size: 0.78rem; }
    .winner-prize{ font-size: 0.95rem; }
  }

  @media (max-width: 360px){
    .winners-table-header,
    .winners-table-row{
      grid-template-columns: 36px minmax(0, 1fr) clamp(84px, 28vw, 118px);
    }
    .winners-header{ font-size: 0.92rem; }
    .winners-table-header{ font-size: 0.88rem; }
  }

  /* =========================
   * MODAL
   * ======================= */
  .modal{
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.78);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: calc(14px + var(--safe-top)) calc(14px + var(--safe-right)) calc(14px + var(--safe-bottom)) calc(14px + var(--safe-left));
  }
  .modal.show { display: flex; animation: modalFade var(--d-3) var(--ease-out); }
  @keyframes modalFade{ from{ opacity:0; } to{ opacity:1; } }

  .modal-content{
    background:
      radial-gradient(520px 280px at 18% 10%, rgba(255,255,255,0.05), transparent 62%),
      linear-gradient(135deg, rgba(6,18,14,0.98), rgba(7,30,22,0.96));
    border: 1px solid rgba(59,224,123,0.52);
    border-radius: 20px;
    padding: clamp(18px, 4vw, 40px);
    text-align: center;
    max-width: 520px;
    width: 100%;
    box-shadow:
      0 0 72px rgba(59,224,123,0.14),
      0 28px 90px rgba(0,0,0,0.60);
    animation: zoomIn 0.22s var(--ease-out);
    max-height: min(84svh, 720px);
    overflow: auto;
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(59,224,123,0.26) rgba(0,0,0,0.22);
    transform: var(--gpu);
  }
  @supports (max-height: 84dvh){
    .modal-content{ max-height: min(84dvh, 720px); }
  }
  @keyframes zoomIn {
    from { opacity: 0; transform: translate3d(0,8px,0) scale(0.96); }
    to   { opacity: 1; transform: translate3d(0,0,0) scale(1); }
  }

  .modal-content h1 { font-size: clamp(1.8rem, 3.4vw, 2.5rem); margin-bottom: 8px; text-shadow: 0 14px 34px rgba(0,0,0,0.56); }
  .modal-content p { color: rgba(255, 255, 255, 0.84); margin-bottom: 14px; font-size: 1.05rem; line-height: 1.45; }

  .prize-amount{
    font-size: clamp(2rem, 6vw, 3rem);
    font-weight: 1000;
    color: var(--green0);
    margin: 18px 0 10px;
    line-height: 1.1;
    text-shadow: 0 18px 44px rgba(0,0,0,0.60);
  }
  .prize-meta{
    font-size: 0.95rem;
    color: rgba(255,255,255,0.72);
    margin-top: 4px;
    line-height: 1.4;
  }
  .mono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    letter-spacing: 0.6px;
    color: rgba(255,255,255,0.92);
    font-weight: 900;
  }

  .modal-actions{
    display:flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 16px;
    align-items: center;
  }
  .modal-actions .primary-btn{ max-width: 320px; height: 58px; font-size: 20px; }
  .modal-actions .secondary-btn{ max-width: 320px; height: 52px; font-size: 16px; }

  /* =========================
   * TOAST
   * ======================= */
  .toast{
    position: fixed;
    left: 50%;
    bottom: calc(18px + var(--safe-bottom));
    transform: translate3d(-50%,0,0);
    z-index: 1200;
    width: min(520px, calc(100vw - 28px));
    background: rgba(0,0,0,0.74);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 14px;
    padding: 12px 14px;
    display: none;
    gap: 10px;
    align-items: center;
    box-shadow: 0 20px 70px rgba(0,0,0,0.56);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    isolation: isolate;
  }
  .toast.show{
    display: flex;
    animation: toastIn var(--d-2) var(--ease-out);
  }
  @keyframes toastIn {
    from { opacity: 0; transform: translate3d(-50%,6px,0); }
    to   { opacity: 1; transform: translate3d(-50%,0,0); }
  }

  .toast .dot{
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--green1);
    box-shadow: 0 0 14px rgba(59,224,123,0.34);
    flex: 0 0 auto;
  }
  .toast .msg{ color: rgba(255,255,255,0.94); font-weight: 900; line-height: 1.3; font-size: 0.98rem; }
  .toast.error .dot{ background: #ef4444; box-shadow: 0 0 14px rgba(239,68,68,0.34); }
  .toast.success .dot{ background: #65f0a3; box-shadow: 0 0 14px rgba(59,224,123,0.30); }

  /* =========================
   * LOADING OVERLAY (CLAIM)
   * ======================= */
  .nav-loading{
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;

    background: rgba(0,0,0,0.78);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);

    padding: calc(14px + var(--safe-top)) calc(14px + var(--safe-right)) calc(14px + var(--safe-bottom)) calc(14px + var(--safe-left));

    opacity: 0;
    visibility: hidden;
    pointer-events: none;

    transform: var(--gpu);
    transition:
      opacity var(--d-3) var(--ease-out),
      visibility 0s linear var(--d-3);
    isolation: isolate;
  }
  .nav-loading.show{
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    transition: opacity var(--d-3) var(--ease-out), visibility 0s;
  }

  .nav-loading-card{
    width: min(520px, calc(100vw - 28px));
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,0.10);
    background:
      radial-gradient(520px 240px at 18% 10%, rgba(255,255,255,0.05), transparent 62%),
      linear-gradient(135deg, rgba(6,18,14,0.98), rgba(7,30,22,0.96));
    box-shadow: 0 25px 90px rgba(0,0,0,0.64);
    padding: 18px 18px;
    display: flex;
    gap: 12px;
    align-items: center;
    transform: translate3d(0,4px,0);
    transition: transform var(--d-3) var(--ease-out);
  }
  .nav-loading.show .nav-loading-card{ transform: translate3d(0,0,0); }

  .nav-spinner{
    width: 34px;
    height: 34px;
    border-radius: 999px;
    border: 3px solid rgba(255,255,255,0.14);
    border-top-color: rgba(59,224,123,0.90);
    animation: navSpin 820ms linear infinite;
    flex: 0 0 auto;
  }
  @keyframes navSpin{ to{ transform: rotate(360deg); } }

  .nav-title{ font-weight: 1000; color: rgba(255,255,255,0.94); line-height: 1.2; }
  .nav-sub{ font-size: 0.92rem; color: rgba(255,255,255,0.62); margin-top: 2px; }

  /* =========================
   * ACCESSIBILITY + REDUCED MOTION
   * ======================= */
  :focus-visible{
    outline: 3px solid var(--ring);
    outline-offset: 3px;
    border-radius: 10px;
  }

  /* =========================
   * LOW-END DOWNGRADE (auto by JS)
   * ======================= */
  body.low-end #fxCanvas{ opacity: 0.52; }
  body.low-end::after{ opacity: 0.028; }
  body.low-end .wheel-container::after{ opacity: 0.35; filter: blur(0.85px); }
  body.low-end .wheel-outer{ box-shadow: 0 22px 70px rgba(0,0,0,0.58), 0 0 26px rgba(243,178,74,0.09); }
  body.low-end .wheel-corefx{ opacity: 0.78; filter: blur(0.48px); }

  @supports (-webkit-touch-callout: none){
    /* Safari safety: tone down blend a bit to avoid harsh/patchy rendering */
    .wheel-corefx{ opacity: 0.88; }
    header::after{ opacity: 0.46; }
  }

  /* update: slow = device refresh lambat (bonus guard) */
  @media (prefers-reduced-motion: reduce), (update: slow){
    * { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
    .winners-table-row.is-new::after { display: none !important; }
    .nav-spinner{ animation: none !important; }
    #fxCanvas{ display:none !important; }
    .wheel-outer::before{ display:none !important; }
    .wheel-container::after{ display:none !important; }
    body::after{ display:none !important; }
    .wheel-corefx{ display:none !important; }
  }
</style>

</head>

<body>
  <canvas id="fxCanvas" aria-hidden="true"></canvas>

  <div class="container" id="mainContainer">
    <header>
      <h1 class="hero-title">
        <span class="hero-top">SELAMAT DATANG DI</span>
        <span class="hero-brand">MADETOTO2</span>
      </h1>
      <p class="subtitle">PUTAR RODANYA &amp; DAPATKAN HADIAH FANTASTIS HINGGA 200 RIBU RUPIAH!</p>
    </header>

    <div class="main-content">
      <div class="wheel-container">
        <div class="wheel-wrapper" id="wheelWrap">
          <div class="pointer" id="pointerEl" aria-hidden="true">
            <svg viewBox="0 0 64 90" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="metal" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0" stop-color="rgba(255,255,255,0.90)"/>
                  <stop offset="0.24" stop-color="rgba(195,195,195,0.92)"/>
                  <stop offset="0.56" stop-color="rgba(88,88,88,0.96)"/>
                  <stop offset="1" stop-color="rgba(18,18,18,0.98)"/>
                </linearGradient>
                <linearGradient id="gold" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0" stop-color="#FFF4D6"/>
                  <stop offset="0.52" stop-color="#F6B33D"/>
                  <stop offset="1" stop-color="#8A4A16"/>
                </linearGradient>
                <radialGradient id="cap" cx="35%" cy="30%" r="70%">
                  <stop offset="0" stop-color="rgba(255,255,255,0.98)"/>
                  <stop offset="0.45" stop-color="#FFF4D6"/>
                  <stop offset="1" stop-color="#B45309"/>
                </radialGradient>
              </defs>

              <path
                d="M32 86 L10 34 C10 34 14 10 32 10 C50 10 54 34 54 34 L32 86 Z"
                fill="url(#gold)"
                stroke="rgba(255,255,255,0.22)"
                stroke-width="2"
              />
              <path
                d="M32 80 L18 36 C18 36 20 18 32 18 C44 18 46 36 46 36 L32 80 Z"
                fill="url(#metal)"
                opacity="0.96"
              />
              <circle
                cx="32"
                cy="27"
                r="11"
                fill="url(#cap)"
                stroke="rgba(0,0,0,0.22)"
                stroke-width="2"
              />
              <circle
                cx="32"
                cy="27"
                r="4.2"
                fill="rgba(10,10,10,0.78)"
                stroke="rgba(255,255,255,0.16)"
                stroke-width="1.5"
              />
            </svg>
          </div>

          <div class="wheel-outer">
            <div class="wheel-inner" id="wheel" aria-label="Lucky wheel">
              <div class="wheel-corefx" aria-hidden="true"></div>
              <div class="wheel-center" aria-hidden="true">
                <span class="hub-sheen" aria-hidden="true"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="input-section">
          <h2>MASUKKAN USER ID</h2>
          <p>Masukkan User ID Anda untuk memutar roda keberuntungan.</p>

          <label for="userIdInput">User ID</label>
          <input
            type="text"
            id="userIdInput"
            placeholder="Contoh: User123"
            maxlength="20"
            autocomplete="off"
            autocapitalize="off"
            autocorrect="off"
            spellcheck="false"
            inputmode="text"
          />

          <button id="spinBtn" class="primary-btn" type="button">SPIN SEKARANG!</button>

          <div class="jackpot-display" aria-live="polite">
            <div class="jackpot-label">Total Jackpot</div>
            <div class="jackpot-amount" id="jackpot">IDR 888.888.888</div>
            <div class="jackpot-meta" id="jackpotMeta">Update: --:--:--</div>
          </div>
        </div>

        <div id="spunMessage" class="spun-message" style="display:none;">
          Kesempatan spin Anda sudah habis. Silakan klaim hadiah Anda.
        </div>

        <div class="winners-section">
          <div class="winners-header">🏆 50 Riwayat Spin Terakhir</div>
          <div class="winners-table" id="winnersTable" aria-live="polite">
            <div class="winners-table-header">
              <div>NO</div>
              <div>USER ID</div>
              <div>HADIAH</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true">
    <div class="dot" aria-hidden="true"></div>
    <div class="msg" id="toastMsg">Toast</div>
  </div>

  <div
    class="modal"
    id="prizeModal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="prizeTitle"
    aria-hidden="true"
  >
    <div class="modal-content" role="document">
      <h1 id="prizeTitle">SELAMAT!</h1>
      <p>Anda memenangkan hadiah:</p>
      <div class="prize-amount" id="prizeAmount">BONUS 10%</div>

      <div class="prize-meta">
        User ID: <span class="mono" id="modalUserId">-</span><br/>
        Waktu: <span class="mono" id="modalTime">-</span>
      </div>

      <p style="margin-top: 14px;">Silakan klaim melalui Live Chat dan sertakan User ID.</p>

      <!-- UPDATED: Unduh kecil + tombol Bagikan -->
      <div class="modal-actions">
  <button type="button" class="primary-btn modal-primary" id="claimBtn">KLAIM SEKARANG</button>

  <button type="button" class="secondary-btn is-compact" id="downloadBtn" aria-label="Unduh hasil">
    UNDUH HASIL
  </button>

  <button type="button" class="secondary-btn is-compact" id="shareBtn" aria-label="Bagikan hasil">
    BAGIKAN
  </button>
</div>

      <div class="prize-meta" style="margin-top:10px;">
        Klik tombol unduh akan tersimpan otomatis di perangkat dan bagikan untuk ke sosial media Anda.
      </div>
    </div>
  </div>

  <div class="nav-loading" id="navLoading" aria-hidden="true">
    <div class="nav-loading-card" role="status" aria-live="polite" aria-atomic="true">
      <div class="nav-spinner" aria-hidden="true"></div>
      <div>
        <div class="nav-title">Menghubungkan…</div>
        <div class="nav-sub">Mengarahkan ke halaman Server</div>
      </div>
    </div>
  </div>

  <!-- Chaport Live Chat -->
  <script type="text/javascript">
    (function(w,d,v3){
      w.chaportConfig = { appId : '6937b4ead2823b3f94b0a834' };
      if(w.chaport) return;
      v3 = w.chaport = {};
      v3._q = [];
      v3._l = {};
      v3.q = function(){ v3._q.push(arguments) };
      v3.on = function(e,fn){ if(!v3._l[e]) v3._l[e]=[]; v3._l[e].push(fn) };
      var s = d.createElement('script');
      s.type = 'text/javascript';
      s.async = true;
      s.src = 'https://app.chaport.com/javascripts/insert.js';
      var ss = d.getElementsByTagName('script')[0];
      ss.parentNode.insertBefore(s, ss);
    })(window, document);
  </script>

  <!-- Audio -->
  <audio id="bgMusic" loop playsinline preload="auto"></audio>
  <audio id="spinSound" playsinline preload="auto"></audio>
  <audio id="tickSound" playsinline preload="auto"></audio>
  <audio id="winSound" playsinline preload="auto"></audio>
  <audio id="historySound" playsinline preload="auto"></audio>

  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>
		
		<script>
/* ======================================================================
 * MT2 — FULL REPLACE (Wheel + Audio Casino Sync vFINAL)
 * ✅ Anti double-init + cleanup total (raf/timers/observers/spin/audio)
 * ✅ Spin engine RAF-based (no CSS animation drift) → tick benar2 sinkron
 * ✅ Tick = segment-crossing (realistic), anti “loop aneh”, anti burst
 * ✅ Audio casino feel: bg fade-in, spin whoosh + fade-out, win punch
 * ✅ Semua variabel pakai state S (hapus bug: hasSpun/isSpin/tickPool undefined)
 * ✅ Modal trapFocus aman (export trapFocus), history/jackpot/confetti/share tetap
 * ====================================================================== */

/* -------------------------
 * Anti double-init / cleanup
 * ------------------------- */
const MT2_SYS = window.__MT2_SYS || (window.__MT2_SYS = {});
if (MT2_SYS._cleanup) { try { MT2_SYS._cleanup(); } catch(_){} }

MT2_SYS._off = [];
MT2_SYS._timers = [];
MT2_SYS._rafs = [];
MT2_SYS._obs = [];

MT2_SYS._cleanup = () => {
  for (const off of MT2_SYS._off) { try { off(); } catch(_){} }
  MT2_SYS._off.length = 0;

  for (const t of MT2_SYS._timers) {
    try { clearTimeout(t); } catch(_){}
    try { clearInterval(t); } catch(_){}
  }
  MT2_SYS._timers.length = 0;

  for (const r of MT2_SYS._rafs) { try { cancelAnimationFrame(r); } catch(_){} }
  MT2_SYS._rafs.length = 0;

  for (const o of MT2_SYS._obs) { try { o.disconnect(); } catch(_){} }
  MT2_SYS._obs.length = 0;

  // stop fx instance (if any)
  if (MT2_SYS._fx && typeof MT2_SYS._fx.stop === "function") {
    try { MT2_SYS._fx.stop(); } catch(_){}
  }
  MT2_SYS._fx = null;

  // stop confetti instance (if any)
  if (window.__MT2_CONF && window.__MT2_CONF._fx && typeof window.__MT2_CONF._fx.reset === "function") {
    try { window.__MT2_CONF._fx.reset(); } catch(_){}
  }

  // stop spin engine
  if (MT2_SYS._state) {
    const S = MT2_SYS._state;
    S.spinToken = (S.spinToken || 0) + 1; // cancel running loops
    if (S._spinRaf) { try { cancelAnimationFrame(S._spinRaf); } catch(_){} }
    S._spinRaf = 0;
  }

  // stop audio safely
  try {
    const ids = ["bgMusic","spinSound","tickSound","winSound","historySound"];
    for (const id of ids) {
      const a = document.getElementById(id);
      if (a && a.pause) { try { a.pause(); } catch(_){} }
    }
  } catch(_){}
};

// helpers (tracked)
function _on(el, ev, fn, opt){
  if (!el || !el.addEventListener) return;
  el.addEventListener(ev, fn, opt);
  MT2_SYS._off.push(() => { try { el.removeEventListener(ev, fn, opt); } catch(_){} });
}
function _st(fn, ms){ const id = setTimeout(fn, ms); MT2_SYS._timers.push(id); return id; }
function _si(fn, ms){ const id = setInterval(fn, ms); MT2_SYS._timers.push(id); return id; }
function _raf(fn){ const id = requestAnimationFrame(fn); MT2_SYS._rafs.push(id); return id; }

const $ = (id)=> document.getElementById(id);

/* =========================
 * CONFIG
 * ========================= */
const CONFIG = {
  SPIN_DURATION_MS: 6200,
  CLAIM_URL: "https://newmadetoto2.com/",
  CLAIM_OVERLAY_MIN_MS: 700,

  SCROLL: {
    ENABLED: true,
    AUTO_FOCUS_ON_SPIN: true,
    FORCE_ON_MOBILE: true,
    FOCUS_CLASS_MS: 650
  },

  JACKPOT: {
    SEED_MIN: 880_000_000,
    SEED_MAX: 930_000_000,
    FLOOR: 800_000_000,
    SPEED_MIN: 1800,
    SPEED_MAX: 9800,
    SPIKE_CHANCE: 0.0014,
    SPIKE_MIN: 2.0,
    SPIKE_MAX: 4.6,
    SPIKE_MS_MIN: 1600,
    SPIKE_MS_MAX: 4200,
    SAVE_EVERY_MS: 3000
  },

  HISTORY: {
    LIVE_MIN_MS: 5200,
    LIVE_MAX_MS: 12500,
    META_TICK_MS: 15000,
    UNIQUE_POOL: 70
  },

  LS_PREFIX: "mt2_spin_v2:",
  PRIZES: ["25K", "50K", "75K", "100K", "200K", "BONUS 10%"],
  BONUS_LABEL: "BONUS 10%",

  PRIZE_DISPLAY_MAP: {
    "25K": "IDR 25.000",
    "50K": "IDR 50.000",
    "75K": "IDR 75.000",
    "100K": "IDR 100.000",
    "200K": "IDR 200.000",
    "BONUS 10%": "BONUS 10%",
  },

  AUDIO: {
    bg: "https://cdn.pixabay.com/download/audio/2022/03/24/audio_197846c632.mp3?filename=casino-music-1-2518.mp3",
    spin: "https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3",
    win: "https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3",
    tick: "https://assets.mixkit.co/active_storage/sfx/2063/2063-preview.mp3",
    history: "https://assets.mixkit.co/active_storage/sfx/2014/2014-preview.mp3",
    vol: { bg: 0.22, spin: 0.58, win: 0.12, tick: 0.46, history: 0.40 },

    // casino feel
    bgFadeMs: 900,
    spinLoop: true,
    spinFadeOutMs: 240,
    tickMinGapMs: 26,
    tickPitchRand: 0.06,   // ±6%
    tickVolJitter: 0.08    // ±8%
  },

  WHEEL_SVG: {
    VIEW: 1000,
    OUTER_R: 492,
    INNER_R: 170,
    LABEL_R1: 305,
    LABEL_R2: 338,
    LABEL_PAD_DEG_MIN: 6,
    LABEL_PAD_DEG_MAX: 11
  }
};

const LS = {
  HAS_SPUN:     CONFIG.LS_PREFIX + "hasSpun",
  SPIN_AT:      CONFIG.LS_PREFIX + "spinAt",
  LAST_USER_ID: CONFIG.LS_PREFIX + "lastUserId",
  JACKPOT_VAL:  CONFIG.LS_PREFIX + "jackpotVal",
  ROTATION:     CONFIG.LS_PREFIX + "rotation"
};

const PRIZES = CONFIG.PRIZES.slice();
const BONUS_LABEL = CONFIG.BONUS_LABEL;
const BONUS_INDEX = PRIZES.indexOf(BONUS_LABEL);

/* =========================
 * Utils
 * ========================= */
const _memStore = new Map();
function lsGet(key, fallback = "") {
  try {
    const v = localStorage.getItem(key);
    return (v == null ? fallback : v);
  } catch (_) {
    return (_memStore.has(key) ? _memStore.get(key) : fallback);
  }
}
function lsSet(key, value) {
  const s = String(value);
  try { localStorage.setItem(key, s); }
  catch (_) { _memStore.set(key, s); }
}

function migrateLegacyKeys() {
  const legacy = { hasSpun:"hasSpun", spinAt:"spinAt", lastUserId:"lastUserId", jackpotVal:"jackpotVal", rotation:"rotation" };
  try {
    if (!lsGet(LS.HAS_SPUN, "") && lsGet(legacy.hasSpun, "")) lsSet(LS.HAS_SPUN, lsGet(legacy.hasSpun, ""));
    if (!lsGet(LS.SPIN_AT, "") && lsGet(legacy.spinAt, "")) lsSet(LS.SPIN_AT, lsGet(legacy.spinAt, ""));
    if (!lsGet(LS.LAST_USER_ID, "") && lsGet(legacy.lastUserId, "")) lsSet(LS.LAST_USER_ID, lsGet(legacy.lastUserId, ""));
    if (!lsGet(LS.JACKPOT_VAL, "") && lsGet(legacy.jackpotVal, "")) lsSet(LS.JACKPOT_VAL, lsGet(legacy.jackpotVal, ""));
    if (!lsGet(LS.ROTATION, "") && lsGet(legacy.rotation, "")) lsSet(LS.ROTATION, lsGet(legacy.rotation, ""));
  } catch (_) {}
}
migrateLegacyKeys();

function pad2(n) { return String(n).padStart(2, "0"); }
function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

const _rmq = (window.matchMedia ? window.matchMedia("(prefers-reduced-motion: reduce)") : null);
function isReducedMotion(){ return !!(_rmq && _rmq.matches); }

function normalizeUserIdInput(v){
  return String(v==null?"":v).replace(/\s+/g,"").slice(0, 20);
}

function detectLowEnd(){
  try{
    const devMem = Number(navigator.deviceMemory || 0) || 0;
    const cores = Number(navigator.hardwareConcurrency || 0) || 0;
    const saveData = !!(navigator.connection && navigator.connection.saveData);
    const low = (saveData) || (devMem && devMem <= 2) || (cores && cores <= 4);
    if (low) document.body.classList.add("low-end");
    return low;
  }catch(_){ return false; }
}

/* =========================
 * State (single source)
 * ========================= */
const S = MT2_SYS._state = MT2_SYS._state || {};

S.hasSpun = (S.hasSpun != null) ? S.hasSpun : (lsGet(LS.HAS_SPUN, "false") === "true");
S.spinAt = (S.spinAt != null) ? S.spinAt : (Number(lsGet(LS.SPIN_AT, "0") || "0") || 0);
S.savedUserId = (S.savedUserId != null) ? S.savedUserId : String(lsGet(LS.LAST_USER_ID, "") || "");
S.isSpin = !!S.isSpin;

S.currentRotation = (S.currentRotation != null) ? S.currentRotation : (Number(lsGet(LS.ROTATION, "0") || "0") || 0);
S.lastResult = S.lastResult || null;

S.winners = Array.isArray(S.winners) ? S.winners : [];
S.rowElById = S.rowElById || new Map();
S.winnersById = S.winnersById || new Map();

S.liveTimer = S.liveTimer || 0;
S.metaTimer = S.metaTimer || 0;

S.pauseReasons = S.pauseReasons || new Set();
S.inertReasons = S.inertReasons || new Set();

S.jackpot = S.jackpot || 0;
S.jackpotTimer = S.jackpotTimer || 0;
S.jackpotSaveTimer = S.jackpotSaveTimer || 0;
S.spikeUntilMs = S.spikeUntilMs || 0;
S.spikeMul = S.spikeMul || 1;

S.toastTimer = S.toastTimer || 0;

S.audioPrimed = !!S.audioPrimed;
S.bgStarted = !!S.bgStarted;

S.tickPool = Array.isArray(S.tickPool) ? S.tickPool : [];
S.tickPoolIdx = S.tickPoolIdx || 0;
S.historyPool = Array.isArray(S.historyPool) ? S.historyPool : [];
S.historyPoolIdx = S.historyPoolIdx || 0;
S.historySfxAt = S.historySfxAt || 0;

S.nonUserToastAt = S.nonUserToastAt || 0;

S.spinToken = S.spinToken || 0;
S._spinRaf = S._spinRaf || 0;

S.recentMasked = S.recentMasked || new Set();
S.recentMaskedQueue = Array.isArray(S.recentMaskedQueue) ? S.recentMaskedQueue : [];

// runtime refs
S.pointerEl = S.pointerEl || null;
S.wheelEl = S.wheelEl || null;

/* =========================
 * Pause / Inert
 * ========================= */
function stopLiveHistory(){ if (S.liveTimer) { clearTimeout(S.liveTimer); } S.liveTimer = 0; }
function pauseHistory(reason){ S.pauseReasons.add(String(reason||"x")); stopLiveHistory(); }
function resumeHistory(reason){
  S.pauseReasons.delete(String(reason||"x"));
  if (S.pauseReasons.size === 0 && !document.hidden) startLiveHistory();
}

function setInert(reason, on){
  const main = $("mainContainer");
  if (!main) return;

  const r = String(reason || "x");
  if (on) S.inertReasons.add(r);
  else S.inertReasons.delete(r);

  const should = S.inertReasons.size > 0;
  try{
    if (should) {
      main.setAttribute("inert", "");
      main.setAttribute("aria-hidden", "true");
    } else {
      main.removeAttribute("inert");
      main.removeAttribute("aria-hidden");
    }
  }catch(_){}
}

/* =========================
 * BUTTON FX + TOAST
 * ========================= */
function pressFX(btn, ev) {
  if (!btn) return;
  const rect = btn.getBoundingClientRect();
  let x = rect.width / 2, y = rect.height / 2;
  if (ev && ev.clientX != null && ev.clientY != null) { x = ev.clientX - rect.left; y = ev.clientY - rect.top; }
  btn.style.setProperty("--fx-x", x + "px");
  btn.style.setProperty("--fx-y", y + "px");
  btn.classList.remove("fx");
  void btn.offsetWidth;
  btn.classList.add("fx");
  _st(() => btn.classList.remove("fx"), 560);
  try { if (navigator.vibrate && !isReducedMotion()) navigator.vibrate(12); } catch (_) {}
}

function showToast(message, type = "info", ms = 2400) {
  const toast = $("toast");
  const msg = $("toastMsg");
  if (!toast || !msg) return;

  toast.classList.remove("error", "success", "muted");
  if (type === "error") toast.classList.add("error");
  if (type === "success") toast.classList.add("success");
  if (type === "muted") toast.classList.add("muted");

  msg.textContent = String(message || "");
  toast.classList.add("show");

  if (S.toastTimer) clearTimeout(S.toastTimer);
  S.toastTimer = _st(() => toast.classList.remove("show"), ms);
}

/* =========================
 * AUDIO (casino-grade, stable)
 * ========================= */
function _makePool(src, count, vol){
  const arr = [];
  for (let i = 0; i < count; i++) {
    const a = new Audio(src);
    a.preload = "auto";
    a.volume = clamp(Number(vol || 0.5), 0, 1);
    a.crossOrigin = "anonymous";
    arr.push(a);
  }
  return arr;
}

function setupAudio() {
  const bgMusic = $("bgMusic");
  const spinSound = $("spinSound");
  const tickSound = $("tickSound");
  const winSound = $("winSound");
  const historySound = $("historySound");

  if (!bgMusic || !spinSound || !tickSound || !winSound || !historySound) return;

  bgMusic.src = CONFIG.AUDIO.bg;
  spinSound.src = CONFIG.AUDIO.spin;
  winSound.src = CONFIG.AUDIO.win;
  tickSound.src = CONFIG.AUDIO.tick;
  historySound.src = CONFIG.AUDIO.history;

  bgMusic.loop = true;
  spinSound.loop = !!CONFIG.AUDIO.spinLoop;

  bgMusic.volume = 0; // fade-in nanti
  spinSound.volume = clamp(CONFIG.AUDIO.vol.spin, 0, 1);
  winSound.volume = clamp(CONFIG.AUDIO.vol.win, 0, 1);
  tickSound.volume = clamp(CONFIG.AUDIO.vol.tick, 0, 1);
  historySound.volume = clamp(CONFIG.AUDIO.vol.history, 0, 1);

  // pools for low-latency
  S.tickPool = _makePool(tickSound.src, 8, tickSound.volume);
  S.tickPoolIdx = 0;

  S.historyPool = _makePool(historySound.src, 5, historySound.volume);
  S.historyPoolIdx = 0;

  // keep refs for later
  S._bg = bgMusic;
  S._spin = spinSound;
  S._win = winSound;
  S._tickRef = tickSound;
  S._histRef = historySound;
}

function primeAudioPool(pool){
  pool.forEach(a=>{
    try{
      const prevMuted = a.muted;
      a.muted = true;
      a.play().then(()=>{
        a.pause();
        a.currentTime = 0;
        a.muted = prevMuted;
      }).catch(()=>{ a.muted = prevMuted; });
    } catch(_){}
  });
}

function _fadeAudio(el, from, to, ms){
  if (!el) return;
  const t0 = performance.now();
  const dur = Math.max(1, ms|0);
  const step = () => {
    const t = (performance.now() - t0) / dur;
    const k = t >= 1 ? 1 : t;
    el.volume = from + (to - from) * k;
    if (k < 1) _raf(step);
  };
  step();
}

function kickAudio(withBgStart = false) {
  if (!S.audioPrimed) {
    S.audioPrimed = true;
    try { primeAudioPool(S.tickPool); primeAudioPool(S.historyPool); } catch(_){}
  }
  if (!withBgStart) return;

  if (!S.bgStarted) {
    S.bgStarted = true;
    const bgMusic = S._bg || $("bgMusic");
    if (bgMusic && bgMusic.paused) {
      try {
        bgMusic.volume = 0;
        bgMusic.play().then(()=>{
          _fadeAudio(bgMusic, 0, clamp(CONFIG.AUDIO.vol.bg,0,1), CONFIG.AUDIO.bgFadeMs || 900);
        }).catch(()=>{});
      } catch(_){}
    }
  }
}

let _pointerKickT = 0;
function playPointerKick(intensity = 1) {
  const el = S.pointerEl || $("pointerEl");
  if (!el) return;
  if (_pointerKickT) clearTimeout(_pointerKickT);

  const mul = clamp(Number(intensity || 1), 0.35, 1.25);
  const deg = (-8 - Math.random()*6) * mul; // -8..-14
  el.style.setProperty("--kick-deg", deg.toFixed(2) + "deg");

  el.classList.remove("is-kick");
  void el.offsetWidth;
  el.classList.add("is-kick");
  _pointerKickT = _st(()=> el && el.classList.remove("is-kick"), 140);
}

function playTick(intensity = 1, speedNorm = 0.5) {
  const now = performance.now();

  const minGap = Math.max(22, Number(CONFIG.AUDIO.tickMinGapMs || 26));
  if (S._lastTickAt && (now - S._lastTickAt) < minGap) return;
  S._lastTickAt = now;

  const pool = S.tickPool;
  if (!pool || !pool.length) return;

  const a = pool[S.tickPoolIdx++ % pool.length];

  // micro variations for realism
  const baseVol = clamp(CONFIG.AUDIO.vol.tick, 0, 1);
  const jit = (Math.random()*2 - 1) * (CONFIG.AUDIO.tickVolJitter || 0.08);
  a.volume = clamp(baseVol * (0.82 + 0.35*clamp(speedNorm,0,1)) + jit, 0.03, 1);

  const pr = 1 + (Math.random()*2 - 1) * (CONFIG.AUDIO.tickPitchRand || 0.06);
  try { a.playbackRate = clamp(pr, 0.88, 1.18); } catch(_){}

  playPointerKick(intensity);

  try {
    a.currentTime = 0;
    a.play().catch(()=>{});
  } catch(_){}
}

function playWin() {
  const win = S._win || $("winSound");
  if (!win) return;
  try { win.currentTime = 0; win.play().catch(()=>{}); } catch(_){}
}

function playSpinStart() {
  const spin = S._spin || $("spinSound");
  if (!spin) return;

  try {
    spin.pause();
    spin.currentTime = 0;
  } catch(_){}

  // subtle variation
  try { spin.playbackRate = clamp(0.98 + Math.random()*0.04, 0.92, 1.08); } catch(_){}
  spin.volume = clamp(CONFIG.AUDIO.vol.spin, 0, 1);

  try { spin.play().catch(()=>{}); } catch(_){}
}

function playSpinStop() {
  const spin = S._spin || $("spinSound");
  if (!spin) return;

  const ms = Math.max(90, CONFIG.AUDIO.spinFadeOutMs || 220);
  const from = clamp(spin.volume, 0, 1);
  _fadeAudio(spin, from, 0, ms);

  _st(() => {
    try { spin.pause(); spin.currentTime = 0; } catch(_){}
    // restore for next spin
    try { spin.volume = clamp(CONFIG.AUDIO.vol.spin, 0, 1); } catch(_){}
  }, ms + 40);
}

function playHistorySfx() {
  const now = Date.now();
  if (now - (S.historySfxAt || 0) < 700) return;
  S.historySfxAt = now;

  const pool = S.historyPool;
  if (!pool || !pool.length) return;

  const a = pool[S.historyPoolIdx++ % pool.length];
  try {
    a.currentTime = 0;
    a.volume = clamp(CONFIG.AUDIO.vol.history, 0, 1);
    a.play().catch(()=>{});
  } catch(_){}
}

/* =========================
 * Wheel rotation persist
 * ========================= */
function applyWheelRotation(deg){
  const wheel = S.wheelEl || $("wheel");
  if (!wheel) return;

  const v = Number(deg || 0);
  wheel.style.willChange = "transform";
  wheel.style.transform = `rotate(${v}deg) translateZ(0)`;
  _raf(() => { try { wheel.style.willChange = ""; } catch(_){} });
}
function saveRotation(deg){
  S.currentRotation = Number(deg || 0);
  lsSet(LS.ROTATION, String(S.currentRotation));
}

/* =========================
 * Focus wheel (smart)
 * ========================= */
function focusWheelIntoView(force = false){
  try { if (CONFIG.SCROLL.ENABLED === false) return; } catch(_){}

  const target = $("wheelWrap") || $("wheel");
  if (!target) return;

  try {
    target.classList.add("mt2-focus");
    _st(() => target.classList.remove("mt2-focus"), CONFIG.SCROLL.FOCUS_CLASS_MS || 650);
  } catch(_){}

  let rect = null;
  try { rect = target.getBoundingClientRect(); } catch(_){ rect = null; }

  const vh = Math.max(1, window.innerHeight || 0);
  const inView = rect && rect.top >= 0 && rect.bottom <= vh;
  if (inView && !force) return;

  const behavior = isReducedMotion() ? "auto" : "smooth";
  try { target.scrollIntoView({ behavior, block: "center", inline: "nearest" }); return; } catch(_){}
  try {
    const y = window.scrollY + (rect ? rect.top : 0) - (vh * 0.33);
    window.scrollTo({ top: Math.max(0, y), behavior });
  } catch(_){}
}

/* =========================
 * FX Canvas (instance-managed)
 * ========================= */
function initFxParticlesCanvas(){
  const c = $("fxCanvas");
  if (!c) return;

  if (MT2_SYS._fx && typeof MT2_SYS._fx.stop === "function") {
    try { MT2_SYS._fx.stop(); } catch(_){}
  }

  const ctx = c.getContext("2d", { alpha: true, desynchronized: true });
  if (!ctx) return;

  try{
    c.style.position = "fixed";
    c.style.inset = "0";
    c.style.width = "100%";
    c.style.height = "100%";
    c.style.pointerEvents = "none";
    c.style.zIndex = "0";
  }catch(_){}

  if (isReducedMotion()) { c.style.display = "none"; return; }
  c.style.display = "";

  const devMem = Number(navigator.deviceMemory || 0) || 4;
  const cores = Number(navigator.hardwareConcurrency || 0) || 6;
  const saveData = !!(navigator.connection && navigator.connection.saveData);
  const lowEnd = saveData || (devMem <= 2) || (cores <= 4);

  let w = 0, h = 0, dpr = 1;
  const parts = [];
  const maxParts = lowEnd ? 42 : 72;

  let rafId = 0;
  let running = true;
  let scrollPauseUntil = 0;

  const resize = () => {
    const vv = window.visualViewport;
    const vw = Math.max(1, Math.floor((vv && vv.width) ? vv.width : window.innerWidth));
    const vh = Math.max(1, Math.floor((vv && vv.height) ? vv.height : window.innerHeight));

    const dprCap = lowEnd ? 1.35 : 2;
    dpr = Math.min(dprCap, window.devicePixelRatio || 1);

    w = vw; h = vh;
    c.width = Math.floor(w * dpr);
    c.height = Math.floor(h * dpr);
    c.style.width = w + "px";
    c.style.height = h + "px";
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  };

  const rand = (a,b)=> a + Math.random()*(b-a);
  const pick = (arr)=> arr[(Math.random()*arr.length)|0];

  const spawn = () => {
    parts.push({
      x: rand(-40, w+40),
      y: rand(-40, h+40),
      r: rand(0.7, 2.0),
      vy: rand(-0.16, -0.05),
      vx: rand(-0.07, 0.07),
      a: rand(0.12, 0.50),
      tw: rand(0.004, 0.010),
      ph: rand(0, Math.PI*2),
      hue: pick([120, 140, 45, 50, 160]),
      life: rand(2400, 5200),
      t: 0
    });
  };
  const ensure = () => { while (parts.length < maxParts) spawn(); };

  const draw = (dt) => {
    ctx.clearRect(0,0,w,h);

    const g = ctx.createRadialGradient(w*0.5, h*0.28, 0, w*0.5, h*0.28, Math.max(w,h)*0.55);
    g.addColorStop(0, "rgba(34,197,94,0.075)");
    g.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    for (let i = parts.length-1; i >= 0; i--) {
      const p = parts[i];
      p.t += dt;
      p.x += p.vx * dt;
      p.y += p.vy * dt;

      const tw = (Math.sin(p.ph + p.t*p.tw) * 0.5 + 0.5);
      const alpha = Math.max(0, Math.min(1, p.a * (0.55 + tw*0.65) * (1 - (p.t/p.life))));
      const rr = p.r * (0.85 + tw*0.65);

      ctx.beginPath();
      ctx.fillStyle = `hsla(${p.hue}, 80%, 70%, ${alpha})`;
      ctx.arc(p.x, p.y, rr, 0, Math.PI*2);
      ctx.fill();

      ctx.globalAlpha = alpha * 0.26;
      ctx.strokeStyle = `hsla(${p.hue}, 85%, 78%, 1)`;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(p.x - rr*2.2, p.y);
      ctx.lineTo(p.x + rr*2.2, p.y);
      ctx.moveTo(p.x, p.y - rr*2.2);
      ctx.lineTo(p.x, p.y + rr*2.2);
      ctx.stroke();
      ctx.globalAlpha = 1;

      if (p.t >= p.life || p.y < -80 || p.x < -120 || p.x > w+120) {
        parts.splice(i,1);
        spawn();
      }
    }
  };

  let last = performance.now();
  const tick = () => {
    if (!running) return;
    const now = performance.now();
    const dt = Math.min(34, now - last);
    last = now;

    ensure();
    if (now >= scrollPauseUntil) draw(dt);

    rafId = requestAnimationFrame(tick);
  };

  const stop = () => { running = false; if (rafId) cancelAnimationFrame(rafId); rafId = 0; };
  const start = () => { if (running) return; running = true; last = performance.now(); rafId = requestAnimationFrame(tick); };

  const onScroll = () => { scrollPauseUntil = performance.now() + 160; };

  resize();
  _on(window, "resize", resize, { passive: true });
  if (window.visualViewport) _on(window.visualViewport, "resize", resize, { passive: true });
  _on(window, "scroll", onScroll, { passive: true });
  _on(document, "visibilitychange", () => { if (document.hidden) stop(); else start(); });

  rafId = requestAnimationFrame(tick);
  MT2_SYS._rafs.push(rafId);
  MT2_SYS._fx = { stop };
}

/* =========================
 * Wheel SVG (HD)
 * ========================= */
function setWheelBackground() {
  const wheel = $("wheel");
  if (!wheel) return;

  const n = PRIZES.length || 1;
  const seg = 360 / n;

  const DARK = "#064e3b";
  const LIGHT = "#f1f5f9";

  const EPS = 0.06;
  const parts = [];
  for (let i = 0; i < n; i++) {
    const a = i * seg;
    let b = (i + 1) * seg + EPS;
    if (i === n - 1) b = 360;
    const color = (i % 2 === 0) ? DARK : LIGHT;
    parts.push(`${color} ${a.toFixed(3)}deg ${b.toFixed(3)}deg`);
  }
  wheel.style.setProperty("--wheel-bg", `conic-gradient(from 0deg, ${parts.join(",")})`);
}

function _svgPolar(cx, cy, r, deg){
  const a = (deg * Math.PI) / 180;
  return { x: cx + r * Math.cos(a), y: cy + r * Math.sin(a) };
}
function _svgArcWedgePath(cx, cy, rOuter, rInner, startDeg, endDeg){
  const p1 = _svgPolar(cx, cy, rOuter, startDeg);
  const p2 = _svgPolar(cx, cy, rOuter, endDeg);
  const p3 = _svgPolar(cx, cy, rInner, endDeg);
  const p4 = _svgPolar(cx, cy, rInner, startDeg);
  const delta = (endDeg - startDeg);
  const large = (delta > 180) ? 1 : 0;

  return [
    `M ${p1.x.toFixed(3)} ${p1.y.toFixed(3)}`,
    `A ${rOuter} ${rOuter} 0 ${large} 1 ${p2.x.toFixed(3)} ${p2.y.toFixed(3)}`,
    `L ${p3.x.toFixed(3)} ${p3.y.toFixed(3)}`,
    `A ${rInner} ${rInner} 0 ${large} 0 ${p4.x.toFixed(3)} ${p4.y.toFixed(3)}`,
    "Z"
  ].join(" ");
}
function _svgArcTextPath(cx, cy, r, startDeg, endDeg, sweepFlag){
  let delta;
  if (sweepFlag === 1) delta = (endDeg - startDeg + 360) % 360;
  else delta = (startDeg - endDeg + 360) % 360;

  const large = (delta > 180) ? 1 : 0;
  const p0 = _svgPolar(cx, cy, r, startDeg);
  const p1 = _svgPolar(cx, cy, r, endDeg);

  return `M ${p0.x.toFixed(3)} ${p0.y.toFixed(3)} A ${r} ${r} 0 ${large} ${sweepFlag} ${p1.x.toFixed(3)} ${p1.y.toFixed(3)}`;
}
function _splitLabelLines(label){
  const t = String(label || "").trim();
  if (/bonus/i.test(t) && /\s/.test(t)) {
    const parts = t.split(/\s+/);
    const a = parts[0] || t;
    const b = parts.slice(1).join(" ");
    return [a, b].filter(Boolean).slice(0, 2);
  }
  return [t];
}
function _fontForLabel(label, isTwoLine){
  const t = String(label || "");
  let fs = 46;
  if (t.length <= 3) fs = 52;
  else if (t.length <= 4) fs = 50;
  else if (t.length >= 8) fs = 42;
  if (isTwoLine) fs = Math.min(fs, 44);
  return Math.max(34, Math.min(54, fs));
}
function renderWheelSVG(){
  const wheel = $("wheel");
  if (!wheel) return;

  setWheelBackground();

  try { if (getComputedStyle(wheel).position === "static") wheel.style.position = "relative"; } catch(_){}

  const old = wheel.querySelector("svg.wheel-svg");
  if (old) { try { old.remove(); } catch(_){ } }

  const prizes = (Array.isArray(PRIZES) && PRIZES.length) ? PRIZES.slice() : ["BONUS"];
  const n = Math.max(1, prizes.length);
  const seg = 360 / n;

  const V = CONFIG.WHEEL_SVG.VIEW || 1000;
  const cx = V/2, cy = V/2;
  const rOuter = CONFIG.WHEEL_SVG.OUTER_R || 492;
  const rInner = CONFIG.WHEEL_SVG.INNER_R || 170;

  const r1 = CONFIG.WHEEL_SVG.LABEL_R1 || 305;
  const r2 = CONFIG.WHEEL_SVG.LABEL_R2 || 338;

  const padDeg = Math.max(
    CONFIG.WHEEL_SVG.LABEL_PAD_DEG_MIN || 6,
    Math.min(CONFIG.WHEEL_SVG.LABEL_PAD_DEG_MAX || 11, seg * 0.18)
  );

  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.createElementNS(svgNS, "svg");
  svg.classList.add("wheel-svg");
  svg.setAttribute("viewBox", `0 0 ${V} ${V}`);
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");
  svg.setAttribute("aria-hidden", "true");
  svg.setAttribute("shape-rendering", "geometricPrecision");
  svg.setAttribute("text-rendering", "geometricPrecision");

  svg.style.position = "absolute";
  svg.style.inset = "0";
  svg.style.pointerEvents = "none";
  svg.style.transform = "translateZ(0)";

  const defs = document.createElementNS(svgNS, "defs");

  const rim = document.createElementNS(svgNS, "radialGradient");
  rim.setAttribute("id", "mt2_rim");
  rim.setAttribute("cx", "50%"); rim.setAttribute("cy", "42%"); rim.setAttribute("r", "72%");
  const rs1 = document.createElementNS(svgNS, "stop"); rs1.setAttribute("offset", "0"); rs1.setAttribute("stop-color", "rgba(255,255,255,0.22)");
  const rs2 = document.createElementNS(svgNS, "stop"); rs2.setAttribute("offset", "0.55"); rs2.setAttribute("stop-color", "rgba(34,197,94,0.10)");
  const rs3 = document.createElementNS(svgNS, "stop"); rs3.setAttribute("offset", "1"); rs3.setAttribute("stop-color", "rgba(0,0,0,0.28)");
  rim.append(rs1, rs2, rs3);
  defs.appendChild(rim);

  const flt = document.createElementNS(svgNS, "filter");
  flt.setAttribute("id", "mt2_txtShadow");
  flt.setAttribute("x", "-30%");
  flt.setAttribute("y", "-30%");
  flt.setAttribute("width", "160%");
  flt.setAttribute("height", "160%");
  const fe = document.createElementNS(svgNS, "feDropShadow");
  fe.setAttribute("dx", "0"); fe.setAttribute("dy", "10");
  fe.setAttribute("stdDeviation", "8");
  fe.setAttribute("flood-color", "rgba(0,0,0,0.55)");
  flt.appendChild(fe);
  defs.appendChild(flt);

  svg.appendChild(defs);

  const gSeg = document.createElementNS(svgNS, "g");
  const gLbl = document.createElementNS(svgNS, "g");
  gLbl.setAttribute("filter", "url(#mt2_txtShadow)");

  for (let i = 0; i < n; i++){
    const start = -90 + (i * seg);
    const end = start + seg;
    const isLight = (i % 2 === 1);

    const wedge = document.createElementNS(svgNS, "path");
    wedge.setAttribute("d", _svgArcWedgePath(cx, cy, rOuter, rInner, start, end));
    wedge.setAttribute("fill", isLight ? "#f1f5f9" : "#064e3b");
    wedge.setAttribute("stroke", "rgba(255,255,255,0.11)");
    wedge.setAttribute("stroke-width", "2");
    gSeg.appendChild(wedge);

    const prize = String(prizes[i] ?? "");
    const lines = _splitLabelLines(prize);
    const twoLine = lines.length === 2;

    const a0 = start + Math.min(padDeg, seg * 0.45);
    const a1 = end - Math.min(padDeg, seg * 0.45);
    const mid = (a0 + a1) / 2;
    const midNorm = ((mid % 360) + 360) % 360;
    const flip = (midNorm > 0 && midNorm < 180);

    const fill = isLight ? "#05281d" : "#ffffff";
    const stroke = isLight ? "rgba(255,255,255,0.42)" : "rgba(0,0,0,0.55)";

    const pid1 = `mt2_lp_${i}_1`;
    const p1 = document.createElementNS(svgNS, "path");
    p1.setAttribute("id", pid1);
    p1.setAttribute("fill", "none");
    if (!flip) p1.setAttribute("d", _svgArcTextPath(cx, cy, r1, a0, a1, 1));
    else       p1.setAttribute("d", _svgArcTextPath(cx, cy, r1, a1, a0, 0));
    defs.appendChild(p1);

    const t1 = document.createElementNS(svgNS, "text");
    t1.setAttribute("fill", fill);
    t1.setAttribute("stroke", stroke);
    t1.setAttribute("stroke-width", isLight ? "6" : "7");
    t1.setAttribute("paint-order", "stroke fill");
    t1.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, Roboto, Arial");
    t1.setAttribute("font-weight", "950");
    t1.setAttribute("letter-spacing", "0.6");
    t1.setAttribute("style", `font-size:${_fontForLabel(lines[0], twoLine)}px;`);

    const tp1 = document.createElementNS(svgNS, "textPath");
    tp1.setAttribute("href", `#${pid1}`);
    tp1.setAttribute("startOffset", "50%");
    tp1.setAttribute("text-anchor", "middle");
    tp1.textContent = String(lines[0] || "");
    t1.appendChild(tp1);
    gLbl.appendChild(t1);

    if (twoLine) {
      const pid2 = `mt2_lp_${i}_2`;
      const p2 = document.createElementNS(svgNS, "path");
      p2.setAttribute("id", pid2);
      p2.setAttribute("fill", "none");
      if (!flip) p2.setAttribute("d", _svgArcTextPath(cx, cy, r2, a0, a1, 1));
      else       p2.setAttribute("d", _svgArcTextPath(cx, cy, r2, a1, a0, 0));
      defs.appendChild(p2);

      const t2 = document.createElementNS(svgNS, "text");
      t2.setAttribute("fill", fill);
      t2.setAttribute("stroke", stroke);
      t2.setAttribute("stroke-width", isLight ? "6" : "7");
      t2.setAttribute("paint-order", "stroke fill");
      t2.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, Roboto, Arial");
      t2.setAttribute("font-weight", "950");
      t2.setAttribute("letter-spacing", "0.5");
      t2.setAttribute("style", `font-size:${Math.max(30, _fontForLabel(lines[1], true) - 6)}px;`);

      const tp2 = document.createElementNS(svgNS, "textPath");
      tp2.setAttribute("href", `#${pid2}`);
      tp2.setAttribute("startOffset", "50%");
      tp2.setAttribute("text-anchor", "middle");
      tp2.textContent = String(lines[1] || "");
      t2.appendChild(tp2);
      gLbl.appendChild(t2);
    }
  }

  const rimCircle = document.createElementNS(svgNS, "circle");
  rimCircle.setAttribute("cx", String(cx));
  rimCircle.setAttribute("cy", String(cy));
  rimCircle.setAttribute("r", String(rOuter - 6));
  rimCircle.setAttribute("fill", "none");
  rimCircle.setAttribute("stroke", "url(#mt2_rim)");
  rimCircle.setAttribute("stroke-width", "18");
  rimCircle.setAttribute("opacity", "0.95");

  svg.appendChild(gSeg);
  svg.appendChild(gLbl);
  svg.appendChild(rimCircle);

  wheel.insertBefore(svg, wheel.firstChild);
}
function drawWheelPrizes(){ renderWheelSVG(); }

function initWheelAutoResize() {
  const wrap = $("wheelWrap");
  if (!wrap) return;

  let t = 0;
  const rerender = () => {
    clearTimeout(t);
    t = setTimeout(() => { drawWheelPrizes(); }, 80);
    MT2_SYS._timers.push(t);
  };

  if (window.ResizeObserver) {
    const ro = new ResizeObserver(rerender);
    ro.observe(wrap);
    MT2_SYS._obs.push(ro);
  } else {
    _on(window, "resize", rerender, { passive: true });
  }

  try {
    if (document.fonts && document.fonts.ready) {
      document.fonts.ready.then(() => rerender()).catch(()=>{});
    }
  } catch(_) {}

  rerender();
}

/* =========================
 * History (unique)
 * ========================= */
function pickWeightedPrizeKey() {
  const bag = [
    ["BONUS 10%", 30],
    ["25K", 17],
    ["50K", 18],
    ["75K", 14],
    ["100K", 12],
    ["200K", 9],
  ];
  const total = bag.reduce((a, [,w]) => a + w, 0);
  let r = Math.random() * total;
  for (const [p, w] of bag) { r -= w; if (r <= 0) return p; }
  return "50K";
}

function randomUserId() {
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
  const pick = (s) => s[Math.floor(Math.random() * s.length)];
  const len = randInt(7, 11);
  let out = "";
  for (let i = 0; i < len; i++) out += (Math.random() < 0.30) ? String(randInt(0,9)) : pick(letters);
  if (Math.random() < 0.35) out += String(randInt(0,9));
  return out;
}

function maskUserId(str) {
  const s = String(str || "");
  if (s.length <= 6) return s.slice(0, 2) + "****";
  return (s.slice(0, 3) + "****" + s.slice(-2));
}

function makeEntryId(prefix) {
  return `${prefix || "w"}-${Date.now()}-${Math.random().toString(16).slice(2)}-${Math.random().toString(16).slice(2)}`;
}

function rememberMasked(id){
  const v = String(id || "");
  if (!v) return;
  if (S.recentMasked.has(v)) return;
  S.recentMasked.add(v);
  S.recentMaskedQueue.push(v);
  while (S.recentMaskedQueue.length > (CONFIG.HISTORY.UNIQUE_POOL || 70)) {
    const old = S.recentMaskedQueue.shift();
    S.recentMasked.delete(old);
  }
}

function uniqueMaskedId(maxTry = 60){
  for (let i = 0; i < maxTry; i++) {
    const masked = maskUserId(randomUserId());
    if (!S.recentMasked.has(masked)) {
      rememberMasked(masked);
      return masked;
    }
  }
  const fallback = maskUserId(randomUserId());
  rememberMasked(fallback);
  return fallback;
}

function generateMockWinnersRandom() {
  let base = Date.now() - randInt(40, 220) * 1000;
  const arr = [];
  for (let i = 0; i < 50; i++) {
    const prizeKey = pickWeightedPrizeKey();
    const masked = uniqueMaskedId();
    arr.push({
      id: makeEntryId("seed"),
      isUser: false,
      fullId: "",
      displayId: masked,
      prizeKey,
      prize: CONFIG.PRIZE_DISPLAY_MAP[prizeKey] || prizeKey,
      ts: base,
      isNew: false
    });
    base -= randInt(20, 160) * 1000;
  }
  arr.sort((a,b) => (b.ts || 0) - (a.ts || 0));
  return arr;
}

function timeLabel(ts) {
  const d = new Date(ts || Date.now());
  const dateStr = d.toLocaleDateString("id-ID", { day: "2-digit", month: "short", year: "numeric" });
  const timeStr = `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;

  const diff = Math.max(0, Date.now() - (ts || Date.now()));
  const sec = Math.floor(diff / 1000);

  let rel = "baru saja";
  if (sec >= 60) {
    const min = Math.floor(sec / 60);
    if (min < 60) rel = `${min}m lalu`;
    else {
      const hr = Math.floor(min / 60);
      if (hr < 24) rel = `${hr}j lalu`;
      else rel = `${Math.floor(hr / 24)} hari lalu`;
    }
  }
  return `${dateStr} ${timeStr} • ${rel}`;
}

function startMetaTicker() {
  if (S.metaTimer) clearInterval(S.metaTimer);
  S.metaTimer = _si(() => {
    document.querySelectorAll(".winner-meta[data-ts]").forEach(el => {
      const ts = Number(el.getAttribute("data-ts") || Date.now());
      el.textContent = timeLabel(ts);
    });
  }, CONFIG.HISTORY.META_TICK_MS || 15000);
}

function pushWinnerEntry(entry) {
  if (!entry) return;
  if (!entry.id) entry.id = makeEntryId(entry.isUser ? "user" : "live");
  if (entry.isNew) playHistorySfx();

  S.winners.forEach(w => (w.isNew = false));
  S.winners.unshift(entry);
  S.winners = S.winners.slice(0, 50);

  renderWinners({ preserveScroll: true, animate: true });
  startMetaTicker();
}

function startLiveHistory() {
  if (S.liveTimer) return;
  if (S.pauseReasons.size > 0) return;

  const schedule = () => {
    stopLiveHistory();
    const ms = randInt(CONFIG.HISTORY.LIVE_MIN_MS, CONFIG.HISTORY.LIVE_MAX_MS);
    S.liveTimer = _st(() => {
      if (!document.hidden && S.pauseReasons.size === 0 && !isModalOpen() && !S.isSpin) {
        const prizeKey = pickWeightedPrizeKey();
        pushWinnerEntry({
          id: makeEntryId("live"),
          isUser: false,
          fullId: "",
          displayId: uniqueMaskedId(),
          prizeKey,
          prize: (CONFIG.PRIZE_DISPLAY_MAP[prizeKey] || prizeKey),
          ts: Date.now(),
          isNew: true
        });
      }
      schedule();
    }, ms);
  };
  schedule();
}

/* =========================
 * Winners Render (FLIP)
 * ========================= */
function ensureWinnersHeader(table) {
  let header = table.querySelector(".winners-table-header");
  if (!header) {
    header = document.createElement("div");
    header.className = "winners-table-header";
    header.innerHTML = "<div>NO</div><div>USER ID</div><div>HADIAH</div>";
    table.appendChild(header);
  }
  return header;
}

function createRowEl(entry) {
  const row = document.createElement("div");
  row.className = "winners-table-row" + (entry.isNew ? " is-new" : "") + (entry.isUser ? " is-user" : "");
  row.setAttribute("data-id", entry.id);
  row.tabIndex = entry.isUser ? 0 : -1;

  const c1 = document.createElement("div");
  c1.className = "winner-no";

  const c2 = document.createElement("div");
  c2.className = "winner-id";

  const meta = document.createElement("div");
  meta.className = "winner-meta";
  meta.setAttribute("data-ts", String(entry.ts || Date.now()));

  const c2wrap = document.createElement("div");
  c2wrap.appendChild(c2);
  c2wrap.appendChild(meta);

  const c3 = document.createElement("div");
  c3.className = "winner-prize";

  row.append(c1, c2wrap, c3);
  return row;
}

function patchRowContent(row, entry, index) {
  row.classList.toggle("is-new", !!entry.isNew);
  row.classList.toggle("is-user", !!entry.isUser);
  row.tabIndex = entry.isUser ? 0 : -1;

  const no = row.querySelector(".winner-no");
  const id = row.querySelector(".winner-id");
  const meta = row.querySelector(".winner-meta");
  const prize = row.querySelector(".winner-prize");

  if (no) no.textContent = String(index + 1);
  if (id) id.textContent = String(entry.displayId || "");
  if (meta) {
    meta.setAttribute("data-ts", String(entry.ts || Date.now()));
    meta.textContent = timeLabel(entry.ts);
  }
  if (prize) prize.textContent = String(entry.prize || "");
}

function renderWinners(opts = {}) {
  const o = Object.assign({ preserveScroll: true, animate: true }, opts);
  const table = $("winnersTable");
  if (!table) return;

  let prevScrollTop = 0, prevScrollHeight = 0;
  try {
    prevScrollTop = table.scrollTop || 0;
    prevScrollHeight = table.scrollHeight || 0;
  } catch(_){}

  const header = ensureWinnersHeader(table);

  S.winnersById = new Map();
  for (const w of S.winners) S.winnersById.set(w.id, w);

  const firstTop = new Map();
  if (o.animate && !isReducedMotion()) {
    for (const [id, el] of S.rowElById.entries()) {
      if (!el || !el.isConnected) continue;
      try { firstTop.set(id, el.getBoundingClientRect().top); } catch(_){}
    }
  }

  for (let i = 0; i < S.winners.length; i++) {
    const w = S.winners[i];
    if (!w.id) w.id = makeEntryId("w");
    let row = S.rowElById.get(w.id);
    if (!row || !row.isConnected) {
      row = createRowEl(w);
      S.rowElById.set(w.id, row);
      table.appendChild(row);
    }
    patchRowContent(row, w, i);
  }

  for (const [id, el] of Array.from(S.rowElById.entries())) {
    if (!S.winnersById.has(id)) {
      try { el.remove(); } catch (_) {}
      S.rowElById.delete(id);
    }
  }

  if (header && header.isConnected) table.insertBefore(header, table.firstChild);
  for (const w of S.winners) {
    const row = S.rowElById.get(w.id);
    if (row && row.isConnected) table.appendChild(row);
  }

  if (o.animate && !isReducedMotion()) {
    requestAnimationFrame(() => {
      for (const w of S.winners) {
        const el = S.rowElById.get(w.id);
        if (!el || !el.isConnected) continue;

        const a = firstTop.get(w.id);
        let b = null;
        try { b = el.getBoundingClientRect().top; } catch(_){ b = null; }
        if (typeof a !== "number" || typeof b !== "number") continue;

        const dy = a - b;
        if (Math.abs(dy) < 0.5) continue;

        try {
          if (typeof el.animate === "function") {
            el.animate(
              [{ transform: `translateY(${dy}px)` }, { transform: "translateY(0)" }],
              { duration: 360, easing: "cubic-bezier(0.2, 0.8, 0.2, 1)" }
            );
          } else {
            el.style.transform = `translateY(${dy}px)`;
            el.style.transition = "transform 0ms";
            requestAnimationFrame(() => {
              el.style.transition = "transform 360ms cubic-bezier(0.2, 0.8, 0.2, 1)";
              el.style.transform = "";
              setTimeout(() => { el.style.transition = ""; }, 420);
            });
          }
        } catch(_){}
      }
    });
  }

  if (o.preserveScroll) {
    try {
      const newH = table.scrollHeight || 0;
      const deltaH = Math.max(0, newH - prevScrollHeight);
      if (prevScrollTop > 2 && deltaH > 0) table.scrollTop = prevScrollTop + deltaH;
      else table.scrollTop = prevScrollTop;
    } catch(_){}
  }
}

/* =========================
 * History row open (user only)
 * ========================= */
function setupHistoryRowOpen() {
  const table = $("winnersTable");
  if (!table) return;

  if (table.dataset && table.dataset.openBound === "1") return;
  if (table.dataset) table.dataset.openBound = "1";

  const tryOpen = (row) => {
    const id = row.getAttribute("data-id");
    const entry = S.winnersById.get(id);
    if (!entry) return;

    if (!entry.isUser) {
      const now = Date.now();
      if (now - S.nonUserToastAt > 1800) {
        S.nonUserToastAt = now;
        showToast("Hanya riwayat Anda yang bisa dibuka.", "error", 1800);
      }
      return;
    }

    const showUser = String(entry.fullId || entry.displayId || "-");
    const prizeShow = String(entry.prize || entry.prizeKey || "-");
    const ts = Number(entry.ts || Date.now());

    S.lastResult = { userId: showUser, prizeLabel: prizeShow, prizeDisplay: prizeShow, ts };

    $("prizeAmount") && ($("prizeAmount").textContent = prizeShow);
    $("modalUserId") && ($("modalUserId").textContent = showUser);
    $("modalTime") && ($("modalTime").textContent = new Date(ts).toLocaleString("id-ID", {
      day: "2-digit", month: "short", year: "numeric",
      hour: "2-digit", minute: "2-digit", second: "2-digit"
    }));

    openModal();
    syncShareState();
  };

  _on(table, "click", (e) => {
    const row = e.target && e.target.closest ? e.target.closest(".winners-table-row") : null;
    if (!row) return;
    tryOpen(row);
  });

  _on(table, "keydown", (e) => {
    if (e.key !== "Enter" && e.key !== " ") return;
    const row = e.target && e.target.classList && e.target.classList.contains("winners-table-row") ? e.target : null;
    if (!row) return;
    e.preventDefault();
    tryOpen(row);
  });
}

/* =========================
 * Jackpot (single version, smooth target)
 * ========================= */
function fmtClock() { const d = new Date(); return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`; }

function initJackpot() {
  const saved = Number(lsGet(LS.JACKPOT_VAL, "0") || "0");
  if (saved && saved > 1_000_000) return saved;

  const seed = randInt(CONFIG.JACKPOT.SEED_MIN, CONFIG.JACKPOT.SEED_MAX);
  lsSet(LS.JACKPOT_VAL, String(seed));
  return seed;
}

function startJackpot() {
  if (S.jackpotTimer) return;

  const el = $("jackpot");
  const meta = $("jackpotMeta");

  let baseSpeed = randInt(CONFIG.JACKPOT.SPEED_MIN, CONFIG.JACKPOT.SPEED_MAX);
  let last = performance.now();

  let target = Number(S.jackpot || 0) || initJackpot();
  let display = target;

  const step = () => {
    const now = performance.now();
    const dt = Math.min(0.22, (now - last) / 1000);
    last = now;

    if (now > S.spikeUntilMs) {
      S.spikeMul = 1;
      if (Math.random() < CONFIG.JACKPOT.SPIKE_CHANCE) {
        S.spikeMul =
          CONFIG.JACKPOT.SPIKE_MIN +
          Math.random() * (CONFIG.JACKPOT.SPIKE_MAX - CONFIG.JACKPOT.SPIKE_MIN);
        S.spikeUntilMs =
          now + (CONFIG.JACKPOT.SPIKE_MS_MIN + Math.random() * (CONFIG.JACKPOT.SPIKE_MS_MAX - CONFIG.JACKPOT.SPIKE_MS_MIN));
      }
    }

    const noise = (Math.random() - 0.5) * 0.85;
    let v = baseSpeed * (1 + noise) * S.spikeMul;

    if (Math.random() < 0.015) v *= -0.18;

    target = Math.max(CONFIG.JACKPOT.FLOOR, target + v * dt);
    display = display + (target - display) * (dt > 0 ? 0.18 : 0.14);

    S.jackpot = target;

    if (el) el.textContent = `IDR ${Math.round(display).toLocaleString("id-ID")}`;
    if (meta) meta.textContent = `Update: ${fmtClock()}`;

    S.jackpotTimer = requestAnimationFrame(step);
  };

  S.jackpotTimer = requestAnimationFrame(step);

  if (S.jackpotSaveTimer) clearInterval(S.jackpotSaveTimer);
  S.jackpotSaveTimer = _si(() => {
    lsSet(LS.JACKPOT_VAL, String(Math.round(target)));
    if (Math.random() < 0.55) baseSpeed = randInt(CONFIG.JACKPOT.SPEED_MIN, CONFIG.JACKPOT.SPEED_MAX);
  }, CONFIG.JACKPOT.SAVE_EVERY_MS);
}

function stopJackpot() {
  if (S.jackpotTimer) cancelAnimationFrame(S.jackpotTimer);
  S.jackpotTimer = 0;
  if (S.jackpotSaveTimer) clearInterval(S.jackpotSaveTimer);
  S.jackpotSaveTimer = 0;
}

/* =========================
 * Modal (FINAL — focus trap + inert + scroll lock)
 * ========================= */
(function(){
  const MT2_MODAL = window.__MT2_MODAL || (window.__MT2_MODAL = {
    isOpen: false,
    lastFocusedEl: null,
    scrollY: 0,
    tabFence: null,
    bound: false
  });

  const FOCUSABLE_SEL =
    'button:not([disabled]),[href],input:not([disabled]),select:not([disabled]),textarea:not([disabled]),[tabindex]:not([tabindex="-1"])';

  function _$(id){ try { return typeof $ === "function" ? $(id) : document.getElementById(id); } catch(_) { return document.getElementById(id); } }
  function getModal(){ return _$("prizeModal"); }
  function getRoot(modal){ return modal?.querySelector?.(".modal-content") || modal; }

  function isVisible(el){
    if (!el) return false;
    try {
      if (el.disabled) return false;
      const r = el.getClientRects && el.getClientRects();
      return !!(r && r.length);
    } catch(_) { return true; }
  }

  function getFocusables(root){
    if (!root?.querySelectorAll) return [];
    return Array.from(root.querySelectorAll(FOCUSABLE_SEL)).filter(isVisible);
  }

  function focusFirst(modal){
    const claimBtn = _$("claimBtn");
    if (claimBtn && isVisible(claimBtn)) { try { claimBtn.focus({ preventScroll:true }); return true; } catch(_){} }
    const list = getFocusables(getRoot(modal));
    if (list[0]) { try { list[0].focus({ preventScroll:true }); return true; } catch(_){} }
    try { modal.focus({ preventScroll:true }); return true; } catch(_){}
    return false;
  }

  function trapFocus(e){
    if (!MT2_MODAL.isOpen) return;
    if (!e || e.key !== "Tab") return;

    const modal = getModal();
    const root = getRoot(modal);
    if (!modal || !root) return;

    const list = getFocusables(root);
    if (!list.length) return;

    const first = list[0];
    const last  = list[list.length - 1];
    const active = document.activeElement;

    if (e.shiftKey) {
      if (active === first || active === root || active === modal) {
        e.preventDefault();
        try { last.focus({ preventScroll:true }); } catch(_){}
      }
    } else {
      if (active === last) {
        e.preventDefault();
        try { first.focus({ preventScroll:true }); } catch(_){}
      }
    }
  }

  function keepFocusInside(e){
    if (!MT2_MODAL.isOpen) return;
    const modal = getModal();
    if (!modal) return;
    const t = e && e.target;
    if (t && modal.contains(t)) return;
    try { focusFirst(modal); } catch(_){}
  }

  function lockBodyScroll(){
    const docEl = document.documentElement;
    MT2_MODAL.scrollY = window.scrollY || docEl.scrollTop || 0;
    const sbw = window.innerWidth - docEl.clientWidth;
    if (sbw > 0) document.body.style.paddingRight = sbw + "px";
    document.body.style.position = "fixed";
    document.body.style.top = (-MT2_MODAL.scrollY) + "px";
    document.body.style.left = "0";
    document.body.style.right = "0";
    document.body.style.width = "100%";
  }

  function unlockBodyScroll(){
    const y = MT2_MODAL.scrollY || 0;
    document.body.style.position = "";
    document.body.style.top = "";
    document.body.style.left = "";
    document.body.style.right = "";
    document.body.style.width = "";
    document.body.style.paddingRight = "";
    try { window.scrollTo(0, y); } catch(_){}
    MT2_MODAL.scrollY = 0;
  }

  function inertFallback(enable){
    const modal = getModal();
    const main = _$("mainContainer") || document.querySelector(".container") || document.querySelector("main") || null;
    if (!main || !modal) return;

    if (enable) {
      const outside = Array.from(main.querySelectorAll(FOCUSABLE_SEL)).filter(el => el && !modal.contains(el));
      const items = [];
      for (const el of outside) {
        try {
          const prev = el.getAttribute("tabindex");
          items.push({ el, prevTab: prev });
          el.setAttribute("tabindex", "-1");
        } catch(_){}
      }
      const prevAria = main.getAttribute("aria-hidden");
      MT2_MODAL.tabFence = { items, ariaEl: main, prevAria };
      try { main.setAttribute("aria-hidden", "true"); } catch(_){}
      try { main.style.pointerEvents = "none"; } catch(_){}
    } else {
      const fence = MT2_MODAL.tabFence;
      if (fence && fence.items) {
        for (const it of fence.items) {
          try {
            if (it.prevTab === null) it.el.removeAttribute("tabindex");
            else it.el.setAttribute("tabindex", it.prevTab);
          } catch(_){}
        }
        if (fence.ariaEl) {
          try {
            if (fence.prevAria === null) fence.ariaEl.removeAttribute("aria-hidden");
            else fence.ariaEl.setAttribute("aria-hidden", fence.prevAria);
          } catch(_){}
          try { fence.ariaEl.style.pointerEvents = ""; } catch(_){}
        }
      }
      MT2_MODAL.tabFence = null;
    }
  }

  function setInertSafe(enable){
    if (typeof setInert === "function") { try { setInert("modal", !!enable); } catch(_){} }
    const main = _$("mainContainer") || document.querySelector(".container") || document.querySelector("main") || null;
    if (main && "inert" in main) { try { main.inert = !!enable; } catch(_){} }
    inertFallback(!!enable);
  }

  window.isModalOpen = function isModalOpen(){
    const m = getModal();
    return !!(m && m.classList && m.classList.contains("show"));
  };

  window.openModal = function openModal(){
    const modal = getModal();
    if (!modal) return;
    if (MT2_MODAL.isOpen) return;

    MT2_MODAL.isOpen = true;
    MT2_MODAL.lastFocusedEl = document.activeElement;

    try { pauseHistory && pauseHistory("modal"); } catch(_){}
    lockBodyScroll();
    setInertSafe(true);

    try {
      modal.setAttribute("role", "dialog");
      modal.setAttribute("aria-modal", "true");
      modal.setAttribute("aria-hidden", "false");
      if (!modal.hasAttribute("tabindex")) modal.setAttribute("tabindex", "-1");
    } catch(_){}

    modal.classList.add("show");
    document.body.classList.add("modal-open");

    const focusLater = () => { try { focusFirst(modal); } catch(_){ } };
    try { _st(focusLater, 0); } catch(_){ focusLater(); }
  };

  window.closeModal = function closeModal(){
    const modal = getModal();
    if (!modal) return;
    if (!MT2_MODAL.isOpen) return;

    MT2_MODAL.isOpen = false;
    modal.classList.remove("show");
    try { modal.setAttribute("aria-hidden", "true"); } catch(_){}

    try { resumeHistory && resumeHistory("modal"); } catch(_){}
    setInertSafe(false);
    unlockBodyScroll();

    if (typeof isNavOpen === "function") {
      if (!isNavOpen()) document.body.classList.remove("modal-open");
    } else {
      document.body.classList.remove("modal-open");
    }

    const last = MT2_MODAL.lastFocusedEl;
    MT2_MODAL.lastFocusedEl = null;

    const fallback = _$("spinBtn") || _$("userIdInput") || document.body;
    const toFocus = (last && last.isConnected && typeof last.focus === "function" && isVisible(last)) ? last : fallback;
    try { toFocus && toFocus.focus && toFocus.focus({ preventScroll: true }); } catch(_){}
  };

  // export trapFocus biar tidak error kalau kamu panggil dari luar
  window.trapFocus = trapFocus;

  function setupPrizeModal(){
    if (MT2_MODAL.bound) return;
    MT2_MODAL.bound = true;

    const modal = getModal();
    if (!modal) return;

    const closeBtn =
      _$("closeModalBtn") ||
      (modal.querySelector && (modal.querySelector("[data-modal-close]") || modal.querySelector(".modal-close") || modal.querySelector(".close")));

    if (closeBtn) {
      _on(closeBtn, "click", (e) => { try { e.preventDefault(); } catch(_){ } window.closeModal(); });
    }

    _on(modal, "click", (e) => {
      const root = getRoot(modal);
      const t = e && e.target;
      if (t === modal) window.closeModal();
      if (root && t && !root.contains(t) && t !== root) window.closeModal();
    });

    _on(document, "keydown", (e) => {
      if (!MT2_MODAL.isOpen) return;
      const k = e.key || "";
      if (k === "Escape" || k === "Esc") { try { e.preventDefault(); } catch(_){ } window.closeModal(); return; }
      if (k === "Tab") trapFocus(e);
    });

    _on(document, "focusin", keepFocusInside, true);
  }

  try {
    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", setupPrizeModal, { once: true });
    else setupPrizeModal();
  } catch(_){}
})();

/* =========================
 * UI (FINAL — resilient)
 * ========================= */
function updateUI() {
  const spinBtn = $("spinBtn");
  const userIdInput = $("userIdInput");
  const spunMessage = $("spunMessage");
  if (!spinBtn || !userIdInput || !spunMessage) return;

  const hasSpun = !!S.hasSpun;

  try { spinBtn.setAttribute("aria-disabled", hasSpun ? "true" : "false"); } catch(_){}
  try { spinBtn.dataset.state = hasSpun ? "done" : "ready"; } catch(_){}
  try { userIdInput.dataset.state = hasSpun ? "locked" : "ready"; } catch(_){}

  if (hasSpun) {
    spinBtn.disabled = true;
    spinBtn.textContent = "SUDAH SPIN";
    userIdInput.disabled = true;
    spunMessage.style.display = "block";
  } else {
    spinBtn.disabled = false;
    spinBtn.textContent = "SPIN SEKARANG!";
    userIdInput.disabled = false;
    spunMessage.style.display = "none";
  }

  try { if (typeof syncShareState === "function") syncShareState(); } catch(_){}
}

/* =========================
 * SPIN ENGINE (RAF-based, real tick sync)
 * ========================= */
function _easeOutQuint(t){ return 1 - Math.pow(1 - t, 5); }
function _easeInOutCubic(t){ return t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2; }

function _computeTargetRotation(prizeIndex){
  const n = PRIZES.length || 1;
  const segmentAngle = 360 / n;

  // center of target segment in wheel coords (0deg = right, but we render from -90 in SVG; wheel CSS uses rotate(...) so pointer at top)
  // we match your previous logic (works with your layout): pointer aims at top; use segmentCenter
  const segmentCenter = (prizeIndex * segmentAngle) + (segmentAngle / 2);

  const base = ((S.currentRotation % 360) + 360) % 360;
  const desiredMod = (360 - segmentCenter + 360) % 360;

  const fullSpins = 360 * (8 + Math.floor(Math.random() * 4)); // casino long spin
  const jitter = (Math.random() - 0.5) * (segmentAngle * 0.55);
  const delta = (desiredMod - base + 360) % 360;

  const totalRotation = S.currentRotation + fullSpins + delta + jitter;
  return { totalRotation, segmentAngle };
}

function _cancelSpinLoop(){
  if (S._spinRaf) { try { cancelAnimationFrame(S._spinRaf); } catch(_){} }
  S._spinRaf = 0;
  S.spinToken = (S.spinToken || 0) + 1;
}

function startSpin() {
  kickAudio(true);

  const reduceMotion = isReducedMotion();
  const userIdInput = $("userIdInput");
  const rawUserId = userIdInput ? userIdInput.value.trim() : "";
  const userId = normalizeUserIdInput(rawUserId);

  if (!userId) {
    showToast("Masukkan User ID terlebih dahulu!", "error");
    try { userIdInput && userIdInput.focus({ preventScroll: true }); } catch(_){}
    return;
  }
  if (S.hasSpun) { showToast("Anda sudah melakukan spin! Kesempatan hanya 1x.", "error"); return; }
  if (S.isSpin) return;

  S.isSpin = true;
  pauseHistory("spin");
  pauseHistory("modal"); // pre-hold supaya tidak flicker

  if (CONFIG.SCROLL.AUTO_FOCUS_ON_SPIN) {
    try { focusWheelIntoView(false); } catch(_){}
  }

  // cancel any previous spin loop immediately
  _cancelSpinLoop();

  const spinBtn = $("spinBtn");
  if (spinBtn) { spinBtn.disabled = true; spinBtn.textContent = "SPINNING…"; }

  const pointerEl = S.pointerEl || $("pointerEl");
  if (pointerEl) pointerEl.classList.add("is-spin");

  playSpinStart();

  const prizeIndex = (BONUS_INDEX >= 0 ? BONUS_INDEX : 0);
  const { totalRotation, segmentAngle } = _computeTargetRotation(prizeIndex);

  const from = Number(S.currentRotation || 0);
  const to = Number(totalRotation || 0);

  const durationMs = reduceMotion ? 360 : Number(CONFIG.SPIN_DURATION_MS || 6000);

  // tick sync vars
  const dir = (to >= from) ? 1 : -1;
  const startAngle = from;
  let lastTickStep = 0;
  let lastAngle = from;
  let lastT = performance.now();

  const maxTicks = 165; // perf cap
  const totalSteps = Math.min(maxTicks, Math.max(0, Math.floor(Math.abs(to - from) / segmentAngle)));

  // For accurate segment-crossing, we use "virtual tick step" count
  function _tickIfNeeded(currAngle, speedDegPerMs){
    const passed = Math.floor(Math.abs(currAngle - startAngle) / segmentAngle);
    if (passed <= lastTickStep) return;
    const newTicks = Math.min(passed - lastTickStep, 3); // limit burst per frame
    lastTickStep = passed;

    const speedNorm = clamp(speedDegPerMs / 1.35, 0, 1); // normalize feel
    for (let i = 0; i < newTicks; i++){
      // intensity: stronger early, softer near end
      const prog = totalSteps ? (passed / totalSteps) : 0.5;
      const intensity = clamp(1.08 - prog*0.60, 0.45, 1.15);
      playTick(intensity, speedNorm);
    }
  }

  const token = S.spinToken;
  const t0 = performance.now();
  const wheel = S.wheelEl || $("wheel");
  S.wheelEl = wheel;

  let ended = false;
  const finish = () => {
    if (ended) return;
    ended = true;

    // stop loops
    _cancelSpinLoop();

    applyWheelRotation(to);
    saveRotation(to);

    playSpinStop();
    playWin();

    if (pointerEl) pointerEl.classList.remove("is-spin");

    S.hasSpun = true;
    S.spinAt = Date.now();
    lsSet(LS.HAS_SPUN, "true");
    lsSet(LS.SPIN_AT, String(S.spinAt));
    lsSet(LS.LAST_USER_ID, userId);
    S.savedUserId = userId;

    S.lastResult = { userId, prizeLabel: BONUS_LABEL, prizeDisplay: CONFIG.PRIZE_DISPLAY_MAP[BONUS_LABEL], ts: S.spinAt };

    $("prizeAmount") && ($("prizeAmount").textContent = BONUS_LABEL);
    $("modalUserId") && ($("modalUserId").textContent = userId);
    $("modalTime") && ($("modalTime").textContent = new Date(S.spinAt).toLocaleString("id-ID", {
      day: "2-digit", month: "short", year: "numeric",
      hour: "2-digit", minute: "2-digit", second: "2-digit"
    }));

    pushWinnerEntry({
      id: makeEntryId("user"),
      isUser: true,
      fullId: userId,
      displayId: userId,
      prizeKey: BONUS_LABEL,
      prize: CONFIG.PRIZE_DISPLAY_MAP[BONUS_LABEL],
      ts: S.spinAt,
      isNew: true
    });

    updateUI();
    try { celebrateWin && celebrateWin(); } catch(_){}

    // remove spin pause while modal pause already active (no flicker)
    resumeHistory("spin");
    openModal();

    S.isSpin = false;
  };

  if (!wheel || reduceMotion) { finish(); return; }

  // real smooth spin by RAF
  const step = () => {
    if (S.spinToken !== token) return;

    const now = performance.now();
    const t = clamp((now - t0) / durationMs, 0, 1);

    // easing: casino spin (fast start, long glide)
    const k = _easeOutQuint(t);

    const angle = from + (to - from) * k;

    // update transform
    wheel.style.willChange = "transform";
    wheel.style.transform = `rotate(${angle}deg) translateZ(0)`;

    // speed estimate
    const dt = Math.max(1, now - lastT);
    const speed = Math.abs(angle - lastAngle) / dt; // deg/ms
    lastT = now;
    lastAngle = angle;

    _tickIfNeeded(angle, speed);

    if (t < 1) {
      S._spinRaf = requestAnimationFrame(step);
      MT2_SYS._rafs.push(S._spinRaf);
      return;
    }

    try { wheel.style.willChange = ""; } catch(_){}
    finish();
  };

  S._spinRaf = requestAnimationFrame(step);
  MT2_SYS._rafs.push(S._spinRaf);

  // watchdog fallback
  _st(() => { if (S.spinToken === token && S.isSpin) finish(); }, durationMs + 650);
}

/* -------------------------
 * CONFETTI — POJOK KIRI ATAS + KANAN ATAS (NO GAP, SAFE-AREA, VISUALVIEWPORT)
 * ------------------------- */
(function () {
  const MT2_CONF = window.__MT2_CONF || (window.__MT2_CONF = {});
  const CLAMP01 = (v) => Math.max(0, Math.min(1, v));

  function isDocHidden() {
    try { return document.visibilityState === "hidden"; } catch (_) { return false; }
  }

  function _vv() {
    const vv = window.visualViewport;
    const w = Math.max(1, Math.round(vv?.width || window.innerWidth || 1));
    const h = Math.max(1, Math.round(vv?.height || window.innerHeight || 1));
    const x = Math.round(vv?.offsetLeft || 0);
    const y = Math.round(vv?.offsetTop || 0);
    const dpr = Math.max(1, Number(window.devicePixelRatio || 1) || 1);
    return { w, h, x, y, dpr };
  }

  function _safeInsets() {
    if (MT2_CONF._insets) return MT2_CONF._insets;
    const d = document.createElement("div");
    d.style.cssText =
      "position:fixed;inset:0;visibility:hidden;pointer-events:none;" +
      "padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);";
    (document.documentElement || document.body).appendChild(d);
    const cs = getComputedStyle(d);
    const ins = {
      top: parseFloat(cs.paddingTop) || 0,
      right: parseFloat(cs.paddingRight) || 0,
      bottom: parseFloat(cs.paddingBottom) || 0,
      left: parseFloat(cs.paddingLeft) || 0,
    };
    d.remove();
    MT2_CONF._insets = ins;
    return ins;
  }

  function getConfettiCanvas() {
    let c = document.getElementById("mt2_confetti_canvas");
    if (c) return c;

    c = document.createElement("canvas");
    c.id = "mt2_confetti_canvas";
    c.setAttribute("aria-hidden", "true");

    Object.assign(c.style, {
      position: "fixed",
      left: "0px",
      top: "0px",
      width: "100px",
      height: "100px",
      pointerEvents: "none",
      zIndex: "999999",
      transform: "translateZ(0)",
    });

    (document.documentElement || document.body).appendChild(c);
    return c;
  }

  function _syncCanvas() {
    const c = getConfettiCanvas();
    const { w, h, x, y, dpr } = _vv();

    c.style.left = x + "px";
    c.style.top = y + "px";
    c.style.width = w + "px";
    c.style.height = h + "px";

    const cw = Math.floor(w * dpr);
    const ch = Math.floor(h * dpr);
    if (c.width !== cw) c.width = cw;
    if (c.height !== ch) c.height = ch;
  }

  function getConfettiInstance() {
    if (MT2_CONF._fx) return MT2_CONF._fx;
    if (typeof window.confetti !== "function") return null;

    _syncCanvas();
    const canvas = getConfettiCanvas();

    try {
      MT2_CONF._fx = window.confetti.create(canvas, { resize: false, useWorker: true });
    } catch (_) {
      try {
        MT2_CONF._fx = window.confetti.create(canvas, { resize: false, useWorker: false });
      } catch (__){
        MT2_CONF._fx = window.confetti;
      }
    }

    if (!MT2_CONF._bound) {
      const onR = () => {
        MT2_CONF._insets = null;
        _syncCanvas();
        try { MT2_CONF._fx?.reset?.(); } catch (_) {}
      };

      window.addEventListener("resize", onR, { passive: true });
      try {
        window.visualViewport?.addEventListener("resize", onR, { passive: true });
        window.visualViewport?.addEventListener("scroll", onR, { passive: true });
      } catch (_) {}

      MT2_CONF._bound = true;
    }

    return MT2_CONF._fx;
  }

  function getPerformanceBudget() {
    const { w, h } = _vv();
    const area = w * h;

    const baseArea = 390 * 844;
    let scale = Math.sqrt(area / baseArea);
    scale = Math.max(0.75, Math.min(1.45, scale));

    const mem = (navigator && navigator.deviceMemory) ? Number(navigator.deviceMemory) : 0;
    const lowEnd = mem && mem <= 2;
    const saveData = !!(navigator && navigator.connection && navigator.connection.saveData);
    if (lowEnd || saveData) scale *= 0.78;

    return {
      scale,
      big: Math.round(125 * scale),
      mid: Math.round(74 * scale),
      small: Math.round(42 * scale),
      scalar: Math.max(0.85, Math.min(1.15, 1.0 * scale)),
    };
  }

  function jitterOrigin(origin, amt) {
    const j = amt || 0.010;
    return {
      x: CLAMP01(origin.x + (Math.random() * 2 - 1) * j),
      y: CLAMP01(origin.y + (Math.random() * 2 - 1) * j),
    };
  }

  function cornerOrigins() {
    const { w, h } = _vv();
    const ins = _safeInsets();
    const pad = Math.max(6, Math.round(Math.min(w, h) * 0.012));

    const xLpx = ins.left + pad;
    const xRpx = w - (ins.right + pad);
    const yTpx = ins.top + pad;

    const xL = CLAMP01(xLpx / w);
    const xR = CLAMP01(xRpx / w);
    const y  = CLAMP01(Math.min(0.085, yTpx / h));

    return {
      left:  { x: Math.max(0.004, Math.min(0.035, xL)), y },
      right: { x: Math.min(0.996, Math.max(0.965, xR)), y },
    };
  }

  window.celebrateWin = function celebrateWin() {
    if (typeof isReducedMotion === "function" && isReducedMotion()) return;
    const fx = getConfettiInstance();
    if (!fx || isDocHidden()) return;

    _syncCanvas();

    const budget = getPerformanceBudget();
    const { left, right } = cornerOrigins();
    const token = (MT2_CONF._token = (MT2_CONF._token || 0) + 1);
    const t0 = performance.now();

    const timeline = [
      { at: 0, fn: () => fx({ particleCount: budget.big, angle: 320, spread: 92, startVelocity: 72, decay: 0.90, gravity: 1.12, ticks: 260, scalar: budget.scalar * 1.04, origin: jitterOrigin(left, 0.008) })},
      { at: 0, fn: () => fx({ particleCount: budget.big, angle: 220, spread: 92, startVelocity: 72, decay: 0.90, gravity: 1.12, ticks: 260, scalar: budget.scalar * 1.04, origin: jitterOrigin(right, 0.008) })},
      { at: 140, fn: () => fx({ particleCount: budget.mid, angle: 300, spread: 122, startVelocity: 56, decay: 0.905, gravity: 1.05, ticks: 285, scalar: budget.scalar * 1.00, origin: jitterOrigin(left, 0.010) })},
      { at: 140, fn: () => fx({ particleCount: budget.mid, angle: 240, spread: 122, startVelocity: 56, decay: 0.905, gravity: 1.05, ticks: 285, scalar: budget.scalar * 1.00, origin: jitterOrigin(right, 0.010) })},
      { at: 520, fn: () => fx({ particleCount: Math.max(14, Math.round(budget.small * 0.72)), angle: 285, spread: 112, startVelocity: 38, decay: 0.92, gravity: 1.22, ticks: 210, scalar: budget.scalar * 0.86, origin: jitterOrigin(left, 0.014) })},
      { at: 520, fn: () => fx({ particleCount: Math.max(14, Math.round(budget.small * 0.72)), angle: 255, spread: 112, startVelocity: 38, decay: 0.92, gravity: 1.22, ticks: 210, scalar: budget.scalar * 0.86, origin: jitterOrigin(right, 0.014) })},
    ];

    let i = 0;
    const pump = () => {
      if (MT2_CONF._token !== token) return;
      if (isDocHidden()) return;

      const now = performance.now() - t0;
      while (i < timeline.length && now >= timeline[i].at) {
        try { timeline[i].fn(); } catch (_) {}
        i++;
      }
      if (i < timeline.length) requestAnimationFrame(pump);
    };

    requestAnimationFrame(pump);
  };
})();

/* =========================
 * PNG Download + Share (reuse canvas)
 * ========================= */
let MEASURE_CTX = null;
function getMeasureCtx() {
  if (MEASURE_CTX) return MEASURE_CTX;
  try {
    const c = document.createElement("canvas");
    c.width = 32; c.height = 32;
    MEASURE_CTX = c.getContext("2d") || null;
  } catch(_){ MEASURE_CTX = null; }
  return MEASURE_CTX;
}

function drawOrb(ctx, x, y, r, color) {
  const g = ctx.createRadialGradient(x, y, 0, x, y, r);
  g.addColorStop(0, color);
  g.addColorStop(1, "rgba(0,0,0,0)");
  ctx.fillStyle = g;
  ctx.beginPath();
  ctx.arc(x, y, r, 0, Math.PI * 2);
  ctx.fill();
}

function roundRect(ctx, x, y, w, h, r) {
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x + rr, y);
  ctx.arcTo(x + w, y, x + w, y + h, rr);
  ctx.arcTo(x + w, y + h, x, y + h, rr);
  ctx.arcTo(x, y + h, x, y, rr);
  ctx.arcTo(x, y, x + w, y, rr);
  ctx.closePath();
}

function buildFileName(userId, ts) {
  const d = new Date(ts || Date.now());
  const y = d.getFullYear();
  const m = pad2(d.getMonth() + 1);
  const da = pad2(d.getDate());
  const hh = pad2(d.getHours());
  const mm = pad2(d.getMinutes());
  const safeId = String(userId || "USER").replace(/[^A-Z0-9_-]/gi, "").slice(0, 18) || "USER";
  return `MADETOTO2-REWARD-${safeId}-${y}${m}${da}-${hh}${mm}.png`;
}

function fitTextWithEllipsis(ctx, text, maxWidth) {
  const ell = "…";
  if (ctx.measureText(text).width <= maxWidth) return text;

  let t = String(text || "");
  while (t.length > 1 && ctx.measureText(t + ell).width > maxWidth) {
    t = t.slice(0, -1);
  }
  return t.trim() + ell;
}

function wrapLinesByWords(ctx, text, maxWidth, maxLines) {
  const words = String(text || "").split(/\s+/).filter(Boolean);
  const lines = [];
  let line = "";

  for (let i = 0; i < words.length; i++) {
    const test = line ? (line + " " + words[i]) : words[i];
    const w = ctx.measureText(test).width;

    if (w <= maxWidth) { line = test; continue; }

    if (line) lines.push(line);
    line = words[i];

    if (lines.length === (maxLines - 1)) break;
  }

  if (line) lines.push(line);

  if (lines.length === maxLines) {
    const lastIdx = maxLines - 1;
    lines[lastIdx] = fitTextWithEllipsis(ctx, lines[lastIdx], maxWidth);
  }
  return lines;
}

function layoutAdaptiveHeadline(ctx, text, maxWidth, opt) {
  const t = String(text || "").trim();
  const maxFont = opt.maxFont || 86;
  const minFont = opt.minFont || 56;
  const weight  = opt.weight  || 1000;
  const family  = opt.family  || "system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const maxLines = opt.maxLines || 2;
  const lineHScale = opt.lineHScale || 0.92;

  let fontSize = maxFont;
  let lines = [t];

  while (fontSize >= minFont) {
    ctx.font = `${weight} ${fontSize}px ${family}`;
    lines = wrapLinesByWords(ctx, t, maxWidth, maxLines);
    if (lines.length <= maxLines) break;
    fontSize -= 2;
  }

  const lineH = Math.ceil(fontSize * lineHScale);
  return { fontSize, lineH, lines };
}

function calcRewardPngLayout(r, ts) {
  const baseW = 1080;

  const pad = 66;
  const cardX = pad;
  const cardY = 120;
  const cardW = baseW - pad * 2;

  const innerX = cardX + 44;
  const innerW = cardW - 88;

  const brandY = cardY + 90;
  const subY   = cardY + 140;

  const prizeStartY = cardY + 255;
  const prizeText = String(r.prizeLabel || "BONUS 10%");

  const mctx = getMeasureCtx();
  const prize = layoutAdaptiveHeadline(mctx, prizeText, innerW, {
    maxFont: 86,
    minFont: 56,
    weight: 1000,
    family: "system-ui, -apple-system, Segoe UI, Roboto, Arial",
    lineHScale: 0.90,
    maxLines: 2
  });

  const prizeBlockH = Math.ceil((prize.lines.length - 1) * prize.lineH + prize.fontSize * 1.12);
  const prizeBottom = prizeStartY + prizeBlockH;

  const dividerY = Math.ceil(prizeBottom + 14);

  const userLabelY = dividerY + 70;
  const userValueY = userLabelY + 42;

  const timeLabelY = userValueY + 64;
  const timeValueY = timeLabelY + 40;

  const noteY = Math.ceil(timeValueY + 56);
  const noteX = innerX;
  const noteW = innerW;

  const noteText = "Silakan klaim melalui Live Chat dan sertakan USER ID + hasil unduh ini.";
  const noteFont = "800 22px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const noteLineH = 28;

  mctx.font = noteFont;
  const noteInnerPadX = 26;
  const noteInnerPadY = 22;
  const noteMaxW = noteW - noteInnerPadX * 2;

  const noteLines = wrapLinesByWords(mctx, noteText, noteMaxW, 3);
  const noteH = Math.max(68, noteInnerPadY * 2 + noteLines.length * noteLineH + 2);

  const noteTextX = noteX + noteInnerPadX;
  const noteTextY = noteY + noteInnerPadY + 22;

  const footerY = Math.ceil(noteY + noteH + 58);

  const cardH = Math.ceil((footerY + 40) - cardY);
  const baseH = Math.ceil(cardY + cardH + 110);

  return {
    baseW, baseH,
    cardX, cardY, cardW, cardH,
    innerX, innerW,
    brandY, subY,
    prizeStartY, prize,
    dividerY,
    userLabelY, userValueY,
    timeLabelY, timeValueY,
    noteX, noteY, noteW, noteH,
    noteLines, noteLineH, noteTextX, noteTextY,
    footerY
  };
}

function buildResultCanvasAndName() {
  if (!S.lastResult) return null;
  const r = S.lastResult;
  const ts = r.ts || Date.now();
  const lay = calcRewardPngLayout(r, ts);

  const canvas = document.createElement("canvas");
  const dpr = Math.min(2, window.devicePixelRatio || 1);
  canvas.width  = Math.floor(lay.baseW * dpr);
  canvas.height = Math.floor(lay.baseH * dpr);

  const ctx = canvas.getContext("2d");
  if (!ctx) return null;
  ctx.scale(dpr, dpr);

  const g = ctx.createLinearGradient(0, 0, lay.baseW, lay.baseH);
  g.addColorStop(0, "#06130f");
  g.addColorStop(0.55, "#071e16");
  g.addColorStop(1, "#05281d");
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, lay.baseW, lay.baseH);

  drawOrb(ctx, 260, 220, 260, "rgba(34,197,94,0.14)");
  drawOrb(ctx, lay.baseW - 220, 320, 220, "rgba(255,255,255,0.07)");
  drawOrb(ctx, lay.baseW - 260, lay.baseH - 260, 300, "rgba(20,184,166,0.10)");

  roundRect(ctx, lay.cardX, lay.cardY, lay.cardW, lay.cardH, 34);

  const cg = ctx.createLinearGradient(lay.cardX, lay.cardY, lay.cardX + lay.cardW, lay.cardY + lay.cardH);
  cg.addColorStop(0, "rgba(6,18,14,0.95)");
  cg.addColorStop(1, "rgba(7,30,22,0.95)");
  ctx.fillStyle = cg;
  ctx.fill();

  ctx.lineWidth = 4;
  ctx.strokeStyle = "rgba(34,197,94,0.55)";
  ctx.stroke();

  ctx.fillStyle = "rgba(255,255,255,0.95)";
  ctx.font = "900 44px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText("MADETOTO2", lay.innerX, lay.brandY);

  ctx.fillStyle = "rgba(255,255,255,0.78)";
  ctx.font = "700 24px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText("HASIL SPIN REWARD", lay.innerX, lay.subY);

  ctx.fillStyle = "#bbf7d0";
  ctx.font = `1000 ${lay.prize.fontSize}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;

  ctx.save();
  ctx.shadowColor = "rgba(0,0,0,0.28)";
  ctx.shadowBlur = 18;
  ctx.shadowOffsetY = 10;
  for (let i = 0; i < lay.prize.lines.length; i++) {
    ctx.fillText(lay.prize.lines[i], lay.innerX, lay.prizeStartY + i * lay.prize.lineH);
  }
  ctx.restore();

  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(lay.innerX, lay.dividerY);
  ctx.lineTo(lay.innerX + lay.innerW, lay.dividerY);
  ctx.stroke();

  ctx.fillStyle = "rgba(255,255,255,0.70)";
  ctx.font = "800 22px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace";
  ctx.fillText("USER ID", lay.innerX, lay.userLabelY);
  ctx.fillText("WAKTU",   lay.innerX, lay.timeLabelY);

  ctx.fillStyle = "rgba(255,255,255,0.96)";
  ctx.font = "900 32px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace";
  ctx.fillText(String(r.userId || "-"), lay.innerX, lay.userValueY);

  const timeStr = new Date(ts).toLocaleString("id-ID", {
    day: "2-digit", month: "short", year: "numeric",
    hour: "2-digit", minute: "2-digit", second: "2-digit"
  });
  ctx.fillText(timeStr, lay.innerX, lay.timeValueY);

  roundRect(ctx, lay.noteX, lay.noteY, lay.noteW, lay.noteH, 22);
  ctx.fillStyle = "rgba(0,0,0,0.30)";
  ctx.fill();
  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.lineWidth = 2;
  ctx.stroke();

  ctx.fillStyle = "rgba(255,255,255,0.88)";
  ctx.font = "800 22px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  for (let i = 0; i < lay.noteLines.length; i++) {
    ctx.fillText(lay.noteLines[i], lay.noteTextX, lay.noteTextY + i * lay.noteLineH);
  }

  ctx.fillStyle = "rgba(255,255,255,0.55)";
  ctx.font = "700 18px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText("Spin & Win • MADETOTO2", lay.innerX, lay.footerY);

  const fileName = buildFileName(r.userId, ts);
  return { canvas, fileName, ts, r };
}

function triggerDownload(url, filename) {
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.rel = "noopener";
  a.target = "_blank";
  document.body.appendChild(a);
  a.click();
  a.remove();

  _st(() => {
    try { if (/iPhone|iPad|iPod/i.test(navigator.userAgent || "")) window.open(url, "_blank", "noopener,noreferrer"); } catch (_) {}
  }, 120);
}

function downloadResultPng() {
  if (!S.lastResult) { showToast("Hasil belum tersedia. Silakan spin terlebih dahulu.", "error"); return; }
  try { kickAudio(true); } catch (_) {}

  const pack = buildResultCanvasAndName();
  if (!pack) { showToast("Gagal membuat gambar hasil.", "error"); return; }

  const { canvas, fileName } = pack;

  const done = (blobOrDataUrl) => {
    try {
      if (blobOrDataUrl instanceof Blob) {
        const url = URL.createObjectURL(blobOrDataUrl);
        triggerDownload(url, fileName);
        _st(() => URL.revokeObjectURL(url), 2500);
      } else if (typeof blobOrDataUrl === "string") {
        triggerDownload(blobOrDataUrl, fileName);
      }
      showToast("File hasil berhasil dibuat", "success");
    } catch (_) {
      showToast("Gagal mengunduh. File akan dibuka di tab baru.", "error");
      try {
        const url = (blobOrDataUrl instanceof Blob) ? URL.createObjectURL(blobOrDataUrl) : String(blobOrDataUrl || "");
        window.open(url, "_blank", "noopener,noreferrer");
      } catch (_) {}
    }
  };

  if (canvas.toBlob) {
    canvas.toBlob((blob) => { if (!blob) { done(canvas.toDataURL("image/png")); return; } done(blob); }, "image/png", 0.92);
  } else {
    done(canvas.toDataURL("image/png"));
  }
}

/* =========================
 * Share (POWER-UP — universal, smooth)
 * ========================= */
function syncShareState(){
  const btn = $("shareBtn");
  if (!btn) return;

  const ok = !!(S && S.lastResult);
  btn.disabled = !ok;
  btn.setAttribute("aria-disabled", ok ? "false" : "true");
  if (btn.classList) btn.classList.toggle("is-disabled", !ok);

  if (ok) { try { primeShareAsset(S.lastResult); } catch(_){} }
}

function _shareKey(res){
  const uid = res?.userId || "";
  const prize = res?.prizeLabel || res?.prize || "";
  const ts = res?.ts || res?.time || res?.createdAt || "";
  const spinId = res?.id || res?.spinId || "";
  return `${uid}::${prize}::${ts}::${spinId}`;
}

function _safeShareUrl(){
  try {
    const raw = (CONFIG && CONFIG.SHARE_URL) ? String(CONFIG.SHARE_URL) : String(location.href || "");
    return String(new URL(raw, location.href).toString());
  } catch(_) {
    return String(location.href || "");
  }
}

function _sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

function _downloadFile(file){
  try{
    const url = URL.createObjectURL(file);
    const a = document.createElement("a");
    a.href = url;
    a.download = file.name || "MADETOTO2-REWARD.png";
    a.rel = "noopener";
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      try { URL.revokeObjectURL(url); } catch(_){}
      try { a.remove(); } catch(_){}
    }, 800);
    return true;
  }catch(_){ return false; }
}

function _getShareCache(){
  if (!S._shareCache) S._shareCache = { key:"", file:null, at:0, primeToken:0, busy:false };
  return S._shareCache;
}

function _getCachedShareFile(res){
  const c = _getShareCache();
  if (!c || !c.file) return null;
  const key = _shareKey(res);
  if (c.key === key && (Date.now() - (c.at || 0)) < 10 * 60 * 1000) return c.file;
  return null;
}

async function _buildShareFile(){
  let file = null;
  try{
    await new Promise(r => requestAnimationFrame(r));
    const pack = buildResultCanvasAndName && buildResultCanvasAndName();
    if (pack && pack.canvas && pack.canvas.toBlob) {
      const blob = await new Promise((resolve) => {
        try { pack.canvas.toBlob(resolve, "image/png", 0.92); } catch(_) { resolve(null); }
      });
      if (blob) file = new File([blob], pack.fileName || "MADETOTO2-REWARD.png", { type: "image/png" });
    }
  }catch(_){ file = null; }
  return file;
}

function primeShareAsset(res = (S && S.lastResult)){
  if (!res) return;
  const c = _getShareCache();
  if (!c) return;

  const key = _shareKey(res);
  if (c.key === key && c.file) return;

  const token = (c.primeToken = (c.primeToken || 0) + 1);

  const run = async () => {
    if (c.busy) return;
    const f = await _buildShareFile();
    if (c.primeToken !== token) return;
    if (f) { c.key = key; c.file = f; c.at = Date.now(); }
  };

  try{
    if ("requestIdleCallback" in window) requestIdleCallback(() => { run(); }, { timeout: 1200 });
    else setTimeout(() => { run(); }, 50);
  }catch(_){
    setTimeout(() => { run(); }, 50);
  }
}

async function shareResult(){
  const res = S && S.lastResult;
  if (!res) { showToast("Hasil belum tersedia untuk dibagikan.", "error"); return; }

  const c = _getShareCache();
  if (c && c.busy) return;
  if (c) c.busy = true;

  try { kickAudio(true); } catch(_){}

  if (typeof window.__MT2_SHARE_HANDLER === "function") {
    try {
      await window.__MT2_SHARE_HANDLER(res);
      showToast("Menu bagikan dibuka", "success", 1400);
      return;
    } catch(_){}
  }

  const url = _safeShareUrl();
  const title = (CONFIG && CONFIG.SHARE_TITLE) ? String(CONFIG.SHARE_TITLE) : "MADETOTO2 - Hasil Spin";
  const text =
    `🎉 ${title}\n` +
    `User ID: ${res.userId || "-"}\n` +
    `Hadiah: ${res.prizeLabel || res.prize || "-"}\n` +
    (url ? `\n${url}` : "");

  let file = _getCachedShareFile(res);

  if (!file) {
    try {
      file = await Promise.race([_buildShareFile(), _sleep(220)]);
      if (file && c) { c.key = _shareKey(res); c.file = file; c.at = Date.now(); }
    } catch(_){ file = null; }
  }

  if (navigator.share) {
    const base = { title, text, url };

    if (file && navigator.canShare && navigator.canShare({ files: [file] })) {
      try {
        await navigator.share({ ...base, files: [file] });
        showToast("Menu bagikan dibuka", "success", 1400);
        return;
      } catch(e){
        if (e && (e.name === "AbortError" || e.name === "NotAllowedError")) {
          showToast("Bagikan dibatalkan.", "muted", 1200);
          return;
        }
      }
    }

    try {
      await navigator.share(base);
      showToast("Menu bagikan dibuka", "success", 1400);
      return;
    } catch(e){
      if (e && (e.name === "AbortError" || e.name === "NotAllowedError")) {
        showToast("Bagikan dibatalkan.", "muted", 1200);
        return;
      }
    }

    try {
      await navigator.share({ title, text });
      showToast("Menu bagikan dibuka", "success", 1400);
      return;
    } catch(_){}
  }

  if (file && window.ClipboardItem && navigator.clipboard && navigator.clipboard.write) {
    try {
      const item = new ClipboardItem({ "image/png": file });
      await navigator.clipboard.write([item]);
      try { await navigator.clipboard.writeText(text); } catch(_){}
      showToast("Gambar + teks siap dipaste ke sosmed.", "success", 2000);
      return;
    } catch(_){}
  }

  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(text);
      showToast("Teks bagikan disalin.", "success", 1800);
      if (file) { try { _downloadFile(file); } catch(_){} }
      return;
    }
  } catch(_){}

  if (file) {
    const ok = _downloadFile(file);
    if (ok) showToast("Gambar diunduh. Tinggal upload ke sosmed.", "success", 2200);
  }

  try { window.prompt("Salin teks ini untuk dibagikan:", text); } catch(_){}
  showToast("Bagikan otomatis tidak didukung di browser ini.", "error", 2400);
}

function setupShareButton(){
  const btn = $("shareBtn");
  if (!btn) return;
  if (btn.dataset && btn.dataset.bound === "1") return;
  if (btn.dataset) btn.dataset.bound = "1";

  const fire = (ev) => {
    if (btn.disabled) { showToast("Belum ada hasil untuk dibagikan.", "muted", 1400); return; }
    pressFX(btn, ev);
    shareResult().finally(()=>{ const c=_getShareCache(); if (c) c.busy=false; });
  };

  _on(btn, "click", fire);
  _on(btn, "pointerdown", (e) => pressFX(btn, e), { passive: true });

  _on(btn, "keydown", (e) => {
    const k = e.key || "";
    if (k === "Enter" || k === " " || k === "Spacebar") {
      e.preventDefault();
      fire(e);
    }
  });

  syncShareState();
}

/* =========================
 * Claim overlay + watchdog
 * ========================= */
let claimInFlight = false;
let claimWatchdogT = 0;

function isNavOpen(){
  const el = $("navLoading");
  return !!(el && el.classList.contains("show"));
}

function showNavLoading() {
  const el = $("navLoading");
  if (!el) return;
  pauseHistory("nav");
  setInert("nav", true);
  el.classList.add("show");
  el.setAttribute("aria-hidden", "false");
  document.body.classList.add("modal-open");
}

function hideNavLoading(immediate = false) {
  const el = $("navLoading");
  if (!el) return;

  const done = () => {
    el.classList.remove("show");
    el.setAttribute("aria-hidden", "true");
    claimInFlight = false;
    resumeHistory("nav");
    setInert("nav", false);
    if (!isModalOpen()) document.body.classList.remove("modal-open");
  };

  if (claimWatchdogT) { clearTimeout(claimWatchdogT); claimWatchdogT = 0; }

  if (immediate || isReducedMotion()) { done(); return; }
  el.classList.remove("show");
  el.setAttribute("aria-hidden", "true");
  _st(done, 260);
}

function claimPrize() {
  if (claimInFlight) return;
  claimInFlight = true;

  closeModal();
  showNavLoading();

  const start = performance.now ? performance.now() : Date.now();
  const minHold = isReducedMotion() ? 0 : CONFIG.CLAIM_OVERLAY_MIN_MS;

  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      const now = performance.now ? performance.now() : Date.now();
      const elapsed = now - start;
      const wait = Math.max(0, minHold - elapsed);

      _st(() => {
        claimWatchdogT = _st(() => {
          if (isNavOpen() && !document.hidden) {
            hideNavLoading(true);
            showToast("Gagal membuka halaman klaim. Coba tekan KLAIM lagi.", "error", 2600);
          }
        }, 10000);

        try { window.location.href = CONFIG.CLAIM_URL; } catch(_) {
          hideNavLoading(true);
          showToast("Tidak bisa membuka halaman klaim.", "error", 2400);
        }
      }, wait);
    });
  });
}

/* =========================
 * Persist user entry
 * ========================= */
function bootPersistedUserEntry() {
  if (S.hasSpun && !S.spinAt) { S.spinAt = Date.now(); lsSet(LS.SPIN_AT, String(S.spinAt)); }

  if (S.hasSpun && S.savedUserId) {
    S.lastResult = { userId: S.savedUserId, prizeLabel: BONUS_LABEL, prizeDisplay: CONFIG.PRIZE_DISPLAY_MAP[BONUS_LABEL], ts: S.spinAt || Date.now() };

    const already = S.winners.some(w => w.isUser === true);
    if (!already) {
      pushWinnerEntry({
        id: makeEntryId("user"),
        isUser: true,
        fullId: S.savedUserId,
        displayId: S.savedUserId,
        prizeKey: BONUS_LABEL,
        prize: CONFIG.PRIZE_DISPLAY_MAP[BONUS_LABEL],
        ts: S.spinAt || Date.now(),
        isNew: false
      });
    }
  }

  if (!isModalOpen()) {
    S.pauseReasons.delete("modal");
  }

  syncShareState();
}

/* =========================
 * DOM Boot
 * ========================= */
document.addEventListener("DOMContentLoaded", () => {
  detectLowEnd();

  S.pointerEl = $("pointerEl");
  S.wheelEl = $("wheel");

  const spinBtn = $("spinBtn");
  const userIdInput = $("userIdInput");
  const claimBtn = $("claimBtn");
  const downloadBtn = $("downloadBtn");
  const modal = $("prizeModal");

  setupAudio();
  initWheelAutoResize();
  initFxParticlesCanvas();
  setupShareButton();

  if (!S.winners || !S.winners.length) S.winners = generateMockWinnersRandom();
  bootPersistedUserEntry();

  applyWheelRotation(S.currentRotation);
  renderWinners({ preserveScroll: true });
  startMetaTicker();
  updateUI();

  S.jackpot = initJackpot();
  startJackpot();
  startLiveHistory();
  setupHistoryRowOpen();

  if (userIdInput) {
    _on(userIdInput, "input", () => { userIdInput.value = normalizeUserIdInput(userIdInput.value); });
    _on(userIdInput, "keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); startSpin(); }
    });
  }

  if (spinBtn) {
    _on(spinBtn, "click", () => startSpin());
    _on(spinBtn, "pointerdown", (e) => pressFX(spinBtn, e), { passive: true });
  }

  if (claimBtn) {
    _on(claimBtn, "click", () => claimPrize());
    _on(claimBtn, "pointerdown", (e) => pressFX(claimBtn, e), { passive: true });
  }

  if (downloadBtn) {
    _on(downloadBtn, "click", () => downloadResultPng());
    _on(downloadBtn, "pointerdown", (e) => pressFX(downloadBtn, e), { passive: true });
  }

  if (modal) {
    _on(modal, "click", (e) => { if (e.target && e.target.id === "prizeModal") closeModal(); });
  }

  const kick = () => kickAudio(true);
  _on(window, "pointerdown", kick, { passive: true, once: true });
  _on(window, "keydown", kick, { passive: true, once: true });

  _on(document, "visibilitychange", () => {
    if (document.hidden) { stopLiveHistory(); stopJackpot(); }
    else { startJackpot(); if (S.pauseReasons.size === 0) startLiveHistory(); }
  });

  _on(window, "pagehide", () => { stopLiveHistory(); stopJackpot(); _cancelSpinLoop(); });
  _on(window, "pageshow", () => {
    if (isNavOpen()) hideNavLoading(true);
    if (!document.hidden) {
      startJackpot();
      if (S.pauseReasons.size === 0) startLiveHistory();
    }
  });

  try {
    if (_rmq && _rmq.addEventListener) {
      _on(_rmq, "change", () => {
        try { initWheelAutoResize(); } catch(_){}
        try { initFxParticlesCanvas(); } catch(_){}
      });
    }
  } catch(_) {}

  _on(window, "storage", (e) => {
    if (!e || !e.key) return;

    if (e.key === LS.HAS_SPUN || e.key === LS.SPIN_AT || e.key === LS.LAST_USER_ID || e.key === LS.ROTATION) {
      S.hasSpun = lsGet(LS.HAS_SPUN, "false") === "true";
      S.spinAt = Number(lsGet(LS.SPIN_AT, "0") || "0") || 0;
      S.savedUserId = String(lsGet(LS.LAST_USER_ID, "") || "");
      S.currentRotation = Number(lsGet(LS.ROTATION, "0") || "0") || 0;

      bootPersistedUserEntry();
      applyWheelRotation(S.currentRotation);
      updateUI();
      renderWinners({ preserveScroll: true });
    }

    if (e.key === LS.JACKPOT_VAL) {
      const v = Number(lsGet(LS.JACKPOT_VAL, "0") || "0") || 0;
      if (v > 1_000_000) {
        S.jackpot = v;
        const el = $("jackpot");
        const meta = $("jackpotMeta");
        if (el) el.textContent = `IDR ${Math.round(S.jackpot).toLocaleString("id-ID")}`;
        if (meta) meta.textContent = `Update: ${fmtClock()}`;
      }
    }
  });
});
</script>
</body>
</html>