<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no"/>

  <!-- ✅ SEO / SHARE (auto via JS dari CONFIG.site.baseUrl) -->
  <meta property="og:url" content="" />
  <link rel="canonical" href="" />
  <meta property="og:title" content="Lucky Ang Pao — Chinese New Year 2026" />
  <meta name="description" content="Pilih Ang Pao keberuntunganmu & dapatkan hadiah!" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="" />
  <meta name="theme-color" content="#19040b"/>
  <meta name="color-scheme" content="dark"/>

  <title>Lucky Ang Pao — Chinese New Year 2026</title>

  <link rel="preconnect" href="https://i.postimg.cc" crossorigin>

<style>
/* ─────────────────────────────────────────────────────────────
 * BLOK 01 — DESIGN TOKENS (CNY 2026 • PREMIUM • HD • NO-GRAIN)
 * ─────────────────────────────────────────────────────────── */
:root{
  --bg0:#19040b;
  --bg1:#2a0610;
  --bg2:#3b0712;
  --bg3:#5a0b14;

  --redHi:#ff3a44;
  --red1:#d51a2b;
  --red2:#b51221;
  --red3:#7f0a16;

  --gold0:#fff6df;
  --gold1:#ffe4a6;
  --gold2:#f2c96f;
  --gold3:#c79a40;
  --gold4:#8a6424;

  --ease:cubic-bezier(.2,.9,.18,1);
  --ease2:cubic-bezier(.22,.85,.2,1);

  --cardW:560px;
  --radius:26px;

  /* shadow system (rapi & konsisten) */
  --shDeep: 0 28px 92px rgba(0,0,0,.70);
  --shMed:  0 14px 36px rgba(0,0,0,.42);
  --shSoft: 0 10px 26px rgba(0,0,0,.30);
  --shBtn:  0 14px 30px rgba(0,0,0,.38);

  --ring:rgba(255,228,166,.58);

  --safe-top: env(safe-area-inset-top);
  --safe-bot: env(safe-area-inset-bottom);
  --scene-pad: clamp(12px, 2.2vw, 18px);
  --scene-top: calc(var(--safe-top) + var(--scene-pad));

  --cornerW: clamp(112px, 20vw, 190px);
  --corner-bg-scale-left: 100%;
  --corner-bg-scale-right: 100%;

  --wireTop: calc(var(--safe-top) + clamp(2px, .6vh, 10px));
  --lanternY: 0px;

  /* global grade (dipakai jika kamu mau) */
  --fxBright: 1.10;
  --fxContrast: 1.05;
  --fxSat: 1.08;

  /* BACKGROUND LIGHTING — presisi posisi */
  --bgGlowTopX: 50%;
  --bgGlowTopY: 18%;
  --bgGlowTopA: .16;

  --bgGlowLx: 16%;
  --bgGlowLy: 26%;
  --bgGlowLa: .11;

  --bgGlowRx: 84%;
  --bgGlowRy: 26%;
  --bgGlowRa: .11;

  --bgWarmX: 50%;
  --bgWarmY: 86%;
  --bgWarmA: .10;

  /* assets */
  --corner-left-url:  url("");
  --corner-right-url: url("");

  --cloud-left-url:  url("");
  --cloud-mid-url:   url("");
  --cloud-right-url: url("");

  --bottom-cloud-url: url("");

  --angpao-url: url("");
  --angpaoImg: 102;

  --pageTitleGap: clamp(86px, 12vh, 152px);
  --titlePadX: max(var(--scene-pad), calc(var(--cornerW) * .34));
  --titleMaxW: 2200px;
  --titleDeskBoost: 1;

  /* overlay theme */
  --ovBg: rgba(0,0,0,.76);
  --ovBlur: 9px;

  /* INPUT HEIGHT */
  --inputH: 48px; /* atur 46–54px sesuai selera */

  /* ─────────────────────────────────────────
   * ORNAMENT TUNING (px, bisa minus)
   * ───────────────────────────────────────── */
  --ornAllX: 0px; --ornAllY: 0px;
  --ornCornerX: 0px; --ornCornerY: 0px;
  --ornLanternX: 0px; --ornLanternY: 0px;
  --ornCloudX: 0px; --ornCloudY: 0px;
  --ornBottomX: 0px; --ornBottomY: 0px;
  --ornBottomOrnX: 0px;

  /* =====================================================
     UI LOCK SCALE SUPPORT (ZOOM UI SAJA)
     - aktif jika JS mengisi --uiScale & optional #uiWrap
  ===================================================== */
  --uiScale: 1;
  --uiBaseW: 1024;
  --uiBaseH: 720;
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 02 — RESET + BASE (lebih crisp, anti smear)
 * ─────────────────────────────────────────────────────────── */
*{ box-sizing:border-box; }
html,body{ height:100%; }
html{ color-scheme: dark; }

body{
  margin:0;
  position:relative;
  isolation:isolate;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
  color:#fff;

  min-height:100svh;

  /* ✅ game feel: no scroll, lebih stabil (lock mode) */
  overflow:hidden;

  -webkit-overflow-scrolling:touch;
  overscroll-behavior:none;

  /* ✅ Background lebih tajam + detail, NO grain/garis */
  background-color: var(--bg0);
  background-image:
    radial-gradient(1200px 820px at var(--bgGlowTopX) var(--bgGlowTopY),
      rgba(255,230,170,var(--bgGlowTopA)) 0%,
      rgba(255,190,110,.10) 28%,
      rgba(255,160,85,.06) 44%,
      rgba(255,228,166,0) 64%),
    radial-gradient(980px 720px at var(--bgGlowLx) var(--bgGlowLy),
      rgba(255,152,78,var(--bgGlowLa)) 0%,
      rgba(255,152,78,.06) 32%,
      rgba(255,152,78,0) 62%),
    radial-gradient(980px 720px at var(--bgGlowRx) var(--bgGlowRy),
      rgba(255,152,78,var(--bgGlowRa)) 0%,
      rgba(255,152,78,.06) 32%,
      rgba(255,152,78,0) 62%),
    radial-gradient(1400px 900px at var(--bgWarmX) var(--bgWarmY),
      rgba(255,160,55,var(--bgWarmA)) 0%,
      rgba(255,120,60,.06) 34%,
      rgba(255,228,166,0) 70%),
    linear-gradient(180deg, var(--bg3) 0%, var(--bg1) 32%, var(--bg0) 100%);

  touch-action:manipulation;
  user-select:none;
  -webkit-tap-highlight-color:transparent;

  /* teks lebih tajam */
  -webkit-font-smoothing: antialiased;
  text-rendering: geometricPrecision;
}

@supports (height:100dvh){
  body{ min-height:100dvh; }
}
body.modal-open{ overflow:hidden; }

img{
  -webkit-user-drag:none;
  user-select:none;
  image-rendering:auto;
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 02A — FIREWORKS CANVAS (TRANSPARENT • NO DARK OVERLAY)
 *  ✅ support multi id biar gak hilang kalau JS beda id
 * ─────────────────────────────────────────────────────────── */
#canvas,
#particle-canvas,
#world{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  pointer-events:none;
  z-index:3;
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 03 — BACKDROP (tajam, rapi, NO grain/garis)
 * ─────────────────────────────────────────────────────────── */
body::before{
  content:"";
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;

  background:
    radial-gradient(1200px 860px at 50% 34%,
      rgba(255,230,170,.10) 0%,
      rgba(255,200,120,.06) 30%,
      rgba(255,228,166,0) 62%),
    radial-gradient(980px 720px at 22% 22%,
      rgba(255,120,70,.075) 0%,
      rgba(255,120,70,.040) 34%,
      rgba(255,120,70,0) 62%),
    radial-gradient(980px 720px at 78% 22%,
      rgba(255,120,70,.075) 0%,
      rgba(255,120,70,.040) 34%,
      rgba(255,120,70,0) 62%),
    linear-gradient(180deg,
      rgba(255,255,255,.030) 0%,
      rgba(255,255,255,0) 34%,
      rgba(0,0,0,.08) 74%,
      rgba(0,0,0,.12) 100%);

  opacity:.98;
  transform: translateZ(0);
  contain: paint;
}

body::after{
  content:"";
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;

  background:
    radial-gradient(1200px 920px at 50% 44%,
      rgba(0,0,0,0) 0%,
      rgba(0,0,0,0) 52%,
      rgba(0,0,0,.36) 78%,
      rgba(0,0,0,.66) 100%),
    radial-gradient(780px 520px at 50% 10%,
      rgba(0,0,0,.14) 0%,
      rgba(0,0,0,0) 66%);

  opacity:.94;
  transform: translateZ(0);
  contain: paint;
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 05 — SCENE
 * ─────────────────────────────────────────────────────────── */
.scene{
  position:fixed;
  inset:0;
  z-index:2;
  pointer-events:none;
  overflow:hidden;
  contain: paint;
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 06 — CORNERS
 * ─────────────────────────────────────────────────────────── */
.corner{
  position:absolute;
  top:var(--scene-top);
  width:var(--cornerW);
  aspect-ratio:1/1;
  height:auto;

  opacity:.985;
  z-index:2;

  background-image:var(--corner-url);
  background-repeat:no-repeat;
  background-position:center;
  background-size:var(--corner-bg-size,contain);

  filter:
    drop-shadow(0 12px 22px rgba(0,0,0,.32))
    drop-shadow(0 0 10px rgba(255,228,166,.06));

  transform:
    translate3d(calc(var(--ornAllX) + var(--ornCornerX)),
                calc(var(--ornAllY) + var(--ornCornerY)), 0)
    scaleX(var(--cornerFlip,1));

  backface-visibility:hidden;
  will-change: transform;
  contain:layout paint;
}
.corner.tl{
  left:var(--scene-pad);
  --corner-url:var(--corner-left-url);
  --cornerFlip:1;
  --corner-bg-size:var(--corner-bg-scale-left);
}
.corner.tr{
  right:var(--scene-pad);
  --corner-url:var(--corner-right-url);
  --cornerFlip:-1;
  --corner-bg-size:var(--corner-bg-scale-right);
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 07 — LANTERNS (halo glow premium)
 * ─────────────────────────────────────────────────────────── */
.lanternWrap{
  position:absolute;
  left: calc(var(--lx) + var(--ornAllX) + var(--ornLanternX));

  --lyFinal: calc(var(--ly) + var(--lanternY, 0px) + var(--lY, 0px));
  top:  calc(var(--lyFinal) + var(--ornAllY) + var(--ornLanternY));

  width:calc(clamp(84px, 15vw, 150px) * var(--lScale, 1));
  aspect-ratio:140/220;

  z-index:4;
  opacity:var(--lop, .985);

  transform:translate3d(-50%,0,0) rotate(var(--lrot, -1deg));
  transform-origin:50% 0%;

  animation:lanternHang var(--ldur, 9.2s) var(--ease2) infinite;
  animation-delay: calc(var(--ldelay, 0s) * -1);

  filter:
    drop-shadow(0 14px 22px rgba(0,0,0,.34))
    drop-shadow(0 0 10px rgba(255,228,166,.09))
    saturate(1.02) contrast(1.02);

  will-change:transform;
  backface-visibility:hidden;

  overflow: visible;
  isolation: isolate;

  --wireLen: max(0px, calc(var(--lyFinal) - var(--wireTop)));
}

/* wire */
.lanternWrap::before{
  content:"";
  position:absolute;
  left:50%;
  top:calc(-1 * var(--wireLen));
  height:var(--wireLen);
  width:clamp(2px, .35vw, 3px);
  transform:translateX(-50%);

  background:
    linear-gradient(90deg,
      rgba(255,255,255,.20),
      rgba(255,228,166,.10) 34%,
      rgba(199,154,64,.60) 66%,
      rgba(0,0,0,.18)),
    linear-gradient(180deg,
      rgba(255,228,166,.22),
      rgba(199,154,64,.68) 55%,
      rgba(90,60,20,.92));

  border-radius:999px;
  opacity:.96;

  box-shadow:
    0 0 8px rgba(255,228,166,.10),
    0 10px 18px rgba(0,0,0,.22);
}

/* halo */
.lanternWrap::after{
  content:"";
  position:absolute;
  left:50%;
  top:58%;

  width:  calc(360% * var(--lGlowSize, 1));
  height: calc(420% * var(--lGlowSize, 1));

  transform:translate3d(-50%,-50%,0);
  pointer-events:none;
  border-radius:999px;

  background:
    radial-gradient(ellipse at 50% 62%,
      rgba(255,246,224,.18) 0%,
      rgba(255,226,160,.12) 20%,
      rgba(255,182,118,.075) 42%,
      rgba(255,132,96,.040) 60%,
      rgba(255,228,166,.016) 78%,
      rgba(255,228,166,0) 100%),

    radial-gradient(ellipse at 50% 66%,
      rgba(255,228,166,.085) 0%,
      rgba(255,228,166,.045) 34%,
      rgba(255,228,166,.018) 58%,
      rgba(255,228,166,0) 100%),

    radial-gradient(ellipse at 50% 40%,
      rgba(255,255,255,.060) 0%,
      rgba(255,255,255,.030) 26%,
      rgba(255,255,255,.010) 44%,
      rgba(255,255,255,0) 66%),

    radial-gradient(circle at 38% 54%, rgba(255,255,255,.050), rgba(255,255,255,0) 32%),
    radial-gradient(circle at 62% 52%, rgba(255,255,255,.040), rgba(255,255,255,0) 34%),
    radial-gradient(circle at 50% 70%, rgba(255,228,166,.028), rgba(255,228,166,0) 38%);

  background-blend-mode: screen, screen, screen, screen, screen, screen;

  mix-blend-mode: screen;
  opacity: var(--lGlow, .78);

  animation: lanternGlow 4.2s var(--ease2) infinite;
  will-change: opacity, transform;
}

@keyframes lanternGlow{
  0%   { opacity:calc(var(--lGlow, .78) * .92); transform:translate3d(-50%,-50%,0) scale(.996); }
  50%  { opacity:var(--lGlow, .78);            transform:translate3d(-50%,-50%,0) scale(1.012); }
  100% { opacity:calc(var(--lGlow, .78) * .92); transform:translate3d(-50%,-50%,0) scale(.996); }
}

@keyframes lanternHang{
  0%   { transform:translate3d(-50%,0,0) rotate(-1.1deg); }
  35%  { transform:translate3d(-50%,10px,0) rotate(1.0deg); }
  70%  { transform:translate3d(-50%,6px,0) rotate(-.75deg); }
  100% { transform:translate3d(-50%,0,0) rotate(-1.1deg); }
}

.lanternWrap svg{
  width:100%;
  height:100%;
  display:block;
  shape-rendering:geometricPrecision;
  text-rendering:geometricPrecision;
}

.lanternWrap.l1{
  --lx: clamp(92px, 16vw, 220px);
  --ly: calc(var(--wireTop) + clamp(118px, 16vh, 210px));
  --ldelay:.22s;
  --lGlow:.84;
  --lGlowSize: 1.10;
}
.lanternWrap.l2{
  --lx: clamp(170px, 28vw, 340px);
  --ly: calc(var(--wireTop) + clamp(94px, 14vh, 180px));
  --lScale:.84;
  --lop:.96;
  --lGlow:.66;
  --lGlowSize: .95;
  --ldelay:1.05s;
}
.lanternWrap.l3{
  --lx: calc(100% - clamp(170px, 28vw, 340px));
  --ly: calc(var(--wireTop) + clamp(94px, 14vh, 180px));
  --lScale:.84;
  --lop:.96;
  --lGlow:.66;
  --lGlowSize: .95;
  --ldelay:.66s;
}
.lanternWrap.l4{
  --lx: calc(100% - clamp(92px, 16vw, 220px));
  --ly: calc(var(--wireTop) + clamp(118px, 16vh, 210px));
  --ldelay:1.55s;
  --lGlow:.84;
  --lGlowSize: 1.10;
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 08 — CLOUDS
 * ─────────────────────────────────────────────────────────── */
.cloudPng{
  position:absolute;
  top:  calc(var(--scene-top) + clamp(118px, 15.5vh, 228px) + var(--ornAllY) + var(--ornCloudY));
  left: calc(var(--cx, 50%) + var(--ornAllX) + var(--ornCloudX));

  --cloudBox: 2.9;
  --cloudImg: 1.9;

  width: calc(clamp(240px, 34vw, 360px) * var(--cloudBox));
  aspect-ratio: 520 / 200;

  z-index:3;

  transform:translate3d(-50%,0,0) scaleX(var(--sx, 1));
  transform-origin:50% 50%;

  background-image:var(--cloud-url);
  background-repeat:no-repeat;
  background-position:center;
  background-size: calc(34% * var(--cloudImg)) auto;

  opacity:var(--co, .96);

  filter:
    drop-shadow(0 12px 18px rgba(0,0,0,.22))
    drop-shadow(0 0 10px rgba(255,228,166,.06));

  will-change:transform;
  backface-visibility:hidden;

  --cdx: 10px;
  --cdy: 6px;
  animation:cloudDriftPng 12s var(--ease2) infinite;
}
.cloudPng.cLeft{
  --cx:14%;
  --sx:1;
  --cloud-url: var(--cloud-left-url);
  --cloudImg: 1.25;
  animation-delay:.25s;
}
.cloudPng.cMid{
  --cx:50%;
  --sx:1;
  --co:.94;
  top: calc(var(--scene-top) + clamp(148px, 18.5vh, 260px) + var(--ornAllY) + var(--ornCloudY));
  width: calc(clamp(280px, 42vw, 460px) * 1.45);
  --cloud-url: var(--cloud-mid-url);
  --cloudImg: 1.8;
  animation-delay:.85s;
}
.cloudPng.cRight{
  --cx:86%;
  --sx:-1;
  --cloud-url: var(--cloud-right-url);
  --cloudImg: 1.25;
  animation-delay:1.45s;
}
@keyframes cloudDriftPng{
  0%  { transform:translate3d(-50%,0,0) scaleX(var(--sx, 1)); }
  50% { transform:translate3d(calc(-50% + var(--cdx)), var(--cdy), 0) scaleX(var(--sx, 1)); }
  100%{ transform:translate3d(-50%,0,0) scaleX(var(--sx, 1)); }
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 09 — BOTTOM CLOUD
 * ─────────────────────────────────────────────────────────── */
.bottomCloudPng{
  position:absolute;
  left: calc(50% + var(--ornAllX) + var(--ornBottomX));
  bottom: calc(-6px + var(--safe-bot) + var(--ornAllY) + var(--ornBottomY));
  transform:translate3d(-50%,0,0);
  transform-origin:50% 100%;

  --bCloudBox: 1.00;
  --bCloudImg: 1.00;

  width: calc(min(980px, 120vw) * var(--bCloudBox));
  max-width: 1200px;
  aspect-ratio: 1600 / 520;

  min-height: clamp(110px, 18vw, 220px);

  pointer-events:none;
  z-index:2;

  background-image: var(--bottom-cloud-url);
  background-repeat:no-repeat;
  background-position:center bottom;
  background-size: calc(85% * var(--bCloudImg)) auto;

  filter:
    drop-shadow(0 -10px 22px rgba(0,0,0,.26))
    drop-shadow(0 0 10px rgba(255,228,166,.06));

  animation: bottomCloudFloat 9.2s var(--ease2) infinite;
  will-change: transform;
  backface-visibility:hidden;

  contain: layout paint;
}
@media (min-width: 900px){
  .bottomCloudPng{
    width: 100vw;
    max-width: none;
    background-size: calc(115% * var(--bCloudImg)) auto;
  }
}
@keyframes bottomCloudFloat{
  0%   { transform:translate3d(-50%,0,0); }
  50%  { transform:translate3d(-50%,-9px,0); }
  100% { transform:translate3d(-50%,0,0); }
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 10 — BOTTOM ORNAMENT
 * ─────────────────────────────────────────────────────────── */
.bottomOrn{
  position:absolute;
  left:0; right:0;
  bottom: calc(-2px + var(--safe-bot) + var(--ornAllY) + var(--ornBottomY));
  width:100%;
  height:min(54vh,540px);
  z-index:1;
  opacity:1;

  transform: translate3d(calc(var(--ornAllX) + var(--ornBottomOrnX)), 0, 0);
  will-change: transform;
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 11A — PAGE TITLE
 * ─────────────────────────────────────────────────────────── */
.pageTitle{
  position:fixed;
  inset:0 0 auto 0;
  z-index:6;
  pointer-events:none;

  display:flex;
  justify-content:center;

  padding-top: calc(var(--safe-top) + clamp(10px, 1.3vh, 16px));
}
.pageTitleInner{
  width: calc(100vw - (var(--titlePadX) * 2));
  max-width: var(--titleMaxW);
  text-align:center;
  line-height:1.05;

  padding-inline: clamp(10px, 1.35vw, 22px);
  filter: drop-shadow(0 18px 34px rgba(0,0,0,.38));

  container-type:inline-size;
  container-name:titlebox;
  text-wrap:balance;
}
.ptLine1{
  display:inline-flex;
  gap:.42ch;
  flex-wrap:wrap;
  justify-content:center;
  align-items:baseline;

  font-weight:950;
  letter-spacing:.8px;
  text-transform:uppercase;
  font-size: clamp(16px, 2.6vw, 34px);
  text-shadow:0 10px 22px rgba(0,0,0,.44);
}
.ptWelcome{ opacity:.92; color:rgba(255,255,255,.94); }
.ptBrand{
  font-weight:1000;
  letter-spacing:.95px;

  background: linear-gradient(180deg, var(--gold0), var(--gold1) 32%, var(--gold2) 62%, var(--gold3));
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;

  text-shadow:
    0 10px 24px rgba(0,0,0,.46),
    0 0 18px rgba(255,228,166,.14);
}
.ptLine2{
  margin-top:7px;
  font-size: clamp(12px, 1.6vw, 17px);
  font-weight:850;
  letter-spacing:.35px;
  opacity:.92;
  text-shadow:0 10px 22px rgba(0,0,0,.40);
}
.ptLine3{
  margin-top:7px;
  font-size: clamp(12px, 1.7vw, 18px);
  font-weight:950;
  letter-spacing:.25px;
  color: rgba(255,228,166,.98);
  text-shadow:
    0 12px 26px rgba(0,0,0,.44),
    0 0 16px rgba(255,228,166,.12);
}
.pageTitleInner::after{
  content:"";
  display:block;
  height:2px;
  width:min(720px,86%);
  margin:10px auto 0;
  background: linear-gradient(90deg,
    transparent,
    rgba(255,228,166,.55),
    rgba(199,154,64,.55),
    rgba(255,228,166,.55),
    transparent
  );
  opacity:.84;
  border-radius:999px;
}
@container titlebox (max-width: 520px){
  .ptLine1{ font-size: clamp(15px, 4.6cqi, 22px); letter-spacing:.65px; }
  .ptLine2{ font-size: clamp(11px, 3.4cqi, 14px); }
  .ptLine3{ font-size: clamp(11px, 3.6cqi, 15px); }
}
@container titlebox (min-width: 900px){
  .ptLine1{ font-size: clamp(24px, calc(2.6cqi * var(--titleDeskBoost)), 52px); letter-spacing:.95px; }
  .ptLine2{ font-size: clamp(13px, 1.25cqi, 18px); }
  .ptLine3{ font-size: clamp(14px, 1.35cqi, 20px); }
  .pageTitleInner::after{ width: min(860px, 74%); }
}
@media (min-width: 1400px){
  :root{ --pageTitleGap: clamp(92px, 12vh, 168px); }
  .ptLine1{ text-shadow:0 14px 28px rgba(0,0,0,.46); }
}
@media (max-width: 420px){
  :root{
    --pageTitleGap: clamp(78px, 11vh, 132px);
    --titlePadX: max(var(--scene-pad), calc(var(--cornerW) * .28));
  }
}
@media (max-height: 650px){
  :root{ --pageTitleGap: clamp(68px, 10vh, 118px); }
  .pageTitleInner::after{ margin-top:8px; }
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 11 — UI WRAPPER
 * ─────────────────────────────────────────────────────────── */
.ui{
  position:relative;
  z-index:5;
  width:100%;
  min-height:100svh;
  display:flex;
  align-items:center;
  justify-content:center;

  padding:
    calc(28px + var(--pageTitleGap))
    14px
    calc(28px + var(--safe-bot));
}
@supports (height:100dvh){
  .ui{ min-height:100dvh; }
}
.uiInner{
  width:min(var(--cardW),92vw);
  display:flex;
  align-items:center;
  justify-content:center;
}

/* =====================================================
   OPTIONAL: UI LOCK WRAP (kalau JS memindahkan menu)
===================================================== */
#uiWrap{
  position:fixed;
  left:50%;
  top:50%;
  width:calc(var(--uiBaseW) * 1px);
  height:calc(var(--uiBaseH) * 1px);
  transform:translate3d(-50%,-50%,0) scale(var(--uiScale));
  transform-origin:center;
  z-index:10;
  pointer-events:none;
  will-change:transform;
}
#uiWrap > *{ pointer-events:auto; }
#uiWrap #login-menu,
#uiWrap #main-menu{
  position:absolute;
  inset:0;
  display:grid;
  place-items:center;
}

/* ─────────────────────────────────────────────────────────────
 * Motion safety
 * ─────────────────────────────────────────────────────────── */
@media (prefers-reduced-motion: reduce){
  .lanternWrap,
  .cloudPng,
  .bottomCloudPng{
    animation-duration: 1ms !important;
    animation-iteration-count: 1 !important;
  }
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 12 — CARD
 * ─────────────────────────────────────────────────────────── */
.card{
  width:100%;
  border-radius:var(--radius);
  position:relative;
  padding:28px 22px 22px;
  text-align:center;
  background:
    radial-gradient(900px 560px at 50% 28%, rgba(255,255,255,.13), transparent 58%),
    radial-gradient(520px 220px at 50% 0%, rgba(255,228,166,.16), transparent 70%),
    linear-gradient(180deg, rgba(255,214,126,.20), rgba(255,214,126,.06)),
    linear-gradient(180deg, rgba(90,11,20,.86), rgba(35,6,14,.96));
  box-shadow: var(--shDeep);
  border:2px solid var(--ring_toggle, var(--ring));
  transform:translate3d(0,6px,0);
  animation:cardIn .9s var(--ease2) both;
  overflow:hidden;
  -webkit-backdrop-filter:saturate(1.08);
  backdrop-filter:saturate(1.08);
  contain: paint;
}
.card .innerPattern{
  position:absolute;
  inset:0;
  pointer-events:none;
  opacity:.22;

  /* ✅ clean pattern: NO repeating-linear (anti “garis/grain”) */
  background:
    radial-gradient(520px 320px at 18% 16%, rgba(255,255,255,.18), transparent 72%),
    radial-gradient(620px 360px at 84% 20%, rgba(255,255,255,.14), transparent 74%),
    radial-gradient(260px 200px at 30% 70%, rgba(255,228,166,.10), transparent 72%),
    radial-gradient(240px 180px at 70% 74%, rgba(199,154,64,.08), transparent 74%);

  mix-blend-mode:overlay;
}
@keyframes cardIn{
  from{ opacity:0; transform:translate3d(0,22px,0) scale(.965); }
  to{ opacity:1; transform:translate3d(0,0,0) scale(1); }
}
.card::before{
  content:"";
  position:absolute;
  inset:10px;
  border-radius:calc(var(--radius) - 8px);
  border:2px solid rgba(255,228,166,.74);
  box-shadow:
    inset 0 0 0 2px rgba(199,154,64,.24),
    inset 0 0 0 1px rgba(255,255,255,.10),
    0 0 12px rgba(255,228,166,.16);
  pointer-events:none;
}
.card::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:var(--radius);
  pointer-events:none;
  background:
    radial-gradient(160px 110px at 12% 16%, rgba(255,255,255,.16), transparent 70%),
    radial-gradient(160px 110px at 88% 16%, rgba(255,255,255,.14), transparent 70%),
    linear-gradient(180deg, rgba(0,0,0,.14), transparent 20%);
  opacity:.96;
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 13 — TYPO
 * ─────────────────────────────────────────────────────────── */
.title{
  position:relative;
  z-index:2;
  margin:0 0 14px;
  font-size:clamp(18px,2.4vw,22px);
  letter-spacing:.3px;
  font-weight:950;
  text-shadow:0 10px 22px rgba(0,0,0,.35);
}
.sub{
  position:relative;
  z-index:2;
  margin:0 0 12px;
  font-size:12px;
  opacity:.92;
  letter-spacing:.35px;
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 14 — INPUT (PLACEHOLDER CENTER PRESISI)
 * ─────────────────────────────────────────────────────────── */
.fields{
  position:relative;
  z-index:2;
  display:grid;
  gap:10px;
  margin:10px 0 10px;
}
input{
  width:100%;
  height:var(--inputH);

  padding:0 14px;
  line-height:calc(var(--inputH) - 2px);
  text-align:center;

  border-radius:14px;
  border:1px solid rgba(255,228,166,.34);
  background:rgba(12,2,6,.32);
  color:#fff;
  outline:none;

  font-weight:800;
  letter-spacing:.5px;
  user-select:text;

  box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
  transition:
    transform .15s var(--ease),
    border-color .2s var(--ease),
    background .2s var(--ease),
    box-shadow .2s var(--ease);
}
input::placeholder{
  text-align:center;
  color:rgba(255,255,255,.62);
  font-weight:850;
  letter-spacing:.9px;
}
input:focus{
  border-color:rgba(255,228,166,.82);
  background:rgba(12,2,6,.36);
  transform:translate3d(0,-1px,0);
  box-shadow:
    0 0 0 3px rgba(255,228,166,.12),
    inset 0 1px 0 rgba(255,255,255,.06);
}
.inputBad{
  border-color:rgba(255,90,90,.78) !important;
  box-shadow:0 0 0 3px rgba(255,90,90,.12) !important;
}
input.locked{
  opacity:.92;
  cursor:not-allowed;
  filter:saturate(.95);
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 15 — BUTTONS + LOADING
 * ─────────────────────────────────────────────────────────── */
.btnRow{ position:relative; z-index:2; display:grid; gap:10px; margin-top:10px; justify-items:center; }
button{
  appearance:none;
  border:0;
  cursor:pointer;
  width:min(360px,94%);
  padding:12px 16px;
  border-radius:16px;
  font-weight:950;
  letter-spacing:.6px;
  color:#3c0712;
  background:
    linear-gradient(180deg, rgba(255,255,255,.26), transparent 42%),
    linear-gradient(135deg, var(--gold1), var(--gold2), var(--gold3));
  box-shadow: var(--shBtn);
  transition:transform .14s var(--ease), box-shadow .2s var(--ease);
  touch-action:manipulation;
  position:relative;
  overflow:hidden;
  transform:translateZ(0);
}
button:focus-visible{
  outline:none;
  box-shadow: 0 0 0 3px rgba(255,228,166,.18), var(--shBtn);
  transform:translate3d(0,-1px,0);
}
button[disabled]{ opacity:.62; cursor:not-allowed; }
button::before{
  content:"";
  position:absolute;
  inset:-40%;
  background:linear-gradient(90deg, transparent 0, rgba(255,255,255,.32) 45%, transparent 60%);
  transform:translateX(-60%) rotate(12deg);
  opacity:0;
  transition:opacity .18s var(--ease);
}
@media (hover:hover){
  button:hover::before{ opacity:.9; animation:btnSheen 1.05s var(--ease2) both; }
  button:hover{ transform:translate3d(0,-2px,0) scale(1.02); box-shadow: 0 18px 38px rgba(0,0,0,.46); }
}
button:active{ transform:translate3d(0,0,0) scale(.99); }
@keyframes btnSheen{ from{ transform:translateX(-70%) rotate(12deg); } to{ transform:translateX(70%) rotate(12deg); } }

.btnGhost{
  background:
    linear-gradient(180deg, rgba(255,255,255,.08), transparent 45%),
    linear-gradient(135deg, rgba(255,228,166,.18), rgba(255,228,166,.08));
  color:rgba(255,228,166,.95);
  border:1px solid rgba(255,228,166,.34);
  box-shadow: 0 12px 26px rgba(0,0,0,.26);
}

/* loading inline (button) */
.btnLoading{
  display:inline-flex;
  gap:10px;
  align-items:center;
  justify-content:center;
}
.spinner{
  width:18px; height:18px;
  border-radius:999px;
  border:2px solid rgba(90,11,20,.24);
  border-top-color: rgba(90,11,20,.92);
  animation:spin .75s linear infinite;
  transform:translateZ(0);
}
@keyframes spin{ to{ transform:rotate(360deg); } }

/* ─────────────────────────────────────────────────────────────
 * BLOK 16 — ERROR
 * ─────────────────────────────────────────────────────────── */
.err{
  position:relative;
  z-index:2;
  margin:8px 0 0;
  font-size:12px;
  color:rgba(255,228,166,.96);
  min-height:16px;
  opacity:0;
  transform:translate3d(0,-2px,0);
  transition:.18s var(--ease);
}
.err.show{ opacity:1; transform:translate3d(0,0,0); }

/* ─────────────────────────────────────────────────────────────
 * BLOK 17 — GRID (CLEAN PNG)
 * ─────────────────────────────────────────────────────────── */
#main-menu{ display:none; }
#login-menu{ display:block; }

.angpaoGrid{
  position:relative;
  z-index:2;
  display:grid;
  grid-template-columns:repeat(3, minmax(0, 1fr));
  gap:clamp(10px, 1.6vw, 14px);
  justify-items:center;
  align-items:center;

  margin-top:10px;
  padding:10px 6px 2px;

  contain: layout paint;
}

.angpaoBtn{
  width:clamp(86px, 16vw, 110px);
  aspect-ratio:96/104;

  border-radius:20px;
  background:transparent !important;
  padding:0;
  border:0;

  box-shadow:none !important;
  filter:none !important;

  position:relative;
  cursor:pointer;

  transition:transform .16s var(--ease), opacity .18s var(--ease);
  transform:translate3d(0,0,0);
  will-change:transform;

  outline:none !important;
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  user-select:none;

  overflow:visible;
  touch-action:manipulation;
}
.angpaoBtn::before{ display:none !important; content:none !important; }

.angpaoBtn:focus-visible{
  outline:3px solid rgba(255,228,166,.22);
  outline-offset:4px;
}
@media (hover:hover){
  .angpaoBtn:hover{ transform:translate3d(0,-4px,0) scale(1.06); }
}
.angpaoBtn:active{ transform:translate3d(0,-1px,0) scale(1.02); }
.angpaoBtn[disabled]{ opacity:.55; cursor:not-allowed; }

/* Envelope wrapper */
.envelope{
  width:100%;
  height:100%;
  display:block;
  position:relative;

  background:none !important;
  filter:none !important;

  transform:translate3d(0,0,0);
  backface-visibility:hidden;
  will-change:transform;

  isolation:isolate;
}
.envelope::before{
  content:"";
  position:absolute;
  inset:0;

  background-image: var(--angpao-url);
  background-repeat:no-repeat;
  background-position:center;
  background-size: calc(1% * var(--angpaoImg, 115)) auto;

  transform:translate3d(0,0,0);
  backface-visibility:hidden;
  will-change:transform;
}
@supports (mix-blend-mode: multiply){
  .envelope::before{
    mix-blend-mode:multiply;
    opacity:.995;
  }
}
.envelope::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;

  background:
    radial-gradient(120px 90px at 30% 22%, rgba(255,255,255,.14), transparent 72%),
    linear-gradient(120deg, transparent 0 46%, rgba(255,255,255,.08) 54%, transparent 64%);

  opacity:0;
  transition:opacity .16s var(--ease);

  -webkit-mask-image: var(--angpao-url);
  mask-image: var(--angpao-url);
  -webkit-mask-repeat:no-repeat;
  mask-repeat:no-repeat;
  -webkit-mask-position:center;
  mask-position:center;
  -webkit-mask-size: calc(1% * var(--angpaoImg, 115)) auto;
  mask-size: calc(1% * var(--angpaoImg, 115)) auto;

  mix-blend-mode: screen;
}
@media (hover:hover){
  .angpaoBtn:hover .envelope::after{ opacity:.95; }
}
.angpaoBtn.is-picked .envelope{
  animation:picked .52s var(--ease2) both;
}
@keyframes picked{
  0%   { transform:translate3d(0,0,0) scale(1); }
  35%  { transform:translate3d(0,-6px,0) scale(1.05); }
  70%  { transform:translate3d(0, 2px,0) scale(1.02); }
  100% { transform:translate3d(0,0,0) scale(1); }
}

.hint{
  position:relative;
  z-index:2;
  margin-top:10px;
  font-size:11px;
  opacity:.80;
  letter-spacing:.35px;
  line-height:1.35;
}

/* =====================================================
   SECURITY OVERLAY
===================================================== */
#secOverlay{
  position:fixed; inset:0; z-index:999999;
  display:none; align-items:center; justify-content:center;
  background: rgba(6,6,10,.78);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color:#fff;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  text-align:center;
  padding: 24px;
}
#secOverlay .box{
  width:min(560px, 92vw);
  border-radius: 18px;
  padding: 22px 18px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 30px 80px rgba(0,0,0,.35);
}
#secOverlay .t{
  font-weight: 800;
  letter-spacing: .14em;
  font-size: 14px;
  opacity: .95;
}
#secOverlay .m{
  margin-top: 10px;
  font-size: 14px;
  line-height: 1.55;
  opacity: .92;
}
#secOverlay .s{
  margin-top: 14px;
  font-size: 12px;
  opacity: .65;
}

/* =====================================================
   REVEAL FX
===================================================== */
#revealFX{
  position:fixed; inset:0; z-index:90;
  display:none; align-items:center; justify-content:center;
  padding:18px;
  background:
    radial-gradient(900px 600px at 50% 18%, rgba(255,228,166,.14), transparent 62%),
    radial-gradient(1200px 900px at 50% 85%, rgba(255,160,55,.10), transparent 68%),
    rgba(6,6,10,.66);
  backdrop-filter: blur(10px) saturate(1.06);
  -webkit-backdrop-filter: blur(10px) saturate(1.06);
}
#revealFX .fxBg{
  position:absolute; inset:0;
  background: radial-gradient(720px 460px at 50% 30%, rgba(255,246,223,.10), transparent 62%);
  opacity:0; transform:scale(.985);
}
#revealFX .fxFlare{
  position:absolute; width:min(560px, 92vw); aspect-ratio:1/1;
  background:
    radial-gradient(circle at 50% 50%, rgba(255,228,166,.30), transparent 58%),
    radial-gradient(circle at 50% 50%, rgba(243,178,74,.22), transparent 66%);
  opacity:0; transform:scale(.78);
  mix-blend-mode:screen;
  pointer-events:none;
}
#revealFX .fxCard{
  position:relative; z-index:2;
  width:min(440px, 92vw);
  border-radius:24px;
  padding:16px 14px 14px;
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
  border: 1px solid rgba(255,228,166,.20);
  box-shadow: 0 30px 90px rgba(0,0,0,.42);
  text-align:center;
  opacity:0;
  transform: translate3d(0,12px,0) scale(.96);
}
#revealFX .fxShine{
  position:absolute; inset:-1px;
  border-radius:24px;
  background:
    radial-gradient(800px 260px at 50% 0%, rgba(255,246,223,.22), transparent 55%),
    radial-gradient(380px 220px at 18% 12%, rgba(255,228,166,.14), transparent 60%);
  opacity:0;
  pointer-events:none;
}
#revealFX .fxPrizeWrap{
  display:flex; justify-content:center; align-items:center;
  padding: 8px 6px 2px;
}
#revealFX .fxPrizeImg{
  width:min(248px, 72vw);
  max-height:min(248px, 34vh);
  height:auto;
  object-fit:contain;
  opacity:0;
  transform: translate3d(0,8px,0) scale(.90);
  filter: drop-shadow(0 18px 40px rgba(0,0,0,.35));
}
#revealFX .fxLabel{
  margin-top:6px;
  font-weight:900;
  letter-spacing:.20em;
  font-size:12px;
  color: rgba(255,246,223,.92);
  opacity:0;
  transform: translate3d(0,6px,0);
  user-select:none;
}
#revealFX .fxOk{
  margin-top:14px;
  width:100%;
  height:46px;
  border-radius:16px;
  border:1px solid rgba(255,228,166,.42);
  background: linear-gradient(180deg, rgba(255,228,166,.22), rgba(243,178,74,.14));
  color: rgba(255,246,223,.96);
  font-weight:900;
  letter-spacing:.16em;
  cursor:pointer;
  outline:none;
}
#revealFX .fxOk:disabled{ opacity:.55; cursor:not-allowed; }
#revealFX .fxOk:active{ transform: translateY(1px); }

@media (prefers-reduced-motion: reduce){
  #revealFX{ backdrop-filter:none; -webkit-backdrop-filter:none; }
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 18 — POPUP (CLEAN • RAPI • PREMIUM)
 * ─────────────────────────────────────────────────────────── */
#popup{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:20;

  background:
    radial-gradient(900px 600px at 50% 18%, rgba(255,228,166,.11), transparent 60%),
    radial-gradient(760px 520px at 50% 92%, rgba(255,58,68,.06), transparent 62%),
    var(--ovBg);

  padding:18px;

  -webkit-backdrop-filter: blur(var(--ovBlur)) saturate(1.08);
  backdrop-filter: blur(var(--ovBlur)) saturate(1.08);

  animation: popFade .22s var(--ease2) both;
  contain: paint;
}
@keyframes popFade{ from{ opacity:0; } to{ opacity:1; } }

.popupCard{
  width:min(520px,92vw);
  border-radius: calc(var(--radius) + 2px);
  position:relative;
  text-align:center;

  padding:28px 18px 18px;

  background:
    radial-gradient(860px 560px at 50% 18%, rgba(255,255,255,.14), transparent 58%),
    radial-gradient(440px 250px at 50% 0%, rgba(255,228,166,.18), transparent 72%),
    linear-gradient(180deg, rgba(255,214,126,.16), rgba(255,214,126,.04)),
    linear-gradient(180deg, rgba(90,11,20,.95), rgba(22,4,10,.98));

  border:1px solid rgba(255,228,166,.44);
  box-shadow: var(--shDeep), var(--shMed);

  overflow:hidden;
  transform: translateZ(0);
  will-change: transform, opacity;

  animation: popIn2 .42s var(--ease2) both;
  contain: paint;
}
@keyframes popIn2{
  from{ opacity:0; transform:translate3d(0,22px,0) scale(.92); }
  to{ opacity:1; transform:translate3d(0,0,0) scale(1); }
}

.popupCard::before{
  content:"";
  position:absolute;
  inset:10px;
  border-radius: calc(var(--radius) - 6px);
  border:2px solid rgba(255,228,166,.70);
  box-shadow:
    inset 0 0 0 2px rgba(199,154,64,.20),
    inset 0 0 0 1px rgba(255,255,255,.08),
    0 0 14px rgba(255,228,166,.16);
  pointer-events:none;
}
.popupCard::after{
  content:"";
  position:absolute;
  inset:-18%;
  border-radius: inherit;
  pointer-events:none;

  background:
    radial-gradient(260px 180px at 18% 10%, rgba(255,255,255,.16), transparent 72%),
    radial-gradient(260px 180px at 82% 10%, rgba(255,255,255,.12), transparent 74%),
    linear-gradient(180deg, rgba(0,0,0,.14), transparent 28%),
    linear-gradient(120deg, transparent 0 38%, rgba(255,255,255,.06) 50%, transparent 64%);

  opacity:.92;
}
.closeX{ display:none !important; }

/* titles */
.rewardText{
  position:relative;
  z-index:2;
  margin:2px 0 12px;
  text-shadow:
    0 12px 26px rgba(0,0,0,.42),
    0 0 18px rgba(255,228,166,.10);
}
.rewardText .t1{
  font-size: clamp(22px, 4.2vw, 30px);
  font-weight: 1000;
  letter-spacing:.25px;
  margin:0;
}
.rewardText .t2{
  margin:6px 0 0;
  font-size: 12px;
  font-weight: 900;
  letter-spacing:.35px;
  opacity:.90;
}

.rewardPrize{
  position:relative;
  z-index:2;

  display:grid;
  grid-template-columns: 48px 1fr;
  gap:10px;
  align-items:center;

  margin:0 auto 12px;
  width:100%;
  max-width:100%;

  padding:12px 12px;
  border-radius:16px;

  border:1px solid rgba(255,228,166,.34);
  background:
    radial-gradient(520px 260px at 50% 0%, rgba(255,228,166,.14), transparent 72%),
    radial-gradient(260px 170px at 18% 14%, rgba(255,255,255,.06), transparent 70%),
    linear-gradient(180deg, rgba(12,2,6,.34), rgba(8,2,6,.22));

  box-shadow: var(--shSoft), inset 0 1px 0 rgba(255,255,255,.05);

  overflow:hidden;
  isolation:isolate;
  transform: translateZ(0);

  clip-path: inset(0 round 16px);
  -webkit-clip-path: inset(0 round 16px);
}

/* ✅ FIX: keyframes bentrok (sebelumnya prizeSheen dobel) */
.rewardPrize::after{
  content:"";
  position:absolute;
  inset:-34% -44%;
  pointer-events:none;

  background:
    linear-gradient(115deg,
      transparent 0 47%,
      rgba(255,255,255,0) 49%,
      rgba(255,255,255,.13) 52%,
      rgba(255,228,166,.09) 56%,
      rgba(255,255,255,0) 60%,
      transparent 0),
    radial-gradient(420px 220px at 50% 0%, rgba(255,228,166,.09), transparent 70%);

  mix-blend-mode: screen;
  opacity:.78;
  border-radius: inherit;

  -webkit-mask-image: -webkit-radial-gradient(white, black);
  mask-image: radial-gradient(white, black);

  transform: translate3d(-16%, 10%, 0) rotate(-6deg);
  animation: rewardSheen 4.4s var(--ease2) infinite;

  z-index:0;
}
@keyframes rewardSheen{
  0%   { transform: translate3d(-20%, 12%, 0) rotate(-6deg); opacity:.58; }
  45%  { opacity:.86; }
  100% { transform: translate3d(18%, -10%, 0) rotate(-6deg); opacity:.58; }
}

.rewardThumb{
  width:48px;
  height:48px;
  border-radius:14px;
  border:1px solid rgba(255,228,166,.22);

  background:
    radial-gradient(40px 34px at 30% 22%, rgba(255,255,255,.14), transparent 70%),
    linear-gradient(135deg, rgba(255,228,166,.10), rgba(199,154,64,.05));

  display:grid;
  place-items:center;
  box-shadow: 0 10px 22px rgba(0,0,0,.22);
  overflow:hidden;

  position:relative;
  z-index:1;
  transform: translateZ(0);
}
.rewardThumb::after{
  content:"";
  position:absolute;
  inset:-12%;
  pointer-events:none;
  background: linear-gradient(120deg, transparent 0 46%, rgba(255,255,255,.10) 54%, transparent 64%);
  opacity:.48;
}
.rewardThumb img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  opacity:.98;
}

.rewardValWrap{
  min-width:0;
  text-align:center;
  padding-right:58px;
  position:relative;
  z-index:1;
}
.rewardValWrap .val{
  font-size:clamp(14px, 3.2vw, 18px);
  line-height:1.18;
  font-weight:1000;
  letter-spacing:.45px;
  color:rgba(255,246,224,.98);
  text-shadow:
    0 10px 22px rgba(0,0,0,.32),
    0 0 12px rgba(255,228,166,.08);
  word-break:break-word;
  text-align:center;
}

.popMeta{
  position:relative;
  z-index:2;
  margin: 10px auto 14px;
  padding: 0 6px;
  display:grid;
  gap:10px;
}
.metaRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;

  width:100%;
  padding:12px 12px;
  border-radius:16px;

  border:1px solid rgba(255,228,166,.16);
  background:
    radial-gradient(320px 160px at 20% 0%, rgba(255,228,166,.07), transparent 70%),
    rgba(12,2,6,.22);

  box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
  overflow:hidden;
}
.metaRow .k{
  font-size:11px;
  letter-spacing:.12em;
  text-transform:uppercase;
  opacity:.78;
}
.metaRow .v{
  font-size:12px;
  font-weight:900;
  letter-spacing:.25px;
  color:rgba(255,228,166,.98);
  text-align:right;
  max-width: 70%;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.statusNote{
  position:relative;
  z-index:2;
  margin:10px 0 0;
  font-size:12px;
  opacity:.88;
  min-height:16px;
}

.popupBtns{
  position:relative;
  z-index:2;
  display:grid;
  gap:12px;
  justify-items:center;
  margin-top:14px;
  padding-top:2px;
}

@media (prefers-reduced-motion: reduce){
  .popupCard{ animation:none; }
  .rewardPrize::after{ animation:none; opacity:.70; }
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 18B — OVERLAY HADIAH (GRID 4 PNG)
 * ─────────────────────────────────────────────────────────── */
#prizeOverlay{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:30;

  --sheenDur: 2.75s;
  --sheenSoft: rgba(255,255,255,.12);
  --sheenGold: rgba(255,228,166,.14);
  --skelA: rgba(255,255,255,.08);
  --skelB: rgba(255,255,255,.03);

  background:
    radial-gradient(900px 640px at 50% 22%, rgba(255,228,166,.10), transparent 62%),
    rgba(0,0,0,.44);

  padding:max(14px, calc(var(--safe-top) + 10px)) 14px calc(14px + var(--safe-bot));
  -webkit-backdrop-filter: blur(6px) saturate(1.05);
  backdrop-filter: blur(6px) saturate(1.05);
  animation: popFade .22s var(--ease2) both;
  contain: paint;
}

.prizeMiniCard{
  width:min(520px, 92vw);
  border-radius:22px;
  position:relative;
  padding:16px 14px 12px;
  text-align:center;

  background:
    radial-gradient(760px 420px at 50% 18%, rgba(255,255,255,.14), transparent 62%),
    linear-gradient(180deg, rgba(255,214,126,.14), rgba(255,214,126,.04)),
    linear-gradient(180deg, rgba(90,11,20,.92), rgba(22,4,10,.98));

  border:1px solid rgba(255,228,166,.44);
  box-shadow: var(--shDeep), var(--shMed);

  overflow:hidden;
  transform: translateZ(0);
  animation: popIn2 .42s var(--ease2) both;
  contain: paint;
}

.prizeMiniCard::before{
  content:"";
  position:absolute;
  inset:10px;
  border-radius:18px;
  border:2px solid rgba(255,228,166,.70);
  box-shadow:
    inset 0 0 0 2px rgba(199,154,64,.18),
    inset 0 0 0 1px rgba(255,255,255,.08),
    0 0 14px rgba(255,228,166,.14);
  pointer-events:none;
}

.prizeMiniBody{
  position:relative;
  z-index:2;
  display:grid;
  justify-items:center;
  gap:10px;
  padding:6px 8px 8px;
}

.prizeMiniTitle{
  font-weight:1000;
  letter-spacing:.16em;
  font-size:12px;
  opacity:.92;
  color:rgba(255,228,166,.95);
  text-shadow:0 12px 26px rgba(0,0,0,.42);
}

.prizeGrid{
  width:100%;
  display:grid;
  grid-template-columns:repeat(2, minmax(0, 1fr));
  gap:12px;
  padding:6px 4px 2px;
}

.prizeItem{
  position:relative;
  border-radius:18px;
  border:1px solid rgba(255,228,166,.22);
  background:
    radial-gradient(240px 150px at 30% 20%, rgba(255,255,255,.12), transparent 70%),
    rgba(10,2,6,.26);
  box-shadow: var(--shSoft);
  padding:10px 10px 12px;
  overflow:hidden;

  transform:translateZ(0);
  transition:transform .16s var(--ease), border-color .16s var(--ease);
  will-change:transform;
  contain: paint;
}

.prizeItem::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  pointer-events:none;
  background:
    linear-gradient(180deg, rgba(255,255,255,.08), transparent 55%),
    radial-gradient(160px 120px at 25% 18%, rgba(255,228,166,.10), transparent 65%);
  opacity:.85;
}

.prizeItem::after{
  content:"";
  position:absolute;
  inset:-40% -60%;
  pointer-events:none;

  background: linear-gradient(
    120deg,
    transparent 0%,
    transparent 42%,
    var(--sheenGold) 49%,
    var(--sheenSoft) 52%,
    transparent 60%,
    transparent 100%
  );

  opacity:.70;
  mix-blend-mode: screen;
  transform:translate3d(-60%, 0, 0) skewX(-10deg);
  will-change:transform;
  animation: prizeSheen var(--sheenDur) var(--ease2) infinite;
}

/* keyframes prizeSheen khusus overlay grid (tidak bentrok lagi) */
@keyframes prizeSheen{
  0%   { transform:translate3d(-62%, 0, 0) skewX(-10deg); }
  48%  { transform:translate3d( 62%, 0, 0) skewX(-10deg); }
  100% { transform:translate3d( 62%, 0, 0) skewX(-10deg); }
}

@media (hover:hover){
  .prizeItem:hover{
    transform:translate3d(0,-2px,0) scale(1.01);
    border-color: rgba(255,228,166,.42);
  }
}
.prizeItem:active{ transform:translate3d(0,0,0) scale(.995); }

.prizeThumb{
  position:relative;
  width:100%;
  aspect-ratio:1/1;
  border-radius:16px;
  overflow:hidden;

  border:1px solid rgba(255,228,166,.18);
  background:
    radial-gradient(70px 62px at 32% 26%, rgba(255,255,255,.16), transparent 70%),
    linear-gradient(135deg, rgba(255,228,166,.08), rgba(199,154,64,.05));
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06);

  display:grid;
  place-items:center;
  contain: paint;
}

.prizeThumb::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  pointer-events:none;

  background:
    linear-gradient(180deg, rgba(255,255,255,.06), transparent 58%),
    linear-gradient(90deg, var(--skelB), var(--skelA), var(--skelB));

  opacity:.55;
  mix-blend-mode: screen;
}

.prizeThumb::after{
  content:"";
  position:absolute;
  inset:-35% -55%;
  border-radius:inherit;
  pointer-events:none;

  background: linear-gradient(
    120deg,
    transparent 0%,
    transparent 44%,
    rgba(255,255,255,.16) 50%,
    transparent 56%,
    transparent 100%
  );

  opacity:.55;
  mix-blend-mode: screen;
  transform:translate3d(-58%, 0, 0) skewX(-10deg);
  will-change:transform;
  animation: thumbSheen calc(var(--sheenDur) * .92) var(--ease2) infinite;
}

@keyframes thumbSheen{
  0%   { transform:translate3d(-60%, 0, 0) skewX(-10deg); }
  52%  { transform:translate3d( 60%, 0, 0) skewX(-10deg); }
  100% { transform:translate3d( 60%, 0, 0) skewX(-10deg); }
}

.prizeThumb img{
  position:relative;
  z-index:2;
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  opacity:.96;
}

.prizeName{
  margin-top:10px;
  font-weight:1000;
  letter-spacing:.35px;
  font-size:12px;
  color:rgba(255,246,224,.98);
  text-shadow:0 12px 26px rgba(0,0,0,.42);

  line-height:1.12;
  min-height: 30px;

  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;

  padding: 0 4px;

  text-align:center;
  white-space:normal;
  word-break:break-word;
}
.prizeName br{ display:block; content:""; }

.prizeMiniHint{
  margin:2px 0 0;
  font-size:11px;
  opacity:.78;
  letter-spacing:.25px;
  line-height:1.35;
  max-width: 420px;
}

.prizeMiniBtns{
  position:relative;
  z-index:2;
  display:grid;
  gap:10px;
  justify-items:center;
  padding: 6px 8px 10px;
}

@media (max-width:420px){
  .prizeMiniCard{ width:min(460px, 92vw); }
  .prizeGrid{ gap:10px; }
  .prizeItem{ padding:9px 9px 11px; border-radius:16px; }
  .prizeThumb{ border-radius:14px; }
  .prizeName{ font-size:11px; min-height: 26px; }
}
@media (prefers-reduced-motion: reduce){
  .prizeItem::after,
  .prizeThumb::after{ animation:none !important; }
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 18C — CLAIM LOADING OVERLAY
 * ─────────────────────────────────────────────────────────── */
#claimOverlay{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:40;

  background:
    radial-gradient(900px 640px at 50% 24%, rgba(255,228,166,.12), transparent 60%),
    radial-gradient(980px 620px at 50% 72%, rgba(255,120,70,.08), transparent 62%),
    rgba(0,0,0,.80);

  -webkit-backdrop-filter: blur(10px) saturate(1.10);
  backdrop-filter: blur(10px) saturate(1.10);

  padding:18px;
  animation: popFade .18s var(--ease2) both;
  contain: paint;
}

.claimBox{
  width:min(520px, 92vw);
  border-radius: 22px;
  padding: 22px 18px;
  text-align:center;

  background:
    radial-gradient(760px 420px at 50% 18%, rgba(255,255,255,.14), transparent 62%),
    linear-gradient(180deg, rgba(255,214,126,.14), rgba(255,214,126,.04)),
    linear-gradient(180deg, rgba(90,11,20,.92), rgba(22,4,10,.98));
  border:1px solid rgba(255,228,166,.44);

  box-shadow:
    0 34px 110px rgba(0,0,0,.74),
    0 12px 34px rgba(0,0,0,.46);

  position:relative;
  overflow:hidden;
  transform: translateZ(0);
  contain: paint;
}

.claimBox::before{
  content:"";
  position:absolute;
  inset:10px;
  border-radius: 18px;
  border:2px solid rgba(255,228,166,.70);
  box-shadow:
    inset 0 0 0 2px rgba(199,154,64,.18),
    inset 0 0 0 1px rgba(255,255,255,.08),
    0 0 14px rgba(255,228,166,.14);
  pointer-events:none;
}

.claimBox::after{
  content:"";
  position:absolute;
  inset:-40% -70%;
  pointer-events:none;
  background: linear-gradient(
    120deg,
    transparent 0%,
    transparent 44%,
    rgba(255,228,166,.12) 49%,
    rgba(255,255,255,.12) 52%,
    transparent 58%,
    transparent 100%
  );
  opacity:.55;
  mix-blend-mode: screen;
  transform:translate3d(-58%,0,0) skewX(-10deg);
  will-change:transform;
  animation: claimSheen 3.0s var(--ease2) infinite;
}
@keyframes claimSheen{
  0%   { transform:translate3d(-60%,0,0) skewX(-10deg); }
  48%  { transform:translate3d( 60%,0,0) skewX(-10deg); }
  100% { transform:translate3d( 60%,0,0) skewX(-10deg); }
}

.claimSpin{
  position:relative;
  z-index:2;

  width:46px;
  height:46px;
  margin: 8px auto 12px;

  border-radius:999px;

  border:0 !important;
  background: radial-gradient(circle at 50% 45%,
    rgba(255,255,255,.08) 0%,
    rgba(255,228,166,.06) 28%,
    rgba(0,0,0,0) 62%
  );

  animation: claimSpin .72s linear infinite;
  will-change: transform;
  transform: translate3d(0,0,0);

  box-shadow:
    0 10px 18px rgba(0,0,0,.22),
    inset 0 0 0 1px rgba(255,255,255,.05);
}

.claimSpin::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  pointer-events:none;

  background: conic-gradient(from 90deg,
    rgba(255,228,166,0) 0%,
    rgba(255,228,166,.92) 10%,
    rgba(255,246,224,1) 16%,
    rgba(199,154,64,.92) 30%,
    rgba(255,228,166,.55) 52%,
    rgba(255,228,166,.18) 70%,
    rgba(255,228,166,0) 86%,
    rgba(255,228,166,0) 100%
  );

  -webkit-mask: radial-gradient(farthest-side,
    transparent calc(100% - 5px),
    #000 calc(100% - 4px)
  );
  mask: radial-gradient(farthest-side,
    transparent calc(100% - 5px),
    #000 calc(100% - 4px)
  );
}

.claimSpin::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  pointer-events:none;

  background: radial-gradient(14px 12px at 35% 32%,
    rgba(255,255,255,.22),
    transparent 70%
  );

  -webkit-mask: radial-gradient(farthest-side,
    transparent calc(100% - 5px),
    #000 calc(100% - 4px)
  );
  mask: radial-gradient(farthest-side,
    transparent calc(100% - 5px),
    #000 calc(100% - 4px)
  );
  opacity:.9;
}

@keyframes claimSpin{
  from{ transform:translate3d(0,0,0) rotate(0deg); }
  to  { transform:translate3d(0,0,0) rotate(360deg); }
}

.claimText{
  position:relative;
  z-index:2;
  margin:0;
  font-weight:1000;
  letter-spacing:.4px;
  color: rgba(255,246,224,.98);
  text-shadow:0 12px 26px rgba(0,0,0,.42);
  font-size: clamp(14px, 2.2vw, 16px);
}

.claimSub{
  position:relative;
  z-index:2;
  margin:8px 0 0;
  font-size:12px;
  opacity:.84;
  letter-spacing:.25px;
}

@media (prefers-reduced-motion: reduce){
  .claimSpin{ animation:none !important; }
  .claimBox::after{ animation:none !important; }
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 20 — RESPONSIVE TUNING
 * ─────────────────────────────────────────────────────────── */
@media (max-width:560px){
  :root{ --fxBright: 1.14; --fxContrast: 1.08; --fxSat: 1.12; }
  .card{ padding:24px 16px 18px; }
  .angpaoGrid{ gap:12px; }
  .cloudPng{ top:calc(var(--scene-top) + clamp(106px, 14vh, 200px) + var(--ornAllY) + var(--ornCloudY)); }
  .lanternWrap.l2{ --lx: clamp(150px, 30vw, 310px); }
  .lanternWrap.l3{ --lx: calc(100% - clamp(150px, 30vw, 310px)); }
}
@media (max-width:420px){
  :root{ --cornerW: clamp(96px, 22vw, 140px); }
  .lanternWrap{ --lScale:.92; }
  .lanternWrap.l2, .lanternWrap.l3{ --lScale:.82; }
  .popupCard{ padding:24px 14px 16px; }
  .metaRow .v{ max-width: 64%; }
}
@media (max-height:650px){
  .cloudPng{ opacity:.90; }
  .bottomOrn{ height:min(46vh,420px); }
}

/* ─────────────────────────────────────────────────────────────
 * BLOK 21 — REDUCED MOTION
 * ─────────────────────────────────────────────────────────── */
@media (prefers-reduced-motion:reduce){
  .lanternWrap, .cloudPng, .card, .bottomCloudPng{ animation:none !important; }
  .lanternWrap::after{ display:none !important; }
  .angpaoBtn, button{ transition:none !important; }
  button::before{ display:none; }
  .spinner, .claimSpin{ animation:none !important; }
}
</style>

</head>

<body>

  <!-- ✅ FIREWORKS CANVAS (AUTO INIT VIA JS) -->
  <canvas id="canvas" aria-hidden="true"></canvas>

  <!-- SVG DEFINITIONS -->
  <svg width="0" height="0" style="position:absolute;left:-9999px;top:-9999px"
       aria-hidden="true" focusable="false"
       xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="lap-gold" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#fff6df"/>
        <stop offset=".35" stop-color="#ffe4a6"/>
        <stop offset=".72" stop-color="#f2c96f"/>
        <stop offset="1" stop-color="#c79a40"/>
      </linearGradient>
      <linearGradient id="lap-gold-deep" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#f2c96f"/>
        <stop offset="1" stop-color="#8a6424"/>
      </linearGradient>

      <linearGradient id="lap-red" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0" stop-color="#ff3a44"/>
        <stop offset=".55" stop-color="#d51a2b"/>
        <stop offset="1" stop-color="#7f0a16"/>
      </linearGradient>

      <radialGradient id="lap-glow" cx=".5" cy=".42" r=".62">
        <stop offset="0" stop-color="#fff6df" stop-opacity=".95"/>
        <stop offset=".55" stop-color="#ffd37a" stop-opacity=".55"/>
        <stop offset="1" stop-color="#ff8b2c" stop-opacity="0"/>
      </radialGradient>

      <linearGradient id="lap-waveRed" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0" stop-color="#a40f1f"/>
        <stop offset=".55" stop-color="#7f0a16"/>
        <stop offset="1" stop-color="#520610"/>
      </linearGradient>
      <linearGradient id="lap-waveGold" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0" stop-color="#ffe4a6"/>
        <stop offset="1" stop-color="#c79a40"/>
      </linearGradient>

      <symbol id="lap-lantern" viewBox="0 0 140 220">
        <path d="M70 0v34" stroke="rgba(255,228,166,.88)" stroke-width="3" stroke-linecap="round"/>
        <path d="M52 34h36c4 0 7 3 7 7v6H45v-6c0-4 3-7 7-7Z" fill="url(#lap-gold)" opacity=".95"/>
        <path d="M45 47h50" stroke="rgba(0,0,0,.18)" stroke-width="3" stroke-linecap="round" opacity=".45"/>

        <path d="M40 50c8-18 52-18 60 0v92c-6 18-54 18-60 0V50Z"
              fill="url(#lap-red)" stroke="url(#lap-gold)" stroke-width="3" stroke-linejoin="round"/>

        <ellipse cx="70" cy="94" rx="34" ry="44" fill="url(#lap-glow)"/>

        <path d="M48 52c6-12 38-12 44 0" fill="none" stroke="rgba(255,228,166,.62)" stroke-width="3" stroke-linecap="round"/>
        <path d="M48 142c6 12 38 12 44 0" fill="none" stroke="rgba(255,228,166,.62)" stroke-width="3" stroke-linecap="round"/>

        <path d="M56 60c0-6 5-10 10-10h10c5 0 10 4 10 10v78c0 6-5 10-10 10H66c-5 0-10-4-10-10V60Z"
              fill="rgba(255,255,255,.10)"/>

        <path d="M52 146h36c4 0 7 3 7 7v6H45v-6c0-4 3-7 7-7Z" fill="url(#lap-gold)" opacity=".92"/>
        <path d="M70 160v16" stroke="rgba(255,228,166,.90)" stroke-width="3" stroke-linecap="round"/>
        <circle cx="70" cy="182" r="6" fill="url(#lap-gold)"/>
        <path d="M70 188v22" stroke="rgba(255,228,166,.90)" stroke-width="3" stroke-linecap="round"/>
        <path d="M62 210h16l-8 14Z" fill="url(#lap-gold-deep)" opacity=".92"/>
      </symbol>

      <symbol id="lap-bottom" viewBox="0 0 1600 720">
        <path d="M0 540C220 500 340 640 560 600C760 564 860 470 1040 520C1230 574 1320 682 1600 630V720H0Z"
              fill="url(#lap-waveRed)" opacity=".92"/>
        <path d="M0 590C240 545 360 680 580 640C780 605 900 520 1080 570C1260 625 1360 715 1600 670"
              fill="none" stroke="url(#lap-waveGold)" stroke-width="10" stroke-linecap="round" opacity=".55"/>
        <path d="M0 640C260 610 420 710 640 680C860 652 980 590 1160 628C1340 666 1440 730 1600 710"
              fill="none" stroke="rgba(255,228,166,.28)" stroke-width="8" stroke-linecap="round"/>
        <g opacity=".18">
          <circle cx="180" cy="610" r="12" fill="url(#lap-gold)"/>
          <circle cx="260" cy="645" r="8" fill="url(#lap-gold)"/>
          <circle cx="1320" cy="640" r="10" fill="url(#lap-gold)"/>
          <circle cx="1440" cy="610" r="7" fill="url(#lap-gold)"/>
        </g>
      </symbol>
    </defs>
  </svg>

  <!-- Decorative scene -->
  <div class="scene" aria-hidden="true">
    <div class="corner tl"></div>
    <div class="corner tr"></div>

    <div class="lanternWrap l1"><svg viewBox="0 0 140 220" focusable="false"><use href="#lap-lantern"></use></svg></div>
    <div class="lanternWrap l2"><svg viewBox="0 0 140 220" focusable="false"><use href="#lap-lantern"></use></svg></div>
    <div class="lanternWrap l3"><svg viewBox="0 0 140 220" focusable="false"><use href="#lap-lantern"></use></svg></div>
    <div class="lanternWrap l4"><svg viewBox="0 0 140 220" focusable="false"><use href="#lap-lantern"></use></svg></div>

    <div class="cloudPng cLeft"></div>
    <div class="cloudPng cMid"></div>
    <div class="cloudPng cRight"></div>

    <div class="bottomCloudPng"></div>

    <svg class="bottomOrn" viewBox="0 0 1600 720" preserveAspectRatio="none" focusable="false">
      <use href="#lap-bottom"></use>
    </svg>
  </div>

  <!-- PAGE TITLE -->
  <header class="pageTitle" aria-label="Judul Halaman">
    <div class="pageTitleInner">
      <div class="ptLine1">
        <span class="ptWelcome">SELAMAT DATANG DI</span>
        <span class="ptBrand">MADETOTO2</span>
      </div>
      <div class="ptLine2">Pilih Ang Pao keberuntunganmu & dapatkan hadiah!</div>
      <div class="ptLine3">Hingga Total Jutaan! Menang Besar</div>
    </div>
  </header>

  <!-- UI -->
  <div class="ui">
    <div class="uiInner">

      <!-- Login -->
      <div class="card" id="login-menu">
        <div class="innerPattern"></div>
        <h1 class="title" id="ui-title">Lucky Ang Pao</h1>
        <p class="sub" id="ui-sub">Masukkan User ID Anda lalu mulai permainan</p>

        <div class="fields">
          <input type="text" id="username" placeholder="Contoh: USER123" autocomplete="username" inputmode="text" aria-label="User ID"/>
        </div>

        <div class="btnRow">
          <button id="btnStart" type="button">MULAI</button>
        </div>

        <p class="err" id="err" role="alert" aria-live="polite"></p>
        <div class="hint" id="ui-hint">© 2025 Admin. All rights reserved.</div>
      </div>

      <!-- Main -->
      <div class="card" id="main-menu">
        <div class="innerPattern"></div>
        <h1 class="title" id="main-title">Pilih Ang Pao Keberuntunganmu!</h1>
        <div class="angpaoGrid" id="angpao-grid" aria-label="Pilih salah satu Ang Pao"></div>

        <div class="btnRow" style="margin-top:12px">
          <button id="btnShowPrize" class="btnGhost" type="button">HADIAH</button>
        </div>

        <div class="hint" id="main-hint">Klik salah satu Ang Pao</div>
      </div>

    </div>
  </div>

  <!-- OVERLAY HADIAH (GRID 4 PNG) -->
  <div id="prizeOverlay" role="dialog" aria-modal="true" aria-label="Daftar Hadiah">
    <div class="prizeMiniCard" role="document">
      <div class="prizeMiniBody">
        <div class="prizeMiniTitle" id="prizeOverlayTitle">HADIAH UTAMA</div>
        <div class="prizeGrid" id="prizeGrid" aria-label="Grid hadiah"></div>
        <p class="prizeMiniHint" id="prizeOverlayHint">—</p>
      </div>

      <div class="prizeMiniBtns">
        <button id="btnPrizeOk" type="button">OK</button>
      </div>
    </div>
  </div>

  <!-- Popup (reward) -->
  <div id="popup" role="dialog" aria-modal="true" aria-label="Hadiah">
    <div class="popupCard" role="document" aria-describedby="reward-text">
      <button class="closeX" id="btnClose" type="button" aria-label="Tutup">&times;</button>

      <div class="rewardText" id="reward-text">
        <div class="t1">SELAMAT</div>
        <div class="t2">Anda Mendapatkan Hadiah</div>
      </div>

      <div class="rewardPrize" aria-label="Detail hadiah">
        <div class="rewardThumb" aria-hidden="true">
          <img id="prize-img" alt="" decoding="async" loading="eager">
        </div>
        <div class="rewardValWrap">
          <div class="val" id="prize-val">—</div>
        </div>
      </div>

      <div class="popMeta" aria-label="Detail pengguna">
        <div class="metaRow">
          <div class="k">User ID</div>
          <div class="v" id="meta-user">—</div>
        </div>
        <div class="metaRow">
          <div class="k">Waktu</div>
          <div class="v" id="meta-time">—</div>
        </div>
      </div>

      <div class="statusNote" id="status-note" aria-live="polite"></div>

      <div class="popupBtns">
        <button id="btnClaim" type="button">
          <span class="btnLoading" id="claimLabel">CLAIM SEKARANG</span>
        </button>
        <button id="btnShare" class="btnGhost" type="button">BAGIKAN</button>
      </div>
    </div>
  </div>

  <!-- CLAIM LOADING OVERLAY -->
  <div id="claimOverlay" aria-hidden="true">
    <div class="claimBox" role="status" aria-live="polite">
      <div class="claimSpin" aria-hidden="true"></div>
      <p class="claimText" id="claimOverlayText">Memproses klaim...</p>
      <p class="claimSub" id="claimOverlaySub">Mohon tunggu sebentar</p>
    </div>
  </div>

  <!-- Audio -->
  <audio id="bgMusic" loop preload="auto"></audio>
  <audio id="winSound" preload="auto"></audio>
  <audio id="clickSound" preload="auto"></audio>

<script>
(() => {
  "use strict";

  // =====================================================
  // ✅ CONFIG — EDIT DI SINI SAJA
  // =====================================================
  const CONFIG = {
    site: {
      title: "Lucky Ang Pao",
      shareTitle: "Lucky Ang Pao",
      baseUrl: "https://madetoto2.info/",
      claimRedirectUrl: "https://madetoto2.info/",
      requireUsername: true,
      timeZone: "Asia/Jakarta", // ganti kalau mau: "Asia/Phnom_Penh"
      loginSubtitle: "Masukkan User ID Anda lalu mulai permainan",
      hintLogin: "© 2025 Madetoto2. All rights reserved.",
      hintMain: "Pilih salah satu Ang Pao"
    },

    images: {
      cornerLeft:  "https://i.postimg.cc/ZKHcV5Rq/Pngtree-chinese-gradient-auspicious-cloud-5400711.png",
      cornerRight: "https://i.postimg.cc/ZKHcV5Rq/Pngtree-chinese-gradient-auspicious-cloud-5400711.png",
      cloudLeft:   "https://i.postimg.cc/ZKHcV5Rq/Pngtree-chinese-gradient-auspicious-cloud-5400711.png",
      cloudMid:    "https://i.postimg.cc/MK7Tn3Q6/Mooon.png",
      cloudRight:  "https://i.postimg.cc/ZKHcV5Rq/Pngtree-chinese-gradient-auspicious-cloud-5400711.png",
      bottomCloud: "https://i.postimg.cc/yd8Gh12G/Wave.png",
      angpao:      "https://i.postimg.cc/CxRSkfR6/511.png"
    },

    prizeIntro: {
      enabled: true,
      showOncePerDevice: true,
      storageKey: "lap_prize_intro_seen_v2",
      items: [
        { name: "iPhone 17 Pro Max",       img: "https://i.postimg.cc/D0HdMCG3/i-Phone-17-Pro-Max.png" },
        { name: "BONUS IMLEK 20%",        img: "https://i.postimg.cc/fTvxGj9S/Gift-Box.png" },
        { name: "Free Saldo Rp 200.000",  img: "https://i.postimg.cc/nMf9mN7m/Uang-Tunai.png" },
        { name: "Apple Watch Series",     img: "https://i.postimg.cc/g2w1j5sR/Apple-Watch.png" }
      ],
      hintText: "Hadiah utama event ini. Klik OK untuk lanjut bermain."
    },

    game: {
      envelopes: 9,
      lockAfterPick: true,

      oneUsernamePerDevice: true,
      onePlayPerDevice: true,

      storageKey: "lap_cny_2026_v1",

      primaryPrizes: ["BONUS IMLEK 20%", "Rp 200.000"],
      autoLockPrimaryMode: "fixed", // "off" | "random" | "fixed"
      lockedPrizeFixed: "BONUS IMLEK 20%",

      defaultPrizeImg: "https://i.postimg.cc/fTvxGj9S/Gift-Box.png",
      prizeImageMap: {
        "BONUS IMLEK 20%": "https://i.postimg.cc/fTvxGj9S/Gift-Box.png",
        "Rp 200.000":      "https://i.postimg.cc/nMf9mN7m/Uang-Tunai.png"
      },

      prizes: [
        { label: "Rp 5.000",        weight: 28 },
        { label: "Rp 10.000",       weight: 22 },
        { label: "Rp 15.000",       weight: 16 },
        { label: "Rp 20.000",       weight: 12 },
        { label: "Rp 25.000",       weight: 9  },
        { label: "Rp 30.000",       weight: 6  },
        { label: "Rp 50.000",       weight: 4  },
        { label: "Rp 75.000",       weight: 2  },
        { label: "Rp 100.000",      weight: 1  },
        { label: "BONUS IMLEK 20%", weight: 2  },
        { label: "Rp 200.000",      weight: 1  }
      ]
    },

    api: {
      enabled: false,
      timeoutMs: 8000,
      headers: { "Content-Type": "application/json" },
      endpoints: {
        reveal: "/api/angpao/reveal",
        claim:  "/api/angpao/claim"
      }
    },

    audio: {
      enabled: true,
      bgUrl:   "https://image2url.com/r2/default/audio/1770706135896-b0cdbdfc-7db9-48f8-ba57-557666c53e10.mp3",
      winUrl:  "",
      clickUrl:"https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3",
      volumeBg: 0.55,
      volumeWin: 0.75,
      volumeClick: 0.55,
      fadeMs: 420
    },

    claimUX: {
      loadingMs: 1800,
      openInNewTab: true,
      overlayText: "Menghubungkan halaman...",
      overlaySub: "Mohon tunggu sebentar"
    },

    ornaments: {
      allX: 0, allY: 0,
      cornerX: 0, cornerY: 0,
      lanternX: 0, lanternY: 0,
      cloudX: 0, cloudY: 0,
      bottomX: 0, bottomY: 0,
      bottomOrnX: 0
    },

    // ✅ FIREWORKS (AUTO AFTER OPEN ANGPAO)
    fireworks: {
      enabled: true,
      probability: 0.052,
      maxParticles: 950,
      burstMin: 95,
      burstMax: 175,
      gravity: 0.065,
      alphaDecay: 0.0135,
      fade: 0.18,
      dprMax: 2,
      bigBoost: 1.25
    },

    security: {
      enabled: true,
      blockContextMenu: true,
      blockKeys: true,
      devtoolsDetect: false,
      devtoolsThresholdPx: 160,
      devtoolsPollMs: 700,
      overlayTitle: "AKSES TERBATAS",
      overlayText: "Konten ini dilindungi. Silakan gunakan akses resmi dari Admin."
    }
  };

  // =====================================================
  // UTIL
  // =====================================================
  const $  = (q, r=document) => r.querySelector(q);
  const $$ = (q, r=document) => Array.from(r.querySelectorAll(q));
  const root = document.documentElement;

  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const nowMs = () => Date.now();

  const isTouchDevice = (() => {
    try { return (navigator.maxTouchPoints || 0) > 0 || "ontouchstart" in window; } catch { return false; }
  })();

  function escapeText(s){
    return String(s ?? "").replace(/\s+/g, " ").trim();
  }

  function setCSSUrlVar(name, url){
    if (!url) return;
    root.style.setProperty(name, `url("${String(url).replace(/"/g,'\\"')}")`);
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  function weightedPick(items){
    const pool = (items || []).filter(x => x && x.label && Number.isFinite(x.weight) && x.weight > 0);
    if (!pool.length) return "Hadiah Misterius";
    let total = 0;
    for (const it of pool) total += it.weight;
    let r = Math.random() * total;
    for (const it of pool){
      r -= it.weight;
      if (r <= 0) return it.label;
    }
    return pool[pool.length - 1].label;
  }

  function fmtTime(ts = Date.now()){
    const tz = String(CONFIG.site.timeZone || "").trim() || (Intl.DateTimeFormat().resolvedOptions().timeZone || "Asia/Jakarta");
    try{
      const d = ts instanceof Date ? ts : new Date(ts);
      if (isNaN(d)) return "";
      const date = new Intl.DateTimeFormat("id-ID", {
        day:"2-digit", month:"2-digit", year:"numeric", timeZone: tz
      }).format(d).replace(/\./g, "/");
      const time = new Intl.DateTimeFormat("id-ID", {
        hour:"2-digit", minute:"2-digit", hour12:false, timeZone: tz
      }).format(d).replace(/:/g, ".");
      return `${date} • ${time}`;
    } catch { return ""; }
  }

  function preloadImage(url){
    if (!url) return;
    const u = String(url).trim();
    if (!/^https?:\/\//i.test(u) && !u.startsWith("data:")) return;

    // defer supaya nggak nge-freeze device low
    const run = () => {
      try{
        const link = document.createElement("link");
        link.rel = "preload";
        link.as = "image";
        link.href = u;
        link.crossOrigin = "anonymous";
        document.head.appendChild(link);
      }catch{}
      try{
        const img = new Image();
        img.decoding = "async";
        img.loading = "eager";
        img.src = u;
      }catch{}
    };

    if ("requestIdleCallback" in window){
      try{ requestIdleCallback(run, { timeout: 1200 }); }catch{ setTimeout(run, 0); }
    } else {
      setTimeout(run, 0);
    }
  }

  async function apiFetch(path, body){
    const base = (CONFIG.site.baseUrl || "").replace(/\/+$/,"");
    const url  = (String(path || "").startsWith("http") ? path : (base + path));

    const ac = new AbortController();
    const t  = setTimeout(() => ac.abort(), clamp(+CONFIG.api.timeoutMs || 8000, 1200, 20000));

    try{
      const res = await fetch(url, {
        method: "POST",
        headers: CONFIG.api.headers || { "Content-Type": "application/json" },
        body: JSON.stringify(body || {}),
        signal: ac.signal
      });

      const txt = await res.text();
      let json = null;
      try{ json = JSON.parse(txt); }catch{}

      if (!res.ok){
        const msg = (json && (json.message || json.error)) ? (json.message || json.error) : (txt || "Request gagal");
        throw new Error(msg);
      }
      return json ?? { ok:true, raw: txt };
    } finally {
      clearTimeout(t);
    }
  }

  // =====================================================
  // META AUTO
  // =====================================================
  function applyMeta(){
    const base = escapeText(CONFIG.site.baseUrl) || window.location.href;
    const ogUrl = $('meta[property="og:url"]');
    const canonical = $('link[rel="canonical"]');
    if (ogUrl) ogUrl.setAttribute("content", base);
    if (canonical) canonical.setAttribute("href", base);

    const ogTitle = $('meta[property="og:title"]');
    if (ogTitle) ogTitle.setAttribute("content", escapeText(CONFIG.site.title || document.title));

    const ogImg = $('meta[property="og:image"]');
    const candidateImg = escapeText(CONFIG.images?.angpao || "");
    if (ogImg && candidateImg) ogImg.setAttribute("content", candidateImg);
  }

  // =====================================================
  // STORAGE (localStorage fallback aman)
  // =====================================================
  const STORE = (() => {
    const base = String(CONFIG.game.storageKey || "lap_cny_2026_v1");
    const kUser   = `${base}:user`;
    const kPlayed = `${base}:played`;
    const kResult = `${base}:result`;

    const mem = new Map();
    const lsOk = (() => {
      try{
        const k = "__t";
        localStorage.setItem(k, "1");
        localStorage.removeItem(k);
        return true;
      }catch{ return false; }
    })();

    const get = (k) => {
      try{
        if (lsOk) return localStorage.getItem(k);
        return mem.has(k) ? String(mem.get(k)) : null;
      }catch{ return mem.has(k) ? String(mem.get(k)) : null; }
    };

    const set = (k, v) => {
      try{
        if (lsOk) localStorage.setItem(k, v);
        else mem.set(k, v);
      }catch{ mem.set(k, v); }
    };

    const getJSON = (k) => {
      const v = get(k);
      if (!v) return null;
      try{ return JSON.parse(v); }catch{ return null; }
    };
    const setJSON = (k, obj) => set(k, JSON.stringify(obj));

    return {
      keys: { kUser, kPlayed, kResult },
      get, set, getJSON, setJSON,
      isPlayed(){ return get(kPlayed) === "1"; },
      setPlayed(){ set(kPlayed, "1"); },
      getUser(){ return get(kUser) || ""; },
      setUser(u){ set(kUser, String(u || "")); },
      getResult(){ return getJSON(kResult); },
      setResult(obj){ setJSON(kResult, obj); }
    };
  })();

// =====================================================
// SECURITY OVERLAY (NO CSS INJECT)
// =====================================================
const Security = (() => {
  if (!CONFIG.security?.enabled) return { init(){}, lock(){}, isLocked(){ return false; } };

  let locked = false;
  let overlay = null;

  function ensureOverlay(){
    if (overlay) return overlay;

    overlay = document.createElement("div");
    overlay.id = "secOverlay";
    overlay.innerHTML = `
      <div class="box" role="alert" aria-live="assertive">
        <div class="t">${escapeText(CONFIG.security.overlayTitle || "AKSES TERBATAS")}</div>
        <div class="m" id="secOverlayMsg">${escapeText(CONFIG.security.overlayText || "Konten ini dilindungi.")}</div>
        <div class="s">Konten ini dilindungi. Silakan gunakan akses resmi dari Admin</div>
      </div>
    `;
    document.body.appendChild(overlay);
    return overlay;
  }

  function lock(reason){
    if (locked) return;
    locked = true;
    const ov = ensureOverlay();
    const msg = $("#secOverlayMsg", ov);
    if (msg && reason) msg.textContent = escapeText(reason);
    ov.style.display = "flex";
    try{
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";
    }catch{}
  }

  function isLocked(){ return locked; }

  function keyBlocker(e){
    if (!CONFIG.security.blockKeys) return;
    if (locked) { e.preventDefault(); e.stopPropagation(); return; }

    const k = (e.key || "").toLowerCase();
    const ctrl = e.ctrlKey || e.metaKey;
    const shift = e.shiftKey;

    const blocked =
      (k === "f12") ||
      (ctrl && k === "u") ||
      (ctrl && shift && (k === "i" || k === "j" || k === "c")) ||
      (ctrl && k === "s") ||
      (ctrl && k === "p");

    if (blocked){
      e.preventDefault();
      e.stopPropagation();
      lock("Akses terbatas.");
    }
  }

  function contextBlocker(e){
    if (!CONFIG.security.blockContextMenu) return;

    // mobile: long-press sering memicu contextmenu -> cukup prevent, jangan lock
    if (isTouchDevice){
      e.preventDefault();
      return;
    }

    if (locked) { e.preventDefault(); return; }
    e.preventDefault();
    lock("Akses terbatas.");
  }

  function devtoolsDetector(){
    if (!CONFIG.security.devtoolsDetect) return;
    const thr = clamp(+CONFIG.security.devtoolsThresholdPx || 160, 80, 420);
    const w = Math.abs((window.outerWidth || 0) - (window.innerWidth || 0));
    const h = Math.abs((window.outerHeight || 0) - (window.innerHeight || 0));
    if (w > thr || h > thr) lock("Akses terbatas.");
  }

  function init(){
    window.addEventListener("keydown", keyBlocker, true);
    window.addEventListener("contextmenu", contextBlocker, { capture:true });

    if (CONFIG.security.devtoolsDetect){
      setInterval(devtoolsDetector, clamp(+CONFIG.security.devtoolsPollMs || 700, 250, 2000));
    }
  }

  return { init, lock, isLocked };
})();

  const onReady = (fn) => {
    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", fn, { once:true });
    } else fn();
  };

  onReady(() => {
    // =====================================================
    // DOM
    // =====================================================
    const loginMenu  = $("#login-menu");
    const mainMenu   = $("#main-menu");
    const errEl      = $("#err");
    const usernameEl = $("#username");

    const btnStart = $("#btnStart");

    const grid     = $("#angpao-grid");
    const popup    = $("#popup");
    const btnClose = $("#btnClose");
    const btnClaim = $("#btnClaim");
    const btnShare = $("#btnShare");

    const prizeVal   = $("#prize-val");
    const prizeImgEl = $("#prize-img");
    const metaUser   = $("#meta-user");
    const metaTime   = $("#meta-time");

    const statusNote = $("#status-note");

    const bgMusic    = $("#bgMusic");
    const winSound   = $("#winSound");
    const clickSound = $("#clickSound");

    const uiTitle  = $("#ui-title");
    const uiSub    = $("#ui-sub");
    const uiHint   = $("#ui-hint");
    const mainHint = $("#main-hint");

    const claimLabel = $("#claimLabel");

    // prize overlay
    const prizeOverlay = $("#prizeOverlay");
    const prizeGrid = $("#prizeGrid");
    const prizeOverlayHint = $("#prizeOverlayHint");
    const btnPrizeOk = $("#btnPrizeOk");
    const btnShowPrize = $("#btnShowPrize");

    // claim overlay
    const claimOverlay = $("#claimOverlay");
    const claimOverlayText = $("#claimOverlayText");
    const claimOverlaySub  = $("#claimOverlaySub");

    // =====================================================
    // APPLY CONFIG
    // =====================================================
    document.title = CONFIG.site.title || document.title;
    if (uiTitle) uiTitle.textContent = CONFIG.site.title || uiTitle.textContent;
    if (uiSub) uiSub.textContent = CONFIG.site.loginSubtitle || uiSub.textContent;
    if (uiHint) uiHint.textContent = CONFIG.site.hintLogin || uiHint.textContent;
    if (mainHint) mainHint.textContent = CONFIG.site.hintMain || mainHint.textContent;

    setCSSUrlVar("--corner-left-url",  CONFIG.images.cornerLeft);
    setCSSUrlVar("--corner-right-url", CONFIG.images.cornerRight);
    setCSSUrlVar("--cloud-left-url",   CONFIG.images.cloudLeft);
    setCSSUrlVar("--cloud-mid-url",    CONFIG.images.cloudMid);
    setCSSUrlVar("--cloud-right-url",  CONFIG.images.cloudRight);
    setCSSUrlVar("--bottom-cloud-url", CONFIG.images.bottomCloud);
    setCSSUrlVar("--angpao-url",       CONFIG.images.angpao);

    // preload (defer)
    Object.values(CONFIG.images || {}).forEach(preloadImage);
    (CONFIG.prizeIntro?.items || []).forEach(it => { if (it?.img) preloadImage(it.img); });
    Object.values(CONFIG.game?.prizeImageMap || {}).forEach(preloadImage);
    if (CONFIG.game?.defaultPrizeImg) preloadImage(CONFIG.game.defaultPrizeImg);

    (function applyOrnaments(){
      const o = CONFIG.ornaments || {};
      const setPx = (name, val) => root.style.setProperty(name, `${clamp(Number(val)||0, -500, 500)}px`);

      setPx("--ornAllX", o.allX);
      setPx("--ornAllY", o.allY);

      setPx("--ornCornerX", o.cornerX);
      setPx("--ornCornerY", o.cornerY);

      setPx("--ornLanternX", o.lanternX);
      setPx("--ornLanternY", o.lanternY);

      setPx("--ornCloudX", o.cloudX);
      setPx("--ornCloudY", o.cloudY);

      setPx("--ornBottomX", o.bottomX);
      setPx("--ornBottomY", o.bottomY);
      setPx("--ornBottomOrnX", o.bottomOrnX);
    })();

    applyMeta();

    if (CONFIG.audio.enabled){
      if (bgMusic && CONFIG.audio.bgUrl) bgMusic.src = CONFIG.audio.bgUrl;
      if (winSound && CONFIG.audio.winUrl) winSound.src = CONFIG.audio.winUrl;
      if (clickSound && CONFIG.audio.clickUrl) clickSound.src = CONFIG.audio.clickUrl;
    }

    Security.init();

// =====================================================
// FIREWORKS (AUTO-QUALITY + AUTO-ON-OPEN + RINGAN)
//  - auto scaling: deviceMemory/cores + fps adaptif
//  - auto ON saat Angpao "opened" (event / class / dataset / popup)
//  - celebrate burst awal + sustain beberapa detik (smooth)
//  - stop loop benar-benar mati saat off (hemat baterai)
// =====================================================
const Fireworks = (() => {
  const PI2 = Math.PI * 2;

  // fallback clamp kalau belum ada di scope kamu
  const _clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const clamp = (typeof window !== "undefined" && typeof window.clamp === "function")
    ? window.clamp
    : _clamp;

  const mm = (q) => { try { return matchMedia(q); } catch { return null; } };
  const pr = mm("(prefers-reduced-motion: reduce)");
  let prefersReduce = !!pr?.matches;

  // ---------- auto tier ----------
  const devMem = (() => { try { return Number(navigator.deviceMemory || 0) || 0; } catch { return 0; } })();
  const cores  = (() => { try { return Number(navigator.hardwareConcurrency || 0) || 0; } catch { return 0; } })();

  const tier = (() => {
    if ((devMem && devMem <= 4) || (cores && cores <= 4)) return "low";
    if ((devMem && devMem >= 8) && (cores && cores >= 8)) return "high";
    return "mid";
  })();

  // ---------- base config ----------
  const baseCfg = {
    enabled: false,

    // sustain
    probability: clamp(+CONFIG.fireworks?.probability || 0.052, 0.0, 0.14),
    maxParticles: clamp(+CONFIG.fireworks?.maxParticles || 950, 120, 3200),

    burstMin: clamp(+CONFIG.fireworks?.burstMin || 95, 25, 520),
    burstMax: clamp(+CONFIG.fireworks?.burstMax || 175, 35, 900),

    gravity: clamp(+CONFIG.fireworks?.gravity || 0.065, 0.01, 0.24),
    alphaDecay: clamp(+CONFIG.fireworks?.alphaDecay || 0.0135, 0.006, 0.035),
    fade: clamp(+CONFIG.fireworks?.fade || 0.18, 0.05, 0.50),

    dprMax: clamp(+CONFIG.fireworks?.dprMax || 2, 1, 3),
    bigBoost: clamp(+CONFIG.fireworks?.bigBoost || 1.25, 1, 2.4),

    // auto celebrate (ms)
    celebrateMs: clamp(+CONFIG.fireworks?.celebrateMs || 6500, 1200, 20000),

    // lebih aman untuk low device
    lowDprCap: 1.5,
  };

  // scale baseline by tier
  const tierMul = (tier === "low") ? 0.72 : (tier === "high") ? 1.08 : 0.92;

  const cfg = {
    ...baseCfg,
    probability: baseCfg.probability * tierMul,
    maxParticles: Math.floor(baseCfg.maxParticles * tierMul),
    burstMin: Math.floor(baseCfg.burstMin * tierMul),
    burstMax: Math.floor(baseCfg.burstMax * tierMul),
    dprMax: (tier === "low") ? Math.min(baseCfg.dprMax, baseCfg.lowDprCap) : baseCfg.dprMax,
  };

  // ---------- colors ----------
  const gold = [
    [255, 246, 223],
    [255, 228, 166],
    [243, 178, 74],
    [255, 211, 92],
    [255, 160, 55],
  ];
  const pickGold = () => {
    const c = gold[(Math.random() * gold.length) | 0];
    const j = () => ((Math.random() * 18 - 9) | 0);
    const r = Math.max(0, Math.min(255, c[0] + j()));
    const g = Math.max(0, Math.min(255, c[1] + j()));
    const b = Math.max(0, Math.min(255, c[2] + j()));
    return `rgb(${r},${g},${b})`;
  };

  // ---------- state ----------
  let canvas, ctx, W = 0, H = 0, DPR = 1;
  let raf = 0;
  let running = false;
  let pausedByHidden = false;

  const particles = [];
  const pool = [];

  // fps adaptive
  let lastT = 0;
  let dtAvg = 16.7;
  let coolDown = 0;

  // smooth ramp (biar tidak “nyentak”)
  let ramp = 0; // 0..1
  let rampTo = 0;

  // auto celebrate timer
  let celebrateTimer = 0;

  // auto open watcher
  let openWatchRaf = 0;
  let openWatchArmed = false;
  let openStateLast = false;

  function init(id = "canvas") {
    canvas = document.getElementById(id);

    // fallback cari canvas lain kalau id beda
    if (!canvas) canvas = document.getElementById("particle-canvas");
    if (!canvas) canvas = document.querySelector("canvas#canvas, canvas#particle-canvas, canvas[data-fireworks]");
    if (!canvas) return false;

    ctx = canvas.getContext("2d", { alpha: true, desynchronized: true });
    if (!ctx) return false;

    let rRAF = 0;
    const onResize = () => {
      cancelAnimationFrame(rRAF);
      rRAF = requestAnimationFrame(resize);
    };
    window.addEventListener("resize", onResize, { passive: true });

    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        pausedByHidden = cfg.enabled;
        cfg.enabled = false;
        rampTo = 0;
        stopLoop(true);
      } else {
        if (pausedByHidden) setEnabled(true);
        pausedByHidden = false;
      }
    }, { passive: true });

    pr?.addEventListener?.("change", () => {
      prefersReduce = !!mm("(prefers-reduced-motion: reduce)")?.matches;
      if (prefersReduce) {
        cfg.enabled = false;
        rampTo = 0;
        stopLoop(true);
      }
    });

    resize();
    return true;
  }

  function resize() {
    if (!canvas || !ctx) return;

    const dpr = window.devicePixelRatio || 1;
    DPR = Math.min(cfg.dprMax, Math.max(1, dpr));

    W = Math.max(1, window.innerWidth);
    H = Math.max(1, window.innerHeight);

    canvas.width = Math.floor(W * DPR);
    canvas.height = Math.floor(H * DPR);
    canvas.style.width = W + "px";
    canvas.style.height = H + "px";

    ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    clear();
  }

  function clear() {
    if (!ctx) return;
    ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    ctx.clearRect(0, 0, W, H);
  }

  function startLoop() {
    if (running) return;
    running = true;
    lastT = 0;
    raf = requestAnimationFrame(loop);
  }

  function stopLoop(forceClear) {
    if (!running) return;
    running = false;
    cancelAnimationFrame(raf);
    raf = 0;
    if (forceClear) clear();
  }

  function loop(t) {
    if (!running) return;

    if (!lastT) lastT = t;
    const dt = Math.min(60, Math.max(0, t - lastT));
    lastT = t;

    dtAvg = dtAvg * 0.92 + dt * 0.08;

    // auto cooldown (kalau berat)
    if (cfg.enabled && !prefersReduce && !document.hidden) {
      if (dtAvg > 26) coolDown = Math.min(12, coolDown + 1);
      else if (dtAvg < 19) coolDown = Math.max(0, coolDown - 1);
    } else {
      coolDown = Math.min(12, coolDown + 1);
    }

    // smooth ramp (biar ON/OFF halus)
    const rampSpd = 0.08; // semakin kecil semakin halus
    ramp += (rampTo - ramp) * rampSpd;

    if (cfg.enabled && !prefersReduce && !document.hidden) {
      update(coolDown);
      paint();
      // kalau dimatiin di tengah, habiskan partikel lalu stop
      if (!cfg.enabled && particles.length === 0) stopLoop(true);
    } else {
      if (particles.length) {
        update(12);
        paint();
      } else {
        stopLoop(true);
        return;
      }
    }

    raf = requestAnimationFrame(loop);
  }

  function update(cd) {
    // burst chance turun saat fps drop + ramp
    const probBase = cfg.probability * (cd ? (1 / (1 + cd * 0.25)) : 1);
    const prob = probBase * clamp(ramp, 0, 1);

    if (particles.length < cfg.maxParticles && cd < 10 && Math.random() < prob) {
      burst();
    }

    for (let i = particles.length - 1; i >= 0; i--) {
      const p = particles[i];
      p.x += p.vx;
      p.vy += cfg.gravity;
      p.y += p.vy;
      p.a -= p.da;

      if (p.a <= 0 || p.x < -30 || p.x > W + 30 || p.y > H + 60) {
        particles[i] = particles[particles.length - 1];
        particles.pop();
        if (pool.length < 4000) pool.push(p);
      }
    }
  }

  function paint() {
    if (!ctx) return;

    // fade jejak (canvas transparan)
    ctx.globalCompositeOperation = "destination-out";
    // ramp juga bikin fade makin halus saat baru ON
    const fade = cfg.fade * (0.55 + 0.45 * clamp(ramp, 0, 1));
    ctx.fillStyle = `rgba(0,0,0,${fade})`;
    ctx.fillRect(0, 0, W, H);

    ctx.globalCompositeOperation = "lighter";
    for (let i = 0; i < particles.length; i++) {
      const p = particles[i];
      ctx.globalAlpha = p.a;
      ctx.fillStyle = p.color;

      if (p.r < 1.15) {
        ctx.fillRect(p.x, p.y, 1.2, 1.2);
      } else {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, PI2);
        ctx.fill();
      }
    }

    ctx.globalAlpha = 1;
  }

  function burst(
    x = Math.random() * (W - 240) + 120,
    y = Math.random() * (H - 260) + 130,
    count,
    isBig = false
  ) {
    if (!ctx) return;

    const mul = isBig ? cfg.bigBoost : 1;
    const n0 = count ?? ((Math.random() * (cfg.burstMax - cfg.burstMin) + cfg.burstMin) | 0);

    // kalau fps drop, pangkas burst
    const fpsCut = (dtAvg > 28) ? 0.65 : (dtAvg > 24) ? 0.82 : 1;
    const rampCut = 0.65 + 0.35 * clamp(ramp, 0, 1);

    const n = Math.max(1, Math.floor(n0 * mul * fpsCut * rampCut));
    const color = pickGold();

    for (let i = 0; i < n; i++) {
      const p = pool.pop() || { x:0, y:0, vx:0, vy:0, r:1, a:1, da:0, color:"#fff" };

      const ang = Math.random() * PI2;
      const spd = Math.random() * 5.1 + 1.35;

      p.x = x;
      p.y = y;
      p.vx = Math.cos(ang) * spd;
      p.vy = Math.sin(ang) * spd;

      p.r = Math.random() * 2.1 + 0.7;
      p.a = Math.random() * 0.45 + 0.55;
      p.da = cfg.alphaDecay * (Math.random() * 0.7 + 0.75);
      p.color = color;

      particles.push(p);
      if (particles.length >= cfg.maxParticles) break;
    }
  }

  function setEnabled(v) {
    if (prefersReduce) {
      cfg.enabled = false;
      rampTo = 0;
      stopLoop(true);
      return;
    }
    cfg.enabled = !!v;

    if (cfg.enabled) {
      rampTo = 1;
      startLoop();
    } else {
      rampTo = 0;
      clearTimeout(celebrateTimer);
      celebrateTimer = 0;
      if (!particles.length) stopLoop(true);
    }
  }

  // sekali tembak + nyala beberapa detik (smooth)
  function celebrate(opts = {}) {
    const ms = clamp(+opts.ms || cfg.celebrateMs, 600, 20000);
    const big = opts.big !== false;

    setEnabled(true);

    // burst awal bertahap (lebih “premium” & tidak mendadak berat)
    const x = W * 0.5;
    const y = H * 0.28;

    // 1) center big
    burst(x, y, undefined, big);

    // 2) kiri kanan sedikit delay
    setTimeout(() => burst(W * 0.30, H * 0.34, cfg.burstMin, false), 110);
    setTimeout(() => burst(W * 0.70, H * 0.34, cfg.burstMin, false), 190);

    // 3) top sparkle
    setTimeout(() => burst(W * 0.50, H * 0.18, Math.floor(cfg.burstMin * 0.75), false), 260);

    clearTimeout(celebrateTimer);
    celebrateTimer = setTimeout(() => setEnabled(false), ms);
  }

  function burstFromEvent(ev, count, isBig = false) {
    const x = ev?.clientX;
    const y = ev?.clientY;
    if (Number.isFinite(x) && Number.isFinite(y)) burst(x, y, count, isBig);
    else burst(W * 0.5, H * 0.30, count, isBig);
  }

  function isReady() { return !!ctx && !!canvas; }

  // =====================================================
  // AUTO ON ketika Angpao "opened"
  //  - Event: angpao:opened / angpao-opened / reveal:done / reward:show
  //  - Heuristik: body/html class/dataset + #popup/#revealFX tampil
  // =====================================================
  function _detectOpened() {
    try {
      // 1) flag global (kalau kamu punya)
      if (window.__ANGPAO_OPENED__ === true) return true;
      if (window.ANGPAO_OPENED === true) return true;

      // 2) dataset/class
      const de = document.documentElement;
      const bd = document.body;
      if (de?.dataset?.angpaoOpened === "1" || de?.dataset?.angpaoOpen === "1") return true;
      if (bd?.dataset?.angpaoOpened === "1" || bd?.dataset?.angpaoOpen === "1") return true;

      if (de?.classList?.contains("angpao-opened") || de?.classList?.contains("opened")) return true;
      if (bd?.classList?.contains("angpao-opened") || bd?.classList?.contains("opened")) return true;

      // 3) popup/reveal visible (umum dipakai setelah buka)
      const popup = document.getElementById("popup");
      if (popup) {
        const ds = getComputedStyle(popup).display;
        if (ds !== "none" && ds !== "") return true;
      }
      const fx = document.getElementById("revealFX");
      if (fx) {
        const ds = getComputedStyle(fx).display;
        if (ds !== "none" && ds !== "") return true;
      }

      return false;
    } catch {
      return false;
    }
  }

  function _openWatchLoop() {
    if (!openWatchArmed) return;
    const nowOpen = _detectOpened();

    // rising edge: false -> true
    if (nowOpen && !openStateLast) {
      celebrate({ ms: cfg.celebrateMs, big: true });
    }

    openStateLast = nowOpen;
    openWatchRaf = requestAnimationFrame(_openWatchLoop);
  }

  function bindAutoOpen() {
    if (openWatchArmed) return;

    // event hooks (kalau kamu dispatch event dari logic kamu, ini langsung nyala)
    const onOpen = () => celebrate({ ms: cfg.celebrateMs, big: true });
    ["angpao:opened", "angpao-opened", "reveal:done", "reward:show"].forEach((ev) => {
      document.addEventListener(ev, onOpen, { passive: true });
    });

    // watcher heuristik (tanpa ubah logic kamu pun tetap bisa kebaca)
    openWatchArmed = true;
    openStateLast = _detectOpened();
    openWatchRaf = requestAnimationFrame(_openWatchLoop);
  }

  function unbindAutoOpen() {
    openWatchArmed = false;
    cancelAnimationFrame(openWatchRaf);
    openWatchRaf = 0;
  }

  return {
    init,
    setEnabled,
    celebrate,
    burst,
    burstFromEvent,
    clear,
    isReady,
    bindAutoOpen,
    unbindAutoOpen,
  };
})();

// init fireworks
Fireworks.init("canvas");       // auto fallback ke "particle-canvas" kalau ada
Fireworks.setEnabled(false);    // default OFF
Fireworks.bindAutoOpen();       // ✅ AUTO aktif saat Angpao terbuka

    // =====================================================
    // AUDIO ENGINE — HARD PAUSE on tab switch (no leak)
    // =====================================================
    const AudioEngine = (() => {
      if (!CONFIG.audio.enabled){
        return { onGesture(){}, ensureBg(){}, click(){}, win(){}, stopAll(){}, onPopupOpen(){}, onPopupClose(){} };
      }

      const fadeMs = clamp(+CONFIG.audio.fadeMs || 420, 120, 1600);
      let gesture = false;

      const safePlay = (a) => {
        if (!a || !a.src) return;
        const p = a.play();
        if (p && typeof p.catch === "function") p.catch(() => {});
      };
      const safePause = (a) => { if (!a) return; try{ a.pause(); }catch{} };
      const setVol = (a, v) => { if (!a) return; a.volume = clamp(v, 0, 1); };

      const Fade = (() => {
        const state = new WeakMap();
        function cancel(a){
          const prev = state.get(a);
          if (prev?.raf) cancelAnimationFrame(prev.raf);
          state.set(a, { raf: 0 });
        }
        function fadeTo(a, target, ms, after){
          if (!a) return;
          cancel(a);

          const start = performance.now();
          const from = Number.isFinite(a.volume) ? a.volume : 0;
          const dur = clamp(ms || fadeMs, 80, 2400);

          const step = (t) => {
            const k = clamp((t - start) / dur, 0, 1);
            const e = 1 - Math.pow(1 - k, 3);
            setVol(a, from + (target - from) * e);
            if (k < 1){
              const raf = requestAnimationFrame(step);
              state.set(a, { raf });
            } else {
              state.set(a, { raf: 0 });
              after && after();
            }
          };

          const raf = requestAnimationFrame(step);
          state.set(a, { raf });
        }
        return { fadeTo, cancel };
      })();

      if (bgMusic){
        bgMusic.loop = true;
        bgMusic.preload = "auto";
        bgMusic.playsInline = true;
        bgMusic.crossOrigin = "anonymous";
        // start in silent to pass some autoplay policies, then unmute on gesture
        bgMusic.muted = true;
        setVol(bgMusic, 0);
      }
      if (winSound){
        winSound.loop = false;
        winSound.preload = "auto";
        winSound.playsInline = true;
        winSound.crossOrigin = "anonymous";
        setVol(winSound, clamp(CONFIG.audio.volumeWin ?? 0.75, 0, 1));
      }
      if (clickSound){
        clickSound.loop = false;
        clickSound.preload = "auto";
        clickSound.playsInline = true;
        clickSound.crossOrigin = "anonymous";
        setVol(clickSound, clamp(CONFIG.audio.volumeClick ?? 0.55, 0, 1));
      }

      function ensureBg(){
        if (!gesture) return;
        if (!bgMusic || !bgMusic.src) return;
        if (document.hidden) return;

        try{
          bgMusic.muted = false;
          // play segera (biar nggak delay), lalu fade volume
          safePlay(bgMusic);
          const target = clamp(CONFIG.audio.volumeBg ?? 0.55, 0, 1);
          Fade.fadeTo(bgMusic, target, fadeMs);
        }catch{}
      }

      function hardPauseAll(){
        if (bgMusic){
          Fade.cancel(bgMusic);
          try{
            bgMusic.muted = true;
            bgMusic.volume = 0;
          }catch{}
          safePause(bgMusic);
        }
        if (winSound){
          safePause(winSound);
          try{ winSound.currentTime = 0; }catch{}
        }
        if (clickSound){
          safePause(clickSound);
          try{ clickSound.currentTime = 0; }catch{}
        }
      }

      function click(){
        if (!gesture) return;
        if (!clickSound || !clickSound.src) return;
        if (document.hidden) return;
        try{ clickSound.currentTime = 0; }catch{}
        setVol(clickSound, clamp(CONFIG.audio.volumeClick ?? 0.55, 0, 1));
        safePlay(clickSound);
      }

      function win(){
        if (!gesture) return;
        if (!winSound || !winSound.src) return;
        if (document.hidden) return;
        try{ winSound.currentTime = 0; }catch{}
        setVol(winSound, clamp(CONFIG.audio.volumeWin ?? 0.75, 0, 1));
        safePlay(winSound);
      }

      function stopAll(){ hardPauseAll(); }
      function onGesture(){ gesture = true; ensureBg(); }

      const onHide = () => hardPauseAll();
      const onShow = () => { if (!document.hidden) ensureBg(); };

      document.addEventListener("visibilitychange", () => {
        if (document.hidden) onHide();
        else onShow();
      }, { passive:true });

      window.addEventListener("blur", onHide, { passive:true });
      window.addEventListener("focus", onShow, { passive:true });

      document.addEventListener?.("freeze", onHide, { passive:true });
      document.addEventListener?.("resume", onShow, { passive:true });

      window.addEventListener("pagehide", onHide, { passive:true });
      window.addEventListener("pageshow", onShow, { passive:true });

      function onPopupOpen(){ ensureBg(); }
      function onPopupClose(){}

      return { onGesture, ensureBg, click, win, stopAll, onPopupOpen, onPopupClose };
    })();

    const markGesture = () => AudioEngine.onGesture();
    window.addEventListener("pointerdown", markGesture, { passive:true, once:true });
    window.addEventListener("keydown", markGesture, { passive:true, once:true });

    // click sound on button / angpao
    document.addEventListener("pointerdown", (e) => {
      const b = e.target?.closest?.("button");
      const ap = e.target?.closest?.(".angpaoBtn");
      if (b || ap) AudioEngine.click?.();
    }, { passive:true });

    // =====================================================
    // PRIZE IMAGE RESOLVE (Popup reward pakai PNG)
    // =====================================================
    const _normKey = (s) => String(s || "").trim().toLowerCase();

    function findIntroImgByKeywords(keywords){
      const items = Array.isArray(CONFIG.prizeIntro?.items) ? CONFIG.prizeIntro.items : [];
      const ks = (keywords || []).map(k => String(k).toLowerCase());
      for (const it of items){
        const name = _normKey(it?.name);
        if (!it?.img) continue;
        if (ks.some(k => name.includes(k))) return String(it.img);
      }
      return "";
    }

    function getPrizeImgUrl(prizeLabel){
      const label = String(prizeLabel || "").trim();
      const map = CONFIG.game?.prizeImageMap || {};

      if (label && map[label]) return String(map[label]);

      const lk = _normKey(label);
      for (const k in map){
        if (_normKey(k) === lk) return String(map[k]);
      }

      if (lk.includes("rp") || lk.includes("saldo")){
        return findIntroImgByKeywords(["saldo","uang","tunai","rp"]) || String(CONFIG.game?.defaultPrizeImg || "");
      }
      if (lk.includes("bonus")){
        return findIntroImgByKeywords(["bonus","gift"]) || String(CONFIG.game?.defaultPrizeImg || "");
      }

      const items = CONFIG.prizeIntro?.items || [];
      const hit = items.find(it => _normKey(it?.name) === lk && it?.img);
      if (hit?.img) return String(hit.img);

      return String(CONFIG.game?.defaultPrizeImg || items?.[0]?.img || CONFIG.images?.angpao || "");
    }

    function setRewardPrizeImg(prizeLabel){
      if (!prizeImgEl) return;
      const url = getPrizeImgUrl(prizeLabel);
      if (url){
        prizeImgEl.src = url;
        prizeImgEl.alt = prizeLabel ? `Hadiah ${prizeLabel}` : "Hadiah";
      } else {
        prizeImgEl.removeAttribute("src");
        prizeImgEl.alt = "";
      }
    }
	
// =====================================================
// REVEAL FX — Prize PNG + "OK" gate BEFORE POPUP (NO CSS INJECT)
// =====================================================
const RevealFX = (() => {
  const rm = (() => { try{ return matchMedia("(prefers-reduced-motion: reduce)"); }catch{ return null; } })();
  const reduced = () => !!rm?.matches;

  let rootEl, bgEl, flareEl, cardEl, shineEl, imgEl, labelEl, okBtn;
  let busy = false;

  function ensure(){
    if (rootEl) return;

    rootEl = document.createElement("div");
    rootEl.id = "revealFX";
    rootEl.setAttribute("role", "dialog");
    rootEl.setAttribute("aria-modal", "true");
    rootEl.setAttribute("aria-label", "Hadiah");
    rootEl.innerHTML = `
      <div class="fxBg" aria-hidden="true"></div>
      <div class="fxFlare" aria-hidden="true"></div>

      <div class="fxCard">
        <div class="fxShine" aria-hidden="true"></div>

        <div class="fxPrizeWrap">
          <img class="fxPrizeImg" alt="Hadiah"/>
        </div>

        <div class="fxLabel">HADIAH ANDA</div>
        <button class="fxOk" type="button" disabled>OK</button>
      </div>
    `;
    document.body.appendChild(rootEl);

    bgEl    = rootEl.querySelector(".fxBg");
    flareEl = rootEl.querySelector(".fxFlare");
    cardEl  = rootEl.querySelector(".fxCard");
    shineEl = rootEl.querySelector(".fxShine");
    imgEl   = rootEl.querySelector(".fxPrizeImg");
    labelEl = rootEl.querySelector(".fxLabel");
    okBtn   = rootEl.querySelector(".fxOk");

    // klik backdrop => OK
    rootEl.addEventListener("pointerdown", (e) => {
      if (e.target === rootEl) okBtn?.click?.();
    }, { passive:true });
  }

  function show(){
    rootEl.style.display = "flex";
    document.body.classList.add("modal-open");
  }
  function hide(){
    rootEl.style.display = "none";
    document.body.classList.remove("modal-open");
  }

  function resetInstant(){
    try{
      bgEl.style.opacity = "0";
      bgEl.style.transform = "scale(.985)";
      flareEl.style.opacity = "0";
      flareEl.style.transform = "scale(.78)";
      cardEl.style.opacity = "0";
      cardEl.style.transform = "translate3d(0,12px,0) scale(.96)";
      shineEl.style.opacity = "0";
      imgEl.style.opacity = "0";
      imgEl.style.transform = "translate3d(0,8px,0) scale(.90)";
      labelEl.style.opacity = "0";
      labelEl.style.transform = "translate3d(0,6px,0)";
      okBtn.disabled = true;
    }catch{}
  }

  function waitForOk(){
    return new Promise((resolve) => {
      let done = false;

      const finish = () => {
        if (done) return;
        done = true;
        cleanup();
        resolve();
      };

      const onKey = (e) => {
        const k = (e.key || "").toLowerCase();
        if (k === "enter" || k === " " || k === "spacebar") { e.preventDefault(); finish(); }
        if (k === "escape") { e.preventDefault(); finish(); }
      };

      const cleanup = () => {
        okBtn?.removeEventListener("click", finish);
        document.removeEventListener("keydown", onKey, true);
      };

      okBtn?.addEventListener("click", finish, { once:true });
      document.addEventListener("keydown", onKey, true);

      try{ okBtn?.focus?.({ preventScroll:true }); }catch{}
    });
  }

  async function play(prizeLabel){
    if (busy) return;
    busy = true;

    ensure();

    const url = getPrizeImgUrl(prizeLabel);
    if (imgEl){
      imgEl.src = url;
      imgEl.alt = prizeLabel ? `Hadiah ${prizeLabel}` : "Hadiah";
    }

    show();
    resetInstant();

    // reduced motion: tampil instan, tetap gate OK
    if (reduced()){
      try{
        bgEl.style.opacity = "1";
        bgEl.style.transform = "scale(1)";
        flareEl.style.opacity = "0.65";
        flareEl.style.transform = "scale(1)";
        cardEl.style.opacity = "1";
        cardEl.style.transform = "translate3d(0,0,0) scale(1)";
        shineEl.style.opacity = "0.55";
        imgEl.style.opacity = "1";
        imgEl.style.transform = "translate3d(0,0,0) scale(1)";
        labelEl.style.opacity = "1";
        labelEl.style.transform = "translate3d(0,0,0)";
      }catch{}
      okBtn.disabled = false;
      await waitForOk();
      hide();
      busy = false;
      return;
    }

    const easeOut = "cubic-bezier(0.16, 1, 0.3, 1)";
    const easePop = "cubic-bezier(0.2, 0.9, 0.2, 1)";

    const aBg = bgEl.animate(
      [{ opacity:0, transform:"scale(.985)" }, { opacity:1, transform:"scale(1)" }],
      { duration:240, easing:easeOut, fill:"forwards" }
    );
    const aFlare = flareEl.animate(
      [{ opacity:0, transform:"scale(.78)" }, { opacity:1, transform:"scale(1.06)" }, { opacity:.55, transform:"scale(1.12)" }],
      { duration:620, easing:easeOut, fill:"forwards" }
    );
    const aCard = cardEl.animate(
      [{ opacity:0, transform:"translate3d(0,12px,0) scale(.96)" }, { opacity:1, transform:"translate3d(0,0,0) scale(1)" }],
      { duration:320, delay:110, easing:easeOut, fill:"forwards" }
    );
    const aShine = shineEl.animate(
      [{ opacity:0 }, { opacity:1 }, { opacity:.45 }],
      { duration:520, delay:150, easing:easeOut, fill:"forwards" }
    );
    const aImg = imgEl.animate(
      [{ opacity:0, transform:"translate3d(0,8px,0) scale(.90)" }, { opacity:1, transform:"translate3d(0,0,0) scale(1.04)" }, { opacity:1, transform:"translate3d(0,0,0) scale(1)" }],
      { duration:520, delay:170, easing:easePop, fill:"forwards" }
    );
    const aLbl = labelEl.animate(
      [{ opacity:0, transform:"translate3d(0,6px,0)" }, { opacity:1, transform:"translate3d(0,0,0)" }],
      { duration:360, delay:250, easing:easeOut, fill:"forwards" }
    );

    await Promise.allSettled([aBg.finished, aFlare.finished, aCard.finished, aShine.finished, aImg.finished, aLbl.finished]);

    okBtn.disabled = false;
    await waitForOk();

    // keluar cepat biar popup reward masuk halus
    const outDur = 200;
    const aOutCard = cardEl.animate(
      [{ opacity:1, transform:"translate3d(0,0,0) scale(1)" }, { opacity:0, transform:"translate3d(0,10px,0) scale(.96)" }],
      { duration:outDur, easing:easeOut, fill:"forwards" }
    );
    const aOutBg = bgEl.animate(
      [{ opacity:1 }, { opacity:0 }],
      { duration:outDur, easing:easeOut, fill:"forwards" }
    );
    const aOutFlare = flareEl.animate(
      [{ opacity:.55, transform:"scale(1.12)" }, { opacity:0, transform:"scale(1.18)" }],
      { duration:outDur, easing:easeOut, fill:"forwards" }
    );

    await Promise.allSettled([aOutCard.finished, aOutBg.finished, aOutFlare.finished]);
    hide();

    busy = false;
  }

  return { play };
})();

    // =====================================================
    // PRIZE INTRO OVERLAY (GRID 4)
    // =====================================================
    const PrizeIntro = (() => {
      const conf = CONFIG.prizeIntro || {};
      const enabled = !!conf.enabled;
      const LSKEY = String(conf.storageKey || "lap_prize_intro_seen_v2");

      const hasSeen = () => {
        if (!enabled) return true;
        if (!conf.showOncePerDevice) return false;
        try{ return localStorage.getItem(LSKEY) === "1"; }catch{ return false; }
      };

      const setSeen = () => {
        if (!enabled) return;
        if (!conf.showOncePerDevice) return;
        try{ localStorage.setItem(LSKEY, "1"); }catch{}
      };

      function escHtml(s){
        return String(s ?? "")
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#39;");
      }

      function twoLineLabel(label){
        const t = String(label || "").replace(/\s+/g, " ").trim();
        if (!t) return { a:"Hadiah", b:"" };
        const parts = t.split(" ");
        if (parts.length <= 2) return { a: parts.join(" "), b: "" };
        return { a: parts.slice(0, 2).join(" "), b: parts.slice(2).join(" ") };
      }

      function normalizeItems(){
        const items = Array.isArray(conf.items) ? conf.items : [];
        const out = items
          .map(it => ({
            name: String(it?.name || "").trim(),
            img:  String(it?.img  || "").trim()
          }))
          .filter(it => it.name || it.img);

        while (out.length < 4){
          out.push({ name: "Hadiah", img: "" });
        }
        return out.slice(0, 4);
      }

      function hydrate(){
        if (!enabled) return;

        const hint = String(conf.hintText || "").trim() || "Hadiah utama event ini. Klik OK untuk lanjut bermain.";
        if (prizeOverlayHint) prizeOverlayHint.textContent = hint;

        const items = normalizeItems();
        for (const it of items){
          if (it.img && /^https?:\/\//i.test(it.img)) preloadImage(it.img);
        }

        if (!prizeGrid) return;
        prizeGrid.innerHTML = "";

        const frag = document.createDocumentFragment();
        for (let i = 0; i < 4; i++){
          const it = items[i];

          const card = document.createElement("div");
          card.className = "prizeItem";
          card.setAttribute("role", "group");
          card.setAttribute("aria-label", it.name ? `Hadiah ${it.name}` : `Hadiah ${i+1}`);

          const thumb = document.createElement("div");
          thumb.className = "prizeThumb";

          const img = document.createElement("img");
          img.alt = it.name ? it.name : `Hadiah ${i+1}`;
          img.decoding = "async";
          img.loading = "eager";

          if (it.img && /^https?:\/\//i.test(it.img)){
            img.src = it.img;
          } else {
            img.src =
              "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cdefs%3E%3CradialGradient id='g' cx='.35' cy='.28' r='.9'%3E%3Cstop offset='0' stop-color='%23fff6df' stop-opacity='.20'/%3E%3Cstop offset='1' stop-color='%23c79a40' stop-opacity='.05'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect width='160' height='160' rx='26' fill='url(%23g)'/%3E%3Cpath d='M34 104l24-28 18 16 30-38 22 50H34Z' fill='rgba(255,228,166,.18)'/%3E%3Ccircle cx='56' cy='54' r='14' fill='rgba(255,228,166,.14)'/%3E%3C/svg%3E";
          }

          const name = document.createElement("div");
          name.className = "prizeName";
          const L = twoLineLabel(it.name || `Hadiah ${i+1}`);
          name.innerHTML = L.b ? `${escHtml(L.a)}<br>${escHtml(L.b)}` : escHtml(L.a);

          thumb.appendChild(img);
          card.appendChild(thumb);
          card.appendChild(name);
          frag.appendChild(card);
        }

        prizeGrid.appendChild(frag);
      }

      function open(){
        if (!enabled || !prizeOverlay) return;
        hydrate();
        prizeOverlay.style.display = "flex";
        document.body.classList.add("modal-open");
      }

      function close(){
        if (!enabled || !prizeOverlay) return;
        prizeOverlay.style.display = "none";
        document.body.classList.remove("modal-open");
      }

      function init(){
        if (!enabled) return;

        hydrate();

        btnPrizeOk?.addEventListener("click", () => {
          setSeen();
          close();
        });

        prizeOverlay?.addEventListener("click", (e) => {
          if (e.target === prizeOverlay){
            setSeen();
            close();
          }
        });

        btnShowPrize?.addEventListener("click", () => open());
      }

      function maybeShowOnce(){
        if (!enabled) return;
        if (!hasSeen()) open();
      }

      return { init, maybeShowOnce, open };
    })();

    // =====================================================
    // CLAIM OVERLAY
    // =====================================================
    function showClaimOverlay(on){
      if (!claimOverlay) return;
      if (on){
        if (claimOverlayText) claimOverlayText.textContent = escapeText(CONFIG.claimUX.overlayText || "Memproses klaim...");
        if (claimOverlaySub) claimOverlaySub.textContent  = escapeText(CONFIG.claimUX.overlaySub || "Mohon tunggu sebentar");
        claimOverlay.style.display = "flex";
        document.body.classList.add("modal-open");
        claimOverlay.setAttribute("aria-busy","true");
      } else {
        claimOverlay.style.display = "none";
        document.body.classList.remove("modal-open");
        claimOverlay.removeAttribute("aria-busy");
      }
    }

    // =====================================================
    // STATE
    // =====================================================
    let picked = false;
    let pickedIndex = -1;
    let pickedPrize = "";
    let pickBusy = false;
    let lastPickAt = 0;

    // =====================================================
    // UI HELPERS
    // =====================================================
    function showErr(msg){
      if (!errEl) return;
      errEl.textContent = msg || "";
      errEl.classList.toggle("show", !!msg);
    }

    function setPickedState(on){
      picked = !!on;
      if (!grid) return;

      const lock = !!CONFIG.game.lockAfterPick;
      const btns = $$(".angpaoBtn", grid);

      for (let i = 0; i < btns.length; i++){
        const b = btns[i];
        const idx = parseInt(b.dataset.index || "-1", 10);
        if (picked && lock) b.disabled = (idx !== pickedIndex);
        else b.disabled = false;
        if (!picked) b.classList.remove("is-picked", "is-opening", "is-opened");
      }
    }

    function fillPopupMeta({ username, prize, ts }){
      const p = escapeText(prize || "—") || "—";
      if (prizeVal) prizeVal.textContent = p;
      if (metaUser) metaUser.textContent = escapeText(username || "—") || "—";
      if (metaTime) metaTime.textContent = fmtTime(ts || Date.now());
      setRewardPrizeImg(p);
    }

    function openPopup(){
      if (!popup) return;
      popup.style.display = "flex";
      popup.classList.add("is-open"); // optional kalau CSS ada
      document.body.classList.add("modal-open");
      if (statusNote) statusNote.textContent = "";
      AudioEngine.onPopupOpen?.();
    }

    function closePopup(){
      if (!popup) return;
      popup.style.display = "none";
      popup.classList.remove("is-open");
      document.body.classList.remove("modal-open");
      AudioEngine.onPopupClose?.();
    }

    // =====================================================
    // GRID BUILD
    // =====================================================
    function buildGrid(){
      if (!grid) return;
      grid.innerHTML = "";
      const n = clamp(parseInt(CONFIG.game.envelopes, 10) || 9, 1, 30);

      const frag = document.createDocumentFragment();
      for (let i = 1; i <= n; i++){
        const b = document.createElement("button");
        b.className = "angpaoBtn";
        b.type = "button";
        b.setAttribute("aria-label", `Pilih Ang Pao ${i}`);
        b.dataset.index = String(i - 1);

        const env = document.createElement("span");
        env.className = "envelope";
        env.setAttribute("aria-hidden", "true");
        b.appendChild(env);

        frag.appendChild(b);
      }
      grid.appendChild(frag);
    }
    buildGrid();

    // =====================================================
    // NAV
    // =====================================================
    function gotoMain(){
      if (loginMenu) loginMenu.style.display = "none";
      if (mainMenu)  mainMenu.style.display  = "block";
      showErr("");
      AudioEngine.ensureBg?.();
      PrizeIntro.maybeShowOnce?.();
    }

    function lockUsernameUI(u){
      if (!usernameEl) return;
      usernameEl.value = u || "";
      usernameEl.readOnly = true;
      usernameEl.setAttribute("aria-readonly", "true");
      usernameEl.classList.add("locked");
    }

    function resetSession(){
      if (statusNote) statusNote.textContent = "";
      pickedIndex = -1;
      pickedPrize = "";
      setPickedState(false);
    }

    // =====================================================
    // PRIMARY PRIZE CHECK
    // =====================================================
    function isPrimaryPrize(prize){
      const p = escapeText(prize).toLowerCase();
      const list = (CONFIG.game.primaryPrizes || []).map(x => escapeText(x).toLowerCase());
      return !!p && list.includes(p);
    }

    // =====================================================
    // INIT RESTORE
    // =====================================================
    (function initRestore(){
      PrizeIntro.init?.();

      // realtime clean error
      usernameEl?.addEventListener("input", () => {
        showErr("");
        usernameEl.classList.remove("inputBad");
      }, { passive:true });

      if (CONFIG.site.requireUsername && CONFIG.game.oneUsernamePerDevice){
        const savedU = escapeText(STORE.getUser());
        if (savedU) lockUsernameUI(savedU);
      }

      if (CONFIG.game.onePlayPerDevice && STORE.isPlayed()){
        const res = STORE.getResult();
        if (res && res.prize){
          if (res.username && usernameEl) lockUsernameUI(String(res.username));
          gotoMain();

          pickedIndex = Number.isFinite(+res.index) ? (+res.index) : -1;
          pickedPrize = String(res.prize);
          setPickedState(true);

          if (grid && pickedIndex >= 0){
            const btn = $(`.angpaoBtn[data-index="${pickedIndex}"]`, grid);
            btn?.classList.add("is-picked", "is-opened");
          }

          fillPopupMeta({
            username: String(res.username || STORE.getUser() || ""),
            prize: String(res.prize || ""),
            ts: Number.isFinite(+res.ts) ? +res.ts : Date.now()
          });

          // ✅ kalau sudah pernah dapat hadiah, fireworks tetap nyala
          if (CONFIG.fireworks?.enabled && Fireworks.isReady?.()) {
            Fireworks.setEnabled(true);
            // burst halus 1x (hindari spike)
            requestAnimationFrame(() => {
              Fireworks.burst(window.innerWidth * 0.5, window.innerHeight * 0.30, 200, isPrimaryPrize(pickedPrize));
            });
          }
        } else {
          showErr("Kesempatan bermain telah digunakan.");
          if (btnStart) btnStart.disabled = true;
        }
      }
    })();

    // =====================================================
    // START
    // =====================================================
    function validateUsername(){
      const u = escapeText(usernameEl?.value);
      const need = !!CONFIG.site.requireUsername;
      if (need && !u){
        showErr("Masukkan User ID dulu.");
        usernameEl?.classList.add("inputBad");
        usernameEl?.focus?.();
        return null;
      }
      usernameEl?.classList.remove("inputBad");
      return u;
    }

    function canStartRealPlay(){
      if (!CONFIG.game.onePlayPerDevice) return true;
      return !STORE.isPlayed();
    }

    btnStart?.addEventListener("click", () => {
      if (Security.isLocked()) return;

      if (!canStartRealPlay()){
        showErr("Kesempatan bermain sudah digunakan.");
        return;
      }

      resetSession();

      const u = validateUsername();
      if (CONFIG.site.requireUsername && !u) return;

      if (CONFIG.site.requireUsername && CONFIG.game.oneUsernamePerDevice){
        STORE.setUser(u);
        lockUsernameUI(u);
      }

      gotoMain();
    });

    usernameEl?.addEventListener("keydown", (e) => {
      if (e.key === "Enter") btnStart?.click();
    });

    // =====================================================
    // PRIZE RESOLVE
    // =====================================================
    function resolveLockedPrimary(){
      const mode = String(CONFIG.game.autoLockPrimaryMode || "off").toLowerCase();
      const prim = (CONFIG.game.primaryPrizes || []).map(escapeText).filter(Boolean);
      if (!prim.length) return null;

      if (mode === "fixed"){
        const fixed = escapeText(CONFIG.game.lockedPrizeFixed);
        return prim.includes(fixed) ? fixed : prim[0];
      }
      if (mode === "random"){
        return prim[(Math.random() * prim.length) | 0];
      }
      return null;
    }

    async function resolvePrize({ username, index }){
      const locked = resolveLockedPrimary();
      if (locked) return locked;

      if (CONFIG.api.enabled){
        const data = await apiFetch(CONFIG.api.endpoints.reveal, { username, index, demo:false });
        const p = (data && (data.prize || data.label)) ? String(data.prize || data.label) : "";
        if (!p) throw new Error("Prize kosong dari server");
        return p;
      }

      return weightedPick(CONFIG.game.prizes);
    }

    // =====================================================
    // PICK LOGIC (anti-double fire + lebih responsif)
    // =====================================================
    async function onPick(btn, ev){
      const t = performance.now();
      if (pickBusy) return;
      if (t - lastPickAt < 220) return;
      lastPickAt = t;

      if (Security.isLocked()) return;
      if (!btn || !grid) return;

      const index = parseInt(btn.dataset.index || "-1", 10);
      if (!Number.isFinite(index) || index < 0) return;

      if (picked && CONFIG.game.lockAfterPick){
        if (index === pickedIndex && pickedPrize){
          const username = escapeText(usernameEl?.value) || escapeText(STORE.getUser());
          const res = STORE.getResult();
          fillPopupMeta({ username, prize: pickedPrize, ts: (res?.ts || Date.now()) });

          if (CONFIG.fireworks?.enabled) {
            Fireworks.setEnabled(true);
            Fireworks.burstFromEvent(ev, 170, isPrimaryPrize(pickedPrize));
          }

          openPopup();
        }
        return;
      }

      if (CONFIG.game.onePlayPerDevice && STORE.isPlayed()){
        showErr("Kesempatan bermain sudah digunakan.");
        Security.lock("Akses terbatas.");
        return;
      }

      const username = escapeText(usernameEl?.value) || escapeText(STORE.getUser());
      if (CONFIG.site.requireUsername){
        const u = validateUsername();
        if (!u) return;
      }

      pickBusy = true;

      pickedIndex = index;
      btn.classList.add("is-picked", "is-opening");
      setPickedState(true);

      try{
        const prize = await resolvePrize({ username, index });
        pickedPrize = prize;

        const ts = nowMs();

        if (CONFIG.game.onePlayPerDevice){
          STORE.setPlayed();
          STORE.setResult({
            username: username || STORE.getUser() || "",
            prize: String(prize),
            index: pickedIndex,
            ts
          });
        }

        fillPopupMeta({ username: username || STORE.getUser() || "", prize, ts });

        // ✅ FIREWORKS: aktif & terus hidup setelah angpao terbuka
        if (CONFIG.fireworks?.enabled) {
          Fireworks.setEnabled(true);
          Fireworks.burstFromEvent(ev, 220, isPrimaryPrize(prize));
        }

        btn.classList.remove("is-opening");
        btn.classList.add("is-opened");

        AudioEngine.win?.();
		await RevealFX.play(prize);
        openPopup();
      }catch(err){
        pickedIndex = -1;
        pickedPrize = "";
        setPickedState(false);
        btn.classList.remove("is-picked", "is-opening", "is-opened");
        showErr(err?.message ? String(err.message) : "Terjadi error. Coba lagi.");
      } finally {
        pickBusy = false;
      }
    }

    // satu jalur input biar nggak double di iOS/Android
    let ignoreClickUntil = 0;

    // Pointer events (utama)
    grid?.addEventListener("pointerup", (e) => {
      const btn = e.target?.closest?.(".angpaoBtn");
      if (!btn) return;

      // cegah ghost click
      try{ e.preventDefault(); }catch{}
      ignoreClickUntil = performance.now() + 450;
      onPick(btn, e);
    }, { passive:false });

    // Fallback click
    grid?.addEventListener("click", (e) => {
      if (performance.now() < ignoreClickUntil) return;
      const btn = e.target?.closest?.(".angpaoBtn");
      if (!btn) return;
      onPick(btn, e);
    }, { passive:true });

    // =====================================================
    // POPUP CLOSE
    // =====================================================
    btnClose?.addEventListener("click", closePopup);
    popup?.addEventListener("click", (e) => { if (e.target === popup) closePopup(); });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && popup && popup.style.display === "flex") closePopup();

      if (e.key === "Escape" && prizeOverlay && prizeOverlay.style.display === "flex"){
        try{
          const conf = CONFIG.prizeIntro || {};
          if (conf.enabled && conf.showOncePerDevice){
            localStorage.setItem(String(conf.storageKey || "lap_prize_intro_seen_v2"), "1");
          }
        }catch{}
        prizeOverlay.style.display = "none";
        document.body.classList.remove("modal-open");
      }
    });

    // =====================================================
    // CLAIM (overlay loading seragam)
    // =====================================================
    let claimBusy = false;

    function setClaimLoading(on){
      if (!btnClaim || !claimLabel) return;
      claimBusy = !!on;
      btnClaim.disabled = !!on;

      if (on){
        claimLabel.innerHTML = `<span class="spinner" aria-hidden="true"></span><span>MEMPROSES...</span>`;
      } else {
        claimLabel.textContent = "CLAIM SEKARANG";
      }
    }

    btnClaim?.addEventListener("click", async () => {
      if (!statusNote) return;
      if (Security.isLocked()) return;
      if (claimBusy) return;

      const username = escapeText(usernameEl?.value) || escapeText(STORE.getUser());
      const prize = escapeText(pickedPrize);
      const res = STORE.getResult();
      const ts = (res?.ts || Date.now());

      if (!username || !prize){
        statusNote.textContent = "Data klaim belum lengkap.";
        return;
      }

      setClaimLoading(true);
      showClaimOverlay(true);
      statusNote.textContent = "Memproses klaim...";

      await sleep(clamp(+CONFIG.claimUX.loadingMs || 1800, 700, 7000));

      if (CONFIG.api.enabled){
        try{
          const data = await apiFetch(CONFIG.api.endpoints.claim, { username, prize, index: pickedIndex, ts });
          statusNote.textContent = (data && (data.message || data.status)) ? String(data.message || data.status) : "Klaim diproses.";
          showClaimOverlay(false);
          setClaimLoading(false);
          return;
        }catch(err){
          statusNote.textContent = err?.message ? String(err.message) : "Klaim gagal. Coba lagi.";
          showClaimOverlay(false);
          setClaimLoading(false);
          return;
        }
      }

      if (CONFIG.site.claimRedirectUrl){
        const url = new URL(CONFIG.site.claimRedirectUrl, window.location.href);
        if (username) url.searchParams.set("u", username);
        if (prize) url.searchParams.set("p", prize);
        if (pickedIndex >= 0) url.searchParams.set("i", String(pickedIndex));
        url.searchParams.set("t", String(ts));

        statusNote.textContent = "Membuka live chat...";

        const openNew = !!CONFIG.claimUX.openInNewTab;

        await sleep(160);
        showClaimOverlay(false);
        setClaimLoading(false);

        if (openNew){
          window.open(url.toString(), "_blank", "noopener,noreferrer");
        } else {
          window.location.href = url.toString();
        }
        return;
      }

      statusNote.textContent = "Klaim diproses. Silakan lanjutkan via live chat.";
      showClaimOverlay(false);
      setClaimLoading(false);
    });

    // =====================================================
    // SHARE (link domain + user + waktu)
    // =====================================================
    function buildShareLink({ username, prize, ts }){
      const base = escapeText(CONFIG.site.baseUrl) || window.location.href;
      const u = new URL(base, window.location.href);
      if (username) u.searchParams.set("u", username);
      if (prize) u.searchParams.set("p", prize);
      u.searchParams.set("t", String(ts || Date.now()));
      return u.toString();
    }

    btnShare?.addEventListener("click", async () => {
      if (Security.isLocked()) return;

      const prize = escapeText(pickedPrize);
      const username = escapeText(usernameEl?.value) || escapeText(STORE.getUser());
      const res = STORE.getResult();
      const ts = (res?.ts || Date.now());

      const link = buildShareLink({ username, prize, ts });
      const text =
        `🧧Lucky Ang Pao — ${prize ? `Saya dapat ${prize}` : "Ikutan sekarang juga!"}` +
        (username ? ` | User: ${username}` : "") +
        ` | Waktu: ${fmtTime(ts)}\n${link}`;

      try{
        if (navigator.share){
          await navigator.share({ title: CONFIG.site.shareTitle || "Lucky Ang Pao", text, url: link });
          if (statusNote) statusNote.textContent = "Berhasil dibagikan.";
        } else if (navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(text);
          if (statusNote) statusNote.textContent = "Link & detail tersalin.";
        } else {
          window.prompt("Salin ini:", text);
          if (statusNote) statusNote.textContent = "Silakan salin teks.";
        }
      }catch{
        if (statusNote) statusNote.textContent = "Share dibatalkan.";
      }
    });

    // =====================================================
    // AUTO FIREWORKS ONLY AFTER REVEAL (default off, nyala saat dapat hadiah)
    // =====================================================
    // Fireworks.setEnabled(false);
  });
})();
</script>
</body>
</html>